```markdown
Hello! I am providing you with a concatenated text document representing a codebase or a portion of it. Each file within this document is formatted as follows:

--- START FILE: path/to/relative/file.ext ---
```[language_hint]
// File content here
```
--- END FILE: path/to/relative/file.ext ---

**Your Task:**

Hello Gemini,

We are continuing our collaboration on the "Factory Architect" mathematics question generation application. In our previous session, you provided a `bash` script (`api_test_suite.sh`) to test the API. I have since run this script against the application, which now includes the bug fixes you recommended.

**Your Role:**

For this session, please act as a **Senior QA Analyst** specializing in educational technology. Your task is to critically and comprehensively evaluate the attached test results (`test_results.txt`) to assess the quality, accuracy, and educational suitability of the generated questions.

**High-Level Goal:**

Our primary objective is to rigorously assess the quality of the questions generated by the API after the recent bug fixes. We need to verify that the previous issues are resolved and identify any new or remaining problems related to **suitability, reasonableness, and accuracy.**

**Context & Provided Artifacts:**

1.  **Background:** The previous round of testing revealed several critical issues, including:
    *   Nonsensical question templates (e.g., asking for a price that was already stated).
    *   Crashes in advanced controller formats (`PERCENTAGE`, `ORDERING`, etc.).
    *   Failure to respect the requested `scenario_theme`.
    *   Failure to block requests for models marked as "BROKEN".
    *   Silent failures during batch generation.
2.  **Test Script Used:** The evaluation should be based on the output from the `api_test_suite.sh` script we developed.
3.  **Test Results File:** The complete output of the test script is attached below.

---

### **Your Detailed Task: Comprehensive Evaluation**

Please perform the following analysis based on the attached `test_results.txt` file.

**Part 1: Bug Verification (Confirming Fixes)**

For each of the previously identified critical bugs, please confirm if the fix was successful. State a clear **"PASS"** or **"FAIL"** for each item, providing a brief justification based on the test output.

*   **A. Flawed Question Template:**
    *   **Check:** Do questions in Suite A and B (e.g., for `ADDITION` and `SUBTRACTION`) now make logical sense? Does the narrative use the *operands* to form a story, rather than stating the answer in the question?
    *   **Status:** PASS / FAIL

*   **B. Advanced Controller Crashes:**
    *   **Check:** Did the tests for `PERCENTAGE` (B.5), `ORDERING` (C.4), `VALIDATION` (C.5), `MISSING_VALUE` (C.7), `PATTERN_RECOGNITION` (C.8), and the high-difficulty `MULTIPLICATION` (D.5) now complete successfully without a `this.formatValue is not a function` error?
    *   **Status:** PASS / FAIL

*   **C. Scenario Theme Selection:**
    *   **Check:** In Suite E, did the API correctly generate a question for each of the 10 specified themes (`COOKING`, `SPORTS`, `NATURE`, etc.), or did it default to `SHOPPING`?
    *   **Status:** PASS / FAIL

*   **D. "Broken" Model Check:**
    *   **Check:** Did the request for the `LINEAR_EQUATION` model (Test F.4) result in a clear error message stating the model is disabled, as expected?
    *   **Status:** PASS / FAIL

*   **E. Batch Generation Failures:**
    *   **Check:** Did the batch generation test (G.1) successfully return all 5 requested questions? Does the `batch_info` reflect a `success_rate` of `1.0`?
    *   **Status:** PASS / FAIL

**Part 2: Deeper Analysis of Question Quality**

Go beyond bug verification and critically evaluate the generated questions for their educational quality. Please provide detailed findings, citing specific Test IDs (e.g., "In Test A.1...").

*   **A. Suitability and Reasonableness:**
    *   **Age-Appropriateness:** Are the scenarios and numbers generated appropriate for the specified `difficulty_level`? For example, does a Year 1 question (e.g., Test A.1, difficulty "1.1") use simple, small numbers and concepts?
    *   **Logical Coherence:** Does the narrative of the question logically connect to the mathematical operation being tested? For example, in Test A.2 (`SUBTRACTION`), is the story about taking away, finding a difference, or calculating change?
    *   **Realism:** In the context of a primary school question, are the values reasonable? (e.g., Are the prices for items in the `SHOPPING` theme believable, or are they nonsensically high like `Â£86.30` for an apple?).

*   **B. Mathematical Accuracy:**
    *   **Correctness:** In every successful response, is the `correctIndex` pointing to the option that contains the correct mathematical answer? Is the `result` field in the `mathOutput` accurate?

*   **C. Distractor Quality:**
    *   **Plausibility:** Are the incorrect answers (distractors) plausible mistakes a student might make? Do they reflect the intended `distractor_strategies` listed in the metadata (e.g., `WRONG_OPERATION`, `PLACE_VALUE_ERROR`)?

*   **D. Feature-Specific Evaluation:**
    *   **Suite C (Format Coverage):** Did the question *format* actually change for each test? For example, did the `COMPARISON` test (C.2) produce a "Which is greater?" style question, and did the `ESTIMATION` test (C.3) ask the user to estimate?
    *   **Suite D (Difficulty Progression):** As you look from Test D.1 to D.6, does the complexity of the `MULTIPLICATION` problems visibly increase in a logical way? Comment on the progression.
    *   **Suite G (Batch Generation):** Are the 5 questions generated in Test G.1 sufficiently varied, or are they too similar to each other?

**Part 3: Overall Assessment and Recommendations**

Conclude your analysis with the following:

1.  **Executive Summary:** A brief, high-level summary of the current state of the API. Is it stable? Are the major issues resolved? What are the most pressing new concerns?
2.  **Go / No-Go Recommendation:** Based on your findings, would you recommend this version of the API for a pilot release to teachers, or does it require further work?
3.  **Prioritized Action List:** Provide a new, prioritized list of the most important issues to address next, based on your analysis of this second round of testing.

**Output Format:**

Please structure your response clearly in Markdown, using headings, subheadings, and bullet points to organize your findings for easy review.

**End of task**

**Output Format Instructions (Strict Adherence Required):**

When you provide your response with the modified code, it is **ABSOLUTELY CRITICAL** that you follow this specific Markdown format for **EVERY** file that is changed, created, or deleted. This output will be parsed by an automated script.

1.  **For AMENDED (Modified) or NEW (Newly Created) Files:**
    *   You **MUST** provide the **ENTIRE, COMPLETE** content of the file, even if only one line has changed. Do not provide diffs, snippets, or summaries of changes *within* the code block itself.
    *   Each file's content **MUST** be enclosed in the following structure:

        ```markdown
        <!-- FILE_START: path/to/your/file.ext -->
        ```[language_hint]
        // The ENTIRE new or modified content of this file goes here.
        // For example, if it's a JavaScript file:
        function example() {
          console.log("This is the full file content.");
        }
        export default example;
        ```
        <!-- FILE_END: path/to/your/file.ext -->
        ```
    *   Replace `path/to/your/file.ext` with the **exact relative file path** as it was in the input document (for amended files), or the intended path for a new file. This path **MUST** be relative to the root of the provided codebase context.
    *   Replace `[language_hint]` (e.g., `javascript`, `python`, `typescript`, `css`, `html`) with the appropriate language for the code block. If no language hint is appropriate (e.g., for a `.txt` or `.json` file), you can use `text` or omit the language hint (e.g., just ```).
    *   Please **always** use forward slashes in file paths like this `/`.

2.  **For Files to be DELETED:**
    *   Use the following specific comment format:
        ```markdown
        <!-- DELETE_FILE: path/to/obsolete/file.ext -->
        ```
    *   Replace `path/to/obsolete/file.ext` with the **exact relative file path** of the file to be deleted.
    *   Do **NOT** include any code block or `FILE_START`/`FILE_END` markers for deleted files.

**Important Rules for Your Output (Critical for Automation):**

*   **COMPLETE FILES ONLY (FOR AMEND/NEW):** I reiterate, for any file you list using `FILE_START` and `FILE_END`, you must provide the **full and complete source code** for that file, reflecting all your changes.
*   **PATH ACCURACY:** The relative file paths used in `FILE_START:`, `FILE_END:`, and `DELETE_FILE:` must be **identical** to the paths provided in the input document (for existing/deleted files) or the correct intended paths (for new files). Paths are case-sensitive on many systems.
*   **ONLY AFFECTED FILES:** Only include entries (using `FILE_START`/`FILE_END` or `DELETE_FILE`) for files that have actually been modified, created, or need to be deleted. **Do not include files that remain unchanged from the input.**
*   **EXPLANATIONS:** You are welcome to provide explanations, comments, or summaries of your changes *outside* of these structured blocks. For example, you can write text before the first `<!-- FILE_START... -->` or between a `<!-- FILE_END... -->` block and the next `<!-- FILE_START... -->` block. My script will ignore text outside these specific markers and their associated code blocks.
*   **NO EXTRA TEXT WITHIN MARKERS:** Do not add any explanatory text *inside* the `<!-- ... -->` comments themselves, other than the required file path.
*   **NO NESTING:** Do not nest these marker blocks.

**Example of Expected Output Structure:**

```markdown
Okay, I've made the requested changes. Here's the updated code:

Some general explanation about the overall changes can go here.

<!-- FILE_START: src/services/UserService.js -->
```javascript
// ENTIRE content of the AMENDED UserService.js
async function getUser(id) {
  // ... new async/await implementation ...
  return user;
}
// ... other functions ...
export { getUser };
```
<!-- FILE_END: src/services/UserService.js -->

I've refactored `UserService.js` to use async/await. I also created a new utility function.

<!-- FILE_START: src/utils/errorHandler.js -->
```javascript
// ENTIRE content of the NEW errorHandler.js
export function handleGlobalError(error) {
  console.error("Global Error:", error);
  // ... more logic ...
}
```
<!-- FILE_END: src/utils/errorHandler.js -->

And I've removed an old API file.

<!-- DELETE_FILE: src/legacy/api.js -->

Please review these changes.
```

**Confirmation:**
Do you understand these formatting instructions completely? It is vital for my automated workflow that you adhere to them precisely.

---
***CODEBASE FOLLOWS:***
```

**How this `prompt.md` will be used:**

1.  When you run `concatenateCode.js`, it will read this `prompt.md` file.
2.  It will then write the content of `prompt.md` to the *top* of the output file (e.g., `concatenated_code_with_prompt.md`).
3.  Following this prompt, the script will append the header (`# Codebase from...`) and then all your concatenated code files.
4.  You will then open the generated output file (e.g., `concatenated_code_with_prompt.md`), **find the `[<<< IMPORTANT: ... >>>]` placeholder**, and **replace it with your specific instructions for that particular LLM interaction.**
5.  Finally, you copy the *entire content* of that edited file and paste it into the LLM.

# Codebase Context: Scanned from '.' within project base 'C:\Users\Andyx\Documents\projects\factory_architect'
# All file paths below are relative to: C:\Users\Andyx\Documents\projects\factory_architect
# Generated on: 2025-09-28T06:23:36.596Z

--- START FILE: api_test_suite.sh ---
```bash
#!/bin/bash

# ==============================================================================
# Factory Architect API Test Suite
#
# Description:
# This script contains a comprehensive suite of tests for the mathematics
# question generator API endpoint. It covers smoke tests, model and format
# coverage, difficulty progression, scenario themes, error handling, and
# batch generation.
#
# Prerequisites:
# 1. `curl` must be installed.
# 2. `jq` must be installed for pretty-printing JSON responses.
#    (e.g., on macOS: `brew install jq`, on Debian/Ubuntu: `sudo apt-get install jq`)
# 3. The Factory Architect application server must be running on localhost:3000.
#
# How to Run:
# 1. Open your terminal.
# 2. Make the script executable: `chmod +x api_test_suite.sh`
# 3. Run the script: `./api_test_suite.sh` or bash ./api_test_suite.sh > test_results.txt 2>&1
#
# ==============================================================================

# Define the API endpoint URL
API_URL="http://localhost:3000/api/generate/enhanced"

# --- SUITE A: SMOKE TESTS ---
echo "--- SUITE A: SMOKE TESTS ---"
echo "Running basic tests to ensure the API is online and responsive..."

# Test 1: Basic valid request for ADDITION model
echo "# Test A.1: Basic ADDITION request"
curl -s -X POST "$API_URL" \
-H "Content-Type: application/json" \
-d '{
  "model_id": "ADDITION",
  "difficulty_level": "1.1"
}' | jq

# Test 2: Basic valid request for SUBTRACTION model
echo "# Test A.2: Basic SUBTRACTION request"
curl -s -X POST "$API_URL" \
-H "Content-Type: application/json" \
-d '{
  "model_id": "SUBTRACTION",
  "difficulty_level": "1.2"
}' | jq


# --- SUITE B: MODEL COVERAGE TESTS ---
echo ""
echo "--- SUITE B: MODEL COVERAGE TESTS ---"
echo "Testing every mathematical model to ensure basic generation and catch crashes..."

# Test B.1: ADDITION
echo "# Test B.1: ADDITION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "4.1"}' | jq

# Test B.2: SUBTRACTION
echo "# Test B.2: SUBTRACTION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "SUBTRACTION", "difficulty_level": "4.1"}' | jq

# Test B.3: MULTIPLICATION
echo "# Test B.3: MULTIPLICATION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MULTIPLICATION", "difficulty_level": "4.1"}' | jq

# Test B.4: DIVISION
echo "# Test B.4: DIVISION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "DIVISION", "difficulty_level": "4.1"}' | jq

# Test B.5: PERCENTAGE
echo "# Test B.5: PERCENTAGE model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "PERCENTAGE", "difficulty_level": "4.1"}' | jq

# Test B.6: FRACTION
echo "# Test B.6: FRACTION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "FRACTION", "difficulty_level": "4.1"}' | jq

# Test B.7: COUNTING
echo "# Test B.7: COUNTING model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "COUNTING", "difficulty_level": "4.1"}' | jq

# Test B.8: TIME_RATE
echo "# Test B.8: TIME_RATE model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "TIME_RATE", "difficulty_level": "4.1"}' | jq

# Test B.9: CONVERSION
echo "# Test B.9: CONVERSION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "CONVERSION", "difficulty_level": "4.1"}' | jq

# Test B.10: COMPARISON
echo "# Test B.10: COMPARISON model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "COMPARISON", "difficulty_level": "4.1"}' | jq

# Test B.11: MULTI_STEP
echo "# Test B.11: MULTI_STEP model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MULTI_STEP", "difficulty_level": "4.1"}' | jq

# Test B.12: LINEAR_EQUATION
echo "# Test B.12: LINEAR_EQUATION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "LINEAR_EQUATION", "difficulty_level": "4.1"}' | jq

# Test B.13: UNIT_RATE
echo "# Test B.13: UNIT_RATE model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "UNIT_RATE", "difficulty_level": "4.1"}' | jq

# Test B.14: COIN_RECOGNITION
echo "# Test B.14: COIN_RECOGNITION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "COIN_RECOGNITION", "difficulty_level": "4.1"}' | jq

# Test B.15: CHANGE_CALCULATION
echo "# Test B.15: CHANGE_CALCULATION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "CHANGE_CALCULATION", "difficulty_level": "4.1"}' | jq

# Test B.16: MONEY_COMBINATIONS
echo "# Test B.16: MONEY_COMBINATIONS model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MONEY_COMBINATIONS", "difficulty_level": "4.1"}' | jq

# Test B.17: MIXED_MONEY_UNITS
echo "# Test B.17: MIXED_MONEY_UNITS model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MIXED_MONEY_UNITS", "difficulty_level": "4.1"}' | jq

# Test B.18: MONEY_FRACTIONS
echo "# Test B.18: MONEY_FRACTIONS model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MONEY_FRACTIONS", "difficulty_level": "4.1"}' | jq

# Test B.19: MONEY_SCALING
echo "# Test B.19: MONEY_SCALING model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MONEY_SCALING", "difficulty_level": "4.1"}' | jq

# Test B.20: SHAPE_RECOGNITION
echo "# Test B.20: SHAPE_RECOGNITION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "SHAPE_RECOGNITION", "difficulty_level": "4.1"}' | jq

# Test B.21: SHAPE_PROPERTIES
echo "# Test B.21: SHAPE_PROPERTIES model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "SHAPE_PROPERTIES", "difficulty_level": "4.1"}' | jq

# Test B.22: ANGLE_MEASUREMENT
echo "# Test B.22: ANGLE_MEASUREMENT model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ANGLE_MEASUREMENT", "difficulty_level": "4.1"}' | jq

# Test B.23: POSITION_DIRECTION
echo "# Test B.23: POSITION_DIRECTION model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "POSITION_DIRECTION", "difficulty_level": "4.1"}' | jq

# Test B.24: AREA_PERIMETER
echo "# Test B.24: AREA_PERIMETER model"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "AREA_PERIMETER", "difficulty_level": "4.1"}' | jq


# --- SUITE C: FORMAT COVERAGE TESTS ---
echo ""
echo "--- SUITE C: FORMAT COVERAGE TESTS ---"
echo "Testing every question format using the ADDITION model..."

# Test C.1: DIRECT_CALCULATION
echo "# Test C.1: DIRECT_CALCULATION format"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "5.3", "format_preference": "DIRECT_CALCULATION"}' | jq

# Test C.2: COMPARISON
echo "# Test C.2: COMPARISON format"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "5.3", "format_preference": "COMPARISON"}' | jq

# Test C.3: ESTIMATION
echo "# Test C.3: ESTIMATION format"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "5.3", "format_preference": "ESTIMATION"}' | jq

# Test C.4: ORDERING
echo "# Test C.4: ORDERING format"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "5.3", "format_preference": "ORDERING"}' | jq

# Test C.5: VALIDATION
echo "# Test C.5: VALIDATION format"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "5.3", "format_preference": "VALIDATION"}' | jq

# Test C.6: MULTI_STEP
echo "# Test C.6: MULTI_STEP format"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "5.3", "format_preference": "MULTI_STEP"}' | jq

# Test C.7: MISSING_VALUE
echo "# Test C.7: MISSING_VALUE format"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "5.3", "format_preference": "MISSING_VALUE"}' | jq

# Test C.8: PATTERN_RECOGNITION
echo "# Test C.8: PATTERN_RECOGNITION format"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "5.3", "format_preference": "PATTERN_RECOGNITION"}' | jq


# --- SUITE D: DIFFICULTY PROGRESSION TESTS ---
echo ""
echo "--- SUITE D: DIFFICULTY PROGRESSION TESTS ---"
echo "Testing smooth difficulty increase for the MULTIPLICATION model..."

# Test D.1: Year 2.1
echo "# Test D.1: MULTIPLICATION at difficulty 2.1"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MULTIPLICATION", "difficulty_level": "2.1"}' | jq

# Test D.2: Year 2.4
echo "# Test D.2: MULTIPLICATION at difficulty 2.4"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MULTIPLICATION", "difficulty_level": "2.4"}' | jq

# Test D.3: Year 3.2
echo "# Test D.3: MULTIPLICATION at difficulty 3.2"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MULTIPLICATION", "difficulty_level": "3.2"}' | jq

# Test D.4: Year 4.1
echo "# Test D.4: MULTIPLICATION at difficulty 4.1"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MULTIPLICATION", "difficulty_level": "4.1"}' | jq

# Test D.5: Year 5.3
echo "# Test D.5: MULTIPLICATION at difficulty 5.3"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MULTIPLICATION", "difficulty_level": "5.3"}' | jq

# Test D.6: Year 6.4
echo "# Test D.6: MULTIPLICATION at difficulty 6.4"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "MULTIPLICATION", "difficulty_level": "6.4"}' | jq


# --- SUITE E: SCENARIO THEME TESTS ---
echo ""
echo "--- SUITE E: SCENARIO THEME TESTS ---"
echo "Testing that each scenario theme can be applied..."

# Test E.1: SHOPPING
echo "# Test E.1: SHOPPING theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "SHOPPING"}' | jq

# Test E.2: COOKING
echo "# Test E.2: COOKING theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "COOKING"}' | jq

# Test E.3: SPORTS
echo "# Test E.3: SPORTS theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "SPORTS"}' | jq

# Test E.4: SCHOOL
echo "# Test E.4: SCHOOL theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "SCHOOL"}' | jq

# Test E.5: POCKET_MONEY
echo "# Test E.5: POCKET_MONEY theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "POCKET_MONEY"}' | jq

# Test E.6: NATURE
echo "# Test E.6: NATURE theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "NATURE"}' | jq

# Test E.7: TRANSPORT
echo "# Test E.7: TRANSPORT theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "TRANSPORT"}' | jq

# Test E.8: COLLECTIONS
echo "# Test E.8: COLLECTIONS theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "COLLECTIONS"}' | jq

# Test E.9: HOUSEHOLD
echo "# Test E.9: HOUSEHOLD theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "HOUSEHOLD"}' | jq

# Test E.10: CELEBRATIONS
echo "# Test E.10: CELEBRATIONS theme"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "3.1", "format_preference": "DIRECT_CALCULATION", "scenario_theme": "CELEBRATIONS"}' | jq


# --- SUITE F: EDGE CASE AND ERROR HANDLING TESTS ---
echo ""
echo "--- SUITE F: EDGE CASE AND ERROR HANDLING TESTS ---"
echo "Testing invalid inputs and expected error responses..."

# Test F.1: Non-existent model_id
echo "# Test F.1: Request with a non-existent model_id"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "FOOBAR", "difficulty_level": "4.1"}' | jq

# Test F.2: Invalid difficulty_level
echo "# Test F.2: Request with an invalid difficulty_level"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "9.9"}' | jq

# Test F.3: Invalid format_preference
echo "# Test F.3: Request with an invalid format_preference"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "4.1", "format_preference": "INVALID_FORMAT"}' | jq

# Test F.4: Known broken model
echo "# Test F.4: Request with a dedicated broken model (TEST_BROKEN)"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "TEST_BROKEN", "difficulty_level": "6.1"}' | jq

# Test F.5: Quantity greater than 20
echo "# Test F.5: Request with a quantity greater than 20"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "ADDITION", "difficulty_level": "4.1", "quantity": 25}' | jq

# Test F.6: Missing required model_id field
echo "# Test F.6: Request missing the required model_id field"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"difficulty_level": "4.1"}' | jq


# --- SUITE G: BATCH GENERATION TESTS ---
echo ""
echo "--- SUITE G: BATCH GENERATION TESTS ---"
echo "Testing the ability to generate multiple questions in one request..."

# Test G.1: Request for 5 questions
echo "# Test G.1: Request a batch of 5 questions"
curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d '{"model_id": "SUBTRACTION", "difficulty_level": "3.3", "quantity": 5}' | jq


echo ""
echo "--- API TEST SUITE COMPLETE ---"

```
--- END FILE: api_test_suite.sh ---

--- START FILE: app\api\curriculum\curated-mappings\route.ts ---
```typescript
/**
 * API endpoints for curated curriculum-model mappings
 */

import { NextRequest, NextResponse } from 'next/server';
import { curatedMappingsManager, CuratedMapping } from '@/lib/curriculum/curated-mappings';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const action = searchParams.get('action');

    switch (action) {
      case 'all':
        const mappings = curatedMappingsManager.getAllMappings();
        return NextResponse.json({ mappings });

      case 'get':
        const strand = searchParams.get('strand');
        const substrand = searchParams.get('substrand');
        const year = searchParams.get('year');

        if (!strand || !substrand || !year) {
          return NextResponse.json(
            { error: 'Missing required parameters: strand, substrand, year' },
            { status: 400 }
          );
        }

        const mapping = curatedMappingsManager.getMapping(strand, substrand, parseInt(year));
        return NextResponse.json({ mapping });

      case 'suggested':
        const filterStrand = searchParams.get('strand');
        const filterSubstrand = searchParams.get('substrand');
        const filterYear = searchParams.get('year');
        const description = searchParams.get('description') || '';

        if (!filterStrand || !filterSubstrand || !filterYear) {
          return NextResponse.json(
            { error: 'Missing required parameters: strand, substrand, year' },
            { status: 400 }
          );
        }

        const suggested = curatedMappingsManager.getSuggestedModels({
          strand: filterStrand,
          substrand: filterSubstrand,
          year: parseInt(filterYear),
          description,
          contentDomainRef: ''
        });
        return NextResponse.json({ suggested });

      case 'matrix':
        const matrixStrands = searchParams.get('strands')?.split(',') || [];
        const matrixSubstrands = searchParams.get('substrands')?.split(',') || [];
        const matrixYears = searchParams.get('years')?.split(',').map(Number) || [];
        const matrixModels = searchParams.get('models')?.split(',') || [];

        const matrix = curatedMappingsManager.buildMappingMatrix(
          matrixStrands,
          matrixSubstrands,
          matrixYears,
          matrixModels
        );
        return NextResponse.json({ matrix });

      case 'statistics':
        const statistics = curatedMappingsManager.getStatistics();
        return NextResponse.json({ statistics });

      case 'export':
        const exportData = curatedMappingsManager.exportMappings();
        return new NextResponse(exportData, {
          headers: {
            'Content-Type': 'application/json',
            'Content-Disposition': `attachment; filename="curated-mappings-${new Date().toISOString().split('T')[0]}.json"`
          }
        });

      default:
        return NextResponse.json(
          { error: 'Invalid action. Use: all, get, suggested, matrix, statistics, or export' },
          { status: 400 }
        );
    }
  } catch (error) {
    console.error('Error in curated mappings GET:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { action } = body;

    switch (action) {
      case 'upsert':
        const {
          strand,
          substrand,
          year,
          primaryModel,
          secondaryModels,
          excludedModels,
          confidence,
          notes,
          status,
          approvedBy,
          testedCount,
          averageRating
        } = body;

        if (!strand || !substrand || !year) {
          return NextResponse.json(
            { error: 'Missing required fields: strand, substrand, year' },
            { status: 400 }
          );
        }

        const updates: Partial<CuratedMapping> = {};
        if (primaryModel !== undefined) updates.primaryModel = primaryModel;
        if (secondaryModels !== undefined) updates.secondaryModels = secondaryModels;
        if (excludedModels !== undefined) updates.excludedModels = excludedModels;
        if (confidence !== undefined) updates.confidence = confidence;
        if (notes !== undefined) updates.notes = notes;
        if (status !== undefined) updates.status = status;
        if (approvedBy !== undefined) updates.approvedBy = approvedBy;
        if (testedCount !== undefined) updates.testedCount = testedCount;
        if (averageRating !== undefined) updates.averageRating = averageRating;

        const mapping = curatedMappingsManager.upsertMapping(
          strand,
          substrand,
          year,
          updates
        );

        return NextResponse.json({ mapping });

      case 'batch-update':
        const { updates: batchUpdates } = body;

        if (!Array.isArray(batchUpdates)) {
          return NextResponse.json(
            { error: 'Updates must be an array' },
            { status: 400 }
          );
        }

        curatedMappingsManager.batchUpdateModels(batchUpdates);
        return NextResponse.json({ success: true });

      case 'approve':
        const { mappingId, approver } = body;

        if (!mappingId || !approver) {
          return NextResponse.json(
            { error: 'Missing required fields: mappingId, approver' },
            { status: 400 }
          );
        }

        curatedMappingsManager.approveMapping(mappingId, approver);
        return NextResponse.json({ success: true });

      case 'mark-for-review':
        const { reviewMappingId } = body;

        if (!reviewMappingId) {
          return NextResponse.json(
            { error: 'Missing required field: reviewMappingId' },
            { status: 400 }
          );
        }

        curatedMappingsManager.markForReview(reviewMappingId);
        return NextResponse.json({ success: true });

      case 'import':
        const { data } = body;
        if (!data) {
          return NextResponse.json(
            { error: 'Missing data field' },
            { status: 400 }
          );
        }

        curatedMappingsManager.importMappings(data);
        return NextResponse.json({ success: true });

      case 'clear':
        // This is a destructive action, could add additional confirmation
        curatedMappingsManager.clearAllMappings();
        return NextResponse.json({ success: true });

      default:
        return NextResponse.json(
          { error: 'Invalid action. Use: upsert, batch-update, approve, mark-for-review, import, or clear' },
          { status: 400 }
        );
    }
  } catch (error) {
    console.error('Error in curated mappings POST:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal server error' },
      { status: 500 }
    );
  }
}

// Handle other HTTP methods
export async function PUT(request: NextRequest) {
  return POST(request); // Alias PUT to POST for convenience
}

export async function PATCH(request: NextRequest) {
  return POST(request); // Alias PATCH to POST for convenience
}

export async function DELETE(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const action = searchParams.get('action');

    switch (action) {
      case 'mapping':
        const strand = searchParams.get('strand');
        const substrand = searchParams.get('substrand');
        const year = searchParams.get('year');

        if (!strand || !substrand || !year) {
          return NextResponse.json(
            { error: 'Missing required parameters: strand, substrand, year' },
            { status: 400 }
          );
        }

        // Note: curatedMappingsManager doesn't have a delete method yet
        // Could be implemented if needed
        return NextResponse.json(
          { error: 'Delete mapping operation not implemented' },
          { status: 501 }
        );

      case 'all':
        curatedMappingsManager.clearAllMappings();
        return NextResponse.json({ success: true });

      default:
        return NextResponse.json(
          { error: 'Invalid action. Use: mapping or all' },
          { status: 400 }
        );
    }
  } catch (error) {
    console.error('Error in curated mappings DELETE:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```
--- END FILE: app\api\curriculum\curated-mappings\route.ts ---

--- START FILE: app\api\curriculum\test-tracking\route.ts ---
```typescript
/**
 * API endpoints for curriculum test tracking
 */

import { NextRequest, NextResponse } from 'next/server';
import { testTracker, TestResult } from '@/lib/curriculum/test-tracking';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const action = searchParams.get('action');

    switch (action) {
      case 'all':
        return NextResponse.json({ results: testTracker.getAllResults() });

      case 'summary':
        const strand = searchParams.get('strand');
        const substrand = searchParams.get('substrand');
        const year = searchParams.get('year');
        const modelId = searchParams.get('modelId');

        if (!strand || !substrand || !year || !modelId) {
          return NextResponse.json(
            { error: 'Missing required parameters: strand, substrand, year, modelId' },
            { status: 400 }
          );
        }

        const summary = testTracker.getSummary(strand, substrand, parseInt(year), modelId);
        return NextResponse.json({ summary });

      case 'progress':
        const strands = searchParams.get('strands')?.split(',') || [];
        const substrands = searchParams.get('substrands')?.split(',') || [];
        const years = searchParams.get('years')?.split(',').map(Number) || [];
        const models = searchParams.get('models')?.split(',') || [];

        const progress = testTracker.getProgress(strands, substrands, years, models);
        return NextResponse.json({ progress });

      case 'export':
        const exportData = testTracker.exportResults();
        return new NextResponse(exportData, {
          headers: {
            'Content-Type': 'application/json',
            'Content-Disposition': `attachment; filename="test-results-${new Date().toISOString().split('T')[0]}.json"`
          }
        });

      default:
        return NextResponse.json(
          { error: 'Invalid action. Use: all, summary, progress, or export' },
          { status: 400 }
        );
    }
  } catch (error) {
    console.error('Error in test tracking GET:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { action } = body;

    switch (action) {
      case 'add':
        const {
          strand,
          substrand,
          year,
          modelId,
          questionGenerated,
          parameters,
          success,
          rating,
          notes,
          generationTime,
          errorMessage,
          sessionId,
          testerName
        } = body;

        if (!strand || !substrand || !year || !modelId) {
          return NextResponse.json(
            { error: 'Missing required fields: strand, substrand, year, modelId' },
            { status: 400 }
          );
        }

        const testResult = testTracker.addTestResult({
          strand,
          substrand,
          year,
          modelId,
          questionGenerated: questionGenerated || '',
          parameters: parameters || {},
          success: success || false,
          rating,
          notes,
          generationTime,
          errorMessage,
          sessionId,
          testerName
        });

        return NextResponse.json({ result: testResult });

      case 'update-rating':
        const { testId, newRating, newNotes } = body;

        if (!testId || !newRating) {
          return NextResponse.json(
            { error: 'Missing required fields: testId, newRating' },
            { status: 400 }
          );
        }

        testTracker.updateRating(testId, newRating, newNotes);
        return NextResponse.json({ success: true });

      case 'import':
        const { data } = body;
        if (!data) {
          return NextResponse.json(
            { error: 'Missing data field' },
            { status: 400 }
          );
        }

        testTracker.importResults(data);
        return NextResponse.json({ success: true });

      case 'clear':
        // This is a destructive action, could add additional confirmation
        testTracker.clearAllResults();
        return NextResponse.json({ success: true });

      default:
        return NextResponse.json(
          { error: 'Invalid action. Use: add, update-rating, import, or clear' },
          { status: 400 }
        );
    }
  } catch (error) {
    console.error('Error in test tracking POST:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal server error' },
      { status: 500 }
    );
  }
}

// Handle other HTTP methods
export async function PUT(request: NextRequest) {
  return POST(request); // Alias PUT to POST for convenience
}

export async function DELETE(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const testId = searchParams.get('testId');

    if (!testId) {
      return NextResponse.json(
        { error: 'Missing testId parameter' },
        { status: 400 }
      );
    }

    // Note: testTracker doesn't have a delete method yet
    // Could be implemented if needed
    return NextResponse.json(
      { error: 'Delete operation not implemented' },
      { status: 501 }
    );
  } catch (error) {
    console.error('Error in test tracking DELETE:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```
--- END FILE: app\api\curriculum\test-tracking\route.ts ---

--- START FILE: app\api\curriculum-bulk\route.ts ---
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { GeneratedQuestion, GenerationSetup, IMathModel } from '@/lib/types';
import { curriculumParser, CurriculumFilter } from '@/lib/curriculum/curriculum-parser';
import { curriculumModelMapper } from '@/lib/curriculum/curriculum-model-mapping';
import { getModel } from '@/lib/math-engine';
import { MODEL_STATUS_REGISTRY, ModelStatus } from '@/lib/models/model-status';
import { QuestionOrchestrator, EnhancedQuestionRequest } from '@/lib/orchestrator/question-orchestrator';
import { ScenarioService } from '@/lib/services/scenario.service';
import { DistractorEngine } from '@/lib/services/distractor-engine.service';
import { QuestionFormat, ScenarioTheme } from '@/lib/types/question-formats';

const ENHANCED_MODELS = ['ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'PERCENTAGE', 'FRACTION'];
const MAX_COMBINATIONS_PER_REQUEST = 500;
const MAX_QUESTIONS_PER_COMBINATION = 10;

// Math engine adapter for orchestrator
class MathEngineAdapter {
  async generate(model: string, params: any): Promise<any> {
    const modelInstance = getModel(model as any);

    // Ensure params have all required properties by merging with defaults
    const defaultParams = modelInstance.getDefaultParams(4);
    const mergedParams = params ? { ...defaultParams, ...params } : defaultParams;

    return modelInstance.generate(mergedParams);
  }

  getModel(modelId: string): IMathModel<any, any> {
    return getModel(modelId as any);
  }
}

// Format distribution weights based on curriculum requirements
const FORMAT_WEIGHTS = {
  [QuestionFormat.DIRECT_CALCULATION]: 0.30,
  [QuestionFormat.COMPARISON]: 0.15,
  [QuestionFormat.ESTIMATION]: 0.15,
  [QuestionFormat.VALIDATION]: 0.10,
  [QuestionFormat.MULTI_STEP]: 0.10,
  [QuestionFormat.MISSING_VALUE]: 0.10,
  [QuestionFormat.ORDERING]: 0.05,
  [QuestionFormat.PATTERN_RECOGNITION]: 0.05
};

// Fine-grained format compatibility matrix for each model
const MODEL_FORMAT_COMPATIBILITY: Record<string, QuestionFormat[]> = {
  // Basic arithmetic - focus on calculation and word problems
  'ADDITION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.COMPARISON
  ],
  'SUBTRACTION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.COMPARISON
  ],
  'MULTIPLICATION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.COMPARISON,
    QuestionFormat.PATTERN_RECOGNITION
  ],
  'DIVISION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.VALIDATION
  ],

  // Advanced arithmetic - can use estimation and validation
  'PERCENTAGE': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.ESTIMATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.VALIDATION,
    QuestionFormat.MULTI_STEP
  ],
  'FRACTION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.ORDERING,
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.VALIDATION
  ],

  // Complex models - full range of formats
  'MULTI_STEP': [
    QuestionFormat.MULTI_STEP,
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.VALIDATION
  ],
  'LINEAR_EQUATION': [
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.PATTERN_RECOGNITION,
    QuestionFormat.DIRECT_CALCULATION
  ],
  'COMPARISON': [
    QuestionFormat.COMPARISON,
    QuestionFormat.ORDERING,
    QuestionFormat.VALIDATION
  ],

  // Measurement and conversion
  'CONVERSION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.ESTIMATION,
    QuestionFormat.VALIDATION
  ],
  'TIME_RATE': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.COMPARISON
  ],
  'UNIT_RATE': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.MULTI_STEP
  ],

  // Counting and patterns
  'COUNTING': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.PATTERN_RECOGNITION,
    QuestionFormat.ORDERING
  ],

  // Money-specific models
  'COIN_RECOGNITION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.ORDERING,
    QuestionFormat.COMPARISON
  ],
  'CHANGE_CALCULATION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE
  ],
  'MONEY_COMBINATIONS': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.PATTERN_RECOGNITION,
    QuestionFormat.VALIDATION
  ],
  'MIXED_MONEY_UNITS': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.MULTI_STEP
  ],
  'MONEY_FRACTIONS': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.MISSING_VALUE
  ],
  'MONEY_SCALING': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.PATTERN_RECOGNITION
  ],

  // Geometry models
  'SHAPE_RECOGNITION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.ORDERING
  ],
  'SHAPE_PROPERTIES': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.VALIDATION
  ],
  'ANGLE_MEASUREMENT': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.ESTIMATION
  ],
  'POSITION_DIRECTION': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.PATTERN_RECOGNITION
  ],
  'AREA_PERIMETER': [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.COMPARISON,
    QuestionFormat.MISSING_VALUE
  ]
};

// Difficulty-based format restrictions
const DIFFICULTY_FORMAT_LIMITS: Record<number, QuestionFormat[]> = {
  1: [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON
  ],
  2: [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.MULTI_STEP
  ],
  3: [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE
  ],
  4: [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.ESTIMATION,
    QuestionFormat.ORDERING
  ],
  5: [
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.ESTIMATION,
    QuestionFormat.ORDERING,
    QuestionFormat.VALIDATION
  ],
  6: [
    // Year 6 can use all formats
    QuestionFormat.DIRECT_CALCULATION,
    QuestionFormat.COMPARISON,
    QuestionFormat.MULTI_STEP,
    QuestionFormat.MISSING_VALUE,
    QuestionFormat.ESTIMATION,
    QuestionFormat.ORDERING,
    QuestionFormat.VALIDATION,
    QuestionFormat.PATTERN_RECOGNITION
  ]
};

// Theme variety for different contexts
const AVAILABLE_THEMES = [
  ScenarioTheme.SHOPPING,
  ScenarioTheme.SCHOOL,
  ScenarioTheme.SPORTS,
  ScenarioTheme.COOKING,
  ScenarioTheme.POCKET_MONEY,
  ScenarioTheme.NATURE
];

// Map curriculum substrands to appropriate formats
function getPreferredFormats(substrand: string): QuestionFormat[] {
  const formatMap: Record<string, QuestionFormat[]> = {
    'estimate, use inverses and check': [QuestionFormat.ESTIMATION, QuestionFormat.VALIDATION],
    'compare and order decimals': [QuestionFormat.COMPARISON, QuestionFormat.ORDERING],
    'solve problems': [QuestionFormat.MULTI_STEP, QuestionFormat.MISSING_VALUE],
    'add / subtract mentally': [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.ESTIMATION],
    'multiply / divide mentally': [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.VALIDATION],
    'comparing and ordering fractions': [QuestionFormat.COMPARISON, QuestionFormat.ORDERING]
  };

  return formatMap[substrand] || [QuestionFormat.DIRECT_CALCULATION];
}

// Select format based on index and preferences - with enhanced intelligence
function selectFormat(
  questionIndex: number,
  preferredFormats: QuestionFormat[],
  formatVariety: boolean,
  modelId?: string,
  yearLevel?: number
): QuestionFormat {
  // No variety requested - use simplest format
  if (!formatVariety) {
    return QuestionFormat.DIRECT_CALCULATION;
  }

  // User has specific preferences - respect them but validate
  if (preferredFormats.length > 0) {
    const selectedFormat = preferredFormats[questionIndex % preferredFormats.length];

    // Validate against year level restrictions if provided
    if (yearLevel && DIFFICULTY_FORMAT_LIMITS[yearLevel]) {
      const allowedFormats = DIFFICULTY_FORMAT_LIMITS[yearLevel];
      if (!allowedFormats.includes(selectedFormat)) {
        // Fall back to first allowed format
        return allowedFormats[0];
      }
    }

    return selectedFormat;
  }

  // Get compatible formats for the model
  let compatibleFormats: QuestionFormat[] = [];

  if (modelId && MODEL_FORMAT_COMPATIBILITY[modelId]) {
    compatibleFormats = MODEL_FORMAT_COMPATIBILITY[modelId];
  } else {
    // Unknown model - use safe defaults
    compatibleFormats = [
      QuestionFormat.DIRECT_CALCULATION,
      QuestionFormat.MULTI_STEP,
      QuestionFormat.COMPARISON
    ];
  }

  // Apply year level restrictions if provided
  if (yearLevel && DIFFICULTY_FORMAT_LIMITS[yearLevel]) {
    const yearFormats = DIFFICULTY_FORMAT_LIMITS[yearLevel];
    // Intersection of compatible and year-appropriate formats
    compatibleFormats = compatibleFormats.filter(f => yearFormats.includes(f));

    // Ensure we have at least one format
    if (compatibleFormats.length === 0) {
      compatibleFormats = [QuestionFormat.DIRECT_CALCULATION];
    }
  }

  // Select from compatible formats using rotation
  return compatibleFormats[questionIndex % compatibleFormats.length];
}

// Select theme for variety
function selectTheme(
  questionIndex: number,
  preferredThemes: ScenarioTheme[],
  themeVariety: boolean
): ScenarioTheme {
  if (!themeVariety) {
    return ScenarioTheme.SHOPPING;
  }

  const themes = preferredThemes.length > 0 ? preferredThemes : AVAILABLE_THEMES;
  return themes[questionIndex % themes.length];
}


interface BulkGenerationRequest {
  strands: string[];
  substrands?: string[];
  years: number[];
  subLevels: number[];
  questionsPerCombination: number;
  useEnhancedDifficulty?: boolean;
  contextType?: string;
  sessionId?: string;
  // Enhanced system options
  useEnhancedGeneration?: boolean;
  formatVariety?: boolean;
  themeVariety?: boolean;
  preferredFormats?: QuestionFormat[];
  preferredThemes?: ScenarioTheme[];
}

interface CombinationRequest {
  strand: string;
  substrand: string;
  year: number;
  subLevel: number;
  primaryModel: string;
  suggestedModels: string[];
  curriculumFilter: CurriculumFilter;
}

interface CombinationResult {
  strand: string;
  substrand: string;
  year: number;
  subLevel: number;
  primaryModel: string;
  suggestedModels: string[];
  status: 'completed' | 'error';
  questionsGenerated: number;
  questions?: GeneratedQuestion[];
  error?: string;
  generationTimeMs?: number;
}

interface BulkGenerationResponse {
  totalCombinations: number;
  completedCombinations: number;
  totalQuestions: number;
  totalGenerationTimeMs: number;
  averageTimePerCombination: number;
  averageTimePerQuestion: number;
  results: CombinationResult[];
  errors: string[];
  metadata: {
    request: BulkGenerationRequest;
    timestamp: Date;
    configuration: {
      enhancedModelsUsed: string[];
      modelsSkipped: string[];
      combinationsSkipped: number;
    };
  };
}

export async function POST(req: NextRequest) {
  const startTime = Date.now();

  try {
    const body: BulkGenerationRequest = await req.json();
    const {
      strands,
      substrands,
      years,
      subLevels,
      questionsPerCombination,
      useEnhancedDifficulty = true,
      contextType = 'money',
      sessionId,
      // Enhanced generation options
      useEnhancedGeneration = true,
      formatVariety = true,
      themeVariety = true,
      preferredFormats = [],
      preferredThemes = []
    } = body;

    // Validation
    if (!strands || strands.length === 0) {
      return NextResponse.json(
        { error: 'At least one strand must be provided' },
        { status: 400 }
      );
    }

    if (!years || years.length === 0) {
      return NextResponse.json(
        { error: 'At least one year level must be provided' },
        { status: 400 }
      );
    }

    if (!subLevels || subLevels.length === 0) {
      return NextResponse.json(
        { error: 'At least one sub-level must be provided' },
        { status: 400 }
      );
    }

    if (questionsPerCombination < 1 || questionsPerCombination > MAX_QUESTIONS_PER_COMBINATION) {
      return NextResponse.json(
        { error: `Questions per combination must be between 1 and ${MAX_QUESTIONS_PER_COMBINATION}` },
        { status: 400 }
      );
    }

    // Build combinations to generate
    const combinations: CombinationRequest[] = [];
    const skippedCombinations: string[] = [];
    const modelsUsed = new Set<string>();
    const modelsSkipped = new Set<string>();

    for (const strand of strands) {
      // Get substrands for this strand
      const strandSubstrands = substrands || curriculumParser.getSubstrands(strand);

      for (const substrand of strandSubstrands) {
        // Check if this substrand exists for this strand
        const availableSubstrands = curriculumParser.getSubstrands(strand);
        if (!availableSubstrands.includes(substrand)) {
          skippedCombinations.push(`${strand} â ${substrand} (substrand not found)`);
          continue;
        }

        // Get available years for this strand/substrand
        const availableYears = curriculumParser.getAvailableYears(strand, substrand);

        for (const year of years) {
          if (!availableYears.includes(year)) {
            skippedCombinations.push(`${strand} â ${substrand} â Year ${year} (year not available)`);
            continue;
          }

          for (const subLevel of subLevels) {
            // Get curriculum description
            const curriculumFilter = curriculumParser.getCurriculumDescription(strand, substrand, year);

            if (!curriculumFilter) {
              skippedCombinations.push(`${strand} â ${substrand} â Year ${year}.${subLevel} (no curriculum description)`);
              continue;
            }

            // Get suggested models
            const suggestedModels = curriculumModelMapper.getSuggestedModels(curriculumFilter);
            const primaryModel = curriculumModelMapper.getPrimaryModel(curriculumFilter);

            if (!primaryModel || suggestedModels.length === 0) {
              skippedCombinations.push(`${strand} â ${substrand} â Year ${year}.${subLevel} (no suitable models)`);
              continue;
            }

            // Check if model is available and working
            const modelInfo = MODEL_STATUS_REGISTRY[primaryModel];
            if (!modelInfo) {
              skippedCombinations.push(`${strand} â ${substrand} â Year ${year}.${subLevel} (model ${primaryModel} not found)`);
              modelsSkipped.add(primaryModel);
              continue;
            }

            if (modelInfo.status === ModelStatus.BROKEN) {
              skippedCombinations.push(`${strand} â ${substrand} â Year ${year}.${subLevel} (model ${primaryModel} is broken)`);
              modelsSkipped.add(primaryModel);
              continue;
            }

            if (!modelInfo.supportedYears.includes(year)) {
              skippedCombinations.push(`${strand} â ${substrand} â Year ${year}.${subLevel} (model ${primaryModel} doesn't support year ${year})`);
              continue;
            }

            modelsUsed.add(primaryModel);
            combinations.push({
              strand,
              substrand,
              year,
              subLevel,
              primaryModel,
              suggestedModels,
              curriculumFilter
            });
          }
        }
      }
    }

    // Check if we have too many combinations
    if (combinations.length > MAX_COMBINATIONS_PER_REQUEST) {
      return NextResponse.json(
        {
          error: `Too many combinations requested: ${combinations.length}. Maximum allowed: ${MAX_COMBINATIONS_PER_REQUEST}`,
          estimatedCombinations: combinations.length,
          maxAllowed: MAX_COMBINATIONS_PER_REQUEST
        },
        { status: 400 }
      );
    }

    if (combinations.length === 0) {
      return NextResponse.json(
        {
          error: 'No valid combinations found',
          skippedCombinations,
          totalSkipped: skippedCombinations.length
        },
        { status: 400 }
      );
    }

    // Generate questions for each combination
    const results: CombinationResult[] = [];
    const errors: string[] = [];
    let totalQuestions = 0;

    // Initialize enhanced generation system (always required now)
    const mathEngine = new MathEngineAdapter();
    const scenarioService = new ScenarioService();
    const distractorEngine = new DistractorEngine();
    const orchestrator = new QuestionOrchestrator(mathEngine, scenarioService, distractorEngine);

    for (let i = 0; i < combinations.length; i++) {
      const combination = combinations[i];
      const combinationStartTime = Date.now();

      try {
        const questions: GeneratedQuestion[] = [];

        // Generate the specified number of questions for this combination
        for (let q = 0; q < questionsPerCombination; q++) {
          try {
            let generatedQuestion: GeneratedQuestion;

            // Always use enhanced generation system
            if (!orchestrator) {
              throw new Error('Enhanced generation system not initialized');
            }

            // Determine preferred formats based on curriculum substrand
            const curricularFormats = getPreferredFormats(combination.substrand);
            const availableFormats = preferredFormats.length > 0 ? preferredFormats : curricularFormats;

            // Select format and theme for variety
            const selectedFormat = selectFormat(q, availableFormats, formatVariety, combination.primaryModel, combination.year);
            const selectedTheme = selectTheme(q, preferredThemes, themeVariety);

            // Create enhanced question request
            const enhancedRequest: EnhancedQuestionRequest = {
              model_id: combination.primaryModel,
              difficulty_level: `${combination.year}.${combination.subLevel}`,
              format_preference: selectedFormat,
              scenario_theme: selectedTheme,
              pedagogical_focus: combination.substrand,
              session_id: sessionId
            };

            const enhancedQuestion = await orchestrator.generateQuestion(enhancedRequest);

            // Create enhanced generation setup with bulk API specific information
            const enhancedGenerationSetup: GenerationSetup = {
              ...enhancedQuestion.generationSetup!,
              // Update with bulk API specific settings
              format_weights: FORMAT_WEIGHTS,
              theme_variety: themeVariety,
              format_variety: formatVariety,
              scenario_selection_method: themeVariety ? 'rotation' : 'fixed'
            };

            // Adapt to response format
            generatedQuestion = {
              question: enhancedQuestion.text,
              answer: enhancedQuestion.options[enhancedQuestion.correctIndex].text,
              math_output: enhancedQuestion.mathOutput,
              context: enhancedQuestion.scenario,
              metadata: {
                model_id: combination.primaryModel,
                year_level: combination.year,
                sub_level: `${combination.year}.${combination.subLevel}`,
                difficulty_params: enhancedQuestion.difficulty,
                enhanced_system_used: true,
                session_id: sessionId,
                timestamp: new Date()
              },
              generation_setup: enhancedGenerationSetup
            };

            questions.push(generatedQuestion);

          } catch (questionError) {
            const errorMsg = questionError instanceof Error ? questionError.message : 'Unknown error generating question';
            console.error(`Error generating question ${q + 1} for combination ${i + 1}:`, errorMsg);
            // Continue with next question instead of failing the entire combination
          }
        }

        const combinationEndTime = Date.now();
        const generationTimeMs = combinationEndTime - combinationStartTime;

        if (questions.length > 0) {
          results.push({
            strand: combination.strand,
            substrand: combination.substrand,
            year: combination.year,
            subLevel: combination.subLevel,
            primaryModel: combination.primaryModel,
            suggestedModels: combination.suggestedModels,
            status: 'completed',
            questionsGenerated: questions.length,
            questions,
            generationTimeMs
          });
          totalQuestions += questions.length;
        } else {
          const errorMsg = `Failed to generate any questions for ${combination.strand} â ${combination.substrand} â Year ${combination.year}.${combination.subLevel}`;
          results.push({
            strand: combination.strand,
            substrand: combination.substrand,
            year: combination.year,
            subLevel: combination.subLevel,
            primaryModel: combination.primaryModel,
            suggestedModels: combination.suggestedModels,
            status: 'error',
            questionsGenerated: 0,
            error: errorMsg,
            generationTimeMs
          });
          errors.push(errorMsg);
        }

      } catch (combinationError) {
        const errorMsg = combinationError instanceof Error ? combinationError.message : 'Unknown error';
        const errorDetail = `${combination.strand} â ${combination.substrand} â Year ${combination.year}.${combination.subLevel}: ${errorMsg}`;

        results.push({
          strand: combination.strand,
          substrand: combination.substrand,
          year: combination.year,
          subLevel: combination.subLevel,
          primaryModel: combination.primaryModel,
          suggestedModels: combination.suggestedModels,
          status: 'error',
          questionsGenerated: 0,
          error: errorMsg,
          generationTimeMs: Date.now() - combinationStartTime
        });
        errors.push(errorDetail);
      }

      // Add a small delay to prevent overwhelming the system
      if (i < combinations.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 10));
      }
    }

    const endTime = Date.now();
    const totalGenerationTimeMs = endTime - startTime;
    const completedCombinations = results.filter(r => r.status === 'completed').length;

    const response: BulkGenerationResponse = {
      totalCombinations: combinations.length,
      completedCombinations,
      totalQuestions,
      totalGenerationTimeMs,
      averageTimePerCombination: completedCombinations > 0 ? totalGenerationTimeMs / completedCombinations : 0,
      averageTimePerQuestion: totalQuestions > 0 ? totalGenerationTimeMs / totalQuestions : 0,
      results,
      errors,
      metadata: {
        request: body,
        timestamp: new Date(),
        configuration: {
          enhancedModelsUsed: Array.from(modelsUsed).filter(model => ENHANCED_MODELS.includes(model)),
          modelsSkipped: Array.from(modelsSkipped),
          combinationsSkipped: skippedCombinations.length
        }
      }
    };

    return NextResponse.json(response);

  } catch (error) {
    console.error('Error in bulk generation:', error);
    return NextResponse.json(
      {
        error: 'Failed to generate bulk questions',
        details: error instanceof Error ? error.message : 'Unknown error',
        totalGenerationTimeMs: Date.now() - startTime
      },
      { status: 500 }
    );
  }
}

export async function GET() {
  return NextResponse.json({
    message: 'Curriculum Bulk Generation API',
    endpoints: {
      POST: {
        description: 'Generate questions for multiple curriculum combinations',
        maxCombinations: MAX_COMBINATIONS_PER_REQUEST,
        maxQuestionsPerCombination: MAX_QUESTIONS_PER_COMBINATION,
        body: {
          strands: 'string[] (required) - Curriculum strands to generate for',
          substrands: 'string[] (optional) - Specific substrands, defaults to all for selected strands',
          years: 'number[] (required) - Year levels to generate for (1-6)',
          subLevels: 'number[] (required) - Sub-levels to generate for (1-4)',
          questionsPerCombination: 'number (required) - Questions to generate per combination (1-10)',
          useEnhancedDifficulty: 'boolean (optional) - Use enhanced difficulty system where available',
          contextType: 'string (optional) - Context type for questions (default: money)',
          sessionId: 'string (optional) - Session ID for tracking',
          useEnhancedGeneration: 'boolean (optional) - [DEPRECATED] Enhanced system is now always used (default: true)',
          formatVariety: 'boolean (optional) - Enable question format variety (default: true)',
          themeVariety: 'boolean (optional) - Enable scenario theme variety (default: true)',
          preferredFormats: 'string[] (optional) - Preferred question formats to cycle through',
          preferredThemes: 'string[] (optional) - Preferred scenario themes to cycle through'
        },
        example: {
          strands: ['Number and place value'],
          years: [1, 2, 3],
          subLevels: [2, 3],
          questionsPerCombination: 2,
          useEnhancedDifficulty: true
        }
      }
    },
    limits: {
      maxCombinationsPerRequest: MAX_COMBINATIONS_PER_REQUEST,
      maxQuestionsPerCombination: MAX_QUESTIONS_PER_COMBINATION
    }
  });
}
```
--- END FILE: app\api\curriculum-bulk\route.ts ---

--- START FILE: app\api\generate\enhanced\route.ts ---
```typescript
// Enhanced Question Generation API - New endpoint with advanced features
// Runs alongside existing /api/generate for backward compatibility

import { NextRequest, NextResponse } from 'next/server';
import {
  QuestionOrchestrator,
  EnhancedQuestionRequest,
  EnhancedQuestion
} from '@/lib/orchestrator/question-orchestrator';
import { ScenarioService } from '@/lib/services/scenario.service';
import { DistractorEngine } from '@/lib/services/distractor-engine.service';
import { generateMathQuestion, getModel } from '@/lib/math-engine';
import { QuestionFormat, ScenarioTheme } from '@/lib/types/question-formats';
import { IMathModel } from '@/lib/types';
import { MODEL_STATUS_REGISTRY, ModelStatus } from '@/lib/models/model-status';

/**
 * Enhanced API request validation
 */
interface ValidatedRequest extends EnhancedQuestionRequest {
  quantity?: number; // Batch generation support
  include_explanation?: boolean;
  include_working?: boolean;
  distractor_count?: number;
}

interface ValidationResult {
  valid: boolean;
  error?: string;
}

/**
 * Enhanced API response
 */
interface EnhancedQuestionResponse {
  success: boolean;
  question?: EnhancedQuestion;
  questions?: EnhancedQuestion[]; // For batch requests
  metadata: {
    format: QuestionFormat;
    cognitive_load: number;
    curriculum_alignment: string[];
    difficulty: string;
    scenario_theme: string;
    distractor_strategies: string[];
    generation_time_ms: number;
    api_version: string;
    enhancement_status: string;
    format_requested?: string;
    format_used: string;
    features_active: string[];
    features_pending: string[];
  };
  context?: any;
  session?: any;
  batch_info?: {
    total_questions: number;
    successful_questions: number;
    failed_questions: number;
    avg_generation_time: number;
    success_rate: number;
    errors?: { index: number; message: string }[];
  };
}

/**
 * Math engine adapter for orchestrator
 */
class MathEngineAdapter {
  async generate(model: string, params: any): Promise<any> {
    // Use existing math engine
    const modelInstance = getModel(model as any);

    // Ensure params have all required properties by merging with defaults
    const defaultParams = modelInstance.getDefaultParams(4);
    const mergedParams = params ? { ...defaultParams, ...params } : defaultParams;

    return modelInstance.generate(mergedParams);
  }

  getModel(modelId: string): IMathModel<any, any> {
    return getModel(modelId as any);
  }
}

// Initialize services
const mathEngine = new MathEngineAdapter();
const scenarioService = new ScenarioService();
const distractorEngine = new DistractorEngine();
const orchestrator = new QuestionOrchestrator(mathEngine, scenarioService, distractorEngine);

/**
 * POST endpoint for enhanced question generation
 */
export async function POST(req: NextRequest) {
  try {
    const body: ValidatedRequest = await req.json();

    // Validate request
    const validation = validateRequest(body);
    if (!validation.valid) {
      return NextResponse.json(
        { error: validation.error },
        { status: 400 }
      );
    }

    const startTime = Date.now();
    const quantity = body.quantity || 1;

    // Generate questions
    if (quantity === 1) {
      // Single question generation
      const question = await orchestrator.generateQuestion(body);
      const endTime = Date.now();

      const response: EnhancedQuestionResponse = {
        success: true,
        question,
        metadata: {
          format: question.format,
          cognitive_load: question.cognitiveLoad,
          curriculum_alignment: question.curriculumTags,
          difficulty: question.difficulty.displayName,
          scenario_theme: question.scenario.theme,
          distractor_strategies: question.distractors.map((d: any) => d.strategy),
          generation_time_ms: endTime - startTime,
          api_version: '2.0',
          enhancement_status: question.enhancementStatus.level,
          format_requested: question.enhancementStatus.requestedFormat,
          format_used: question.enhancementStatus.actualFormat,
          features_active: question.enhancementStatus.featuresActive,
          features_pending: question.enhancementStatus.featuresPending
        },
        context: question.scenario
      };

      return NextResponse.json(response);
    } else {
      // Batch question generation
      const questions: EnhancedQuestion[] = [];
      const errors: { index: number; message: string }[] = [];
      let successCount = 0;

      for (let i = 0; i < quantity; i++) {
        try {
          const question = await orchestrator.generateQuestion(body);
          questions.push(question);
          successCount++;
        } catch (error) {
          console.warn(`Failed to generate question ${i + 1} in batch:`, error);
          errors.push({
            index: i,
            message: error instanceof Error ? error.message : 'Unknown error during batch generation'
          });
        }
      }

      const endTime = Date.now();
      const totalTime = endTime - startTime;

      const response: EnhancedQuestionResponse = {
        success: successCount > 0,
        questions,
        metadata: {
          format: questions[0]?.format || QuestionFormat.DIRECT_CALCULATION,
          cognitive_load: questions[0]?.cognitiveLoad || 50,
          curriculum_alignment: questions[0]?.curriculumTags || [],
          difficulty: questions[0]?.difficulty.displayName || '4.3',
          scenario_theme: questions[0]?.scenario.theme || ScenarioTheme.SHOPPING,
          distractor_strategies: [],
          generation_time_ms: totalTime,
          enhancement_status: questions[0]?.enhancementStatus.level || 'fallback',
          format_used: questions[0]?.enhancementStatus.actualFormat || QuestionFormat.DIRECT_CALCULATION,
          features_active: questions[0]?.enhancementStatus.featuresActive || [],
          features_pending: questions[0]?.enhancementStatus.featuresPending || [],
          api_version: '2.0'
        },
        batch_info: {
          total_questions: quantity,
          successful_questions: successCount,
          failed_questions: errors.length,
          avg_generation_time: totalTime / quantity,
          success_rate: successCount / quantity,
          errors: errors
        }
      };

      return NextResponse.json(response);
    }

  } catch (error) {
    console.error('Enhanced question generation error:', error);

    return NextResponse.json(
      {
        error: 'Failed to generate enhanced question',
        details: error instanceof Error ? error.message : 'Unknown error',
        api_version: '2.0'
      },
      { status: 500 }
    );
  }
}

/**
 * GET endpoint for API documentation
 */
export async function GET() {
  return NextResponse.json({
    name: 'Enhanced Question Generation API',
    version: '2.0',
    description: 'Advanced question generation with multiple formats, rich scenarios, and pedagogical distractors',
    endpoints: {
      POST: {
        description: 'Generate enhanced questions with advanced features',
        request_body: {
          // Required
          model_id: {
            type: 'string',
            required: true,
            description: 'Mathematical model to use',
            examples: ['ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'UNIT_RATE', 'COMPARISON']
          },

          // Difficulty (one of these)
          difficulty_level: {
            type: 'string',
            description: 'Enhanced difficulty format (X.Y)',
            examples: ['3.2', '4.1', '5.4']
          },
          year_level: {
            type: 'number',
            description: 'Legacy year level (1-6)',
            examples: [3, 4, 5]
          },

          // Optional enhancements
          format_preference: {
            type: 'string',
            description: 'Preferred question format',
            examples: ['DIRECT_CALCULATION', 'COMPARISON', 'ESTIMATION', 'VALIDATION', 'MULTI_STEP']
          },
          scenario_theme: {
            type: 'string',
            description: 'Preferred scenario theme',
            examples: ['SHOPPING', 'SCHOOL', 'SPORTS', 'COOKING', 'POCKET_MONEY']
          },
          pedagogical_focus: {
            type: 'string',
            description: 'Learning objective focus',
            examples: ['fluency', 'reasoning', 'problem_solving', 'number_sense']
          },

          // Batch and customization
          quantity: {
            type: 'number',
            description: 'Number of questions to generate (1-20)',
            default: 1
          },
          difficulty_params: {
            type: 'object',
            description: 'Custom difficulty parameters for math models'
          },

          // Session and tracking
          session_id: {
            type: 'string',
            description: 'Session identifier for tracking'
          },
          cultural_context: {
            type: 'string',
            description: 'Cultural context (default: UK)',
            default: 'UK'
          },

          // Output options
          include_explanation: {
            type: 'boolean',
            description: 'Include solution explanation',
            default: false
          },
          include_working: {
            type: 'boolean',
            description: 'Include working steps',
            default: false
          },
          distractor_count: {
            type: 'number',
            description: 'Number of wrong answer options',
            default: 3
          }
        },

        response: {
          success: 'boolean',
          question: {
            text: 'string - Question text',
            options: 'array - Answer options with distractors',
            correctIndex: 'number - Index of correct answer',
            format: 'string - Question format used',
            difficulty: 'object - Difficulty information',
            scenario: 'object - Rich scenario context',
            mathOutput: 'object - Raw math engine output'
          },
          metadata: {
            format: 'string - Question format',
            cognitive_load: 'number - Estimated cognitive difficulty (0-100)',
            curriculum_alignment: 'array - UK curriculum tags',
            difficulty: 'string - Difficulty level (X.Y format)',
            scenario_theme: 'string - Scenario theme used',
            distractor_strategies: 'array - Distractor generation strategies',
            generation_time_ms: 'number - Generation time',
            api_version: 'string - API version'
          }
        }
      }
    },

    features: [
      'Multiple question formats (8 types)',
      'Rich scenario contexts (10+ themes)',
      'Pedagogically sound distractors',
      'Enhanced difficulty progression (X.Y system)',
      'Batch question generation',
      'Session tracking support',
      'UK National Curriculum alignment',
      'Cultural context awareness',
      'Backward compatibility maintained'
    ],

    compatibility: {
      legacy_endpoint: '/api/generate',
      migration_notes: [
        'All existing requests continue to work unchanged',
        'New features available through /api/generate/enhanced',
        'Response format enhanced but maintains core structure',
        'Math engine models unchanged'
      ]
    },

    examples: {
      basic_request: {
        model_id: 'ADDITION',
        difficulty_level: '3.2'
      },
      advanced_request: {
        model_id: 'UNIT_RATE',
        difficulty_level: '5.3',
        format_preference: 'COMPARISON',
        scenario_theme: 'SHOPPING',
        pedagogical_focus: 'reasoning',
        quantity: 5
      }
    }
  });
}

/**
 * Validate enhanced API request
 */
function validateRequest(body: ValidatedRequest): ValidationResult {
  // Required fields
  if (!body.model_id) {
    return { valid: false, error: 'model_id is required' };
  }

  // Validate model exists
  const supportedModels = [
    'ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'PERCENTAGE',
    'FRACTION', 'COUNTING', 'TIME_RATE', 'CONVERSION', 'COMPARISON',
    'MULTI_STEP', 'LINEAR_EQUATION', 'UNIT_RATE',
    'COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS',
    'MIXED_MONEY_UNITS', 'MONEY_FRACTIONS', 'MONEY_SCALING',
    'SHAPE_RECOGNITION', 'SHAPE_PROPERTIES', 'ANGLE_MEASUREMENT',
    'POSITION_DIRECTION', 'AREA_PERIMETER',
    'TEST_BROKEN' // Added for testing purposes
  ];

  if (!supportedModels.includes(body.model_id)) {
    return {
      valid: false,
      error: `Unsupported model_id: ${body.model_id}. Supported models: ${supportedModels.join(', ')}`
    };
  }

  // Check if the model is marked as broken
  const modelStatus = MODEL_STATUS_REGISTRY[body.model_id]?.status;
  if (modelStatus === ModelStatus.BROKEN) {
    return {
      valid: false,
      error: `Model ${body.model_id} is currently disabled for maintenance.`
    };
  }

  // Validate difficulty format
  if (body.difficulty_level) {
    const parts = body.difficulty_level.split('.');
    if (parts.length !== 2) {
      return {
        valid: false,
        error: 'difficulty_level must be in X.Y format (e.g., "3.2")'
      };
    }

    const year = parseInt(parts[0]);
    const subLevel = parseInt(parts[1]);

    if (year < 1 || year > 6 || subLevel < 1 || subLevel > 4) {
      return {
        valid: false,
        error: 'difficulty_level must be X.Y where X=1-6 and Y=1-4'
      };
    }
  } else if (body.year_level) {
    if (body.year_level < 1 || body.year_level > 6) {
      return {
        valid: false,
        error: 'year_level must be between 1 and 6'
      };
    }
  }

  // Validate quantity
  if (body.quantity && (body.quantity < 1 || body.quantity > 20)) {
    return {
      valid: false,
      error: 'quantity must be between 1 and 20'
    };
  }

  // Validate format preference
  if (body.format_preference) {
    const validFormats = Object.values(QuestionFormat);
    if (!validFormats.includes(body.format_preference)) {
      return {
        valid: false,
        error: `Invalid format_preference. Valid options: ${validFormats.join(', ')}`
      };
    }
  }

  // Validate scenario theme
  if (body.scenario_theme) {
    const validThemes = Object.values(ScenarioTheme);
    if (!validThemes.includes(body.scenario_theme)) {
      return {
        valid: false,
        error: `Invalid scenario_theme. Valid options: ${validThemes.join(', ')}`
      };
    }
  }

  return { valid: true };
}
```
--- END FILE: app\api\generate\enhanced\route.ts ---

--- START FILE: app\api\generate\route.ts ---
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { generateMathQuestion, getModel } from '@/lib/math-engine';
import { StoryEngine } from '@/lib/story-engine/story.engine';
import { MoneyContextGenerator } from '@/lib/story-engine/contexts/money.context';
import { GenerateRequest, GeneratedQuestion } from '@/lib/types';
import { EnhancedDifficultySystem } from '@/lib/math-engine/difficulty-enhanced';
import { ProgressionTracker } from '@/lib/math-engine/progression-tracker';
import { SubDifficultyLevel, DifficultyProgression } from '@/lib/types-enhanced';

// Import enhanced system for redirect
import {
  QuestionOrchestrator,
  EnhancedQuestionRequest
} from '@/lib/orchestrator/question-orchestrator';
import { ScenarioService } from '@/lib/services/scenario.service';
import { DistractorEngine } from '@/lib/services/distractor-engine.service';

interface EnhancedGenerateRequest extends GenerateRequest {
  sub_level?: string; // e.g., "3.2"
  session_id?: string; // For progression tracking
  adaptive_mode?: boolean; // Enable adaptive difficulty
  confidence_mode?: boolean; // Enable confidence mode
  quantity?: number; // Number of questions to generate in batch
}

// Initialize enhanced system components for legacy compatibility
class MathEngineAdapter {
  async generate(model: string, params: any): Promise<any> {
    const modelInstance = getModel(model as any);
    // Always use default params for the model to ensure proper structure
    const defaultParams = modelInstance.getDefaultParams(4);
    // Merge any provided params with defaults
    const finalParams = { ...defaultParams, ...(params || {}) };
    return modelInstance.generate(finalParams);
  }

  getModel(modelId: string) {
    return getModel(modelId as any);
  }
}

const mathEngine = new MathEngineAdapter();
const scenarioService = new ScenarioService();
const distractorEngine = new DistractorEngine();
const orchestrator = new QuestionOrchestrator(mathEngine, scenarioService, distractorEngine);

export async function POST(req: NextRequest) {
  try {
    const body: EnhancedGenerateRequest = await req.json();
    const {
      model_id,
      difficulty_params,
      context_type = 'money',
      year_level = 4,
      sub_level,
      session_id,
      adaptive_mode = false,
      confidence_mode = false,
      quantity = 1
    } = body;

    // Validate model exists
    const modelIds = ['ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'PERCENTAGE',
                     'FRACTION', 'COUNTING', 'TIME_RATE', 'CONVERSION', 'COMPARISON',
                     'MULTI_STEP', 'LINEAR_EQUATION', 'UNIT_RATE',
                     'COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS',
                     'MIXED_MONEY_UNITS', 'MONEY_FRACTIONS', 'MONEY_SCALING',
                     'SHAPE_RECOGNITION', 'SHAPE_PROPERTIES', 'ANGLE_MEASUREMENT', 'POSITION_DIRECTION', 'AREA_PERIMETER'];
    if (!modelIds.includes(model_id)) {
      return NextResponse.json(
        { error: `Invalid model_id: ${model_id}` },
        { status: 400 }
      );
    }

    // Validate quantity
    if (quantity < 1 || quantity > 20) {
      return NextResponse.json(
        { error: 'Quantity must be between 1 and 20' },
        { status: 400 }
      );
    }

    // Transform legacy request to enhanced format
    const enhancedRequest: EnhancedQuestionRequest = {
      model_id,
      difficulty_level: sub_level || `${year_level}.3`, // Convert to X.Y format
      format_preference: 'DIRECT_CALCULATION' as any, // Force direct calculation for legacy compatibility
      difficulty_params,
      session_id,
      cultural_context: 'UK'
    };

    const startTime = Date.now();

    // Use enhanced system for generation
    if (quantity === 1) {
      // Single question generation
      const enhancedQuestion = await orchestrator.generateQuestion(enhancedRequest);

      // Transform to legacy format for backward compatibility
      const legacyQuestion: GeneratedQuestion = {
        question: enhancedQuestion.text,
        answer: enhancedQuestion.options[enhancedQuestion.correctIndex].text,
        math_output: enhancedQuestion.mathOutput,
        context: enhancedQuestion.scenario,
        metadata: {
          model_id,
          year_level: enhancedQuestion.difficulty.year,
          sub_level: enhancedQuestion.difficulty.displayName,
          difficulty_params,
          enhanced_system_used: true,
          session_id,
          timestamp: new Date()
        },
        generation_setup: enhancedQuestion.generationSetup
      };

      return NextResponse.json(legacyQuestion);
    } else {
      // Batch question generation
      const enhancedQuestions = [];
      let successCount = 0;

      for (let i = 0; i < quantity; i++) {
        try {
          const enhancedQuestion = await orchestrator.generateQuestion(enhancedRequest);
          enhancedQuestions.push(enhancedQuestion);
          successCount++;
        } catch (error) {
          console.warn(`Failed to generate question ${i + 1}:`, error);
          // Continue with other questions
        }
      }

      const endTime = Date.now();
      const totalTime = endTime - startTime;

      // Transform to legacy format for backward compatibility
      const legacyQuestions: GeneratedQuestion[] = enhancedQuestions.map((eq, index) => ({
        question: eq.text,
        answer: eq.options[eq.correctIndex].text,
        math_output: eq.mathOutput,
        context: eq.scenario,
        metadata: {
          model_id,
          year_level: eq.difficulty.year,
          sub_level: eq.difficulty.displayName,
          difficulty_params,
          enhanced_system_used: true,
          session_id,
          timestamp: new Date()
        },
        generation_setup: eq.generationSetup
      }));

      const response = {
        questions: legacyQuestions,
        batch_metadata: {
          quantity: successCount,
          total_generation_time_ms: totalTime,
          average_generation_time_ms: totalTime / Math.max(successCount, 1),
          model_id,
          enhanced_system_used: true,
          enhancement_status: enhancedQuestions[0]?.enhancementStatus.level || 'fallback',
          session_id,
          timestamp: new Date()
        }
      };
      return NextResponse.json(response);
    }
  } catch (error) {
    console.error('Error generating question:', error);
    return NextResponse.json(
      { error: 'Failed to generate question', details: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    );
  }
}

export async function GET() {
  return NextResponse.json({
    message: 'Question Generation API',
    endpoints: {
      POST: {
        description: 'Generate a question or batch of questions',
        body: {
          model_id: 'string (required) - ADDITION, SUBTRACTION, MULTIPLICATION, DIVISION, PERCENTAGE',
          year_level: 'number (optional) - 1 to 6',
          sub_level: 'string (optional) - X.Y format (e.g., "3.2") for enhanced difficulty',
          quantity: 'number (optional) - 1 to 20, number of questions to generate',
          session_id: 'string (optional) - For progression tracking',
          adaptive_mode: 'boolean (optional) - Enable adaptive difficulty adjustments',
          confidence_mode: 'boolean (optional) - Enable confidence-based progression',
          difficulty_params: 'object (optional) - Custom difficulty parameters',
          context_type: 'string (optional) - money, measurement, etc.'
        }
      }
    }
  });
}
```
--- END FILE: app\api\generate\route.ts ---

--- START FILE: app\curriculum-curator\page.tsx ---
```typescript
'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  CheckCircle,
  XCircle,
  AlertTriangle,
  Star,
  Grid,
  List,
  Save,
  Download,
  Upload,
  Eye,
  Settings,
  Target,
  Ban,
  Crown
} from 'lucide-react';

import {
  curatedMappingsManager,
  CuratedMapping,
  MappingMatrix,
  MappingStatus
} from '@/lib/curriculum/curated-mappings';
import { testTracker, TestSummary } from '@/lib/curriculum/test-tracking';
import { MODEL_STATUS_REGISTRY } from '@/lib/models/model-status';
import { CURRICULUM_DATA } from '@/context/curriculum';

interface CurationState {
  selectedStrand: string;
  selectedSubstrand: string;
  selectedYear: number;
  currentMapping: CuratedMapping | null;
  viewMode: 'matrix' | 'list' | 'details';
  showTestData: boolean;
}

const CurriculumCuratorPage = () => {
  const [state, setState] = useState<CurationState>({
    selectedStrand: '',
    selectedSubstrand: '',
    selectedYear: 1,
    currentMapping: null,
    viewMode: 'matrix',
    showTestData: false
  });

  const [matrix, setMatrix] = useState<MappingMatrix | null>(null);
  const [mappings, setMappings] = useState<CuratedMapping[]>([]);
  const [statistics, setStatistics] = useState<any>(null);
  const [unsavedChanges, setUnsavedChanges] = useState(false);

  // Get curriculum data
  const strands = Object.keys(CURRICULUM_DATA);
  const substrands = state.selectedStrand
    ? Object.keys(CURRICULUM_DATA[state.selectedStrand] || {})
    : [];
  const years = [1, 2, 3, 4, 5, 6];
  const models = Object.keys(MODEL_STATUS_REGISTRY);

  useEffect(() => {
    loadData();
  }, []);

  useEffect(() => {
    if (state.selectedStrand && state.selectedSubstrand && state.selectedYear) {
      const mapping = curatedMappingsManager.getMapping(
        state.selectedStrand,
        state.selectedSubstrand,
        state.selectedYear
      );
      setState(prev => ({ ...prev, currentMapping: mapping || null }));
    }
  }, [state.selectedStrand, state.selectedSubstrand, state.selectedYear]);

  const loadData = () => {
    // Build matrix
    const matrixData = curatedMappingsManager.buildMappingMatrix(
      strands,
      substrands.length > 0 ? substrands : Object.keys(CURRICULUM_DATA[strands[0]] || {}),
      years,
      models
    );
    setMatrix(matrixData);

    // Load mappings
    const allMappings = curatedMappingsManager.getAllMappings();
    setMappings(allMappings);

    // Load statistics
    const stats = curatedMappingsManager.getStatistics();
    setStatistics(stats);

    setUnsavedChanges(false);
  };

  const updateModelRole = (
    strand: string,
    substrand: string,
    year: number,
    modelId: string,
    role: 'primary' | 'secondary' | 'excluded' | 'none'
  ) => {
    curatedMappingsManager.batchUpdateModels([{
      strand,
      substrand,
      year,
      modelId,
      role
    }]);

    loadData();
    setUnsavedChanges(true);
  };

  const saveCurrentMapping = (updates: Partial<CuratedMapping>) => {
    if (state.selectedStrand && state.selectedSubstrand) {
      curatedMappingsManager.upsertMapping(
        state.selectedStrand,
        state.selectedSubstrand,
        state.selectedYear,
        updates
      );
      loadData();
      setUnsavedChanges(true);
    }
  };

  const getModelRoleInMapping = (
    strand: string,
    substrand: string,
    year: number,
    modelId: string
  ): 'primary' | 'secondary' | 'excluded' | 'none' => {
    const mapping = curatedMappingsManager.getMapping(strand, substrand, year);
    if (!mapping) return 'none';

    if (mapping.primaryModel === modelId) return 'primary';
    if (mapping.secondaryModels.includes(modelId)) return 'secondary';
    if (mapping.excludedModels.includes(modelId)) return 'excluded';
    return 'none';
  };

  const getTestSummary = (strand: string, substrand: string, year: number, modelId: string): TestSummary | null => {
    return testTracker.getSummary(strand, substrand, year, modelId);
  };

  const renderMatrixView = () => {
    if (!matrix) return null;

    return (
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold">Curation Matrix</h3>
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 text-sm">
              <div className="w-3 h-3 bg-blue-500 rounded"></div>
              <span>Primary</span>
              <div className="w-3 h-3 bg-green-500 rounded"></div>
              <span>Secondary</span>
              <div className="w-3 h-3 bg-red-500 rounded"></div>
              <span>Excluded</span>
              <div className="w-3 h-3 bg-gray-300 rounded"></div>
              <span>Unset</span>
            </div>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setState(prev => ({ ...prev, showTestData: !prev.showTestData }))}
            >
              {state.showTestData ? 'Hide' : 'Show'} Test Data
            </Button>
          </div>
        </div>

        <div className="grid gap-6">
          {strands.map(strand => {
            const strandSubstrands = Object.keys(CURRICULUM_DATA[strand] || {});
            return (
              <Card key={strand}>
                <CardHeader>
                  <CardTitle className="text-lg">{strand}</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {strandSubstrands.map(substrand => (
                      <div key={substrand}>
                        <h4 className="font-medium mb-2 text-sm">{substrand}</h4>
                        <div className="grid grid-cols-6 gap-2">
                          {years.map(year => (
                            <div key={year} className="space-y-1">
                              <div className="text-xs text-center font-medium">Year {year}</div>
                              <div className="grid grid-cols-4 gap-1">
                                {models.slice(0, 8).map(modelId => {
                                  const role = getModelRoleInMapping(strand, substrand, year, modelId);
                                  const testSummary = state.showTestData ? getTestSummary(strand, substrand, year, modelId) : null;

                                  let bgColor = 'bg-gray-300';
                                  if (role === 'primary') bgColor = 'bg-blue-500';
                                  else if (role === 'secondary') bgColor = 'bg-green-500';
                                  else if (role === 'excluded') bgColor = 'bg-red-500';

                                  return (
                                    <button
                                      key={modelId}
                                      className={`w-6 h-6 rounded text-xs text-white hover:opacity-80 relative group ${bgColor}`}
                                      onClick={() => {
                                        const nextRole = role === 'none' ? 'primary' :
                                                       role === 'primary' ? 'secondary' :
                                                       role === 'secondary' ? 'excluded' :
                                                       'none';
                                        updateModelRole(strand, substrand, year, modelId, nextRole);
                                      }}
                                      title={`${MODEL_STATUS_REGISTRY[modelId]?.name || modelId} - ${role}`}
                                    >
                                      {role === 'primary' && <Crown className="w-3 h-3" />}
                                      {role === 'secondary' && <CheckCircle className="w-3 h-3" />}
                                      {role === 'excluded' && <Ban className="w-3 h-3" />}

                                      {state.showTestData && testSummary && testSummary.totalTests > 0 && (
                                        <div className="absolute -top-1 -right-1 bg-white text-black rounded-full w-3 h-3 text-xs flex items-center justify-center">
                                          {testSummary.totalTests}
                                        </div>
                                      )}
                                    </button>
                                  );
                                })}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      </div>
    );
  };

  const renderListView = () => {
    return (
      <div className="space-y-4">
        {mappings.length === 0 ? (
          <Card>
            <CardContent className="text-center py-12">
              <List className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p className="text-gray-500">No curated mappings yet. Start by configuring some combinations in the matrix view.</p>
            </CardContent>
          </Card>
        ) : (
          mappings.map(mapping => (
            <Card key={mapping.id}>
              <CardContent className="pt-6">
                <div className="flex items-start justify-between">
                  <div className="space-y-2">
                    <div className="font-medium">
                      {mapping.strand} â {mapping.substrand} (Year {mapping.year})
                    </div>
                    <div className="flex items-center gap-2">
                      <Badge variant="outline" className="bg-blue-50">
                        Primary: {MODEL_STATUS_REGISTRY[mapping.primaryModel]?.name || mapping.primaryModel}
                      </Badge>
                      {mapping.secondaryModels.length > 0 && (
                        <Badge variant="outline" className="bg-green-50">
                          +{mapping.secondaryModels.length} secondary
                        </Badge>
                      )}
                      {mapping.excludedModels.length > 0 && (
                        <Badge variant="outline" className="bg-red-50">
                          {mapping.excludedModels.length} excluded
                        </Badge>
                      )}
                    </div>
                    <div className="flex items-center gap-4 text-sm text-gray-600">
                      <span>Confidence: {mapping.confidence}</span>
                      <span>Status: {mapping.status}</span>
                      {mapping.averageRating && (
                        <span className="flex items-center gap-1">
                          Rating: {mapping.averageRating.toFixed(1)}
                          <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                        </span>
                      )}
                    </div>
                  </div>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      setState(prev => ({
                        ...prev,
                        selectedStrand: mapping.strand,
                        selectedSubstrand: mapping.substrand,
                        selectedYear: mapping.year,
                        viewMode: 'details'
                      }));
                    }}
                  >
                    <Eye className="w-4 h-4" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          ))
        )}
      </div>
    );
  };

  const renderDetailsView = () => {
    if (!state.currentMapping && (!state.selectedStrand || !state.selectedSubstrand)) {
      return (
        <Card>
          <CardContent className="text-center py-12">
            <Settings className="w-12 h-12 mx-auto mb-3 opacity-50" />
            <p className="text-gray-500">Select a curriculum combination to view or edit details.</p>
          </CardContent>
        </Card>
      );
    }

    const mapping = state.currentMapping;
    const isNewMapping = !mapping;

    return (
      <div className="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>
              {isNewMapping ? 'Create New' : 'Edit'} Mapping: {state.selectedStrand} â {state.selectedSubstrand} (Year {state.selectedYear})
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Primary Model Selection */}
            <div>
              <label className="text-sm font-medium mb-2 block">Primary Model</label>
              <Select
                value={mapping?.primaryModel || ''}
                onValueChange={(value) => saveCurrentMapping({ primaryModel: value })}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select primary model" />
                </SelectTrigger>
                <SelectContent>
                  {models.map(modelId => (
                    <SelectItem key={modelId} value={modelId}>
                      {MODEL_STATUS_REGISTRY[modelId]?.name || modelId}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Secondary Models */}
            <div>
              <label className="text-sm font-medium mb-2 block">Secondary Models</label>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                {models.map(modelId => {
                  const isSecondary = mapping?.secondaryModels.includes(modelId) || false;
                  const isPrimary = mapping?.primaryModel === modelId;
                  const isExcluded = mapping?.excludedModels.includes(modelId) || false;

                  return (
                    <Button
                      key={modelId}
                      variant={isSecondary ? "default" : "outline"}
                      size="sm"
                      disabled={isPrimary || isExcluded}
                      onClick={() => {
                        const currentSecondary = mapping?.secondaryModels || [];
                        const newSecondary = isSecondary
                          ? currentSecondary.filter(m => m !== modelId)
                          : [...currentSecondary, modelId];
                        saveCurrentMapping({ secondaryModels: newSecondary });
                      }}
                      className="justify-start text-xs"
                    >
                      {isSecondary && <CheckCircle className="w-3 h-3 mr-1" />}
                      {MODEL_STATUS_REGISTRY[modelId]?.name || modelId}
                    </Button>
                  );
                })}
              </div>
            </div>

            {/* Excluded Models */}
            <div>
              <label className="text-sm font-medium mb-2 block">Excluded Models</label>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                {models.map(modelId => {
                  const isExcluded = mapping?.excludedModels.includes(modelId) || false;
                  const isPrimary = mapping?.primaryModel === modelId;
                  const isSecondary = mapping?.secondaryModels.includes(modelId) || false;

                  return (
                    <Button
                      key={modelId}
                      variant={isExcluded ? "destructive" : "outline"}
                      size="sm"
                      disabled={isPrimary || isSecondary}
                      onClick={() => {
                        const currentExcluded = mapping?.excludedModels || [];
                        const newExcluded = isExcluded
                          ? currentExcluded.filter(m => m !== modelId)
                          : [...currentExcluded, modelId];
                        saveCurrentMapping({ excludedModels: newExcluded });
                      }}
                      className="justify-start text-xs"
                    >
                      {isExcluded && <XCircle className="w-3 h-3 mr-1" />}
                      {MODEL_STATUS_REGISTRY[modelId]?.name || modelId}
                    </Button>
                  );
                })}
              </div>
            </div>

            {/* Confidence Level */}
            <div>
              <label className="text-sm font-medium mb-2 block">Confidence Level</label>
              <Select
                value={mapping?.confidence || 'low'}
                onValueChange={(value) => saveCurrentMapping({ confidence: value as 'low' | 'medium' | 'high' })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="low">Low</SelectItem>
                  <SelectItem value="medium">Medium</SelectItem>
                  <SelectItem value="high">High</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Status */}
            <div>
              <label className="text-sm font-medium mb-2 block">Status</label>
              <Select
                value={mapping?.status || 'draft'}
                onValueChange={(value) => saveCurrentMapping({ status: value as 'draft' | 'approved' | 'needs_review' })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="draft">Draft</SelectItem>
                  <SelectItem value="approved">Approved</SelectItem>
                  <SelectItem value="needs_review">Needs Review</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Notes */}
            <div>
              <label className="text-sm font-medium mb-2 block">Notes</label>
              <Textarea
                value={mapping?.notes || ''}
                onChange={(e) => saveCurrentMapping({ notes: e.target.value })}
                placeholder="Add notes about this mapping..."
                rows={3}
              />
            </div>

            {/* Test Data Summary */}
            {state.selectedStrand && state.selectedSubstrand && (
              <div>
                <label className="text-sm font-medium mb-2 block">Test Data Summary</label>
                <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                  {models.map(modelId => {
                    const summary = getTestSummary(state.selectedStrand, state.selectedSubstrand, state.selectedYear, modelId);
                    if (!summary || summary.totalTests === 0) return null;

                    return (
                      <div key={modelId} className="flex justify-between text-sm">
                        <span>{MODEL_STATUS_REGISTRY[modelId]?.name || modelId}</span>
                        <span>
                          {summary.totalTests} tests, avg rating: {summary.averageRating?.toFixed(1) || 'N/A'}
                        </span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    );
  };

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold">Curriculum Curator</h1>
          <p className="text-gray-600">Manage curated model-curriculum mappings</p>
        </div>
        <div className="flex gap-2">
          {unsavedChanges && (
            <Badge variant="outline" className="bg-yellow-50">
              <AlertTriangle className="w-3 h-3 mr-1" />
              Unsaved Changes
            </Badge>
          )}
          <Button variant="outline" onClick={() => {
            const data = curatedMappingsManager.exportMappings();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `curated-mappings-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
          }}>
            <Download className="w-4 h-4 mr-2" />
            Export
          </Button>
        </div>
      </div>

      {statistics && (
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <Card>
            <CardContent className="pt-6 text-center">
              <div className="text-2xl font-bold">{statistics.totalMappings}</div>
              <p className="text-xs text-gray-600">Total Mappings</p>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="pt-6 text-center">
              <div className="text-2xl font-bold text-green-600">{statistics.approvedMappings}</div>
              <p className="text-xs text-gray-600">Approved</p>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="pt-6 text-center">
              <div className="text-2xl font-bold text-yellow-600">{statistics.draftMappings}</div>
              <p className="text-xs text-gray-600">Draft</p>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="pt-6 text-center">
              <div className="text-2xl font-bold text-orange-600">{statistics.needsReviewMappings}</div>
              <p className="text-xs text-gray-600">Needs Review</p>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="pt-6 text-center">
              <div className="text-2xl font-bold text-blue-600">{statistics.highConfidenceMappings}</div>
              <p className="text-xs text-gray-600">High Confidence</p>
            </CardContent>
          </Card>
        </div>
      )}

      <Tabs value={state.viewMode} onValueChange={(value: any) => setState(prev => ({ ...prev, viewMode: value }))}>
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="matrix" className="flex items-center gap-2">
            <Grid className="w-4 h-4" />
            Matrix
          </TabsTrigger>
          <TabsTrigger value="list" className="flex items-center gap-2">
            <List className="w-4 h-4" />
            List
          </TabsTrigger>
          <TabsTrigger value="details" className="flex items-center gap-2">
            <Settings className="w-4 h-4" />
            Details
          </TabsTrigger>
        </TabsList>

        <TabsContent value="matrix">
          {renderMatrixView()}
        </TabsContent>

        <TabsContent value="list">
          {renderListView()}
        </TabsContent>

        <TabsContent value="details">
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <Card className="lg:col-span-1">
              <CardHeader>
                <CardTitle>Selection</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <label className="text-sm font-medium mb-2 block">Strand</label>
                  <Select value={state.selectedStrand} onValueChange={(value) =>
                    setState(prev => ({ ...prev, selectedStrand: value, selectedSubstrand: '' }))
                  }>
                    <SelectTrigger>
                      <SelectValue placeholder="Select strand" />
                    </SelectTrigger>
                    <SelectContent>
                      {strands.map(strand => (
                        <SelectItem key={strand} value={strand}>{strand}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-medium mb-2 block">Substrand</label>
                  <Select
                    value={state.selectedSubstrand}
                    onValueChange={(value) => setState(prev => ({ ...prev, selectedSubstrand: value }))}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Select substrand" />
                    </SelectTrigger>
                    <SelectContent>
                      {substrands.map(substrand => (
                        <SelectItem key={substrand} value={substrand}>{substrand}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-medium mb-2 block">Year</label>
                  <Select value={state.selectedYear.toString()} onValueChange={(value) =>
                    setState(prev => ({ ...prev, selectedYear: parseInt(value) }))
                  }>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {years.map(year => (
                        <SelectItem key={year} value={year.toString()}>Year {year}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </CardContent>
            </Card>

            <div className="lg:col-span-3">
              {renderDetailsView()}
            </div>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  );
};

export default CurriculumCuratorPage;
```
--- END FILE: app\curriculum-curator\page.tsx ---

--- START FILE: app\curriculum-manager\page.tsx ---
```typescript
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { GeneratedQuestion } from '@/lib/types';
import { curriculumParser, CurriculumFilter } from '@/lib/curriculum/curriculum-parser';
import { curriculumModelMapper } from '@/lib/curriculum/curriculum-model-mapping';
import { MODEL_STATUS_REGISTRY, ModelStatus } from '@/lib/models/model-status';
import { CurriculumCoverage } from '@/components/curriculum-coverage';

interface BulkGenerationConfig {
  selectedStrands: string[];
  selectedSubstrands: string[];
  selectedYears: number[];
  selectedSubLevels: number[];
  questionsPerCombination: number;
  useEnhancedDifficulty: boolean;
}

interface GenerationCombination {
  strand: string;
  substrand: string;
  year: number;
  subLevel: number;
  suggestedModels: string[];
  primaryModel: string;
  questionsGenerated: number;
  status: 'pending' | 'generating' | 'completed' | 'error';
  questions?: GeneratedQuestion[];
  error?: string;
}

interface BulkGenerationResult {
  combinations: GenerationCombination[];
  totalQuestions: number;
  completedCombinations: number;
  totalCombinations: number;
  startTime: Date;
  endTime?: Date;
  errors: string[];
}

const YEARS = [1, 2, 3, 4, 5, 6];
const SUB_LEVELS = [1, 2, 3, 4];
const ENHANCED_MODELS = ['ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'PERCENTAGE', 'FRACTION'];

export default function CurriculumManagerPage() {
  // Curriculum data
  const [strands, setStrands] = useState<string[]>([]);
  const [substrandsByStrand, setSubstrandsByStrand] = useState<{ [strand: string]: string[] }>({});
  const [allSubstrands, setAllSubstrands] = useState<string[]>([]);

  // Generation configuration
  const [config, setConfig] = useState<BulkGenerationConfig>({
    selectedStrands: [],
    selectedSubstrands: [],
    selectedYears: YEARS,
    selectedSubLevels: [3], // Default to standard level
    questionsPerCombination: 1,
    useEnhancedDifficulty: true
  });

  // Generation state
  const [isGenerating, setIsGenerating] = useState(false);
  const [generationResult, setGenerationResult] = useState<BulkGenerationResult | null>(null);
  const [currentProgress, setCurrentProgress] = useState(0);
  const [totalEstimated, setTotalEstimated] = useState(0);
  const [estimatedCombinations, setEstimatedCombinations] = useState<GenerationCombination[]>([]);
  const [generationPhase, setGenerationPhase] = useState<'idle' | 'preparing' | 'generating' | 'processing' | 'completed'>('idle');

  // UI state
  const [showResults, setShowResults] = useState(false);
  const [selectedView, setSelectedView] = useState<'config' | 'progress' | 'results'>('config');

  // Initialize curriculum data
  useEffect(() => {
    const allStrands = curriculumParser.getStrands();
    setStrands(allStrands);

    const substrandMap: { [strand: string]: string[] } = {};
    const allSubs: string[] = [];

    allStrands.forEach(strand => {
      const substrands = curriculumParser.getSubstrands(strand);
      substrandMap[strand] = substrands;
      allSubs.push(...substrands);
    });

    setSubstrandsByStrand(substrandMap);
    setAllSubstrands([...new Set(allSubs)]);

    // Default to first strand
    if (allStrands.length > 0 && config.selectedStrands.length === 0) {
      setConfig(prev => ({
        ...prev,
        selectedStrands: [allStrands[0]],
        selectedSubstrands: substrandMap[allStrands[0]] || []
      }));
    }
  }, []);

  // Update substrands when strands change
  useEffect(() => {
    if (config.selectedStrands.length > 0) {
      const relevantSubstrands = config.selectedStrands.flatMap(strand =>
        substrandsByStrand[strand] || []
      );
      const uniqueSubstrands = [...new Set(relevantSubstrands)];

      if (JSON.stringify(config.selectedSubstrands) !== JSON.stringify(uniqueSubstrands)) {
        setConfig(prev => ({
          ...prev,
          selectedSubstrands: uniqueSubstrands
        }));
      }
    }
  }, [config.selectedStrands, substrandsByStrand]);

  // Calculate estimated combinations
  useEffect(() => {
    const combinations: GenerationCombination[] = [];

    config.selectedStrands.forEach(strand => {
      const strandSubstrands = substrandsByStrand[strand] || [];
      const relevantSubstrands = config.selectedSubstrands.filter(sub =>
        strandSubstrands.includes(sub)
      );

      relevantSubstrands.forEach(substrand => {
        const availableYears = curriculumParser.getAvailableYears(strand, substrand);
        const validYears = config.selectedYears.filter(year => availableYears.includes(year));

        validYears.forEach(year => {
          config.selectedSubLevels.forEach(subLevel => {
            const curriculumFilter = curriculumParser.getCurriculumDescription(strand, substrand, year);

            if (curriculumFilter) {
              const suggestedModels = curriculumModelMapper.getSuggestedModels(curriculumFilter);
              const primaryModel = curriculumModelMapper.getPrimaryModel(curriculumFilter);

              if (suggestedModels.length > 0 && primaryModel) {
                combinations.push({
                  strand,
                  substrand,
                  year,
                  subLevel,
                  suggestedModels,
                  primaryModel,
                  questionsGenerated: 0,
                  status: 'pending'
                });
              }
            }
          });
        });
      });
    });

    setEstimatedCombinations(combinations);
    setTotalEstimated(combinations.length * config.questionsPerCombination);
  }, [config, substrandsByStrand]);

  const handleStrandSelection = (strand: string, selected: boolean) => {
    setConfig(prev => ({
      ...prev,
      selectedStrands: selected
        ? [...prev.selectedStrands, strand]
        : prev.selectedStrands.filter(s => s !== strand)
    }));
  };

  const selectAllStrands = () => {
    setConfig(prev => ({
      ...prev,
      selectedStrands: [...strands]
    }));
  };

  const clearAllStrands = () => {
    setConfig(prev => ({
      ...prev,
      selectedStrands: []
    }));
  };

  const handleYearSelection = (year: number, selected: boolean) => {
    setConfig(prev => ({
      ...prev,
      selectedYears: selected
        ? [...prev.selectedYears, year]
        : prev.selectedYears.filter(y => y !== year)
    }));
  };

  const handleSubLevelSelection = (subLevel: number, selected: boolean) => {
    setConfig(prev => ({
      ...prev,
      selectedSubLevels: selected
        ? [...prev.selectedSubLevels, subLevel]
        : prev.selectedSubLevels.filter(sl => sl !== subLevel)
    }));
  };

  const startBulkGeneration = async () => {
    if (estimatedCombinations.length === 0) {
      alert('No valid combinations found. Please check your selection.');
      return;
    }

    // Check for large batch sizes and warn user
    const totalEstimatedQuestions = estimatedCombinations.length * config.questionsPerCombination;
    if (totalEstimatedQuestions > 1000) {
      const confirmed = confirm(
        `You are about to generate ${totalEstimatedQuestions} questions across ${estimatedCombinations.length} combinations. This may take several minutes. Continue?`
      );
      if (!confirmed) return;
    }

    setIsGenerating(true);
    setCurrentProgress(0);
    setSelectedView('progress');
    setShowResults(false);
    setGenerationPhase('preparing');

    // Initialize result structure
    const result: BulkGenerationResult = {
      combinations: [...estimatedCombinations.map(combo => ({ ...combo, status: 'pending' as const }))],
      totalQuestions: 0,
      completedCombinations: 0,
      totalCombinations: estimatedCombinations.length,
      startTime: new Date(),
      errors: []
    };

    setGenerationResult(result);

    try {
      // Show preparation phase
      await new Promise(resolve => setTimeout(resolve, 500));
      setGenerationPhase('generating');

      // Prepare request for bulk API
      const requestBody = {
        strands: config.selectedStrands,
        substrands: config.selectedSubstrands,
        years: config.selectedYears,
        subLevels: config.selectedSubLevels,
        questionsPerCombination: config.questionsPerCombination,
        useEnhancedDifficulty: config.useEnhancedDifficulty,
        contextType: 'money',
        sessionId: `curriculum_bulk_${Date.now()}`
      };

      console.log('Starting bulk generation with request:', requestBody);

      // Simulate progress for better UX (since bulk API doesn't provide real-time progress)
      const progressInterval = setInterval(() => {
        setCurrentProgress(prev => {
          const newProgress = Math.min(prev + 1, estimatedCombinations.length - 1);
          return newProgress;
        });
      }, Math.max(100, Math.min(1000, estimatedCombinations.length * 50))); // Adaptive timing

      const response = await fetch('/api/curriculum-bulk', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody),
      });

      // Clear progress interval and show processing phase
      clearInterval(progressInterval);
      setGenerationPhase('processing');
      setCurrentProgress(estimatedCombinations.length);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
      }

      const bulkResult = await response.json();
      console.log('Bulk generation completed:', bulkResult);

      // Transform bulk API response to our internal format
      const transformedCombinations: GenerationCombination[] = bulkResult.results.map((apiResult: any) => ({
        strand: apiResult.strand,
        substrand: apiResult.substrand,
        year: apiResult.year,
        subLevel: apiResult.subLevel,
        suggestedModels: apiResult.suggestedModels,
        primaryModel: apiResult.primaryModel,
        questionsGenerated: apiResult.questionsGenerated,
        status: apiResult.status,
        questions: apiResult.questions,
        error: apiResult.error
      }));

      // Update result with bulk API response
      const finalResult: BulkGenerationResult = {
        combinations: transformedCombinations,
        totalQuestions: bulkResult.totalQuestions,
        completedCombinations: bulkResult.completedCombinations,
        totalCombinations: bulkResult.totalCombinations,
        startTime: new Date(bulkResult.metadata.timestamp),
        endTime: new Date(),
        errors: bulkResult.errors
      };

      setGenerationResult(finalResult);
      setCurrentProgress(bulkResult.completedCombinations);
      setGenerationPhase('completed');
      setShowResults(true);
      setSelectedView('results');

      // Show summary notification
      if (bulkResult.errors.length > 0) {
        alert(`Generation completed with ${bulkResult.errors.length} errors. Check the results tab for details.`);
      } else {
        alert(`Successfully generated ${bulkResult.totalQuestions} questions across ${bulkResult.completedCombinations} combinations!`);
      }

    } catch (error) {
      console.error('Bulk generation failed:', error);

      const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';

      // Update result with error information
      result.endTime = new Date();
      result.errors = [errorMessage];

      // Mark all combinations as error
      result.combinations = result.combinations.map(combo => ({
        ...combo,
        status: 'error' as const,
        error: errorMessage
      }));

      setGenerationResult(result);
      setGenerationPhase('completed');
      setShowResults(true);
      setSelectedView('results');

      alert(`Bulk generation failed: ${errorMessage}`);
    } finally {
      setIsGenerating(false);
    }
  };

  const exportToCSV = () => {
    if (!generationResult) return;

    const headers = [
      'Question ID',
      'Question Text',
      'Answer',
      'Strand',
      'Substrand',
      'Year Level',
      'Sub Level',
      'Full Level',
      'Model Used',
      'Suggested Models',
      'Enhanced System Used',
      'Context Type',
      'Generation Status',
      'Questions Generated',
      'Generation Time',
      'Curriculum Reference',
      'Error Message',
      // Generation Setup Details
      'Controller Used',
      'Format Requested',
      'Format Actual',
      'Format Selection Reason',
      'Scenario Theme',
      'Scenario ID',
      'Scenario Selection Method',
      'Distractor Count',
      'Distractor Strategies',
      'Enhancement Level',
      'Format Variety',
      'Theme Variety',
      'Generation Time MS',
      'Features Active',
      'Features Pending'
    ];

    const csvRows = [headers.join(',')];

    generationResult.combinations.forEach((combination, combIndex) => {
      if (combination.questions && combination.questions.length > 0) {
        // Export each individual question
        combination.questions.forEach((question, qIndex) => {
          const genSetup = question.generation_setup;
          const row = [
            `"C${combIndex + 1}_Q${qIndex + 1}"`,
            `"${question.question.replace(/"/g, '""')}"`,
            `"${question.answer}"`,
            `"${combination.strand}"`,
            `"${combination.substrand}"`,
            combination.year,
            combination.subLevel,
            `"${combination.year}.${combination.subLevel}"`,
            `"${combination.primaryModel}"`,
            `"${combination.suggestedModels.join('; ')}"`,
            question.metadata.enhanced_system_used ? 'Yes' : 'No',
            'Money',
            'Completed',
            combination.questionsGenerated,
            question.metadata.timestamp ? new Date(question.metadata.timestamp).toISOString() : '',
            `"Year ${combination.year} Curriculum"`,
            '',
            // Generation Setup Details
            genSetup ? `"${genSetup.controller_used}"` : 'N/A',
            genSetup ? `"${genSetup.format_requested}"` : 'N/A',
            genSetup ? `"${genSetup.format_actual}"` : 'N/A',
            genSetup && genSetup.format_selection_reason ? `"${genSetup.format_selection_reason}"` : '',
            genSetup ? `"${genSetup.scenario_theme}"` : 'N/A',
            genSetup ? `"${genSetup.scenario_id}"` : 'N/A',
            genSetup ? `"${genSetup.scenario_selection_method}"` : 'N/A',
            genSetup ? genSetup.distractor_count : 0,
            genSetup ? `"${genSetup.distractor_strategies.join('; ')}"` : '',
            genSetup ? `"${genSetup.enhancement_level}"` : 'N/A',
            genSetup ? (genSetup.format_variety ? 'Yes' : 'No') : 'N/A',
            genSetup ? (genSetup.theme_variety ? 'Yes' : 'No') : 'N/A',
            genSetup ? genSetup.generation_time_ms : 0,
            genSetup ? `"${genSetup.features_active.join('; ')}"` : '',
            genSetup ? `"${genSetup.features_pending.join('; ')}"` : ''
          ];
          csvRows.push(row.join(','));
        });
      } else {
        // Export combination even if no questions were generated (for error tracking)
        const row = [
          `"C${combIndex + 1}_ERROR"`,
          'NO QUESTION GENERATED',
          'NO ANSWER',
          `"${combination.strand}"`,
          `"${combination.substrand}"`,
          combination.year,
          combination.subLevel,
          `"${combination.year}.${combination.subLevel}"`,
          `"${combination.primaryModel}"`,
          `"${combination.suggestedModels.join('; ')}"`,
          'N/A',
          'Money',
          combination.status,
          combination.questionsGenerated,
          '',
          `"Year ${combination.year} Curriculum"`,
          `"${combination.error || 'Unknown error'}"`,
          // Empty generation setup details for error cases
          '', '', '', '', '', '', '', 0, '', '', '', '', 0, '', ''
        ];
        csvRows.push(row.join(','));
      }
    });

    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `curriculum_questions_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  };

  const exportToJSON = () => {
    if (!generationResult) return;

    const exportData = {
      metadata: {
        exportDate: new Date().toISOString(),
        generationStartTime: generationResult.startTime.toISOString(),
        generationEndTime: generationResult.endTime?.toISOString(),
        totalCombinations: generationResult.totalCombinations,
        completedCombinations: generationResult.completedCombinations,
        failedCombinations: generationResult.totalCombinations - generationResult.completedCombinations,
        totalQuestions: generationResult.totalQuestions,
        generationTimeMs: generationResult.endTime && generationResult.startTime
          ? generationResult.endTime.getTime() - generationResult.startTime.getTime()
          : null,
        averageQuestionsPerCombination: generationResult.completedCombinations > 0
          ? Math.round((generationResult.totalQuestions / generationResult.completedCombinations) * 100) / 100
          : 0,
        configuration: {
          ...config,
          estimatedCombinations: estimatedCombinations.length,
          actualCombinations: generationResult.totalCombinations
        },
        statistics: {
          successRate: Math.round((generationResult.completedCombinations / generationResult.totalCombinations) * 100),
          errorCount: generationResult.errors.length,
          strandsProcessed: [...new Set(generationResult.combinations.map(c => c.strand))],
          modelsUsed: [...new Set(generationResult.combinations.map(c => c.primaryModel))],
          yearLevelsProcessed: [...new Set(generationResult.combinations.map(c => c.year))].sort(),
          subLevelsProcessed: [...new Set(generationResult.combinations.map(c => c.subLevel))].sort()
        },
        errors: generationResult.errors
      },
      curriculumData: {
        byStrand: generationResult.combinations.reduce((acc, combination) => {
          if (!acc[combination.strand]) {
            acc[combination.strand] = {
              substrands: {},
              totalQuestions: 0,
              totalCombinations: 0,
              completedCombinations: 0
            };
          }

          if (!acc[combination.strand].substrands[combination.substrand]) {
            acc[combination.strand].substrands[combination.substrand] = {
              combinations: [],
              totalQuestions: 0,
              yearLevels: []
            };
          }

          const strandData = acc[combination.strand];
          const substrandData = strandData.substrands[combination.substrand];

          substrandData.combinations.push({
            year: combination.year,
            subLevel: combination.subLevel,
            fullLevel: `${combination.year}.${combination.subLevel}`,
            primaryModel: combination.primaryModel,
            status: combination.status,
            questionsGenerated: combination.questionsGenerated,
            error: combination.error
          });

          substrandData.totalQuestions += combination.questionsGenerated;
          substrandData.yearLevels = [...new Set([...substrandData.yearLevels, combination.year])].sort();

          strandData.totalQuestions += combination.questionsGenerated;
          strandData.totalCombinations++;
          if (combination.status === 'completed') {
            strandData.completedCombinations++;
          }

          return acc;
        }, {} as any)
      },
      questions: generationResult.combinations.map((combination, combIndex) => ({
        combinationId: `C${combIndex + 1}`,
        curriculum: {
          strand: combination.strand,
          substrand: combination.substrand,
          year: combination.year,
          subLevel: combination.subLevel,
          fullLevel: `${combination.year}.${combination.subLevel}`
        },
        model: {
          primaryModel: combination.primaryModel,
          suggestedModels: combination.suggestedModels,
          modelCategory: ENHANCED_MODELS.includes(combination.primaryModel) ? 'Enhanced' : 'Standard'
        },
        generation: {
          status: combination.status,
          questionsGenerated: combination.questionsGenerated,
          requestedQuestions: config.questionsPerCombination,
          error: combination.error
        },
        questions: (combination.questions || []).map((question, qIndex) => ({
          questionId: `C${combIndex + 1}_Q${qIndex + 1}`,
          questionText: question.question,
          answer: question.answer,
          mathOutput: question.math_output,
          context: question.context,
          metadata: {
            ...question.metadata,
            enhancedSystemUsed: question.metadata.enhanced_system_used,
            generationTimestamp: question.metadata.timestamp
          },
          generationSetup: question.generation_setup
        }))
      }))
    };

    const jsonContent = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `curriculum_questions_complete_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-3xl font-bold text-gray-900">Curriculum Question Manager</h1>
            <div className="flex gap-2">
              <Link
                href="/"
                className="px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm"
              >
                Home
              </Link>
              <Link
                href="/test"
                className="px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 text-sm"
              >
                Question Testing
              </Link>
            </div>
          </div>
          <p className="text-gray-600">Generate questions for every combination of strand, substrand, year level, and sublevel</p>
        </div>

        {/* Navigation Tabs */}
        <div className="mb-6">
          <div className="border-b border-gray-200">
            <nav className="-mb-px flex space-x-8">
              <button
                onClick={() => setSelectedView('config')}
                className={`py-2 px-1 border-b-2 font-medium text-sm ${
                  selectedView === 'config'
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                Configuration
              </button>
              <button
                onClick={() => setSelectedView('progress')}
                className={`py-2 px-1 border-b-2 font-medium text-sm ${
                  selectedView === 'progress'
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
                disabled={!isGenerating && !showResults}
              >
                Generation Progress
              </button>
              <button
                onClick={() => setSelectedView('results')}
                className={`py-2 px-1 border-b-2 font-medium text-sm ${
                  selectedView === 'results'
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
                disabled={!showResults}
              >
                Results & Export
              </button>
            </nav>
          </div>
        </div>

        {/* Configuration View */}
        {selectedView === 'config' && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Configuration Panel */}
            <div className="bg-white rounded-lg shadow-sm border p-6">
              <h2 className="text-lg font-semibold mb-4">Generation Configuration</h2>

              {/* Strand Selection */}
              <div className="mb-6">
                <div className="flex items-center justify-between mb-3">
                  <label className="block text-sm font-medium text-gray-700">
                    Curriculum Strands ({config.selectedStrands.length} selected)
                  </label>
                  <div className="flex gap-2">
                    <button
                      onClick={selectAllStrands}
                      className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"
                    >
                      Select All
                    </button>
                    <button
                      onClick={clearAllStrands}
                      className="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200"
                    >
                      Clear All
                    </button>
                  </div>
                </div>
                <div className="max-h-48 overflow-y-auto border rounded-md p-3 space-y-2">
                  {strands.map(strand => (
                    <label key={strand} className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        checked={config.selectedStrands.includes(strand)}
                        onChange={(e) => handleStrandSelection(strand, e.target.checked)}
                        className="rounded border-gray-300"
                      />
                      <span className="text-sm text-gray-700">{strand}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Year Level Selection */}
              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 mb-3">
                  Year Levels ({config.selectedYears.length} selected)
                </label>
                <div className="flex flex-wrap gap-2">
                  {YEARS.map(year => (
                    <label key={year} className="flex items-center space-x-1">
                      <input
                        type="checkbox"
                        checked={config.selectedYears.includes(year)}
                        onChange={(e) => handleYearSelection(year, e.target.checked)}
                        className="rounded border-gray-300"
                      />
                      <span className="text-sm text-gray-700">Year {year}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Sub-Level Selection */}
              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 mb-3">
                  Sub-Levels ({config.selectedSubLevels.length} selected)
                </label>
                <div className="space-y-2">
                  {SUB_LEVELS.map(subLevel => (
                    <label key={subLevel} className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        checked={config.selectedSubLevels.includes(subLevel)}
                        onChange={(e) => handleSubLevelSelection(subLevel, e.target.checked)}
                        className="rounded border-gray-300"
                      />
                      <span className="text-sm text-gray-700">
                        Level X.{subLevel} - {
                          subLevel === 1 ? 'Introductory' :
                          subLevel === 2 ? 'Developing' :
                          subLevel === 3 ? 'Standard' :
                          'Advanced'
                        }
                      </span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Questions per Combination */}
              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Questions per Combination
                </label>
                <select
                  value={config.questionsPerCombination}
                  onChange={(e) => setConfig(prev => ({ ...prev, questionsPerCombination: parseInt(e.target.value) }))}
                  className="w-full p-2 border rounded-md bg-white"
                >
                  {[1, 2, 3, 5, 10].map(num => (
                    <option key={num} value={num}>{num} question{num > 1 ? 's' : ''}</option>
                  ))}
                </select>
              </div>

              {/* Enhanced Difficulty Toggle */}
              <div className="mb-6">
                <label className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    checked={config.useEnhancedDifficulty}
                    onChange={(e) => setConfig(prev => ({ ...prev, useEnhancedDifficulty: e.target.checked }))}
                    className="rounded border-gray-300"
                  />
                  <span className="text-sm font-medium text-gray-700">
                    Use Enhanced Difficulty System (where available)
                  </span>
                </label>
                <p className="text-xs text-gray-500 mt-1">
                  Enhanced system supports: {ENHANCED_MODELS.join(', ')}
                </p>
              </div>

              {/* Generate Button */}
              <button
                onClick={startBulkGeneration}
                disabled={isGenerating || estimatedCombinations.length === 0}
                className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium"
              >
                {isGenerating
                  ? 'Generating...'
                  : `Generate ${totalEstimated} Questions (${estimatedCombinations.length} combinations)`
                }
              </button>
            </div>

            {/* Preview Panel */}
            <div className="bg-white rounded-lg shadow-sm border p-6">
              <h2 className="text-lg font-semibold mb-4">Generation Preview</h2>

              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div className="bg-blue-50 p-3 rounded-md">
                    <div className="font-medium text-blue-900">Valid Combinations</div>
                    <div className="text-2xl font-bold text-blue-700">{estimatedCombinations.length}</div>
                  </div>
                  <div className="bg-green-50 p-3 rounded-md">
                    <div className="font-medium text-green-900">Total Questions</div>
                    <div className="text-2xl font-bold text-green-700">{totalEstimated}</div>
                  </div>
                </div>

                {estimatedCombinations.length > 0 && (
                  <div>
                    <h3 className="font-medium text-gray-900 mb-2">Sample Combinations:</h3>
                    <div className="max-h-64 overflow-y-auto space-y-2">
                      {estimatedCombinations.slice(0, 10).map((combo, index) => (
                        <div key={index} className="text-xs bg-gray-50 p-2 rounded border">
                          <div className="font-medium">{combo.strand} â {combo.substrand}</div>
                          <div className="text-gray-600">Year {combo.year}.{combo.subLevel} â {combo.primaryModel}</div>
                        </div>
                      ))}
                      {estimatedCombinations.length > 10 && (
                        <div className="text-xs text-gray-500 italic">
                          ...and {estimatedCombinations.length - 10} more combinations
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Progress View */}
        {selectedView === 'progress' && (
          <div className="bg-white rounded-lg shadow-sm border p-6">
            <h2 className="text-lg font-semibold mb-4">Generation Progress</h2>

            {generationResult && (
              <div className="space-y-6">
                {/* Progress Bar */}
                <div>
                  <div className="flex justify-between text-sm text-gray-600 mb-2">
                    <span>
                      {generationPhase === 'preparing' && 'Preparing generation...'}
                      {generationPhase === 'generating' && `Generating: ${currentProgress} / ${generationResult.totalCombinations} combinations`}
                      {generationPhase === 'processing' && 'Processing results...'}
                      {generationPhase === 'completed' && `Completed: ${currentProgress} / ${generationResult.totalCombinations} combinations`}
                      {generationPhase === 'idle' && `Progress: ${currentProgress} / ${generationResult.totalCombinations} combinations`}
                    </span>
                    <span>
                      {generationPhase === 'preparing' && '0%'}
                      {generationPhase === 'processing' && '95%'}
                      {generationPhase === 'completed' && '100%'}
                      {(generationPhase === 'generating' || generationPhase === 'idle') &&
                        `${Math.round((currentProgress / generationResult.totalCombinations) * 100)}%`}
                    </span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3">
                    <div
                      className={`h-3 rounded-full transition-all duration-500 ${
                        generationPhase === 'generating' ? 'bg-blue-600' :
                        generationPhase === 'processing' ? 'bg-yellow-500' :
                        generationPhase === 'completed' ? 'bg-green-600' :
                        'bg-gray-400'
                      }`}
                      style={{
                        width: `${
                          generationPhase === 'preparing' ? 5 :
                          generationPhase === 'processing' ? 95 :
                          generationPhase === 'completed' ? 100 :
                          (currentProgress / generationResult.totalCombinations) * 100
                        }%`
                      }}
                    ></div>
                  </div>
                </div>

                {/* Statistics */}
                <div className="grid grid-cols-3 gap-4">
                  <div className="bg-green-50 p-3 rounded-md text-center">
                    <div className="text-2xl font-bold text-green-700">{generationResult.totalQuestions}</div>
                    <div className="text-sm text-green-600">Questions Generated</div>
                  </div>
                  <div className="bg-blue-50 p-3 rounded-md text-center">
                    <div className="text-2xl font-bold text-blue-700">{generationResult.completedCombinations}</div>
                    <div className="text-sm text-blue-600">Combinations Complete</div>
                  </div>
                  <div className="bg-red-50 p-3 rounded-md text-center">
                    <div className="text-2xl font-bold text-red-700">{generationResult.errors.length}</div>
                    <div className="text-sm text-red-600">Errors</div>
                  </div>
                </div>

                {/* Real-time Combination Status */}
                <div>
                  <h3 className="font-medium text-gray-900 mb-3">Combination Status</h3>
                  <div className="max-h-96 overflow-y-auto space-y-2">
                    {generationResult.combinations.map((combo, index) => (
                      <div key={index} className={`p-3 rounded-md text-sm border ${
                        combo.status === 'completed' ? 'bg-green-50 border-green-200' :
                        combo.status === 'generating' ? 'bg-blue-50 border-blue-200' :
                        combo.status === 'error' ? 'bg-red-50 border-red-200' :
                        'bg-gray-50 border-gray-200'
                      }`}>
                        <div className="flex items-center justify-between">
                          <div>
                            <span className="font-medium">{combo.strand} â {combo.substrand}</span>
                            <span className="ml-2 text-gray-600">Year {combo.year}.{combo.subLevel}</span>
                            <span className="ml-2 text-gray-500">({combo.primaryModel})</span>
                          </div>
                          <div className="flex items-center gap-2">
                            {combo.status === 'completed' && (
                              <span className="text-green-600 font-medium">{combo.questionsGenerated} questions</span>
                            )}
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                              combo.status === 'completed' ? 'bg-green-100 text-green-700' :
                              combo.status === 'generating' ? 'bg-blue-100 text-blue-700' :
                              combo.status === 'error' ? 'bg-red-100 text-red-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>
                              {combo.status === 'generating' ? 'â³ Generating...' :
                               combo.status === 'completed' ? 'â Complete' :
                               combo.status === 'error' ? 'â Error' :
                               'â¸ï¸ Pending'}
                            </span>
                          </div>
                        </div>
                        {combo.error && (
                          <div className="mt-1 text-red-600 text-xs">{combo.error}</div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Results View */}
        {selectedView === 'results' && generationResult && (
          <div className="space-y-6">
            {/* Summary Stats */}
            <div className="bg-white rounded-lg shadow-sm border p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold">Generation Complete</h2>
                <div className="flex gap-2">
                  <button
                    onClick={exportToCSV}
                    className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium"
                  >
                    Export CSV
                  </button>
                  <button
                    onClick={exportToJSON}
                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
                  >
                    Export JSON
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-green-50 p-4 rounded-lg">
                  <div className="text-2xl font-bold text-green-700">{generationResult.totalQuestions}</div>
                  <div className="text-sm text-green-600">Questions Generated</div>
                </div>
                <div className="bg-blue-50 p-4 rounded-lg">
                  <div className="text-2xl font-bold text-blue-700">{generationResult.completedCombinations}</div>
                  <div className="text-sm text-blue-600">Successful Combinations</div>
                </div>
                <div className="bg-red-50 p-4 rounded-lg">
                  <div className="text-2xl font-bold text-red-700">{generationResult.errors.length}</div>
                  <div className="text-sm text-red-600">Failed Combinations</div>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg">
                  <div className="text-2xl font-bold text-purple-700">
                    {generationResult.endTime && generationResult.startTime
                      ? `${Math.round((generationResult.endTime.getTime() - generationResult.startTime.getTime()) / 1000)}s`
                      : 'N/A'
                    }
                  </div>
                  <div className="text-sm text-purple-600">Total Time</div>
                </div>
              </div>

              {generationResult.errors.length > 0 && (
                <div className="mb-4">
                  <h3 className="font-medium text-red-900 mb-2">Errors ({generationResult.errors.length})</h3>
                  <div className="max-h-32 overflow-y-auto bg-red-50 border border-red-200 rounded-md p-3">
                    {generationResult.errors.map((error, index) => (
                      <div key={index} className="text-sm text-red-700 mb-1">{error}</div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Curriculum Coverage Component */}
            <CurriculumCoverage
              combinations={generationResult.combinations}
              config={config}
            />
          </div>
        )}
      </div>
    </div>
  );
}
```
--- END FILE: app\curriculum-manager\page.tsx ---

--- START FILE: app\curriculum-tester\page.tsx ---
```typescript
'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  CheckCircle,
  XCircle,
  Clock,
  Play,
  RotateCcw,
  Download,
  Upload,
  Star,
  TrendingUp,
  Filter,
  Eye
} from 'lucide-react';

import { testTracker, TestResult, TestSummary, TestingProgress } from '@/lib/curriculum/test-tracking';
import { MODEL_STATUS_REGISTRY } from '@/lib/models/model-status';
import { CURRICULUM_DATA } from '@/context/curriculum';

interface TestingState {
  selectedStrand: string;
  selectedSubstrand: string;
  selectedYear: number;
  selectedModel: string;
  isGenerating: boolean;
  currentQuestion: string | null;
  currentParameters: any;
  generationTime: number | null;
  generationError: string | null;
  showRating: boolean;
  currentTestId: string | null;
}

const CurriculumTesterPage = () => {
  const [testingState, setTestingState] = useState<TestingState>({
    selectedStrand: '',
    selectedSubstrand: '',
    selectedYear: 1,
    selectedModel: '',
    isGenerating: false,
    currentQuestion: null,
    currentParameters: null,
    generationTime: null,
    generationError: null,
    showRating: false,
    currentTestId: null
  });

  const [progress, setProgress] = useState<TestingProgress | null>(null);
  const [currentSummary, setCurrentSummary] = useState<TestSummary | null>(null);
  const [recentTests, setRecentTests] = useState<TestResult[]>([]);
  const [viewMode, setViewMode] = useState<'testing' | 'progress' | 'results'>('testing');

  // Get curriculum data
  const strands = Object.keys(CURRICULUM_DATA);
  const substrands = testingState.selectedStrand
    ? Object.keys(CURRICULUM_DATA[testingState.selectedStrand] || {})
    : [];
  const years = [1, 2, 3, 4, 5, 6];
  const models = Object.keys(MODEL_STATUS_REGISTRY);

  // Update progress when component mounts or data changes
  useEffect(() => {
    updateProgress();
    updateRecentTests();
  }, []);

  // Update summary when selection changes
  useEffect(() => {
    if (testingState.selectedStrand && testingState.selectedSubstrand && testingState.selectedModel) {
      const summary = testTracker.getSummary(
        testingState.selectedStrand,
        testingState.selectedSubstrand,
        testingState.selectedYear,
        testingState.selectedModel
      );
      setCurrentSummary(summary);
    } else {
      setCurrentSummary(null);
    }
  }, [testingState.selectedStrand, testingState.selectedSubstrand, testingState.selectedYear, testingState.selectedModel]);

  const updateProgress = () => {
    const progressData = testTracker.getProgress(strands, substrands, years, models);
    setProgress(progressData);
  };

  const updateRecentTests = () => {
    const recent = testTracker.getAllResults()
      .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime())
      .slice(0, 20);
    setRecentTests(recent);
  };

  const generateQuestion = async () => {
    if (!testingState.selectedStrand || !testingState.selectedSubstrand || !testingState.selectedModel) {
      return;
    }

    setTestingState(prev => ({
      ...prev,
      isGenerating: true,
      currentQuestion: null,
      generationError: null,
      generationTime: null,
      showRating: false
    }));

    const startTime = Date.now();

    try {
      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          mathModel: testingState.selectedModel,
          year: testingState.selectedYear,
          subLevel: 2, // Standard difficulty
          questionFormat: 'DIRECT_CALCULATION'
        })
      });

      const endTime = Date.now();
      const generationTime = endTime - startTime;

      if (response.ok) {
        const result = await response.json();

        // Record successful test
        const testResult = testTracker.addTestResult({
          strand: testingState.selectedStrand,
          substrand: testingState.selectedSubstrand,
          year: testingState.selectedYear,
          modelId: testingState.selectedModel,
          questionGenerated: result.question || 'Question generated successfully',
          parameters: result.parameters || {},
          success: true,
          generationTime
        });

        setTestingState(prev => ({
          ...prev,
          isGenerating: false,
          currentQuestion: result.question || 'Question generated successfully',
          currentParameters: result.parameters || {},
          generationTime,
          showRating: true,
          currentTestId: testResult.id
        }));
      } else {
        const error = await response.text();

        // Record failed test
        testTracker.addTestResult({
          strand: testingState.selectedStrand,
          substrand: testingState.selectedSubstrand,
          year: testingState.selectedYear,
          modelId: testingState.selectedModel,
          questionGenerated: '',
          parameters: {},
          success: false,
          generationTime,
          errorMessage: error
        });

        setTestingState(prev => ({
          ...prev,
          isGenerating: false,
          generationError: error
        }));
      }

      // Update progress and recent tests
      updateProgress();
      updateRecentTests();

    } catch (error) {
      const endTime = Date.now();
      const generationTime = endTime - startTime;

      testTracker.addTestResult({
        strand: testingState.selectedStrand,
        substrand: testingState.selectedSubstrand,
        year: testingState.selectedYear,
        modelId: testingState.selectedModel,
        questionGenerated: '',
        parameters: {},
        success: false,
        generationTime,
        errorMessage: error instanceof Error ? error.message : 'Unknown error'
      });

      setTestingState(prev => ({
        ...prev,
        isGenerating: false,
        generationError: error instanceof Error ? error.message : 'Unknown error'
      }));

      updateProgress();
      updateRecentTests();
    }
  };

  const submitRating = (rating: 1 | 2 | 3 | 4 | 5, notes?: string) => {
    if (testingState.currentTestId) {
      testTracker.updateRating(testingState.currentTestId, rating, notes);
      setTestingState(prev => ({ ...prev, showRating: false, currentTestId: null }));
      updateProgress();
      updateRecentTests();
    }
  };

  const exportResults = () => {
    const data = testTracker.exportResults();
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `test-results-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const getStatusColor = (status: TestSummary['recommendedStatus']) => {
    switch (status) {
      case 'approved': return 'bg-green-500';
      case 'rejected': return 'bg-red-500';
      case 'needs_review': return 'bg-yellow-500';
      case 'testing': return 'bg-blue-500';
      default: return 'bg-gray-500';
    }
  };

  const getStatusText = (status: TestSummary['recommendedStatus']) => {
    switch (status) {
      case 'approved': return 'Approved';
      case 'rejected': return 'Rejected';
      case 'needs_review': return 'Needs Review';
      case 'testing': return 'Testing';
      default: return 'Untested';
    }
  };

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold">Curriculum Testing Center</h1>
          <p className="text-gray-600">Test mathematical models against curriculum combinations</p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={exportResults}>
            <Download className="w-4 h-4 mr-2" />
            Export Results
          </Button>
        </div>
      </div>

      <Tabs value={viewMode} onValueChange={(value: any) => setViewMode(value)}>
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="testing" className="flex items-center gap-2">
            <Play className="w-4 h-4" />
            Testing
          </TabsTrigger>
          <TabsTrigger value="progress" className="flex items-center gap-2">
            <TrendingUp className="w-4 h-4" />
            Progress
          </TabsTrigger>
          <TabsTrigger value="results" className="flex items-center gap-2">
            <Eye className="w-4 h-4" />
            Results
          </TabsTrigger>
        </TabsList>

        <TabsContent value="testing" className="space-y-6">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Selection Panel */}
            <Card className="lg:col-span-1">
              <CardHeader>
                <CardTitle>Test Configuration</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <label className="text-sm font-medium mb-2 block">Strand</label>
                  <Select value={testingState.selectedStrand} onValueChange={(value) =>
                    setTestingState(prev => ({ ...prev, selectedStrand: value, selectedSubstrand: '' }))
                  }>
                    <SelectTrigger>
                      <SelectValue placeholder="Select strand" />
                    </SelectTrigger>
                    <SelectContent>
                      {strands.map(strand => (
                        <SelectItem key={strand} value={strand}>{strand}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-medium mb-2 block">Substrand</label>
                  <Select
                    value={testingState.selectedSubstrand}
                    onValueChange={(value) => setTestingState(prev => ({ ...prev, selectedSubstrand: value }))}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Select substrand" />
                    </SelectTrigger>
                    <SelectContent>
                      {substrands.map(substrand => (
                        <SelectItem key={substrand} value={substrand}>{substrand}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-medium mb-2 block">Year</label>
                  <Select value={testingState.selectedYear.toString()} onValueChange={(value) =>
                    setTestingState(prev => ({ ...prev, selectedYear: parseInt(value) }))
                  }>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {years.map(year => (
                        <SelectItem key={year} value={year.toString()}>Year {year}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-medium mb-2 block">Model</label>
                  <Select value={testingState.selectedModel} onValueChange={(value) =>
                    setTestingState(prev => ({ ...prev, selectedModel: value }))
                  }>
                    <SelectTrigger>
                      <SelectValue placeholder="Select model" />
                    </SelectTrigger>
                    <SelectContent>
                      {models.map(modelId => (
                        <SelectItem key={modelId} value={modelId}>
                          {MODEL_STATUS_REGISTRY[modelId]?.name || modelId}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <Button
                  onClick={generateQuestion}
                  disabled={testingState.isGenerating || !testingState.selectedStrand || !testingState.selectedSubstrand || !testingState.selectedModel}
                  className="w-full"
                >
                  {testingState.isGenerating ? (
                    <>
                      <RotateCcw className="w-4 h-4 mr-2 animate-spin" />
                      Generating...
                    </>
                  ) : (
                    <>
                      <Play className="w-4 h-4 mr-2" />
                      Generate Question
                    </>
                  )}
                </Button>

                {currentSummary && (
                  <div className="pt-4 border-t">
                    <h4 className="font-medium mb-2">Current Combination</h4>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span>Tests:</span>
                        <span>{currentSummary.totalTests}</span>
                      </div>
                      <div className="flex justify-between">
                        <span>Success:</span>
                        <span>{currentSummary.successfulTests}/{currentSummary.totalTests}</span>
                      </div>
                      {currentSummary.averageRating && (
                        <div className="flex justify-between">
                          <span>Avg Rating:</span>
                          <span className="flex items-center gap-1">
                            {currentSummary.averageRating.toFixed(1)}
                            <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                          </span>
                        </div>
                      )}
                      <div className="flex justify-between">
                        <span>Status:</span>
                        <Badge variant="outline" className={`${getStatusColor(currentSummary.recommendedStatus)} text-white`}>
                          {getStatusText(currentSummary.recommendedStatus)}
                        </Badge>
                      </div>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Results Panel */}
            <Card className="lg:col-span-2">
              <CardHeader>
                <CardTitle>Test Results</CardTitle>
              </CardHeader>
              <CardContent>
                {testingState.isGenerating ? (
                  <div className="flex items-center justify-center py-12">
                    <RotateCcw className="w-8 h-8 animate-spin text-blue-500" />
                    <span className="ml-3">Generating question...</span>
                  </div>
                ) : testingState.currentQuestion ? (
                  <div className="space-y-4">
                    <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                      <div className="flex items-start gap-3">
                        <CheckCircle className="w-5 h-5 text-green-500 mt-1" />
                        <div className="flex-1">
                          <h4 className="font-medium text-green-800 mb-2">Question Generated Successfully</h4>
                          <p className="text-gray-700">{testingState.currentQuestion}</p>
                        </div>
                      </div>
                    </div>

                    {testingState.generationTime && (
                      <div className="flex items-center gap-2 text-sm text-gray-600">
                        <Clock className="w-4 h-4" />
                        Generated in {testingState.generationTime}ms
                      </div>
                    )}

                    {testingState.showRating && (
                      <div className="border-t pt-4">
                        <h4 className="font-medium mb-3">Rate this question's appropriateness</h4>
                        <div className="flex gap-2 mb-4">
                          {[1, 2, 3, 4, 5].map(rating => (
                            <Button
                              key={rating}
                              variant="outline"
                              size="sm"
                              onClick={() => submitRating(rating as 1 | 2 | 3 | 4 | 5)}
                              className="flex items-center gap-1"
                            >
                              {rating}
                              <Star className="w-3 h-3" />
                            </Button>
                          ))}
                        </div>
                        <p className="text-xs text-gray-500">1 = Poor fit, 5 = Perfect fit for curriculum area</p>
                      </div>
                    )}
                  </div>
                ) : testingState.generationError ? (
                  <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                    <div className="flex items-start gap-3">
                      <XCircle className="w-5 h-5 text-red-500 mt-1" />
                      <div className="flex-1">
                        <h4 className="font-medium text-red-800 mb-2">Generation Failed</h4>
                        <p className="text-gray-700 text-sm">{testingState.generationError}</p>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <Play className="w-12 h-12 mx-auto mb-3 opacity-50" />
                    <p>Select a curriculum combination and model, then click "Generate Question" to begin testing.</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        <TabsContent value="progress" className="space-y-6">
          {progress && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <Card>
                <CardContent className="pt-6">
                  <div className="text-2xl font-bold">{progress.testedCombinations}</div>
                  <p className="text-xs text-gray-600">Combinations Tested</p>
                  <Progress value={(progress.testedCombinations / progress.totalCombinations) * 100} className="mt-2" />
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-2xl font-bold text-green-600">{progress.approvedCombinations}</div>
                  <p className="text-xs text-gray-600">Approved Combinations</p>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-2xl font-bold text-red-600">{progress.rejectedCombinations}</div>
                  <p className="text-xs text-gray-600">Rejected Combinations</p>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-2xl font-bold text-blue-600">{progress.totalCombinations}</div>
                  <p className="text-xs text-gray-600">Total Combinations</p>
                </CardContent>
              </Card>
            </div>
          )}

          {progress && (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card>
                <CardHeader>
                  <CardTitle>Progress by Year</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {Object.entries(progress.byYear).map(([year, stats]) => (
                      <div key={year}>
                        <div className="flex justify-between text-sm mb-1">
                          <span>Year {year}</span>
                          <span>{stats.tested}/{stats.total}</span>
                        </div>
                        <Progress value={(stats.tested / stats.total) * 100} />
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Progress by Model</CardTitle>
                </CardHeader>
                <CardContent className="max-h-80 overflow-y-auto">
                  <div className="space-y-4">
                    {Object.entries(progress.byModel)
                      .sort(([, a], [, b]) => (b.tested / b.total) - (a.tested / a.total))
                      .map(([modelId, stats]) => (
                        <div key={modelId}>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="truncate">{MODEL_STATUS_REGISTRY[modelId]?.name || modelId}</span>
                            <span>{stats.tested}/{stats.total}</span>
                          </div>
                          <Progress value={(stats.tested / stats.total) * 100} />
                        </div>
                      ))}
                  </div>
                </CardContent>
              </Card>
            </div>
          )}
        </TabsContent>

        <TabsContent value="results" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Recent Test Results</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {recentTests.map(test => (
                  <div key={test.id} className="flex items-center gap-3 p-3 border rounded-lg">
                    {test.success ? (
                      <CheckCircle className="w-5 h-5 text-green-500" />
                    ) : (
                      <XCircle className="w-5 h-5 text-red-500" />
                    )}
                    <div className="flex-1 min-w-0">
                      <div className="text-sm font-medium truncate">
                        {test.strand} â {test.substrand} (Year {test.year})
                      </div>
                      <div className="text-xs text-gray-500">
                        {MODEL_STATUS_REGISTRY[test.modelId]?.name || test.modelId}
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      {test.rating && (
                        <div className="flex items-center gap-1">
                          <span className="text-sm">{test.rating}</span>
                          <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                        </div>
                      )}
                      <div className="text-xs text-gray-500">
                        {test.generationTime}ms
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
};

export default CurriculumTesterPage;
```
--- END FILE: app\curriculum-tester\page.tsx ---

--- START FILE: app\globals.css ---
```css
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

```
--- END FILE: app\globals.css ---

--- START FILE: app\layout.tsx ---
```typescript
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Factory Architect - UK Maths Question Generator",
  description: "Educational Mathematics Question Generator for UK National Curriculum with comprehensive testing and bulk generation capabilities",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}

```
--- END FILE: app\layout.tsx ---

--- START FILE: app\page.tsx ---
```typescript
import Link from 'next/link';

export default function Home() {
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-4xl mx-auto px-4 py-12">
        <header className="text-center mb-12">
          <h1 className="text-4xl font-bold text-gray-900 mb-4">
            Factory Architect
          </h1>
          <p className="text-xl text-gray-600 max-w-2xl mx-auto">
            Educational Mathematics Question Generator for UK National Curriculum
          </p>
        </header>

        <div className="grid md:grid-cols-2 gap-8 mb-12">
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-2xl font-semibold mb-4">Math Engine</h2>
            <p className="text-gray-600 mb-4">
              Pure mathematical models that operate on numbers and logical parameters.
              Each operation is atomic and separate from narrative context.
            </p>
            <ul className="text-sm text-gray-600 space-y-1">
              <li>â Addition - Summing arrays of values</li>
              <li>â Subtraction - Finding differences</li>
              <li>â Multiplication - Computing products</li>
              <li>â Division - Quotients and remainders</li>
              <li>â Percentage - Calculations and comparisons</li>
              <li>â Fraction - Finding fractions of amounts</li>
              <li>â Counting - Coin combinations and counting</li>
              <li>â Time Rate - Savings over time periods</li>
              <li>â Conversion - Unit conversions (Â£/p, m/cm)</li>
              <li>â Comparison - Value and rate comparisons</li>
              <li className="text-gray-400">â Multi-Step - Operation sequences</li>
              <li className="text-gray-400">â Linear Equations - y = mx + c</li>
              <li className="text-gray-400">â Unit Rate - Rate calculations</li>
            </ul>
          </div>

          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-2xl font-semibold mb-4">Story Engine</h2>
            <p className="text-gray-600 mb-4">
              Contextual layer that wraps mathematical output with real-world scenarios.
              Same math can be presented as money, measurements, or other contexts.
            </p>
            <ul className="text-sm text-gray-600 space-y-1">
              <li>â Money contexts - Shopping, change, savings</li>
              <li>â Dynamic question templates</li>
              <li>â Year-appropriate difficulty scaling</li>
              <li>â UK National Curriculum aligned</li>
              <li className="text-gray-400">â Measurement contexts</li>
              <li className="text-gray-400">â Time-based scenarios</li>
              <li className="text-gray-400">â Multi-language support</li>
            </ul>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-md p-6 mb-8">
          <h2 className="text-2xl font-semibold mb-4">Key Features</h2>
          <div className="grid md:grid-cols-3 gap-6">
            <div>
              <h3 className="font-semibold text-lg mb-2">Separation of Concerns</h3>
              <p className="text-gray-600 text-sm">
                Mathematical logic completely separated from story context for maximum flexibility.
              </p>
            </div>
            <div>
              <h3 className="font-semibold text-lg mb-2">Difficulty Scaling</h3>
              <p className="text-gray-600 text-sm">
                Questions adapt to Years 1-6 with progressive complexity and appropriate parameters.
              </p>
            </div>
            <div>
              <h3 className="font-semibold text-lg mb-2">Context Flexibility</h3>
              <p className="text-gray-600 text-sm">
                Same mathematical output can be wrapped in different real-world scenarios.
              </p>
            </div>
          </div>
        </div>

        <div className="text-center space-y-6">
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <Link
              href="/test"
              className="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
            >
              Question Testing
            </Link>
            <Link
              href="/curriculum-manager"
              className="inline-block bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors"
            >
              Curriculum Manager
            </Link>
            <Link
              href="/curriculum-tester"
              className="inline-block bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
            >
              Testing Center
            </Link>
            <Link
              href="/curriculum-curator"
              className="inline-block bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-700 transition-colors"
            >
              Curriculum Curator
            </Link>
          </div>
          <div className="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto text-left">
            <div>
              <h3 className="font-semibold text-lg mb-2">Core Interfaces</h3>
              <ul className="text-sm text-gray-600 space-y-1">
                <li><strong>Question Testing:</strong> Generate and test individual questions</li>
                <li><strong>Curriculum Manager:</strong> Bulk generation for all curriculum combinations</li>
              </ul>
            </div>
            <div>
              <h3 className="font-semibold text-lg mb-2">Testing & Curation</h3>
              <ul className="text-sm text-gray-600 space-y-1">
                <li><strong>Testing Center:</strong> Systematically test model-curriculum combinations</li>
                <li><strong>Curriculum Curator:</strong> Define and manage curated model mappings</li>
              </ul>
            </div>
          </div>
        </div>

        <div className="mt-12 bg-gray-100 rounded-lg p-6">
          <h2 className="text-xl font-semibold mb-4">API Usage</h2>
          <p className="text-gray-600 mb-4">
            Generate questions programmatically using our REST API:
          </p>
          <div className="bg-gray-800 text-green-400 p-4 rounded-md text-sm font-mono">
            <p className="mb-2">POST /api/generate</p>
            <p className="text-gray-300">
              {`{
  "model_id": "ADDITION",
  "year_level": 4,
  "context_type": "money"
}`}
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

```
--- END FILE: app\page.tsx ---

--- START FILE: app\test\page.tsx ---
```typescript
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { GeneratedQuestion } from '@/lib/types';
import { MODEL_STATUS_REGISTRY, ModelStatus, getCompletionStats } from '@/lib/models/model-status';
import { curriculumParser, CurriculumFilter } from '@/lib/curriculum/curriculum-parser';
import { curriculumModelMapper } from '@/lib/curriculum/curriculum-model-mapping';
import { EnhancedDifficultySystem } from '@/lib/math-engine/difficulty-enhanced';
import { SubDifficultyLevel } from '@/lib/types-enhanced';

type FilterMode = 'model' | 'curriculum';

const YEARS = [1, 2, 3, 4, 5, 6];
const SUB_LEVELS = [1, 2, 3, 4];
const ENHANCED_MODELS = ['ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'PERCENTAGE', 'FRACTION'];

export default function TestPage() {
  // Filter mode state
  const [filterMode, setFilterMode] = useState<FilterMode>('model');
  
  // Model-first filtering
  const [selectedModel, setSelectedModel] = useState('ADDITION');
  const [selectedYear, setSelectedYear] = useState(4);
  const [selectedSubLevel, setSelectedSubLevel] = useState(3);
  const [useEnhancedDifficulty, setUseEnhancedDifficulty] = useState(true);
  const [sessionId, setSessionId] = useState('session_default');
  const [adaptiveMode, setAdaptiveMode] = useState(false);
  const [confidenceMode, setConfidenceMode] = useState(false);
  
  // Curriculum-first filtering
  const [selectedStrand, setSelectedStrand] = useState('');
  const [selectedSubstrand, setSelectedSubstrand] = useState('');
  const [selectedCurriculumYear, setSelectedCurriculumYear] = useState(1);
  const [selectedCurriculumSubLevel, setSelectedCurriculumSubLevel] = useState(3);
  const [curriculumFilter, setCurriculumFilter] = useState<CurriculumFilter | null>(null);
  const [suggestedModels, setSuggestedModels] = useState<string[]>([]);
  
  // Curriculum data
  const [strands, setStrands] = useState<string[]>([]);
  const [substrands, setSubstrands] = useState<string[]>([]);
  const [availableYears, setAvailableYears] = useState<number[]>([]);
  
  // Question state
  const [generatedQuestion, setGeneratedQuestion] = useState<GeneratedQuestion | null>(null);
  const [generatedQuestions, setGeneratedQuestions] = useState<GeneratedQuestion[]>([]);
  const [batchMetadata, setBatchMetadata] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showAnswer, setShowAnswer] = useState<number | null>(null);
  const [questionHistory, setQuestionHistory] = useState<GeneratedQuestion[]>([]);
  const [quantity, setQuantity] = useState(1);
  const [showBatchView, setShowBatchView] = useState(false);

  // Initialize session ID after hydration
  useEffect(() => {
    setSessionId(`session_${Date.now()}`);
  }, []);

  // Initialize curriculum data
  useEffect(() => {
    const allStrands = curriculumParser.getStrands();
    setStrands(allStrands);
    if (allStrands.length > 0 && !selectedStrand) {
      setSelectedStrand(allStrands[0]);
    }
  }, []);

  // Update substrands when strand changes
  useEffect(() => {
    if (selectedStrand) {
      const strandSubstrands = curriculumParser.getSubstrands(selectedStrand);
      setSubstrands(strandSubstrands);
      if (strandSubstrands.length > 0) {
        setSelectedSubstrand(strandSubstrands[0]);
      }
    }
  }, [selectedStrand]);

  // Update available years when substrand changes
  useEffect(() => {
    if (selectedStrand && selectedSubstrand) {
      const years = curriculumParser.getAvailableYears(selectedStrand, selectedSubstrand);
      setAvailableYears(years);
      if (years.length > 0) {
        setSelectedCurriculumYear(years[0]);
      }
    }
  }, [selectedStrand, selectedSubstrand]);

  // Update curriculum filter and suggested models
  useEffect(() => {
    if (selectedStrand && selectedSubstrand && selectedCurriculumYear) {
      const filter = curriculumParser.getCurriculumDescription(
        selectedStrand,
        selectedSubstrand,
        selectedCurriculumYear
      );
      setCurriculumFilter(filter);
      
      if (filter) {
        const suggested = curriculumModelMapper.getSuggestedModels(filter);
        setSuggestedModels(suggested);
      }
    }
  }, [selectedStrand, selectedSubstrand, selectedCurriculumYear]);

  const generateQuestion = async (modelId?: string, yearLevel?: number, subLevel?: number) => {
    const model = modelId || (filterMode === 'model' ? selectedModel : suggestedModels[0]);
    const year = yearLevel || (filterMode === 'model' ? selectedYear : selectedCurriculumYear);
    const subLvl = subLevel || (filterMode === 'model' ? selectedSubLevel : selectedCurriculumSubLevel);
    
    if (!model) {
      setError('No model selected or available');
      return;
    }

    setLoading(true);
    setError(null);
    setShowAnswer(null);

    try {
      const requestBody: any = {
        model_id: model,
        context_type: 'money',
        quantity: quantity
      };

      // Use enhanced difficulty system if available and enabled
      if (useEnhancedDifficulty && ENHANCED_MODELS.includes(model)) {
        requestBody.sub_level = `${year}.${subLvl}`;
        requestBody.session_id = sessionId;
        requestBody.adaptive_mode = adaptiveMode;
        requestBody.confidence_mode = confidenceMode;
      } else {
        requestBody.year_level = year;
      }

      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody),
      });

      if (!response.ok) {
        throw new Error(`Failed to generate question: ${response.statusText}`);
      }

      const data = await response.json();

      if (quantity === 1) {
        // Single question response
        const singleQuestion: GeneratedQuestion = data;
        setGeneratedQuestion(singleQuestion);
        setGeneratedQuestions([]);
        setBatchMetadata(null);
        setShowBatchView(false);
        setQuestionHistory(prev => [singleQuestion, ...prev.slice(0, 9)]);
      } else {
        // Batch response
        setGeneratedQuestion(null);
        setGeneratedQuestions(data.questions);
        setBatchMetadata(data.batch_metadata);
        setShowBatchView(true);
        setQuestionHistory(prev => [...data.questions, ...prev].slice(0, 20));
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred');
    } finally {
      setLoading(false);
    }
  };

  const downloadAsJSON = () => {
    if (showBatchView && generatedQuestions.length > 0) {
      const dataToDownload = {
        questions: generatedQuestions,
        batch_metadata: batchMetadata
      };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToDownload, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `questions_${batchMetadata.model_id}_${batchMetadata.quantity}.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }
  };

  const getEnhancementStatusBadge = (metadata: any) => {
    const status = metadata.enhancement_status || 'unknown';
    const formatRequested = metadata.format_requested;
    const formatUsed = metadata.format_used;

    switch (status) {
      case 'full':
        return (
          <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200" title="Fully enhanced with all features">
            â¨ Full Enhancement
          </span>
        );
      case 'partial':
        return (
          <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200" title="Enhanced with basic features">
            ð· Partial Enhancement
          </span>
        );
      case 'fallback':
        return (
          <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700 border border-yellow-200" title={`Requested ${formatRequested} but used ${formatUsed} (pending implementation)`}>
            â³ Fallback Mode
          </span>
        );
      default:
        return (
          <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">
            â¨ Enhanced
          </span>
        );
    }
  };

  const downloadAsCSV = () => {
    if (showBatchView && generatedQuestions.length > 0) {
      const csvContent = "Question,Answer,Model,Year Level,Sub Level,Enhancement Status,Format Used\n" +
        generatedQuestions.map(q =>
          `"${q.question.replace(/"/g, '""')}","${q.answer}","${q.metadata.model_id}","${q.metadata.year_level}","${q.metadata.sub_level || 'N/A'}","${q.generation_setup?.enhancement_level || 'unknown'}","${q.generation_setup?.format_actual || 'unknown'}"`
        ).join('\n');

      const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `questions_${batchMetadata.model_id}_${batchMetadata.quantity}.csv`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }
  };

  const getModelStatusBadge = (modelId: string) => {
    const modelInfo = MODEL_STATUS_REGISTRY[modelId];
    if (!modelInfo) return null;

    const statusColors = {
      [ModelStatus.COMPLETE]: 'bg-green-100 text-green-800 border-green-200',
      [ModelStatus.WIP]: 'bg-yellow-100 text-yellow-800 border-yellow-200',
      [ModelStatus.BROKEN]: 'bg-red-100 text-red-800 border-red-200',
      [ModelStatus.PLANNED]: 'bg-gray-100 text-gray-800 border-gray-200'
    };

    const statusLabels = {
      [ModelStatus.COMPLETE]: 'â',
      [ModelStatus.WIP]: 'WIP',
      [ModelStatus.BROKEN]: 'â ',
      [ModelStatus.PLANNED]: 'â'
    };

    return (
      <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${statusColors[modelInfo.status]}`}>
        {statusLabels[modelInfo.status]}
      </span>
    );
  };

  const getModelDisplayName = (modelId: string) => {
    const modelInfo = MODEL_STATUS_REGISTRY[modelId];
    return modelInfo ? modelInfo.name : modelId.replace('_', ' ');
  };

  const isModelDisabled = (modelId: string) => {
    const modelInfo = MODEL_STATUS_REGISTRY[modelId];
    return modelInfo?.status === ModelStatus.BROKEN;
  };

  const completionStats = getCompletionStats();

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto px-4">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-3xl font-bold text-gray-900">Mathematics Question Generator</h1>
            <div className="flex gap-2">
              <Link
                href="/"
                className="px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm"
              >
                Home
              </Link>
              <Link
                href="/curriculum-manager"
                className="px-3 py-1 bg-green-100 text-green-700 rounded-md hover:bg-green-200 text-sm"
              >
                Curriculum Manager
              </Link>
            </div>
          </div>
          <div className="flex items-center gap-4 text-sm text-gray-600">
            <span>Total Models: {completionStats.total}</span>
            <span className="text-green-600">Complete: {completionStats.complete}</span>
            <span className="text-yellow-600">WIP: {completionStats.wip}</span>
            <span className="text-red-600">Broken: {completionStats.broken}</span>
            <span className="font-medium">{completionStats.completionPercentage}% Ready</span>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Controls Panel */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-lg shadow-sm border p-6">
              <h2 className="text-lg font-semibold mb-4">Question Generator</h2>
              
              {/* Filter Mode Toggle */}
              <div className="mb-6">
                <div className="flex bg-gray-100 rounded-lg p-1">
                  <button
                    onClick={() => setFilterMode('model')}
                    className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                      filterMode === 'model' 
                        ? 'bg-white text-gray-900 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-900'
                    }`}
                  >
                    Browse by Model
                  </button>
                  <button
                    onClick={() => setFilterMode('curriculum')}
                    className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                      filterMode === 'curriculum' 
                        ? 'bg-white text-gray-900 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-900'
                    }`}
                  >
                    Browse by Curriculum
                  </button>
                </div>
              </div>

              {/* Model-First Filtering */}
              {filterMode === 'model' && (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Mathematical Model
                    </label>
                    <select
                      value={selectedModel}
                      onChange={(e) => setSelectedModel(e.target.value)}
                      className="w-full p-2 border rounded-md bg-white"
                      disabled={loading}
                    >
                      {Object.keys(MODEL_STATUS_REGISTRY).map(modelId => (
                        <option key={modelId} value={modelId} disabled={isModelDisabled(modelId)}>
                          {getModelDisplayName(modelId)} {isModelDisabled(modelId) ? '(Broken)' : ''}
                        </option>
                      ))}
                    </select>
                    <div className="mt-2 flex items-center gap-2">
                      {getModelStatusBadge(selectedModel)}
                      {MODEL_STATUS_REGISTRY[selectedModel]?.knownIssues && (
                        <span className="text-xs text-gray-500">
                          Known issues: {MODEL_STATUS_REGISTRY[selectedModel]?.knownIssues?.length}
                        </span>
                      )}
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Year Level
                    </label>
                    <select
                      value={selectedYear}
                      onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                      className="w-full p-2 border rounded-md bg-white"
                      disabled={loading}
                    >
                      {YEARS.filter(year => 
                        MODEL_STATUS_REGISTRY[selectedModel]?.supportedYears.includes(year)
                      ).map(year => (
                        <option key={year} value={year}>Year {year}</option>
                      ))}
                    </select>
                  </div>

                  {/* Enhanced Difficulty Toggle */}
                  <div>
                    <label className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        checked={useEnhancedDifficulty && ENHANCED_MODELS.includes(selectedModel)}
                        onChange={(e) => setUseEnhancedDifficulty(e.target.checked)}
                        disabled={!ENHANCED_MODELS.includes(selectedModel) || loading}
                        className="rounded border-gray-300"
                      />
                      <span className="text-sm font-medium text-gray-700">
                        Use Enhanced Difficulty System
                        {ENHANCED_MODELS.includes(selectedModel) ? (
                          <span className="ml-1 text-green-600">â Available</span>
                        ) : (
                          <span className="ml-1 text-gray-400">(Not available for this model)</span>
                        )}
                      </span>
                    </label>
                  </div>

                  {/* Sub-Level Selection */}
                  {useEnhancedDifficulty && ENHANCED_MODELS.includes(selectedModel) && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Sub-Level (Fine-Grained Difficulty)
                      </label>
                      <select
                        value={selectedSubLevel}
                        onChange={(e) => setSelectedSubLevel(parseInt(e.target.value))}
                        className="w-full p-2 border rounded-md bg-white"
                        disabled={loading}
                      >
                        {SUB_LEVELS.map(subLevel => (
                          <option key={subLevel} value={subLevel}>
                            {selectedYear}.{subLevel} - {
                              subLevel === 1 ? 'Introductory' :
                              subLevel === 2 ? 'Developing' :
                              subLevel === 3 ? 'Standard' :
                              'Advanced'
                            }
                          </option>
                        ))}
                      </select>
                      <p className="text-xs text-gray-500 mt-1">
                        Current level: {selectedYear}.{selectedSubLevel} - Maximum 50% difficulty increases between levels
                      </p>
                    </div>
                  )}

                  {/* Adaptive Mode Controls */}
                  {useEnhancedDifficulty && ENHANCED_MODELS.includes(selectedModel) && (
                    <div className="space-y-2 p-3 bg-blue-50 rounded-md">
                      <h4 className="text-sm font-medium text-blue-900">Adaptive Learning Options</h4>
                      
                      <label className="flex items-center space-x-2">
                        <input
                          type="checkbox"
                          checked={adaptiveMode}
                          onChange={(e) => setAdaptiveMode(e.target.checked)}
                          disabled={loading}
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-blue-800">
                          Adaptive Mode - Auto-adjust difficulty based on performance
                        </span>
                      </label>

                      <label className="flex items-center space-x-2">
                        <input
                          type="checkbox"
                          checked={confidenceMode}
                          onChange={(e) => setConfidenceMode(e.target.checked)}
                          disabled={loading}
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-blue-800">
                          Confidence Mode - Lock difficulty until 80% accuracy achieved
                        </span>
                      </label>

                      <p className="text-xs text-blue-600">
                        Session ID: {sessionId.slice(-8)}...
                      </p>
                    </div>
                  )}

                  {MODEL_STATUS_REGISTRY[selectedModel] && (
                    <div className="mt-4 p-3 bg-gray-50 rounded-md text-sm">
                      <p className="font-medium">{MODEL_STATUS_REGISTRY[selectedModel].name}</p>
                      <p className="text-gray-600 mt-1">{MODEL_STATUS_REGISTRY[selectedModel].description}</p>
                      <p className="text-xs text-gray-500 mt-2">
                        Curriculum areas: {MODEL_STATUS_REGISTRY[selectedModel].curriculumAreas.join(', ')}
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* Curriculum-First Filtering */}
              {filterMode === 'curriculum' && (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Curriculum Strand
                    </label>
                    <select
                      value={selectedStrand}
                      onChange={(e) => setSelectedStrand(e.target.value)}
                      className="w-full p-2 border rounded-md bg-white"
                      disabled={loading}
                    >
                      {strands.map((strand, index) => (
                        <option key={`strand-${index}-${strand}`} value={strand}>{strand}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Substrand
                    </label>
                    <select
                      value={selectedSubstrand}
                      onChange={(e) => setSelectedSubstrand(e.target.value)}
                      className="w-full p-2 border rounded-md bg-white"
                      disabled={loading}
                    >
                      {substrands.map((substrand, index) => (
                        <option key={`substrand-${index}-${substrand}`} value={substrand}>{substrand}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Year Level
                    </label>
                    <select
                      value={selectedCurriculumYear}
                      onChange={(e) => setSelectedCurriculumYear(parseInt(e.target.value))}
                      className="w-full p-2 border rounded-md bg-white"
                      disabled={loading}
                    >
                      {availableYears.map((year, index) => (
                        <option key={`year-${index}-${year}`} value={year}>Year {year}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Sub-Level (if supported)
                    </label>
                    <select
                      value={selectedCurriculumSubLevel}
                      onChange={(e) => setSelectedCurriculumSubLevel(parseInt(e.target.value))}
                      className="w-full p-2 border rounded-md bg-white"
                      disabled={loading}
                    >
                      {SUB_LEVELS.map(subLevel => (
                        <option key={subLevel} value={subLevel}>
                          {selectedCurriculumYear}.{subLevel} - {
                            subLevel === 1 ? 'Introductory' :
                            subLevel === 2 ? 'Developing' :
                            subLevel === 3 ? 'Standard' :
                            'Advanced'
                          }
                        </option>
                      ))}
                    </select>
                  </div>

                  {curriculumFilter && (
                    <div className="mt-4 p-3 bg-blue-50 rounded-md text-sm">
                      <p className="font-medium text-blue-900">UK Curriculum Requirement</p>
                      <p className="text-blue-800 mt-1">{curriculumFilter.description}</p>
                      <p className="text-xs text-blue-600 mt-2">
                        Reference: {curriculumFilter.contentDomainRef}
                      </p>
                    </div>
                  )}

                  {suggestedModels.length > 0 && (
                    <div className="mt-4">
                      <p className="text-sm font-medium text-gray-700 mb-2">Suggested Models</p>
                      <div className="flex flex-wrap gap-1">
                        {suggestedModels.map(modelId => (
                          <button
                            key={modelId}
                            onClick={() => generateQuestion(modelId, selectedCurriculumYear, selectedCurriculumSubLevel)}
                            disabled={loading || isModelDisabled(modelId)}
                            className={`px-2 py-1 text-xs rounded-md border flex items-center gap-1 ${
                              isModelDisabled(modelId)
                                ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                : 'bg-white text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            {getModelDisplayName(modelId)}
                            {getModelStatusBadge(modelId)}
                            {ENHANCED_MODELS.includes(modelId) && (
                              <span className="text-green-600 text-xs">â¨</span>
                            )}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Quantity Selector */}
              <div className="mt-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Number of Questions
                </label>
                <select
                  value={quantity}
                  onChange={(e) => setQuantity(parseInt(e.target.value))}
                  className="w-full p-2 border rounded-md bg-white"
                  disabled={loading}
                >
                  {[1, 2, 3, 5, 10, 15, 20].map(num => (
                    <option key={num} value={num}>
                      {num} question{num > 1 ? 's' : ''}
                    </option>
                  ))}
                </select>
                <p className="text-xs text-gray-500 mt-1">
                  {quantity === 1 ? 'Single question mode' : `Batch generation mode - ${quantity} questions`}
                </p>
              </div>

              {/* Generate Button */}
              <button
                onClick={() => generateQuestion()}
                disabled={loading || (filterMode === 'curriculum' && suggestedModels.length === 0) || (filterMode === 'model' && isModelDisabled(selectedModel))}
                className="w-full mt-6 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                {loading ? 'Generating...' : (quantity === 1 ? 'Generate Question' : `Generate ${quantity} Questions`)}
              </button>
            </div>
          </div>

          {/* Question Display */}
          <div className="lg:col-span-2">
            <div className="bg-white rounded-lg shadow-sm border p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold">
                  {showBatchView ? `Generated Questions (${generatedQuestions.length})` : 'Generated Question'}
                </h2>
                {showBatchView && generatedQuestions.length > 0 && (
                  <div className="flex gap-2">
                    <button
                      onClick={downloadAsJSON}
                      className="px-3 py-1 bg-gray-600 text-white text-sm rounded-md hover:bg-gray-700"
                    >
                      Export JSON
                    </button>
                    <button
                      onClick={downloadAsCSV}
                      className="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700"
                    >
                      Export CSV
                    </button>
                  </div>
                )}
              </div>

              {error && (
                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700">
                  {error}
                </div>
              )}

              {generatedQuestion && (
                <div>
                  <div className="mb-4 p-4 bg-gray-50 rounded-md">
                    <p className="text-lg font-medium">{generatedQuestion.question}</p>
                  </div>

                  <div className="flex items-center justify-between mb-4">
                    <button
                      onClick={() => setShowAnswer(showAnswer !== null ? null : 0)}
                      className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
                    >
                      {showAnswer !== null ? 'Hide Answer' : 'Show Answer'}
                    </button>
                    
                    <div className="text-sm text-gray-500">
                      Model: {generatedQuestion.metadata.model_id} |
                      {generatedQuestion.metadata.sub_level ? (
                        <>
                          <span className="text-green-600 font-medium"> Level: {generatedQuestion.metadata.sub_level}</span>
                          {generatedQuestion.metadata.enhanced_system_used && (
                            <span className="ml-1">
                              {getEnhancementStatusBadge(generatedQuestion.metadata)}
                            </span>
                          )}
                        </>
                      ) : (
                        <span> Year: {generatedQuestion.metadata.year_level}</span>
                      )}
                      {generatedQuestion.metadata.session_id && (
                        <span className="ml-2 text-blue-600">Session: {generatedQuestion.metadata.session_id.slice(-6)}</span>
                      )}
                    </div>
                  </div>

                  {showAnswer !== null && (
                    <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-md">
                      <p className="text-lg font-semibold text-green-800">
                        Answer: {generatedQuestion.answer}
                      </p>
                    </div>
                  )}

                  <details className="mt-4">
                    <summary className="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900">
                      Technical Details
                    </summary>
                    <pre className="mt-2 text-xs bg-gray-100 p-3 rounded-md overflow-auto">
                      {JSON.stringify(generatedQuestion, null, 2)}
                    </pre>
                  </details>
                </div>
              )}

              {/* Batch Questions Display */}
              {showBatchView && generatedQuestions.length > 0 && (
                <div>
                  {/* Batch Statistics */}
                  {batchMetadata && (
                    <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                      <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                        <div>
                          <span className="font-medium text-blue-900">Total Questions:</span>
                          <p className="text-blue-800">{batchMetadata.quantity}</p>
                        </div>
                        <div>
                          <span className="font-medium text-blue-900">Generation Time:</span>
                          <p className="text-blue-800">{batchMetadata.total_generation_time_ms}ms</p>
                        </div>
                        <div>
                          <span className="font-medium text-blue-900">Average per Question:</span>
                          <p className="text-blue-800">{Math.round(batchMetadata.average_generation_time_ms)}ms</p>
                        </div>
                        <div>
                          <span className="font-medium text-blue-900">Model:</span>
                          <p className="text-blue-800">{batchMetadata.model_id}</p>
                        </div>
                        <div>
                          <span className="font-medium text-blue-900">Enhancement:</span>
                          <div className="mt-1">
                            {batchMetadata.enhanced_system_used && getEnhancementStatusBadge(batchMetadata)}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Questions Grid */}
                  <div className="space-y-4">
                    {generatedQuestions.map((question, index) => (
                      <div key={index} className="border border-gray-200 rounded-lg p-4">
                        <div className="flex items-start justify-between mb-2">
                          <span className="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">
                            Question {index + 1}
                          </span>
                          <button
                            onClick={() => setShowAnswer(showAnswer === index ? null : index)}
                            className="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700"
                          >
                            {showAnswer === index ? 'Hide Answer' : 'Show Answer'}
                          </button>
                        </div>

                        <div className="mb-3 p-3 bg-gray-50 rounded-md">
                          <p className="text-gray-900 font-medium">{question.question}</p>
                        </div>

                        {showAnswer === index && (
                          <div className="mb-3 p-3 bg-green-50 border border-green-200 rounded-md">
                            <p className="text-green-800 font-semibold">
                              Answer: {question.answer}
                            </p>
                          </div>
                        )}

                        <div className="text-xs text-gray-500 flex items-center gap-2">
                          {question.metadata.sub_level ? (
                            <span className="text-green-600 font-medium">Level: {question.metadata.sub_level}</span>
                          ) : (
                            <span>Year: {question.metadata.year_level}</span>
                          )}
                          {question.metadata.enhanced_system_used && getEnhancementStatusBadge(question.metadata)}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {!generatedQuestion && !showBatchView && !loading && !error && (
                <div className="text-center py-12 text-gray-500">
                  <p>Select your preferences above and click "Generate Question" to start.</p>
                </div>
              )}

              {loading && (
                <div className="text-center py-12">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                  <p className="mt-2 text-gray-500">Generating your question...</p>
                </div>
              )}
            </div>

            {/* Question History */}
            {questionHistory.length > 0 && (
              <div className="mt-6 bg-white rounded-lg shadow-sm border p-6">
                <h3 className="text-lg font-semibold mb-4">Recent Questions</h3>
                <div className="space-y-3">
                  {questionHistory.slice(0, 5).map((q, index) => (
                    <div key={index} className="p-3 bg-gray-50 rounded-md">
                      <p className="text-sm">{q.question}</p>
                      <div className="mt-1 text-xs text-gray-500 flex items-center gap-2">
                        <span>{q.metadata.model_id}</span>
                        {q.metadata.sub_level ? (
                          <span className="text-green-600 font-medium">Level {q.metadata.sub_level}</span>
                        ) : (
                          <span>Year {q.metadata.year_level}</span>
                        )}
                        {q.metadata.enhanced_system_used && getEnhancementStatusBadge(q.metadata)}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
```
--- END FILE: app\test\page.tsx ---

--- START FILE: components\curriculum-coverage.tsx ---
```typescript
'use client';

import { useState } from 'react';
import { GeneratedQuestion } from '@/lib/types';

interface GenerationCombination {
  strand: string;
  substrand: string;
  year: number;
  subLevel: number;
  suggestedModels: string[];
  primaryModel: string;
  questionsGenerated: number;
  status: 'pending' | 'generating' | 'completed' | 'error';
  questions?: GeneratedQuestion[];
  error?: string;
}

interface BulkGenerationConfig {
  selectedStrands: string[];
  selectedSubstrands: string[];
  selectedYears: number[];
  selectedSubLevels: number[];
  questionsPerCombination: number;
  useEnhancedDifficulty: boolean;
}

interface CurriculumCoverageProps {
  combinations: GenerationCombination[];
  config: BulkGenerationConfig;
}

type ViewMode = 'grid' | 'table' | 'hierarchy';
type FilterMode = 'all' | 'completed' | 'error' | 'pending';

export function CurriculumCoverage({ combinations, config }: CurriculumCoverageProps) {
  const [viewMode, setViewMode] = useState<ViewMode>('table');
  const [filterMode, setFilterMode] = useState<FilterMode>('all');
  const [selectedStrand, setSelectedStrand] = useState<string>('');
  const [expandedCombination, setExpandedCombination] = useState<string | null>(null);
  const [showQuestions, setShowQuestions] = useState<{ [key: string]: boolean }>({});

  // Filter combinations based on current filter mode
  const filteredCombinations = combinations.filter(combo => {
    if (filterMode === 'all') return true;
    return combo.status === filterMode;
  }).filter(combo => {
    if (!selectedStrand) return true;
    return combo.strand === selectedStrand;
  });

  // Group combinations by strand for hierarchy view
  const groupedByStrand = filteredCombinations.reduce((acc, combo) => {
    if (!acc[combo.strand]) {
      acc[combo.strand] = {};
    }
    if (!acc[combo.strand][combo.substrand]) {
      acc[combo.strand][combo.substrand] = [];
    }
    acc[combo.strand][combo.substrand].push(combo);
    return acc;
  }, {} as { [strand: string]: { [substrand: string]: GenerationCombination[] } });

  // Get unique strands for filtering
  const uniqueStrands = [...new Set(combinations.map(c => c.strand))].sort();

  // Statistics
  const stats = {
    total: combinations.length,
    completed: combinations.filter(c => c.status === 'completed').length,
    error: combinations.filter(c => c.status === 'error').length,
    pending: combinations.filter(c => c.status === 'pending').length,
    totalQuestions: combinations.reduce((sum, c) => sum + c.questionsGenerated, 0)
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800 border-green-200';
      case 'error': return 'bg-red-100 text-red-800 border-red-200';
      case 'generating': return 'bg-blue-100 text-blue-800 border-blue-200';
      default: return 'bg-gray-100 text-gray-800 border-gray-200';
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'completed': return 'â';
      case 'error': return 'â';
      case 'generating': return 'â³';
      default: return 'â¸ï¸';
    }
  };

  const toggleQuestions = (comboKey: string) => {
    setShowQuestions(prev => ({
      ...prev,
      [comboKey]: !prev[comboKey]
    }));
  };

  const getCombinationKey = (combo: GenerationCombination) => {
    return `${combo.strand}-${combo.substrand}-${combo.year}-${combo.subLevel}`;
  };

  return (
    <div className="bg-white rounded-lg shadow-sm border">
      {/* Header with controls */}
      <div className="p-6 border-b border-gray-200">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-900">Curriculum Coverage</h3>

          {/* View mode selector */}
          <div className="flex bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => setViewMode('table')}
              className={`px-3 py-1 rounded-md text-sm font-medium transition-colors ${
                viewMode === 'table'
                  ? 'bg-white text-gray-900 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Table
            </button>
            <button
              onClick={() => setViewMode('grid')}
              className={`px-3 py-1 rounded-md text-sm font-medium transition-colors ${
                viewMode === 'grid'
                  ? 'bg-white text-gray-900 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Grid
            </button>
            <button
              onClick={() => setViewMode('hierarchy')}
              className={`px-3 py-1 rounded-md text-sm font-medium transition-colors ${
                viewMode === 'hierarchy'
                  ? 'bg-white text-gray-900 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Hierarchy
            </button>
          </div>
        </div>

        {/* Statistics */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
          <div className="text-center">
            <div className="text-2xl font-bold text-gray-900">{stats.total}</div>
            <div className="text-sm text-gray-600">Total</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-green-600">{stats.completed}</div>
            <div className="text-sm text-gray-600">Completed</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-red-600">{stats.error}</div>
            <div className="text-sm text-gray-600">Errors</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-gray-600">{stats.pending}</div>
            <div className="text-sm text-gray-600">Pending</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-blue-600">{stats.totalQuestions}</div>
            <div className="text-sm text-gray-600">Questions</div>
          </div>
        </div>

        {/* Filters */}
        <div className="flex flex-wrap gap-4">
          {/* Status filter */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
            <select
              value={filterMode}
              onChange={(e) => setFilterMode(e.target.value as FilterMode)}
              className="px-3 py-1 border rounded-md text-sm bg-white"
            >
              <option value="all">All ({stats.total})</option>
              <option value="completed">Completed ({stats.completed})</option>
              <option value="error">Errors ({stats.error})</option>
              <option value="pending">Pending ({stats.pending})</option>
            </select>
          </div>

          {/* Strand filter */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Strand</label>
            <select
              value={selectedStrand}
              onChange={(e) => setSelectedStrand(e.target.value)}
              className="px-3 py-1 border rounded-md text-sm bg-white"
            >
              <option value="">All Strands</option>
              {uniqueStrands.map(strand => (
                <option key={strand} value={strand}>{strand}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {/* Content based on view mode */}
      <div className="p-6">
        {viewMode === 'table' && (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Status
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Strand
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Substrand
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Level
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Model
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Questions
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {filteredCombinations.map((combo) => {
                  const comboKey = getCombinationKey(combo);
                  return (
                    <tr key={comboKey} className="hover:bg-gray-50">
                      <td className="px-4 py-3 whitespace-nowrap">
                        <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(combo.status)}`}>
                          {getStatusIcon(combo.status)} {combo.status}
                        </span>
                      </td>
                      <td className="px-4 py-3">
                        <div className="text-sm font-medium text-gray-900 max-w-xs truncate" title={combo.strand}>
                          {combo.strand}
                        </div>
                      </td>
                      <td className="px-4 py-3">
                        <div className="text-sm text-gray-900 max-w-xs truncate" title={combo.substrand}>
                          {combo.substrand}
                        </div>
                      </td>
                      <td className="px-4 py-3 whitespace-nowrap">
                        <div className="text-sm text-gray-900">
                          Year {combo.year}.{combo.subLevel}
                        </div>
                      </td>
                      <td className="px-4 py-3 whitespace-nowrap">
                        <div className="text-sm text-gray-900">{combo.primaryModel}</div>
                      </td>
                      <td className="px-4 py-3 whitespace-nowrap">
                        <div className="text-sm text-gray-900">{combo.questionsGenerated}</div>
                      </td>
                      <td className="px-4 py-3 whitespace-nowrap">
                        {combo.questions && combo.questions.length > 0 && (
                          <button
                            onClick={() => toggleQuestions(comboKey)}
                            className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"
                          >
                            {showQuestions[comboKey] ? 'Hide' : 'Show'} Questions
                          </button>
                        )}
                        {combo.error && (
                          <div className="text-xs text-red-600 mt-1" title={combo.error}>
                            Error: {combo.error.substring(0, 50)}...
                          </div>
                        )}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}

        {viewMode === 'grid' && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredCombinations.map((combo) => {
              const comboKey = getCombinationKey(combo);
              return (
                <div key={comboKey} className={`border rounded-lg p-4 ${getStatusColor(combo.status).replace('text-', 'border-').replace('bg-', 'bg-opacity-20 bg-')}`}>
                  <div className="flex items-center justify-between mb-2">
                    <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(combo.status)}`}>
                      {getStatusIcon(combo.status)} {combo.status}
                    </span>
                    <span className="text-sm font-medium text-gray-600">
                      Year {combo.year}.{combo.subLevel}
                    </span>
                  </div>

                  <h4 className="font-medium text-gray-900 mb-1 truncate" title={combo.strand}>
                    {combo.strand}
                  </h4>
                  <p className="text-sm text-gray-600 mb-2 truncate" title={combo.substrand}>
                    {combo.substrand}
                  </p>

                  <div className="flex items-center justify-between text-xs text-gray-500">
                    <span>{combo.primaryModel}</span>
                    <span>{combo.questionsGenerated} questions</span>
                  </div>

                  {combo.questions && combo.questions.length > 0 && (
                    <button
                      onClick={() => toggleQuestions(comboKey)}
                      className="w-full mt-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"
                    >
                      {showQuestions[comboKey] ? 'Hide' : 'Show'} Questions
                    </button>
                  )}

                  {combo.error && (
                    <div className="mt-2 text-xs text-red-600 p-2 bg-red-50 rounded" title={combo.error}>
                      Error: {combo.error.substring(0, 100)}...
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {viewMode === 'hierarchy' && (
          <div className="space-y-6">
            {Object.entries(groupedByStrand).map(([strand, substrands]) => (
              <div key={strand} className="border rounded-lg">
                <div className="bg-gray-50 px-4 py-3 border-b">
                  <h4 className="font-medium text-gray-900">{strand}</h4>
                  <p className="text-sm text-gray-600">
                    {Object.values(substrands).flat().length} combinations
                  </p>
                </div>

                <div className="p-4 space-y-4">
                  {Object.entries(substrands).map(([substrand, combos]) => (
                    <div key={substrand} className="border-l-4 border-gray-200 pl-4">
                      <h5 className="font-medium text-gray-800 mb-2">{substrand}</h5>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {combos.map((combo) => {
                          const comboKey = getCombinationKey(combo);
                          return (
                            <div key={comboKey} className="bg-gray-50 rounded p-3">
                              <div className="flex items-center justify-between mb-1">
                                <span className="text-sm font-medium">Year {combo.year}.{combo.subLevel}</span>
                                <span className={`inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(combo.status)}`}>
                                  {getStatusIcon(combo.status)}
                                </span>
                              </div>
                              <div className="text-xs text-gray-600 mb-1">{combo.primaryModel}</div>
                              <div className="text-xs text-gray-500">{combo.questionsGenerated} questions</div>

                              {combo.questions && combo.questions.length > 0 && (
                                <button
                                  onClick={() => toggleQuestions(comboKey)}
                                  className="w-full mt-1 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"
                                >
                                  {showQuestions[comboKey] ? 'Hide' : 'Show'}
                                </button>
                              )}

                              {combo.error && (
                                <div className="mt-1 text-xs text-red-600" title={combo.error}>
                                  Error occurred
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Question details modal/expansion */}
        {Object.entries(showQuestions).map(([comboKey, isShown]) => {
          if (!isShown) return null;

          const combo = combinations.find(c => getCombinationKey(c) === comboKey);
          if (!combo || !combo.questions) return null;

          return (
            <div key={comboKey} className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
                <div className="bg-gray-50 px-6 py-4 border-b">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">Generated Questions</h3>
                      <p className="text-sm text-gray-600">
                        {combo.strand} â {combo.substrand} (Year {combo.year}.{combo.subLevel})
                      </p>
                    </div>
                    <button
                      onClick={() => toggleQuestions(comboKey)}
                      className="text-gray-400 hover:text-gray-600"
                    >
                      â
                    </button>
                  </div>
                </div>

                <div className="p-6 overflow-y-auto max-h-[60vh]">
                  <div className="space-y-4">
                    {combo.questions.map((question, index) => (
                      <div key={index} className="border rounded-lg p-4">
                        <div className="flex items-start justify-between mb-2">
                          <span className="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">
                            Question {index + 1}
                          </span>
                          <span className="text-xs text-gray-500">
                            {combo.primaryModel}
                          </span>
                        </div>

                        <div className="mb-3">
                          <p className="text-gray-900 font-medium">{question.question}</p>
                        </div>

                        <div className="bg-green-50 border border-green-200 rounded p-3">
                          <p className="text-green-800 font-semibold">
                            Answer: {question.answer}
                          </p>
                        </div>

                        <div className="mt-3 space-y-2">
                          <details>
                            <summary className="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                              Generation Setup Details
                            </summary>
                            <div className="mt-2">
                              {question.generation_setup ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs bg-blue-50 p-3 rounded">
                                  <div>
                                    <div className="font-medium text-blue-800 mb-2">Controller & Format</div>
                                    <div className="space-y-1 text-blue-700">
                                      <div><span className="font-medium">Controller:</span> {question.generation_setup.controller_used}</div>
                                      <div><span className="font-medium">Format Requested:</span> {question.generation_setup.format_requested}</div>
                                      <div><span className="font-medium">Format Used:</span> {question.generation_setup.format_actual}</div>
                                      {question.generation_setup.format_selection_reason && (
                                        <div><span className="font-medium">Selection Reason:</span> {question.generation_setup.format_selection_reason}</div>
                                      )}
                                    </div>
                                  </div>
                                  <div>
                                    <div className="font-medium text-blue-800 mb-2">Scenario & Theme</div>
                                    <div className="space-y-1 text-blue-700">
                                      <div><span className="font-medium">Theme:</span> {question.generation_setup.scenario_theme}</div>
                                      <div><span className="font-medium">Scenario ID:</span> {question.generation_setup.scenario_id}</div>
                                      <div><span className="font-medium">Selection Method:</span> {question.generation_setup.scenario_selection_method}</div>
                                    </div>
                                  </div>
                                  <div>
                                    <div className="font-medium text-blue-800 mb-2">Distractors</div>
                                    <div className="space-y-1 text-blue-700">
                                      <div><span className="font-medium">Count:</span> {question.generation_setup.distractor_count}</div>
                                      <div><span className="font-medium">Strategies:</span> {question.generation_setup.distractor_strategies.join(', ') || 'None'}</div>
                                    </div>
                                  </div>
                                  <div>
                                    <div className="font-medium text-blue-800 mb-2">System Settings</div>
                                    <div className="space-y-1 text-blue-700">
                                      <div><span className="font-medium">Enhancement Level:</span> {question.generation_setup.enhancement_level}</div>
                                      <div><span className="font-medium">Format Variety:</span> {question.generation_setup.format_variety ? 'Yes' : 'No'}</div>
                                      <div><span className="font-medium">Theme Variety:</span> {question.generation_setup.theme_variety ? 'Yes' : 'No'}</div>
                                      <div><span className="font-medium">Generation Time:</span> {question.generation_setup.generation_time_ms}ms</div>
                                    </div>
                                  </div>
                                </div>
                              ) : (
                                <div className="text-xs text-gray-500 italic bg-gray-50 p-3 rounded">
                                  No generation setup details available (generated with older version)
                                </div>
                              )}
                            </div>
                          </details>

                          <details>
                            <summary className="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                              Technical Details
                            </summary>
                            <pre className="mt-2 text-xs bg-gray-100 p-3 rounded overflow-auto">
                              {JSON.stringify(question.math_output, null, 2)}
                            </pre>
                          </details>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          );
        })}

        {filteredCombinations.length === 0 && (
          <div className="text-center py-12 text-gray-500">
            <p>No combinations match the current filters.</p>
          </div>
        )}
      </div>
    </div>
  );
}
```
--- END FILE: components\curriculum-coverage.tsx ---

--- START FILE: components\ui\badge.tsx ---
```typescript
import * as React from "react"

function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement> {
  variant?: "default" | "secondary" | "destructive" | "outline"
}

function Badge({ className, variant = "default", ...props }: BadgeProps) {
  const baseClasses = "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"

  const variants = {
    default: "border-transparent bg-blue-600 text-white hover:bg-blue-700",
    secondary: "border-transparent bg-gray-100 text-gray-900 hover:bg-gray-200",
    destructive: "border-transparent bg-red-600 text-white hover:bg-red-700",
    outline: "text-foreground border-gray-300 bg-white"
  }

  return (
    <div className={cn(baseClasses, variants[variant], className)} {...props} />
  )
}

export { Badge }
```
--- END FILE: components\ui\badge.tsx ---

--- START FILE: components\ui\button.tsx ---
```typescript
import * as React from "react"

function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: "default" | "destructive" | "outline" | "secondary" | "ghost" | "link"
  size?: "default" | "sm" | "lg" | "icon"
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant = "default", size = "default", ...props }, ref) => {
    const baseClasses = "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"

    const variants = {
      default: "bg-blue-600 text-white hover:bg-blue-700",
      destructive: "bg-red-600 text-white hover:bg-red-700",
      outline: "border border-gray-300 bg-white hover:bg-gray-50 hover:text-gray-900",
      secondary: "bg-gray-100 text-gray-900 hover:bg-gray-200",
      ghost: "hover:bg-gray-100 hover:text-gray-900",
      link: "text-blue-600 underline-offset-4 hover:underline"
    }

    const sizes = {
      default: "h-10 px-4 py-2",
      sm: "h-9 rounded-md px-3",
      lg: "h-11 rounded-md px-8",
      icon: "h-10 w-10"
    }

    return (
      <button
        className={cn(
          baseClasses,
          variants[variant],
          sizes[size],
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button }
```
--- END FILE: components\ui\button.tsx ---

--- START FILE: components\ui\card.tsx ---
```typescript
import * as React from "react"

function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-white text-gray-900 shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-gray-600", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
```
--- END FILE: components\ui\card.tsx ---

--- START FILE: components\ui\input.tsx ---
```typescript
import * as React from "react"

function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {
  placeholder?: string
}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
```
--- END FILE: components\ui\input.tsx ---

--- START FILE: components\ui\progress.tsx ---
```typescript
import * as React from "react"

function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

export interface ProgressProps
  extends React.HTMLAttributes<HTMLDivElement> {
  value?: number
  max?: number
}

const Progress = React.forwardRef<HTMLDivElement, ProgressProps>(
  ({ className, value, max = 100, ...props }, ref) => (
    <div
      ref={ref}
      className={cn(
        "relative h-4 w-full overflow-hidden rounded-full bg-gray-200",
        className
      )}
      {...props}
    >
      <div
        className="h-full w-full flex-1 bg-blue-600 transition-all"
        style={{ transform: `translateX(-${100 - Math.max(0, Math.min(100, ((value || 0) / max) * 100))}%)` }}
      />
    </div>
  )
)
Progress.displayName = "Progress"

export { Progress }
```
--- END FILE: components\ui\progress.tsx ---

--- START FILE: components\ui\select.tsx ---
```typescript
import * as React from "react"

function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

interface SelectProps {
  value: string
  onValueChange: (value: string) => void
  children: React.ReactNode
}

interface SelectTriggerProps {
  className?: string
  children: React.ReactNode
  disabled?: boolean
}

interface SelectValueProps {
  placeholder?: string
}

interface SelectContentProps {
  children: React.ReactNode
}

interface SelectItemProps {
  value: string
  children: React.ReactNode
}

const SelectContext = React.createContext<{
  value: string
  onValueChange: (value: string) => void
  isOpen: boolean
  setIsOpen: (open: boolean) => void
} | null>(null)

const Select: React.FC<SelectProps> = ({ value, onValueChange, children }) => {
  const [isOpen, setIsOpen] = React.useState(false)

  return (
    <SelectContext.Provider value={{ value, onValueChange, isOpen, setIsOpen }}>
      <div className="relative">
        {children}
      </div>
    </SelectContext.Provider>
  )
}

const SelectTrigger: React.FC<SelectTriggerProps> = ({ className, children, disabled }) => {
  const context = React.useContext(SelectContext)
  if (!context) throw new Error('SelectTrigger must be used within Select')

  return (
    <button
      type="button"
      className={cn(
        "flex h-10 w-full items-center justify-between rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      disabled={disabled}
      onClick={() => context.setIsOpen(!context.isOpen)}
    >
      {children}
      <svg
        className="h-4 w-4 opacity-50"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </button>
  )
}

const SelectValue: React.FC<SelectValueProps> = ({ placeholder }) => {
  const context = React.useContext(SelectContext)
  if (!context) throw new Error('SelectValue must be used within Select')

  return (
    <span className="block truncate">
      {context.value || placeholder}
    </span>
  )
}

const SelectContent: React.FC<SelectContentProps> = ({ children }) => {
  const context = React.useContext(SelectContext)
  if (!context) throw new Error('SelectContent must be used within Select')

  if (!context.isOpen) return null

  return (
    <div className="absolute top-full left-0 z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
      {children}
    </div>
  )
}

const SelectItem: React.FC<SelectItemProps> = ({ value, children }) => {
  const context = React.useContext(SelectContext)
  if (!context) throw new Error('SelectItem must be used within Select')

  return (
    <button
      type="button"
      className={cn(
        "w-full px-3 py-2 text-sm text-left hover:bg-gray-100 cursor-pointer",
        context.value === value ? "bg-blue-100 text-blue-900" : ""
      )}
      onClick={() => {
        context.onValueChange(value)
        context.setIsOpen(false)
      }}
    >
      {children}
    </button>
  )
}

export { Select, SelectContent, SelectItem, SelectTrigger, SelectValue }
```
--- END FILE: components\ui\select.tsx ---

--- START FILE: components\ui\tabs.tsx ---
```typescript
import * as React from "react"

function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

interface TabsContextValue {
  value: string
  onValueChange: (value: string) => void
}

const TabsContext = React.createContext<TabsContextValue | undefined>(undefined)

interface TabsProps {
  value: string
  onValueChange: (value: string) => void
  className?: string
  children: React.ReactNode
}

const Tabs: React.FC<TabsProps> = ({ value, onValueChange, className, children }) => {
  return (
    <TabsContext.Provider value={{ value, onValueChange }}>
      <div className={cn("w-full", className)}>
        {children}
      </div>
    </TabsContext.Provider>
  )
}

interface TabsListProps {
  className?: string
  children: React.ReactNode
}

const TabsList: React.FC<TabsListProps> = ({ className, children }) => {
  return (
    <div
      className={cn(
        "inline-flex h-10 items-center justify-center rounded-md bg-gray-100 p-1 text-gray-500",
        className
      )}
    >
      {children}
    </div>
  )
}

interface TabsTriggerProps {
  value: string
  className?: string
  children: React.ReactNode
}

const TabsTrigger: React.FC<TabsTriggerProps> = ({ value, className, children }) => {
  const context = React.useContext(TabsContext)
  if (!context) throw new Error('TabsTrigger must be used within Tabs')

  const isActive = context.value === value

  return (
    <button
      type="button"
      className={cn(
        "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
        isActive
          ? "bg-white text-gray-950 shadow-sm"
          : "text-gray-600 hover:text-gray-900",
        className
      )}
      onClick={() => context.onValueChange(value)}
    >
      {children}
    </button>
  )
}

interface TabsContentProps {
  value: string
  className?: string
  children: React.ReactNode
}

const TabsContent: React.FC<TabsContentProps> = ({ value, className, children }) => {
  const context = React.useContext(TabsContext)
  if (!context) throw new Error('TabsContent must be used within Tabs')

  if (context.value !== value) return null

  return (
    <div
      className={cn(
        "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
        className
      )}
    >
      {children}
    </div>
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }
```
--- END FILE: components\ui\tabs.tsx ---

--- START FILE: components\ui\textarea.tsx ---
```typescript
import * as React from "react"

function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

export interface TextareaProps
  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {
  placeholder?: string
}

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[80px] w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-background placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Textarea.displayName = "Textarea"

export { Textarea }
```
--- END FILE: components\ui\textarea.tsx ---

--- START FILE: context\curriculum.ts ---
```typescript
/**
 * Curriculum data utilities and exports
 * Provides structured access to UK National Curriculum data
 */

import { curriculumParser, CurriculumEntry } from '@/lib/curriculum/curriculum-parser';

// Export curriculum parser for detailed access
export { curriculumParser, type CurriculumEntry };

/**
 * Simplified curriculum data structure for UI components
 * Maps strands to their substrands
 */
export const CURRICULUM_DATA: Record<string, Record<string, boolean>> = (() => {
  const data: Record<string, Record<string, boolean>> = {};

  // Get all entries from the parser
  const entries = curriculumParser.getAllEntries();

  entries.forEach(entry => {
    if (!data[entry.Strand]) {
      data[entry.Strand] = {};
    }
    data[entry.Strand][entry.Substrand] = true;
  });

  return data;
})();

/**
 * Get all strands from curriculum data
 */
export const getCurriculumStrands = (): string[] => {
  return Object.keys(CURRICULUM_DATA).sort();
};

/**
 * Get all substrands for a specific strand
 */
export const getCurriculumSubstrands = (strand: string): string[] => {
  return Object.keys(CURRICULUM_DATA[strand] || {}).sort();
};

/**
 * Get all strand-substrand combinations
 */
export const getAllCurriculumCombinations = (): Array<{ strand: string; substrand: string }> => {
  const combinations: Array<{ strand: string; substrand: string }> = [];

  Object.keys(CURRICULUM_DATA).forEach(strand => {
    Object.keys(CURRICULUM_DATA[strand]).forEach(substrand => {
      combinations.push({ strand, substrand });
    });
  });

  return combinations.sort((a, b) => {
    if (a.strand !== b.strand) {
      return a.strand.localeCompare(b.strand);
    }
    return a.substrand.localeCompare(b.substrand);
  });
};

/**
 * Check if a strand-substrand combination exists
 */
export const isValidCurriculumCombination = (strand: string, substrand: string): boolean => {
  return CURRICULUM_DATA[strand]?.[substrand] || false;
};

/**
 * Get curriculum description for a specific combination and year
 */
export const getCurriculumDescription = (strand: string, substrand: string, year: number): string | null => {
  const filter = curriculumParser.getCurriculumDescription(strand, substrand, year);
  return filter?.description || null;
};

/**
 * Get available years for a strand-substrand combination
 */
export const getAvailableYears = (strand: string, substrand: string): number[] => {
  return curriculumParser.getAvailableYears(strand, substrand);
};

/**
 * Search curriculum by keyword
 */
export const searchCurriculum = (searchTerm: string) => {
  return curriculumParser.searchCurriculum(searchTerm);
};

// Export default for convenience
export default {
  CURRICULUM_DATA,
  getCurriculumStrands,
  getCurriculumSubstrands,
  getAllCurriculumCombinations,
  isValidCurriculumCombination,
  getCurriculumDescription,
  getAvailableYears,
  searchCurriculum,
  curriculumParser
};
```
--- END FILE: context\curriculum.ts ---

--- START FILE: context\example_questions.json ---
```json
{
  "compare_describe_and_order_measures": {
    "Year 1": [
      "Which is longer, a pencil or a classroom table?",
      "Which is heavier, a book or a feather?",
      "If you have a full glass of water and an empty glass of water, which has more?",
      "Who is taller, you or your teacher?",
      "Which animal is slower, a snail or a cheetah?",
      "Which is shorter, your finger or your leg?",
      "Hold a crayon in one hand and a bottle of water in the other. Which one is lighter?",
      "Look at two plant pots. Which one do you think can hold more soil?",
      "Which takes longer to do: brushing your teeth or eating your dinner?",
      "Is a giraffe taller or shorter than a cat?",
      "Which is heavier, a school bag full of books or an empty school bag?",
      "If you pour all the water from a small cup into a large bucket, which will look fuller?",
      "Is it quicker to walk to the end of the corridor or to hop?",
      "Which is longer, a car or a bus?",
      "Which is lighter, a balloon or an apple?",
      "Compare your lunchbox to a friend's. Which one is bigger?",
      "Who is the tallest person in your class? Who is the shortest?",
      "Order three friends by height, from shortest to tallest.",
      "Which is heavier, a potato or a bag of potatoes?",
      "Does a teaspoon hold more or less liquid than a mug?",
      "Which is faster, a running person or a person walking?",
      "Is a lamppost taller or shorter than a house?",
      "Put these in order of length, from shortest to longest: a paperclip, a pencil, a whiteboard.",
      "Which holds more water, a bathtub or a swimming pool?",
      "Which would take less time, singing a song or watching a film?",
      "Which container holds less: a water bottle or a paddling pool?",
      "Is a ruler longer or shorter than your arm?",
      "Which is heavier: a single grape or a bunch of grapes?",
      "Does it take a longer time to draw a picture or to write your name?",
      "Who is shorter: you or a baby?",
      "Which is lighter: a chair or a table?",
      "Does a bucket hold more or less than a teacup?",
      "Is it quicker to clap your hands once or to tie your shoelaces?",
      "Which animal is taller: a mouse or an elephant?",
      "Which is heavier: a feather pillow or a pile of bricks?",
      "Put these in order of time taken, from quickest to slowest: eating an apple, reading a book, blinking.",
      "Is a tree taller or shorter than a flower?",
      "Which holds more juice: a small carton or a large bottle?",
      "Which is lighter: a coin or a wallet full of coins?",
      "Is it slower to crawl or to run?",
      "Which is longer: a worm or a snake?",
      "Which is heavier: a single piece of paper or a whole notebook?",
      "Does a jug hold more or less water than a spoon?",
      "Who is taller: the school's headteacher or a student in Year 1?",
      "Which takes a shorter time: counting to 10 or counting to 100?",
      "Is a bus longer or shorter than a bicycle?",
      "Which is lighter: your school jumper or your winter coat?",
      "Compare the capacity of your water bottle and your lunch box. Which holds more?",
      "Order these from slowest to fastest: a tortoise, a person walking, a car on the motorway.",
      "Which is shorter: a pen or a crayon?"
    ],
    "Year 2": [
      "Order these lengths from shortest to longest: 15cm, 8cm, 21cm, 12cm.",
      "Use the symbols <, >, or = to compare the following: 500g ___ 1kg.",
      "A bottle holds 1 litre of juice. A glass holds 200ml. Which holds more?",
      "Put these masses in order from lightest to heaviest: 25g, 1kg, 50g, 250g.",
      "Circle the longest time: 1 hour, 30 minutes, 70 minutes, half an hour.",
      "Order these masses from heaviest to lightest: 1kg, 500g, 750g, 2kg.",
      "Use the symbols <, >, or = to compare: 1 litre ___ 1000ml.",
      "A snake is 50cm long. A lizard is 55cm long. Which is shorter?",
      "A jug contains 500ml of squash. A glass contains 250ml. Which contains less?",
      "Put these lengths in order from longest to shortest: 2m, 150cm, 1m, 210cm.",
      "Use the symbols <, >, or = to compare: 30cm ___ 25cm.",
      "A bag of apples weighs 1kg. A bag of grapes weighs 900g. Which is heavier?",
      "Circle the smallest capacity: 300ml, 1 litre, 200ml, 50ml.",
      "Order these heights: Ben is 125cm tall, Sarah is 119cm tall, Tom is 130cm tall.",
      "Use the symbols <, >, or = to compare: 100g ___ 1kg.",
      "A red ribbon is 45cm long. A blue ribbon is half a metre long. Which is longer?",
      "A bottle of pop is 2 litres. A carton of juice is 1 litre. How much more does the pop bottle hold?",
      "Arrange these weights in ascending order: 3kg, 300g, 1kg, 2500g.",
      "Which is longer, the school hall or the classroom?",
      "Use the symbols <, >, or = to compare: 75ml ___ 750ml.",
      "A pencil is 15cm long. A crayon is 9cm long. Which is shorter?",
      "Sam weighs 25kg. His dog weighs 30kg. Who is lighter?",
      "Order these capacities from smallest to largest: 1 litre, 50ml, 500ml, 2 litres.",
      "Use the symbols <, >, or = to compare: 1m 10cm ___ 120cm.",
      "Is a 30-minute cartoon longer or shorter than a 1-hour film?",
      "Use the symbols <, >, or = to compare: 25cm ___ a quarter of a metre.",
      "Put these capacities in descending order: 1 litre, 1200ml, 900ml, 1.5 litres.",
      "Which is heavier, 200g of feathers or 200g of stones? Use the = sign.",
      "Order these times from shortest to longest: 45 minutes, 1 hour, 25 minutes, half an hour.",
      "A rope is 2 metres long. Another rope is 180cm long. Which is longer?",
      "Use the symbols <, >, or = to compare: 750g ___ three quarters of a kilogram.",
      "A can holds 330ml. A bottle holds half a litre. Which holds more?",
      "Order these masses from lightest to heaviest: 500g, 5kg, 50g.",
      "Which is a shorter distance: 1km or 1200m?",
      "Use the symbols <, >, or = to compare: 90 minutes ___ 1.5 hours.",
      "A plant is 67cm tall. Another plant is 65cm tall. Which is shorter?",
      "A bag of flour weighs 1.5kg. A bag of sugar weighs 1500g. Compare their weights.",
      "Circle the largest volume: 2 litres, 2500ml, 2200ml.",
      "Order these children from shortest to tallest: Amy (1m 15cm), Leo (120cm), Sara (1m 5cm).",
      "Use the symbols <, >, or = to compare: 2 days ___ 48 hours.",
      "A plank is 3m long. A second plank is 305cm long. Which is shorter?",
      "A cat weighs 4kg. A puppy weighs 3500g. Which is heavier?",
      "Which holds less: a jug with 1 litre of water, or a bucket with 1500ml of water?",
      "Order these amounts of time from longest to shortest: 1 day, 25 hours, 1200 minutes.",
      "Use the symbols <, >, or = to compare: 199cm ___ 2m.",
      "A watermelon weighs 3kg. A pineapple weighs 2800g. Which is lighter?",
      "Put these volumes in order, starting with the smallest: 950ml, 1 litre, 0.9 litres.",
      "Which is longer: a 90-minute film or a film that lasts 1 hour and 20 minutes?",
      "Use the symbols <, >, or = to compare: 1500m ___ 1.5km."
    ],
    "Year 3": [
      "A pencil is 15cm long. A ruler is 30cm long. How much longer is the ruler?",
      "A bag of sugar weighs 1kg. A bag of flour weighs 750g. Which is lighter?",
      "A can of fizzy drink holds 330ml. A bottle of water holds 500ml. Which has a larger capacity?",
      "Convert 1.5kg to grams. Is this more or less than 1200g?",
      "Order these lengths from shortest to longest: 1m, 120cm, 95cm, 1m 10cm.",
      "Convert 250cm to metres. Is this longer or shorter than 2m?",
      "A pineapple weighs 1.2kg. An orange weighs 200g. Which is heavier?",
      "A swimming pool holds 5000 litres of water. A paddling pool holds 50,000ml. Which holds more?",
      "Order these masses: 1.5kg, 2000g, 1200g, 0.5kg.",
      "Use the symbols <, >, or = to compare: 35mm ___ 3cm.",
      "A running track is 400m long. A football pitch is 110m long. Which is shorter?",
      "A bag of flour is 1.5kg. A bag of sugar is 1kg 200g. Which is lighter?",
      "Compare these volumes: 1.2 litres ___ 1100ml.",
      "Arrange these lengths in descending order: 2km, 250m, 2.1km, 2050m.",
      "Is 4kg and 50g heavier or lighter than 4.5kg?",
      "Would a mug of tea be closer to 300ml or 3 litres?",
      "A piece of string is 2m 5cm long. Write this in centimetres.",
      "Order these weights from lightest to heaviest: 750g, 1.1kg, 0.9kg, 1050g.",
      "A journey is 5km long. Another journey is 500m long. Which is ten times longer?",
      "Use the symbols <, >, or = to compare: 750ml ___ 0.75 litres.",
      "A plank of wood is 3m long. A door is 195cm tall. Which is longer?",
      "Which is heavier: 3.5kg of feathers or 3kg of stones?",
      "A recipe needs 0.5 litres of milk. You have a 600ml carton. Do you have enough?",
      "Order these lengths: 10mm, 1cm, 0.1m, 1m.",
      "Is a weight of 2050g more or less than 2.5kg?",
      "A piece of ribbon is 1m 25cm long. Another is 130cm long. Which is longer?",
      "Compare the weights: 2kg 50g and 2500g.",
      "Which container has a larger capacity: a 1.5 litre bottle or a 1400ml jug?",
      "Arrange these measurements from shortest to longest: 25mm, 2cm, 0.02m.",
      "Is a mass of 990g greater or less than 1kg?",
      "A book is 23cm long. A shelf is 1m long. How many books could fit on the shelf?",
      "A parcel weighs 1.8kg. The maximum postage weight is 2kg. Is the parcel light enough?",
      "A recipe calls for 450ml of stock. You have a 0.5 litre carton. Is there enough?",
      "Order these lengths from longest to shortest: 300cm, 3.5m, 3m 20cm.",
      "Use the symbols <, >, or = to compare: 1001g ___ 1kg.",
      "Which holds more: three cans of 330ml or a 1 litre bottle?",
      "A child is 1m 10cm tall. To go on a ride, they must be 120cm tall. Are they tall enough?",
      "A bag of apples weighs 1.2kg. A bag of bananas weighs 1kg 250g. Which is heavier?",
      "A car's fuel tank holds 40 litres. A petrol can holds 5000ml. How many cans to fill the tank?",
      "Put these lengths in ascending order: 1.5km, 1600m, 1km 400m.",
      "Which is lighter: a 2.2kg bag of potatoes or a 2150g bag of potatoes?",
      "A watering can holds 5 litres. A bucket holds 8000ml. What is the difference in capacity?",
      "Compare the lengths: 99mm and 10cm.",
      "A box of cereal weighs 0.75kg. Is that more or less than 750g?",
      "Which is the larger volume: 2.5 litres or 2499ml?",
      "Order these from heaviest to lightest: 0.5kg, 50g, 5000g, 5.5kg.",
      "A bridge is 1km long. A train is 200m long. How many train lengths fit on the bridge?",
      "A bottle of medicine holds 150ml. A dose is 5ml. How many doses are in the bottle?",
      "Which length is the odd one out: 2.5m, 250cm, 2500mm, 25m?",
      "A shopping bag can hold 5kg. The shopping weighs 4800g. Will it hold?",
      "A fish tank needs 25 litres of water. You have a 2 litre jug. How many times must you fill it?"
    ],
    "Year 4": [
      "Which is a better value: 2 litres of milk for Â£1.50 or 500ml for 40p?",
      "An apple costs 35p. A banana costs 40p. Which is cheaper?",
      "Would you measure the distance to the next town in metres or kilometres?",
      "Compare these amounts using <, >, or =: Â£2.50 ___ 250p.",
      "Which is heavier, a bag of crisps (25g) or a bar of chocolate (100g)?",
      "A 1kg bag of carrots costs Â£1. A 750g bag of carrots costs 80p. Which is better value for money?",
      "A pack of 4 yoghurts costs Â£1.20. A single yoghurt costs 35p. Is it cheaper to buy four single yoghurts?",
      "Compare the distance from your school to your home, and from your school to the local shop. Which is further?",
      "Is it better to buy a 2-litre bottle of lemonade for Â£1.80 or two 1-litre bottles for 95p each?",
      "A monthly bus pass is Â£40. A single ticket is Â£2.50. If you make 20 journeys in a month, which is cheaper?",
      "Compare these prices using <, >, or =: Â£15.01 ___ 1510p.",
      "Would you measure the weight of a person in grams or kilograms?",
      "A car is 4.5m long. A parking space is 500cm long. Is the space long enough?",
      "A book costs Â£7.99. The same book costs 8 Euros. Given Â£1 is about 1.15 Euros, which is cheaper?",
      "Is a temperature of 25Â°C hotter or colder than 10Â°C?",
      "Compare the area of two classrooms. Which is larger?",
      "A box of cereal weighing 500g costs Â£2.00. A larger box weighing 750g costs Â£2.70. Which is the better buy per gram?",
      "Compare these amounts: 350p ___ Â£3.05.",
      "Which unit of measurement would be most appropriate to measure the capacity of a car's petrol tank?",
      "You have Â£10. Can you afford to buy a DVD for Â£7.50 and popcorn for Â£2.99?",
      "Which is a longer period of time: 3 weeks or 20 days?",
      "A fence is 1.8m tall. A wall is 170cm tall. Which is shorter?",
      "A job pays Â£10 per hour. Another job pays Â£75 for an 8-hour day. Which job pays more per hour?",
      "Compare the weight of your school bag in the morning and the afternoon. When is it heavier?",
      "Is it generally warmer in June or in December in the UK?",
      "A 500g jar of coffee costs Â£4.00. A 200g jar costs Â£2.00. Which is better value?",
      "Which is a greater amount: one thousand pence or ten pounds?",
      "Would you measure the length of a river in centimetres or kilometres?",
      "Compare the duration: a 1 hour 30 minute film vs a 100 minute film.",
      "A pack of 3 pens costs 99p. A single pen costs 35p. Which is cheaper per pen?",
      "Use <, >, or = to compare: 4500g ___ 4.5kg.",
      "A holiday in Spain costs â¬500. A holiday in Portugal costs Â£450. If Â£1 = â¬1.10, which holiday is cheaper?",
      "Which is the colder temperature: -5Â°C or -2Â°C?",
      "A 2 litre bottle of water costs Â£1.00. A 500ml bottle costs 30p. Which is better value per litre?",
      "Compare these amounts of money: Â£0.50 and 5p.",
      "Which is a longer distance: 2.5km or 2400m?",
      "A bag of 6 apples costs Â£1.20. A bag of 8 apples costs Â£1.68. Which is better value per apple?",
      "Use <, >, or = to compare: 90 seconds ___ 1.5 minutes.",
      "A book has a mass of 0.8kg. A laptop has a mass of 1200g. Which is heavier?",
      "Which is the better offer: 'Buy one get one free' on items costing Â£5, or a '3 for 2' offer on the same items?",
      "Compare the areas: a field that is 100m x 50m vs a field that is 80m x 60m.",
      "A train journey takes 2 hours 15 minutes. A car journey takes 140 minutes. Which is quicker?",
      "A 75cl bottle of juice costs Â£1.50. A 1 litre carton costs Â£1.80. Which is better value?",
      "Use <, >, or = to compare: Â£1,250 ___ one thousand two hundred and five pounds.",
      "Which is heavier: 1 tonne or 1001kg?",
      "A phone plan costs Â£10 a month for 1000 minutes. Another costs Â£12 for 1500 minutes. Which is cheaper per minute?",
      "Compare the lengths: 1 mile or 1.5 kilometres? (1 mile â 1.6km)",
      "A 1kg tub of butter costs Â£5. A 250g block costs Â£1.30. Which is better value?",
      "Which is warmer: the average UK summer temperature (19Â°C) or a hot oven (200Â°C)?",
      "Use <, >, or = to compare: half a day ___ 10 hours."
    ]
  },
  "estimate_measure_and_read_scales": {
    "Year 1": [
      "How many building blocks long is your desk?",
      "Use a ruler to measure the length of your pencil in centimetres.",
      "Choose two objects in the classroom. Which do you estimate is heavier? Now use a balance scale to check.",
      "How many cups of water do you think it will take to fill a jug?",
      "Using a timer, how long does it take to write your name five times?",
      "How many of your hand spans does it take to measure the width of the door?",
      "Estimate how many pencils long the teacher's desk is, then check.",
      "Find an object you think is heavier than your shoe. Use a balance scale to compare them.",
      "Estimate how many small cubes will fit into a large box.",
      "Use a stopwatch. How many star jumps can you do in 30 seconds?",
      "Measure your height using a tape measure.",
      "Find an object in the classroom and record its length in centimetres.",
      "Estimate which holds more: a cup or a bucket.",
      "How many steps does it take to walk across the classroom?",
      "Measure the length of a book using paperclips.",
      "Estimate if your water bottle is full, half full, or empty.",
      "How long does it take for a sand timer to run out?",
      "Measure the weight of three different objects using a balance scale and put them in order.",
      "Estimate how many Lego bricks tall your chair is.",
      "Record the time it takes for a friend to run across the playground.",
      "Measure the width of a window in hand spans.",
      "Estimate how many glasses of water would fill a watering can.",
      "Find a leaf outside and measure its length with a ruler.",
      "Use a balance to find something that weighs the same as 10 connecting cubes.",
      "Record what time school starts and finishes by looking at the clock.",
      "How many steps long is the school corridor? Estimate first, then measure.",
      "Use non-standard units, like crayons, to measure the length of your table.",
      "Which do you estimate is heavier: a whiteboard pen or a pair of scissors? Use a balance to check.",
      "Estimate how many handfuls of sand would fill a bucket.",
      "Use a clock with a second hand to time how long you can stand on one leg.",
      "Measure the height of your friend using building blocks.",
      "Find three things in the classroom that are shorter than your ruler.",
      "Estimate which is lighter: an apple or a banana? Check with a balance scale.",
      "How many yoghurt pots of water do you think will fill a large bowl?",
      "Time how long it takes to sing 'Happy Birthday' three times.",
      "Measure your own foot using 1p coins lined up end to end.",
      "Record the length of a piece of string in centimetres.",
      "Find something in the room that you think has the same weight as your reading book.",
      "Estimate how many times you can write the number 8 in one minute.",
      "Use a ruler to measure the shortest side of a rectangular table.",
      "How many of your feet (heel to toe) is it from your desk to the door?",
      "Estimate the weight of an empty lunchbox, then weigh it with something heavy inside.",
      "Pour water from a full cup into an empty jug. Describe how full the jug is.",
      "Use a calendar to find out how many seconds there are in a minute.",
      "Measure the longest object in your pencil case.",
      "Which is heavier: a stack of 5 books or a single chair?",
      "Estimate how many little cups of rice would fill a big cup.",
      "How long does the school lunchtime last? Record the start and end times.",
      "Measure the distance around a hula hoop using a piece of string."
    ],
    "Year 2": [
      "What unit would you use to measure the length of the classroom? (cm or m)",
      "Read the weighing scale. How much does the bag of flour weigh in grams?",
      "The thermometer shows the temperature in the classroom. What is the temperature in degrees Celsius?",
      "How much water is in the measuring jug in millilitres?",
      "Estimate the height of your chair in centimetres, then measure it with a ruler.",
      "Estimate the weight of your reading book in grams, then use a scale to measure it.",
      "What is the temperature on the thermometer outside? Is it hot or cold?",
      "Measure the height of your friend in metres and centimetres.",
      "Read the scale on the measuring jug. How much juice is there in millilitres?",
      "Estimate the mass of an apple. Is it closer to 10g, 100g or 1kg?",
      "Use a ruler to draw a line that is exactly 12cm long.",
      "Read the weight on a kitchen scale. How many kilograms does the bag of sugar weigh?",
      "The weather forecast says it will be 15Â°C. What sort of clothes should you wear?",
      "Pour 200ml of water into a measuring jug.",
      "Estimate the length of the school hall in metres.",
      "Measure the perimeter of your table using a tape measure.",
      "What weight is the arrow pointing to on this scale? (Image of a scale needed).",
      "Look at the thermometer in the classroom. Record the temperature.",
      "How much liquid is in this beaker? (Image of a beaker with a scale needed).",
      "Estimate the capacity of your water bottle. Is it more or less than 1 litre?",
      "Measure the length and width of a piece of A4 paper in centimetres.",
      "Use a weighing scale to find out how many grams a pack of crisps weighs.",
      "What temperature does water freeze at?",
      "A recipe says to add 500ml of milk. Use a measuring jug to measure this amount.",
      "Estimate, then measure, the distance from your desk to the classroom door in metres.",
      "Choose the best unit to measure the weight of a pencil: grams or kilograms?",
      "Read the temperature from a weather app or thermometer for today. Is it hot, warm, or cold?",
      "A recipe requires 250ml of water. Shade the measuring jug to show this amount.",
      "Estimate the length of a car in metres. Then, if possible, find out the actual length.",
      "What would you use to measure the amount of water in a bath: millilitres or litres?",
      "Draw a line you estimate to be 15cm long. Check its length with a ruler.",
      "The scale shows 1.5kg. How many grams is this?",
      "The temperature in the desert can be 40Â°C. Is this hot or cold?",
      "How many 100ml glasses can you fill from a 1 litre bottle?",
      "Estimate the width of the school gate in metres.",
      "What standard unit would you use to measure your own height?",
      "Read the scale on a bag of potatoes. What is the mass in kg?",
      "A thermometer reads 22Â°C. Is this a likely temperature for an oven or a room?",
      "A measuring cylinder contains 75ml of liquid. Draw the line on a diagram.",
      "Estimate the mass of a pineapple in kilograms.",
      "Use a ruler to measure the height of a water bottle in centimetres.",
      "What does the 'g' stand for on a weighing scale?",
      "If the temperature is 0Â°C, what might you see outside?",
      "Estimate the capacity of a school milk carton in millilitres.",
      "Measure the length of your shoe in centimetres.",
      "Would a feather weigh more or less than 1 gram?",
      "Read the temperature on an oven dial. Is it measured in Â°C or ml?",
      "A jug has markings every 100ml. If the water level is on the third mark, how much water is there?",
      "Estimate the height of a door in metres.",
      "Choose the most sensible weight for a banana: 150g, 1.5kg, or 15g."
    ],
    "Year 3": [
      "Measure the length of the whiteboard in metres and centimetres.",
      "Find an object that weighs approximately 1kg. Use a digital scale to check your accuracy.",
      "How much water is in the measuring cylinder? Read the scale to the nearest millilitre.",
      "Draw a line that you estimate to be 8.5cm long. Measure it for accuracy.",
      "Read the weight shown on these bathroom scales in kilograms.",
      "Measure the perimeter of a regular pentagon with 5cm sides.",
      "A bag of flour weighs 1.5kg. What does the scale show in grams?",
      "Estimate the capacity of a large bucket. Is it closer to 1 litre, 10 litres, or 100 litres?",
      "Measure the thickness of a Â£1 coin in millimetres.",
      "Weigh a single grape. What is its mass in grams?",
      "Look at the markings on a ruler. How many millimetres are between the 2cm and 3cm mark?",
      "Use a tape measure to find the circumference of your head.",
      "Read the volume of liquid in a graduated cylinder, paying attention to the meniscus.",
      "Estimate the mass of a large dictionary.",
      "Measure the length of a football pitch in metres.",
      "A bottle of medicine says to take 5ml. Use a medicine spoon to measure this dose.",
      "Look at a set of kitchen scales. What is the interval between each marking?",
      "Draw a plan of your bedroom and measure its length and width.",
      "Find the total weight of 5 apples.",
      "Estimate, then measure, the volume of a lunchbox by filling it with water and pouring it into a measuring jug.",
      "Measure the length of your desk to the nearest millimetre.",
      "Estimate the mass of a bag of sugar in kg. Then read the actual mass.",
      "A measuring jug has 1 litre of water. 250ml is poured out. What does the scale read now?",
      "Draw a rectangle with a perimeter of 20cm. Measure the sides.",
      "Read the scale. The arrow is halfway between 1kg and 2kg. What is the weight?",
      "Measure the height of a classroom door in metres and centimetres.",
      "Find an object that you estimate weighs about 200g. Check your estimate.",
      "A beaker contains 450ml of liquid. If you add 100ml more, what will the new reading be?",
      "Estimate the length of your pencil in mm, then measure it.",
      "Use kitchen scales to measure out 375g of flour.",
      "Measure the perimeter of a square with sides of 7cm.",
      "Read the volume of milk in a 2-litre carton that is half full.",
      "Estimate the width of a window in centimetres.",
      "What is the mass of 1 litre of water? (Answer: 1kg).",
      "Measure the length of your arm from your elbow to your wrist in cm and mm.",
      "A scale shows 2kg and 300g. What is the total mass in grams?",
      "Estimate the capacity of a car's windscreen washer tank in litres.",
      "Draw a line that is exactly 125mm long using a ruler.",
      "Weigh a banana. Then weigh the peel. What is the mass of the part you eat?",
      "Measure the perimeter of an A4 sheet of paper.",
      "A recipe requires 750ml of stock. How would you measure this using a 500ml jug?",
      "Estimate the length of a whale in metres.",
      "Read a person's weight on a set of bathroom scales that shows 65.5kg.",
      "Measure the amount of water a sponge can soak up.",
      "What is the length of a standard 30cm ruler in millimetres?",
      "Estimate the weight of a can of baked beans.",
      "A rain gauge collected 12mm of rain. Show this on a diagram of a ruler.",
      "Measure the perimeter of a hexagon where each side is 4cm long.",
      "A measuring cylinder holds 100ml. What do the intervals of 10ml represent?",
      "Estimate the total mass of the books in your school bag."
    ],
    "Year 4": [
      "Estimate the total cost of a loaf of bread (Â£1.25), a pint of milk (60p) and a block of cheese (Â£2.50).",
      "A recipe needs 250g of flour. If you only have a 1kg bag, about what fraction of the bag will you use?",
      "If a journey starts at 2:15 pm and finishes at 3:00 pm, estimate how long it took.",
      "Estimate the length of your classroom. Would you measure it in metres or centimetres?",
      "Look at a map of your local area. Estimate the distance from your school to the nearest park.",
      "Estimate the total value of these coins in a picture: Â£1, 50p, 20p, 20p, 5p, 2p.",
      "A journey takes 40 minutes. If you leave at 8:30 am, estimate the arrival time.",
      "Estimate the weight of a bag of shopping. Would it be closer to 500g, 5kg, or 50kg?",
      "Look at the price of petrol per litre at a petrol station. Estimate the cost to fill a 40-litre tank.",
      "Estimate the area of your classroom floor in square metres.",
      "A menu has prices like Â£8.95, Â£12.50, and Â£4.99. Estimate the cost of a three-course meal.",
      "Estimate the height of a double-decker bus.",
      "If your pocket money is Â£5 a week, estimate how many weeks it would take to save for a Â£22 video game.",
      "Look at your electricity meter. Read the number shown.",
      "Estimate the amount of water you drink in a day in litres.",
      "Estimate the cost of posting a parcel based on its weight.",
      "A recipe needs 175g of sugar. Look at a bag of sugar and estimate how much this is.",
      "How long do you estimate it will take to run 100 metres?",
      "Estimate the total length of all the pencils in your pencil case.",
      "Look at a timetable for a TV channel. Estimate the total time spent on news programmes in one evening.",
      "Estimate the price of a weekly food shop for a family.",
      "How much time do you estimate you spend on homework each week?",
      "Estimate the weight of your school chair.",
      "A car's fuel gauge is halfway between full and empty. The tank holds 60 litres. Estimate how many litres are left.",
      "Estimate the temperature in the room right now.",
      "Estimate the total cost of a cinema ticket (Â£8.50), popcorn (Â£4.95), and a drink (Â£2.75).",
      "A jug holds 1 litre of water. You pour out what you think is 300ml. How can you check how accurate your estimate was?",
      "Estimate the perimeter of the school playground in metres.",
      "You have a Â£20 note. Estimate if you have enough to buy three items costing Â£5.99 each.",
      "Estimate the mass of a dog in kilograms.",
      "Read the departure board at a train station. If a train is due at 14:05 and it's now 13:50, about how long is the wait?",
      "Estimate the capacity of a bathtub in litres.",
      "A bill for a meal comes to Â£48.60. Estimate a 10% tip.",
      "Estimate the length of a football pitch. Is it closer to 10m, 100m, or 1km?",
      "Look at the prices in a supermarket catalogue. Estimate the cost of the ingredients for a simple meal.",
      "Estimate the weight of your desk in kilograms.",
      "A scale shows a parcel's weight is halfway between 2.5kg and 3kg. What is the estimated weight?",
      "Estimate how many millilitres of water are in a half-full 2-litre bottle.",
      "You need 2kg of apples. One apple weighs about 150g. Estimate how many apples you need.",
      "Estimate the total value of the coins in your teacher's purse or wallet (with permission!).",
      "Read a utility bill (gas, electric). What is the meter reading?",
      "Estimate the amount of liquid in a can of fizzy drink in ml.",
      "A recipe needs 1.2kg of meat for 6 people. Estimate how much meat would be needed for 3 people.",
      "Estimate the cost of a family holiday from a brochure.",
      "If a film is 135 minutes long, estimate its running time in hours and minutes.",
      "Estimate the mass of a car in tonnes.",
      "Read a nutrition label on a food packet. How many grams of sugar are there per 100g?",
      "Estimate the perimeter of a local park by walking around it and counting your steps.",
      "You have Â£5.00. Estimate the total cost of a sandwich (Â£2.80), crisps (85p), and a drink (Â£1.20).",
      "Estimate the temperature of a hot cup of tea."
    ]
  },
  "money": {
    "Year 1": [
      "What is the value of a 10p coin?",
      "Which is worth more, a 2p coin or a 5p coin?",
      "Can you name all the UK coins?",
      "If you have a 1p, 2p, and 5p coin, how much money do you have altogether?",
      "I have a coin that is silver and has seven sides. What coin is it?",
      "How many 1p coins do you need to make 5p?",
      "Can you find a coin that is brown? What is its value?",
      "I have two 10p coins. How much money do I have?",
      "Which note has the lowest value? (Â£5, Â£10, Â£20).",
      "Is a 50p coin worth more or less than a Â£1 coin?",
      "If I have three 2p coins, how much do I have?",
      "Name a coin that is gold and silver.",
      "What is the colour of a Â£10 note?",
      "How many 5p coins are worth the same as a 20p coin?",
      "I have a Â£2 coin and a Â£1 coin. How much money do I have?",
      "Find two coins that add up to 3p.",
      "What coin has 12 sides?",
      "How many 1p coins are in a Â£1 coin?",
      "If I have a 20p coin and a 5p coin, do I have more or less than 22p?",
      "Can you show me 8p using exactly three coins?",
      "Name all the silver coins.",
      "What is the value of a Â£20 note?",
      "If I have two 50p coins, how much money do I have?",
      "Find three coins that add up to 16p.",
      "Which is worth more: four 1p coins or one 5p coin?",
      "What coin is small, silver and round?",
      "How many 1p coins make 10p?",
      "If you have a 5p coin and a 2p coin, how much do you have?",
      "Which is worth less: a Â£5 note or a Â£10 note?",
      "Can you find two coins that have the same value?",
      "What is the biggest coin in size?",
      "I have a 10p coin and a 5p coin. How much money is that?",
      "Name a bank note that is orange.",
      "How many 2p coins make 10p?",
      "What is the total value of a 50p coin and a 10p coin?",
      "Find a coin that is worth 100 pennies.",
      "If I have four 1p coins, how much do I have?",
      "Which is worth more: a 50p coin or three 10p coins?",
      "What is the value of the coin with two colours?",
      "How many 5p coins make 15p?",
      "I have a 20p coin and a 2p coin. How much is that?",
      "Which coin is worth the most?",
      "Which bank note is worth the least?",
      "If I have a Â£1 coin and a 10p coin, do I have more than 105p?",
      "Show me 6p using the smallest number of coins.",
      "How much is a 1p, a 2p and another 1p coin altogether?",
      "What is the shape of a 20p coin?",
      "How many 10p coins are equal to a 50p coin?",
      "Can you add a 50p coin and a Â£1 coin?",
      "Which is worth less: a 2p coin or a 1p coin?"
    ],
    "Year 2": [
      "How many 10p coins make Â£1?",
      "If you buy a comic for 60p and pay with a Â£1 coin, how much change will you get?",
      "Sophie buys a cake for 35p and a drink for 25p. How much does she spend altogether?",
      "Write down two different ways to make 20p using coins.",
      "What do the symbols Â£ and p stand for?",
      "A pen costs 45p. Which coins could you use to pay for it exactly?",
      "You have Â£1 and spend 70p. How much change do you get?",
      "How much is two Â£5 notes and three Â£1 coins?",
      "Find the total of Â£2, 50p, and 5p.",
      "Show three ways to make 50p.",
      "If you save 10p every day for a week, how much will you have?",
      "An ice cream costs 85p. You pay with a Â£1 coin. What is your change?",
      "Which costs more, a comic for Â£1.50 or a book for Â£1.25?",
      "How many 20p coins do you need to make Â£2?",
      "Sarah has Â£5. She buys a magazine for Â£2.50. How much is left?",
      "Add these amounts: Â£3 and 40p + Â£1 and 20p.",
      "What is the difference between Â£10 and Â£6.50?",
      "A bus ticket is 90p. How much for two tickets?",
      "Can you buy a toy for Â£3.75 if you have a Â£5 note?",
      "I have three 50p coins and two 20p coins. How much money is that?",
      "How much more do I need to make Â£1 if I have 65p?",
      "A rubber costs 15p. A ruler costs 25p. How much for both?",
      "Find the value of one Â£10 note, one Â£5 note, and three Â£2 coins.",
      "If I share Â£2 equally between two people, how much do they get each?",
      "I buy a drink for 65p and crisps for 55p. How much have I spent?",
      "Tom has a 50p coin and three 10p coins. How much money does he have?",
      "A banana costs 30p. An apple costs 25p. How much for one of each?",
      "How can you make 75p using exactly three coins?",
      "I have Â£1 and buy a chocolate bar for 55p. What change will I receive?",
      "How many 5p coins are in 50p?",
      "Lily has two 20p coins and one 5p coin. Does she have enough to buy a comic for 40p?",
      "Find the total of a Â£1 coin, a 50p coin, and a 5p coin.",
      "Show Â£1.50 using the smallest number of coins.",
      "If I have three 20p coins, how much more do I need to make Â£1?",
      "A toy car costs Â£1.20. A toy boat costs Â£1.50. What is the difference in price?",
      "How many Â£2 coins are there in Â£10?",
      "Sam wants to buy a book for Â£5. He has saved Â£3.50. How much more does he need?",
      "Add together 45p and 35p.",
      "Can you make 37p using UK coins?",
      "I pay for a 70p item with a Â£2 coin. How much change do I get?",
      "What is the total of a Â£5 note and a Â£10 note?",
      "A pack of stickers costs 80p. How much would 2 packs cost?",
      "How would you write one pound and five pence using the Â£ symbol?",
      "If I have two 50p coins and I spend 80p, how much do I have left?",
      "Find three coins that total 26p.",
      "How many 50p coins make Â£3.00?",
      "Which is more money: four 20p coins or three 50p coins?",
      "A cup of juice is 40p. A biscuit is 15p. How much for both?",
      "What is double Â£1.25?",
      "Show how to make Â£2.35 using four coins."
    ],
    "Year 3": [
      "A computer game costs Â£15. You have saved Â£8.50. How much more do you need?",
      "Calculate the change from Â£10 for items costing Â£3.40 and Â£2.80.",
      "Three friends share the cost of a pizza that is Â£9.60. How much do they each pay?",
      "A cinema ticket costs Â£4.75. How much would it cost for a family of four?",
      "Find the total cost of a book at Â£6.99 and a pen at Â£1.25.",
      "How much is five Â£2 coins, three 50p coins, and seven 5p coins?",
      "I bought two items for Â£5.60. One cost Â£2.90. What did the other one cost?",
      "A weekly bus pass costs Â£12.50. How much would four weeks cost?",
      "A sandwich costs Â£2.80, a drink 95p, and a cake Â£1.50. What is the total?",
      "If I have a Â£20 note, can I buy three books that cost Â£6 each? What change will I get?",
      "Find half of Â£7.50.",
      "I have a mixture of 8 coins in my pocket worth 97p. What could they be?",
      "What is the difference in price between a Â£12.99 toy and a Â£17.50 toy?",
      "A school trip costs Â£14 per child. How much for 10 children?",
      "Find 1/4 of Â£20.",
      "I bought 5 pens for 40p each. How much did I spend in total?",
      "A meal costs Â£23.70. How much change is there from a Â£50 note?",
      "If I save Â£3 a week, how long will it take to save for a bike that costs Â£36?",
      "A DVD costs Â£8.99. A Blu-ray costs Â£11.49. How much more is the Blu-ray?",
      "Add up these amounts: Â£10.60, Â£5.80 and Â£3.20.",
      "A t-shirt costs Â£5.50 and a pair of shorts costs Â£4.75. How much do they cost altogether?",
      "A pack of pens costs Â£2.40. There are 6 pens in the pack. What is the cost per pen?",
      "A cafÃ© sells coffee for Â£2.60 and tea for Â£1.90. How much more does the coffee cost?",
      "If I pay for a Â£2.80 magazine with a Â£5 note, how much change will I get?",
      "I buy a book for Â£4.80 and pay with a Â£10 note. What is my change?",
      "A football costs Â£8.25. A pump costs Â£3.99. What is the total cost?",
      "How much change would you get from a Â£10 note if you spent Â£6.35?",
      "If 4 children share Â£10 equally, how much does each child get?",
      "A swimming lesson costs Â£6.50. How much would 5 lessons cost?",
      "Find the sum of Â£12.45 and Â£7.80.",
      "I have Â£15. I buy a DVD for Â£8.99. How much money is left?",
      "A train ticket costs Â£22.50. How much would it cost for 3 people?",
      "Convert 350p into pounds and pence.",
      "A family meal costs Â£34.60. They pay with two Â£20 notes. What is their change?",
      "What is Â£10 minus Â£4.72?",
      "If I save Â£1.50 each week, how much will I save in 6 weeks?",
      "A jacket costs Â£25. It is in a sale with Â£5.50 off. What is the new price?",
      "Find the cost of 10 stamps if one stamp costs 65p.",
      "Add Â£3.45, Â£2.99 and Â£1.50 together.",
      "A book costs Â£7.49. How much change from Â£20?",
      "If a pack of 8 batteries costs Â£4.80, what does one battery cost?",
      "Subtract Â£2.80 from Â£5.00.",
      "A monthly magazine subscription is Â£4.25. What is the cost for a whole year?",
      "What is one third of Â£9.30?",
      "A comic is Â£1.25 and a magazine is Â£2.10. How much more is the magazine?",
      "How many 50p coins do you need to make Â£5.50?",
      "If you spend Â£1.75 and Â£2.50, what is the total spend?",
      "A toy car costs Â£3.75. How much would 3 cost?",
      "What is the difference between Â£20 and Â£11.65?",
      "If I have Â£8.40 and I divide it among 4 people, how much does each get?"
    ]
  },
  "telling_time_ordering_time_duration_and_units_of_time": {
    "Year 1": [
      "What time is it if the big hand is on the 12 and the little hand is on the 3?",
      "Draw the hands on a clock to show half past 4.",
      "What day comes after Tuesday?",
      "Put these in order: morning, afternoon, evening.",
      "Which month is your birthday in?",
      "Draw a clock showing 9 o'clock.",
      "If it is morning now, what part of the day comes next?",
      "Which season comes after summer?",
      "What day is it today? What day will it be tomorrow?",
      "Point to the hour hand on a clock. Point to the minute hand.",
      "Is playtime in the morning or the afternoon?",
      "How many days are in a week?",
      "The clock says 1 o'clock. What time will it be in one hour?",
      "What month comes before January?",
      "Show me half past 2 on a clock.",
      "Which day of the week is the first day of the school week?",
      "Name the four seasons.",
      "If a party starts at 3 o'clock and lasts for one hour, what time does it finish?",
      "What do you usually do in the evening?",
      "What is special about Saturday and Sunday?",
      "Draw a clock that shows the time you go to bed.",
      "Put these in order: breakfast, lunch, dinner.",
      "How many months are in a year?",
      "What time does school finish?",
      "If the time is half past 8, where is the big hand pointing?",
      "What time is it one hour after 7 o'clock?",
      "Show half past 11 on a clock face.",
      "What is the day before Saturday?",
      "Put these events in order: go to school, wake up, go to bed, eat dinner.",
      "Name a month in the season of winter.",
      "The little hand is pointing at the 6, the big hand is pointing at the 12. What time is it?",
      "If it is half past 9, where is the minute hand?",
      "What day of the week is your favourite?",
      "Which comes first, March or May?",
      "Draw a clock showing the time you have lunch.",
      "What time is it one hour before 2 o'clock?",
      "How many days are there from Monday to Friday?",
      "A TV show starts at 5 o'clock. Where are the hands on the clock?",
      "What is the last month of the year?",
      "Show half past six on a clock.",
      "Put these in order of a day: sunrise, sunset, midnight, noon.",
      "Which season has Christmas in it?",
      "If you go to the park at 4 o'clock, what will you do before that?",
      "What time is it when both hands point to the 12?",
      "Name the month that comes after August.",
      "Draw the hands on a clock to show half past one.",
      "What day is two days after Wednesday?",
      "Which takes longer: a school day or a weekend?",
      "If you wake up at 7 o'clock, is that in the morning or evening?",
      "Show 10 o'clock on a clock face."
    ],
    "Year 2": [
      "What time is quarter past 7? Show this on a clock face.",
      "A TV show starts at 5:00 and ends at 5:30. How long is the show?",
      "How many minutes are in an hour?",
      "If it is 10 o'clock now, what time will it be in 2 hours?",
      "A bus journey takes 45 minutes. If it starts at 9:00 am, what time does it finish?",
      "A programme starts at quarter to 4. What time is this in digital format?",
      "How many hours are there in a day?",
      "It is 6:15. What time will it be in 30 minutes?",
      "A school lesson is 50 minutes long. Does it last for more or less than an hour?",
      "Write the time 'twenty past three' in digital form.",
      "A bus leaves at 10:00 am and the journey is one hour long. What time does it arrive?",
      "How many seconds are in a minute?",
      "Draw the hands on a clock to show 7:25.",
      "A film starts at 3:00 pm and finishes at 4:15 pm. How long was the film?",
      "If it's half past 2 now, what time was it half an hour ago?",
      "How many full weeks are in a month?",
      "It takes 10 minutes to walk to school. If you leave at 8:20 am, what time do you arrive?",
      "What time is shown on the clock? (Image showing ten to five).",
      "Order these times from earliest to latest: 3:00 pm, 10:00 am, 5:00 pm, 12:00 pm (noon).",
      "How many hours are there in two days?",
      "What time is 15 minutes after 1:30?",
      "A cake needs to bake for 25 minutes. It goes in the oven at 11:10. When is it ready?",
      "Write 'five to nine' in two different ways.",
      "A football match is 90 minutes long. It starts at 1:00 pm. What time does it finish?",
      "How many times does the minute hand go all the way around the clock in one hour?",
      "What time is it 20 minutes before 3 o'clock?",
      "A swimming lesson is 40 minutes long. It ends at 11:00 am. What time did it start?",
      "How many minutes pass between 2:10 and 2:35?",
      "Draw the hands on a clock to show quarter to eight.",
      "A train journey takes half an hour. If it leaves at 1:15 pm, when does it arrive?",
      "How many hours are there from 9am to 2pm?",
      "A party starts at 2:00 pm and lasts for 2 hours. What time does it finish?",
      "Write the time 'ten past six' using numbers.",
      "It is now quarter past 4. What time will it be in 20 minutes?",
      "A bike ride took 55 minutes. Is that more or less than one hour?",
      "How many days are in a fortnight?",
      "A cake takes 30 minutes to cool down. It comes out of the oven at 12:00. When is it cool?",
      "Which is longer: 3 days or 70 hours?",
      "Show 5:50 on an analogue clock face.",
      "A lesson begins at 9:05 and ends at 9:55. How many minutes long is it?",
      "How many minutes are in a quarter of an hour?",
      "Lunchtime starts at 12:15 and ends at 1:00. How long is lunchtime?",
      "What time is it 25 minutes after 10:30 am?",
      "If today is the 10th of the month, what will the date be in one week?",
      "A film is 75 minutes long. How many hours and minutes is this?",
      "How many times does the hour hand go all the way around the clock in one day?",
      "A park opens at 9am and closes at 6pm. For how many hours is it open?",
      "Write 'twenty-five to seven' in digital format.",
      "It takes 5 minutes to boil a kettle. If I start at 8:50 am, what time will it be ready?"
    ],
    "Year 3": [
      "Write 4:45 pm in 24-hour clock format.",
      "How many days are there in March?",
      "A film is 90 minutes long. How many hours and minutes is this?",
      "If you go to bed at 8:30 pm and wake up at 7:00 am, how long have you slept for?",
      "Look at a calendar. What day of the week is the 15th of the current month?",
      "A train is due at 16:10. It is 15 minutes late. What time does it arrive?",
      "How many days are there in a leap year?",
      "What time is it 25 minutes after 7:50 am?",
      "A TV show lasts for 45 minutes and ends at 6:00 pm. What time did it start?",
      "Write quarter to three in the afternoon in 24-hour format.",
      "How many hours and minutes is 100 minutes?",
      "A car journey took 2 hours and 30 minutes. If the family arrived at 1:00 pm, what time did they set off?",
      "Which months have exactly 30 days?",
      "Show 19:30 on an analogue clock face.",
      "A boy goes on holiday for 3 weeks. How many days is he away?",
      "What is the time 12 hours after 3:00 am?",
      "I leave home at 8:15 am and arrive at school at 8:40 am. How long is my journey?",
      "How many seconds are in five minutes?",
      "It is 2:00 pm. You are going to a party at 4:30 pm. How long do you have to wait?",
      "A clock shows Roman numerals. What time is it if the hour hand points to VI and the minute hand points to XII?",
      "A flight from London to Rome takes 2 hours and 20 minutes. If it departs at 11:00, when does it land?",
      "How many days are there altogether in July and August?",
      "What is the date one week after the 25th of December?",
      "A swimming lesson starts at 9:05 am and finishes at 9:55 am. How long is the lesson?",
      "Convert 3 days into hours.",
      "A bus leaves at 13:45. The journey takes 50 minutes. What time does it arrive?",
      "How many seconds are there in 2.5 minutes?",
      "A film starts at 18:00 and is 110 minutes long. What time does it finish?",
      "What is the date 2 weeks before the 30th of April?",
      "Write 8:20 in the morning using a.m. or p.m.",
      "How many days are there in this year?",
      "A train journey begins at 10:25 and ends at 11:10. How long did it take?",
      "How many minutes are there from 9:50 am to 10:15 am?",
      "Write half past seven in the evening in 24-hour clock time.",
      "What time is it 3 hours and 15 minutes after 14:00?",
      "How many months are there from the start of May to the end of August?",
      "A cake takes 35 minutes to bake. It goes in the oven at 4:30 pm. When is it ready?",
      "How many hours are there in a week?",
      "A clock's minute hand is on the IX and the hour hand is just before the V. What time is it?",
      "A school sports day starts at 9:30 am and finishes at 2:15 pm. How long does it last?",
      "How many days are in February in a leap year?",
      "What time is 45 minutes before 12:30 pm?",
      "Convert 150 minutes into hours and minutes.",
      "A boy's birthday is in October. His sister's is 3 months later. What month is her birthday?",
      "Write 00:30 in 12-hour clock format, using a.m. or p.m.",
      "A car is parked from Monday 9:00 am to Tuesday 9:00 am. How many hours is that?",
      "How many seconds are in one hour?",
      "A play is 2 hours and 5 minutes long. How many minutes is that?",
      "If the time is 20:50, how many minutes is it until 9 pm?",
      "What is the time shown by the Roman numerals XI on a clock face?"
    ],
    "Year 4": [
      "A train leaves at 14:20 and arrives at 15:05. How long is the journey?",
      "How many seconds are in 3 minutes?",
      "Convert 2 and a half hours into minutes.",
      "How many weeks are in a year?",
      "Change 150 minutes into hours and minutes.",
      "A film starts at 18:30 and is 1 hour 45 minutes long. What time does it finish?",
      "How many days are in 5 years, assuming one is a leap year?",
      "Change 200 seconds into minutes and seconds.",
      "Write 2:35 am in 24-hour clock time.",
      "A school day starts at 8:50 am and finishes at 3:20 pm. How long is the school day?",
      "How many months are in 3 and a half years?",
      "Convert 5 hours and 20 minutes into minutes only.",
      "What is 72 hours in days?",
      "A family sets off on a journey at 09:00. They stop for a 45-minute break and arrive at their destination at 13:15. How long were they driving for?",
      "Write quarter past five in the evening on a 24-hour digital clock.",
      "How many weeks are there in 6 months?",
      "A train was scheduled to arrive at 11:45 but arrived at 12:10. How many minutes late was it?",
      "Convert 3.5 minutes to seconds.",
      "A worker's shift is from 22:00 to 06:00. How long is the shift?",
      "If your birthday is on the 5th of April, how many days is it until the 1st of May?",
      "Change 48 months into years.",
      "A student spends 1 hour on English homework and 40 minutes on maths. How long is this in total?",
      "Read the time on an analogue clock and write it in 12-hour and 24-hour digital format.",
      "How many hours and minutes are there from 10:30 am to 1:15 pm?",
      "A tap drips once every 30 seconds. How many times will it drip in 5 minutes?",
      "Convert 5 days into hours.",
      "A TV series has 6 episodes, each 45 minutes long. What is the total running time?",
      "How many seconds are in 1 hour and 10 minutes?",
      "Write 11:15 pm in 24-hour format.",
      "A flight departs at 10:00 and lands at 14:30. How long is the flight?",
      "How many complete weeks are there in 50 days?",
      "A recipe says to simmer a sauce for 1.5 hours. How many minutes is that?",
      "A bus arrives every 20 minutes. If one arrives at 9:10 am, what time is the next one?",
      "How many years and months is 30 months?",
      "A car journey takes 3 hours and 25 minutes. If it ends at 16:00, when did it start?",
      "Write midnight in 24-hour clock format.",
      "How many minutes are in 4.5 hours?",
      "A school has 6 lessons a day, each 50 minutes long. How long is spent in lessons in hours and minutes?",
      "Convert 42 days into weeks.",
      "A train journey takes 2 hours 50 minutes. How many minutes is this?",
      "What is the time 8 hours after 17:00?",
      "How many seconds are in a quarter of an hour?",
      "Convert 2 years and 3 months into months.",
      "A meeting starts at 11:30 and lasts for 90 minutes. What time does it finish?",
      "How many days are there from the 3rd of June to the 1st of July?",
      "Write 1 minute 45 seconds purely in seconds.",
      "It takes 25 minutes to get to the cinema. The film starts at 17:00. What is the latest you can leave?",
      "How many hours are in 360 minutes?",
      "A worker starts at 07:30 and finishes at 15:30. They have a 45 minute break. How long do they work for?",
      "Convert 10 weeks into days."
    ],
    "Year 5": [
      "A flight takes off at 09:40 and lands at 13:25. How long is the flight in hours and minutes?",
      "If a recipe says to bake a cake for 55 minutes and it goes in the oven at 11:30 am, what time should it come out?",
      "How many days are in 3 years, including one leap year?",
      "A car race lasts for 3 hours and 45 minutes. The race starts at 1:15 pm. What time does it finish?",
      "Convert 2.5 days into hours.",
      "A concert starts at 7:45 pm and lasts for 2 hours and 20 minutes. What time does it end?",
      "A runner completed a race in 150 minutes. How many hours and minutes is that?",
      "How many seconds are in half an hour?",
      "A bus runs every 12 minutes. If the first bus is at 6:30 am, what time is the fourth bus?",
      "A plane journey takes 6.5 hours. If it lands at 14:00, what time did it take off?",
      "How many hours are in a fortnight?",
      "A project is due in 3 weeks. You estimate it will take 30 hours to complete. How many hours a day do you need to work on it if you work 5 days a week?",
      "Convert 1.25 hours into minutes.",
      "The time is 15:50. How long is it until 7 pm?",
      "A train journey from Manchester to London takes 2 hours and 10 minutes. If you need to be in London by 11:30 am, what is the latest train you can catch?",
      "How many minutes are there in a day?",
      "A satellite orbits the Earth every 90 minutes. How many orbits does it complete in 24 hours?",
      "Convert 10,000 seconds into hours, minutes, and seconds.",
      "A meeting is scheduled for 10:00 am and lasts 75 minutes. There is then a 20-minute break before the next meeting. What time does the second meeting start?",
      "Your friend in New York is 5 hours behind you. If it is 6 pm in London, what time is it in New York?",
      "How many days old will you be on your 10th birthday (don't forget leap years!)?",
      "A car is parked from 9:30 am on Monday to 1:00 pm on Tuesday. How many hours has it been parked?",
      "The school holidays are 6 weeks long. How many hours is this?",
      "A recipe requires a dough to rise for 45 minutes, be kneaded for 10, and then rise again for 1 hour 15 minutes. What is the total time required?",
      "If a movie is 135 minutes long, what is its running time in hours and minutes?",
      "How many hours and minutes are there in 200 minutes?",
      "A train leaves at 08:55 and arrives at 11:40. How long did the journey take?",
      "Convert 3.5 weeks into days.",
      "A worker's shift is 8.5 hours long. How many minutes is this?",
      "What is the time 50 minutes before 1:20 pm?",
      "How many decades are in 250 years?",
      "A car is driven for 45 minutes every day. How many hours is this in a week?",
      "Convert 1000 hours into days and hours.",
      "A ferry sails at 23:15 and docks at 06:50 the next day. How long is the crossing?",
      "How many seconds are there in 1.75 minutes?",
      "A TV series has a total running time of 8 hours. If each episode is 40 minutes long, how many episodes are there?",
      "What is the time in Tokyo if it is 8 hours ahead of London and the time in London is 15:00?",
      "Convert 500 days into years, weeks, and days (assume a non-leap year).",
      "A battery lasts for 36 hours. How many days is this?",
      "How many minutes are there from 10:40 am on Tuesday to 1:10 pm on Tuesday?",
      "A historical period lasted for 150 years. How many decades is that?",
      "Convert 450 seconds into minutes and seconds.",
      "The summer holidays last for 44 days. How many weeks and days is this?",
      "A plane is delayed by 2 hours and 35 minutes. Its original departure time was 19:50. What is the new departure time?",
      "How many minutes are in 0.25 of an hour?",
      "A project takes 100 hours to complete. If a team of 4 people work on it, and each works for 5 hours a day, how many days will it take?",
      "Convert 3600 seconds into hours.",
      "A train was due at 16:30. It arrived 75 minutes late. What time did it arrive in 24-hour format?",
      "How many centuries are in a millennium?",
      "A person sleeps for 8 hours a night. How many hours do they sleep in a year?"
    ]
  },
  "convert_between_metric_units": {
    "Year 5": [
      "How many metres are in 3.5 kilometres?",
      "Convert 2500 grams into kilograms.",
      "A bottle contains 1.5 litres of water. How many millilitres is this?",
      "Change 45mm into centimetres.",
      "A piece of wood is 2.2 metres long. What is its length in centimetres?",
      "How many grams are in 4.5 kilograms?",
      "A ribbon is 1.8 metres long. How many centimetres is this?",
      "Convert 75mm into centimetres.",
      "A bucket holds 3.2 litres. What is its capacity in millilitres?",
      "A marathon is approximately 42 kilometres long. How many metres is this?",
      "Change 560cm into metres.",
      "A recipe uses 250g of butter. How many kilograms is this?",
      "A bottle of shampoo holds 0.4 litres. How many millilitres is this?",
      "A tower is 0.15km high. What is its height in metres?",
      "A small insect is 0.8cm long. How long is it in millimetres?",
      "Convert 1250ml to litres.",
      "An athlete runs 5000m. How many kilometres has he run?",
      "A bag of sweets weighs 0.125kg. What is the weight in grams?",
      "A fence panel is 180cm wide. What is its width in metres?",
      "A medicine dose is 5ml. A bottle contains 0.1 litres. How many doses are in the bottle?",
      "A room is 4.2m long. What is this measurement in centimetres?",
      "Change 3400g to kilograms.",
      "A journey is 3200m. How far is this in kilometres?",
      "Convert 2.75 litres into millilitres.",
      "A stack of paper is 4.5cm thick. What is the thickness in millimetres?",
      "A car travels 8km. How many metres is this?",
      "A bag of flour weighs 1.2kg. How many grams is this?",
      "A jug contains 750ml of juice. What is this in litres?",
      "Convert 1.5cm into millimetres.",
      "How many metres are in 250cm?",
      "A box weighs 3500g. What is its mass in kilograms?",
      "How many millilitres are in a 2-litre bottle of pop?",
      "A pencil is 15cm long. What is its length in millimetres?",
      "How many kilometres is 4500m?",
      "A recipe calls for 0.5kg of sugar. How many grams do you need?",
      "A swimming pool contains 50,000 litres of water. How many kilolitres is this?",
      "A piece of wire is 2.05m long. Write this length in centimetres.",
      "Convert 850g into kilograms.",
      "A can of soup holds 0.4 litres. How many millilitres is this?",
      "An ant is 6mm long. What is this in centimetres?",
      "A road is 12km long. What is this distance in metres?",
      "A baby weighs 4.1kg at birth. What is this weight in grams?",
      "Convert 325ml into litres.",
      "A door is 198cm high. What is its height in metres?",
      "A sheet of paper is 0.1mm thick. What is this in centimetres?",
      "A running track is 400m. How many laps is a 10km race?",
      "A baker uses 25g of yeast. What is this amount in kilograms?",
      "A fish tank holds 65 litres of water. A bucket holds 5000ml. How many buckets to fill the tank?",
      "A bridge has a weight limit of 7.5 tonnes. How many kilograms is this?",
      "A journey is 250km. How many metres is that?"
    ]
  },
  "convert_metric_imperial": {
    "Year 4": [
      "How many metres are there in a kilometre?",
      "How many minutes are in an hour?",
      "A road is 3km long. How many metres is that?",
      "A film is 120 minutes long. How many hours is that?",
      "A runner runs 5000m. How many kilometres has she run?",
      "A road is 5km long. How many metres is this?",
      "A lesson is 1 hour long. How many minutes is this?",
      "How many metres in 2.5 kilometres?",
      "A film lasts 90 minutes. How many hours and minutes is this?",
      "A runner does a 10km race. How many metres is this?",
      "How many minutes in 3 hours?",
      "Convert 1500m to km.",
      "Change 180 minutes to hours.",
      "A lorry drives 20km. How many metres did it travel?",
      "An exam is 2 hours long. How many minutes do the students have?",
      "A walk is 3000m long. What is this in km?",
      "A TV series is 6 hours long in total. How many minutes is that?",
      "Convert 7km into metres.",
      "How many hours in 240 minutes?",
      "A cyclist travels 15,000m. Convert this to km.",
      "How many minutes in a school day that lasts 6 hours?",
      "If you walk 1km to school and 1km back, how many metres do you walk in total?",
      "Change 30 minutes into a fraction of an hour.",
      "A bridge is 1.2km long. What is its length in metres?",
      "A meeting lasted 75 minutes. How much more than an hour was that?",
      "How many metres are in half a kilometre?",
      "A TV show is 45 minutes long. How much of an hour is this?",
      "A journey is 10km. How many metres is that?",
      "Convert 2 hours 30 minutes into minutes.",
      "A mountain is 3km high. What is its height in metres?",
      "How many hours in a day?",
      "Convert 7500m to kilometres and metres.",
      "A football match is 90 minutes long. How many hours is this?",
      "How many minutes are in 1.5 hours?",
      "A running race is 5km. How many metres do the athletes run?",
      "Change 240 seconds to minutes.",
      "A flight is 4 hours long. How many minutes is the plane in the air?",
      "A river is 8km long. What is this in metres?",
      "How many hours are there in 300 minutes?",
      "Convert 1km and 200m into metres.",
      "A school break is 15 minutes long. What fraction of an hour is this?",
      "How many metres in 1.1km?",
      "A worker's shift is 8 hours. How many minutes do they work?",
      "Change 2.5km into metres.",
      "How many hours and minutes is 100 minutes?",
      "A fence is 20m long. A field is 1km long. How many fences would fit along the field?",
      "Convert 360 minutes into hours.",
      "A film is 2.5 hours long. How many minutes is that?",
      "A cyclist rides for 20km. How many metres is this?",
      "How many seconds in 2 minutes?"
    ],
    "Year 5": [
      "If 1 inch is about 2.5 cm, how many centimetres are in 6 inches?",
      "A bag of sugar weighs 2.2 pounds (lbs). Approximately how many kilograms is this if 1 kg is about 2.2 lbs?",
      "A recipe requires 1 pint of milk. You have a 1-litre carton. Do you have enough? (1 litre â 1.75 pints).",
      "A car is travelling at 50 miles per hour. Is it going faster or slower than a car travelling at 80 kilometres per hour? (5 miles â 8 km).",
      "A man is 6 feet tall. Approximately what is his height in metres? (1 foot â 30cm).",
      "The speed limit is 30 miles per hour. What is this approximately in kilometres per hour? (5 miles â 8 km).",
      "A ruler is 12 inches long. Approximately how long is it in centimetres? (1 inch â 2.5 cm).",
      "A boxer weighs 14 stone. If 1 stone is 14 pounds, what is his weight in pounds?",
      "A recipe asks for 4 ounces of flour. If 1 ounce is about 28g, how many grams do you need?",
      "A garden is 10 yards long. What is this in feet? (1 yard = 3 feet).",
      "A car has a 10-gallon petrol tank. Approximately how many litres is this? (1 gallon â 4.5 litres).",
      "A door is 2 metres high. Is it taller than a man who is 6 feet tall? (1 foot â 30cm).",
      "A bag of potatoes weighs 5 lbs. Approximately what is this in kg? (1 kg â 2.2 lbs).",
      "I need 2 pints of milk. The shop only sells it in litres. Should I buy a 1-litre or 2-litre carton? (1 litre â 1.75 pints).",
      "A road sign says the next town is 16km away. Approximately how many miles is this?",
      "A baby weighs 8 pounds at birth. What is this in ounces? (1 pound = 16 ounces).",
      "A marathon is about 26 miles. A local fun run is 10km. How many fun runs would equal the distance of a marathon?",
      "A table is 4 feet long. What is its length in inches?",
      "A vet weighs a dog and it is 15kg. Approximately what is its weight in pounds?",
      "An American tourist asks for a pint of beer. The barman serves him 500ml. Is this more or less than a pint?",
      "My waist measurement is 32 inches. What is this in cm?",
      "A bottle of perfume holds 50ml. What is this in fluid ounces? (1 fl oz â 28ml).",
      "A plane flies at an altitude of 30,000 feet. What is this in miles? (1 mile = 5280 feet).",
      "A recipe requires the oven to be at 400Â°F. Your oven is in Celsius. What should you set it to?",
      "The USA measures distance in miles and the UK in miles, but most of Europe uses kilometres. Discuss the advantages of a single system.",
      "A baby weighs 7 pounds. Approximately how many grams is this? (1 pound â 450g)",
      "A carton of juice holds 2 pints. Is this more or less than 1 litre?",
      "A road speed limit is 40 mph. What is this approximately in km/h?",
      "A piece of wood is 3 feet long. How many inches is that?",
      "A car's fuel efficiency is 50 miles per gallon. Approximately what is this in km per litre?",
      "A person is 5 feet 10 inches tall. What is their approximate height in centimetres?",
      "A bag of flour weighs 4 lbs. How many ounces is this?",
      "A US travel guide says a journey is 100 miles. Your car's odometer is in km. What distance should you look for?",
      "A recipe calls for 8 fluid ounces of cream. You have a 250ml pot. Is it enough?",
      "A parcel has a weight limit of 5kg. Your parcel weighs 10 lbs. Can you post it?",
      "The length of a football pitch is 100 yards. What is this in feet?",
      "A pint of milk costs 60p. A litre of milk costs Â£1. Which is better value if you need 2 litres?",
      "The distance to the moon is about 238,900 miles. What is this in km?",
      "A boxer needs to be under 12 stone to fight. He weighs 75kg. Does he qualify? (1 stone â 6.35kg)",
      "A plank of wood is 2 inches thick. What is this in mm?",
      "A car is travelling at 100 km/h. Is it breaking the UK speed limit of 70 mph?",
      "A recipe from the US uses cups. 1 cup is about 240ml. How many ml in 3 cups?",
      "A farm is 50 acres in size. Is this bigger or smaller than 25 hectares? (1 hectare â 2.5 acres)",
      "An athlete weighs 150 pounds. What is this in stone and pounds?",
      "A bottle of wine holds 75cl. A US bottle holds 25 fluid ounces. Which is larger?",
      "A mountain is 14,000 feet high. How high is this in metres?",
      "A car journey in France is 300km. Approximately how many miles is this?",
      "A steak weighs 8 ounces. What is this in grams?",
      "A garden hose is 50 feet long. Your garden is 15 metres long. Is the hose long enough?",
      "A fish tank holds 20 US gallons. How many litres is that approximately? (1 US gallon â 3.8 litres)"
    ],
    "Year 6": [
      "The distance between two cities is 150 miles. What is this distance in kilometres? (5 miles â 8 km).",
      "A suitcase weighs 23kg. Convert this weight to grams.",
      "A bottle holds 750ml of liquid. What is this in litres?",
      "A marathon is approximately 26 miles. How many kilometres is this?",
      "A car's petrol tank holds 50 litres. Approximately how many gallons is this? (1 gallon â 4.5 litres).",
      "A car travels at an average speed of 40 mph. How long will it take to travel 100 miles?",
      "Convert 2.5kg into grams.",
      "A bottle contains 0.33 litres of water. What is this in millilitres?",
      "Change 1.75m into centimetres.",
      "The distance from London to Edinburgh is approximately 400 miles. What is this in km?",
      "A parcel weighs 3200g. Convert this to kg.",
      "A recipe needs 250ml of cream. The tub contains 0.5 litres. What fraction of the tub is used?",
      "Convert 5 feet and 10 inches into inches only. Then, convert this to cm.",
      "A swimmer swims 20 lengths of a 50m pool. How far is this in kilometres?",
      "A lorry has a maximum load weight of 7.5 tonnes. How many kilograms is this?",
      "Convert a speed of 60km/h into metres per minute.",
      "A piece of wood is 1.05m long. What is its length in millimetres?",
      "An athlete runs 100 metres in 10 seconds. What is their speed in km/h?",
      "A petrol tank holds 55 litres. If the car uses 8 litres per 100km, how far can it travel on a full tank?",
      "Change 4.5 litres into cmÂ³. (1 litre = 1000 cmÂ³).",
      "A map has a scale where 1cm represents 2km. The distance on the map is 8.5cm. What is the real distance?",
      "A baby weighs 3.45kg. What is this weight in grams?",
      "The Earth's circumference is approximately 24,901 miles. Convert this to kilometres.",
      "A medicine requires a dose of 2.5ml. How many doses can you get from a 0.25 litre bottle?",
      "Convert 1 square metre into square centimetres.",
      "A car is travelling at 50 mph. How many miles does it travel in 1 hour and 30 minutes?",
      "Convert 3.2km into metres.",
      "A jug holds 1.5 litres. 400ml is poured out. How much is left in litres?",
      "A person is 6 feet 2 inches tall. What is their approximate height in cm? (1 inch â 2.54cm)",
      "The speed of light is approximately 300,000 km per second. How far does it travel in a minute?",
      "A field is 2.5 hectares. How many square metres is this? (1 hectare = 10,000 mÂ²)",
      "Convert 0.75kg into grams.",
      "A journey of 200 miles starts with a full 12-gallon tank of petrol. The car does 40 miles per gallon. How much petrol is left at the end?",
      "Change 1 hour 45 minutes into a decimal of hours.",
      "A box has a volume of 2.5mÂ³. How many litres can it hold? (1mÂ³ = 1000 litres)",
      "Convert a speed of 30 metres per second into kilometres per hour.",
      "A parcel weighs 4.5 lbs. What is its approximate weight in kilograms? (1kg â 2.2 lbs)",
      "A recipe needs 8 ounces of cheese. How many grams is this? (1 ounce â 28.35g)",
      "The area of a room is 20 square yards. What is this in square feet? (1 yard = 3 feet)",
      "Convert 1.2 cubic metres into cubic centimetres.",
      "A flight from London to New York is approximately 3460 miles. How long would this take at an average speed of 550 mph?",
      "A medicine dosage is 5ml per 10kg of body weight. What is the dose for a person weighing 11 stone? (1 stone â 6.35kg)",
      "Convert 25Â°C to Fahrenheit. F = (C * 9/5) + 32.",
      "A car travels 80km in 1 hour. How many metres does it travel in 1 second?",
      "The density of gold is 19.3 g/cmÂ³. What is the mass of a gold bar with a volume of 100cmÂ³?",
      "Convert 1 year into seconds.",
      "A pressure of 1 bar is approximately 14.5 psi. What is 30 psi in bar?",
      "The distance of a marathon (26.2 miles) is run by a top athlete in about 2 hours 5 minutes. What is their average speed in mph?",
      "A bottle contains 0.7 litres of liquid. What is this in millilitres?",
      "Convert 5 tonnes to kilograms."
    ]
  },
  "perimeter_area": {
    "Year 3": [
      "A square has sides of 5cm. What is its perimeter?",
      "A rectangle has a length of 8cm and a width of 4cm. What is its perimeter?",
      "Draw a shape with a perimeter of 12cm on squared paper.",
      "The school playground is a rectangle. One side is 20m long and the other is 15m long. What is the perimeter of the playground?",
      "If you walk all the way around a square park with sides of 50m, how far have you walked?",
      "The perimeter of a square is 20cm. How long is each side?",
      "Draw a rectangle with a perimeter of 14cm.",
      "A triangular field has sides of 30m, 40m, and 50m. What is its perimeter?",
      "Measure the perimeter of the cover of your reading book.",
      "An octagon has 8 equal sides of 3cm each. What is its perimeter?",
      "The school hall is a rectangle 30m long and 15m wide. What is its perimeter?",
      "I have a piece of string 25cm long. Can I use it to go all the way around a square with 6cm sides?",
      "Find the perimeter of a regular hexagon with sides of 10cm.",
      "The perimeter of a rectangle is 18cm. Its length is 6cm. What is its width?",
      "Walk around the edge of the school playground. You have just walked its perimeter.",
      "A farmer wants to put a fence around a field. The sides are 100m, 120m, 80m and 90m. How much fencing does he need?",
      "Measure the sides of a 50p coin and estimate its perimeter.",
      "Draw two different shapes that both have a perimeter of 16cm.",
      "The perimeter of an equilateral triangle is 21cm. How long is each side?",
      "A photo frame is 20cm long and 15cm wide. What is the total length of wood needed to make it?",
      "Find the perimeter of your classroom.",
      "A rectangle's perimeter is 22m. What could its length and width be?",
      "If I run around a square park twice and the side of the park is 100m, how far have I run?",
      "Measure the perimeter of a CD case.",
      "A garden is in the shape of a regular pentagon with sides of 8m. What is its perimeter?",
      "A triangle has sides of 6cm, 7cm and 8cm. What is its perimeter?",
      "Calculate the perimeter of a rectangle that is 10cm long and 5cm wide.",
      "A square garden has a perimeter of 24m. What is the length of one side?",
      "Measure the perimeter of a postcard.",
      "A five-sided shape has sides of 4cm, 5cm, 6cm, 4cm, and 5cm. What is the perimeter?",
      "A rectangular swimming pool is 25m long and 10m wide. What is its perimeter?",
      "The perimeter of a regular octagon is 40cm. How long is each side?",
      "Draw a shape on squared paper and calculate its perimeter by counting the squares around the edge.",
      "A book cover measures 20cm by 15cm. What is its perimeter?",
      "A farmer puts a fence around a square field. If one side is 120m, how much fencing is needed?",
      "An equilateral triangle has a perimeter of 30cm. What is the length of one side?",
      "A rectangular room is 5m long and 4m wide. What is the perimeter of the room?",
      "Find the perimeter of a hexagon with equal sides of 9cm.",
      "A shape has a perimeter of 18cm. All its sides are 3cm long. What is the shape?",
      "Measure the perimeter of the interactive whiteboard in your classroom.",
      "A rectangular photo has a length of 12cm and a width of 7cm. What is its perimeter?",
      "A square has a side length of 11m. What is its perimeter?",
      "A playground is a rectangle with a perimeter of 100m. If the length is 30m, what is the width?",
      "Calculate the perimeter of a triangle with sides 12cm, 15cm, and 17cm.",
      "A field has a perimeter of 200m. A farmer walks around it three times. How far does he walk?",
      "Draw an irregular shape and measure its perimeter.",
      "A rectangle has a perimeter of 26cm and a length of 8cm. Find its width.",
      "What is the perimeter of a regular pentagon with 6cm sides?",
      "Measure the perimeter of a tablet or phone screen.",
      "A dog lead is 2m long. If you use it to make a square on the ground, what is the perimeter?"
    ],
    "Year 4": [
      "Find the area of a rectangle with sides 6cm and 4cm by counting squares.",
      "Calculate the perimeter of a rectangle that is 12m long and 5m wide.",
      "A square has a perimeter of 24cm. What is the length of one of its sides?",
      "Draw a rectilinear shape on squared paper and find its area and perimeter.",
      "A farmer's field is 100m long and 50m wide. What is its perimeter?",
      "A square has an area of 25cmÂ². What is the length of its side?",
      "A rectilinear shape is made of two rectangles. One is 3cm by 4cm, the other is 5cm by 2cm. What is the total area?",
      "Find the area of your classroom floor in square metres (by counting floor tiles or measuring).",
      "A swimming pool is 25m long and 10m wide. What is its perimeter?",
      "The area of a rectangle is 24mÂ². What could its length and width be? Give two examples.",
      "On squared paper, draw a shape with an area of 15 squares and find its perimeter.",
      "A football pitch is 100m long and 60m wide. What is its area?",
      "Find the perimeter of an L-shaped room with given dimensions.",
      "A garden has an area of 30mÂ². A patio with an area of 5mÂ² is built in it. What is the area of the remaining garden?",
      "Draw a shape that has a perimeter of 20cm and an area of 9cmÂ².",
      "The perimeter of a square is 32cm. What is its area?",
      "A window is made of 12 square panes of glass. Each pane is 20cm by 20cm. What is the total area of the window?",
      "Find the area of the letter 'T' drawn on 1cm squared paper.",
      "A wall is 5m long and 3m high. What is its area?",
      "A rug is 2m by 3m. Will it fit in a room with an area of 10mÂ²?",
      "Calculate the perimeter of a cross shape made from 5 squares, each with a side of 3cm.",
      "Find the area of a photograph that is 6 inches by 4 inches.",
      "A farmer has 40m of fencing. What is the largest rectangular area he can enclose?",
      "A rectangle has a length of 9cm and a perimeter of 30cm. What is its area?",
      "Count the squares to find the approximate area of a circle drawn on squared paper.",
      "A rectangular garden is 15m long and 10m wide. What is its perimeter and area?",
      "Find the area of an L-shaped room by splitting it into two rectangles.",
      "The area of a square is 49cmÂ². What is its perimeter?",
      "Draw a rectilinear shape with an area of 18 squares. What is its perimeter? Can you draw another with the same area but a different perimeter?",
      "A piece of paper is 30cm long and 20cm wide. What is its area?",
      "Calculate the perimeter of a rectilinear shape with sides of 8m, 5m, 3m, 2m, 5m and 3m.",
      "A floor is tiled with square tiles. If the floor is 10 tiles long and 8 tiles wide, what is the area in tiles?",
      "A rectangle has a perimeter of 28cm. Its width is 4cm. What is its length and area?",
      "Find the area of the letter 'H' on squared paper.",
      "A dog run is 12m long and 3m wide. What is its area?",
      "The perimeter of a rectangular field is 180m. The length is 50m. What is the width?",
      "Count the squares to find the area of an irregular shape like a leaf.",
      "A small patio is made of 30 square slabs, each 1m by 1m. What is the area of the patio?",
      "A square has a perimeter of 44cm. What is its area?",
      "A room is 6m by 4m. A rug in the room is 3m by 2m. What is the area of the floor not covered by the rug?",
      "Calculate the area of a composite shape made from a 5cm x 5cm square and a 3cm x 2cm rectangle.",
      "A school hall has a perimeter of 80m. It is 25m long. What is its width and area?",
      "Find the area of the letter 'E' drawn on 1cm grid paper.",
      "A rectangular vegetable patch is 8m long and has an area of 40mÂ². What is its width?",
      "Calculate the perimeter of a 'plus' sign shape made from 5 identical squares of side 2cm.",
      "A swimming pool is 25m long and 12m wide. What is the area of the water's surface?",
      "A rectangle has an area of 36cmÂ². What are the possible whole number lengths and widths?",
      "Find the area of a rectilinear shape by subtracting a missing part from a larger rectangle.",
      "The area of a square is 81mÂ². What is the length of its side?",
      "A path is 10m long and 2m wide. What is its area?"
    ],
    "Year 5": [
      "A composite rectilinear shape is made from two rectangles. One is 5cm by 3cm and the other is 6cm by 4cm. What is the total area?",
      "Calculate the perimeter of an L-shaped room with given side lengths.",
      "The area of a square is 36cmÂ². What is the length of one of its sides?",
      "Estimate the area of an irregular shape (like a leaf) by drawing it on squared paper and counting the squares.",
      "A rectangle has a perimeter of 30m. If its length is 10m, what is its width?",
      "Calculate the area of a rectangle with a length of 12m and a width of 7m.",
      "The perimeter of a regular hexagon is 48cm. What is the length of one side?",
      "A composite shape is formed by a 5m x 5m square and a 3m x 8m rectangle. Find its total area and perimeter.",
      "A rectangular field is 80m long and has a perimeter of 260m. What is its width?",
      "Draw an irregular shape and estimate its area by counting squares.",
      "The area of a rectangle is 45cmÂ². Its width is 5cm. What is its length and perimeter?",
      "Compare the areas of two school playing fields. Which is larger?",
      "A room is 5.5m long and 4m wide. What is its area?",
      "A path 1m wide is built around a rectangular lawn that is 10m by 8m. What is the area of the path?",
      "A square has an area of 64mÂ². What is its perimeter?",
      "Calculate the perimeter of a shape made of two equilateral triangles joined along one side, where each side is 6cm.",
      "A tablecloth measures 2m by 1.5m. What is its area?",
      "Estimate the area of your hand in cmÂ².",
      "A rectangular swimming pool has an area of 250mÂ². If it is 25m long, how wide is it?",
      "A small photo is 10cm by 15cm. It is enlarged so each side is doubled. What is the new area and perimeter?",
      "A garden is L-shaped. The lengths of the six sides are given. Calculate the perimeter and area.",
      "Find the area of a classroom with dimensions 7.2m by 8.5m.",
      "The perimeter of a rectangle is 34cm. Its area is 60cmÂ². What are its dimensions?",
      "A piece of A4 paper is approximately 30cm by 21cm. What is its approximate area?",
      "A wall is 6m by 2.5m. A door in the wall is 2m by 0.8m. What is the area of the wall to be painted?",
      "Calculate the area of a rectangle that is 1.5m long and 0.8m wide.",
      "A square has a perimeter of 100cm. What is its area?",
      "A composite shape is made of a rectangle 10cm by 6cm, with a square of side 3cm removed from one corner. What is the area and perimeter of the new shape?",
      "Estimate the area of a puddle by drawing it on squared paper.",
      "A football pitch has an area of 7140mÂ². It is 105m long. What is its width?",
      "The perimeter of a regular octagon is 64cm. What is the length of one side?",
      "Calculate the area of a room that is 4.5m by 3.5m.",
      "A rectangular garden is 20m long. Its area is 300mÂ². Find the perimeter of the garden.",
      "A shape is made from three identical squares of side 5cm joined in a row. What is the perimeter of the shape?",
      "Estimate the area of a local park in square metres.",
      "The area of a square is 144cmÂ². What is its perimeter?",
      "A rectangular swimming pool is 25m by 10m. It is surrounded by a path that is 2m wide. What is the area of the path?",
      "Calculate the perimeter of a composite rectilinear shape with given side lengths.",
      "A rectangle has an area of 0.5mÂ². What could its dimensions be in cm?",
      "A farmer has a field that is 120m by 80m. What is its area in square metres?",
      "A window is 1.2m wide and 1.5m high. What is its area?",
      "The perimeter of a rectangular room is 18m. Its length is 5.5m. What is its area?",
      "A composite shape has an area of 50cmÂ². It is made of two rectangles. One has an area of 20cmÂ². What is the area of the second?",
      "Estimate the surface area of a large lake.",
      "A square piece of card has a perimeter of 60cm. What is its area?",
      "A kitchen floor is 5m by 3m. Floor tiles are 50cm by 50cm. How many tiles are needed?",
      "Calculate the perimeter and area of a T-shaped room.",
      "A rectangle has an area of 48cmÂ² and a perimeter of 28cm. What are its dimensions?",
      "A wall is 7m long and 2.5m high. A window on the wall is 1.5m by 1m. What is the area of the brickwork?",
      "A regular pentagon has a perimeter of 75cm. How long is each side?"
    ],
    "Year 6": [
      "Calculate the area of a triangle with a base of 10cm and a height of 6cm.",
      "A parallelogram has a base of 8m and a perpendicular height of 5m. What is its area?",
      "A shape has an area of 20cmÂ². Can you draw two different shapes (a rectangle and a triangle) that both have this area?",
      "The living room in a house is a rectangle 6m long and 4m wide. The hallway is a rectangle 5m long and 1.5m wide. What is the total area of both rooms?",
      "Recognise that a rectangle with a perimeter of 16cm could have sides of 4cm and 4cm (area 16cmÂ²) or 6cm and 2cm (area 12cmÂ²).",
      "A triangle has an area of 24cmÂ² and a base of 8cm. What is its perpendicular height?",
      "Find the area of a parallelogram with a base of 12m and a height of 7m.",
      "Draw two different rectangles that both have a perimeter of 18cm. Which one has the larger area?",
      "Calculate the area of a right-angled triangle with sides 5cm, 12cm, and 13cm.",
      "The area of a parallelogram is 50mÂ². Its height is 4m. What is the length of its base?",
      "A triangular sail has a base of 4m and a height of 5m. What is its area?",
      "A shape is made from a rectangle and a triangle. Calculate the total area.",
      "A garden is in the shape of a parallelogram. The base is 15m and the perpendicular distance between the parallel sides is 10m. What is the area of the garden?",
      "A rhombus can be split into two identical triangles. Find the area of a rhombus with given diagonal lengths.",
      "Compare the area of a square with side length 4cm and a triangle with base 8cm and height 4cm.",
      "A logo is designed using a triangle and a parallelogram. Find its total area.",
      "A field in the shape of a triangle has a base of 100m and a height of 60m. What is its area in square metres?",
      "Can a triangle have the same area as a parallelogram? Explain how.",
      "The two parallel sides of a trapezium are 10cm and 14cm, and the height is 6cm. Find its area.",
      "A rectangular room has an area of 24mÂ². A triangular rug placed in the room has an area of 6mÂ². What fraction of the floor is covered by the rug?",
      "Find the area of a composite shape made from three different triangles.",
      "A kite is made from two triangles. One has a height of 20cm and the other 40cm. Both have a base of 30cm. What is the total area?",
      "The perimeter of a rectangle is 28cm. The area of a triangle is 12cmÂ². Can you determine if one is larger than the other?",
      "A plot of land is a parallelogram with a base of 50m. The area is 1000mÂ². What is its perpendicular height?",
      "Explain why two shapes can have the same area but different perimeters.",
      "A right-angled triangle has a base of 7cm and a height of 8cm. What is its area?",
      "The area of a triangle is 30mÂ². Its height is 6m. What is the length of its base?",
      "A parallelogram has an area of 45cmÂ² and a base of 9cm. What is its perpendicular height?",
      "A rectangular garden is 12m by 8m. A triangular pond with a base of 4m and height of 3m is in the middle. What is the area of the grass?",
      "Draw a rectangle with a perimeter of 24cm and the largest possible area.",
      "A triangular piece of paper has a height of 15cm and a base of 10cm. What is its area?",
      "The area of a parallelogram is 72mÂ². What could its base and height be? (Give two examples).",
      "A shape is made of a 10cm x 8cm rectangle with a triangle of base 8cm and height 5cm on top. What is the total area?",
      "True or false: If you double the sides of a rectangle, you double its area and its perimeter.",
      "Find the area of a triangle with a base of 2.5m and a height of 4m.",
      "A parallelogram has a perimeter of 30cm. Two of its sides are 10cm long. What are the lengths of the other two sides?",
      "A garden is a trapezium with parallel sides of 20m and 30m, and a height of 15m. What is its area?",
      "A shape with an area of 100cmÂ² can have different perimeters. Give an example of two shapes.",
      "The side of a building is a triangle on top of a square. The square is 10m x 10m. The triangle has a base of 10m and a height of 6m. Find the total area.",
      "The area of a triangle is 18cmÂ². Its base and height are equal. What is their length?",
      "Calculate the area of a parallelogram with a base of 1.5m and a height of 2m.",
      "A rectangular flag is 3m by 2m. It has a diagonal stripe that forms two triangles. What is the area of each triangle?",
      "A room is a rectangle (5m x 4m) with a triangular bay window (base 3m, height 1.5m). What is the total floor area?",
      "Why is the area of a triangle half of base times height?",
      "Find the area of a rhombus with diagonals of 10cm and 16cm.",
      "A rectangular field has an area of 1 hectare (10,000mÂ²). It is 200m long. What is its perimeter?",
      "A triangle and a parallelogram have the same base and the same area. What is the relationship between their heights?",
      "The perimeter of a rectangle is the same as the perimeter of a 10cm side square. The rectangle is 12cm long. What is its area?",
      "Find the area of a composite shape by enclosing it in a larger rectangle and subtracting the missing parts."
    ]
  },
  "volume": {
    "Year 5": [
      "Using 1cmÂ³ blocks, build a cuboid that is 3 blocks long, 2 blocks wide, and 2 blocks high. What is its volume?",
      "Estimate which of two containers has a greater capacity by pouring water from one to the other.",
      "If a box has a volume of 24cmÂ³, what could its dimensions be?",
      "Look at a picture of a cuboid made from centimetre cubes. Can you work out its volume?",
      "Estimate the volume of your lunchbox.",
      "How many 1cmÂ³ cubes would you need to make a 2cm by 3cm by 4cm cuboid?",
      "Estimate the capacity of a drinking glass in millilitres.",
      "If you have 100 centimetre cubes, what are the dimensions of three different cuboids you could make?",
      "A box is filled with 1cmÂ³ cubes. It has 4 layers and each layer has 12 cubes. What is the volume?",
      "Look at a carton of juice. What is its volume/capacity as written on the label?",
      "Estimate the volume of your pencil case.",
      "A fish tank is a cuboid. You pour in 10 litres of water. What is the volume of the water in cmÂ³?",
      "Build a shape with a volume of 18cmÂ³ using interlocking cubes.",
      "Estimate, then measure, how many spoonfuls of rice it takes to fill a small container.",
      "A Rubik's cube is 3x3x3 small cubes. What is its volume in cubes?",
      "If a cuboid has a volume of 30cmÂ³, what could its length, width and height be?",
      "Estimate the volume of a shoebox.",
      "Compare the capacity of a mug and a teacup. Which holds more?",
      "A box contains 16 smaller cubes. What could the arrangement of cubes be?",
      "A jug holds 1 litre of water. If you pour out 300ml, what volume of water is left?",
      "Build a cube with side lengths of 4cm using 1cmÂ³ blocks. How many blocks did you use?",
      "Estimate the volume of a brick.",
      "If 500ml of water is poured into a 1-litre container, what percentage of the container is full?",
      "A pack of sugar cubes contains 48 cubes arranged in a cuboid shape. What could the dimensions of the pack be?",
      "Does a larger object always have a larger volume? Discuss (e.g., a beach ball vs a brick).",
      "A cuboid is made from 36 centimetre cubes. What could its length, width and height be?",
      "Estimate the capacity of a bathtub in litres.",
      "How many 1cmÂ³ cubes are needed to make a cube with sides of 5cm?",
      "A shape is made of 5 layers of cubes. Each layer is a 3 by 4 rectangle. What is the volume?",
      "Estimate the volume of a can of baked beans in cmÂ³.",
      "A box has a volume of 12 cubes. Sketch two possible cuboids with this volume.",
      "A swimming pool is half full. Its total capacity is 50,000 litres. What volume of water is in the pool?",
      "Build a shape with a volume of 20cmÂ³. How many cubes did you use?",
      "Estimate the volume of your classroom in cubic metres.",
      "A box is 10cm long, 5cm wide, and 4cm high. How many 1cmÂ³ cubes will it hold?",
      "If a cuboid has a volume of 40cmÂ³, give two sets of possible dimensions (length, width, height).",
      "Estimate the capacity of a car's petrol tank in litres.",
      "A large cube is made from 27 small cubes. What are the dimensions of the large cube?",
      "A glass contains 250ml of water. A jug contains 1 litre. Estimate how many glasses you can fill from the jug.",
      "A box of chocolates has two layers. Each layer has 12 chocolates. If each chocolate is roughly a 2cm cube, estimate the volume of the box.",
      "A cuboid is built with 30 cubes. The base is 5 cubes long and 2 cubes wide. How high is it?",
      "Estimate the volume of a single Lego brick.",
      "A paddling pool takes 10 buckets of water to fill. If a bucket holds 5 litres, what is the capacity of the pool?",
      "A shape has a volume of 16cmÂ³. Can it be a cube with whole number sides?",
      "Estimate the capacity of a cereal box in cmÂ³.",
      "A tower is made from 1cmÂ³ cubes. It is 8 cubes high, 3 cubes long, and 3 cubes wide. What is its volume?",
      "Which has a larger volume: a football or a rugby ball? How could you test your estimate?",
      "A box can hold 100 sugar cubes. If the box is 10 cubes long and 5 cubes wide, how many layers are there?",
      "Estimate the volume of water you drink in a day.",
      "A cuboid has a volume of 72cmÂ³. Its length is 6cm and width is 4cm. How high is it?"
    ],
    "Year 6": [
      "Calculate the volume of a cuboid with a length of 8cm, a width of 5cm, and a height of 4cm.",
      "A cube has a side length of 6cm. What is its volume?",
      "A fish tank is 50cm long, 30cm wide, and 20cm high. What is its volume in cmÂ³?",
      "How many 1cmÂ³ cubes would you need to make a 3cm by 3cm by 3cm cube?",
      "A box has a volume of 60mÂ³. If its length is 5m and its width is 4m, what is its height?",
      "A cereal box has dimensions of 20cm by 30cm by 5cm. What is its volume?",
      "Find the volume of a cube with edges of 10cm.",
      "A swimming pool is 25m long, 10m wide, and 2m deep. What volume of water does it hold in cubic metres?",
      "The volume of a cuboid is 72cmÂ³. Its length is 6cm and its width is 3cm. What is its height?",
      "How many 1cmÂ³ cubes can fit into a box that is 10cm by 5cm by 4cm?",
      "A concrete block has a volume of 8000cmÂ³. What is this in litres?",
      "Compare the volume of a cube with 5cm sides and a cuboid measuring 4cm x 5cm x 6cm.",
      "An aquarium is 60cm long, 30cm wide, and 40cm high. If it is half full, what is the volume of the water?",
      "A lorry's container is 10m long, 2.5m wide, and 3m high. What is its volume?",
      "A small box has a volume of 100cmÂ³. A large box has dimensions that are double the small box. What is the volume of the large box?",
      "A wooden beam is 2m long, 10cm wide, and 5cm thick. Find its volume in cmÂ³.",
      "A storage unit has a volume of 30mÂ³. What could its dimensions be?",
      "Calculate the volume of your classroom in cubic metres.",
      "A set of 4 identical books forms a stack that is 20cm long, 15cm wide and 12cm high. What is the volume of a single book?",
      "A cube has a volume of 125cmÂ³. What is the length of one of its sides?",
      "A removal van has a storage space of 25mÂ³. Can it fit the contents of a flat with a total volume of 22mÂ³?",
      "A fish tank has a base area of 2000cmÂ². If water is poured in to a depth of 30cm, what is the volume of the water?",
      "Convert 1 cubic metre (mÂ³) into cubic centimetres (cmÂ³).",
      "A block of cheese is a cuboid measuring 10cm x 8cm x 5cm. If a piece with a volume of 80cmÂ³ is cut off, what is the volume of the remaining cheese?",
      "Estimate the volume of air in a bus.",
      "A cuboid has a length of 1.5m, a width of 0.5m, and a height of 1m. What is its volume in mÂ³?",
      "What is the volume of a cube with a side length of 20mm?",
      "A shipping container is 12m long, 2.5m wide, and 3m high. What is its volume?",
      "The volume of a box is 200cmÂ³. Its base is 10cm by 5cm. What is its height?",
      "How many 2cm x 2cm x 2cm cubes could fit into a 10cm x 10cm x 10cm box?",
      "A garden bed is 5m long, 1m wide, and 0.5m deep. What volume of soil is needed to fill it in cubic metres?",
      "A cube has a volume of 27mÂ³. What is the length of one of its edges?",
      "A paddling pool is 2m long, 1.5m wide, and is filled to a depth of 0.4m. What is the volume of water in the pool?",
      "A box of tea bags is 14cm long, 7cm high, and 5cm wide. Calculate its volume.",
      "A lorry can carry a volume of 60mÂ³. How many boxes with a volume of 1.5mÂ³ can it carry?",
      "A room has a volume of 75mÂ³. It is 5m long and 5m wide. How high is the ceiling?",
      "Calculate the volume of a cube with a side length of 0.5m. Give your answer in cmÂ³.",
      "A block of ice measures 30cm by 20cm by 15cm. What is its volume?",
      "A fish tank has a volume of 90 litres. What could its dimensions be in cm? (1 litre = 1000cmÂ³)",
      "A cube has a surface area of 54cmÂ². What is its volume?",
      "A swimming pool is 50m long and 20m wide. If it holds 1500mÂ³ of water, what is its average depth?",
      "What is the volume of a cuboid with dimensions 12mm, 2cm, and 0.5m? Give your answer in cmÂ³.",
      "The volume of a large box is 1mÂ³. The volume of a small box is 1cmÂ³. How many small boxes fit in the large one?",
      "A water tank is 3m long, 2m wide and 1.5m high. It is 2/3 full. What is the volume of water in the tank?",
      "A cuboid has a volume of 300cmÂ³. Its length is 10cm and its height is 5cm. What is its width?",
      "Estimate, then calculate, the volume of a refrigerator.",
      "A cube has a volume of 1000cmÂ³. What is the area of one of its faces?",
      "A sandpit is 2.5m by 2m by 0.3m. What is the volume of sand it can hold?",
      "Two cuboids have the same volume. One is 4x5x6cm. The other has a base of 3x5cm. What is its height?",
      "Calculate the volume of air in your classroom in cubic metres."
    ]
  },
  "solve_problems_money_length_mass_weight_capacity_volume": {
    "Year 2": [
      "I have 50p. I buy an apple for 20p. How much money do I have left?",
      "A ribbon is 30cm long. I cut off 10cm. How much is left?",
      "A bag of sweets weighs 100g. I eat 30g. What is the weight of the sweets left in the bag?",
      "A cup holds 200ml of water. If I drink half of it, how much is left?",
      "Leo has Â£20. He buys two cinema tickets that cost Â£7 each. How much money does he have left?",
      "A pencil costs 15p. A rubber costs 10p. How much for both?",
      "My plant was 8cm tall. It grew 5cm more. How tall is it now?",
      "I have a 100g bag of crisps. I share it equally with a friend. How many grams do we get each?",
      "A bottle holds 500ml of water. I drink 100ml. How much is left?",
      "I have Â£1. A book costs 80p. Do I have enough money? How much change?",
      "A piece of string is 25cm long. I need a piece 30cm long. How much more do I need?",
      "An apple weighs 90g. A banana weighs 110g. What is their total weight?",
      "A cup holds 150ml. How much do two cups hold?",
      "A comic costs 75p. I pay with three 20p coins and three 5p coins. Is this correct?",
      "A tower of blocks is 40cm high. I add 3 more blocks that are each 2cm high. What is the new height?",
      "A cake weighs 500g. If I cut it into 10 equal slices, how much does each slice weigh?",
      "A car has 4 wheels. How many wheels on 5 cars?",
      "I have 60p. Sweets are 5p each. How many can I buy?",
      "My sunflower is 1m tall. My friend's is 85cm tall. What is the difference in height?",
      "A bag contains 1kg of sugar. I use half of it. How many grams are left?",
      "A bottle of lemonade holds 1 litre. A glass holds 200ml. How many full glasses can I pour?",
      "I buy stickers for 25p and a pen for 30p. How much change from Â£1?",
      "A running track is 100m long. How far is it to run around it three times?",
      "A dog weighs 12kg. A cat weighs 5kg. How much heavier is the dog?",
      "A jug of juice holds 800ml. I pour 250ml into a glass. How much is left in the jug?",
      "A toy car costs 70p. How much change do I get from a Â£1 coin?",
      "A snake is 45cm long. It grows another 15cm. How long is it now?",
      "A bag of apples weighs 1kg. I take out two apples weighing 100g each. What is the new weight?",
      "A bucket holds 10 litres of water. I use 3 litres to water the plants. How much is left?",
      "I have Â£2. I buy a magazine for Â£1.50. How much do I have left?",
      "A fence is 10m long. I add another 5m section. What is the total length?",
      "A box of cereal weighs 500g. The box itself weighs 50g. What is the weight of the cereal?",
      "A can of pop holds 330ml. How much do two cans hold?",
      "I save 20p every day for 5 days. How much have I saved?",
      "My desk is 80cm wide. My friend's desk is 70cm wide. What is the difference?",
      "A bag of flour weighs 1kg. A recipe needs 200g. How much is left?",
      "A jug has 600ml of juice. I share it equally between 3 glasses. How much is in each glass?",
      "A ticket to the zoo costs Â£10. How much for a family of four?",
      "A plant is 25cm tall. It needs to grow another 25cm to reach the window. How high is the window?",
      "A bag of carrots weighs 500g. A bag of potatoes weighs 1kg. What is the total weight?",
      "A bottle contains 1 litre of water. I pour it into 100ml cups. How many cups can I fill?",
      "A teddy costs Â£5. A doll costs Â£8. What is the total cost?",
      "A piece of wool is 1m long. I cut it in half. How many cm is each piece?",
      "I have 2kg of dog food. My dog eats 100g a day. How many days will the food last?",
      "A swimming pool is 25m long. I swim two lengths. How far have I swum?",
      "A bar of chocolate costs 65p. How much change from Â£1?",
      "A tower is 50cm high. I take off a 10cm block. How high is it now?",
      "A recipe needs 100g of butter. I have a 250g block. How much is left?",
      "A watering can holds 2 litres. It is half full. How many ml of water are in it?",
      "A film is 90 minutes long. A TV show is 30 minutes long. What is the difference in duration?"
    ],
    "Year 3": [
      "A t-shirt costs Â£5.50 and a pair of shorts costs Â£4.75. How much do they cost altogether?",
      "My journey to school is 2km. I have walked 800m. How much further do I have to go?",
      "A baker has 1kg of flour. He uses 450g to make a cake. How much flour is left?",
      "A bottle of juice contains 1 litre. I pour out a 250ml glass. How much is left in the bottle?",
      "If I pay for a Â£2.80 magazine with a Â£5 note, how much change will I get?",
      "A CD costs Â£7.99. A DVD costs Â£9.50. What is the total cost?",
      "A plank of wood is 3m long. I cut off a piece that is 120cm. How much is left in metres?",
      "A recipe needs 350g of flour from a 1kg bag. How much flour will be left in the bag?",
      "I have a 2-litre bottle of cola. I drink 400ml. How much is left?",
      "I buy a book for Â£4.80 and pay with a Â£10 note. What is my change?",
      "A fence is made of panels that are 1.8m long. How long would a fence with 10 panels be?",
      "A baker makes 2kg of dough. He divides it into 10 equal loaves. What is the weight of each loaf in grams?",
      "A car's petrol tank holds 50 litres. It currently contains 15 litres. How much is needed to fill it?",
      "Cinema tickets are Â£5.25 for adults and Â£3.50 for children. How much for one adult and two children?",
      "A snail crawls 35cm in one minute. How far will it crawl in 5 minutes?",
      "A box of 6 eggs weighs 300g. What is the approximate weight of one egg?",
      "A swimming pool contains 10,000 litres of water. 1,500 litres are drained. How much is left?",
      "A pack of pens costs Â£2.40. There are 6 pens in the pack. What is the cost per pen?",
      "The distance from my house to the park is 1.5km. How far is the round trip in metres?",
      "A watermelon weighs 2.5kg. A pineapple weighs 1.2kg. How much heavier is the watermelon?",
      "I need 1 litre of orange juice. I have one carton of 250ml and another of 400ml. How much more do I need?",
      "A cafÃ© sells coffee for Â£2.60 and tea for Â£1.90. How much more does the coffee cost?",
      "A tower is 45m high. A nearby flagpole is 12.5m high. What is the difference in height?",
      "I need 1kg of potatoes. The bag I pick up weighs 1350g. How many grams do I need to remove?",
      "A bucket holds 10 litres. It has a hole and is losing 50ml every minute. How much will be left after 10 minutes?",
      "A football costs Â£9.50. A child has Â£7.80. How much more money do they need?",
      "A piece of rope is 5m long. 2m 50cm is cut off. How much is left?",
      "A bag of apples weighs 1.5kg. A bag of oranges weighs 1.2kg. What is the total weight?",
      "A recipe requires 300ml of milk. A carton holds 1 litre. How much milk is left after making the recipe?",
      "I have a Â£20 note. I buy a book for Â£8.99 and a magazine for Â£3.50. How much change do I get?",
      "A marathon is 26 miles long. A runner has completed 10 miles. How much further to go?",
      "A cake weighs 1.2kg. It is cut into 10 equal slices. What is the weight of one slice in grams?",
      "A bathtub holds 80 litres of water. A shower uses 35 litres. How much water is saved by having a shower?",
      "A train ticket for an adult is Â£12. A child's ticket is half price. What is the cost for two adults and one child?",
      "A room's perimeter is 18m. It is a rectangle with a length of 5m. What is the width?",
      "A box of cereal weighs 750g. A family eats 50g each day. How many days does the box last?",
      "A can of paint holds 2.5 litres. A wall needs 1.8 litres for one coat. Is there enough for two coats?",
      "I need Â£30 for a trip. I have saved Â£17.50. How much more do I need to save?",
      "A plank of wood is 2.4m long. It is cut into 3 equal pieces. How long is each piece in cm?",
      "A farmer has a 1 tonne bag of feed. He uses 50kg a day. How many days will it last?",
      "A bottle contains 1.5 litres of lemonade. It is shared equally among 6 children. How many ml does each child get?",
      "A film starts at 6:30 pm and lasts for 95 minutes. What time does it finish?",
      "A tree is 8m tall. It grows by 75cm in a year. How tall is it now?",
      "A bag of rice weighs 2kg. 600g is used. How much is left in the bag?",
      "A fish tank is filled with 35 litres of water. Its capacity is 50 litres. How much more water is needed to fill it?",
      "A comic costs Â£1.75. How much would 4 comics cost?",
      "The journey to school is 3km. How many metres is this?",
      "A recipe needs 0.5kg of flour. I have a 1kg bag. What fraction is left?",
      "A water butt holds 200 litres. After a rainstorm, it is 3/4 full. How many litres are in it?",
      "A football match lasts 90 minutes with a 15 minute half-time break. If it kicks off at 3:00 pm, what time does it end?"
    ],
    "Year 4": [
      "I buy three items costing Â£1.20, 75p, and Â£2.50. What is the total cost?",
      "A rectangular field has a perimeter of 120m. One side is 40m long. What is the length of the other side?",
      "A recipe for 4 people needs 500g of pasta. How much pasta would you need for 8 people?",
      "A swimming pool is 25m long. How many lengths do you need to swim to complete 1km?",
      "A bottle of lemonade holds 2 litres. How many 250ml glasses can be filled from it?",
      "A school trip costs Â£12.50 per child. How much will it cost for a class of 30 children?",
      "The perimeter of a rectangular field is 300m. If the length is 100m, what is the area of the field?",
      "A cake recipe for 6 people requires 300g of flour. How much flour is needed for 9 people?",
      "A family travels 150km. They stop for a break after 80km. What fraction of the journey is left?",
      "I bought 4 items costing 75p, Â£1.25, Â£2.10, and 90p. I paid with a Â£10 note. How much change did I get?",
      "A rectangular room measures 4m by 5m. Carpet costs Â£15 per square metre. How much will it cost to carpet the room?",
      "A runner runs 8 laps of a 400m track. How many kilometres has she run?",
      "A 2-litre bottle of squash is shared between 8 children. How many millilitres does each child get?",
      "A book has 300 pages. I have read 120 pages. What percentage of the book have I read?",
      "Three friends have lunch. The bills are Â£8.50, Â£10.20, and Â£7.70. They split the total cost equally. How much do they each pay?",
      "A wall measuring 6m by 3m needs two coats of paint. One litre of paint covers 9mÂ². How many litres are needed?",
      "A car travels 10km on 1 litre of petrol. How much petrol is needed for a 250km journey?",
      "A pack of 8 biscuits weighs 200g. What is the weight of one biscuit?",
      "A film starts at 19:20 and finishes at 21:05. How long is the film?",
      "A shop has a sale with 25% off. How much would a Â£40 coat cost in the sale?",
      "Find the area of a garden that is 12.5m long and 8m wide.",
      "A box contains 48 chocolates. The box weighs 600g. If the box itself weighs 120g, what is the average weight of a chocolate?",
      "How many 300ml glasses can be filled from a 1.5-litre jug?",
      "A train journey costs Â£35. A railcard gives a 1/3 discount. What is the new price?",
      "A swimming pool is 25m long. To swim 1km, how many lengths are needed?",
      "A family needs Â£200 for a day out. They have Â£155.50. How much more do they need?",
      "A garden is a rectangle 10m long with a perimeter of 34m. What is its area?",
      "A recipe for 12 cupcakes needs 150g of sugar. How much sugar for 24 cupcakes?",
      "A car journey is 5km. How many metres is this?",
      "A 1 litre carton of juice costs Â£1.20. A 2 litre bottle costs Â£2.20. Which is better value?",
      "A school fair raises Â£546. The money is shared equally between 6 charities. How much does each charity receive?",
      "A room is 5m by 4m. A rug of 3m by 2m is placed on the floor. What area of floor is not covered?",
      "A cyclist travels at 15km per hour. How far do they travel in 2 hours?",
      "A pack of 6 yoghurts costs Â£1.80. What is the cost of one yoghurt?",
      "A flight leaves at 10:45 and is 2 hours 30 minutes long. What time does it arrive?",
      "A T-shirt costs Â£8.99. In a sale, it is half price. What is the sale price?",
      "A rectangular field has an area of 200mÂ². Its length is 20m. What is its perimeter?",
      "A machine produces 120 toys per hour. How many toys does it produce in 8 hours?",
      "Convert 3.5kg to grams.",
      "A bottle of water holds 750ml. How many bottles would be needed to fill a 3-litre container?",
      "A school concert starts at 18:00 and lasts for 1 hour and 40 minutes. What time does it finish?",
      "A book costs Â£7.50. What is the cost of 5 books?",
      "A fence is made of panels 2m wide. How many panels for a fence 30m long?",
      "A bag of apples weighs 1.2kg. If there are 8 apples in the bag, what is the average weight of one apple?",
      "How many minutes are in 3.25 hours?",
      "A box of 12 pencils costs Â£2.40. A box of 8 crayons costs Â£1.84. Which is cheaper per item?",
      "The perimeter of a square is 36cm. What is its area?",
      "A recipe for 8 people requires 400ml of cream. How much cream is needed for 6 people?",
      "A journey is 40 miles. The car travels at 20 mph. How long does the journey take?",
      "A 2.5 litre bottle of paint is needed for a wall. The paint is sold in 1 litre tins. How many tins must be bought?"
    ],
    "Year 5": [
      "A jacket costs Â£45.50. In a sale, it is reduced by 20%. What is the new price?",
      "The distance from London to Paris is approximately 450km. A train travels at an average speed of 150km/h. How long will the journey take?",
      "A box of 8 apples weighs 1.2kg. What is the approximate weight of one apple in grams?",
      "A rectangular garden is 12m long and 8m wide. What is its area? If fencing costs Â£10 per metre, how much will it cost to fence the entire garden?",
      "A car's fuel tank has a capacity of 40 litres. If petrol costs Â£1.50 per litre, how much does it cost to fill the tank from empty?",
      "A car travels 300km and uses 25 litres of petrol. How many kilometres per litre does the car achieve?",
      "A garden measuring 15m by 20m needs to be seeded. One box of seed covers 50mÂ². How many boxes are needed?",
      "A 2.5kg chicken needs to be cooked for 40 minutes per kg. How long should it be cooked for?",
      "A plank of wood is 5.2m long. A carpenter cuts it into 4 equal pieces. How long is each piece in centimetres?",
      "A taxi costs Â£3 plus Â£1.50 per mile. How much would a 6-mile journey cost?",
      "A rectangular fish tank is 80cm long, 40cm wide and 50cm high. What is its volume in litres?",
      "A recipe uses 150g sugar for every 250g of flour. If you use 750g of flour, how much sugar do you need?",
      "A runner's average speed is 12km/h. How far can they run in 2.5 hours?",
      "A phone contract costs Â£15 a month and includes 5GB of data. Extra data is Â£3 per GB. One month the bill is Â£24. How much extra data was used?",
      "A fence is built from panels 1.8m wide. How many panels are needed for a fence 27m long?",
      "A 5-litre container of paint is used to paint a wall with an area of 60mÂ². How many millilitres of paint are used per square metre?",
      "A block of cheese weighing 1.2kg costs Â£9. What is the price per 100g?",
      "A cyclist travels 45km in 3 hours. What is their average speed in km/h?",
      "A water butt collects 5 litres of water every hour during a storm. If it has a capacity of 150 litres and was empty, how long would it take to fill?",
      "A shop sells T-shirts for Â£8 each or 3 for Â£20. How much do you save by buying 3 together?",
      "A room needs a new skirting board. The room is a rectangle 4.5m by 3.2m with a doorway 0.8m wide. What length of skirting board is needed?",
      "An empty suitcase weighs 2.8kg. After packing, it weighs 15.5kg. What is the mass of the contents?",
      "A machine fills 12 bottles of juice every minute. Each bottle holds 500ml. How many litres of juice does it bottle in an hour?",
      "A map has a scale of 1cm to 5km. A road on the map is 6.5cm long. What is the actual length of the road?",
      "You have a budget of Â£100 for a party. Venue hire is Â£45, food is Â£3.50 per person. What is the maximum number of people you can invite?",
      "A car is worth Â£8000. It loses 10% of its value in a year. What is it worth after a year?",
      "A train travels 200 miles in 2.5 hours. What is its average speed in mph?",
      "A recipe for 12 biscuits needs 200g of flour. You have 1kg of flour. How many biscuits can you make?",
      "The perimeter of a rectangular field is 240m. The length is twice the width. What are the dimensions?",
      "Petrol costs Â£1.45 per litre. A car's tank holds 50 litres. How much does it cost to fill the tank from empty?",
      "A cuboid has a volume of 120cmÂ³. It is 10cm long and 4cm wide. What is its height?",
      "A recipe uses butter and sugar in the ratio 2:3. If you use 150g of sugar, how much butter do you need?",
      "An athlete runs 100m in 12.5 seconds. What is their speed in metres per second?",
      "A phone bill is Â£20 plus 10p per minute for calls outside the plan. If a person makes 30 minutes of extra calls, what is the bill?",
      "A fence is made of 15 panels, each 2.2m long. What is the total length of the fence?",
      "A 2 litre carton of orange juice costs Â£2.50. A 750ml bottle costs 90p. Which is better value per litre?",
      "A cheese costs Â£8.50 per kg. What is the cost of a 300g piece?",
      "A cyclist wants to travel 100km. They cycle at an average speed of 20km/h. How long will the journey take?",
      "A water tank is 80% full. Its capacity is 500 litres. How many litres are in the tank?",
      "A concert ticket costs Â£35. A booking fee of 5% is added. What is the total price?",
      "A composite L-shaped room needs a new carpet. The room's dimensions are given. Calculate the area of carpet needed.",
      "A parcel weighs 3.45kg. Postage costs Â£5 for the first kg and Â£1.50 for each additional kg. What is the postage cost?",
      "A machine prints 150 pages in 5 minutes. How many pages does it print per minute?",
      "A map scale is 1:50,000. The distance on the map is 4cm. What is the real distance in km?",
      "A budget for a project is Â£5000. 45% is spent on materials. How much money is left for labour?",
      "A car's value decreases by 15% from Â£12,000. What is its new value?",
      "An object travels at 60 mph. How many miles does it travel in 20 minutes?",
      "A bag contains red and blue sweets in the ratio 3:4. If there are 12 blue sweets, how many red sweets are there?",
      "The perimeter of an isosceles triangle is 30cm. The two equal sides are 12cm long. What is the length of the base?",
      "A builder mixes 1 part cement with 4 parts sand. If he has 20kg of sand, how much cement does he need?"
    ],
    "Year 6": [
      "A tin of beans weighs 450g. The tins are sold in packs of 4. What is the weight of 3 packs in kilograms?",
      "A room is 5m long, 4m wide, and 2.5m high. What is its volume?",
      "A recipe for a fruit smoothie requires 250ml of orange juice, 150ml of mango juice, and 100ml of pineapple juice. If you want to make 2 litres of the smoothie for a party, how much orange juice will you need?",
      "A map has a scale of 1:50,000. The distance between two towns on the map is 10cm. What is the actual distance in kilometres?",
      "A jug of squash is made by mixing 1 part concentrate to 4 parts water. If you use 300ml of concentrate, how much squash will you have in total, in litres?",
      "A car is travelling at 70 mph. How far will it travel in 2 hours and 30 minutes?",
      "The area of a triangular garden is 50mÂ². Its base is 20m. What is its height?",
      "A currency exchange rate is Â£1 = â¬1.15. How many euros would you get for Â£250?",
      "A recipe for 12 cakes needs 200g flour, 150g sugar and 100g butter. How much of each ingredient is needed for 18 cakes?",
      "A 10kg bag of potatoes costs Â£4.50. A 2.5kg bag costs Â£1.20. Which is better value per kg?",
      "The volume of a cuboid is 240cmÂ³. Its length is 10cm and its height is 8cm. What is its width?",
      "A map scale is 1:50,000. The distance between two towns on the map is 7cm. What is the actual distance in kilometres?",
      "A mobile phone costs Â£600, or a payment plan of Â£50 deposit plus 12 monthly payments of Â£50. How much more expensive is the payment plan?",
      "A train leaves at 09:45 and arrives at 12:15. It travels 150 miles. What is its average speed in miles per hour?",
      "A company makes a profit of Â£2.5 million. It has 50 employees and wants to give 10% of the profit as a bonus, shared equally. How much does each employee get?",
      "A parallelogram has an area of 48cmÂ² and a base of 12cm. What is its perpendicular height?",
      "A builder mixes cement, sand and gravel in the ratio 1:2:4. If he uses 15kg of cement, how much sand and gravel does he need?",
      "A water tank in the shape of a cuboid is 2m x 1.5m x 1m. It is 75% full. How many litres of water are in the tank?",
      "A plane flies 800km in 1 hour 15 minutes. What is its average speed in km/h?",
      "Interest on savings is 2% per year. If you have Â£500 in a savings account, how much interest will you earn in one year?",
      "A cube has a volume of 64cmÂ³. What is the area of one of its faces?",
      "Three builders can build a wall in 10 days. Assuming they work at the same rate, how long would it take 5 builders?",
      "The diameter of a circle is 10cm. What is its circumference?",
      "A recipe is in imperial units, asking for 2lbs of flour. Your scales are metric. How many grams do you need?",
      "A car depreciates in value by 20% in its first year. If it cost Â£15,000 new, what is its value after one year?",
      "A Â£80 coat is in a sale with 25% off. What is the sale price?",
      "The ratio of boys to girls in a school is 4:5. If there are 200 boys, how many girls are there?",
      "A car travels 30 miles on 1 gallon of petrol. Petrol costs Â£6.50 per gallon. How much does a 150-mile journey cost?",
      "The area of a circle is approximately 78.5cmÂ². What is its radius? (A = ÏrÂ²)",
      "A recipe for 6 people needs 300g of pasta. How much pasta is needed for 10 people?",
      "A cuboid has a volume of 0.5mÂ³. How many litres is this?",
      "A map has a scale of 1 inch to 5 miles. The distance on the map is 3.5 inches. What is the real distance?",
      "A bank offers 1.5% annual interest. If you save Â£2000 for a year, how much interest do you earn?",
      "Two numbers are in the ratio 3:7. Their sum is 50. What are the numbers?",
      "The circumference of a wheel is 80cm. How many full rotations does it make over a distance of 1km?",
      "A shop buys a TV for Â£400 and sells it for a 30% profit. What is the selling price?",
      "The angles in a triangle are in the ratio 1:2:3. What are the sizes of the angles?",
      "A car is travelling at 30 metres per second. What is this speed in km/h?",
      "The volume of a cube is 216cmÂ³. What is the length of one of its sides?",
      "An item costs Â£50 plus 20% VAT. What is the total price?",
      "The exchange rate is $1.25 to Â£1. How many pounds is $200?",
      "The area of a parallelogram is 60cmÂ². Its base is 1.5 times its height. Find the base and height.",
      "A group of 5 people can paint a fence in 4 hours. How long would it take 2 people?",
      "The diameter of the Earth is approximately 12,742 km. What is its circumference?",
      "A company's shares are worth Â£2.50 each. They increase in value by 8%. What is the new price?",
      "In a survey of 120 people, the ratio of people who prefer tea to coffee is 3:2. How many people prefer tea?",
      "A car travels 210 miles in 3 hours and 30 minutes. What was its average speed?",
      "A cylinder has a volume of 314cmÂ³. Its height is 10cm. What is the radius of its base? (V=ÏrÂ²h)",
      "An investment of Â£1000 increases by 10% in the first year, and then the new amount increases by 10% in the second year. What is the final value?",
      "The scale on a model boat is 1:50. The model is 40cm long. What is the real length of the boat in metres?"
    ]
  }
}

```
--- END FILE: context\example_questions.json ---

--- START FILE: context\national_curriculum_framework.json ---
```json
[
  {
    "Strand": "Number and place value",
    "Substrand": "counting (in multiples)",
    "Content domain reference": "N1",
    "Years": {
      "Year 1": "count to and across 100, forwards and backwards, beginning with 0 or 1, or from any given number; count in multiples of twos, fives and tens",
      "Year 2": "count in steps of 2, 3, and 5 from 0, and in tens from any number, forward or backward",
      "Year 3": "count from 0 in multiples of 4, 8, 50 and 100",
      "Year 4": "count in multiples of 6, 7, 9, 25 and 1,000",
      "Year 5": "count forwards or backwards in steps of powers of 10 for any given number up to 1,000,000",
      "Year 6": ""
    }
  },
  {
    "Strand": "Number and place value",
    "Substrand": "read, write, order and compare numbers",
    "Content domain reference": "N2",
    "Years": {
      "Year 1": "count, read and write numbers to 100 in numerals; given a number, identify one more and one less; read and write numbers from 1 to 20 in numerals and words",
      "Year 2": "read and write numbers to at least 100 in numerals and in words; compare and order numbers from 0 up to 100; use <, > and = signs",
      "Year 3": "compare and order numbers up to 1,000; read and write numbers to 1,000 in numerals and in words; find 10 or 100 more or less than a given number",
      "Year 4": "order and compare numbers beyond 1,000; find 1,000 more or less than a given number",
      "Year 5": "read, write, order and compare numbers to at least 1,000,000",
      "Year 6": "read, write, order and compare numbers up to 10,000,000"
    }
  },
  {
    "Strand": "Number and place value",
    "Substrand": "place value; roman numerals",
    "Content domain reference": "N3",
    "Years": {
      "Year 1": "",
      "Year 2": "recognise the place value of each digit in a two-digit number (tens, ones)",
      "Year 3": "recognise the place value of each digit in a three-digit number (hundreds, tens, ones)",
      "Year 4": "recognise the place value of each digit in a four-digit number (thousands, hundreds, tens and ones); read Roman numerals to 100 (I to C) and know that over time, the numeral system changed to include the concept of zero and place value",
      "Year 5": "determine the value of each digit in numbers up to 1,000,000; read Roman numerals to 1,000 (M) and recognise years written in Roman numerals",
      "Year 6": "determine the value of each digit in numbers up to 10,000,000"
    }
  },
  {
    "Strand": "Number and place value",
    "Substrand": "identify, represent and estimate; rounding",
    "Content domain reference": "N4",
    "Years": {
      "Year 1": "identify and represent numbers using objects and pictorial representations including the number line, and use the language of: equal to, more than, less than (fewer), most, least",
      "Year 2": "identify, represent and estimate numbers using different representations, including the number line",
      "Year 3": "identify, represent and estimate numbers using different representations",
      "Year 4": "identify, represent and estimate numbers using different representations; round any number to the nearest 10, 100 or 1,000",
      "Year 5": "round any number up to 1,000,000 to the nearest 10, 100, 1,000, 10,000 and 100,000",
      "Year 6": "round any whole number to a required degree of accuracy"
    }
  },
  {
    "Strand": "Number and place value",
    "Substrand": "negative numbers",
    "Content domain reference": "N5",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "count backwards through zero to include negative numbers",
      "Year 5": "interpret negative numbers in context, count forwards and backwards with positive and negative whole numbers, including through zero",
      "Year 6": "use negative numbers in context, and calculate intervals across zero"
    }
  },
  {
    "Strand": "Number and place value",
    "Substrand": "number problems",
    "Content domain reference": "N6",
    "Years": {
      "Year 1": "",
      "Year 2": "use place value and number facts to solve problems",
      "Year 3": "solve number problems and practical problems involving 3N1-3N4",
      "Year 4": "solve number and practical problems that involve 4N1-4N5 and with increasingly large positive numbers",
      "Year 5": "solve number problems and practical problems that involve 5N1-5N5",
      "Year 6": "solve number problems and practical problems that involve 6N2-6N5"
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "add / subtract mentally",
    "Content domain reference": "C1",
    "Years": {
      "Year 1": "represent and use number bonds and related subtraction facts within 20",
      "Year 2": "recall and use addition and subtraction facts to 20 fluently, and derive and use related facts up to 100",
      "Year 3": "add and subtract numbers mentally, including: a three-digit number and ones, a three-digit number and tens, a three-digit number and hundreds",
      "Year 4": "",
      "Year 5": "add and subtract numbers mentally with increasingly large numbers",
      "Year 6": ""
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "add / subtract using written methods",
    "Content domain reference": "C2",
    "Years": {
      "Year 1": "add and subtract one-digit and two-digit numbers to 20, including zero; read, write and interpret mathematical statements involving addition (+), subtraction (â) and equals (=) signs",
      "Year 2": "add and subtract numbers using concrete objects, pictorial representations, and mentally, including: a two-digit number and ones, a two-digit number and tens, two two-digit numbers, adding three one-digit numbers",
      "Year 3": "add and subtract numbers with up to three digits, using formal written methods of columnar addition and subtraction",
      "Year 4": "add and subtract numbers with up to 4 digits using the formal written methods of columnar addition and subtraction where appropriate",
      "Year 5": "add and subtract whole numbers with more than 4 digits, including using formal written methods (columnar addition and subtraction)",
      "Year 6": ""
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "estimate, use inverses and check",
    "Content domain reference": "C3",
    "Years": {
      "Year 1": "",
      "Year 2": "recognise and use the inverse relationship between addition and subtraction and use this to check calculations and missing number problems",
      "Year 3": "estimate the answer to a calculation and use inverse operations to check answers",
      "Year 4": "estimate and use inverse operations to check answers to a calculation",
      "Year 5": "use rounding to check answers to calculations and determine, in the context of a problem, levels of accuracy",
      "Year 6": "use estimation to check answers to calculations and determine, in the context of a problem, an appropriate degree of accuracy"
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "add / subtract to solve problems",
    "Content domain reference": "C4",
    "Years": {
      "Year 1": "solve one-step problems that involve addition and subtraction, using concrete objects and pictorial representations, and missing number problems such as 7 = _ â 9",
      "Year 2": "solve problems with addition and subtraction: using concrete objects and pictorial representations, including those involving numbers, quantities and measures; applying their increasing knowledge of mental and written methods",
      "Year 3": "solve problems, including missing number problems, using number facts, place value, and more complex addition and subtraction",
      "Year 4": "solve addition and subtraction two-step problems in contexts, deciding which operations and methods to use and why",
      "Year 5": "solve addition and subtraction multi-step problems in contexts, deciding which operations and methods to use and why",
      "Year 6": "solve addition and subtraction multi-step problems in contexts, deciding which operations and methods to use and why"
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "properties of number (multiples, factors, primes, squares and cubes)",
    "Content domain reference": "C5",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "identify multiples and factors, including finding all factor pairs of a number and common factors of two numbers; know and use the vocabulary of prime numbers, prime factors and composite (non-prime) numbers; establish whether a number up to 100 is prime and recall prime numbers up to 19; recognise and use square numbers and cube numbers, and the notation for squared (Â²) and cubed (Â³)",
      "Year 6": "identify common factors, common multiples and prime numbers"
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "multiply / divide mentally",
    "Content domain reference": "C6",
    "Years": {
      "Year 1": "",
      "Year 2": "recall and use multiplication and division facts for the 2, 5 and 10 multiplication tables, including recognising odd and even numbers",
      "Year 3": "recall and use multiplication and division facts for the 3, 4 and 8 multiplication tables",
      "Year 4": "recall multiplication and division facts for multiplication tables up to 12 x 12; use place value, known and derived facts to multiply and divide mentally, including: multiplying by 0 and 1, dividing by 1, multiplying together three numbers; recognise and use factor pairs and commutativity in mental calculations",
      "Year 5": "multiply and divide numbers mentally drawing upon known facts; multiply and divide whole numbers and those involving decimals by 10, 100 and 1,000",
      "Year 6": "perform mental calculations, including with mixed operations and large numbers"
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "multiply / divide using written methods",
    "Content domain reference": "C7",
    "Years": {
      "Year 1": "",
      "Year 2": "calculate mathematical statements for multiplication and division within the multiplication tables and write them using the multiplication (Ã), division (Ã·) and equals (=) signs",
      "Year 3": "write and calculate mathematical statements for multiplication and division using the multiplication tables that pupils know, including for two-digit numbers times one-digit numbers, using mental and progressing to formal written methods",
      "Year 4": "multiply two-digit and three-digit numbers by a one-digit number using formal written layout",
      "Year 5": "multiply numbers up to 4 digits by a one- or two-digit number using a formal written method, including long multiplication for two-digit numbers; divide numbers up to 4 digits by a one-digit number using the formal written method of short division and interpret remainders appropriately for the context",
      "Year 6": "multiply multi-digit numbers up to 4 digits by a two-digit whole number using the formal written method of long multiplication; divide numbers up to 4 digits by a two-digit whole number using the formal written method of long division, and interpret remainders as whole number remainders, fractions, or by rounding, as appropriate for the context; divide numbers up to 4 digits by a two-digit number using the formal written method of short division where appropriate, interpreting remainders according to the context"
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "solve problems (commutative, associative, distributive and all four operations)",
    "Content domain reference": "C8",
    "Years": {
      "Year 1": "solve one-step problems involving multiplication and division, by calculating the answer using concrete objects, pictorial representations and arrays with the support of the teacher",
      "Year 2": "solve problems involving multiplication and division, using materials, arrays, repeated addition, mental methods, and multiplication and division facts, including problems in contexts; show that addition of two numbers can be done in any order (commutative) and subtraction of one number from another cannot; show that multiplication of two numbers can be done in any order (commutative) and division of one number by another cannot",
      "Year 3": "solve problems, including missing number problems, involving multiplication and division, including integer scaling problems and correspondence problems in which n objects are connected to m objects",
      "Year 4": "solve problems involving multiplying and adding, including using the distributive law to multiply two-digit numbers by one digit, integer scaling problems and harder correspondence problems such as n objects are connected to m objects",
      "Year 5": "solve problems involving multiplication and division including using their knowledge of factors and multiples, squares and cubes; solve problems involving addition, subtraction, multiplication and division and a combination of these, including understanding the meaning of the equals sign; solve problems involving multiplication and division including scaling by simple fractions and problems involving simple rates",
      "Year 6": "solve problems involving addition, subtraction, multiplication and division"
    }
  },
  {
    "Strand": "Addition, subtraction, multiplication and division (calculations)",
    "Substrand": "order of operations",
    "Content domain reference": "C9",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "use their knowledge of the order of operations to carry out calculations involving the four operations"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "recognise, find, write, name and count fractions",
    "Content domain reference": "F1",
    "Years": {
      "Year 1": "recognise, find and name a half as one of two equal parts of an object, shape or quantity; recognise, find and name a quarter as one of four equal parts of an object, shape or quantity",
      "Year 2": "recognise, find, name and write fractions â, Â¼, Â²ââ and Â¾ of a length, shape, set of objects or quantity; write simple fractions, for example, Â½ of 6 = 3",
      "Year 3": "count up and down in tenths, recognise that tenths arise from dividing an object into 10 equal parts and in dividing one-digit numbers or quantities by 10; recognise, find and write fractions of a discrete set of objects: unit fractions and non-unit fractions with small denominators; recognise and use fractions as numbers: unit fractions and non-unit fractions with small denominators",
      "Year 4": "count up and down in hundredths; recognise that hundredths arise when dividing an object by a hundred and dividing tenths by ten",
      "Year 5": "",
      "Year 6": ""
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "equivalent fractions",
    "Content domain reference": "F2",
    "Years": {
      "Year 1": "",
      "Year 2": "recognise the equivalence of Â²ââ and Â½",
      "Year 3": "recognise and show, using diagrams, equivalent fractions with small denominators",
      "Year 4": "recognise and show, using diagrams, families of common equivalent fractions",
      "Year 5": "recognise mixed numbers and improper fractions and convert from one form to the other; write mathematical statements >1 as a mixed number [e.g. â + â = â¶ââ = 1â]; identify name and write equivalent fractions of a given fraction, represented visually, including tenths and hundredths",
      "Year 6": "use common factors to simplify fractions; use common multiples to express fractions in the same denomination"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "comparing and ordering fractions",
    "Content domain reference": "F3",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "compare and order unit fractions and fractions with the same denominators",
      "Year 4": "",
      "Year 5": "compare and order fractions whose denominators are all multiples of the same number",
      "Year 6": "compare and order fractions, including fractions > 1"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "add / subtract fractions",
    "Content domain reference": "F4",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "add and subtract fractions with the same denominator within one whole [e.g. â + â = â¶ââ]",
      "Year 4": "add and subtract fractions with the same denominator",
      "Year 5": "add and subtract fractions with the same denominator and denominators that are multiples of the same number",
      "Year 6": "add and subtract fractions with different denominators and mixed numbers, using the concept of equivalent fractions"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "multiply / divide fractions",
    "Content domain reference": "F5",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "multiply proper fractions and mixed numbers by whole numbers, supported by materials and diagrams",
      "Year 6": "multiply simple pairs of proper fractions, writing the answer in its simplest form [e.g. Â¼ x Â½ = â]; divide proper fractions by whole numbers [e.g. â Ã· 2 = â]"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "fractions / decimals equivalence",
    "Content domain reference": "F6",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "recognise and write decimal equivalents to Â¼, Â½, Â¾; recognise and write decimal equivalents of any number of tenths or hundredths",
      "Year 5": "read and write decimal numbers as fractions [e.g. 0.71 = â·Â¹ââââ]; recognise and use thousandths and relate them to tenths, hundredths and decimal equivalents",
      "Year 6": "associate a fraction with division to calculate decimal fraction equivalents (e.g. 0.375) for a simple fraction [e.g. â]"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "rounding decimals",
    "Content domain reference": "F7",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "round decimals with one decimal place to the nearest whole number",
      "Year 5": "round decimals with two decimal places to the nearest whole number and to one decimal place",
      "Year 6": ""
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "compare and order decimals",
    "Content domain reference": "F8",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "compare numbers with the same number of decimal places up to two decimal places",
      "Year 5": "read, write, order and compare numbers with up to three decimal places",
      "Year 6": ""
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "multiply / divide decimals",
    "Content domain reference": "F9",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "find the effect of dividing a one- or two-digit number by 10 and 100, identifying the value of the digits in the answer as ones, tenths and hundredths",
      "Year 5": "",
      "Year 6": "identify the value of each digit to three decimal places and multiply and divide numbers by 10, 100 and 1,000 giving answers up to three decimal places; multiply one-digit numbers with up to two-decimal places by whole numbers; use written division methods in cases where the answer has up to two-decimal places"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "solve problems with fractions and decimals",
    "Content domain reference": "F10",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "solve problems that involve 3F1-3F4",
      "Year 4": "solve problems involving increasingly harder fractions to calculate quantities and fractions to divide quantities, including non-unit fractions where the answer is a whole number; solve simple measure and money problems involving fractions and decimals to two decimal places",
      "Year 5": "solve problems involving numbers up to three decimal places",
      "Year 6": "solve problems which require answers to be rounded to specified degrees of accuracy"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "fractions / decimal / percentage equivalence",
    "Content domain reference": "F11",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "recognise the per cent symbol (%) and understand that per cent relates to 'number of parts per hundred'; write percentages as a fraction with denominator hundred, and as a decimal",
      "Year 6": "recall and use equivalences between simple fractions, decimals and percentages, including in different contexts"
    }
  },
  {
    "Strand": "Fractions, decimals and percentages",
    "Substrand": "solve problems with percentages",
    "Content domain reference": "F12",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "solve problems that require knowing percentage and decimal equivalents of Â½, Â¼, â, â, â and those fractions with a denominator of a multiple of 10 or 25",
      "Year 6": ""
    }
  },
  {
    "Strand": "Ratio and proportion",
    "Substrand": "relative sizes, similarity",
    "Content domain reference": "R1",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "solve problems involving the relative sizes of two quantities, where missing values can be found by using integer multiplication and division facts"
    }
  },
  {
    "Strand": "Ratio and proportion",
    "Substrand": "use of percentages for comparison",
    "Content domain reference": "R2",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "solve problems involving the calculation of percentages [e.g. of measures such as 15% of 360] and the use of percentages for comparison"
    }
  },
  {
    "Strand": "Ratio and proportion",
    "Substrand": "scale factors",
    "Content domain reference": "R3",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "solve problem involving similar shapes where the scale factor is known or can be found"
    }
  },
  {
    "Strand": "Ratio and proportion",
    "Substrand": "unequal sharing and grouping",
    "Content domain reference": "R4",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "solve problems involving unequal sharing and grouping using knowledge of fractions and multiples"
    }
  },
  {
    "Strand": "Algebra",
    "Substrand": "missing number problems expressed in algebra",
    "Content domain reference": "A1",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "express missing number problems algebraically"
    }
  },
  {
    "Strand": "Algebra",
    "Substrand": "simple formulae expressed in words",
    "Content domain reference": "A2",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "use simple formulae"
    }
  },
  {
    "Strand": "Algebra",
    "Substrand": "generate and describe linear number sequences",
    "Content domain reference": "A3",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "generate and describe linear number sequences"
    }
  },
  {
    "Strand": "Algebra",
    "Substrand": "number sentences involving two unknowns",
    "Content domain reference": "A4",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "find pairs of numbers that satisfy an equation with two unknowns"
    }
  },
  {
    "Strand": "Algebra",
    "Substrand": "enumerate all possibilities of combinations of two variables",
    "Content domain reference": "A5",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "enumerate possibilities of combinations of two variables"
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "compare, describe and order measures",
    "Content domain reference": "M1",
    "Years": {
      "Year 1": "compare, describe and solve practical problems for: lengths and heights (e.g. long/short, taller/shorter); mass/weight (e.g. heavy/light, heavier than); capacity and volume (e.g. full/empty, more than/less than); time (e.g. quicker, slower)",
      "Year 2": "compare and order lengths, mass, volume/capacity and record the results using >, < and =",
      "Year 3": "compare lengths (m/cm/mm); compare mass (kg/g); compare volume/capacity (l/ml)",
      "Year 4": "compare different measures, including money in pounds and pence",
      "Year 5": "",
      "Year 6": ""
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "estimate, measure and read scales",
    "Content domain reference": "M2",
    "Years": {
      "Year 1": "measure and begin to record: lengths and heights; mass/weight; capacity and volume; time (hours, minutes, seconds)",
      "Year 2": "choose and use appropriate standard units to estimate and measure: length/height (m/cm); mass (kg/g); temperature (Â°C); capacity (litres/ml) to the nearest appropriate unit, using rulers, scales, thermometers and measuring vessels",
      "Year 3": "measure lengths (m/cm/mm); measure mass (kg/g); measure volume / capacity (l/ml)",
      "Year 4": "estimate different measures, including money in pounds and pence",
      "Year 5": "",
      "Year 6": ""
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "money",
    "Content domain reference": "M3",
    "Years": {
      "Year 1": "recognise and know the value of different denominations of coins and notes",
      "Year 2": "recognise and use symbols for pounds (Â£) and pence (p); combine amounts to make a particular value; find different combinations of coins that equal the same amounts of money",
      "Year 3": "Key stage 1 content domain",
      "Year 4": "",
      "Year 5": "",
      "Year 6": ""
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "telling time, ordering time, duration and units of time",
    "Content domain reference": "M4",
    "Years": {
      "Year 1": "tell the time to the hour and half past the hour and draw the hands on a clock face to show these times; sequence events in chronological order using language (e.g. before, after, next); recognise and use language relating to dates, including days of the week, weeks, months and years",
      "Year 2": "tell and write the time to five minutes, including quarter past/to the hour and draw the hands on a clock face to show these times; compare and sequence intervals of time; know the number of minutes in an hour and the number of hours in a day",
      "Year 3": "tell and write the time from an analogue clock; 12-hour clocks; tell and write the time from an analogue clock; 24-hour clocks; tell and write the time from an analogue clock, including using Roman numerals from I to XII; estimate and read time with increasing accuracy to the nearest minute; record and compare time in terms of seconds, minutes and hours; use vocabulary such as o'clock / a.m. / p.m., morning, afternoon, noon and midnight; know the number of seconds in a minute and the number of days in each month, year and leap year; compare durations of events, [e.g. to calculate the time taken by particular events or tasks]",
      "Year 4": "read, write and convert time between analogue and digital 12-hour clocks; read, write and convert time between analogue and digital 24-hour clocks; solve problems involving converting from hours to minutes; minutes to seconds; years to months; weeks to days",
      "Year 5": "solve problems involving converting between units of time",
      "Year 6": ""
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "convert between metric units",
    "Content domain reference": "M5",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "convert between different units of metric measure [e.g. kilometre and metre; centimetre and metre; centimetre and millimetre; gram and kilogram; litre and millilitre]",
      "Year 6": ""
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "convert metric / imperial",
    "Content domain reference": "M6",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "convert between different units of measurement [e.g. kilometre to metre; hour to minute]",
      "Year 5": "understand and use approximate equivalences between metric units and common imperial units such as inches, pounds and pints",
      "Year 6": "use, read, write and convert between standard units, converting measurements of length, mass, volume and time from a smaller unit of measure to a larger unit, and vice versa, using decimal notation of up to three decimal places; convert between miles and kilometres"
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "perimeter, area",
    "Content domain reference": "M7",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "measure the perimeter of simple 2-D shapes",
      "Year 4": "measure and calculate the perimeter of a rectilinear figure (including squares) in centimetres and metres; find the area of rectilinear shapes by counting squares",
      "Year 5": "measure and calculate the perimeter of composite rectilinear shapes in centimetres and metres; calculate and compare the area of rectangles (including squares), and including using standard units, square centimetres (cmÂ²) and square metres (mÂ²) and estimate the area of irregular shapes",
      "Year 6": "recognise that shapes with the same areas can have different perimeters and vice versa; calculate the area of parallelograms and triangles; recognise when it is possible to use the formulae for the area of shapes"
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "volume",
    "Content domain reference": "M8",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "estimate volume [e.g. using 1 cmÂ³ blocks to build cuboids (including cubes)] and capacity [e.g. using water]",
      "Year 6": "calculate, estimate and compare volume of cubes and cuboids using standard units, including centimetre cubed (cmÂ³) and cubic metres (mÂ³), and extending to other units [e.g. mmÂ³ and kmÂ³]; recognise when it is possible to use the formulae for the volume of shapes"
    }
  },
  {
    "Strand": "Measurement",
    "Substrand": "solve problems (a, money; b, length; c, mass / weight; d, capacity / volume)",
    "Content domain reference": "M9",
    "Years": {
      "Year 1": "",
      "Year 2": "solve simple problems in a practical context involving addition and subtraction of money of the same unit, including giving change",
      "Year 3": "add and subtract amounts of money to give change, using both pounds (Â£) and pence (p) in practical contexts; add and subtract lengths (m/cm/mm); add and subtract mass (kg/g); add and subtract volume / capacity (l/ml)",
      "Year 4": "calculate different measures, including money in pounds and pence",
      "Year 5": "use all four operations to solve problems involving measures [money] using decimal notation, including scaling; use all four operations to solve problems involving measure [e.g. length] using decimal notation, including scaling; use all four operations to solve problems involving measure [e.g. mass] using decimal notation, including scaling; use all four operations to solve problems involving measure [e.g. volume] using decimal notation, including scaling",
      "Year 6": "solve problems involving the calculation and conversion of units of measure, using decimal notation up to three decimal places where appropriate"
    }
  },
  {
    "Strand": "Geometry â properties of shapes",
    "Substrand": "recognise and name common shapes",
    "Content domain reference": "G1",
    "Years": {
      "Year 1": "recognise and name common 2-D shapes (e.g. rectangles, squares, circles, triangles); recognise and name common 3-D shapes (e.g. cuboids, cubes, pyramids, spheres)",
      "Year 2": "compare and sort common 2-D and 3-D shapes and everyday objects",
      "Year 3": "Within key stage 1 content domain",
      "Year 4": "",
      "Year 5": "",
      "Year 6": ""
    }
  },
  {
    "Strand": "Geometry â properties of shapes",
    "Substrand": "describe properties and classify shapes",
    "Content domain reference": "G2",
    "Years": {
      "Year 1": "",
      "Year 2": "identify and describe the properties of 2-D shapes, including the number of sides and line symmetry in a vertical line; identify and describe the properties of 3-D shapes, including the number of edges, vertices and faces",
      "Year 3": "identify horizontal, vertical lines and pairs of perpendicular and parallel lines",
      "Year 4": "compare and classify geometric shapes, including quadrilaterals and triangles based on their properties and sizes; identify lines of symmetry in 2-D shapes presented in different orientations; complete a simple symmetric figure with respect to a specific line of symmetry",
      "Year 5": "use the properties of rectangles to deduce related facts and find missing lengths and angles; distinguish between regular and irregular polygons based on reasoning about equal sides and angles",
      "Year 6": "compare and classify geometric shapes based on their properties and sizes; describe simple 3-D shapes"
    }
  },
  {
    "Strand": "Geometry â properties of shapes",
    "Substrand": "draw and make shapes and relate 2-D to 3-D shapes (including nets)",
    "Content domain reference": "G3",
    "Years": {
      "Year 1": "",
      "Year 2": "identify 2-D shapes on the surface of 3-D shapes (e.g. a circle on a cylinder and a triangle on a pyramid)",
      "Year 3": "draw 2-D shapes; make 3-D shapes using modelling materials; recognise 3-D shapes in different orientations and describe them",
      "Year 4": "",
      "Year 5": "identify 3-D shapes including cubes and other cuboids, from 2-D representations",
      "Year 6": "draw 2-D shapes using given dimensions and angles; recognise and build simple 3-D shapes, including making nets"
    }
  },
  {
    "Strand": "Geometry â properties of shapes",
    "Substrand": "angles â measuring and properties",
    "Content domain reference": "G4",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "recognise that angles are a property of shape or a description of a turn; identify right angles, recognise that two right angles make a half-turn, three make three quarters of a turn and four a complete turn; identify whether angles are greater than or less than a right angle",
      "Year 4": "identify acute and obtuse angles and compare and order angles up to two right angles by size",
      "Year 5": "know angles are measured in degrees: estimate and compare acute, obtuse and reflex angles; identify: angles at a point and one whole turn (total 360Â°), angles at a point on a straight line and Â½ a turn (total 180Â°), other multiples of 90Â°; draw given angles and measure them in degrees (Â°)",
      "Year 6": "find unknown angles in any triangles, quadrilaterals and regular polygons; recognise angles where they meet at a point, are on a straight line, or are vertically opposite, and find missing angles"
    }
  },
  {
    "Strand": "Geometry â properties of shapes",
    "Substrand": "circles",
    "Content domain reference": "G5",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "illustrate and name parts of circles, including radius, diameter and circumference and know that the diameter is twice the radius"
    }
  },
  {
    "Strand": "Geometry - position and direction",
    "Substrand": "patterns",
    "Content domain reference": "P1",
    "Years": {
      "Year 1": "",
      "Year 2": "order and arrange combinations of mathematical objects in patterns and sequences",
      "Year 3": "Within key stage 1 content domain",
      "Year 4": "",
      "Year 5": "",
      "Year 6": ""
    }
  },
  {
    "Strand": "Geometry - position and direction",
    "Substrand": "describe position, direction and movement",
    "Content domain reference": "P2",
    "Years": {
      "Year 1": "describe position, direction and movement, including half, quarter and three-quarter turns",
      "Year 2": "use mathematical vocabulary to describe position, direction and movement, including movement in a straight line and distinguishing between rotation as a turn and in terms of right angles for quarter, half and three-quarter turns (clockwise and anti-clockwise)",
      "Year 3": "",
      "Year 4": "describe movements between positions as translations of a given unit to the left / right and up / down",
      "Year 5": "identify, describe and represent the position of a shape following a reflection or translation, using the appropriate language, and know that the shape has not changed",
      "Year 6": "draw and translate simple shapes on the co-ordinate plane, and reflect them in the axes"
    }
  },
  {
    "Strand": "Geometry - position and direction",
    "Substrand": "co-ordinates",
    "Content domain reference": "P3",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "describe positions on a 2-D grid as co-ordinates in the first quadrant; plot specified points and draw sides to complete a given polygon",
      "Year 5": "",
      "Year 6": "describe positions on the full co-ordinate grid (all four quadrants)"
    }
  },
  {
    "Strand": "Statistics",
    "Substrand": "interpret and represent data",
    "Content domain reference": "S1",
    "Years": {
      "Year 1": "",
      "Year 2": "interpret and construct simple pictograms, tally charts, block diagrams and simple tables",
      "Year 3": "interpret and present data using bar charts, pictograms and tables",
      "Year 4": "interpret and present discrete and continuous data using appropriate graphical methods, including bar charts and time graphs",
      "Year 5": "complete, read and interpret information in tables, including timetables",
      "Year 6": "interpret and construct pie charts and line graphs and use these to solve problems"
    }
  },
  {
    "Strand": "Statistics",
    "Substrand": "solve problems involving data",
    "Content domain reference": "S2",
    "Years": {
      "Year 1": "",
      "Year 2": "ask and answer simple questions by counting the number of objects in each category and sorting the categories by quantity; ask and answer questions about totalling and comparing categorical data",
      "Year 3": "solve one-step and two-step questions [e.g. 'How many more?' and 'How many fewer?'] using information presented in scaled bar charts, pictograms and tables",
      "Year 4": "solve comparison, sum and difference problems using information presented in bar charts, pictograms, tables and other graphs",
      "Year 5": "solve comparison, sum and difference problems using information presented in a line graph",
      "Year 6": ""
    }
  },
  {
    "Strand": "Statistics",
    "Substrand": "mean average",
    "Content domain reference": "S3",
    "Years": {
      "Year 1": "",
      "Year 2": "",
      "Year 3": "",
      "Year 4": "",
      "Year 5": "",
      "Year 6": "calculate and interpret the mean as an average"
    }
  }
]
```
--- END FILE: context\national_curriculum_framework.json ---

--- START FILE: eslint.config.mjs ---
```javascript
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  {
    ignores: [
      "node_modules/**",
      ".next/**",
      "out/**",
      "build/**",
      "next-env.d.ts",
      "**/.next/**",
      "**/build/**",
      "**/dist/**"
    ],
    rules: {
      "@typescript-eslint/no-explicit-any": "off",
      "@typescript-eslint/no-unused-vars": "warn",
      "@typescript-eslint/no-require-imports": "off",
      "@typescript-eslint/triple-slash-reference": "off",
      "react/no-unescaped-entities": "off",
      "react-hooks/exhaustive-deps": "warn",
      "prefer-const": "warn"
    }
  },
];

export default eslintConfig;

```
--- END FILE: eslint.config.mjs ---

--- START FILE: lib\adapters\legacy-adapter.ts ---
```typescript
// Legacy Adapter - Ensures backward compatibility with existing system
// Maps old requests to new enhanced system while maintaining identical responses

import { StoryEngine } from '@/lib/story-engine/story.engine';
import { MoneyContextGenerator } from '@/lib/story-engine/contexts/money.context';
import {
  QuestionOrchestrator,
  EnhancedQuestionRequest
} from '@/lib/orchestrator/question-orchestrator';
import { QuestionFormat } from '@/lib/types/question-formats';
import { GenerateRequest, GeneratedQuestion } from '@/lib/types';

/**
 * Adapter that maps legacy API requests to the enhanced system
 * Ensures 100% backward compatibility
 */
export class LegacyAdapter {
  private orchestrator: QuestionOrchestrator;
  private storyEngine: StoryEngine;

  constructor(orchestrator: QuestionOrchestrator) {
    this.orchestrator = orchestrator;
    this.storyEngine = new StoryEngine();
  }

  /**
   * Convert legacy request to enhanced format
   */
  convertRequest(legacyRequest: GenerateRequest): EnhancedQuestionRequest {
    return {
      model_id: legacyRequest.model_id,
      year_level: legacyRequest.year_level,
      difficulty_params: legacyRequest.difficulty_params,
      cultural_context: 'UK',
      format_preference: QuestionFormat.DIRECT_CALCULATION, // Default to existing behavior
      scenario_theme: this.inferScenarioTheme(legacyRequest.context_type)
    };
  }

  /**
   * Convert enhanced response back to legacy format
   */
  convertResponse(enhancedQuestion: any): GeneratedQuestion {
    // Extract original math output or reconstruct it
    const mathOutput = enhancedQuestion.mathOutput || this.reconstructMathOutput(enhancedQuestion);

    // Generate context using original MoneyContextGenerator
    const context = MoneyContextGenerator.generate(enhancedQuestion.mathOutput?.operation || 'ADDITION');

    // Generate question and answer using original StoryEngine
    const question = this.storyEngine.generateQuestion(mathOutput, context);
    const answer = this.storyEngine.generateAnswer(mathOutput, context);

    return {
      question,
      answer,
      math_output: mathOutput,
      context,
      metadata: {
        model_id: enhancedQuestion.mathOutput?.operation || 'UNKNOWN',
        year_level: enhancedQuestion.difficulty?.year || 4,
        sub_level: enhancedQuestion.difficulty?.displayName || '4.3',
        difficulty_params: {},
        enhanced_system_used: true,
        session_id: undefined,
        timestamp: new Date()
      }
    };
  }

  /**
   * Full legacy generation - uses enhanced system but returns legacy format
   */
  async generateLegacyQuestion(request: GenerateRequest): Promise<GeneratedQuestion> {
    try {
      // Convert request to enhanced format
      const enhancedRequest = this.convertRequest(request);

      // Generate using enhanced system
      const enhancedQuestion = await this.orchestrator.generateQuestion(enhancedRequest);

      // Convert back to legacy format
      return this.convertResponse(enhancedQuestion);

    } catch (error) {
      // Fallback to original behavior if enhanced system fails
      console.warn('Enhanced system failed, falling back to legacy generation:', error);
      return this.fallbackToLegacy(request);
    }
  }

  /**
   * Infer scenario theme from legacy context type
   */
  private inferScenarioTheme(contextType?: string): any {
    switch (contextType) {
      case 'money':
        return 'SHOPPING';
      case 'measurement':
        return 'SCHOOL';
      case 'time':
        return 'HOUSEHOLD';
      default:
        return 'SHOPPING'; // Default theme
    }
  }

  /**
   * Reconstruct math output from enhanced question data
   */
  private reconstructMathOutput(enhancedQuestion: any): any {
    const mathValues = enhancedQuestion.parameters?.mathValues || {};
    const operation = enhancedQuestion.mathOutput?.operation || 'ADDITION';

    // Reconstruct based on operation type
    switch (operation) {
      case 'ADDITION':
        return {
          operation: 'ADDITION',
          operands: this.extractOperands(mathValues, 'operand_'),
          result: mathValues.result,
          intermediate_steps: [],
          decimal_formatted: {
            operands: this.extractOperands(mathValues, 'operand_').map(String),
            result: String(mathValues.result)
          }
        };

      case 'SUBTRACTION':
        return {
          operation: 'SUBTRACTION',
          minuend: mathValues.minuend,
          subtrahend: mathValues.subtrahend,
          result: mathValues.result,
          decimal_formatted: {
            minuend: String(mathValues.minuend),
            subtrahend: String(mathValues.subtrahend),
            result: String(mathValues.result)
          }
        };

      case 'MULTIPLICATION':
        return {
          operation: 'MULTIPLICATION',
          multiplicand: mathValues.multiplicand,
          multiplier: mathValues.multiplier,
          result: mathValues.result,
          factors: [mathValues.multiplicand, mathValues.multiplier],
          decimal_formatted: {
            result: String(mathValues.result)
          }
        };

      case 'DIVISION':
        return {
          operation: 'DIVISION',
          dividend: mathValues.dividend,
          divisor: mathValues.divisor,
          quotient: mathValues.quotient,
          remainder: mathValues.remainder || 0,
          decimal_formatted: {
            quotient: String(mathValues.quotient)
          }
        };

      default:
        return {
          operation,
          result: mathValues.result || 0,
          decimal_formatted: {
            result: String(mathValues.result || 0)
          }
        };
    }
  }

  /**
   * Extract operands from math values with prefix
   */
  private extractOperands(mathValues: Record<string, number>, prefix: string): number[] {
    return Object.keys(mathValues)
      .filter(key => key.startsWith(prefix))
      .sort() // Ensure correct order
      .map(key => mathValues[key]);
  }

  /**
   * Fallback to original legacy generation
   */
  private async fallbackToLegacy(request: GenerateRequest): Promise<GeneratedQuestion> {
    // Import original generation function
    const { generateMathQuestion } = await import('@/lib/math-engine');

    const mathOutput = generateMathQuestion(
      request.model_id as any,
      request.year_level || 4,
      request.difficulty_params
    );

    const context = MoneyContextGenerator.generate(request.model_id);
    const question = this.storyEngine.generateQuestion(mathOutput, context);
    const answer = this.storyEngine.generateAnswer(mathOutput, context);

    return {
      question,
      answer,
      math_output: mathOutput,
      context,
      metadata: {
        model_id: request.model_id,
        year_level: request.year_level || 4,
        difficulty_params: request.difficulty_params,
        enhanced_system_used: false,
        timestamp: new Date()
      }
    };
  }
}

/**
 * Enhanced backward compatibility layer
 * Can be used to gradually migrate existing code
 */
export class CompatibilityLayer {
  private adapter: LegacyAdapter;

  constructor(orchestrator: QuestionOrchestrator) {
    this.adapter = new LegacyAdapter(orchestrator);
  }

  /**
   * Drop-in replacement for generateMathQuestion
   */
  async generateMathQuestion(
    modelId: string,
    yearLevel: number,
    difficultyParams?: any
  ): Promise<any> {
    const request: GenerateRequest = {
      model_id: modelId,
      year_level: yearLevel,
      difficulty_params: difficultyParams,
      context_type: 'money'
    };

    const result = await this.adapter.generateLegacyQuestion(request);
    return result.math_output;
  }

  /**
   * Drop-in replacement for StoryEngine.generateQuestion
   */
  generateQuestion(mathOutput: any, context: any): string {
    return this.adapter['storyEngine'].generateQuestion(mathOutput, context);
  }

  /**
   * Drop-in replacement for StoryEngine.generateAnswer
   */
  generateAnswer(mathOutput: any, context: any): string {
    return this.adapter['storyEngine'].generateAnswer(mathOutput, context);
  }

  /**
   * Enhanced generation with fallback
   */
  async generateWithFallback(request: GenerateRequest): Promise<GeneratedQuestion> {
    return this.adapter.generateLegacyQuestion(request);
  }
}

/**
 * Migration utility functions
 */
export class MigrationUtils {
  /**
   * Check if a request can use enhanced features
   */
  static canUseEnhanced(request: any): boolean {
    // Check if request has enhanced-specific fields
    return !!(
      request.format_preference ||
      request.scenario_theme ||
      request.pedagogical_focus ||
      request.difficulty_level?.includes('.')
    );
  }

  /**
   * Convert old difficulty params to enhanced format
   */
  static upgradeRequest(oldRequest: GenerateRequest): EnhancedQuestionRequest {
    return {
      model_id: oldRequest.model_id,
      year_level: oldRequest.year_level,
      difficulty_params: oldRequest.difficulty_params,
      cultural_context: 'UK'
    };
  }

  /**
   * Test compatibility between old and new systems
   */
  static async testCompatibility(
    request: GenerateRequest,
    legacyFunction: (request: GenerateRequest) => Promise<GeneratedQuestion>,
    enhancedAdapter: LegacyAdapter
  ): Promise<{
    legacy: GeneratedQuestion;
    enhanced: GeneratedQuestion;
    compatible: boolean;
    differences: string[];
  }> {
    const legacy = await legacyFunction(request);
    const enhanced = await enhancedAdapter.generateLegacyQuestion(request);

    const differences: string[] = [];

    // Compare key fields
    if (legacy.question !== enhanced.question) {
      differences.push('Question text differs');
    }

    if (legacy.answer !== enhanced.answer) {
      differences.push('Answer differs');
    }

    if (legacy.math_output.operation !== enhanced.math_output.operation) {
      differences.push('Math operation differs');
    }

    if (legacy.math_output.result !== enhanced.math_output.result) {
      differences.push('Math result differs');
    }

    return {
      legacy,
      enhanced,
      compatible: differences.length === 0,
      differences
    };
  }
}

/**
 * Feature flag system for gradual rollout
 */
export class FeatureFlags {
  private static flags: Map<string, boolean> = new Map([
    ['enhanced_distractors', false],
    ['rich_scenarios', false],
    ['comparison_questions', false],
    ['enhanced_difficulty', false],
    ['full_enhanced_system', false]
  ]);

  static isEnabled(flag: string): boolean {
    return this.flags.get(flag) || false;
  }

  static enable(flag: string): void {
    this.flags.set(flag, true);
  }

  static disable(flag: string): void {
    this.flags.set(flag, false);
  }

  static getAll(): Record<string, boolean> {
    return Object.fromEntries(this.flags);
  }

  /**
   * Determine which system to use based on flags and request
   */
  static shouldUseEnhanced(request: any): boolean {
    // Always use enhanced if explicitly requested
    if (MigrationUtils.canUseEnhanced(request)) {
      return true;
    }

    // Use feature flags for gradual rollout
    if (this.isEnabled('full_enhanced_system')) {
      return true;
    }

    // Specific feature flags
    if (request.format_preference && this.isEnabled('comparison_questions')) {
      return true;
    }

    if (request.difficulty_level?.includes('.') && this.isEnabled('enhanced_difficulty')) {
      return true;
    }

    return false;
  }
}
```
--- END FILE: lib\adapters\legacy-adapter.ts ---

--- START FILE: lib\controllers\base-question.controller.ts ---
```typescript
// Base Question Controller - Abstract pattern for format-specific question generation
// Provides common functionality and enforces consistent interface

import {
  QuestionDefinition,
  QuestionFormat,
  ScenarioContext,
  ScenarioTheme,
  SubDifficultyLevel,
  DistractorContext,
  Distractor
} from '@/lib/types/question-formats';
import { formatValue, formatCurrency } from '@/lib/utils';
import { EnhancedDifficultySystem } from '@/lib/math-engine/difficulty-enhanced';

// Import existing types for compatibility
import { IMathModel } from '@/lib/types';

/**
 * Dependencies injected into controllers
 */
export interface ControllerDependencies {
  mathEngine: MathEngine;
  scenarioService: ScenarioService;
  distractorEngine: DistractorEngine;
}

/**
 * Parameters for question generation
 */
export interface GenerationParams {
  mathModel: string;
  difficulty: SubDifficultyLevel;
  difficultyParams?: any;
  preferredTheme?: ScenarioTheme;
  culturalContext?: string;
  sessionId?: string;
}

/**
 * Abstract base class for all question format controllers
 * Provides common functionality while enforcing specific implementation requirements
 */
export abstract class QuestionController {
  protected mathEngine: MathEngine;
  protected scenarioService: ScenarioService;
  protected distractorEngine: DistractorEngine;

  constructor(dependencies: ControllerDependencies) {
    this.mathEngine = dependencies.mathEngine;
    this.scenarioService = dependencies.scenarioService;
    this.distractorEngine = dependencies.distractorEngine;
  }

  /**
   * Main generation method - must be implemented by each format controller
   */
  abstract generate(params: GenerationParams): Promise<QuestionDefinition>;

  /**
   * Common validation logic for all controllers
   */
  protected validateParams(params: GenerationParams): void {
    if (!params.mathModel || !params.difficulty) {
      throw new Error('Invalid generation parameters: mathModel and difficulty are required');
    }

    if (params.difficulty.year < 1 || params.difficulty.year > 6) {
      throw new Error('Year level must be between 1 and 6');
    }

    if (params.difficulty.subLevel < 1 || params.difficulty.subLevel > 4) {
      throw new Error('Sub level must be between 1 and 4');
    }
  }

  /**
   * Common scenario selection logic
   */
  protected async selectScenario(criteria: any): Promise<ScenarioContext> {
    return this.scenarioService.selectScenario({
        ...criteria,
        culturalContext: 'UK'
    });
  }

  /**
   * Common distractor generation
   */
  protected async generateDistractors(
    correctAnswer: any,
    context: DistractorContext,
    count: number = 3
  ): Promise<Distractor[]> {
    return this.distractorEngine.generate(correctAnswer, context, count);
  }

  /**
   * Generate math output using existing math engine
   */
  protected async generateMathOutput(
    model: string,
    params: any
  ): Promise<any> {
    return this.mathEngine.generate(model, params);
  }

   /**
   * Get difficulty parameters, prioritizing custom params over sub-level defaults.
   */
  protected getEffectiveDifficultyParams(params: GenerationParams): any {
    if (params.difficultyParams && Object.keys(params.difficultyParams).length > 0) {
      return params.difficultyParams;
    }
    try {
      return EnhancedDifficultySystem.getSubLevelParams(params.mathModel, params.difficulty);
    } catch (e) {
      console.warn(`Could not get enhanced difficulty for ${params.mathModel}, falling back to legacy defaults.`);
      const model = this.mathEngine.getModel(params.mathModel);
      return model.getDefaultParams(params.difficulty.year);
    }
  }

  /**
   * Create base question definition structure
   */
  protected createBaseQuestionDefinition(
    format: QuestionFormat,
    mathModel: string,
    difficulty: SubDifficultyLevel,
    scenario: ScenarioContext
  ): Partial<QuestionDefinition> {
    return {
      id: this.generateQuestionId(),
      timestamp: new Date(),
      format,
      mathModel,
      difficulty,
      scenario,
      metadata: {
        curriculumAlignment: this.getCurriculumAlignment(mathModel, difficulty.year),
        pedagogicalTags: this.getPedagogicalTags(format, mathModel),
        cognitiveSkills: this.getCognitiveSkills(format),
        estimatedTime: this.estimateCompletionTime(format, difficulty),
        accessibility: {
          readingLevel: this.getReadingLevel(difficulty.year),
          visualElements: this.hasVisualElements(format),
          assistiveTechFriendly: true
        }
      }
    };
  }

  /**
   * Generate unique question identifier
   */
  private generateQuestionId(): string {
    return `q_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  /**
   * Get curriculum alignment tags for a model and year
   */
  private getCurriculumAlignment(mathModel: string, year: number): string[] {
    // Map to UK National Curriculum objectives
    const alignmentMap: Record<string, Record<number, string[]>> = {
      ADDITION: {
        1: ['1N1a', '1N1b'], 2: ['2N1a', '2N1b', '2N1c'], 3: ['3N1a', '3N1b'],
        4: ['4N1a', '4N1b'], 5: ['5N1a', '5N1b'], 6: ['6N1a', '6N1b']
      },
      SUBTRACTION: {
        1: ['1N1c', '1N1d'], 2: ['2N1d', '2N1e'], 3: ['3N1c', '3N1d'],
        4: ['4N1c', '4N1d'], 5: ['5N1c', '5N1d'], 6: ['6N1c', '6N1d']
      },
      MULTIPLICATION: {
        2: ['2N1a'], 3: ['3N1a'], 4: ['4N1a'], 5: ['5N1a'], 6: ['6N1a']
      },
       DIVISION: {
        3: ['3N1a'], 4: ['4N1a'], 5: ['5N1a'], 6: ['6N1a']
      }
      // Add more models as needed
    };

    return alignmentMap[mathModel]?.[year] || [`${year}N1a`];
  }

  /**
   * Get pedagogical tags for format and model combination
   */
  private getPedagogicalTags(format: QuestionFormat, mathModel: string): string[] {
    const formatTags = {
      [QuestionFormat.DIRECT_CALCULATION]: ['calculation', 'fluency'],
      [QuestionFormat.COMPARISON]: ['reasoning', 'problem_solving'],
      [QuestionFormat.ESTIMATION]: ['reasoning', 'number_sense'],
      [QuestionFormat.VALIDATION]: ['problem_solving', 'reasoning'],
      [QuestionFormat.MULTI_STEP]: ['problem_solving', 'fluency'],
      [QuestionFormat.MISSING_VALUE]: ['reasoning', 'algebra'],
      [QuestionFormat.ORDERING]: ['reasoning', 'number_sense'],
      [QuestionFormat.PATTERN_RECOGNITION]: ['reasoning', 'algebra']
    };

    return [...(formatTags[format] || []), mathModel.toLowerCase()];
  }

  /**
   * Get cognitive skills required for format
   */
  private getCognitiveSkills(format: QuestionFormat): string[] {
    const skillsMap = {
      [QuestionFormat.DIRECT_CALCULATION]: ['procedural_fluency'],
      [QuestionFormat.COMPARISON]: ['critical_thinking', 'analysis'],
      [QuestionFormat.ESTIMATION]: ['number_sense', 'approximation'],
      [QuestionFormat.VALIDATION]: ['logical_reasoning', 'problem_solving'],
      [QuestionFormat.MULTI_STEP]: ['working_memory', 'sequential_processing'],
      [QuestionFormat.MISSING_VALUE]: ['algebraic_thinking', 'pattern_recognition'],
      [QuestionFormat.ORDERING]: ['comparison', 'sequencing'],
      [QuestionFormat.PATTERN_RECOGNITION]: ['pattern_recognition', 'prediction']
    };

    return skillsMap[format] || ['mathematical_reasoning'];
  }

  /**
   * Estimate completion time for different formats and difficulties
   */
  private estimateCompletionTime(format: QuestionFormat, difficulty: SubDifficultyLevel): number {
    const baseTime = {
      [QuestionFormat.DIRECT_CALCULATION]: 30,
      [QuestionFormat.COMPARISON]: 60,
      [QuestionFormat.ESTIMATION]: 45,
      [QuestionFormat.VALIDATION]: 40,
      [QuestionFormat.MULTI_STEP]: 90,
      [QuestionFormat.MISSING_VALUE]: 50,
      [QuestionFormat.ORDERING]: 35,
      [QuestionFormat.PATTERN_RECOGNITION]: 55
    };

    const difficultyMultiplier = 1 + (difficulty.year - 1) * 0.15 + (difficulty.subLevel - 1) * 0.1;
    return Math.round((baseTime[format] || 45) * difficultyMultiplier);
  }

  /**
   * Get reading level for year
   */
  private getReadingLevel(year: number): number {
    return year;
  }

  /**
   * Check if format typically includes visual elements
   */
  private hasVisualElements(format: QuestionFormat): boolean {
    return [
      QuestionFormat.COMPARISON,
      QuestionFormat.ESTIMATION,
      QuestionFormat.ORDERING,
      QuestionFormat.PATTERN_RECOGNITION
    ].includes(format);
  }

  /**
   * Format values according to context (centralized utility)
   */
  protected formatValue(value: number, units?: string, decimalPlaces: number = 2): string {
    return formatValue(value, units, decimalPlaces);
  }

  /**
   * Format currency values (centralized utility)
   */
  protected formatCurrency(value: number): string {
    return formatCurrency(value);
  }
}

/**
 * Interface definitions for injected dependencies
 * These will be implemented by the actual service classes
 */
export interface MathEngine {
  generate(model: string, params: any): Promise<any>;
  getModel(modelId: string): IMathModel<any, any>;
}

export interface ScenarioService {
  selectScenario(criteria: any): Promise<ScenarioContext>;
  generateDynamicScenario(theme: ScenarioTheme, yearLevel: number): Promise<ScenarioContext>;
}

export interface DistractorEngine {
  generate(correctAnswer: any, context: DistractorContext, count?: number): Promise<Distractor[]>;
}
```
--- END FILE: lib\controllers\base-question.controller.ts ---

--- START FILE: lib\controllers\comparison.controller.ts ---
```typescript
// Comparison Controller - Handles "Which is better value?" and comparison questions
// Leverages existing UNIT_RATE and COMPARISON models

import {
  QuestionController,
  GenerationParams,
  ControllerDependencies
} from './base-question.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  QuestionParameters,
  QuestionSolution,
  DistractorContext,
  DistractorStrategy,
  Distractor,
  Answer
} from '@/lib/types/question-formats';

/**
 * Data structure for comparison calculations
 */
interface ComparisonData {
  type: 'unit_rate' | 'direct_value' | 'quantity_comparison';
  options: ComparisonOption[];
  comparisonMetric: string;
  context: string;
}

interface ComparisonOption {
  label: string;
  quantity?: number;
  price?: number;
  value: number;
  unitRate?: number;
  displayText: string;
}

interface ComparisonSolution {
  correctAnswer: Answer;
  winner: {
    index: number;
    label: string;
    advantage: string;
    difference?: number;
  };
}

/**
 * Generates comparison questions like "Which is better value?"
 * Works with UNIT_RATE, COMPARISON, and custom comparison scenarios
 */
export class ComparisonController extends QuestionController {
  constructor(dependencies: ControllerDependencies) {
    super(dependencies);
  }

  async generate(params: GenerationParams): Promise<QuestionDefinition> {
    this.validateParams(params);

    // 1. Generate comparison data using math engine
    const comparisonData = await this.generateComparisonData(params);

    // 2. Select appropriate scenario for comparison
    const scenario = await this.selectScenario({
      format: QuestionFormat.COMPARISON,
      yearLevel: params.difficulty.year,
      theme: params.preferredTheme,
      mathModel: params.mathModel
    });

    // 3. Calculate the comparison result
    const solution = this.performComparison(comparisonData);

    // 4. Generate comparison-specific distractors
    const distractors = await this.generateComparisonDistractors(
      solution,
      comparisonData,
      params
    );

    // 5. Create question parameters
    const questionParams = this.createComparisonParameters(comparisonData, scenario);

    // 6. Update solution with distractors
    const completeSolution: QuestionSolution = {
      correctAnswer: solution.correctAnswer,
      distractors,
      explanation: this.generateComparisonExplanation(solution, comparisonData),
      workingSteps: this.generateComparisonSteps(solution, comparisonData),
      solutionStrategy: 'comparison_analysis'
    };

    // 7. Assemble complete question definition
    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.COMPARISON,
      params.mathModel,
      params.difficulty,
      scenario
    );

    return {
      ...baseDefinition,
      parameters: questionParams,
      solution: completeSolution
    } as QuestionDefinition;
  }

  /**
   * Generate comparison data using the math engine
   */
  private async generateComparisonData(params: GenerationParams): Promise<ComparisonData> {
    const model = params.mathModel;
    const effectiveDifficultyParams = this.getEffectiveDifficultyParams(params);

    if (model === 'UNIT_RATE') {
      return this.generateUnitRateComparison(params);
    } else if (model === 'COMPARISON') {
      return this.generateDirectComparison(params);
    } else if (['ADDITION', 'MULTIPLICATION', 'PERCENTAGE'].includes(model)) {
      return this.generateCalculationComparison(params);
    } else {
      // Fallback for incompatible models
      console.warn(`Comparison format fallback for model: ${model}. Generating direct value comparison.`);
      return this.generateCalculationComparison({ ...params, mathModel: 'ADDITION' });
    }
  }

  /**
   * Generate unit rate comparison (e.g., price per unit)
   */
  private async generateUnitRateComparison(params: GenerationParams): Promise<ComparisonData> {
    const effectiveParams = this.getEffectiveDifficultyParams(params);
    // Generate two separate unit rate calculations
    const option1Data = await this.generateMathOutput('UNIT_RATE', {
      ...effectiveParams,
      base_quantity: this.generateQuantity(params.difficulty.year),
      target_quantity: 1,
      problem_type: 'find_unit_rate'
    });

    const option2Data = await this.generateMathOutput('UNIT_RATE', {
      ...effectiveParams,
      base_quantity: this.generateQuantity(params.difficulty.year),
      target_quantity: 1,
      problem_type: 'find_unit_rate'
    });

    const options: ComparisonOption[] = [
      {
        label: 'Option A',
        quantity: option1Data.base_quantity,
        price: option1Data.base_rate,
        value: option1Data.base_rate,
        unitRate: option1Data.unit_rate,
        displayText: `${option1Data.base_quantity} for ${this.formatValue(option1Data.base_rate, 'Â£')}`
      },
      {
        label: 'Option B',
        quantity: option2Data.base_quantity,
        price: option2Data.base_rate,
        value: option2Data.base_rate,
        unitRate: option2Data.unit_rate,
        displayText: `${option2Data.base_quantity} for ${this.formatValue(option2Data.base_rate, 'Â£')}`
      }
    ];

    return {
      type: 'unit_rate',
      options,
      comparisonMetric: 'price_per_unit',
      context: option1Data.item || 'items'
    };
  }

  /**
   * Generate direct value comparison
   */
  private async generateDirectComparison(params: GenerationParams): Promise<ComparisonData> {
    const effectiveParams = this.getEffectiveDifficultyParams(params);
    const comparisonOutput = await this.generateMathOutput('COMPARISON', effectiveParams);

    const options: ComparisonOption[] = comparisonOutput.options.map((option: any, index: number) => ({
      label: String.fromCharCode(65 + index), // A, B, C...
      quantity: option.quantity,
      value: option.value,
      displayText: option.quantity
        ? `${option.quantity}ml for ${this.formatValue(option.value, 'Â£')}`
        : `${this.formatValue(option.value, 'Â£')}`
    }));

    return {
      type: 'direct_value',
      options,
      comparisonMetric: comparisonOutput.comparison_type || 'value',
      context: 'general'
    };
  }

  /**
   * Generate comparison from calculation models
   */
  private async generateCalculationComparison(params: GenerationParams): Promise<ComparisonData> {
    const effectiveParams = this.getEffectiveDifficultyParams(params);
    // Generate two calculations with different parameters
    const calc1 = await this.generateMathOutput(params.mathModel, effectiveParams);
    const calc2 = await this.generateMathOutput(params.mathModel, {
      ...effectiveParams,
      // Slightly modify parameters for variation
      ...(params.mathModel === 'ADDITION' && { operand_count: Math.max(2, (effectiveParams?.operand_count || 3) - 1) }),
      ...(params.mathModel === 'MULTIPLICATION' && { multiplier_max: Math.max(5, (effectiveParams?.multiplier_max || 10) + 2) })
    });

    const options: ComparisonOption[] = [
      {
        label: 'Option A',
        value: calc1.result || calc1.quotient || calc1.final_result,
        displayText: this.formatCalculationForComparison(calc1, 'A')
      },
      {
        label: 'Option B',
        value: calc2.result || calc2.quotient || calc2.final_result,
        displayText: this.formatCalculationForComparison(calc2, 'B')
      }
    ];

    return {
      type: 'direct_value',
      options,
      comparisonMetric: 'calculated_value',
      context: params.mathModel.toLowerCase()
    };
  }

  /**
   * Perform the comparison and determine the winner
   */
  private performComparison(data: ComparisonData): ComparisonSolution {
    let winnerIndex: number;
    let advantage: string;
    let difference: number | undefined;

    if (data.type === 'unit_rate' && data.options[0].unitRate !== undefined) {
      const rates = data.options.map(opt => opt.unitRate!);
      winnerIndex = rates[0] < rates[1] ? 0 : 1;
      difference = Math.abs(rates[0] - rates[1]);
      advantage = `${this.formatValue(difference, 'Â£')} per unit cheaper`;
    } else {
      const values = data.options.map(opt => opt.value);
      winnerIndex = values[0] > values[1] ? 0 : 1;
      difference = Math.abs(values[0] - values[1]);
      advantage = `${this.formatValue(difference, 'Â£')} more`;
    }

    const winner = data.options[winnerIndex];

    return {
      correctAnswer: {
        value: winnerIndex,
        displayText: `${winner.label} is better value`,
        metadata: {
          winnerIndex,
          difference,
          comparisonType: data.type
        }
      },
      winner: {
        index: winnerIndex,
        label: winner.label,
        advantage,
        difference
      }
    };
  }

  /**
   * Generate comparison-specific distractors
   */
  private async generateComparisonDistractors(
    solution: ComparisonSolution,
    data: ComparisonData,
    params: GenerationParams
  ): Promise<Distractor[]> {
    const distractors: Distractor[] = [];

    // Wrong option selected (most common error)
    const wrongIndex = solution.winner.index === 0 ? 1 : 0;
    const wrongOption = data.options[wrongIndex];
    distractors.push({
      value: wrongIndex,
      displayText: `${wrongOption.label} is better value`,
      strategy: DistractorStrategy.REVERSED_COMPARISON,
      reasoning: data.type === 'unit_rate'
        ? 'Selected the option with higher total price instead of better unit price'
        : 'Selected the option with lower value'
    });

    // They're the same (common misconception)
    distractors.push({
      value: -1,
      displayText: 'Both options are equally good value',
      strategy: DistractorStrategy.WRONG_SELECTION,
      reasoning: 'Failed to calculate the difference correctly'
    });

    // Calculation error in difference
    if (solution.winner.difference) {
      const wrongDiff = solution.winner.difference * 2;
      distractors.push({
        value: solution.winner.index,
        displayText: `${solution.winner.label} saves you ${this.formatValue(wrongDiff, 'Â£')}`,
        strategy: DistractorStrategy.CALCULATION_ERROR,
        reasoning: 'Arithmetic error in calculating the difference'
      });
    }

    return distractors;
  }

  /**
   * Create question parameters for comparison
   */
  private createComparisonParameters(data: ComparisonData, scenario: any): QuestionParameters {
    const mathValues: Record<string, number> = {};
    const narrativeValues: Record<string, any> = {};
    const units: Record<string, string> = {};

    data.options.forEach((option, index) => {
      mathValues[`option_${index + 1}_value`] = option.value;
      if (option.quantity) mathValues[`option_${index + 1}_quantity`] = option.quantity;
      if (option.price) mathValues[`option_${index + 1}_price`] = option.price;
      if (option.unitRate) mathValues[`option_${index + 1}_unit_rate`] = option.unitRate;
    });

    narrativeValues.options = data.options.map(opt => opt.displayText);
    narrativeValues.context = data.context;
    narrativeValues.comparison_type = data.comparisonMetric;

    if (scenario.characters && scenario.characters.length > 0) {
      narrativeValues.character = scenario.characters[0].name;
    }

    units.currency = 'Â£';
    units.comparison_metric = data.comparisonMetric;

    return {
      mathValues,
      narrativeValues,
      units,
      formatting: {
        currencyFormat: 'symbol',
        decimalPlaces: 2,
        useGroupingSeparators: false,
        unitPosition: 'before'
      }
    };
  }

  /**
   * Generate explanation for the comparison
   */
  private generateComparisonExplanation(solution: ComparisonSolution, data: ComparisonData): string {
    if (data.type === 'unit_rate') {
      const winner = data.options[solution.winner.index];
      const loser = data.options[solution.winner.index === 0 ? 1 : 0];

      return `${winner.label} offers better value. ` +
             `${winner.label} costs ${this.formatValue(winner.unitRate!, 'Â£')} per unit, ` +
             `while ${loser.label} costs ${this.formatValue(loser.unitRate!, 'Â£')} per unit. ` +
             `${winner.label} is ${this.formatValue(Math.abs(winner.unitRate! - loser.unitRate!), 'Â£')} cheaper per unit.`;
    } else {
      const winner = data.options[solution.winner.index];
      return `${winner.label} has the higher value at ${this.formatValue(winner.value, 'Â£')}.`;
    }
  }

  /**
   * Generate working steps for comparison
   */
  private generateComparisonSteps(solution: ComparisonSolution, data: ComparisonData): string[] {
    const steps: string[] = [];

    if (data.type === 'unit_rate') {
      data.options.forEach((option, index) => {
        const unitRate = option.price! / option.quantity!;
        steps.push(`${option.label}: ${this.formatValue(option.price!, 'Â£')} Ã· ${option.quantity} = ${this.formatValue(unitRate, 'Â£')} per unit`);
      });

      const winner = data.options[solution.winner.index];
      steps.push(`${winner.label} has the lowest price per unit, so it's better value.`);
    } else {
      data.options.forEach((option) => {
        steps.push(`${option.label}: ${this.formatValue(option.value, 'Â£')}`);
      });

      const winner = data.options[solution.winner.index];
      steps.push(`${winner.label} has the highest value.`);
    }

    return steps;
  }

  /**
   * Generate appropriate quantities based on year level
   */
  private generateQuantity(year: number): number {
    const ranges = {
      1: [2, 5], 2: [3, 8], 3: [4, 10], 4: [5, 15], 5: [6, 20], 6: [8, 25]
    };
    const [min, max] = ranges[year as keyof typeof ranges] || [5, 15];
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  /**
   * Format a calculation result for comparison display
   */
  private formatCalculationForComparison(calc: any, label: string): string {
    if (calc.operation === 'ADDITION' && calc.operands) {
      return `${label}: ${calc.operands.join(' + ')} = ${calc.result}`;
    } else if (calc.operation === 'MULTIPLICATION') {
      return `${label}: ${calc.multiplicand} Ã ${calc.multiplier} = ${calc.result}`;
    } else {
      return `${label}: ${calc.result || calc.quotient || calc.final_result}`;
    }
  }
}
```
--- END FILE: lib\controllers\comparison.controller.ts ---

--- START FILE: lib\controllers\direct-calculation.controller.ts ---
```typescript
// Direct Calculation Controller - Handles traditional calculation questions
// This is the simplest format that maps closely to the existing question generation flow

import {
  QuestionController,
  GenerationParams,
  ControllerDependencies
} from './base-question.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  QuestionParameters,
  QuestionSolution,
  DistractorContext,
  DistractorStrategy,
  Distractor,
  FormattingOptions
} from '@/lib/types/question-formats';
import { EnhancedDifficultySystem } from '@/lib/math-engine/difficulty-enhanced';

/**
 * Generates direct calculation questions like "What is 25 + 17?"
 * This format most closely matches the existing system behavior
 */
export class DirectCalculationController extends QuestionController {
  constructor(dependencies: ControllerDependencies) {
    super(dependencies);
  }

  async generate(params: GenerationParams): Promise<QuestionDefinition> {
    this.validateParams(params);

    // Get difficulty params from the enhanced system if not provided
    const effectiveDifficultyParams = this.getEffectiveDifficultyParams(params);

    // 1. Generate mathematical output using existing math engine
    const mathOutput = await this.generateMathOutput(
      params.mathModel,
      effectiveDifficultyParams
    );

    // 2. Select appropriate scenario for this calculation
    const scenario = await this.selectScenario({
        format: QuestionFormat.DIRECT_CALCULATION,
        yearLevel: params.difficulty.year,
        theme: params.preferredTheme,
        mathModel: params.mathModel
    });

    // 3. Create question parameters from math output
    const questionParams = this.createQuestionParameters(mathOutput, scenario);

    // 4. Generate the correct answer
    const correctAnswer = this.generateCorrectAnswer(mathOutput, questionParams);

    // 5. Generate distractors using enhanced distractor engine
    const distractors = await this.generateCalculationDistractors(
      correctAnswer,
      mathOutput,
      params
    );

    // 6. Create solution object
    const solution: QuestionSolution = {
      correctAnswer,
      distractors,
      explanation: this.generateExplanation(mathOutput, questionParams),
      workingSteps: this.generateWorkingSteps(mathOutput),
      solutionStrategy: this.getSolutionStrategy(params.mathModel)
    };

    // 7. Assemble complete question definition
    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.DIRECT_CALCULATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    return {
      ...baseDefinition,
      parameters: questionParams,
      solution
    } as QuestionDefinition;
  }

  /**
   * Create question parameters from math output and scenario
   */
  private createQuestionParameters(mathOutput: any, scenario: any): QuestionParameters {
    const mathValues: Record<string, any> = { ...mathOutput };
    const narrativeValues: Record<string, any> = {};
    const units: Record<string, string> = {};

    if (scenario.characters && scenario.characters.length > 0) {
      narrativeValues.character = scenario.characters[0].name;
    }
    if (scenario.setting) {
      narrativeValues.location = scenario.setting.location;
    }
    if (scenario.culturalElements?.some((e: any) => e.type === 'currency')) {
        units.result = 'Â£';
    }

    const operands = this.extractOperands(mathOutput);

    if (scenario.theme === 'SHOPPING' && operands.length > 0) {
        const availableItems = scenario.items?.map((item: any) => item.name) || ['item'];
        const itemsToBuy: string[] = [];
        for (let i = 0; i < operands.length; i++) {
            itemsToBuy.push(availableItems[i % availableItems.length]);
        }

        if (mathOutput.operation === 'ADDITION') {
            narrativeValues.purchases = operands.map((price, index) => 
                `a ${itemsToBuy[index]} for ${this.formatValue(price, 'Â£')}`
            ).join(' and ');
        } else if (mathOutput.operation === 'MULTIPLICATION') {
            narrativeValues.quantity = mathOutput.multiplier;
            narrativeValues.item = itemsToBuy[0];
            narrativeValues.price = this.formatValue(mathOutput.multiplicand, 'Â£');
        } else if (mathOutput.operation === 'SUBTRACTION') {
             narrativeValues.totalAmount = this.formatValue(mathOutput.minuend, 'Â£');
             narrativeValues.spentAmount = this.formatValue(mathOutput.subtrahend, 'Â£');
             narrativeValues.item = itemsToBuy[0];
        }

    } else {
        if (scenario.items && scenario.items.length > 0) {
            narrativeValues.item = scenario.items[0]?.name || 'item';
        }
    }

    const formatting: FormattingOptions = {
      currencyFormat: 'symbol',
      decimalPlaces: this.getDecimalPlaces(mathOutput),
      useGroupingSeparators: (mathOutput.result || 0) > 1000,
      unitPosition: 'before'
    };

    return {
      mathValues,
      narrativeValues,
      units,
      formatting
    };
  }

  /**
   * Generate the correct answer from math output
   */
  private generateCorrectAnswer(mathOutput: any, params: QuestionParameters): any {
    let value: number;
    let displayText: string;
    let units: string | undefined = params.units.result;

    if (mathOutput.operation === 'DIVISION' && mathOutput.remainder > 0) {
      value = mathOutput.quotient;
      const remainderText = mathOutput.remainder > 0 ? ` remainder ${mathOutput.remainder}` : '';
      displayText = `${this.formatValue(mathOutput.quotient, units, 0)}${remainderText}`;
    } else {
      value = mathOutput.result ?? mathOutput.quotient ?? mathOutput.final_result;
      if (value === undefined) {
          console.error("Could not determine correct answer from mathOutput", mathOutput);
          value = 0; // Fallback
      }
      displayText = this.formatValue(value, units, params.formatting.decimalPlaces);
    }

    return {
      value,
      displayText,
      units,
      metadata: {
        mathOutput,
        operationType: mathOutput.operation
      }
    };
  }

  /**
   * Generate distractors specific to calculation questions
   */
  private async generateCalculationDistractors(
    correctAnswer: any,
    mathOutput: any,
    params: GenerationParams
  ): Promise<Distractor[]> {
    const context: DistractorContext = {
      mathModel: params.mathModel,
      format: QuestionFormat.DIRECT_CALCULATION,
      operands: this.extractOperands(mathOutput),
      operation: mathOutput.operation,
      yearLevel: params.difficulty.year,
      existingDistractors: []
    };

    const engineDistractors = await this.generateDistractors(correctAnswer.value, context, 3);
    const specificDistractors = this.generateSpecificCalculationDistractors(correctAnswer, mathOutput);
    
    const allDistractors = [...engineDistractors, ...specificDistractors];
    return this.deduplicateDistractors(allDistractors, correctAnswer.value).slice(0, 3);
  }
  
  private generateSpecificCalculationDistractors(correctAnswer: any, mathOutput: any): Distractor[] {
      const distractors: Distractor[] = [];
      const operands = this.extractOperands(mathOutput);
      if(operands.length < 2) return [];

      const [a, b] = operands;

      switch (mathOutput.operation) {
          case 'ADDITION':
              if (a - b > 0 && a - b !== correctAnswer.value) {
                  distractors.push({ value: a - b, displayText: this.formatValue(a - b, correctAnswer.units, 0), strategy: DistractorStrategy.WRONG_OPERATION, reasoning: 'Subtracted instead of adding' });
              }
              break;
          case 'SUBTRACTION':
              if (a + b !== correctAnswer.value) {
                  distractors.push({ value: a + b, displayText: this.formatValue(a + b, correctAnswer.units, 0), strategy: DistractorStrategy.WRONG_OPERATION, reasoning: 'Added instead of subtracting' });
              }
              break;
          case 'MULTIPLICATION':
              if (a + b !== correctAnswer.value) {
                  distractors.push({ value: a + b, displayText: this.formatValue(a + b, correctAnswer.units, 0), strategy: DistractorStrategy.WRONG_OPERATION, reasoning: 'Added instead of multiplying' });
              }
              break;
          case 'DIVISION':
              if (a * b !== correctAnswer.value) {
                  distractors.push({ value: a * b, displayText: this.formatValue(a * b, correctAnswer.units, 0), strategy: DistractorStrategy.WRONG_OPERATION, reasoning: 'Multiplied instead of dividing' });
              }
              break;
      }
      return distractors;
  }

  private extractOperands(mathOutput: any): number[] {
    if (mathOutput.operands) return mathOutput.operands;
    if (mathOutput.minuend !== undefined && mathOutput.subtrahend !== undefined) return [mathOutput.minuend, mathOutput.subtrahend];
    if (mathOutput.multiplicand !== undefined && mathOutput.multiplier !== undefined) return [mathOutput.multiplicand, mathOutput.multiplier];
    if (mathOutput.dividend !== undefined && mathOutput.divisor !== undefined) return [mathOutput.dividend, mathOutput.divisor];
    return [];
  }

  private deduplicateDistractors(distractors: Distractor[], correctValue: number): Distractor[] {
    const seen = new Set([correctValue]);
    const unique: Distractor[] = [];

    for (const distractor of distractors) {
      if (distractor.value !== undefined && !seen.has(distractor.value)) {
        seen.add(distractor.value);
        unique.push(distractor);
      }
    }

    return unique;
  }

  private generateExplanation(mathOutput: any, params: QuestionParameters): string {
    const operation = mathOutput.operation.toLowerCase();
    const operands = this.extractOperands(mathOutput);

    switch (mathOutput.operation) {
      case 'ADDITION':
        return `Add the numbers together: ${operands.join(' + ')} = ${mathOutput.result}`;
      case 'SUBTRACTION':
        return `Subtract: ${operands[0]} - ${operands[1]} = ${mathOutput.result}`;
      case 'MULTIPLICATION':
        return `Multiply: ${operands[0]} Ã ${operands[1]} = ${mathOutput.result}`;
      case 'DIVISION':
        const remainder = mathOutput.remainder ? ` remainder ${mathOutput.remainder}` : '';
        return `Divide: ${operands[0]} Ã· ${operands[1]} = ${mathOutput.quotient}${remainder}`;
      default:
        return `Perform the ${operation} calculation to get the answer.`;
    }
  }

  private generateWorkingSteps(mathOutput: any): string[] {
    if (mathOutput.intermediate_steps && mathOutput.intermediate_steps.length > 0) {
      return mathOutput.intermediate_steps.map((step: any, index: number) => `Step ${index + 1}: ${step}`);
    }
    return [];
  }

  private getSolutionStrategy(mathModel: string): string {
    const strategies: Record<string, string> = {
      ADDITION: 'column_addition',
      SUBTRACTION: 'column_subtraction',
      MULTIPLICATION: 'long_multiplication',
      DIVISION: 'long_division',
      PERCENTAGE: 'percentage_calculation',
      FRACTION: 'fraction_arithmetic'
    };
    return strategies[mathModel] || 'standard_algorithm';
  }

  private getDecimalPlaces(mathOutput: any): number {
    if (mathOutput.decimal_formatted && mathOutput.decimal_formatted.result) {
      const resultStr = String(mathOutput.decimal_formatted.result);
      const decimalIndex = resultStr.indexOf('.');
      return decimalIndex === -1 ? 0 : resultStr.length - decimalIndex - 1;
    }
    return 0;
  }
}
```
--- END FILE: lib\controllers\direct-calculation.controller.ts ---

--- START FILE: lib\controllers\estimation.controller.ts ---
```typescript
// Estimation Controller - Generates estimation and rounding questions
// "Estimate the result of..." or "Round to the nearest..."

import {
  QuestionController,
  GenerationParams,
  ControllerDependencies
} from './base-question.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  Distractor,
  DistractorStrategy,
  ScenarioTheme
} from '@/lib/types/question-formats';

/**
 * Estimation-specific parameters
 */
interface EstimationParams {
  estimationType: 'round' | 'approximate' | 'magnitude' | 'benchmark';
  roundingPlace?: 'ones' | 'tens' | 'hundreds' | 'thousands' | 'tenths' | 'hundredths';
  toleranceRange?: number; // Acceptable range for estimates (e.g., Â±10%)
  showWorkingHint?: boolean;
}

/**
 * Controller for generating estimation and rounding questions
 */
export class EstimationController extends QuestionController {

  constructor(dependencies: ControllerDependencies) {
    super(dependencies);
  }

  /**
   * Generate estimation-focused question
   */
  async generate(params: GenerationParams): Promise<QuestionDefinition> {
    // 1. Generate base math content
    const mathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);

    // 2. Select appropriate scenario
    const scenario = await this.selectScenario(
      QuestionFormat.ESTIMATION,
      params.difficulty.year,
      params.preferredTheme || ScenarioTheme.SHOPPING,
      params.mathModel
    );

    // 3. Determine estimation type based on math model and difficulty
    const estimationParams = this.determineEstimationParams(params.mathModel, mathOutput, params.difficulty);

    // 4. Generate estimation question variants
    let questionDef: QuestionDefinition;

    switch (estimationParams.estimationType) {
      case 'round':
        questionDef = await this.generateRoundingQuestion(mathOutput, scenario, estimationParams, params);
        break;
      case 'approximate':
        questionDef = await this.generateApproximationQuestion(mathOutput, scenario, estimationParams, params);
        break;
      case 'magnitude':
        questionDef = await this.generateMagnitudeQuestion(mathOutput, scenario, estimationParams, params);
        break;
      case 'benchmark':
        questionDef = await this.generateBenchmarkQuestion(mathOutput, scenario, estimationParams, params);
        break;
      default:
        questionDef = await this.generateApproximationQuestion(mathOutput, scenario, estimationParams, params);
    }

    return questionDef;
  }

  /**
   * Generate rounding-based estimation question
   */
  private async generateRoundingQuestion(
    mathOutput: any,
    scenario: any,
    estimationParams: EstimationParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.ESTIMATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    // Extract the exact result for rounding
    const exactValue = mathOutput.result || mathOutput.answer || mathOutput.value || 0;
    const roundingPlace = estimationParams.roundingPlace || 'tens';

    // Calculate rounded value
    const roundedValue = this.performRounding(exactValue, roundingPlace);

    // Generate question text with scenario context
    const questionText = this.generateRoundingQuestionText(scenario, mathOutput, roundingPlace);

    // Generate distractors for rounding
    const distractors = await this.generateRoundingDistractors(exactValue, roundedValue, roundingPlace);

    // Create proper QuestionParameters structure
    const parameters = {
      mathValues: {
        ...mathOutput,
        exactValue,
        roundedValue
      },
      narrativeValues: {
        character: scenario.characters?.[0]?.name || 'Student',
        roundingPlace,
        operation: this.describeOperation(mathOutput)
      },
      units: {
        input: 'Â£',
        result: 'Â£'
      },
      formatting: {
        currencyFormat: 'symbol' as const,
        decimalPlaces: 2,
        useGroupingSeparators: roundedValue > 1000,
        unitPosition: 'before' as const
      }
    };

    return {
      ...baseDefinition,
      parameters,
      questionContent: {
        fullText: questionText,
        components: undefined,
        templateData: {
          character: scenario.characters?.[0]?.name || 'Student',
          operation: this.describeOperation(mathOutput),
          roundingPlace,
          exactValue: String(exactValue),
          roundedValue: String(roundedValue)
        }
      },
      solution: {
        correctAnswer: {
          value: roundedValue,
          displayText: this.formatValue(roundedValue, 'Â£', 0),
          units: 'Â£'
        },
        distractors,
        workingSteps: this.generateRoundingSteps(exactValue, roundedValue, roundingPlace),
        explanation: `Rounding ${exactValue} to the nearest ${roundingPlace} gives ${roundedValue}`,
        solutionStrategy: 'rounding_estimation'
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Generate approximation-based estimation question
   */
  private async generateApproximationQuestion(
    mathOutput: any,
    scenario: any,
    estimationParams: EstimationParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.ESTIMATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    const exactValue = mathOutput.result || mathOutput.answer || mathOutput.value;

    // Generate reasonable estimate based on operation
    const estimatedValue = this.generateReasonableEstimate(mathOutput, estimationParams.toleranceRange || 0.15);

    const questionText = this.generateApproximationQuestionText(scenario, mathOutput);

    // Generate distractors for approximation
    const distractors = await this.generateApproximationDistractors(exactValue, estimatedValue, estimationParams.toleranceRange || 0.15);

    // Create proper QuestionParameters structure
    const parameters = {
      mathValues: {
        ...mathOutput,
        exactValue,
        estimatedValue
      },
      narrativeValues: {
        character: scenario.characters?.[0]?.name || 'Student',
        operation: this.describeOperation(mathOutput),
        toleranceRange: String(estimationParams.toleranceRange)
      },
      units: {
        input: 'Â£',
        result: 'Â£'
      },
      formatting: {
        currencyFormat: 'symbol' as const,
        decimalPlaces: 2,
        useGroupingSeparators: estimatedValue > 1000,
        unitPosition: 'before' as const
      }
    };

    return {
      ...baseDefinition,
      parameters,
      questionContent: {
        fullText: questionText,
        components: undefined,
        templateData: {
          character: scenario.characters?.[0]?.name || 'Student',
          operation: this.describeOperation(mathOutput),
          exactValue: String(exactValue),
          estimatedValue: String(estimatedValue)
        }
      },
      solution: {
        correctAnswer: {
          value: estimatedValue,
          displayText: this.formatValue(estimatedValue, 'Â£'),
          units: 'Â£'
        },
        distractors,
        workingSteps: this.generateEstimationSteps(mathOutput, estimatedValue),
        explanation: `A reasonable estimate for this calculation is approximately ${estimatedValue}`,
        solutionStrategy: 'approximation_estimation'
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Generate magnitude/order of magnitude question
   */
  private async generateMagnitudeQuestion(
    mathOutput: any,
    scenario: any,
    estimationParams: EstimationParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.ESTIMATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    const exactValue = mathOutput.result || mathOutput.answer || mathOutput.value;
    const magnitude = this.calculateOrderOfMagnitude(exactValue);

    const questionText = this.generateMagnitudeQuestionText(scenario, mathOutput);

    const distractors = await this.generateMagnitudeDistractors(magnitude);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        estimationParams,
        exactValue,
        magnitude
      },
      solution: {
        correctAnswer: {
          value: magnitude,
          displayText: this.formatValue(magnitude, ''),
          units: ''
        },
        distractors,
        workingSteps: [`The result ${exactValue} is in the order of magnitude of ${magnitude}`],
        explanation: `The order of magnitude is ${magnitude}`,
        solutionStrategy: 'magnitude_estimation'
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Generate benchmark-based estimation question
   */
  private async generateBenchmarkQuestion(
    mathOutput: any,
    scenario: any,
    estimationParams: EstimationParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.ESTIMATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    const exactValue = mathOutput.result || mathOutput.answer || mathOutput.value;
    const benchmark = this.findNearestBenchmark(exactValue);

    const questionText = this.generateBenchmarkQuestionText(scenario, mathOutput, benchmark);

    const distractors = await this.generateBenchmarkDistractors(benchmark);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        estimationParams,
        exactValue,
        benchmark
      },
      solution: {
        correctAnswer: {
          value: benchmark,
          displayText: this.formatValue(benchmark, 'Â£'),
          units: 'Â£'
        },
        distractors,
        workingSteps: [`${exactValue} is closest to the benchmark value ${benchmark}`],
        explanation: `The nearest benchmark is ${benchmark}`,
        solutionStrategy: 'benchmark_estimation'
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Determine estimation parameters based on context
   */
  private determineEstimationParams(mathModel: string, mathOutput: any, yearLevel: params.difficulty.year,
        format: QuestionFormat.ORDERING, any): EstimationParams {
    const result = mathOutput.result || mathOutput.answer || mathOutput.value || 0;

    // Choose estimation type based on model and difficulty
    if (mathModel.includes('MONEY') || mathModel === 'PERCENTAGE') {
      return {
        estimationType: 'round',
        roundingPlace: difficulty.year <= 3 ? 'ones' : 'tens',
        toleranceRange: 0.1
      };
    }

    if (result > 1000) {
      return {
        estimationType: 'round',
        roundingPlace: 'hundreds',
        toleranceRange: 0.15
      };
    }

    if (result > 100) {
      return {
        estimationType: 'round',
        roundingPlace: 'tens',
        toleranceRange: 0.1
      };
    }

    return {
      estimationType: 'approximate',
      toleranceRange: 0.2
    };
  }

  /**
   * Perform rounding to specified place
   */
  private performRounding(value: number, place: string): number {
    const placeValues = {
      'ones': 1,
      'tens': 10,
      'hundreds': 100,
      'thousands': 1000,
      'tenths': 0.1,
      'hundredths': 0.01
    };

    const divisor = placeValues[place as keyof typeof placeValues] || 1;
    if (divisor === 0) return value;
    return Math.round(value / divisor) * divisor;
  }

  /**
   * Generate reasonable estimate with tolerance
   */
  private generateReasonableEstimate(mathOutput: any, tolerance: number): number {
    const exactValue = mathOutput.result || mathOutput.answer || mathOutput.value;

    // Round to nice numbers for estimation
    if (exactValue < 10) {
      return Math.round(exactValue);
    } else if (exactValue < 100) {
      return Math.round(exactValue / 5) * 5;
    } else if (exactValue < 1000) {
      return Math.round(exactValue / 10) * 10;
    } else {
      return Math.round(exactValue / 100) * 100;
    }
  }

  /**
   * Calculate order of magnitude
   */
  private calculateOrderOfMagnitude(value: number): number {
    if (value === 0) return 1;
    const magnitude = Math.pow(10, Math.floor(Math.log10(Math.abs(value))));
    return magnitude;
  }

  /**
   * Find nearest benchmark value
   */
  private findNearestBenchmark(value: number): number {
    const benchmarks = [1, 5, 10, 25, 50, 100, 250, 500, 1000, 2500, 5000, 10000];

    let closest = benchmarks[0];
    let minDiff = Math.abs(value - closest);

    for (const benchmark of benchmarks) {
      const diff = Math.abs(value - benchmark);
      if (diff < minDiff) {
        minDiff = diff;
        closest = benchmark;
      }
    }

    return closest;
  }

  // Question text generation methods
  private generateRoundingQuestionText(scenario: any, mathOutput: any, roundingPlace: string): string {
    const operation = this.describeOperation(mathOutput);
    return `${scenario.characters[0].name} ${operation}. Round the result to the nearest ${roundingPlace}.`;
  }

  private generateApproximationQuestionText(scenario: any, mathOutput: any): string {
    const operation = this.describeOperation(mathOutput);
    return `${scenario.characters[0].name} ${operation}. What is a reasonable estimate?`;
  }

  private generateMagnitudeQuestionText(scenario: any, mathOutput: any): string {
    const operation = this.describeOperation(mathOutput);
    return `${scenario.characters[0].name} ${operation}. What order of magnitude is the result?`;
  }

  private generateBenchmarkQuestionText(scenario: any, mathOutput: any, benchmark: number): string {
    const operation = this.describeOperation(mathOutput);
    return `${scenario.characters[0].name} ${operation}. Which benchmark value is this closest to?`;
  }

  private describeOperation(mathOutput: any): string {
    if (!mathOutput) {
      return 'is calculating a result';
    }

    const operands = mathOutput.operands || mathOutput.factors || [];
    const op1 = operands[0] ?? mathOutput.multiplicand ?? mathOutput.base_value ?? mathOutput.exactValue;
    const op2 = operands[1] ?? mathOutput.multiplier;

    if (op1 === undefined) {
        return 'is performing a calculation';
    }

    const formatMoney = (val: number) => this.formatValue(val, 'Â£', 2);

    switch (mathOutput.operation) {
      case 'ADDITION':
        return `is adding ${operands.map(formatMoney).join(' + ')}`;
      case 'SUBTRACTION':
        return `is subtracting ${formatMoney(mathOutput.minuend)} - ${formatMoney(mathOutput.subtrahend)}`;
      case 'MULTIPLICATION':
        return `is multiplying ${formatMoney(op1)} Ã ${op2}`;
      case 'DIVISION':
        return `is dividing ${formatMoney(mathOutput.dividend)} Ã· ${mathOutput.divisor}`;
      default:
        return `is calculating with ${formatMoney(op1)}`;
    }
  }

  // Distractor generation methods
  private async generateRoundingDistractors(exactValue: number, roundedValue: number, roundingPlace: string): Promise<Distractor[]> {
    const distractors: Distractor[] = [];
    const usedValues = new Set([roundedValue]);
  
    // Always round up
    const roundUpValue = this.performRounding(exactValue + this.getDivisor(roundingPlace) * 0.9, roundingPlace);
    if (!usedValues.has(roundUpValue)) {
      distractors.push({
        value: roundUpValue,
        displayText: this.formatValue(roundUpValue, 'Â£', 0),
        strategy: DistractorStrategy.COMMON_MISCONCEPTION,
        reasoning: 'Always rounded up instead of to the nearest'
      });
      usedValues.add(roundUpValue);
    }
  
    // Always round down (truncation)
    const roundDownValue = this.performRounding(exactValue - this.getDivisor(roundingPlace) * 0.9, roundingPlace);
    if (!usedValues.has(roundDownValue)) {
      distractors.push({
        value: roundDownValue,
        displayText: this.formatValue(roundDownValue, 'Â£', 0),
        strategy: DistractorStrategy.COMMON_MISCONCEPTION,
        reasoning: 'Always rounded down (truncated)'
      });
      usedValues.add(roundDownValue);
    }
  
    // Round to a different place value
    if (roundingPlace === 'tens' && exactValue > 100) {
      const wrongPlaceValue = this.performRounding(exactValue, 'hundreds');
      if (!usedValues.has(wrongPlaceValue)) {
        distractors.push({
          value: wrongPlaceValue,
          displayText: this.formatValue(wrongPlaceValue, 'Â£', 0),
          strategy: DistractorStrategy.PLACE_VALUE_ERROR,
          reasoning: 'Rounded to the nearest hundred instead of ten'
        });
        usedValues.add(wrongPlaceValue);
      }
    } else if (roundingPlace === 'hundreds') {
        const wrongPlaceValue = this.performRounding(exactValue, 'tens');
        if (!usedValues.has(wrongPlaceValue)) {
          distractors.push({
            value: wrongPlaceValue,
            displayText: this.formatValue(wrongPlaceValue, 'Â£', 0),
            strategy: DistractorStrategy.PLACE_VALUE_ERROR,
            reasoning: 'Rounded to the nearest ten instead of hundred'
          });
          usedValues.add(wrongPlaceValue);
        }
    }

    // Add exact value if it's different
    if (!usedValues.has(exactValue)) {
        distractors.push({
            value: exactValue,
            displayText: this.formatValue(exactValue, 'Â£', 2),
            strategy: DistractorStrategy.WRONG_OPERATION,
            reasoning: 'Gave the exact value instead of rounding'
        });
        usedValues.add(exactValue);
    }
  
    return distractors.slice(0, 3);
  }

  private getDivisor(place: string): number {
    const placeValues = { 'ones': 1, 'tens': 10, 'hundreds': 100, 'thousands': 1000, 'tenths': 0.1, 'hundredths': 0.01 };
    return placeValues[place as keyof typeof placeValues] || 1;
  }

  private async generateApproximationDistractors(exactValue: number, estimatedValue: number, tolerance: number): Promise<Distractor[]> {
    const distractors: Distractor[] = [];
    const usedValues = new Set([estimatedValue]);

    // Too precise (exact answer)
    if(!usedValues.has(exactValue)){
        distractors.push({
            value: exactValue,
            displayText: this.formatValue(exactValue, 'Â£', 2),
            strategy: DistractorStrategy.WRONG_OPERATION,
            reasoning: 'Used exact calculation instead of estimation'
        });
        usedValues.add(exactValue);
    }

    // Poor estimates (too high/low)
    const tooHigh = estimatedValue * 1.5 + 5;
     if(!usedValues.has(tooHigh)){
        distractors.push({
            value: tooHigh,
            displayText: this.formatValue(tooHigh, 'Â£', 0),
            strategy: DistractorStrategy.CALCULATION_ERROR,
            reasoning: 'Overestimated significantly'
        });
        usedValues.add(tooHigh);
     }

    const tooLow = estimatedValue * 0.6 - 5;
    if(!usedValues.has(tooLow) && tooLow > 0){
        distractors.push({
            value: tooLow,
            displayText: this.formatValue(tooLow, 'Â£', 0),
            strategy: DistractorStrategy.CALCULATION_ERROR,
            reasoning: 'Underestimated significantly'
        });
        usedValues.add(tooLow);
    }

    return distractors.slice(0, 3);
  }

  private async generateMagnitudeDistractors(magnitude: number): Promise<Distractor[]> {
      const distractors = [];
      const usedValues = new Set([magnitude]);

      // One order higher/lower
      const higher = magnitude * 10;
      if(!usedValues.has(higher)) {
          distractors.push({ value: higher, displayText: String(higher), strategy: DistractorStrategy.CALCULATION_ERROR, reasoning: 'One order of magnitude too high' });
          usedValues.add(higher);
      }
      
      const lower = magnitude / 10;
       if(!usedValues.has(lower) && lower >= 1) {
          distractors.push({ value: lower, displayText: String(lower), strategy: DistractorStrategy.CALCULATION_ERROR, reasoning: 'One order of magnitude too low' });
          usedValues.add(lower);
       }
      
      return distractors.slice(0, 3);
  }

  private async generateBenchmarkDistractors(benchmark: number): Promise<Distractor[]> {
    const allBenchmarks = [1, 5, 10, 25, 50, 100, 250, 500, 1000, 2500, 5000, 10000];
    const currentIndex = allBenchmarks.indexOf(benchmark);
    const usedValues = new Set([benchmark]);
    const distractors = [];

    if (currentIndex > 0) {
      const lower = allBenchmarks[currentIndex - 1];
       if(!usedValues.has(lower)) {
            distractors.push({ value: lower, displayText: this.formatValue(lower, 'Â£'), strategy: DistractorStrategy.COMMON_MISCONCEPTION, reasoning: 'Adjacent lower benchmark' });
            usedValues.add(lower);
       }
    }

    if (currentIndex < allBenchmarks.length - 1) {
      const higher = allBenchmarks[currentIndex + 1];
        if(!usedValues.has(higher)) {
            distractors.push({ value: higher, displayText: this.formatValue(higher, 'Â£'), strategy: DistractorStrategy.COMMON_MISCONCEPTION, reasoning: 'Adjacent higher benchmark' });
            usedValues.add(higher);
        }
    }

    return distractors.slice(0, 3);
  }

  private generateRoundingSteps(exactValue: number, roundedValue: number, roundingPlace: string): string[] {
    return [
      `Original value: ${exactValue}`,
      `Looking at the ${roundingPlace} place`,
      `Rounded value: ${roundedValue}`
    ];
  }

  private generateEstimationSteps(mathOutput: any, estimatedValue: number): string[] {
    return [
      `Identify the operation: ${mathOutput.operation}`,
      `Round operands to nice numbers`,
      `Calculate estimate: ${estimatedValue}`
    ];
  }
}
```
--- END FILE: lib\controllers\estimation.controller.ts ---

--- START FILE: lib\controllers\missing-value.controller.ts ---
```typescript
// Missing Value Controller - Generates missing number/value questions
// "What number makes this equation true?" or "Fill in the blank"

import {
  QuestionController,
  GenerationParams,
  ControllerDependencies
} from './base-question.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  DistractorStrategy,
  ScenarioTheme
} from '@/lib/types/question-formats';

/**
 * Missing value specific parameters
 */
interface MissingValueParams {
  missingPosition: 'operand1' | 'operand2' | 'operand3' | 'result' | 'operator';
  equationType: 'simple' | 'balanced' | 'function' | 'word_equation';
  showUnits?: boolean;
  algebraicForm?: boolean;
  providedValues: number[];
  missingValue: number;
}

/**
 * Controller for generating missing value and algebraic thinking questions
 */
export class MissingValueController extends QuestionController {

  constructor(dependencies: ControllerDependencies) {
    super(dependencies);
  }

  /**
   * Generate missing value question
   */
  async generate(params: GenerationParams): Promise<QuestionDefinition> {
    try {
      // 1. Generate base math content
      const mathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);

      // 2. Select appropriate scenario
      const scenario = await this.selectScenario({
        format: QuestionFormat.MISSING_VALUE,
        yearLevel: params.difficulty.year,
        theme: params.preferredTheme || ScenarioTheme.SCHOOL,
        mathModel: params.mathModel,
        culturalContext: params.culturalContext
      });

    // 3. Determine missing value parameters
    const missingValueParams = this.determineMissingValueParams(params.mathModel, mathOutput, params.difficulty);

    // 4. Generate question based on equation type
    let questionDef: QuestionDefinition;

    switch (missingValueParams.equationType) {
      case 'simple':
        questionDef = await this.generateSimpleEquation(mathOutput, scenario, missingValueParams, params);
        break;
      case 'balanced':
        questionDef = await this.generateBalancedEquation(mathOutput, scenario, missingValueParams, params);
        break;
      case 'function':
        questionDef = await this.generateFunctionEquation(mathOutput, scenario, missingValueParams, params);
        break;
      case 'word_equation':
        questionDef = await this.generateWordEquation(mathOutput, scenario, missingValueParams, params);
        break;
      default:
        questionDef = await this.generateSimpleEquation(mathOutput, scenario, missingValueParams, params);
    }

    return questionDef;
    } catch (error) {
      console.error('MissingValueController error:', error);
      // Fallback to simple question format
      return this.generateFallbackQuestion(params);
    }
  }

  /**
   * Generate fallback question if missing value fails
   */
  private async generateFallbackQuestion(params: GenerationParams): Promise<QuestionDefinition> {
    const mathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);
    const scenario = await this.selectScenario({
      format: QuestionFormat.MISSING_VALUE,
      yearLevel: params.difficulty.year,
      theme: ScenarioTheme.SCHOOL,
      mathModel: params.mathModel,
      culturalContext: params.culturalContext
    });

    return this.createBaseQuestionDefinition(
      QuestionFormat.MISSING_VALUE,
      params.mathModel,
      params.difficulty,
      scenario
    ) as QuestionDefinition;
  }

  /**
   * Generate simple missing value equation
   */
  private async generateSimpleEquation(
    mathOutput: any,
    scenario: any,
    missingValueParams: MissingValueParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.MISSING_VALUE,
      params.mathModel,
      params.difficulty,
      scenario
    );

    // Create equation with missing value
    const equation = this.buildEquation(mathOutput, missingValueParams);
    const questionText = this.generateSimpleEquationText(scenario, equation, missingValueParams);

    // Generate distractors for missing value
    const distractors = await this.generateMissingValueDistractors(missingValueParams.missingValue, mathOutput, missingValueParams);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        missingValueParams,
        equation,
        missingValue: missingValueParams.missingValue
      },
      solution: {
        correctAnswer: {
          value: missingValueParams.missingValue,
          displayText: this.formatValue(missingValueParams.missingValue, ''),
          units: ''
        },
        distractors,
        workingSteps: this.generateSolutionSteps(equation, missingValueParams),
        explanation: this.generateExplanation(equation, missingValueParams)
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Generate balanced equation (both sides)
   */
  private async generateBalancedEquation(
    mathOutput: any,
    scenario: any,
    missingValueParams: MissingValueParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.MISSING_VALUE,
      params.mathModel,
      params.difficulty,
      scenario
    );

    // Create balanced equation like: 15 + ? = 8 + 12
    const leftSide = this.buildEquation(mathOutput, missingValueParams);
    const rightSide = this.buildBalancingEquation(mathOutput, missingValueParams.missingValue);

    const equation = {
      left: leftSide,
      right: rightSide,
      type: 'balanced'
    };

    const questionText = this.generateBalancedEquationText(scenario, equation, missingValueParams);

    const distractors = await this.generateMissingValueDistractors(missingValueParams.missingValue, mathOutput, missingValueParams);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        missingValueParams,
        equation,
        missingValue: missingValueParams.missingValue
      },
      solution: {
        correctAnswer: {
          value: missingValueParams.missingValue,
          displayText: this.formatValue(missingValueParams.missingValue, ''),
          units: ''
        },
        distractors,
        workingSteps: this.generateBalancedSolutionSteps(equation, missingValueParams),
        explanation: this.generateBalancedExplanation(equation, missingValueParams)
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Generate function-style equation
   */
  private async generateFunctionEquation(
    mathOutput: any,
    scenario: any,
    missingValueParams: MissingValueParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.MISSING_VALUE,
      params.mathModel,
      params.difficulty,
      scenario
    );

    // Create function like: f(x) = 3x + 5, if f(?) = 20
    const functionRule = this.buildFunctionRule(mathOutput, missingValueParams);
    const equation = {
      rule: functionRule,
      input: missingValueParams.missingValue,
      output: mathOutput.result,
      type: 'function'
    };

    const questionText = this.generateFunctionEquationText(scenario, equation, missingValueParams);

    const distractors = await this.generateMissingValueDistractors(missingValueParams.missingValue, mathOutput, missingValueParams);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        missingValueParams,
        equation,
        missingValue: missingValueParams.missingValue
      },
      solution: {
        correctAnswer: {
          value: missingValueParams.missingValue,
          displayText: this.formatValue(missingValueParams.missingValue, ''),
          units: ''
        },
        distractors,
        workingSteps: this.generateFunctionSolutionSteps(equation, missingValueParams),
        explanation: this.generateFunctionExplanation(equation, missingValueParams)
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Generate word equation
   */
  private async generateWordEquation(
    mathOutput: any,
    scenario: any,
    missingValueParams: MissingValueParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.MISSING_VALUE,
      params.mathModel,
      params.difficulty,
      scenario
    );

    // Create word-based equation
    const equation = this.buildWordEquation(mathOutput, missingValueParams, scenario);
    const questionText = this.generateWordEquationText(scenario, equation, missingValueParams);

    const distractors = await this.generateMissingValueDistractors(missingValueParams.missingValue, mathOutput, missingValueParams);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        missingValueParams,
        equation,
        missingValue: missingValueParams.missingValue
      },
      solution: {
        correctAnswer: {
          value: missingValueParams.missingValue,
          displayText: this.formatValue(missingValueParams.missingValue, ''),
          units: ''
        },
        distractors,
        workingSteps: this.generateWordSolutionSteps(equation, missingValueParams),
        explanation: this.generateWordExplanation(equation, missingValueParams)
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Determine missing value parameters based on context
   */
  private determineMissingValueParams(mathModel: string, mathOutput: any, yearLevel: params.difficulty.year,
        format: QuestionFormat.ORDERING, any): MissingValueParams {
    // Determine missing position
    const positions = ['operand1', 'operand2', 'result'];
    const missingPosition = positions[Math.floor(Math.random() * positions.length)] as MissingValueParams['missingPosition'];

    // Determine equation type based on difficulty
    let equationType: MissingValueParams['equationType'];
    if (difficulty.year <= 2) {
      equationType = 'simple';
    } else if (difficulty.year <= 4) {
      equationType = Math.random() > 0.5 ? 'simple' : 'word_equation';
    } else {
      const types: MissingValueParams['equationType'][] = ['simple', 'balanced', 'word_equation'];
      if (difficulty.year >= 6) types.push('function');
      equationType = types[Math.floor(Math.random() * types.length)];
    }

    // Calculate missing value based on position
    let missingValue: number;
    let providedValues: number[] = [];

    switch (missingPosition) {
      case 'operand1':
        missingValue = mathOutput.operand_1;
        providedValues = [mathOutput.operand_2, mathOutput.result];
        break;
      case 'operand2':
        missingValue = mathOutput.operand_2;
        providedValues = [mathOutput.operand_1, mathOutput.result];
        break;
      case 'result':
        missingValue = mathOutput.result;
        providedValues = [mathOutput.operand_1, mathOutput.operand_2];
        break;
      default:
        missingValue = mathOutput.result;
        providedValues = [mathOutput.operand_1, mathOutput.operand_2];
    }

    return {
      missingPosition,
      equationType,
      showUnits: mathModel.includes('MONEY') || mathModel.includes('MEASUREMENT'),
      algebraicForm: difficulty.year >= 5 && equationType === 'function',
      providedValues,
      missingValue
    };
  }

  /**
   * Build equation structure with missing value
   */
  private buildEquation(mathOutput: any, missingValueParams: MissingValueParams): any {
    const placeholder = '?';

    switch (missingValueParams.missingPosition) {
      case 'operand1':
        return {
          left: placeholder,
          operator: this.getOperatorSymbol(mathOutput.operation),
          right: mathOutput.operand_2,
          result: mathOutput.result,
          missingValue: mathOutput.operand_1
        };

      case 'operand2':
        return {
          left: mathOutput.operand_1,
          operator: this.getOperatorSymbol(mathOutput.operation),
          right: placeholder,
          result: mathOutput.result,
          missingValue: mathOutput.operand_2
        };

      case 'result':
        return {
          left: mathOutput.operand_1,
          operator: this.getOperatorSymbol(mathOutput.operation),
          right: mathOutput.operand_2,
          result: placeholder,
          missingValue: mathOutput.result
        };

      default:
        return {
          left: mathOutput.operand_1,
          operator: this.getOperatorSymbol(mathOutput.operation),
          right: mathOutput.operand_2,
          result: placeholder,
          missingValue: mathOutput.result
        };
    }
  }

  /**
   * Build balancing equation for the right side
   */
  private buildBalancingEquation(mathOutput: any, targetValue: number): any {
    // Create an equation that equals the target value
    // For example, if target is 20, create "15 + 5" or "30 - 10"

    const operations = ['ADDITION', 'SUBTRACTION'];
    const operation = operations[Math.floor(Math.random() * operations.length)];

    switch (operation) {
      case 'ADDITION':
        const add1 = Math.floor(targetValue * 0.6) + Math.floor(Math.random() * 5);
        const add2 = targetValue - add1;
        return {
          left: add1,
          operator: '+',
          right: add2,
          result: targetValue
        };

      case 'SUBTRACTION':
        const sub2 = Math.floor(Math.random() * 10) + 1;
        const sub1 = targetValue + sub2;
        return {
          left: sub1,
          operator: '-',
          right: sub2,
          result: targetValue
        };

      default:
        return {
          left: targetValue,
          operator: '+',
          right: 0,
          result: targetValue
        };
    }
  }

  /**
   * Build function rule
   */
  private buildFunctionRule(mathOutput: any, missingValueParams: MissingValueParams): any {
    // Create simple function like f(x) = ax + b
    const coefficient = Math.floor(Math.random() * 5) + 1;
    const constant = Math.floor(Math.random() * 10);

    return {
      coefficient,
      constant,
      operation: 'linear',
      expression: `${coefficient}x + ${constant}`
    };
  }

  /**
   * Build word equation
   */
  private buildWordEquation(mathOutput: any, missingValueParams: MissingValueParams, scenario: any): any {
    const character = scenario.characters[0].name;

    return {
      context: `${character} has some items`,
      action: this.getWordAction(mathOutput.operation),
      values: missingValueParams.providedValues,
      missingValue: missingValueParams.missingValue,
      missingPosition: missingValueParams.missingPosition
    };
  }

  /**
   * Get operator symbol
   */
  private getOperatorSymbol(operation: string): string {
    switch (operation) {
      case 'ADDITION': return '+';
      case 'SUBTRACTION': return '-';
      case 'MULTIPLICATION': return 'Ã';
      case 'DIVISION': return 'Ã·';
      default: return '+';
    }
  }

  /**
   * Get word action for word equations
   */
  private getWordAction(operation: string): string {
    switch (operation) {
      case 'ADDITION': return 'gets more';
      case 'SUBTRACTION': return 'gives away';
      case 'MULTIPLICATION': return 'groups into sets of';
      case 'DIVISION': return 'shares equally among';
      default: return 'calculates with';
    }
  }

  // Question text generation methods
  private generateSimpleEquationText(scenario: any, equation: any, missingValueParams: MissingValueParams): string {
    const equationStr = `${equation.left} ${equation.operator} ${equation.right} = ${equation.result}`;
    return `${scenario.characters[0].name} is working on this equation: ${equationStr}. What number should replace the ? to make this equation true?`;
  }

  private generateBalancedEquationText(scenario: any, equation: any, missingValueParams: MissingValueParams): string {
    const leftStr = `${equation.left.left} ${equation.left.operator} ${equation.left.right}`;
    const rightStr = `${equation.right.left} ${equation.right.operator} ${equation.right.right}`;
    return `${scenario.characters[0].name} needs to balance this equation: ${leftStr} = ${rightStr}. What number should replace the ? to make both sides equal?`;
  }

  private generateFunctionEquationText(scenario: any, equation: any, missingValueParams: MissingValueParams): string {
    const rule = equation.rule.expression;
    return `${scenario.characters[0].name} has a function rule: f(x) = ${rule}. If f(?) = ${equation.output}, what is the input value?`;
  }

  private generateWordEquationText(scenario: any, equation: any, missingValueParams: MissingValueParams): string {
    const character = scenario.characters[0].name;
    const values = missingValueParams.providedValues;

    switch (missingValueParams.missingPosition) {
      case 'operand1':
        return `${character} ${equation.action} ${values[0]} items and ends up with ${values[1]} items total. How many items did ${character} start with?`;
      case 'operand2':
        return `${character} starts with ${values[0]} items and ${equation.action} some more. Now ${character} has ${values[1]} items total. How many items did ${character} ${equation.action}?`;
      case 'result':
        return `${character} starts with ${values[0]} items and ${equation.action} ${values[1]} more items. How many items does ${character} have now?`;
      default:
        return `${character} is working with ${values[0]} and ${values[1]} items. What is the missing number?`;
    }
  }

  // Solution step generation methods
  private generateSolutionSteps(equation: any, missingValueParams: MissingValueParams): string[] {
    const steps = [];

    switch (missingValueParams.missingPosition) {
      case 'operand1':
        steps.push(`Given: ? ${equation.operator} ${equation.right} = ${equation.result}`);
        steps.push(`To find the missing number, we need to work backwards`);
        steps.push(`${equation.result} ${this.getInverseOperator(equation.operator)} ${equation.right} = ${equation.missingValue}`);
        break;

      case 'operand2':
        steps.push(`Given: ${equation.left} ${equation.operator} ? = ${equation.result}`);
        steps.push(`To find the missing number, we need to work backwards`);
        steps.push(`${equation.result} ${this.getInverseOperator(equation.operator)} ${equation.left} = ${equation.missingValue}`);
        break;

      case 'result':
        steps.push(`Given: ${equation.left} ${equation.operator} ${equation.right} = ?`);
        steps.push(`Calculate: ${equation.left} ${equation.operator} ${equation.right}`);
        steps.push(`Answer: ${equation.missingValue}`);
        break;
    }

    return steps;
  }

  private generateBalancedSolutionSteps(equation: any, missingValueParams: MissingValueParams): string[] {
    const steps = [];
    const rightValue = equation.right.result;

    steps.push(`The right side equals: ${equation.right.left} ${equation.right.operator} ${equation.right.right} = ${rightValue}`);
    steps.push(`So the left side must also equal ${rightValue}`);
    steps.push(`Working backwards to find the missing value...`);

    return steps;
  }

  private generateFunctionSolutionSteps(equation: any, missingValueParams: MissingValueParams): string[] {
    const steps = [];
    const rule = equation.rule;

    steps.push(`Given: f(x) = ${rule.expression}`);
    steps.push(`We know: f(?) = ${equation.output}`);
    steps.push(`Substitute: ${rule.coefficient} Ã ? + ${rule.constant} = ${equation.output}`);
    steps.push(`Solve: ? = (${equation.output} - ${rule.constant}) Ã· ${rule.coefficient}`);
    steps.push(`Answer: ? = ${missingValueParams.missingValue}`);

    return steps;
  }

  private generateWordSolutionSteps(equation: any, missingValueParams: MissingValueParams): string[] {
    const steps = [];

    steps.push(`Identify what we know and what we need to find`);
    steps.push(`Set up the equation based on the word problem`);
    steps.push(`Work backwards to find the missing value`);
    steps.push(`Check: Does our answer make sense in the context?`);

    return steps;
  }

  /**
   * Get inverse operator for working backwards
   */
  private getInverseOperator(operator: string): string {
    switch (operator) {
      case '+': return '-';
      case '-': return '+';
      case 'Ã': return 'Ã·';
      case 'Ã·': return 'Ã';
      default: return '+';
    }
  }

  // Explanation generation methods
  private generateExplanation(equation: any, missingValueParams: MissingValueParams): string {
    return `To find the missing value, we work backwards using the inverse operation. The answer is ${missingValueParams.missingValue}.`;
  }

  private generateBalancedExplanation(equation: any, missingValueParams: MissingValueParams): string {
    return `Both sides of the equation must be equal. By calculating the right side and working backwards on the left side, we find the missing value is ${missingValueParams.missingValue}.`;
  }

  private generateFunctionExplanation(equation: any, missingValueParams: MissingValueParams): string {
    return `Using the function rule and working backwards from the output, we can solve for the input value: ${missingValueParams.missingValue}.`;
  }

  private generateWordExplanation(equation: any, missingValueParams: MissingValueParams): string {
    return `By understanding the word problem and setting up the equation, we can solve for the missing value: ${missingValueParams.missingValue}.`;
  }

  /**
   * Generate distractors for missing value questions
   */
  private async generateMissingValueDistractors(missingValue: number, mathOutput: any, missingValueParams: MissingValueParams): Promise<any[]> {
    const distractors = [];

    // Common errors for missing value problems:

    // 1. Using wrong operation
    const wrongOpValue = this.calculateWithWrongOperation(mathOutput, missingValueParams);
    distractors.push({
      value: wrongOpValue,
      strategy: DistractorStrategy.WRONG_OPERATION,
      rationale: 'Used wrong operation to solve'
    });

    // 2. Arithmetic error (off by small amount)
    const arithError = missingValue + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 3) + 1);
    distractors.push({
      value: arithError,
      strategy: DistractorStrategy.CALCULATION_ERROR,
      rationale: 'Arithmetic calculation error'
    });

    // 3. Using provided value as answer
    if (missingValueParams.providedValues.length > 0) {
      const confusedValue = missingValueParams.providedValues[0];
      if (confusedValue !== missingValue) {
        distractors.push({
          value: confusedValue,
          strategy: DistractorStrategy.COMMON_MISCONCEPTION,
          rationale: 'Confused given value with missing value'
        });
      }
    }

    // 4. Order of operations error
    const orderError = this.calculateOrderError(mathOutput, missingValueParams);
    if (orderError !== missingValue) {
      distractors.push({
        value: orderError,
        strategy: DistractorStrategy.CALCULATION_ERROR,
        rationale: 'Order of operations error'
      });
    }

    return distractors.slice(0, 3);
  }

  /**
   * Calculate what answer would be with wrong operation
   */
  private calculateWithWrongOperation(mathOutput: any, missingValueParams: MissingValueParams): number {
    switch (missingValueParams.missingPosition) {
      case 'operand1':
        // If original was addition, wrong would be subtraction from result
        if (mathOutput.operation === 'ADDITION') {
          return mathOutput.result + mathOutput.operand_2; // Should subtract, but added
        } else if (mathOutput.operation === 'SUBTRACTION') {
          return mathOutput.result - mathOutput.operand_2; // Should add, but subtracted
        }
        break;

      case 'operand2':
        // Similar logic for second operand
        if (mathOutput.operation === 'ADDITION') {
          return mathOutput.result + mathOutput.operand_1;
        } else if (mathOutput.operation === 'SUBTRACTION') {
          return mathOutput.operand_1 - mathOutput.result;
        }
        break;

      case 'result':
        // Wrong operation on the given operands
        if (mathOutput.operation === 'ADDITION') {
          return mathOutput.operand_1 - mathOutput.operand_2;
        } else if (mathOutput.operation === 'SUBTRACTION') {
          return mathOutput.operand_1 + mathOutput.operand_2;
        }
        break;
    }

    return missingValueParams.missingValue + 5; // Fallback
  }

  /**
   * Calculate error from wrong order of operations
   */
  private calculateOrderError(mathOutput: any, missingValueParams: MissingValueParams): number {
    // Simple order error: doing operation in wrong direction
    switch (missingValueParams.missingPosition) {
      case 'operand1':
        if (mathOutput.operation === 'SUBTRACTION') {
          return mathOutput.operand_2 - mathOutput.result; // Backwards subtraction
        }
        break;
      case 'operand2':
        if (mathOutput.operation === 'DIVISION') {
          return mathOutput.result / mathOutput.operand_1; // Backwards division
        }
        break;
    }

    return missingValueParams.missingValue + 2; // Fallback
  }
}
```
--- END FILE: lib\controllers\missing-value.controller.ts ---

--- START FILE: lib\controllers\multi-step.controller.ts ---
```typescript
// Multi-Step Controller - Generates multi-step problem solving questions
// "First calculate..., then..." or "Step 1:..., Step 2:..."

import {
  QuestionController,
  GenerationParams,
  ControllerDependencies
} from './base-question.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  DistractorStrategy,
  ScenarioTheme,
  QuestionContent,
  QuestionComponents,
  QuestionStep,
  QuestionTemplateData
} from '@/lib/types/question-formats';

/**
 * Multi-step specific parameters
 */
interface MultiStepParams {
  stepCount: number;
  operations: string[];
  intermediateValues: number[];
  stepDescriptions: string[];
  requiresSequencing: boolean;
  allowsParallelSteps: boolean;
}

/**
 * Controller for generating multi-step problem solving questions
 */
export class MultiStepController extends QuestionController {

  constructor(dependencies: ControllerDependencies) {
    super(dependencies);
  }

  /**
   * Generate multi-step problem solving question
   */
  async generate(params: GenerationParams): Promise<QuestionDefinition> {
    try {
      // 1. Generate base math content for final result
      const finalMathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);

      // 2. Select appropriate scenario that supports multi-step problems
      const scenario = await this.selectScenario({
        format: QuestionFormat.MULTI_STEP,
        yearLevel: params.difficulty.year,
        theme: params.preferredTheme || ScenarioTheme.SCHOOL,
        mathModel: params.mathModel,
        culturalContext: params.culturalContext
      });

      // 3. Design multi-step sequence based on difficulty and model
      const multiStepParams = this.designMultiStepSequence(params.mathModel, finalMathOutput, params.difficulty);

      // 4. Generate the multi-step question
      const questionDef = await this.generateMultiStepQuestion(finalMathOutput, scenario, multiStepParams, params);

      return questionDef;
    } catch (error) {
      console.error('MultiStepController error:', error);
      // Fallback to simple question format
      return this.generateFallbackQuestion(params);
    }
  }

  /**
   * Generate fallback question if multi-step fails
   */
  private async generateFallbackQuestion(params: GenerationParams): Promise<QuestionDefinition> {
    const mathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);
    const scenario = await this.selectScenario({
      format: QuestionFormat.MULTI_STEP,
      yearLevel: params.difficulty.year,
      theme: ScenarioTheme.SCHOOL,
      mathModel: params.mathModel,
      culturalContext: params.culturalContext
    });

    return this.createBaseQuestionDefinition(
      QuestionFormat.MULTI_STEP,
      params.mathModel,
      params.difficulty,
      scenario
    ) as QuestionDefinition;
  }

  /**
   * Generate complete multi-step question
   */
  private async generateMultiStepQuestion(
    finalMathOutput: any,
    scenario: any,
    multiStepParams: MultiStepParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.MULTI_STEP,
      params.mathModel,
      params.difficulty,
      scenario
    );

    // Generate intermediate calculations for each step
    const stepCalculations = this.generateStepCalculations(finalMathOutput, multiStepParams);

    // Create the multi-step story problem
    const questionText = this.generateMultiStepQuestionText(scenario, stepCalculations, multiStepParams);

    // Create structured question content for rich UI
    const questionContent = this.createQuestionContent(questionText, stepCalculations, scenario, multiStepParams);

    // Final answer and working
    const finalAnswer = stepCalculations[stepCalculations.length - 1].result;

    // Generate distractors for multi-step problems
    const distractors = await this.generateMultiStepDistractors(stepCalculations, multiStepParams);

    return {
      ...baseDefinition,
      questionContent,
      parameters: {
        mathValues: finalMathOutput,
        multiStepParams,
        stepCalculations,
        finalAnswer
      },
      solution: {
        correctAnswer: {
          value: finalAnswer,
          displayText: this.formatValue(finalAnswer, 'Â£'),
          units: 'Â£'
        },
        distractors,
        workingSteps: this.generateWorkingSteps(stepCalculations, multiStepParams),
        explanation: this.generateStepByStepExplanation(stepCalculations, multiStepParams)
      }
    } as unknown as QuestionDefinition;
  }

  /**
   * Design the sequence of steps for the multi-step problem
   */
  private designMultiStepSequence(mathModel: string, finalOutput: any, yearLevel: params.difficulty.year,
        format: QuestionFormat.ORDERING, any): MultiStepParams {
    // Determine step count based on difficulty
    const stepCount = this.determineStepCount(difficulty.year, difficulty.subLevel);

    // Design operations sequence
    const operations = this.determineOperationSequence(mathModel, stepCount, difficulty);

    return {
      stepCount,
      operations,
      intermediateValues: [], // Will be filled during calculation generation
      stepDescriptions: [], // Will be generated based on scenario
      requiresSequencing: stepCount > 2,
      allowsParallelSteps: stepCount <= 3 && difficulty.year >= 5
    };
  }

  /**
   * Determine appropriate number of steps
   */
  private determineStepCount(year: number, subLevel: number): number {
    if (year <= 2) return 2;
    if (year <= 4) return Math.random() > 0.5 ? 2 : 3;
    return Math.floor(Math.random() * 3) + 2; // 2-4 steps for higher years
  }

  /**
   * Determine sequence of operations
   */
  private determineOperationSequence(mathModel: string, stepCount: number, yearLevel: params.difficulty.year,
        format: QuestionFormat.ORDERING, any): string[] {
    const operations = [];

    // Start with the primary operation
    operations.push(mathModel);

    // Add complementary operations for additional steps
    for (let i = 1; i < stepCount; i++) {
      switch (mathModel) {
        case 'ADDITION':
          operations.push(Math.random() > 0.5 ? 'ADDITION' : 'SUBTRACTION');
          break;
        case 'SUBTRACTION':
          operations.push(Math.random() > 0.5 ? 'SUBTRACTION' : 'ADDITION');
          break;
        case 'MULTIPLICATION':
          operations.push(Math.random() > 0.6 ? 'MULTIPLICATION' : 'ADDITION');
          break;
        case 'DIVISION':
          operations.push(Math.random() > 0.6 ? 'DIVISION' : 'SUBTRACTION');
          break;
        case 'PERCENTAGE':
          operations.push('MULTIPLICATION'); // Often follows percentage calculations
          break;
        default:
          operations.push('ADDITION');
      }
    }

    return operations;
  }

  /**
   * Generate calculations for each step
   */
  private generateStepCalculations(finalOutput: any, multiStepParams: MultiStepParams): any[] {
    const calculations = [];

    // Work backwards from final result to create logical sequence
    const targetFinalResult = finalOutput.result || finalOutput.answer || finalOutput.value;

    // Generate a coherent sequence that leads to a reasonable final result
    // Start with a manageable initial value
    let currentValue = this.generateReasonableStartValue(targetFinalResult, multiStepParams);

    // Step 1: Initial calculation
    const step1 = this.generateReasonableInitialStep(multiStepParams.operations[0], currentValue);
    calculations.push(step1);
    currentValue = step1.result;

    // Subsequent steps - each uses the previous result
    for (let i = 1; i < multiStepParams.stepCount; i++) {
      const nextStep = this.generateLogicalNextStep(
        multiStepParams.operations[i],
        currentValue,
        i,
        targetFinalResult,
        multiStepParams.stepCount
      );
      calculations.push(nextStep);
      currentValue = nextStep.result;
    }

    return calculations;
  }

  /**
   * Generate reasonable start value for multi-step sequence
   */
  private generateReasonableStartValue(targetFinalResult: number, multiStepParams: MultiStepParams): number {
    // Choose a starting value that's reasonable for the sequence
    const minStart = Math.max(1, Math.floor(targetFinalResult / 10));
    const maxStart = Math.max(10, Math.floor(targetFinalResult / 2));
    return Math.floor(Math.random() * (maxStart - minStart + 1)) + minStart;
  }

  /**
   * Generate reasonable initial step calculation
   */
  private generateReasonableInitialStep(operation: string, startValue: number): any {
    switch (operation) {
      case 'ADDITION':
        const add2 = Math.floor(Math.random() * startValue) + 1;
        return {
          operation: 'ADDITION',
          operand_1: startValue,
          operand_2: add2,
          result: startValue + add2,
          description: `Add ${startValue} and ${add2}`
        };

      case 'SUBTRACTION':
        const sub2 = Math.floor(Math.random() * Math.floor(startValue / 2)) + 1;
        return {
          operation: 'SUBTRACTION',
          operand_1: startValue,
          operand_2: sub2,
          result: startValue - sub2,
          description: `Subtract ${sub2} from ${startValue}`
        };

      case 'MULTIPLICATION':
        const mult2 = Math.floor(Math.random() * 4) + 2; // 2-5
        return {
          operation: 'MULTIPLICATION',
          operand_1: startValue,
          operand_2: mult2,
          result: startValue * mult2,
          description: `Multiply ${startValue} by ${mult2}`
        };

      case 'DIVISION':
        // Ensure clean division
        const div2 = Math.floor(Math.random() * 4) + 2; // 2-5
        const dividend = startValue * div2; // Make sure it divides evenly
        return {
          operation: 'DIVISION',
          operand_1: dividend,
          operand_2: div2,
          result: startValue, // Result is the original startValue
          description: `Divide ${dividend} by ${div2}`
        };

      default:
        return {
          operation: 'ADDITION',
          operand_1: startValue,
          operand_2: 5,
          result: startValue + 5,
          description: `Add ${startValue} and 5`
        };
    }
  }

  /**
   * Generate next step in logical sequence
   */
  private generateLogicalNextStep(
    operation: string,
    previousResult: number,
    stepIndex: number,
    targetFinal: number,
    totalSteps: number
  ): any {
    // Use reasonable modifiers that won't create extremely large or small values
    const isLastStep = stepIndex === totalSteps - 1;

    switch (operation) {
      case 'ADDITION':
        // Use smaller additions for later steps to avoid huge results
        const addModifier = Math.floor(Math.random() * Math.max(5, Math.floor(previousResult / 4))) + 1;
        return {
          operation: 'ADDITION',
          operand_1: previousResult,
          operand_2: addModifier,
          result: previousResult + addModifier,
          description: `Add ${addModifier} to ${previousResult}`
        };

      case 'SUBTRACTION':
        // Ensure we don't go negative and use reasonable amounts
        const maxSubtract = Math.min(Math.floor(previousResult * 0.7), 20);
        const subModifier = Math.floor(Math.random() * Math.max(1, maxSubtract)) + 1;
        return {
          operation: 'SUBTRACTION',
          operand_1: previousResult,
          operand_2: subModifier,
          result: Math.max(1, previousResult - subModifier),
          description: `Subtract ${subModifier} from ${previousResult}`
        };

      case 'MULTIPLICATION':
        // Use small multipliers to avoid huge numbers
        const multiplier = isLastStep ? 2 : Math.floor(Math.random() * 3) + 2; // 2-4
        return {
          operation: 'MULTIPLICATION',
          operand_1: previousResult,
          operand_2: multiplier,
          result: previousResult * multiplier,
          description: `Multiply ${previousResult} by ${multiplier}`
        };

      case 'DIVISION':
        // Ensure clean division by finding factors of previousResult
        const divisor = this.findReasonableDivisor(previousResult);
        return {
          operation: 'DIVISION',
          operand_1: previousResult,
          operand_2: divisor,
          result: Math.floor(previousResult / divisor),
          description: `Divide ${previousResult} by ${divisor}`
        };

      default:
        return {
          operation: 'ADDITION',
          operand_1: previousResult,
          operand_2: 5,
          result: previousResult + 5,
          description: `Add 5 to ${previousResult}`
        };
    }
  }

  /**
   * Find a reasonable divisor for clean division
   */
  private findReasonableDivisor(value: number): number {
    // Find factors of the value, prefer smaller ones
    const factors = [];
    for (let i = 2; i <= Math.min(10, Math.floor(value / 2)); i++) {
      if (value % i === 0) {
        factors.push(i);
      }
    }

    // If no good factors found, use a small number that gives a reasonable result
    if (factors.length === 0) {
      // Find a divisor that gives a reasonable quotient (not too small)
      for (let i = 2; i <= 5; i++) {
        if (Math.floor(value / i) >= 1) {
          return i;
        }
      }
      return 2; // Fallback
    }

    // Return a random factor, preferring smaller ones
    return factors[Math.floor(Math.random() * Math.min(factors.length, 3))];
  }

  /**
   * Create structured question content for rich UI rendering
   */
  private createQuestionContent(
    questionText: string,
    stepCalculations: any[],
    scenario: any,
    multiStepParams: MultiStepParams
  ): QuestionContent {
    const character = scenario.characters[0]?.name || 'A student';
    const setting = scenario.setting?.location || 'problem';

    // Extract all intermediate values and final result for highlighting
    const highlightValues: number[] = [];
    stepCalculations.forEach(calc => {
      if (calc.operand_1) highlightValues.push(calc.operand_1);
      if (calc.operand_2) highlightValues.push(calc.operand_2);
      if (calc.result) highlightValues.push(calc.result);
    });

    // Create structured steps
    const steps: QuestionStep[] = stepCalculations.map((calc, index) => ({
      stepNumber: index + 1,
      text: calc.description || `Step ${index + 1}`,
      operation: calc.operation,
      values: [calc.operand_1, calc.operand_2].filter(v => v !== undefined),
      result: calc.result,
      description: calc.description
    }));

    // Extract operators used
    const operators = [...new Set(stepCalculations.map(calc =>
      this.operationToSymbol(calc.operation)
    ).filter(Boolean))];

    return {
      fullText: questionText,
      components: {
        narrative: `${character} needs to solve this step by step:`,
        steps,
        prompt: "What is the final result?",
        highlightValues,
        operators
      },
      templateData: {
        character,
        context: setting,
        theme: scenario.theme,
        quantities: stepCalculations.map(calc => calc.operand_1).filter(Boolean),
        prices: stepCalculations.map(calc => calc.operand_2).filter(Boolean),
        action: 'calculating step by step'
      }
    };
  }

  /**
   * Convert operation string to symbol
   */
  private operationToSymbol(operation: string): string {
    switch (operation) {
      case 'ADDITION': return '+';
      case 'SUBTRACTION': return '-';
      case 'MULTIPLICATION': return 'Ã';
      case 'DIVISION': return 'Ã·';
      default: return '';
    }
  }

  /**
   * Generate multi-step question text with scenario
   */
  private generateMultiStepQuestionText(scenario: any, stepCalculations: any[], multiStepParams: MultiStepParams): string {
    const character = scenario.characters[0].name;
    const setting = scenario.setting.location;

    // Create a story that incorporates all steps
    let storyParts = [];

    switch (scenario.theme) {
      case 'SHOPPING':
        storyParts = this.generateShoppingStory(character, stepCalculations);
        break;
      case 'CLASSROOM':
        storyParts = this.generateClassroomStory(character, stepCalculations);
        break;
      case 'SPORTS':
        storyParts = this.generateSportsStory(character, stepCalculations);
        break;
      default:
        storyParts = this.generateGenericStory(character, stepCalculations);
    }

    // Combine story parts with step structure
    const storyText = storyParts.join(' ');
    return `${storyText} What is the final result?`;
  }

  /**
   * Generate shopping-themed multi-step story
   */
  private generateShoppingStory(character: string, stepCalculations: any[]): string[] {
    const parts = [];

    parts.push(`${character} is shopping and needs to make several calculations.`);

    stepCalculations.forEach((calc, index) => {
      switch (calc.operation) {
        case 'ADDITION':
          if (index === 0) {
            parts.push(`First, ${character} adds the cost of ${calc.operand_1}p and ${calc.operand_2}p items.`);
          } else {
            parts.push(`Then ${character} adds ${calc.operand_2}p more to the total.`);
          }
          break;
        case 'SUBTRACTION':
          if (index === 0) {
            parts.push(`${character} starts with ${calc.operand_1}p and spends ${calc.operand_2}p.`);
          } else {
            parts.push(`Next, ${character} gets a ${calc.operand_2}p discount.`);
          }
          break;
        case 'MULTIPLICATION':
          parts.push(`${character} then buys ${calc.operand_2} items at ${calc.operand_1}p each.`);
          break;
        case 'DIVISION':
          parts.push(`Finally, ${character} splits the ${calc.operand_1}p total equally among ${calc.operand_2} people.`);
          break;
      }
    });

    return parts;
  }

  /**
   * Generate classroom-themed multi-step story
   */
  private generateClassroomStory(character: string, stepCalculations: any[]): string[] {
    const parts = [];

    parts.push(`${character} is solving a math problem step by step.`);

    stepCalculations.forEach((calc, index) => {
      switch (calc.operation) {
        case 'ADDITION':
          parts.push(`Step ${index + 1}: Add ${calc.operand_1} and ${calc.operand_2}.`);
          break;
        case 'SUBTRACTION':
          parts.push(`Step ${index + 1}: Subtract ${calc.operand_2} from ${calc.operand_1}.`);
          break;
        case 'MULTIPLICATION':
          parts.push(`Step ${index + 1}: Multiply ${calc.operand_1} by ${calc.operand_2}.`);
          break;
        case 'DIVISION':
          parts.push(`Step ${index + 1}: Divide ${calc.operand_1} by ${calc.operand_2}.`);
          break;
      }
    });

    return parts;
  }

  /**
   * Generate sports-themed multi-step story
   */
  private generateSportsStory(character: string, stepCalculations: any[]): string[] {
    const parts = [];

    parts.push(`${character} is calculating sports scores and statistics.`);

    stepCalculations.forEach((calc, index) => {
      switch (calc.operation) {
        case 'ADDITION':
          if (index === 0) {
            parts.push(`In round 1, ${character} scores ${calc.operand_1} points, then ${calc.operand_2} more points.`);
          } else {
            parts.push(`In the next round, ${character} adds ${calc.operand_2} bonus points.`);
          }
          break;
        case 'MULTIPLICATION':
          parts.push(`${character} then multiplies the score by ${calc.operand_2} for the multiplier bonus.`);
          break;
        case 'DIVISION':
          parts.push(`Finally, the total is divided by ${calc.operand_2} for the average.`);
          break;
      }
    });

    return parts;
  }

  /**
   * Generate generic multi-step story
   */
  private generateGenericStory(character: string, stepCalculations: any[]): string[] {
    const parts = [];

    parts.push(`${character} needs to solve this step by step:`);

    stepCalculations.forEach((calc, index) => {
      parts.push(`Step ${index + 1}: ${calc.description}.`);
    });

    return parts;
  }

  /**
   * Generate working steps for solution
   */
  private generateWorkingSteps(stepCalculations: any[], multiStepParams: MultiStepParams): string[] {
    const steps = [];

    stepCalculations.forEach((calc, index) => {
      switch (calc.operation) {
        case 'ADDITION':
          steps.push(`Step ${index + 1}: ${calc.operand_1} + ${calc.operand_2} = ${calc.result}`);
          break;
        case 'SUBTRACTION':
          steps.push(`Step ${index + 1}: ${calc.operand_1} - ${calc.operand_2} = ${calc.result}`);
          break;
        case 'MULTIPLICATION':
          steps.push(`Step ${index + 1}: ${calc.operand_1} Ã ${calc.operand_2} = ${calc.result}`);
          break;
        case 'DIVISION':
          steps.push(`Step ${index + 1}: ${calc.operand_1} Ã· ${calc.operand_2} = ${calc.result}`);
          break;
        default:
          steps.push(`Step ${index + 1}: Calculate = ${calc.result}`);
      }
    });

    const finalResult = stepCalculations[stepCalculations.length - 1].result;
    steps.push(`Final answer: ${finalResult}`);

    return steps;
  }

  /**
   * Generate step-by-step explanation
   */
  private generateStepByStepExplanation(stepCalculations: any[], multiStepParams: MultiStepParams): string {
    const explanations = stepCalculations.map((calc, index) =>
      `Step ${index + 1}: ${calc.description} = ${calc.result}`
    );

    const finalResult = stepCalculations[stepCalculations.length - 1].result;
    explanations.push(`Therefore, the final answer is ${finalResult}.`);

    return explanations.join('. ');
  }

  /**
   * Generate distractors for multi-step problems
   */
  private async generateMultiStepDistractors(stepCalculations: any[], multiStepParams: MultiStepParams): Promise<any[]> {
    const distractors = [];
    const finalResult = stepCalculations[stepCalculations.length - 1].result;

    // Common multi-step errors:

    // 1. Stopped after first step
    if (stepCalculations.length > 1) {
      distractors.push({
        value: stepCalculations[0].result,
        strategy: DistractorStrategy.PARTIAL_CALCULATION,
        rationale: 'Stopped after first step'
      });
    }

    // 2. Wrong operation in one step
    const wrongOpStep = Math.floor(Math.random() * stepCalculations.length);
    const wrongResult = this.calculateWithWrongOperation(stepCalculations, wrongOpStep);
    distractors.push({
      value: wrongResult,
      strategy: DistractorStrategy.WRONG_OPERATION,
      rationale: `Used wrong operation in step ${wrongOpStep + 1}`
    });

    // 3. Order of operations error
    const outOfOrderResult = this.calculateOutOfOrder(stepCalculations);
    distractors.push({
      value: outOfOrderResult,
      strategy: DistractorStrategy.WRONG_OPERATION,
      rationale: 'Performed operations in wrong order'
    });

    // 4. Calculation error in final step
    const lastStepError = finalResult + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 10) + 1);
    distractors.push({
      value: lastStepError,
      strategy: DistractorStrategy.CALCULATION_ERROR,
      rationale: 'Calculation error in final step'
    });

    return distractors.slice(0, 3);
  }

  /**
   * Calculate result with wrong operation in one step
   */
  private calculateWithWrongOperation(stepCalculations: any[], errorStepIndex: number): number {
    let result = stepCalculations[0].result;

    for (let i = 1; i < stepCalculations.length; i++) {
      const calc = stepCalculations[i];

      if (i === errorStepIndex) {
        // Use wrong operation
        switch (calc.operation) {
          case 'ADDITION':
            result = result - calc.operand_2; // Subtract instead
            break;
          case 'SUBTRACTION':
            result = result + calc.operand_2; // Add instead
            break;
          case 'MULTIPLICATION':
            result = result + calc.operand_2; // Add instead
            break;
          case 'DIVISION':
            result = result - calc.operand_2; // Subtract instead
            break;
        }
      } else {
        // Use correct operation
        result = calc.result;
      }
    }

    return result;
  }

  /**
   * Calculate with steps performed out of order
   */
  private calculateOutOfOrder(stepCalculations: any[]): number {
    // Simple out of order error: reverse last two operations
    if (stepCalculations.length < 2) return stepCalculations[0].result;

    // Start with first calculation
    let result = stepCalculations[0].result;

    // Skip to last operation first
    const lastCalc = stepCalculations[stepCalculations.length - 1];
    const secondLastCalc = stepCalculations[stepCalculations.length - 2];

    // Apply last operation to first result (out of order)
    switch (lastCalc.operation) {
      case 'ADDITION':
        result += lastCalc.operand_2;
        break;
      case 'SUBTRACTION':
        result -= lastCalc.operand_2;
        break;
      case 'MULTIPLICATION':
        result *= lastCalc.operand_2;
        break;
      case 'DIVISION':
        result /= lastCalc.operand_2;
        break;
    }

    return Math.round(result * 100) / 100; // Round to 2 decimal places
  }
}
```
--- END FILE: lib\controllers\multi-step.controller.ts ---

--- START FILE: lib\controllers\ordering.controller.ts ---
```typescript
// Ordering Controller - Generates ordering and sequencing questions
// "Put these in order from smallest to largest" or "Arrange these numbers"

import {
  QuestionController,
  GenerationParams,
  ControllerDependencies
} from './base-question.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  DistractorStrategy,
  ScenarioTheme
} from '@/lib/types/question-formats';

/**
 * Ordering specific parameters
 */
interface OrderingParams {
  orderDirection: 'ascending' | 'descending' | 'custom';
  orderCriteria: 'value' | 'magnitude' | 'length' | 'weight' | 'time' | 'alphabetical';
  itemCount: number;
  values: number[];
  correctOrder: number[];
  includeEquivalents: boolean;
  mixedTypes?: boolean; // Mix integers, decimals, fractions
}

/**
 * Controller for generating ordering and sequencing questions
 */
export class OrderingController extends QuestionController {

  constructor(dependencies: ControllerDependencies) {
    super(dependencies);
  }

  /**
   * Generate ordering question
   */
  async generate(params: GenerationParams): Promise<QuestionDefinition> {
    try {
      // 1. Generate base math content to get number ranges
      const mathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);

      // 2. Select appropriate scenario
      const scenario = await this.selectScenario({
        theme: params.preferredTheme || ScenarioTheme.CLASSROOM,
        mathModel: params.mathModel,
        difficulty: params.difficulty,
        culturalContext: params.culturalContext
    });

    // 3. Determine ordering parameters
    const orderingParams = this.determineOrderingParams(params.mathModel, mathOutput, params.difficulty);

    // 4. Generate the ordering question
    const questionDef = await this.generateOrderingQuestion(mathOutput, scenario, orderingParams, params);

    return questionDef;
    } catch (error) {
      console.error('OrderingController error:', error);
      // Fallback to simple question format
      return this.generateFallbackQuestion(params);
    }
  }

  /**
   * Generate fallback question if ordering fails
   */
  private async generateFallbackQuestion(params: GenerationParams): Promise<QuestionDefinition> {
    const mathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);
    const scenario = await this.selectScenario({
      theme: ScenarioTheme.CLASSROOM,
      mathModel: params.mathModel,
      difficulty: params.difficulty,
      culturalContext: params.culturalContext
    });

    return this.createBaseQuestionDefinition(
      QuestionFormat.ORDERING,
      params.mathModel,
      params.difficulty,
      scenario
    );
  }

  /**
   * Generate complete ordering question
   */
  private async generateOrderingQuestion(
    mathOutput: any,
    scenario: any,
    orderingParams: OrderingParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.ORDERING,
      params.mathModel,
      params.difficulty,
      scenario
    );

    // Generate set of values to order
    const valuesToOrder = this.generateValuesToOrder(mathOutput, orderingParams, params.difficulty);

    // Calculate correct ordering
    const correctOrder = this.calculateCorrectOrder(valuesToOrder, orderingParams);

    // Create question text with scenario
    const questionText = this.generateOrderingQuestionText(scenario, valuesToOrder, orderingParams);

    // Generate distractors (incorrect orderings)
    const distractors = await this.generateOrderingDistractors(valuesToOrder, correctOrder, orderingParams);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        orderingParams: {
          ...orderingParams,
          values: valuesToOrder,
          correctOrder
        },
        valuesToOrder
      },
      solution: {
        correctAnswer: {
          value: correctOrder,
          displayText: correctOrder.map(index => valuesToOrder[index]).join(', '),
          units: ''
        },
        distractors,
        workingSteps: this.generateOrderingSteps(valuesToOrder, correctOrder, orderingParams),
        explanation: this.generateOrderingExplanation(valuesToOrder, correctOrder, orderingParams)
      }
    } as QuestionDefinition;
  }

  /**
   * Determine ordering parameters based on context
   */
  private determineOrderingParams(mathModel: string, mathOutput: any, difficulty: any): OrderingParams {
    // Determine order direction
    const orderDirection = Math.random() > 0.3 ? 'ascending' : 'descending';

    // Determine criteria based on model
    let orderCriteria: OrderingParams['orderCriteria'];
    if (mathModel.includes('MONEY')) {
      orderCriteria = 'value';
    } else if (mathModel.includes('TIME')) {
      orderCriteria = 'time';
    } else if (mathModel.includes('MEASUREMENT') || mathModel.includes('LENGTH')) {
      orderCriteria = 'length';
    } else {
      orderCriteria = 'value';
    }

    // Determine item count based on difficulty
    let itemCount = 3; // Default
    if (difficulty.year <= 2) {
      itemCount = 3;
    } else if (difficulty.year <= 4) {
      itemCount = Math.random() > 0.5 ? 4 : 5;
    } else {
      itemCount = Math.floor(Math.random() * 3) + 4; // 4-6 items
    }

    return {
      orderDirection,
      orderCriteria,
      itemCount,
      values: [],
      correctOrder: [],
      includeEquivalents: difficulty.year >= 4 && Math.random() > 0.7,
      mixedTypes: difficulty.year >= 5 && Math.random() > 0.8
    };
  }

  /**
   * Generate set of values to order
   */
  private generateValuesToOrder(mathOutput: any, orderingParams: OrderingParams, difficulty: any): number[] {
    const values = [];
    const baseRange = this.getBaseRange(mathOutput, difficulty);

    // Generate distinct values for ordering
    for (let i = 0; i < orderingParams.itemCount; i++) {
      let newValue;
      let attempts = 0;

      do {
        newValue = this.generateValueInRange(baseRange, orderingParams, i);
        attempts++;
      } while (values.includes(newValue) && attempts < 10);

      values.push(newValue);
    }

    // If including equivalents, replace one value with equivalent form
    if (orderingParams.includeEquivalents && values.length > 3) {
      const replaceIndex = Math.floor(Math.random() * values.length);
      values[replaceIndex] = this.createEquivalentForm(values[replaceIndex], difficulty.year);
    }

    // Shuffle the values so they're not already in order
    return this.shuffleArray(values);
  }

  /**
   * Get base range for values
   */
  private getBaseRange(mathOutput: any, difficulty: any): { min: number, max: number } {
    const result = mathOutput.result || mathOutput.answer || 100;

    if (difficulty.year <= 2) {
      return { min: 1, max: 20 };
    } else if (difficulty.year <= 4) {
      return { min: 1, max: Math.min(100, result * 2) };
    } else {
      return { min: 1, max: Math.min(1000, result * 3) };
    }
  }

  /**
   * Generate value within range
   */
  private generateValueInRange(range: { min: number, max: number }, orderingParams: OrderingParams, index: number): number {
    if (orderingParams.mixedTypes && Math.random() > 0.7) {
      // Generate decimal
      const wholepart = Math.floor(Math.random() * (range.max - range.min)) + range.min;
      const decimal = Math.floor(Math.random() * 9) + 1;
      return parseFloat(`${wholepart}.${decimal}`);
    }

    // Generate integer
    return Math.floor(Math.random() * (range.max - range.min)) + range.min;
  }

  /**
   * Create equivalent form (like 0.5 for 1/2)
   */
  private createEquivalentForm(value: number, year: number): number {
    if (year >= 4 && Number.isInteger(value)) {
      // Convert some integers to decimals
      if (value % 2 === 0) {
        return value + 0.5;
      } else if (value % 4 === 0) {
        return value + 0.25;
      }
    }

    return value; // Return as-is if no conversion
  }

  /**
   * Shuffle array using Fisher-Yates algorithm
   */
  private shuffleArray(array: number[]): number[] {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }

  /**
   * Calculate correct order
   */
  private calculateCorrectOrder(values: number[], orderingParams: OrderingParams): number[] {
    const indexed = values.map((value, index) => ({ value, index }));

    switch (orderingParams.orderDirection) {
      case 'ascending':
        indexed.sort((a, b) => a.value - b.value);
        break;
      case 'descending':
        indexed.sort((a, b) => b.value - a.value);
        break;
      default:
        indexed.sort((a, b) => a.value - b.value);
    }

    return indexed.map(item => item.index);
  }

  /**
   * Generate question text with scenario
   */
  private generateOrderingQuestionText(scenario: any, values: number[], orderingParams: OrderingParams): string {
    const character = scenario.characters[0].name;
    const direction = orderingParams.orderDirection === 'ascending' ? 'smallest to largest' : 'largest to smallest';
    const valuesText = values.join(', ');

    // Customize based on scenario theme and criteria
    switch (scenario.theme) {
      case 'SHOPPING':
        if (orderingParams.orderCriteria === 'value') {
          return `${character} is comparing prices: ${valuesText} pence. Arrange these prices from ${direction}.`;
        }
        break;

      case 'SPORTS':
        return `${character} recorded these scores: ${valuesText}. Put them in order from ${direction}.`;

      case 'CLASSROOM':
        return `${character} has these numbers on the board: ${valuesText}. Help arrange them from ${direction}.`;

      case 'REAL_WORLD':
        if (orderingParams.orderCriteria === 'length') {
          return `${character} measured these lengths: ${values.map(v => v + 'cm').join(', ')}. Order them from ${direction}.`;
        }
        if (orderingParams.orderCriteria === 'weight') {
          return `${character} weighed these items: ${values.map(v => v + 'g').join(', ')}. Arrange by weight from ${direction}.`;
        }
        break;

      default:
        return `${character} needs to order these numbers from ${direction}: ${valuesText}`;
    }

    return `${character} needs to order these numbers from ${direction}: ${valuesText}`;
  }

  /**
   * Generate working steps for solution
   */
  private generateOrderingSteps(values: number[], correctOrder: number[], orderingParams: OrderingParams): string[] {
    const steps = [];
    const direction = orderingParams.orderDirection === 'ascending' ? 'smallest to largest' : 'largest to smallest';

    steps.push(`Original numbers: ${values.join(', ')}`);
    steps.push(`We need to arrange from ${direction}`);

    // Show comparison process
    if (values.length <= 4) {
      steps.push(`Compare each number with the others`);
      const sortedValues = values.map((v, i) => ({ value: v, index: i }))
        .sort((a, b) => orderingParams.orderDirection === 'ascending' ? a.value - b.value : b.value - a.value)
        .map(item => item.value);

      steps.push(`Sorted order: ${sortedValues.join(', ')}`);
    } else {
      steps.push(`Find the ${orderingParams.orderDirection === 'ascending' ? 'smallest' : 'largest'} number first`);
      steps.push(`Continue until all numbers are ordered`);
    }

    return steps;
  }

  /**
   * Generate explanation
   */
  private generateOrderingExplanation(values: number[], correctOrder: number[], orderingParams: OrderingParams): string {
    const sortedValues = correctOrder.map(index => values[index]);
    const direction = orderingParams.orderDirection === 'ascending' ? 'smallest to largest' : 'largest to smallest';

    return `When arranged from ${direction}, the correct order is: ${sortedValues.join(', ')}.`;
  }

  /**
   * Generate distractors (incorrect orderings)
   */
  private async generateOrderingDistractors(values: number[], correctOrder: number[], orderingParams: OrderingParams): Promise<any[]> {
    const distractors = [];
    const correctSorted = correctOrder.map(index => values[index]);

    // Common ordering errors:

    // 1. Reverse order
    const reverseOrder = [...correctOrder].reverse();
    const reverseSorted = reverseOrder.map(index => values[index]);
    if (JSON.stringify(reverseSorted) !== JSON.stringify(correctSorted)) {
      distractors.push({
        value: reverseSorted,
        strategy: DistractorStrategy.LOGICAL_OPPOSITE,
        rationale: 'Ordered in opposite direction'
      });
    }

    // 2. Partially correct (first few right, rest wrong)
    if (correctOrder.length > 3) {
      const partialOrder = [...correctOrder];
      // Swap last two elements
      [partialOrder[partialOrder.length - 1], partialOrder[partialOrder.length - 2]] =
      [partialOrder[partialOrder.length - 2], partialOrder[partialOrder.length - 1]];

      const partialSorted = partialOrder.map(index => values[index]);
      distractors.push({
        value: partialSorted,
        strategy: DistractorStrategy.PARTIAL_UNDERSTANDING,
        rationale: 'Partially correct ordering'
      });
    }

    // 3. Random/original order
    if (JSON.stringify(values) !== JSON.stringify(correctSorted)) {
      distractors.push({
        value: values,
        strategy: DistractorStrategy.NO_ATTEMPT,
        rationale: 'Original unsorted order'
      });
    }

    // 4. Nearly correct (one element out of place)
    if (correctOrder.length >= 4) {
      const nearlyCorrect = [...correctOrder];
      const swapIndex = Math.floor(Math.random() * (nearlyCorrect.length - 1));
      [nearlyCorrect[swapIndex], nearlyCorrect[swapIndex + 1]] =
      [nearlyCorrect[swapIndex + 1], nearlyCorrect[swapIndex]];

      const nearlySorted = nearlyCorrect.map(index => values[index]);
      if (JSON.stringify(nearlySorted) !== JSON.stringify(correctSorted)) {
        distractors.push({
          value: nearlySorted,
          strategy: DistractorStrategy.CLOSE_BUT_WRONG,
          rationale: 'One element out of place'
        });
      }
    }

    return distractors.slice(0, 3);
  }
}
```
--- END FILE: lib\controllers\ordering.controller.ts ---

--- START FILE: lib\controllers\pattern.controller.ts ---
```typescript
// Pattern Controller - Generates pattern recognition and sequence questions
// "What comes next?" or "Complete the pattern" or "Find the rule"

import {
  QuestionController,
  GenerationParams,
  ControllerDependencies
} from './base-question.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  DistractorStrategy,
  ScenarioTheme
} from '@/lib/types/question-formats';

/**
 * Pattern specific parameters
 */
interface PatternParams {
  patternType: 'arithmetic' | 'geometric' | 'fibonacci' | 'quadratic' | 'custom';
  patternRule: string;
  sequence: number[];
  missingPosition: 'next' | 'middle' | 'beginning' | 'multiple';
  difficulty: 'simple' | 'moderate' | 'complex';
  step: number; // For arithmetic sequences
  ratio?: number; // For geometric sequences
  baseValue: number;
  sequenceLength: number;
}

/**
 * Controller for generating pattern recognition questions
 */
export class PatternController extends QuestionController {

  constructor(dependencies: ControllerDependencies) {
    super(dependencies);
  }

  /**
   * Generate pattern recognition question
   */
  async generate(params: GenerationParams): Promise<QuestionDefinition> {
    // 1. Generate base math content for number ranges
    const mathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);

    // 2. Select appropriate scenario
    const scenario = await this.selectScenario({
      theme: params.preferredTheme || ScenarioTheme.PUZZLE,
      mathModel: params.mathModel,
      difficulty: params.difficulty,
      culturalContext: params.culturalContext
    });

    // 3. Determine pattern parameters
    const patternParams = this.determinePatternParams(params.mathModel, mathOutput, params.difficulty);

    // 4. Generate the pattern question
    const questionDef = await this.generatePatternQuestion(mathOutput, scenario, patternParams, params);

    return questionDef;
  }

  /**
   * Generate complete pattern question
   */
  private async generatePatternQuestion(
    mathOutput: any,
    scenario: any,
    patternParams: PatternParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.PATTERN_RECOGNITION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    // Generate complete sequence based on pattern
    const fullSequence = this.generateSequence(patternParams);

    // Create the question by hiding some elements
    const questionSequence = this.createQuestionSequence(fullSequence, patternParams);

    // Determine what the student needs to find
    const missingValues = this.findMissingValues(fullSequence, questionSequence, patternParams);

    // Create question text with scenario
    const questionText = this.generatePatternQuestionText(scenario, questionSequence, patternParams);

    // Generate distractors
    const distractors = await this.generatePatternDistractors(missingValues, patternParams, fullSequence);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        patternParams: {
          ...patternParams,
          sequence: fullSequence
        },
        questionSequence,
        missingValues
      },
      solution: {
        correctAnswer: {
          value: missingValues.length === 1 ? missingValues[0] : missingValues,
          displayText: missingValues.length === 1 ? missingValues[0].toString() : missingValues.join(', '),
          units: ''
        },
        distractors,
        workingSteps: this.generatePatternSteps(fullSequence, patternParams),
        explanation: this.generatePatternExplanation(patternParams, missingValues)
      }
    } as QuestionDefinition;
  }

  /**
   * Determine pattern parameters based on context
   */
  private determinePatternParams(mathModel: string, mathOutput: any, difficulty: any): PatternParams {
    // Determine pattern type based on difficulty
    let patternType: PatternParams['patternType'];
    let patternDifficulty: PatternParams['difficulty'];

    if (difficulty.year <= 2) {
      patternType = 'arithmetic';
      patternDifficulty = 'simple';
    } else if (difficulty.year <= 4) {
      patternType = Math.random() > 0.7 ? 'geometric' : 'arithmetic';
      patternDifficulty = Math.random() > 0.5 ? 'simple' : 'moderate';
    } else {
      const types: PatternParams['patternType'][] = ['arithmetic', 'geometric', 'quadratic'];
      if (difficulty.year >= 6) types.push('fibonacci', 'custom');
      patternType = types[Math.floor(Math.random() * types.length)];
      patternDifficulty = Math.random() > 0.3 ? 'moderate' : 'complex';
    }

    // Determine sequence length
    const sequenceLength = Math.max(4, Math.min(8, difficulty.year + 2));

    // Determine missing position
    let missingPosition: PatternParams['missingPosition'];
    if (difficulty.year <= 2) {
      missingPosition = 'next';
    } else if (difficulty.year <= 4) {
      missingPosition = Math.random() > 0.5 ? 'next' : 'middle';
    } else {
      const positions: PatternParams['missingPosition'][] = ['next', 'middle', 'multiple'];
      missingPosition = positions[Math.floor(Math.random() * positions.length)];
    }

    // Generate pattern-specific parameters
    const baseValue = this.generateBaseValue(mathOutput, patternDifficulty);
    const step = this.generateStep(patternType, patternDifficulty);
    const ratio = patternType === 'geometric' ? this.generateRatio(patternDifficulty) : undefined;

    return {
      patternType,
      patternRule: '',
      sequence: [],
      missingPosition,
      difficulty: patternDifficulty,
      step,
      ratio,
      baseValue,
      sequenceLength
    };
  }

  /**
   * Generate appropriate base value
   */
  private generateBaseValue(mathOutput: any, difficulty: PatternParams['difficulty']): number {
    switch (difficulty) {
      case 'simple':
        return Math.floor(Math.random() * 10) + 1;
      case 'moderate':
        return Math.floor(Math.random() * 20) + 1;
      case 'complex':
        return Math.floor(Math.random() * 50) + 1;
      default:
        return 2;
    }
  }

  /**
   * Generate step size for arithmetic patterns
   */
  private generateStep(patternType: PatternParams['patternType'], difficulty: PatternParams['difficulty']): number {
    if (patternType !== 'arithmetic') return 1;

    switch (difficulty) {
      case 'simple':
        return Math.floor(Math.random() * 5) + 1; // 1-5
      case 'moderate':
        return Math.floor(Math.random() * 10) + 1; // 1-10
      case 'complex':
        return Math.floor(Math.random() * 15) + 1; // 1-15
      default:
        return 2;
    }
  }

  /**
   * Generate ratio for geometric patterns
   */
  private generateRatio(difficulty: PatternParams['difficulty']): number {
    switch (difficulty) {
      case 'simple':
        return 2; // Always double
      case 'moderate':
        return Math.random() > 0.5 ? 2 : 3; // x2 or x3
      case 'complex':
        const ratios = [2, 3, 4, 0.5]; // Include fractions
        return ratios[Math.floor(Math.random() * ratios.length)];
      default:
        return 2;
    }
  }

  /**
   * Generate complete sequence based on pattern
   */
  private generateSequence(patternParams: PatternParams): number[] {
    const sequence = [];
    let current = patternParams.baseValue;

    switch (patternParams.patternType) {
      case 'arithmetic':
        for (let i = 0; i < patternParams.sequenceLength; i++) {
          sequence.push(current);
          current += patternParams.step;
        }
        patternParams.patternRule = `Add ${patternParams.step} each time`;
        break;

      case 'geometric':
        for (let i = 0; i < patternParams.sequenceLength; i++) {
          sequence.push(Math.round(current * 100) / 100); // Round to 2 decimal places
          current *= patternParams.ratio!;
        }
        patternParams.patternRule = `Multiply by ${patternParams.ratio} each time`;
        break;

      case 'fibonacci':
        // Start with two values
        sequence.push(patternParams.baseValue);
        sequence.push(patternParams.baseValue + 1);
        for (let i = 2; i < patternParams.sequenceLength; i++) {
          sequence.push(sequence[i - 1] + sequence[i - 2]);
        }
        patternParams.patternRule = 'Each number is the sum of the two previous numbers';
        break;

      case 'quadratic':
        for (let i = 0; i < patternParams.sequenceLength; i++) {
          const term = patternParams.baseValue + (i * i * patternParams.step);
          sequence.push(term);
        }
        patternParams.patternRule = `Based on square numbers (nÂ²)`;
        break;

      case 'custom':
        // Alternating pattern or more complex
        for (let i = 0; i < patternParams.sequenceLength; i++) {
          if (i % 2 === 0) {
            sequence.push(current);
            current += patternParams.step;
          } else {
            sequence.push(current - 1);
            current += patternParams.step;
          }
        }
        patternParams.patternRule = 'Alternating pattern with step changes';
        break;

      default:
        // Default arithmetic
        for (let i = 0; i < patternParams.sequenceLength; i++) {
          sequence.push(current);
          current += patternParams.step;
        }
        patternParams.patternRule = `Add ${patternParams.step} each time`;
    }

    return sequence;
  }

  /**
   * Create question sequence by hiding some elements
   */
  private createQuestionSequence(fullSequence: number[], patternParams: PatternParams): (number | string)[] {
    const questionSequence = [...fullSequence] as (number | string)[];

    switch (patternParams.missingPosition) {
      case 'next':
        // Remove the last element(s)
        questionSequence[questionSequence.length - 1] = '?';
        break;

      case 'middle':
        // Remove a middle element
        const middleIndex = Math.floor(questionSequence.length / 2);
        questionSequence[middleIndex] = '?';
        break;

      case 'beginning':
        // Remove first element
        questionSequence[0] = '?';
        break;

      case 'multiple':
        // Remove multiple elements
        const indices = this.selectMultipleIndices(questionSequence.length);
        indices.forEach(index => {
          questionSequence[index] = '?';
        });
        break;
    }

    return questionSequence;
  }

  /**
   * Select multiple indices for missing values
   */
  private selectMultipleIndices(length: number): number[] {
    const count = Math.min(2, Math.floor(length / 3)); // Remove at most 1/3
    const indices = [];

    while (indices.length < count) {
      const index = Math.floor(Math.random() * length);
      if (!indices.includes(index)) {
        indices.push(index);
      }
    }

    return indices.sort((a, b) => a - b);
  }

  /**
   * Find missing values in the sequence
   */
  private findMissingValues(fullSequence: number[], questionSequence: (number | string)[], patternParams: PatternParams): number[] {
    const missingValues = [];

    for (let i = 0; i < questionSequence.length; i++) {
      if (questionSequence[i] === '?') {
        missingValues.push(fullSequence[i]);
      }
    }

    return missingValues;
  }

  /**
   * Generate question text with scenario
   */
  private generatePatternQuestionText(scenario: any, questionSequence: (number | string)[], patternParams: PatternParams): string {
    const character = scenario.characters[0].name;
    const sequenceText = questionSequence.join(', ');

    switch (scenario.theme) {
      case 'CLASSROOM':
        return `${character} is working on number patterns. Look at this sequence: ${sequenceText}. What number(s) should replace the ? to continue the pattern?`;

      case 'PUZZLE':
        return `${character} found this number puzzle: ${sequenceText}. Can you figure out what number should replace the ?`;

      case 'REAL_WORLD':
        if (patternParams.patternType === 'arithmetic' && patternParams.step > 0) {
          return `${character} is counting by ${patternParams.step}s: ${sequenceText}. What comes next?`;
        }
        break;

      case 'SPORTS':
        return `${character} noticed a pattern in the scores: ${sequenceText}. What number should replace the ?`;

      default:
        return `${character} needs to find the missing number in this pattern: ${sequenceText}`;
    }

    return `Look at this pattern: ${sequenceText}. What number should replace the ?`;
  }

  /**
   * Generate working steps for solution
   */
  private generatePatternSteps(fullSequence: number[], patternParams: PatternParams): string[] {
    const steps = [];

    steps.push(`Look at the sequence: ${fullSequence.slice(0, Math.min(4, fullSequence.length)).join(', ')}...`);

    switch (patternParams.patternType) {
      case 'arithmetic':
        steps.push(`Find the difference between consecutive terms`);
        steps.push(`${fullSequence[1]} - ${fullSequence[0]} = ${patternParams.step}`);
        steps.push(`${fullSequence[2]} - ${fullSequence[1]} = ${patternParams.step}`);
        steps.push(`The pattern adds ${patternParams.step} each time`);
        break;

      case 'geometric':
        steps.push(`Find the ratio between consecutive terms`);
        steps.push(`${fullSequence[1]} Ã· ${fullSequence[0]} = ${patternParams.ratio}`);
        steps.push(`${fullSequence[2]} Ã· ${fullSequence[1]} = ${patternParams.ratio}`);
        steps.push(`The pattern multiplies by ${patternParams.ratio} each time`);
        break;

      case 'fibonacci':
        steps.push(`Look for the relationship between terms`);
        steps.push(`${fullSequence[0]} + ${fullSequence[1]} = ${fullSequence[2]}`);
        steps.push(`${fullSequence[1]} + ${fullSequence[2]} = ${fullSequence[3]}`);
        steps.push(`Each term is the sum of the two previous terms`);
        break;

      case 'quadratic':
        steps.push(`Look at the differences between terms`);
        steps.push(`The pattern is based on square numbers`);
        break;

      default:
        steps.push(`Identify the rule: ${patternParams.patternRule}`);
        steps.push(`Apply the rule to find missing values`);
    }

    return steps;
  }

  /**
   * Generate pattern explanation
   */
  private generatePatternExplanation(patternParams: PatternParams, missingValues: number[]): string {
    const rule = patternParams.patternRule;
    const answer = missingValues.length === 1 ? missingValues[0].toString() : missingValues.join(', ');

    return `The pattern rule is: ${rule}. Therefore, the missing value(s) are: ${answer}.`;
  }

  /**
   * Generate distractors for pattern questions
   */
  private async generatePatternDistractors(missingValues: number[], patternParams: PatternParams, fullSequence: number[]): Promise<any[]> {
    const distractors = [];
    const correctValue = missingValues[0]; // Use first missing value for simplicity

    // Common pattern errors:

    // 1. Wrong step size (arithmetic patterns)
    if (patternParams.patternType === 'arithmetic') {
      const wrongStep = patternParams.step + (Math.random() > 0.5 ? 1 : -1);
      const wrongValue = this.calculateWithWrongStep(fullSequence, correctValue, wrongStep, patternParams);
      if (wrongValue !== correctValue) {
        distractors.push({
          value: wrongValue,
          strategy: DistractorStrategy.PROCEDURAL_ERROR,
          rationale: `Used wrong step size (${wrongStep} instead of ${patternParams.step})`
        });
      }
    }

    // 2. Wrong operation
    const wrongOpValue = this.calculateWithWrongOperation(fullSequence, correctValue, patternParams);
    if (wrongOpValue !== correctValue) {
      distractors.push({
        value: wrongOpValue,
        strategy: DistractorStrategy.WRONG_OPERATION,
        rationale: 'Used wrong operation for pattern'
      });
    }

    // 3. Pattern from wrong starting point
    const wrongStartValue = this.calculateFromWrongStart(fullSequence, patternParams);
    if (wrongStartValue !== correctValue) {
      distractors.push({
        value: wrongStartValue,
        strategy: DistractorStrategy.PATTERN_MISUNDERSTANDING,
        rationale: 'Started pattern from wrong position'
      });
    }

    // 4. Simple counting error
    const countingError = correctValue + (Math.random() > 0.5 ? 1 : -1);
    if (countingError !== correctValue && countingError > 0) {
      distractors.push({
        value: countingError,
        strategy: DistractorStrategy.CALCULATION_ERROR,
        rationale: 'Off by one error'
      });
    }

    // 5. Magnitude error (for geometric patterns)
    if (patternParams.patternType === 'geometric') {
      const magnitudeError = Math.round(correctValue * 1.5);
      if (magnitudeError !== correctValue) {
        distractors.push({
          value: magnitudeError,
          strategy: DistractorStrategy.MAGNITUDE_ERROR,
          rationale: 'Magnitude error in geometric progression'
        });
      }
    }

    return distractors.slice(0, 3);
  }

  /**
   * Calculate value with wrong step size
   */
  private calculateWithWrongStep(fullSequence: number[], correctValue: number, wrongStep: number, patternParams: PatternParams): number {
    // Assume we're finding the next value in sequence
    const lastKnownValue = fullSequence[fullSequence.length - 2];
    return lastKnownValue + wrongStep;
  }

  /**
   * Calculate value with wrong operation
   */
  private calculateWithWrongOperation(fullSequence: number[], correctValue: number, patternParams: PatternParams): number {
    if (patternParams.patternType === 'arithmetic') {
      // Use multiplication instead of addition
      const lastKnownValue = fullSequence[fullSequence.length - 2];
      return lastKnownValue * 2;
    }

    if (patternParams.patternType === 'geometric') {
      // Use addition instead of multiplication
      const lastKnownValue = fullSequence[fullSequence.length - 2];
      return lastKnownValue + patternParams.ratio!;
    }

    return correctValue + 5; // Fallback
  }

  /**
   * Calculate assuming wrong starting point
   */
  private calculateFromWrongStart(fullSequence: number[], patternParams: PatternParams): number {
    // Assume pattern starts from second element instead of first
    if (fullSequence.length < 2) return fullSequence[0];

    const wrongBase = fullSequence[1];
    const position = fullSequence.length - 1; // Position of missing element

    if (patternParams.patternType === 'arithmetic') {
      return wrongBase + (position * patternParams.step);
    }

    return wrongBase * Math.pow(patternParams.ratio || 2, position);
  }
}
```
--- END FILE: lib\controllers\pattern.controller.ts ---

--- START FILE: lib\controllers\validation.controller.ts ---
```typescript
// Validation Controller - Generates validation and verification questions
// "Is this correct?" or "Check the calculation" or "True or False?"

import {
  QuestionController,
  GenerationParams,
  ControllerDependencies
} from './base-question.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  DistractorStrategy,
  ScenarioTheme
} from '@/lib/types/question-formats';

/**
 * Validation-specific parameters
 */
interface ValidationParams {
  validationType: 'true_false' | 'check_work' | 'spot_error' | 'verify_answer';
  errorType?: 'computational' | 'conceptual' | 'procedural' | 'none';
  showWorking?: boolean;
  includeExplanation?: boolean;
}

/**
 * Controller for generating validation and verification questions
 */
export class ValidationController extends QuestionController {

  constructor(dependencies: ControllerDependencies) {
    super(dependencies);
  }

  /**
   * Generate validation-focused question
   */
  async generate(params: GenerationParams): Promise<QuestionDefinition> {
    // 1. Generate base math content
    const mathOutput = await this.generateMathOutput(params.mathModel, params.difficultyParams);

    // 2. Select appropriate scenario
    const scenario = await this.selectScenario({
      theme: params.preferredTheme || ScenarioTheme.CLASSROOM,
      mathModel: params.mathModel,
      difficulty: params.difficulty,
      culturalContext: params.culturalContext
    });

    // 3. Determine validation type and potential errors
    const validationParams = this.determineValidationParams(params.mathModel, mathOutput, params.difficulty);

    // 4. Generate validation question variants
    let questionDef: QuestionDefinition;

    switch (validationParams.validationType) {
      case 'true_false':
        questionDef = await this.generateTrueFalseQuestion(mathOutput, scenario, validationParams, params);
        break;
      case 'check_work':
        questionDef = await this.generateCheckWorkQuestion(mathOutput, scenario, validationParams, params);
        break;
      case 'spot_error':
        questionDef = await this.generateSpotErrorQuestion(mathOutput, scenario, validationParams, params);
        break;
      case 'verify_answer':
        questionDef = await this.generateVerifyAnswerQuestion(mathOutput, scenario, validationParams, params);
        break;
      default:
        questionDef = await this.generateTrueFalseQuestion(mathOutput, scenario, validationParams, params);
    }

    return questionDef;
  }

  /**
   * Generate true/false validation question
   */
  private async generateTrueFalseQuestion(
    mathOutput: any,
    scenario: any,
    validationParams: ValidationParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.VALIDATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    const correctAnswer = mathOutput.result || mathOutput.answer || mathOutput.value;

    // Randomly decide if presenting correct or incorrect statement
    const isCorrectStatement = Math.random() > 0.5;
    let presentedAnswer: number;
    let statementIsTrue: boolean;

    if (isCorrectStatement) {
      presentedAnswer = correctAnswer;
      statementIsTrue = true;
    } else {
      // Generate a plausible incorrect answer
      presentedAnswer = this.generatePlausibleIncorrectAnswer(mathOutput, validationParams.errorType || 'computational');
      statementIsTrue = false;
    }

    const questionText = this.generateTrueFalseQuestionText(scenario, mathOutput, presentedAnswer);

    // Distractors are "True" or "False"
    const distractors = await this.generateTrueFalseDistractors(statementIsTrue);

    // Create proper QuestionParameters structure
    const parameters = {
      mathValues: {
        ...mathOutput,
        presentedAnswer,
        correctAnswer,
        isTrue: statementIsTrue
      },
      narrativeValues: {
        character: scenario.characters?.[0]?.name || 'Student',
        operation: this.describeOperation(mathOutput),
        presentedAnswer: String(presentedAnswer)
      },
      units: {
        input: 'Â£',
        result: 'Â£'
      },
      formatting: {
        currencyFormat: 'symbol' as const,
        decimalPlaces: 2,
        useGroupingSeparators: correctAnswer > 1000,
        unitPosition: 'before' as const
      }
    };

    return {
      ...baseDefinition,
      parameters,
      questionContent: {
        fullText: questionText,
        components: undefined,
        templateData: {
          character: scenario.characters?.[0]?.name || 'Student',
          operation: this.describeOperation(mathOutput),
          presentedAnswer: String(presentedAnswer),
          correctAnswer: String(correctAnswer)
        }
      },
      solution: {
        correctAnswer: {
          value: correctAnswer,  // Return the actual numeric answer
          displayText: this.formatValue(correctAnswer, 'Â£'),
          units: 'Â£'
        },
        distractors,
        workingSteps: this.generateTrueFalseSteps(mathOutput, presentedAnswer, correctAnswer, statementIsTrue),
        explanation: statementIsTrue
          ? `The calculation is correct: ${presentedAnswer}`
          : `The calculation is incorrect. The correct answer is ${correctAnswer}, not ${presentedAnswer}`
      }
    } as QuestionDefinition;
  }

  /**
   * Generate check work validation question
   */
  private async generateCheckWorkQuestion(
    mathOutput: any,
    scenario: any,
    validationParams: ValidationParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.VALIDATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    const correctAnswer = mathOutput.result || mathOutput.answer || mathOutput.value;

    // Generate working steps (some may contain errors)
    const workingSteps = this.generateWorkingSteps(mathOutput, validationParams.errorType);
    const hasError = validationParams.errorType !== 'none';

    const questionText = this.generateCheckWorkQuestionText(scenario, mathOutput, workingSteps);

    const distractors = await this.generateCheckWorkDistractors(hasError);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        validationParams,
        workingSteps,
        hasError,
        correctAnswer
      },
      solution: {
        correctAnswer: {
          value: correctAnswer,  // Return the actual numeric answer
          displayText: this.formatValue(correctAnswer, 'Â£'),
          units: 'Â£'
        },
        distractors,
        workingSteps: this.generateCheckWorkExplanation(workingSteps, hasError, correctAnswer),
        explanation: hasError
          ? `The working contains an error. The correct answer should be ${correctAnswer}`
          : `The working is correct and gives the right answer: ${correctAnswer}`
      }
    } as QuestionDefinition;
  }

  /**
   * Generate spot error validation question
   */
  private async generateSpotErrorQuestion(
    mathOutput: any,
    scenario: any,
    validationParams: ValidationParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.VALIDATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    const correctAnswer = mathOutput.result || mathOutput.answer || mathOutput.value;

    // Generate working with deliberate error
    const { workingSteps, errorStep } = this.generateWorkingWithError(mathOutput, validationParams.errorType || 'procedural');

    const questionText = this.generateSpotErrorQuestionText(scenario, mathOutput, workingSteps);

    const distractors = await this.generateSpotErrorDistractors(workingSteps.length, errorStep);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        validationParams,
        workingSteps,
        errorStep,
        correctAnswer
      },
      solution: {
        correctAnswer: {
          value: `Step ${errorStep + 1}`,
          displayText: `Step ${errorStep + 1}`,
          units: ''
        },
        distractors,
        workingSteps: [`The error is in step ${errorStep + 1}`, `Correct answer: ${correctAnswer}`],
        explanation: `The error occurs in step ${errorStep + 1}. The correct calculation gives ${correctAnswer}`
      }
    } as QuestionDefinition;
  }

  /**
   * Generate verify answer validation question
   */
  private async generateVerifyAnswerQuestion(
    mathOutput: any,
    scenario: any,
    validationParams: ValidationParams,
    params: GenerationParams
  ): Promise<QuestionDefinition> {

    const baseDefinition = this.createBaseQuestionDefinition(
      QuestionFormat.VALIDATION,
      params.mathModel,
      params.difficulty,
      scenario
    );

    const correctAnswer = mathOutput.result || mathOutput.answer || mathOutput.value;

    // Present multiple possible answers, student must choose correct one
    const answerOptions = this.generateAnswerOptions(correctAnswer, mathOutput);

    const questionText = this.generateVerifyAnswerQuestionText(scenario, mathOutput, answerOptions);

    const distractors = await this.generateVerifyAnswerDistractors(answerOptions, correctAnswer);

    return {
      ...baseDefinition,
      parameters: {
        mathValues: mathOutput,
        validationParams,
        answerOptions,
        correctAnswer
      },
      solution: {
        correctAnswer,
        distractors,
        workingSteps: this.generateVerificationSteps(mathOutput, correctAnswer),
        explanation: `The correct answer is ${correctAnswer}`
      }
    } as QuestionDefinition;
  }

  /**
   * Determine validation parameters based on context
   */
  private determineValidationParams(mathModel: string, mathOutput: any, difficulty: any): ValidationParams {
    // Choose validation type based on difficulty and model
    if (difficulty.year <= 2) {
      return {
        validationType: 'true_false',
        errorType: 'computational',
        showWorking: false
      };
    }

    if (difficulty.year <= 4) {
      return {
        validationType: Math.random() > 0.5 ? 'check_work' : 'verify_answer',
        errorType: Math.random() > 0.5 ? 'procedural' : 'computational',
        showWorking: true
      };
    }

    // Higher years get more complex validation tasks
    const types: ValidationParams['validationType'][] = ['check_work', 'spot_error', 'verify_answer'];
    const errors: ValidationParams['errorType'][] = ['computational', 'conceptual', 'procedural'];

    return {
      validationType: types[Math.floor(Math.random() * types.length)],
      errorType: errors[Math.floor(Math.random() * errors.length)],
      showWorking: true,
      includeExplanation: true
    };
  }

  /**
   * Generate plausible incorrect answer
   */
  private generatePlausibleIncorrectAnswer(mathOutput: any, errorType: string): number {
    const correct = mathOutput.result || mathOutput.answer || mathOutput.value;

    switch (errorType) {
      case 'computational':
        // Off by one calculation errors
        return correct + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 5) + 1);

      case 'procedural':
        // Wrong operation errors
        if (mathOutput.operation === 'ADDITION') {
          return mathOutput.operand_1 - mathOutput.operand_2; // Subtracted instead
        }
        if (mathOutput.operation === 'SUBTRACTION') {
          return mathOutput.operand_1 + mathOutput.operand_2; // Added instead
        }
        if (mathOutput.operation === 'MULTIPLICATION') {
          return mathOutput.operand_1 + mathOutput.operand_2; // Added instead
        }
        break;

      case 'conceptual':
        // Magnitude errors
        return correct * (Math.random() > 0.5 ? 10 : 0.1);

      default:
        return correct + Math.floor(Math.random() * 10) - 5;
    }

    return correct + Math.floor(Math.random() * 10) - 5;
  }

  /**
   * Generate working steps with potential errors
   */
  private generateWorkingSteps(mathOutput: any, errorType?: string): string[] {
    const steps = [];

    switch (mathOutput.operation) {
      case 'ADDITION':
        steps.push(`${mathOutput.operand_1} + ${mathOutput.operand_2}${mathOutput.operand_3 ? ' + ' + mathOutput.operand_3 : ''}`);
        if (errorType && errorType !== 'none') {
          const wrongAddResult = this.generatePlausibleIncorrectAnswer(mathOutput, errorType);
          steps.push(`= ${wrongAddResult}`);
        } else {
          steps.push(`= ${mathOutput.result}`);
        }
        break;

      case 'SUBTRACTION':
        steps.push(`${mathOutput.operand_1} - ${mathOutput.operand_2}`);
        if (errorType && errorType !== 'none') {
          const wrongSubResult = this.generatePlausibleIncorrectAnswer(mathOutput, errorType);
          steps.push(`= ${wrongSubResult}`);
        } else {
          steps.push(`= ${mathOutput.result}`);
        }
        break;

      case 'MULTIPLICATION':
        steps.push(`${mathOutput.operand_1} Ã ${mathOutput.operand_2}`);
        if (errorType && errorType !== 'none') {
          const wrongMulResult = this.generatePlausibleIncorrectAnswer(mathOutput, errorType);
          steps.push(`= ${wrongMulResult}`);
        } else {
          steps.push(`= ${mathOutput.result}`);
        }
        break;

      case 'DIVISION':
        steps.push(`${mathOutput.operand_1} Ã· ${mathOutput.operand_2}`);
        if (errorType && errorType !== 'none') {
          const wrongDivResult = this.generatePlausibleIncorrectAnswer(mathOutput, errorType);
          steps.push(`= ${wrongDivResult}`);
        } else {
          steps.push(`= ${mathOutput.result}`);
        }
        break;

      default:
        steps.push(`Calculation: ${mathOutput.result || 'unknown'}`);
    }

    return steps;
  }

  /**
   * Generate working steps with deliberate error in specific step
   */
  private generateWorkingWithError(mathOutput: any, errorType: string): { workingSteps: string[], errorStep: number } {
    const steps = [];
    let errorStep = -1;

    switch (mathOutput.operation) {
      case 'ADDITION':
        steps.push(`Step 1: ${mathOutput.operand_1} + ${mathOutput.operand_2}${mathOutput.operand_3 ? ' + ' + mathOutput.operand_3 : ''}`);

        // Introduce error in calculation step
        errorStep = 1;
        const wrongCalcResult = this.generatePlausibleIncorrectAnswer(mathOutput, errorType);
        steps.push(`Step 2: = ${wrongCalcResult}`);
        break;

      case 'MULTIPLICATION':
        steps.push(`Step 1: ${mathOutput.operand_1} Ã ${mathOutput.operand_2}`);

        // Could add intermediate step with error
        if (mathOutput.operand_1 > 10 && mathOutput.operand_2 > 10) {
          steps.push(`Step 2: Break down: ${mathOutput.operand_1} Ã ${mathOutput.operand_2}`);
          errorStep = 2;
          const wrongBreakdownResult = this.generatePlausibleIncorrectAnswer(mathOutput, errorType);
          steps.push(`Step 3: = ${wrongBreakdownResult}`);
        } else {
          errorStep = 1;
          const wrongMultResult = this.generatePlausibleIncorrectAnswer(mathOutput, errorType);
          steps.push(`Step 2: = ${wrongMultResult}`);
        }
        break;

      default:
        steps.push(`Step 1: Calculate ${mathOutput.operation}`);
        errorStep = 1;
        const wrongDefaultResult = this.generatePlausibleIncorrectAnswer(mathOutput, errorType);
        steps.push(`Step 2: = ${wrongDefaultResult}`);
    }

    return { workingSteps: steps, errorStep };
  }

  /**
   * Generate multiple answer options for verification
   */
  private generateAnswerOptions(correctAnswer: number, mathOutput: any): number[] {
    const options = [correctAnswer];

    // Add plausible distractors
    options.push(this.generatePlausibleIncorrectAnswer(mathOutput, 'computational'));
    options.push(this.generatePlausibleIncorrectAnswer(mathOutput, 'procedural'));
    options.push(this.generatePlausibleIncorrectAnswer(mathOutput, 'conceptual'));

    // Shuffle options
    return options.sort(() => Math.random() - 0.5).slice(0, 4);
  }

  // Question text generation methods
  private generateTrueFalseQuestionText(scenario: any, mathOutput: any, presentedAnswer: number): string {
    const operation = this.describeOperation(mathOutput);
    return `${scenario.characters[0].name} says "${operation} equals ${presentedAnswer}." Is this correct? (True/False)`;
  }

  private generateCheckWorkQuestionText(scenario: any, mathOutput: any, workingSteps: string[]): string {
    const workingText = workingSteps.join('\\n');
    return `${scenario.characters[0].name} showed their working:\\n${workingText}\\n\\nIs this working correct?`;
  }

  private generateSpotErrorQuestionText(scenario: any, mathOutput: any, workingSteps: string[]): string {
    const workingText = workingSteps.join('\\n');
    return `${scenario.characters[0].name} made an error in their calculation:\\n${workingText}\\n\\nWhich step contains the error?`;
  }

  private generateVerifyAnswerQuestionText(scenario: any, mathOutput: any, answerOptions: number[]): string {
    const operation = this.describeOperation(mathOutput);
    const optionsText = answerOptions.map((opt, i) => `${String.fromCharCode(65 + i)}) ${opt}`).join('  ');
    return `${scenario.characters[0].name} needs to solve: ${operation}\\n\\nWhich answer is correct?\\n${optionsText}`;
  }

  private describeOperation(mathOutput: any): string {
    switch (mathOutput.operation) {
      case 'ADDITION':
        return `${mathOutput.operand_1} + ${mathOutput.operand_2}${mathOutput.operand_3 ? ' + ' + mathOutput.operand_3 : ''}`;
      case 'SUBTRACTION':
        return `${mathOutput.operand_1} - ${mathOutput.operand_2}`;
      case 'MULTIPLICATION':
        return `${mathOutput.operand_1} Ã ${mathOutput.operand_2}`;
      case 'DIVISION':
        return `${mathOutput.operand_1} Ã· ${mathOutput.operand_2}`;
      default:
        return `a calculation`;
    }
  }

  // Distractor generation methods
  private async generateTrueFalseDistractors(correctAnswer: boolean): Promise<any[]> {
    return [
      {
        value: !correctAnswer,
        strategy: DistractorStrategy.LOGICAL_OPPOSITE,
        rationale: correctAnswer ? 'Incorrectly identified as false' : 'Incorrectly identified as true'
      }
    ];
  }

  private async generateCheckWorkDistractors(isCorrect: boolean): Promise<any[]> {
    return [
      {
        value: isCorrect ? 'Incorrect' : 'Correct',
        strategy: DistractorStrategy.LOGICAL_OPPOSITE,
        rationale: isCorrect ? 'Incorrectly identified correct work as wrong' : 'Incorrectly identified wrong work as correct'
      }
    ];
  }

  private async generateSpotErrorDistractors(totalSteps: number, errorStep: number): Promise<any[]> {
    const distractors = [];

    // Wrong steps
    for (let i = 0; i < totalSteps; i++) {
      if (i !== errorStep) {
        distractors.push({
          value: `Step ${i + 1}`,
          strategy: DistractorStrategy.CLOSE_BUT_WRONG,
          rationale: `Incorrectly identified step ${i + 1} as containing the error`
        });
      }
    }

    return distractors.slice(0, 3);
  }

  private async generateVerifyAnswerDistractors(answerOptions: number[], correctAnswer: number): Promise<any[]> {
    return answerOptions
      .filter(opt => opt !== correctAnswer)
      .map(opt => ({
        value: opt,
        strategy: DistractorStrategy.CALCULATION_ERROR,
        rationale: 'Common calculation error'
      }))
      .slice(0, 3);
  }

  private generateTrueFalseSteps(mathOutput: any, presentedAnswer: number, correctAnswer: number, isTrue: boolean): string[] {
    if (isTrue) {
      return [
        `Calculate: ${this.describeOperation(mathOutput)}`,
        `Result: ${correctAnswer}`,
        `Statement claims: ${presentedAnswer}`,
        `Since ${correctAnswer} = ${presentedAnswer}, the statement is TRUE`
      ];
    } else {
      return [
        `Calculate: ${this.describeOperation(mathOutput)}`,
        `Correct result: ${correctAnswer}`,
        `Statement claims: ${presentedAnswer}`,
        `Since ${correctAnswer} â  ${presentedAnswer}, the statement is FALSE`
      ];
    }
  }

  private generateCheckWorkExplanation(workingSteps: string[], hasError: boolean, correctAnswer: number): string[] {
    if (hasError) {
      return [
        'Check each step of the working',
        'Error found in calculation',
        `Correct answer should be: ${correctAnswer}`
      ];
    } else {
      return [
        'Check each step of the working',
        'All steps are correct',
        `Final answer ${correctAnswer} is correct`
      ];
    }
  }

  private generateVerificationSteps(mathOutput: any, correctAnswer: number): string[] {
    return [
      `Calculate: ${this.describeOperation(mathOutput)}`,
      `Apply correct operation and order`,
      `Result: ${correctAnswer}`
    ];
  }
}
```
--- END FILE: lib\controllers\validation.controller.ts ---

--- START FILE: lib\curriculum\curated-mappings.ts ---
```typescript
/**
 * Curated Model-Curriculum Mappings System
 * Manages user-defined mappings between mathematical models and curriculum areas
 */

import { MODEL_STATUS_REGISTRY } from '@/lib/models/model-status';
import { CurriculumFilter } from './curriculum-parser';

/**
 * Curated mapping between a curriculum area and mathematical models
 */
export interface CuratedMapping {
  id: string;
  createdAt: Date;
  updatedAt: Date;

  // Curriculum specification
  strand: string;
  substrand: string;
  year: number;

  // Curated model selections
  primaryModel: string; // The best model for this curriculum area
  secondaryModels: string[]; // Alternative models that also work well
  excludedModels: string[]; // Models that should not be used

  // Metadata
  confidence: 'low' | 'medium' | 'high'; // Confidence in this mapping
  notes?: string; // Notes about why these models were chosen
  testedCount: number; // How many tests informed this mapping
  averageRating: number | null; // Average rating from tests

  // Status
  status: 'draft' | 'approved' | 'needs_review';
  approvedBy?: string;
  approvedAt?: Date;
}

/**
 * Mapping matrix for visualization
 */
export interface MappingMatrix {
  strands: string[];
  substrands: string[];
  years: number[];
  models: string[];

  // 4D matrix: [strand][substrand][year][model] = mapping status
  matrix: Record<string, Record<string, Record<number, Record<string, MappingStatus>>>>;
}

/**
 * Status of a specific model-curriculum combination
 */
export interface MappingStatus {
  isPrimary: boolean;
  isSecondary: boolean;
  isExcluded: boolean;
  isSuggested: boolean; // From automatic suggestions
  testedCount: number;
  averageRating: number | null;
  confidence?: 'low' | 'medium' | 'high';
}

/**
 * Manages curated model-curriculum mappings
 */
export class CuratedMappingsManager {
  private mappings: CuratedMapping[] = [];
  private readonly storageKey = 'curated_curriculum_mappings';

  constructor() {
    this.loadFromStorage();
  }

  /**
   * Create or update a curated mapping
   */
  upsertMapping(
    strand: string,
    substrand: string,
    year: number,
    updates: Partial<Omit<CuratedMapping, 'id' | 'strand' | 'substrand' | 'year' | 'createdAt' | 'updatedAt'>>
  ): CuratedMapping {
    const existing = this.getMapping(strand, substrand, year);

    if (existing) {
      // Update existing mapping
      Object.assign(existing, {
        ...updates,
        updatedAt: new Date()
      });
      this.saveToStorage();
      return existing;
    } else {
      // Create new mapping
      const newMapping: CuratedMapping = {
        id: this.generateId(),
        createdAt: new Date(),
        updatedAt: new Date(),
        strand,
        substrand,
        year,
        primaryModel: updates.primaryModel || '',
        secondaryModels: updates.secondaryModels || [],
        excludedModels: updates.excludedModels || [],
        confidence: updates.confidence || 'low',
        notes: updates.notes,
        testedCount: updates.testedCount || 0,
        averageRating: updates.averageRating || null,
        status: updates.status || 'draft',
        approvedBy: updates.approvedBy,
        approvedAt: updates.approvedAt
      };

      this.mappings.push(newMapping);
      this.saveToStorage();
      return newMapping;
    }
  }

  /**
   * Get a specific mapping
   */
  getMapping(strand: string, substrand: string, year: number): CuratedMapping | undefined {
    return this.mappings.find(
      m => m.strand === strand && m.substrand === substrand && m.year === year
    );
  }

  /**
   * Get all mappings
   */
  getAllMappings(): CuratedMapping[] {
    return this.mappings;
  }

  /**
   * Get suggested models for a curriculum area
   * Combines curated mappings with automatic suggestions
   */
  getSuggestedModels(filter: CurriculumFilter): {
    primary: string | null;
    secondary: string[];
    excluded: string[];
    automatic: string[];
  } {
    const curated = this.getMapping(filter.strand, filter.substrand, filter.year);
    const automatic = this.getAutomaticSuggestions(filter);

    if (curated && curated.status === 'approved') {
      // Use curated mapping if approved
      return {
        primary: curated.primaryModel,
        secondary: curated.secondaryModels,
        excluded: curated.excludedModels,
        automatic: automatic.filter(m =>
          m !== curated.primaryModel &&
          !curated.secondaryModels.includes(m) &&
          !curated.excludedModels.includes(m)
        )
      };
    } else if (curated) {
      // Use curated mapping (draft/review) but include automatic suggestions
      return {
        primary: curated.primaryModel || automatic[0] || null,
        secondary: curated.secondaryModels,
        excluded: curated.excludedModels,
        automatic
      };
    } else {
      // No curated mapping, use automatic suggestions only
      return {
        primary: automatic[0] || null,
        secondary: automatic.slice(1),
        excluded: [],
        automatic
      };
    }
  }

  /**
   * Generate automatic model suggestions (internal implementation)
   */
  private getAutomaticSuggestions(filter: CurriculumFilter): string[] {
    const { strand, substrand, year, description } = filter;
    const suggestedModels: Set<string> = new Set();

    // Direct mapping based on strand and substrand patterns
    const mappings = this.getDirectMappings();

    // Find matching mappings
    mappings.forEach(mapping => {
      if (this.matchesMapping(mapping, strand, substrand, year)) {
        mapping.models.forEach(model => suggestedModels.add(model));
      }
    });

    // Keyword-based mapping from description
    const keywordModels = this.getModelsByKeywords(description, year);
    keywordModels.forEach(model => suggestedModels.add(model));

    // Filter by year appropriateness and model availability
    return Array.from(suggestedModels).filter(modelId => {
      const modelInfo = MODEL_STATUS_REGISTRY[modelId];
      return modelInfo && modelInfo.supportedYears.includes(year);
    });
  }

  /**
   * Direct mappings between curriculum areas and models
   */
  private getDirectMappings(): Array<{
    strand?: string;
    substrand?: string;
    yearRange?: [number, number];
    models: string[];
  }> {
    return [
      // Number and place value
      {
        strand: 'Number and place value',
        substrand: 'counting (in multiples)',
        yearRange: [1, 6],
        models: ['COUNTING', 'ADDITION', 'MULTIPLICATION']
      },
      {
        strand: 'Number and place value',
        substrand: 'read, write, order and compare numbers',
        yearRange: [1, 6],
        models: ['COMPARISON', 'ADDITION', 'SUBTRACTION']
      },

      // Addition, subtraction, multiplication and division
      {
        strand: 'Addition, subtraction, multiplication and division (calculations)',
        substrand: 'add / subtract mentally',
        models: ['ADDITION', 'SUBTRACTION']
      },
      {
        strand: 'Addition, subtraction, multiplication and division (calculations)',
        substrand: 'add / subtract using written methods',
        models: ['ADDITION', 'SUBTRACTION', 'MULTI_STEP']
      },
      {
        strand: 'Addition, subtraction, multiplication and division (calculations)',
        substrand: 'multiply / divide mentally',
        models: ['MULTIPLICATION', 'DIVISION']
      },
      {
        strand: 'Addition, subtraction, multiplication and division (calculations)',
        substrand: 'multiply / divide using written methods',
        models: ['MULTIPLICATION', 'DIVISION', 'MULTI_STEP']
      },

      // Fractions
      {
        strand: 'Fractions (including decimals and percentages)',
        substrand: 'fractions',
        models: ['FRACTION', 'MONEY_FRACTIONS']
      },
      {
        strand: 'Fractions (including decimals and percentages)',
        substrand: 'decimals',
        models: ['CONVERSION', 'MIXED_MONEY_UNITS', 'PERCENTAGE']
      },
      {
        strand: 'Fractions (including decimals and percentages)',
        substrand: 'percentages',
        models: ['PERCENTAGE', 'MONEY_SCALING']
      },

      // Measurement - Money
      {
        strand: 'Measurement',
        substrand: 'money',
        models: ['COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS', 'MIXED_MONEY_UNITS', 'MONEY_FRACTIONS', 'MONEY_SCALING']
      },

      // Measurement - Other
      {
        strand: 'Measurement',
        substrand: 'solve problems (a, money; b, length; c, mass / weight; d, capacity / volume)',
        models: ['CHANGE_CALCULATION', 'CONVERSION', 'MULTI_STEP', 'COMPARISON']
      },

      // Ratio and proportion
      {
        strand: 'Ratio and proportion',
        models: ['UNIT_RATE', 'MONEY_SCALING', 'COMPARISON']
      },

      // Algebra
      {
        strand: 'Algebra',
        models: ['LINEAR_EQUATION', 'MULTI_STEP']
      }
    ];
  }

  /**
   * Get models based on keywords in curriculum description
   */
  private getModelsByKeywords(description: string, year: number): string[] {
    const lowerDesc = description.toLowerCase();
    const models: string[] = [];

    // Keywords mapping
    const keywordMappings = [
      { keywords: ['add', 'adding', 'addition', 'sum', 'total', 'altogether'], models: ['ADDITION'] },
      { keywords: ['subtract', 'subtraction', 'minus', 'take away', 'difference'], models: ['SUBTRACTION'] },
      { keywords: ['multiply', 'multiplication', 'times', 'groups of'], models: ['MULTIPLICATION'] },
      { keywords: ['divide', 'division', 'share', 'sharing', 'split'], models: ['DIVISION'] },
      { keywords: ['fraction', 'half', 'quarter', 'third'], models: ['FRACTION', 'MONEY_FRACTIONS'] },
      { keywords: ['percent', 'percentage', '%'], models: ['PERCENTAGE'] },
      { keywords: ['money', 'pounds', 'pence', 'coin', 'note', 'change'], models: ['COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS'] },
      { keywords: ['count', 'counting'], models: ['COUNTING'] },
      { keywords: ['compare', 'order', 'greater', 'less', 'equal'], models: ['COMPARISON'] },
      { keywords: ['measure', 'measurement', 'convert'], models: ['CONVERSION'] },
      { keywords: ['time', 'rate'], models: ['TIME_RATE'] },
      { keywords: ['problem', 'solve'], models: ['MULTI_STEP'] }
    ];

    keywordMappings.forEach(mapping => {
      if (mapping.keywords.some(keyword => lowerDesc.includes(keyword))) {
        mapping.models.forEach(model => {
          const modelInfo = MODEL_STATUS_REGISTRY[model];
          if (modelInfo && modelInfo.supportedYears.includes(year)) {
            models.push(model);
          }
        });
      }
    });

    return [...new Set(models)];
  }

  /**
   * Check if a mapping matches the given criteria
   */
  private matchesMapping(
    mapping: { strand?: string; substrand?: string; yearRange?: [number, number] },
    strand: string,
    substrand: string,
    year: number
  ): boolean {
    // Check strand match
    if (mapping.strand && !strand.toLowerCase().includes(mapping.strand.toLowerCase())) {
      return false;
    }

    // Check substrand match
    if (mapping.substrand && !substrand.toLowerCase().includes(mapping.substrand.toLowerCase())) {
      return false;
    }

    // Check year range
    if (mapping.yearRange) {
      const [minYear, maxYear] = mapping.yearRange;
      if (year < minYear || year > maxYear) {
        return false;
      }
    }

    return true;
  }

  /**
   * Build mapping matrix for visualization
   */
  buildMappingMatrix(
    strands: string[],
    substrands: string[],
    years: number[],
    models: string[]
  ): MappingMatrix {
    const matrix: MappingMatrix['matrix'] = {};

    strands.forEach(strand => {
      matrix[strand] = {};
      substrands.forEach(substrand => {
        matrix[strand][substrand] = {};
        years.forEach(year => {
          matrix[strand][substrand][year] = {};

          // Get curated mapping if exists
          const curated = this.getMapping(strand, substrand, year);

          // Get automatic suggestions
          const automatic = this.getAutomaticSuggestions({
            strand,
            substrand,
            year,
            description: `${strand} - ${substrand}`
          });

          models.forEach(modelId => {
            const status: MappingStatus = {
              isPrimary: curated?.primaryModel === modelId,
              isSecondary: curated?.secondaryModels.includes(modelId) || false,
              isExcluded: curated?.excludedModels.includes(modelId) || false,
              isSuggested: automatic.includes(modelId),
              testedCount: 0, // Will be populated from test tracker
              averageRating: null,
              confidence: curated?.confidence
            };

            matrix[strand][substrand][year][modelId] = status;
          });
        });
      });
    });

    return {
      strands,
      substrands,
      years,
      models,
      matrix
    };
  }

  /**
   * Approve a mapping
   */
  approveMapping(mappingId: string, approvedBy: string): void {
    const mapping = this.mappings.find(m => m.id === mappingId);
    if (mapping) {
      mapping.status = 'approved';
      mapping.approvedBy = approvedBy;
      mapping.approvedAt = new Date();
      mapping.updatedAt = new Date();
      this.saveToStorage();
    }
  }

  /**
   * Mark mapping for review
   */
  markForReview(mappingId: string): void {
    const mapping = this.mappings.find(m => m.id === mappingId);
    if (mapping) {
      mapping.status = 'needs_review';
      mapping.updatedAt = new Date();
      this.saveToStorage();
    }
  }

  /**
   * Batch update model assignments
   */
  batchUpdateModels(
    updates: Array<{
      strand: string;
      substrand: string;
      year: number;
      modelId: string;
      role: 'primary' | 'secondary' | 'excluded' | 'none';
    }>
  ): void {
    updates.forEach(update => {
      const mapping = this.getMapping(update.strand, update.substrand, update.year);

      if (!mapping) {
        // Create new mapping if doesn't exist
        if (update.role !== 'none') {
          this.upsertMapping(update.strand, update.substrand, update.year, {
            primaryModel: update.role === 'primary' ? update.modelId : '',
            secondaryModels: update.role === 'secondary' ? [update.modelId] : [],
            excludedModels: update.role === 'excluded' ? [update.modelId] : []
          });
        }
      } else {
        // Update existing mapping
        // Remove model from all lists first
        if (mapping.primaryModel === update.modelId) {
          mapping.primaryModel = '';
        }
        mapping.secondaryModels = mapping.secondaryModels.filter(m => m !== update.modelId);
        mapping.excludedModels = mapping.excludedModels.filter(m => m !== update.modelId);

        // Add to appropriate list
        switch (update.role) {
          case 'primary':
            mapping.primaryModel = update.modelId;
            break;
          case 'secondary':
            mapping.secondaryModels.push(update.modelId);
            break;
          case 'excluded':
            mapping.excludedModels.push(update.modelId);
            break;
        }

        mapping.updatedAt = new Date();
      }
    });

    this.saveToStorage();
  }

  /**
   * Get statistics about curated mappings
   */
  getStatistics(): {
    totalMappings: number;
    approvedMappings: number;
    draftMappings: number;
    needsReviewMappings: number;
    highConfidenceMappings: number;
    coverageByYear: Record<number, number>;
    coverageByStrand: Record<string, number>;
  } {
    const stats = {
      totalMappings: this.mappings.length,
      approvedMappings: this.mappings.filter(m => m.status === 'approved').length,
      draftMappings: this.mappings.filter(m => m.status === 'draft').length,
      needsReviewMappings: this.mappings.filter(m => m.status === 'needs_review').length,
      highConfidenceMappings: this.mappings.filter(m => m.confidence === 'high').length,
      coverageByYear: {} as Record<number, number>,
      coverageByStrand: {} as Record<string, number>
    };

    // Calculate coverage by year
    this.mappings.forEach(mapping => {
      if (!stats.coverageByYear[mapping.year]) {
        stats.coverageByYear[mapping.year] = 0;
      }
      stats.coverageByYear[mapping.year]++;

      if (!stats.coverageByStrand[mapping.strand]) {
        stats.coverageByStrand[mapping.strand] = 0;
      }
      stats.coverageByStrand[mapping.strand]++;
    });

    return stats;
  }

  /**
   * Export mappings as JSON
   */
  exportMappings(): string {
    return JSON.stringify(this.mappings, null, 2);
  }

  /**
   * Import mappings from JSON
   */
  importMappings(jsonData: string): void {
    try {
      const imported = JSON.parse(jsonData);
      if (Array.isArray(imported)) {
        // Convert date strings back to Date objects
        const mappings = imported.map(m => ({
          ...m,
          createdAt: new Date(m.createdAt),
          updatedAt: new Date(m.updatedAt),
          approvedAt: m.approvedAt ? new Date(m.approvedAt) : undefined
        }));
        this.mappings = mappings;
        this.saveToStorage();
      }
    } catch (error) {
      console.error('Failed to import mappings:', error);
      throw new Error('Invalid mappings format');
    }
  }

  /**
   * Clear all mappings (with confirmation)
   */
  clearAllMappings(): void {
    this.mappings = [];
    this.saveToStorage();
  }

  /**
   * Generate unique ID
   */
  private generateId(): string {
    return `map_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  /**
   * Load from local storage
   */
  private loadFromStorage(): void {
    if (typeof window === 'undefined') return;

    try {
      const stored = localStorage.getItem(this.storageKey);
      if (stored) {
        const parsed = JSON.parse(stored);
        // Convert date strings back to Date objects
        this.mappings = parsed.map((m: any) => ({
          ...m,
          createdAt: new Date(m.createdAt),
          updatedAt: new Date(m.updatedAt),
          approvedAt: m.approvedAt ? new Date(m.approvedAt) : undefined
        }));
      }
    } catch (error) {
      console.error('Failed to load curated mappings:', error);
      this.mappings = [];
    }
  }

  /**
   * Save to local storage
   */
  private saveToStorage(): void {
    if (typeof window === 'undefined') return;

    try {
      localStorage.setItem(this.storageKey, JSON.stringify(this.mappings));
    } catch (error) {
      console.error('Failed to save curated mappings:', error);
    }
  }
}

// Singleton instance
export const curatedMappingsManager = new CuratedMappingsManager();
```
--- END FILE: lib\curriculum\curated-mappings.ts ---

--- START FILE: lib\curriculum\curriculum-model-mapping.ts ---
```typescript
import { CurriculumFilter } from './curriculum-parser';
import { MODEL_STATUS_REGISTRY } from '../models/model-status';
import { curatedMappingsManager } from './curated-mappings';

/**
 * Maps curriculum areas to appropriate mathematical models
 */
export interface CurriculumModelMapping {
  strand: string;
  substrand: string;
  year: number;
  suggestedModels: string[];
  primaryModel?: string; // Most relevant model for this curriculum area
}

/**
 * Intelligent mapping between curriculum requirements and mathematical models
 */
class CurriculumModelMapper {
  
  /**
   * Get suggested models for a specific curriculum filter
   * Now integrates with curated mappings when available
   */
  getSuggestedModels(filter: CurriculumFilter): string[] {
    const { strand, substrand, year, description } = filter;

    // First check for curated mappings (takes priority)
    const curated = curatedMappingsManager.getSuggestedModels(filter);
    if (curated.primary || curated.secondary.length > 0) {
      // Return curated suggestions, excluding excluded models
      const suggested: string[] = [];
      if (curated.primary) suggested.push(curated.primary);
      suggested.push(...curated.secondary);

      // Add automatic suggestions that aren't excluded
      const automaticFiltered = curated.automatic.filter(
        model => !curated.excluded.includes(model)
      );
      suggested.push(...automaticFiltered);

      return [...new Set(suggested)];
    }

    // Fall back to automatic mapping if no curated mapping
    return this.getAutomaticSuggestions(filter);
  }

  /**
   * Get automatic model suggestions (legacy behavior)
   */
  getAutomaticSuggestions(filter: CurriculumFilter): string[] {
    const { strand, substrand, year, description } = filter;
    const suggestedModels: Set<string> = new Set();

    // Direct mapping based on strand and substrand patterns
    const mappings = this.getDirectMappings();

    // Find matching mappings
    mappings.forEach(mapping => {
      if (this.matchesMapping(mapping, strand, substrand, year)) {
        mapping.models.forEach(model => suggestedModels.add(model));
      }
    });

    // Keyword-based mapping from description
    const keywordModels = this.getModelsByKeywords(description, year);
    keywordModels.forEach(model => suggestedModels.add(model));

    // Filter by year appropriateness and model availability
    return Array.from(suggestedModels).filter(modelId => {
      const modelInfo = MODEL_STATUS_REGISTRY[modelId];
      return modelInfo && modelInfo.supportedYears.includes(year);
    });
  }

  /**
   * Get the primary (most relevant) model for a curriculum area
   * Now integrates with curated mappings when available
   */
  getPrimaryModel(filter: CurriculumFilter): string | null {
    // First check for curated primary model
    const curated = curatedMappingsManager.getSuggestedModels(filter);
    if (curated.primary) {
      return curated.primary;
    }

    // Fall back to automatic suggestion logic
    const suggested = this.getSuggestedModels(filter);
    if (suggested.length === 0) return null;

    // Priority order for primary model selection
    const priorityOrder = [
      'ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION',
      'COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS',
      'FRACTION', 'PERCENTAGE', 'COUNTING', 'TIME_RATE',
      'CONVERSION', 'COMPARISON', 'MIXED_MONEY_UNITS',
      'MONEY_FRACTIONS', 'MONEY_SCALING', 'MULTI_STEP',
      'LINEAR_EQUATION', 'UNIT_RATE'
    ];

    // Return first match from priority order
    for (const modelId of priorityOrder) {
      if (suggested.includes(modelId)) {
        return modelId;
      }
    }

    return suggested[0];
  }

  /**
   * Direct mappings between curriculum areas and models
   */
  private getDirectMappings(): Array<{
    strand?: string;
    substrand?: string;
    yearRange?: [number, number];
    models: string[];
  }> {
    return [
      // Number and place value
      {
        strand: 'Number and place value',
        substrand: 'counting (in multiples)',
        yearRange: [1, 6],
        models: ['COUNTING', 'ADDITION', 'MULTIPLICATION']
      },
      {
        strand: 'Number and place value',
        substrand: 'read, write, order and compare numbers',
        yearRange: [1, 6],
        models: ['COMPARISON', 'ADDITION', 'SUBTRACTION']
      },

      // Addition, subtraction, multiplication and division
      {
        strand: 'Addition, subtraction, multiplication and division (calculations)',
        substrand: 'add / subtract mentally',
        models: ['ADDITION', 'SUBTRACTION']
      },
      {
        strand: 'Addition, subtraction, multiplication and division (calculations)',
        substrand: 'add / subtract using written methods',
        models: ['ADDITION', 'SUBTRACTION', 'MULTI_STEP']
      },
      {
        strand: 'Addition, subtraction, multiplication and division (calculations)',
        substrand: 'multiply / divide mentally',
        models: ['MULTIPLICATION', 'DIVISION']
      },
      {
        strand: 'Addition, subtraction, multiplication and division (calculations)',
        substrand: 'multiply / divide using written methods',
        models: ['MULTIPLICATION', 'DIVISION', 'MULTI_STEP']
      },

      // Fractions
      {
        strand: 'Fractions (including decimals and percentages)',
        substrand: 'fractions',
        models: ['FRACTION', 'MONEY_FRACTIONS']
      },
      {
        strand: 'Fractions (including decimals and percentages)',
        substrand: 'decimals',
        models: ['CONVERSION', 'MIXED_MONEY_UNITS', 'PERCENTAGE']
      },
      {
        strand: 'Fractions (including decimals and percentages)',
        substrand: 'percentages',
        models: ['PERCENTAGE', 'MONEY_SCALING']
      },

      // Measurement - Money
      {
        strand: 'Measurement',
        substrand: 'money',
        models: ['COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS', 'MIXED_MONEY_UNITS', 'MONEY_FRACTIONS', 'MONEY_SCALING']
      },

      // Measurement - Other
      {
        strand: 'Measurement',
        substrand: 'solve problems (a, money; b, length; c, mass / weight; d, capacity / volume)',
        models: ['CHANGE_CALCULATION', 'CONVERSION', 'MULTI_STEP', 'COMPARISON']
      },

      // Ratio and proportion
      {
        strand: 'Ratio and proportion',
        models: ['UNIT_RATE', 'MONEY_SCALING', 'COMPARISON']
      },

      // Algebra
      {
        strand: 'Algebra',
        models: ['LINEAR_EQUATION', 'MULTI_STEP']
      }
    ];
  }

  /**
   * Get models based on keywords in curriculum description
   */
  private getModelsByKeywords(description: string, year: number): string[] {
    const lowerDesc = description.toLowerCase();
    const models: string[] = [];

    // Keywords mapping
    const keywordMappings = [
      { keywords: ['add', 'adding', 'addition', 'sum', 'total', 'altogether'], models: ['ADDITION'] },
      { keywords: ['subtract', 'subtraction', 'minus', 'take away', 'difference'], models: ['SUBTRACTION'] },
      { keywords: ['multiply', 'multiplication', 'times', 'groups of'], models: ['MULTIPLICATION'] },
      { keywords: ['divide', 'division', 'share', 'sharing', 'split'], models: ['DIVISION'] },
      { keywords: ['fraction', 'half', 'quarter', 'third'], models: ['FRACTION', 'MONEY_FRACTIONS'] },
      { keywords: ['percent', 'percentage', '%'], models: ['PERCENTAGE'] },
      { keywords: ['money', 'pounds', 'pence', 'coin', 'note', 'change'], models: ['COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS'] },
      { keywords: ['count', 'counting'], models: ['COUNTING'] },
      { keywords: ['compare', 'order', 'greater', 'less', 'equal'], models: ['COMPARISON'] },
      { keywords: ['measure', 'measurement', 'convert'], models: ['CONVERSION'] },
      { keywords: ['time', 'rate'], models: ['TIME_RATE'] },
      { keywords: ['problem', 'solve'], models: ['MULTI_STEP'] }
    ];

    keywordMappings.forEach(mapping => {
      if (mapping.keywords.some(keyword => lowerDesc.includes(keyword))) {
        mapping.models.forEach(model => {
          const modelInfo = MODEL_STATUS_REGISTRY[model];
          if (modelInfo && modelInfo.supportedYears.includes(year)) {
            models.push(model);
          }
        });
      }
    });

    return [...new Set(models)];
  }

  /**
   * Check if a mapping matches the given criteria
   */
  private matchesMapping(
    mapping: { strand?: string; substrand?: string; yearRange?: [number, number] },
    strand: string,
    substrand: string,
    year: number
  ): boolean {
    // Check strand match
    if (mapping.strand && !strand.toLowerCase().includes(mapping.strand.toLowerCase())) {
      return false;
    }

    // Check substrand match
    if (mapping.substrand && !substrand.toLowerCase().includes(mapping.substrand.toLowerCase())) {
      return false;
    }

    // Check year range
    if (mapping.yearRange) {
      const [minYear, maxYear] = mapping.yearRange;
      if (year < minYear || year > maxYear) {
        return false;
      }
    }

    return true;
  }

  /**
   * Get all models that could be relevant for a curriculum area
   */
  getAllRelevantModels(strand: string): string[] {
    const relevantModels: Set<string> = new Set();
    
    Object.values(MODEL_STATUS_REGISTRY).forEach(model => {
      if (model.curriculumAreas.some(area => 
        area.toLowerCase().includes(strand.toLowerCase()) ||
        strand.toLowerCase().includes(area.toLowerCase())
      )) {
        relevantModels.add(model.id);
      }
    });

    return Array.from(relevantModels);
  }
}

export const curriculumModelMapper = new CurriculumModelMapper();
```
--- END FILE: lib\curriculum\curriculum-model-mapping.ts ---

--- START FILE: lib\curriculum\curriculum-parser.ts ---
```typescript
// Import curriculum data - adjust path as needed
const curriculumData = require('../../context/national_curriculum_framework.json');

export interface CurriculumEntry {
  Strand: string;
  Substrand: string;
  "Content domain reference": string;
  Years: {
    [yearKey: string]: string;
  };
}

export interface CurriculumFilter {
  strand: string;
  substrand: string;
  year: number;
  description: string;
  contentDomainRef: string;
}

export interface ParsedCurriculum {
  strands: string[];
  substrands: { [strand: string]: string[] };
  yearDescriptions: { [key: string]: string };
}

class CurriculumParser {
  private data: CurriculumEntry[];

  constructor() {
    this.data = curriculumData as CurriculumEntry[];
  }

  /**
   * Get all unique strands
   */
  getStrands(): string[] {
    const strands = [...new Set(this.data.map(item => item.Strand))];
    return strands.sort();
  }

  /**
   * Get all substrands for a given strand
   */
  getSubstrands(strand: string): string[] {
    const substrands = this.data
      .filter(item => item.Strand === strand)
      .map(item => item.Substrand);
    return [...new Set(substrands)].sort();
  }

  /**
   * Get available years for a strand/substrand combination
   */
  getAvailableYears(strand: string, substrand: string): number[] {
    const entry = this.data.find(
      item => item.Strand === strand && item.Substrand === substrand
    );
    
    if (!entry) return [];
    
    const years: number[] = [];
    Object.keys(entry.Years).forEach(yearKey => {
      const yearNum = parseInt(yearKey.replace('Year ', ''));
      if (entry.Years[yearKey].trim() !== '') {
        years.push(yearNum);
      }
    });
    
    return years.sort((a, b) => a - b);
  }

  /**
   * Get curriculum description for specific strand/substrand/year
   */
  getCurriculumDescription(strand: string, substrand: string, year: number): CurriculumFilter | null {
    const entry = this.data.find(
      item => item.Strand === strand && item.Substrand === substrand
    );
    
    if (!entry) return null;
    
    const yearKey = `Year ${year}`;
    const description = entry.Years[yearKey];
    
    if (!description || description.trim() === '') return null;
    
    return {
      strand,
      substrand,
      year,
      description: description.trim(),
      contentDomainRef: entry["Content domain reference"]
    };
  }

  /**
   * Get all curriculum entries for easy browsing
   */
  getAllEntries(): CurriculumEntry[] {
    return this.data;
  }

  /**
   * Search curriculum by keywords
   */
  searchCurriculum(searchTerm: string): CurriculumFilter[] {
    const results: CurriculumFilter[] = [];
    const term = searchTerm.toLowerCase();
    
    this.data.forEach(entry => {
      Object.keys(entry.Years).forEach(yearKey => {
        const description = entry.Years[yearKey];
        if (description.toLowerCase().includes(term)) {
          const year = parseInt(yearKey.replace('Year ', ''));
          results.push({
            strand: entry.Strand,
            substrand: entry.Substrand,
            year,
            description: description.trim(),
            contentDomainRef: entry["Content domain reference"]
          });
        }
      });
    });
    
    return results;
  }

  /**
   * Get related curriculum entries (same strand, different substrands)
   */
  getRelatedEntries(strand: string, currentSubstrand?: string): string[] {
    return this.data
      .filter(item => item.Strand === strand && item.Substrand !== currentSubstrand)
      .map(item => item.Substrand);
  }
}

export const curriculumParser = new CurriculumParser();
```
--- END FILE: lib\curriculum\curriculum-parser.ts ---

--- START FILE: lib\curriculum\test-tracking.ts ---
```typescript
/**
 * Test Tracking System for Model-Curriculum Combinations
 * Tracks testing of each mathematical model against curriculum areas
 */

import { QuestionFormat } from '@/lib/types/question-formats';

/**
 * Represents a single test result for a model-curriculum combination
 */
export interface TestResult {
  id: string;
  timestamp: Date;

  // Curriculum context
  strand: string;
  substrand: string;
  year: number;

  // Model context
  modelId: string;
  questionFormat?: QuestionFormat;

  // Test details
  questionGenerated: string; // The actual question text
  parameters: Record<string, any>; // Parameters used for generation

  // Results and ratings
  success: boolean; // Did generation succeed?
  rating?: 1 | 2 | 3 | 4 | 5; // User's rating of appropriateness
  notes?: string; // User's notes about this combination

  // Performance metrics
  generationTime?: number; // Time to generate in ms
  errorMessage?: string; // If generation failed

  // Session tracking
  sessionId?: string;
  testerName?: string;
}

/**
 * Summary statistics for a specific combination
 */
export interface TestSummary {
  strand: string;
  substrand: string;
  year: number;
  modelId: string;

  totalTests: number;
  successfulTests: number;
  failedTests: number;
  averageRating: number | null;

  lastTested?: Date;
  recommendedStatus: 'untested' | 'testing' | 'approved' | 'rejected' | 'needs_review';
}

/**
 * Progress tracking for testing coverage
 */
export interface TestingProgress {
  totalCombinations: number;
  testedCombinations: number;
  approvedCombinations: number;
  rejectedCombinations: number;

  byYear: Record<number, {
    total: number;
    tested: number;
    approved: number;
  }>;

  byModel: Record<string, {
    total: number;
    tested: number;
    approved: number;
  }>;

  byStrand: Record<string, {
    total: number;
    tested: number;
    approved: number;
  }>;
}

/**
 * Test tracking storage and management
 */
export class TestTracker {
  private testResults: TestResult[] = [];
  private readonly storageKey = 'curriculum_test_results';

  constructor() {
    this.loadFromStorage();
  }

  /**
   * Add a new test result
   */
  addTestResult(result: Omit<TestResult, 'id' | 'timestamp'>): TestResult {
    const newResult: TestResult = {
      ...result,
      id: this.generateId(),
      timestamp: new Date()
    };

    this.testResults.push(newResult);
    this.saveToStorage();

    return newResult;
  }

  /**
   * Get all test results
   */
  getAllResults(): TestResult[] {
    return this.testResults;
  }

  /**
   * Get test results for a specific combination
   */
  getResultsForCombination(
    strand: string,
    substrand: string,
    year: number,
    modelId: string
  ): TestResult[] {
    return this.testResults.filter(
      result =>
        result.strand === strand &&
        result.substrand === substrand &&
        result.year === year &&
        result.modelId === modelId
    );
  }

  /**
   * Get summary for a specific combination
   */
  getSummary(
    strand: string,
    substrand: string,
    year: number,
    modelId: string
  ): TestSummary {
    const results = this.getResultsForCombination(strand, substrand, year, modelId);

    const ratings = results
      .filter(r => r.rating !== undefined)
      .map(r => r.rating!);

    const averageRating = ratings.length > 0
      ? ratings.reduce((a, b) => a + b, 0) / ratings.length
      : null;

    const lastTested = results.length > 0
      ? new Date(Math.max(...results.map(r => r.timestamp.getTime())))
      : undefined;

    // Determine recommended status based on tests and ratings
    let recommendedStatus: TestSummary['recommendedStatus'] = 'untested';
    if (results.length === 0) {
      recommendedStatus = 'untested';
    } else if (results.length < 3) {
      recommendedStatus = 'testing';
    } else if (averageRating !== null) {
      if (averageRating >= 4) {
        recommendedStatus = 'approved';
      } else if (averageRating <= 2) {
        recommendedStatus = 'rejected';
      } else {
        recommendedStatus = 'needs_review';
      }
    }

    return {
      strand,
      substrand,
      year,
      modelId,
      totalTests: results.length,
      successfulTests: results.filter(r => r.success).length,
      failedTests: results.filter(r => !r.success).length,
      averageRating,
      lastTested,
      recommendedStatus
    };
  }

  /**
   * Get overall testing progress
   */
  getProgress(
    allStrands: string[],
    allSubstrands: string[],
    allYears: number[],
    allModels: string[]
  ): TestingProgress {
    const totalCombinations = allStrands.length * allSubstrands.length * allYears.length * allModels.length;

    // Get unique tested combinations
    const testedCombos = new Set<string>();
    const approvedCombos = new Set<string>();
    const rejectedCombos = new Set<string>();

    this.testResults.forEach(result => {
      const key = `${result.strand}|${result.substrand}|${result.year}|${result.modelId}`;
      testedCombos.add(key);

      const summary = this.getSummary(result.strand, result.substrand, result.year, result.modelId);
      if (summary.recommendedStatus === 'approved') {
        approvedCombos.add(key);
      } else if (summary.recommendedStatus === 'rejected') {
        rejectedCombos.add(key);
      }
    });

    // Calculate progress by year
    const byYear: TestingProgress['byYear'] = {};
    allYears.forEach(year => {
      const yearTotal = allStrands.length * allSubstrands.length * allModels.length;
      const yearTested = this.testResults.filter(r => r.year === year).length;
      const yearApproved = Array.from(approvedCombos).filter(key =>
        key.split('|')[2] === year.toString()
      ).length;

      byYear[year] = {
        total: yearTotal,
        tested: yearTested,
        approved: yearApproved
      };
    });

    // Calculate progress by model
    const byModel: TestingProgress['byModel'] = {};
    allModels.forEach(modelId => {
      const modelTotal = allStrands.length * allSubstrands.length * allYears.length;
      const modelTested = this.testResults.filter(r => r.modelId === modelId).length;
      const modelApproved = Array.from(approvedCombos).filter(key =>
        key.split('|')[3] === modelId
      ).length;

      byModel[modelId] = {
        total: modelTotal,
        tested: modelTested,
        approved: modelApproved
      };
    });

    // Calculate progress by strand
    const byStrand: TestingProgress['byStrand'] = {};
    allStrands.forEach(strand => {
      const strandTotal = allSubstrands.length * allYears.length * allModels.length;
      const strandTested = this.testResults.filter(r => r.strand === strand).length;
      const strandApproved = Array.from(approvedCombos).filter(key =>
        key.split('|')[0] === strand
      ).length;

      byStrand[strand] = {
        total: strandTotal,
        tested: strandTested,
        approved: strandApproved
      };
    });

    return {
      totalCombinations,
      testedCombinations: testedCombos.size,
      approvedCombinations: approvedCombos.size,
      rejectedCombinations: rejectedCombos.size,
      byYear,
      byModel,
      byStrand
    };
  }

  /**
   * Update rating for existing test result
   */
  updateRating(testId: string, rating: 1 | 2 | 3 | 4 | 5, notes?: string): void {
    const result = this.testResults.find(r => r.id === testId);
    if (result) {
      result.rating = rating;
      if (notes !== undefined) {
        result.notes = notes;
      }
      this.saveToStorage();
    }
  }

  /**
   * Clear all test results (with confirmation)
   */
  clearAllResults(): void {
    this.testResults = [];
    this.saveToStorage();
  }

  /**
   * Export test results as JSON
   */
  exportResults(): string {
    return JSON.stringify(this.testResults, null, 2);
  }

  /**
   * Import test results from JSON
   */
  importResults(jsonData: string): void {
    try {
      const imported = JSON.parse(jsonData);
      if (Array.isArray(imported)) {
        // Convert date strings back to Date objects
        const results = imported.map(r => ({
          ...r,
          timestamp: new Date(r.timestamp)
        }));
        this.testResults = results;
        this.saveToStorage();
      }
    } catch (error) {
      console.error('Failed to import test results:', error);
      throw new Error('Invalid test results format');
    }
  }

  /**
   * Generate unique ID
   */
  private generateId(): string {
    return `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  /**
   * Load from local storage
   */
  private loadFromStorage(): void {
    if (typeof window === 'undefined') return;

    try {
      const stored = localStorage.getItem(this.storageKey);
      if (stored) {
        const parsed = JSON.parse(stored);
        // Convert date strings back to Date objects
        this.testResults = parsed.map((r: any) => ({
          ...r,
          timestamp: new Date(r.timestamp),
          lastTested: r.lastTested ? new Date(r.lastTested) : undefined
        }));
      }
    } catch (error) {
      console.error('Failed to load test results:', error);
      this.testResults = [];
    }
  }

  /**
   * Save to local storage
   */
  private saveToStorage(): void {
    if (typeof window === 'undefined') return;

    try {
      localStorage.setItem(this.storageKey, JSON.stringify(this.testResults));
    } catch (error) {
      console.error('Failed to save test results:', error);
    }
  }
}

// Singleton instance
export const testTracker = new TestTracker();
```
--- END FILE: lib\curriculum\test-tracking.ts ---

--- START FILE: lib\math-engine\difficulty-enhanced.ts ---
```typescript
import {
  SubDifficultyLevel,
  DifficultyProgression,
  DifficultyInterpolation,
  ProgressionRules,
  TransitionValidation,
  CognitiveDemands,
  EnhancedAdditionParams,
  EnhancedSubtractionParams,
  EnhancedMultiplicationParams,
  EnhancedDivisionParams,
  EnhancedPercentageParams,
  EnhancedFractionParams
} from '@/lib/types-enhanced';

/**
 * Enhanced Difficulty System with 4 sub-levels per year
 * Provides smooth progression and confidence preservation
 */
export class EnhancedDifficultySystem {
  
  private static readonly PROGRESSION_RULES: ProgressionRules = {
    maxParameterIncrease: 0.5,  // 50% max increase
    maxSimultaneousChanges: 2,  // Max 2 parameters change at once
    confidenceThreshold: 0.75,  // 75% success needed for advancement
    adaptiveEnabled: true
  };

  /**
   * Create a SubDifficultyLevel from decimal notation
   */
  static createLevel(year: number, subLevel: number): SubDifficultyLevel {
    if (year < 1 || year > 6) throw new Error('Year must be 1-6');
    if (subLevel < 1 || subLevel > 4) throw new Error('SubLevel must be 1-4');
    
    return {
      year,
      subLevel,
      displayName: `${year}.${subLevel}`
    };
  }

  /**
   * Parse decimal level string (e.g., "3.2") into SubDifficultyLevel
   */
  static parseLevel(levelString: string): SubDifficultyLevel {
    const parts = levelString.split('.');
    if (parts.length !== 2) throw new Error('Level must be in format "X.Y"');
    
    const year = parseInt(parts[0]);
    const subLevel = parseInt(parts[1]);
    
    return this.createLevel(year, subLevel);
  }

  /**
   * Get enhanced parameters for any model at specified sub-level
   */
  static getSubLevelParams(
    modelId: string, 
    level: SubDifficultyLevel
  ): any {
    switch (modelId) {
      case 'ADDITION':
        return this.getAdditionSubLevelParams(level);
      case 'SUBTRACTION':
        return this.getSubtractionSubLevelParams(level);
      case 'MULTIPLICATION':
        return this.getMultiplicationSubLevelParams(level);
      case 'DIVISION':
        return this.getDivisionSubLevelParams(level);
      case 'PERCENTAGE':
        return this.getPercentageSubLevelParams(level);
      case 'FRACTION':
        return this.getFractionSubLevelParams(level);
      default:
        throw new Error(`Enhanced difficulty not yet implemented for ${modelId}`);
    }
  }

  /**
   * Calculate cognitive load for given parameters
   */
  static calculateCognitiveLoad(
    modelId: string,
    parameters: any
  ): CognitiveDemands {
    switch (modelId) {
      case 'ADDITION':
        return this.calculateAdditionCognitive(parameters);
      case 'SUBTRACTION':
        return this.calculateSubtractionCognitive(parameters);
      case 'MULTIPLICATION':
        return this.calculateMultiplicationCognitive(parameters);
      case 'DIVISION':
        return this.calculateDivisionCognitive(parameters);
      default:
        return {
          workingMemoryLoad: 5,
          proceduralComplexity: 5,
          conceptualDepth: 5,
          visualProcessing: 5,
          totalLoad: 50
        };
    }
  }

  /**
   * Validate that transition between levels is smooth
   */
  static validateTransition(
    modelId: string,
    fromLevel: SubDifficultyLevel,
    toLevel: SubDifficultyLevel
  ): TransitionValidation {
    const fromParams = this.getSubLevelParams(modelId, fromLevel);
    const toParams = this.getSubLevelParams(modelId, toLevel);
    
    return this.analyzeParameterChanges(fromParams, toParams);
  }

  /**
   * Get next recommended level based on current performance
   */
  static getNextLevel(
    currentLevel: SubDifficultyLevel,
    isAdvancing: boolean = true
  ): SubDifficultyLevel {
    if (isAdvancing) {
      // Advance to next sub-level or next year
      if (currentLevel.subLevel < 4) {
        return this.createLevel(currentLevel.year, currentLevel.subLevel + 1);
      } else if (currentLevel.year < 6) {
        return this.createLevel(currentLevel.year + 1, 1);
      } else {
        return currentLevel; // At maximum level
      }
    } else {
      // Go back to previous sub-level or previous year
      if (currentLevel.subLevel > 1) {
        return this.createLevel(currentLevel.year, currentLevel.subLevel - 1);
      } else if (currentLevel.year > 1) {
        return this.createLevel(currentLevel.year - 1, 4);
      } else {
        return currentLevel; // At minimum level
      }
    }
  }

  // ADDITION Model Sub-Level Parameters
  private static getAdditionSubLevelParams(level: SubDifficultyLevel): EnhancedAdditionParams {
    const progressionTable = {
      // Year 1 sub-levels
      '1.1': { max_value: 5, operands: 2, carrying: 'never', range: 'single-digit' },
      '1.2': { max_value: 8, operands: 2, carrying: 'never', range: 'single-digit' },
      '1.3': { max_value: 10, operands: 2, carrying: 'never', range: 'single-digit' },
      '1.4': { max_value: 15, operands: 2, carrying: 'never', range: 'teen' },
      
      // Year 2 sub-levels
      '2.1': { max_value: 15, operands: 2, carrying: 'never', range: 'teen' },
      '2.2': { max_value: 18, operands: 2, carrying: 'never', range: 'two-digit' },
      '2.3': { max_value: 20, operands: 2, carrying: 'never', range: 'two-digit' },
      '2.4': { max_value: 30, operands: 2, carrying: 'rare', range: 'two-digit' },
      
      // Year 3 sub-levels
      '3.1': { max_value: 40, operands: [2,3], carrying: 'occasional', range: 'two-digit' },
      '3.2': { max_value: 60, operands: [2,3], carrying: 'common', range: 'two-digit' },
      '3.3': { max_value: 100, operands: 3, carrying: 'common', range: 'three-digit' },
      '3.4': { max_value: 150, operands: 3, carrying: 'always', range: 'three-digit' },
      
      // Year 4 sub-levels (introducing decimals)
      '4.1': { max_value: 150, operands: 3, carrying: 'always', range: 'three-digit', decimal_places: 0 },
      '4.2': { max_value: 100, operands: 3, carrying: 'always', range: 'two-digit', decimal_places: 1 },
      '4.3': { max_value: 100, operands: 3, carrying: 'always', range: 'two-digit', decimal_places: 2 },
      '4.4': { max_value: 200, operands: 3, carrying: 'always', range: 'three-digit', decimal_places: 2 },
      
      // Year 5 sub-levels
      '5.1': { max_value: 300, operands: 3, carrying: 'always', range: 'three-digit', decimal_places: 2 },
      '5.2': { max_value: 500, operands: 4, carrying: 'always', range: 'three-digit', decimal_places: 2 },
      '5.3': { max_value: 1000, operands: 4, carrying: 'always', range: 'large', decimal_places: 2 },
      '5.4': { max_value: 1500, operands: 4, carrying: 'always', range: 'large', decimal_places: 2 },
      
      // Year 6 sub-levels
      '6.1': { max_value: 2000, operands: 4, carrying: 'always', range: 'large', decimal_places: 2 },
      '6.2': { max_value: 5000, operands: 5, carrying: 'always', range: 'large', decimal_places: 3 },
      '6.3': { max_value: 10000, operands: 5, carrying: 'always', range: 'large', decimal_places: 3 },
      '6.4': { max_value: 15000, operands: 5, carrying: 'always', range: 'large', decimal_places: 3 }
    };

    const config = progressionTable[level.displayName as keyof typeof progressionTable] as any;
    if (!config) throw new Error(`No progression defined for level ${level.displayName}`);

    return {
      operand_count: Array.isArray(config.operands) ? config.operands[1] : config.operands,
      max_value: config.max_value,
      decimal_places: config.decimal_places || 0,
      allow_carrying: config.carrying !== 'never',
      value_constraints: {
        min: config.decimal_places ? 0.01 : 1,
        step: config.decimal_places ? Math.pow(10, -config.decimal_places) : 1
      },
      carryingFrequency: config.carrying as any,
      numberRange: config.range as any,
      visualSupport: level.year <= 2
    };
  }

  // SUBTRACTION Model Sub-Level Parameters
  private static getSubtractionSubLevelParams(level: SubDifficultyLevel): EnhancedSubtractionParams {
    const progressionTable = {
      // Year 1 sub-levels
      '1.1': { max: 5, borrowing: 'never', range: 'single-digit' },
      '1.2': { max: 8, borrowing: 'never', range: 'single-digit' },
      '1.3': { max: 10, borrowing: 'never', range: 'single-digit' },
      '1.4': { max: 15, borrowing: 'never', range: 'teen' },
      
      // Year 2 sub-levels
      '2.1': { max: 15, borrowing: 'never', range: 'teen' },
      '2.2': { max: 18, borrowing: 'never', range: 'two-digit' },
      '2.3': { max: 20, borrowing: 'never', range: 'two-digit' },
      '2.4': { max: 30, borrowing: 'rare', range: 'two-digit' },
      
      // Year 3 sub-levels
      '3.1': { max: 40, borrowing: 'occasional', range: 'two-digit' },
      '3.2': { max: 60, borrowing: 'common', range: 'two-digit' },
      '3.3': { max: 100, borrowing: 'common', range: 'three-digit' },
      '3.4': { max: 150, borrowing: 'always', range: 'three-digit' },
      
      // Year 4 sub-levels (introducing decimals)
      '4.1': { max: 150, borrowing: 'always', range: 'three-digit', decimal_places: 0 },
      '4.2': { max: 100, borrowing: 'always', range: 'two-digit', decimal_places: 1 },
      '4.3': { max: 100, borrowing: 'always', range: 'two-digit', decimal_places: 2 },
      '4.4': { max: 200, borrowing: 'always', range: 'three-digit', decimal_places: 2 },
      
      // Year 5 sub-levels
      '5.1': { max: 300, borrowing: 'always', range: 'three-digit', decimal_places: 2 },
      '5.2': { max: 500, borrowing: 'always', range: 'three-digit', decimal_places: 2 },
      '5.3': { max: 1000, borrowing: 'always', range: 'large', decimal_places: 2 },
      '5.4': { max: 1500, borrowing: 'always', range: 'large', decimal_places: 2 },
      
      // Year 6 sub-levels
      '6.1': { max: 2000, borrowing: 'always', range: 'large', decimal_places: 2 },
      '6.2': { max: 5000, borrowing: 'always', range: 'large', decimal_places: 3 },
      '6.3': { max: 10000, borrowing: 'always', range: 'large', decimal_places: 3 },
      '6.4': { max: 15000, borrowing: 'always', range: 'large', decimal_places: 3 }
    };

    const config = progressionTable[level.displayName as keyof typeof progressionTable] as any;
    if (!config) throw new Error(`No progression defined for level ${level.displayName}`);

    return {
      minuend_max: config.max,
      subtrahend_max: config.max,
      decimal_places: config.decimal_places || 0,
      allow_borrowing: config.borrowing !== 'never',
      ensure_positive: true,
      value_constraints: {
        step: config.decimal_places ? Math.pow(10, -config.decimal_places) : 1
      },
      borrowingFrequency: config.borrowing as any,
      numberRange: config.range as any,
      visualSupport: level.year <= 2
    };
  }

  // MULTIPLICATION Model Sub-Level Parameters
  private static getMultiplicationSubLevelParams(level: SubDifficultyLevel): EnhancedMultiplicationParams {
    const progressionTable = {
      // Year 1 sub-levels
      '1.1': { multiplicand_max: 3, multiplier_max: 2, tables: [2], range: 'basic' },
      '1.2': { multiplicand_max: 5, multiplier_max: 2, tables: [2], range: 'basic' },
      '1.3': { multiplicand_max: 5, multiplier_max: 2, tables: [2], range: 'basic' },
      '1.4': { multiplicand_max: 8, multiplier_max: 3, tables: [2, 3], range: 'basic' },
      
      // Year 2 sub-levels
      '2.1': { multiplicand_max: 8, multiplier_max: 3, tables: [2, 3], range: 'basic' },
      '2.2': { multiplicand_max: 10, multiplier_max: 4, tables: [2, 3, 4], range: 'basic' },
      '2.3': { multiplicand_max: 10, multiplier_max: 5, tables: [2, 3, 4, 5], range: 'basic' },
      '2.4': { multiplicand_max: 12, multiplier_max: 6, tables: [2, 3, 4, 5, 6], range: 'extended' },
      
      // Year 3 sub-levels
      '3.1': { multiplicand_max: 12, multiplier_max: 7, tables: [2, 3, 4, 5, 6, 7], range: 'extended' },
      '3.2': { multiplicand_max: 12, multiplier_max: 8, tables: [2, 3, 4, 5, 6, 7, 8], range: 'extended' },
      '3.3': { multiplicand_max: 12, multiplier_max: 10, tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], range: 'extended' },
      '3.4': { multiplicand_max: 20, multiplier_max: 10, tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], range: 'extended' },
      
      // Year 4 sub-levels
      '4.1': { multiplicand_max: 30, multiplier_max: 10, tables: [], range: 'large' },
      '4.2': { multiplicand_max: 50, multiplier_max: 10, tables: [], range: 'large' },
      '4.3': { multiplicand_max: 100, multiplier_max: 10, tables: [], range: 'large' },
      '4.4': { multiplicand_max: 150, multiplier_max: 12, tables: [], range: 'large' },
      
      // Year 5 sub-levels (introducing decimals)
      '5.1': { multiplicand_max: 150, multiplier_max: 15, tables: [], range: 'large', decimal_places: 0 },
      '5.2': { multiplicand_max: 100, multiplier_max: 20, tables: [], range: 'large', decimal_places: 1 },
      '5.3': { multiplicand_max: 100, multiplier_max: 100, tables: [], range: 'large', decimal_places: 2 },
      '5.4': { multiplicand_max: 200, multiplier_max: 100, tables: [], range: 'large', decimal_places: 2 },
      
      // Year 6 sub-levels
      '6.1': { multiplicand_max: 500, multiplier_max: 100, tables: [], range: 'large', decimal_places: 2, operand_count: 2 },
      '6.2': { multiplicand_max: 800, multiplier_max: 100, tables: [], range: 'large', decimal_places: 3, operand_count: 2 },
      '6.3': { multiplicand_max: 1000, multiplier_max: 100, tables: [], range: 'large', decimal_places: 3, operand_count: 3 },
      '6.4': { multiplicand_max: 1500, multiplier_max: 150, tables: [], range: 'large', decimal_places: 3, operand_count: 3, use_fractions: true }
    };

    const config = progressionTable[level.displayName as keyof typeof progressionTable] as any;
    if (!config) throw new Error(`No progression defined for level ${level.displayName}`);

    return {
      multiplicand_max: config.multiplicand_max,
      multiplier_max: config.multiplier_max,
      decimal_places: config.decimal_places || 0,
      operand_count: config.operand_count || 2,
      use_fractions: config.use_fractions || false,
      tablesFocus: config.tables,
      numberRange: config.range as any,
      conceptualSupport: level.year <= 3
    };
  }

  // DIVISION Model Sub-Level Parameters  
  private static getDivisionSubLevelParams(level: SubDifficultyLevel): EnhancedDivisionParams {
    const progressionTable = {
      // Year 1 sub-levels
      '1.1': { dividend_max: 6, divisor_max: 2, remainder: 'never', tables: [2] },
      '1.2': { dividend_max: 10, divisor_max: 2, remainder: 'never', tables: [2] },
      '1.3': { dividend_max: 10, divisor_max: 2, remainder: 'never', tables: [2] },
      '1.4': { dividend_max: 15, divisor_max: 3, remainder: 'never', tables: [2, 3] },
      
      // Year 2 sub-levels
      '2.1': { dividend_max: 15, divisor_max: 3, remainder: 'never', tables: [2, 3] },
      '2.2': { dividend_max: 20, divisor_max: 4, remainder: 'never', tables: [2, 3, 4] },
      '2.3': { dividend_max: 20, divisor_max: 5, remainder: 'never', tables: [2, 3, 4, 5] },
      '2.4': { dividend_max: 30, divisor_max: 5, remainder: 'rare', tables: [2, 3, 4, 5] },
      
      // Year 3 sub-levels
      '3.1': { dividend_max: 30, divisor_max: 6, remainder: 'rare', tables: [2, 3, 4, 5, 6] },
      '3.2': { dividend_max: 50, divisor_max: 8, remainder: 'occasional', tables: [2, 3, 4, 5, 6, 7, 8] },
      '3.3': { dividend_max: 100, divisor_max: 10, remainder: 'never', tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] },
      '3.4': { dividend_max: 100, divisor_max: 10, remainder: 'common', tables: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] },
      
      // Year 4 sub-levels (remainder mastery)
      '4.1': { dividend_max: 100, divisor_max: 10, remainder: 'common', decimal_places: 0 },
      '4.2': { dividend_max: 150, divisor_max: 12, remainder: 'always', decimal_places: 0 },
      '4.3': { dividend_max: 200, divisor_max: 15, remainder: 'always', decimal_places: 0 },
      '4.4': { dividend_max: 300, divisor_max: 20, remainder: 'always', decimal_places: 0 },
      
      // Year 5 sub-levels (introducing decimal results)
      '5.1': { dividend_max: 300, divisor_max: 20, remainder: 'always', decimal_places: 0 },
      '5.2': { dividend_max: 500, divisor_max: 25, remainder: 'always', decimal_places: 1 },
      '5.3': { dividend_max: 1000, divisor_max: 100, remainder: 'always', decimal_places: 2 },
      '5.4': { dividend_max: 1500, divisor_max: 100, remainder: 'always', decimal_places: 2 },
      
      // Year 6 sub-levels
      '6.1': { dividend_max: 2000, divisor_max: 100, remainder: 'always', decimal_places: 2 },
      '6.2': { dividend_max: 5000, divisor_max: 100, remainder: 'always', decimal_places: 3 },
      '6.3': { dividend_max: 10000, divisor_max: 100, remainder: 'always', decimal_places: 3 },
      '6.4': { dividend_max: 15000, divisor_max: 150, remainder: 'always', decimal_places: 3 }
    };

    const config = progressionTable[level.displayName as keyof typeof progressionTable] as any;
    if (!config) throw new Error(`No progression defined for level ${level.displayName}`);

    return {
      dividend_max: config.dividend_max,
      divisor_max: config.divisor_max,
      decimal_places: config.decimal_places || 0,
      allow_remainder: config.remainder !== 'never',
      ensure_whole: config.remainder === 'never',
      remainderFrequency: config.remainder as any,
      tablesFocus: config.tables || [],
      visualSupport: level.year <= 3
    };
  }

  // PERCENTAGE Model Sub-Level Parameters
  private static getPercentageSubLevelParams(level: SubDifficultyLevel): EnhancedPercentageParams {
    // Percentages typically start in Year 4
    if (level.year < 4) {
      throw new Error('Percentage model not appropriate for years below 4');
    }

    const progressionTable = {
      // Year 4 sub-levels
      '4.1': { base_max: 50, percentages: [50, 100], operation: 'of', complexity: 'simple' },
      '4.2': { base_max: 80, percentages: [25, 50, 75], operation: 'of', complexity: 'simple' },
      '4.3': { base_max: 100, percentages: [10, 50, 100], operation: 'of', complexity: 'simple' },
      '4.4': { base_max: 120, percentages: [10, 20, 25, 50], operation: 'of', complexity: 'standard' },
      
      // Year 5 sub-levels
      '5.1': { base_max: 150, percentages: [10, 20, 25, 50], operation: 'of', complexity: 'standard' },
      '5.2': { base_max: 180, percentages: [10, 20, 25, 50, 75], operation: 'of', complexity: 'standard' },
      '5.3': { base_max: 200, percentages: [10, 20, 25, 50, 75], operation: 'of', complexity: 'standard' },
      '5.4': { base_max: 250, percentages: [5, 10, 15, 20, 25, 30], operation: 'mixed', complexity: 'complex' },
      
      // Year 6 sub-levels
      '6.1': { base_max: 300, percentages: [5, 10, 15, 20, 25, 30, 40], operation: 'mixed', complexity: 'complex' },
      '6.2': { base_max: 400, percentages: [5, 10, 15, 20, 25, 30, 40, 50], operation: 'decrease', complexity: 'complex' },
      '6.3': { base_max: 500, percentages: [5, 10, 15, 20, 25, 30, 40, 50, 75], operation: 'decrease', complexity: 'complex' },
      '6.4': { base_max: 750, percentages: [5, 10, 15, 20, 25, 30, 40, 50, 75, 90], operation: 'decrease', complexity: 'complex' }
    };

    const config = progressionTable[level.displayName as keyof typeof progressionTable] as any;
    if (!config) throw new Error(`No progression defined for level ${level.displayName}`);

    return {
      base_value_max: config.base_max,
      percentage_values: config.percentages,
      operation_type: config.operation as any,
      decimal_places: level.year >= 5 ? 2 : 0,
      percentageComplexity: config.complexity as any,
      conceptualContext: ['money', 'measurement', 'statistics'].slice(0, Math.ceil(level.year / 2)),
      visualSupport: level.year <= 4
    };
  }

  // FRACTION Model Sub-Level Parameters
  private static getFractionSubLevelParams(level: SubDifficultyLevel): EnhancedFractionParams {
    // Fractions typically start in Year 3
    if (level.year < 3) {
      throw new Error('Fraction model not appropriate for years below 3');
    }

    const progressionTable = {
      // Year 3 sub-levels
      '3.1': { whole_max: 10, fractions: [{ numerator: 1, denominator: 2 }], complexity: 'basic', numerator_types: 'unit' },
      '3.2': { whole_max: 20, fractions: [{ numerator: 1, denominator: 2 }], complexity: 'basic', numerator_types: 'unit' },
      '3.3': { whole_max: 30, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 4 }], complexity: 'basic', numerator_types: 'unit' },
      '3.4': { whole_max: 50, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }], complexity: 'common', numerator_types: 'simple' },
      
      // Year 4 sub-levels
      '4.1': { whole_max: 60, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }], complexity: 'common', numerator_types: 'simple' },
      '4.2': { whole_max: 80, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }], complexity: 'common', numerator_types: 'simple' },
      '4.3': { whole_max: 100, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }], complexity: 'common', numerator_types: 'simple' },
      '4.4': { whole_max: 150, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 2, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }], complexity: 'mixed', numerator_types: 'mixed' },
      
      // Year 5 sub-levels
      '5.1': { whole_max: 200, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 2, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }, { numerator: 1, denominator: 5 }], complexity: 'mixed', numerator_types: 'mixed' },
      '5.2': { whole_max: 300, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 2, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }, { numerator: 1, denominator: 5 }, { numerator: 2, denominator: 5 }], complexity: 'mixed', numerator_types: 'mixed' },
      '5.3': { whole_max: 500, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 2, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }, { numerator: 1, denominator: 5 }, { numerator: 2, denominator: 5 }, { numerator: 3, denominator: 5 }], complexity: 'mixed', numerator_types: 'mixed' },
      '5.4': { whole_max: 750, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 2, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }, { numerator: 1, denominator: 5 }, { numerator: 2, denominator: 5 }, { numerator: 3, denominator: 5 }, { numerator: 4, denominator: 5 }], complexity: 'complex', numerator_types: 'mixed' },
      
      // Year 6 sub-levels
      '6.1': { whole_max: 1000, fractions: [{ numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 2, denominator: 3 }, { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }, { numerator: 1, denominator: 5 }, { numerator: 2, denominator: 5 }, { numerator: 3, denominator: 5 }, { numerator: 4, denominator: 5 }], complexity: 'complex', numerator_types: 'mixed' },
      '6.2': { whole_max: 1200, fractions: 'extended', complexity: 'complex', numerator_types: 'mixed' },
      '6.3': { whole_max: 1500, fractions: 'extended', complexity: 'complex', numerator_types: 'improper' },
      '6.4': { whole_max: 2000, fractions: 'extended', complexity: 'complex', numerator_types: 'improper' }
    };

    const config = progressionTable[level.displayName as keyof typeof progressionTable] as any;
    if (!config) throw new Error(`No progression defined for level ${level.displayName}`);

    // Extended fractions for Year 6
    const extendedFractions = [
      { numerator: 1, denominator: 2 }, { numerator: 1, denominator: 3 }, { numerator: 2, denominator: 3 },
      { numerator: 1, denominator: 4 }, { numerator: 3, denominator: 4 }, { numerator: 1, denominator: 5 },
      { numerator: 2, denominator: 5 }, { numerator: 3, denominator: 5 }, { numerator: 4, denominator: 5 },
      { numerator: 1, denominator: 6 }, { numerator: 5, denominator: 6 }, { numerator: 1, denominator: 8 },
      { numerator: 3, denominator: 8 }, { numerator: 5, denominator: 8 }, { numerator: 7, denominator: 8 },
      { numerator: 1, denominator: 10 }, { numerator: 3, denominator: 10 }, { numerator: 7, denominator: 10 }, { numerator: 9, denominator: 10 }
    ];

    return {
      whole_value_max: config.whole_max,
      fraction_types: config.fractions === 'extended' ? extendedFractions : config.fractions,
      decimal_places: level.year >= 4 ? 2 : 0,
      ensure_whole_result: level.year <= 3,
      denominatorComplexity: config.complexity as any,
      numeratorTypes: config.numerator_types as any,
      visualSupport: level.year <= 4
    };
  }

  // Cognitive Load Calculation Methods
  private static calculateAdditionCognitive(params: EnhancedAdditionParams): CognitiveDemands {
    const workingMemory = Math.min(10, Math.ceil(params.operand_count * 2 + (params.max_value > 100 ? 2 : 0)));
    const procedural = Math.min(10, Math.ceil((params.allow_carrying ? 3 : 1) + (params.decimal_places > 0 ? 2 : 0)));
    const conceptual = Math.min(10, Math.ceil(params.decimal_places + (params.allow_carrying ? 2 : 0)));
    const visual = Math.min(10, Math.ceil(Math.log10(params.max_value) + params.operand_count));
    
    return {
      workingMemoryLoad: workingMemory,
      proceduralComplexity: procedural,
      conceptualDepth: conceptual,
      visualProcessing: visual,
      totalLoad: Math.round((workingMemory + procedural + conceptual + visual) * 2.5)
    };
  }

  private static calculateSubtractionCognitive(params: EnhancedSubtractionParams): CognitiveDemands {
    const workingMemory = Math.min(10, Math.ceil(2 + (params.minuend_max > 100 ? 2 : 0)));
    const procedural = Math.min(10, Math.ceil((params.allow_borrowing ? 4 : 1) + (params.decimal_places > 0 ? 2 : 0)));
    const conceptual = Math.min(10, Math.ceil(params.decimal_places + (params.allow_borrowing ? 3 : 0)));
    const visual = Math.min(10, Math.ceil(Math.log10(params.minuend_max) + 1));
    
    return {
      workingMemoryLoad: workingMemory,
      proceduralComplexity: procedural,
      conceptualDepth: conceptual,
      visualProcessing: visual,
      totalLoad: Math.round((workingMemory + procedural + conceptual + visual) * 2.5)
    };
  }

  private static calculateMultiplicationCognitive(params: EnhancedMultiplicationParams): CognitiveDemands {
    const workingMemory = Math.min(10, Math.ceil(3 + (params.multiplicand_max > 100 ? 3 : 0)));
    const procedural = Math.min(10, Math.ceil(3 + (params.decimal_places > 0 ? 3 : 0) + (params.use_fractions ? 2 : 0)));
    const conceptual = Math.min(10, Math.ceil(2 + params.decimal_places + (params.use_fractions ? 3 : 0)));
    const visual = Math.min(10, Math.ceil(Math.log10(params.multiplicand_max) + Math.log10(params.multiplier_max)));
    
    return {
      workingMemoryLoad: workingMemory,
      proceduralComplexity: procedural,
      conceptualDepth: conceptual,
      visualProcessing: visual,
      totalLoad: Math.round((workingMemory + procedural + conceptual + visual) * 2.5)
    };
  }

  private static calculateDivisionCognitive(params: EnhancedDivisionParams): CognitiveDemands {
    const workingMemory = Math.min(10, Math.ceil(4 + (params.dividend_max > 100 ? 3 : 0)));
    const procedural = Math.min(10, Math.ceil(4 + (params.decimal_places > 0 ? 3 : 0) + (params.allow_remainder ? 2 : 0)));
    const conceptual = Math.min(10, Math.ceil(3 + params.decimal_places + (params.allow_remainder ? 2 : 0)));
    const visual = Math.min(10, Math.ceil(Math.log10(params.dividend_max) + 1));
    
    return {
      workingMemoryLoad: workingMemory,
      proceduralComplexity: procedural,
      conceptualDepth: conceptual,
      visualProcessing: visual,
      totalLoad: Math.round((workingMemory + procedural + conceptual + visual) * 2.5)
    };
  }

  private static analyzeParameterChanges(fromParams: any, toParams: any): TransitionValidation {
    const warnings: string[] = [];
    const recommendations: string[] = [];
    
    // Check for parameter changes that are too large
    const paramChanges = this.calculateParameterChanges(fromParams, toParams);
    const maxChange = Math.max(...paramChanges.map(change => change.percentIncrease));
    const simultaneousChanges = paramChanges.filter(change => change.percentIncrease > 0).length;
    
    const isSmooth = maxChange <= 50 && simultaneousChanges <= 2;
    
    if (maxChange > 50) {
      warnings.push(`Parameter change of ${maxChange.toFixed(1)}% exceeds 50% threshold`);
      recommendations.push('Consider adding intermediate sub-level');
    }
    
    if (simultaneousChanges > 2) {
      warnings.push(`${simultaneousChanges} parameters changing simultaneously`);
      recommendations.push('Limit changes to 2 parameters per level');
    }
    
    return {
      isSmooth,
      maxParameterChange: maxChange,
      simultaneousChanges,
      cognitiveLoadIncrease: Math.min(100, maxChange * simultaneousChanges),
      warnings,
      recommendations
    };
  }

  private static calculateParameterChanges(fromParams: any, toParams: any): Array<{
    parameter: string;
    fromValue: any;
    toValue: any;
    percentIncrease: number;
  }> {
    const changes: Array<{
      parameter: string;
      fromValue: any;
      toValue: any;
      percentIncrease: number;
    }> = [];
    
    // Compare numeric parameters
    const numericParams = ['max_value', 'minuend_max', 'subtrahend_max', 'multiplicand_max', 
                          'multiplier_max', 'dividend_max', 'divisor_max', 'operand_count',
                          'base_value_max', 'whole_value_max'];
    
    for (const param of numericParams) {
      if (fromParams[param] !== undefined && toParams[param] !== undefined) {
        const fromVal = fromParams[param];
        const toVal = toParams[param];
        const percentIncrease = fromVal > 0 ? ((toVal - fromVal) / fromVal) * 100 : 0;
        
        if (percentIncrease > 0) {
          changes.push({
            parameter: param,
            fromValue: fromVal,
            toValue: toVal,
            percentIncrease
          });
        }
      }
    }
    
    return changes;
  }
}
```
--- END FILE: lib\math-engine\difficulty-enhanced.ts ---

--- START FILE: lib\math-engine\difficulty.ts ---
```typescript
import {
  AdditionDifficultyParams,
  SubtractionDifficultyParams,
  MultiplicationDifficultyParams,
  DivisionDifficultyParams,
  PercentageDifficultyParams
} from '@/lib/types';

type DifficultyParams = 
  | AdditionDifficultyParams
  | SubtractionDifficultyParams
  | MultiplicationDifficultyParams
  | DivisionDifficultyParams
  | PercentageDifficultyParams;

export class DifficultyPresets {
  static getPreset(modelId: string, year: number): DifficultyParams {
    switch (modelId) {
      case 'ADDITION':
        return this.getAdditionPreset(year);
      case 'SUBTRACTION':
        return this.getSubtractionPreset(year);
      case 'MULTIPLICATION':
        return this.getMultiplicationPreset(year);
      case 'DIVISION':
        return this.getDivisionPreset(year);
      case 'PERCENTAGE':
        return this.getPercentagePreset(year);
      default:
        throw new Error(`Unknown model: ${modelId}`);
    }
  }

  private static getAdditionPreset(year: number): AdditionDifficultyParams {
    const presets: Record<number, AdditionDifficultyParams> = {
      1: {
        operand_count: 2,
        max_value: 10,
        decimal_places: 0,
        allow_carrying: false,
        value_constraints: { min: 1, step: 1 }
      },
      2: {
        operand_count: 2,
        max_value: 20,
        decimal_places: 0,
        allow_carrying: false,
        value_constraints: { min: 1, step: 1 }
      },
      3: {
        operand_count: 3,
        max_value: 100,
        decimal_places: 0,
        allow_carrying: true,
        value_constraints: { min: 1, step: 1 }
      },
      4: {
        operand_count: 3,
        max_value: 100,
        decimal_places: 2,
        allow_carrying: true,
        value_constraints: { min: 0.01, step: 0.01 }
      },
      5: {
        operand_count: 4,
        max_value: 1000,
        decimal_places: 2,
        allow_carrying: true,
        value_constraints: { min: 0.01, step: 0.01 }
      },
      6: {
        operand_count: 5,
        max_value: 10000,
        decimal_places: 3,
        allow_carrying: true,
        value_constraints: { min: 0.001, step: 0.001 }
      }
    };
    return presets[year] || presets[6];
  }

  private static getSubtractionPreset(year: number): SubtractionDifficultyParams {
    const presets: Record<number, SubtractionDifficultyParams> = {
      1: {
        minuend_max: 10,
        subtrahend_max: 10,
        decimal_places: 0,
        allow_borrowing: false,
        ensure_positive: true,
        value_constraints: { step: 1 }
      },
      2: {
        minuend_max: 20,
        subtrahend_max: 20,
        decimal_places: 0,
        allow_borrowing: false,
        ensure_positive: true,
        value_constraints: { step: 1 }
      },
      3: {
        minuend_max: 100,
        subtrahend_max: 100,
        decimal_places: 0,
        allow_borrowing: true,
        ensure_positive: true,
        value_constraints: { step: 1 }
      },
      4: {
        minuend_max: 100,
        subtrahend_max: 100,
        decimal_places: 2,
        allow_borrowing: true,
        ensure_positive: true,
        value_constraints: { step: 0.01 }
      },
      5: {
        minuend_max: 1000,
        subtrahend_max: 1000,
        decimal_places: 2,
        allow_borrowing: true,
        ensure_positive: true,
        value_constraints: { step: 0.01 }
      },
      6: {
        minuend_max: 10000,
        subtrahend_max: 10000,
        decimal_places: 3,
        allow_borrowing: true,
        ensure_positive: true,
        value_constraints: { step: 0.001 }
      }
    };
    return presets[year] || presets[6];
  }

  private static getMultiplicationPreset(year: number): MultiplicationDifficultyParams {
    const presets: Record<number, MultiplicationDifficultyParams> = {
      1: {
        multiplicand_max: 5,
        multiplier_max: 2,
        decimal_places: 0,
        operand_count: 2,
        use_fractions: false
      },
      2: {
        multiplicand_max: 10,
        multiplier_max: 5,
        decimal_places: 0,
        operand_count: 2,
        use_fractions: false
      },
      3: {
        multiplicand_max: 10,
        multiplier_max: 10,
        decimal_places: 0,
        operand_count: 2,
        use_fractions: false
      },
      4: {
        multiplicand_max: 100,
        multiplier_max: 10,
        decimal_places: 0,
        operand_count: 2,
        use_fractions: false
      },
      5: {
        multiplicand_max: 100,
        multiplier_max: 100,
        decimal_places: 2,
        operand_count: 2,
        use_fractions: false
      },
      6: {
        multiplicand_max: 1000,
        multiplier_max: 100,
        decimal_places: 3,
        operand_count: 3,
        use_fractions: true
      }
    };
    return presets[year] || presets[6];
  }

  private static getDivisionPreset(year: number): DivisionDifficultyParams {
    const presets: Record<number, DivisionDifficultyParams> = {
      1: {
        dividend_max: 10,
        divisor_max: 2,
        decimal_places: 0,
        allow_remainder: false,
        ensure_whole: true
      },
      2: {
        dividend_max: 20,
        divisor_max: 5,
        decimal_places: 0,
        allow_remainder: false,
        ensure_whole: true
      },
      3: {
        dividend_max: 100,
        divisor_max: 10,
        decimal_places: 0,
        allow_remainder: false,
        ensure_whole: true
      },
      4: {
        dividend_max: 100,
        divisor_max: 10,
        decimal_places: 0,
        allow_remainder: true,
        ensure_whole: false
      },
      5: {
        dividend_max: 1000,
        divisor_max: 100,
        decimal_places: 2,
        allow_remainder: true,
        ensure_whole: false
      },
      6: {
        dividend_max: 10000,
        divisor_max: 100,
        decimal_places: 3,
        allow_remainder: true,
        ensure_whole: false
      }
    };
    return presets[year] || presets[6];
  }

  private static getPercentagePreset(year: number): PercentageDifficultyParams {
    const presets: Record<number, PercentageDifficultyParams> = {
      4: {
        base_value_max: 100,
        percentage_values: [10, 50, 100],
        operation_type: "of",
        decimal_places: 0
      },
      5: {
        base_value_max: 200,
        percentage_values: [10, 20, 25, 50, 75],
        operation_type: "of",
        decimal_places: 2
      },
      6: {
        base_value_max: 500,
        percentage_values: [5, 10, 15, 20, 25, 30, 40, 50, 75],
        operation_type: "decrease",
        decimal_places: 2
      }
    };
    return presets[year] || presets[6];
  }
}
```
--- END FILE: lib\math-engine\difficulty.ts ---

--- START FILE: lib\math-engine\index.ts ---
```typescript
import { AdditionModel } from './models/addition.model';
import { SubtractionModel } from './models/subtraction.model';
import { MultiplicationModel } from './models/multiplication.model';
import { DivisionModel } from './models/division.model';
import { PercentageModel } from './models/percentage.model';
import { FractionModel } from './models/fraction.model';
import { CountingModel } from './models/counting.model';
import { TimeRateModel } from './models/time-rate.model';
import { ConversionModel } from './models/conversion.model';
import { ComparisonModel } from './models/comparison.model';
import { MultiStepModel } from './models/multi-step.model';
import { LinearEquationModel } from './models/linear-equation.model';
import { UnitRateModel } from './models/unit-rate.model';
import { CoinRecognitionModel } from './models/coin-recognition.model';
import { ChangeCalculationModel } from './models/change-calculation.model';
import { MoneyCombinationsModel } from './models/money-combinations.model';
import { MixedMoneyUnitsModel } from './models/mixed-money-units.model';
import { MoneyFractionsModel } from './models/money-fractions.model';
import { MoneyScalingModel } from './models/money-scaling.model';
import { ShapeRecognitionModel } from './models/shape-recognition.model';
import { ShapePropertiesModel } from './models/shape-properties.model';
import { AngleMeasurementModel } from './models/angle-measurement.model';
import { PositionDirectionModel } from './models/position-direction.model';
import { AreaPerimeterModel } from './models/area-perimeter.model';
import { DifficultyPresets } from './difficulty';

// Model Registry
export const mathModels = {
  ADDITION: new AdditionModel(),
  SUBTRACTION: new SubtractionModel(),
  MULTIPLICATION: new MultiplicationModel(),
  DIVISION: new DivisionModel(),
  PERCENTAGE: new PercentageModel(),
  FRACTION: new FractionModel(),
  COUNTING: new CountingModel(),
  TIME_RATE: new TimeRateModel(),
  CONVERSION: new ConversionModel(),
  COMPARISON: new ComparisonModel(),
  MULTI_STEP: new MultiStepModel(),
  LINEAR_EQUATION: new LinearEquationModel(),
  UNIT_RATE: new UnitRateModel(),
  COIN_RECOGNITION: new CoinRecognitionModel(),
  CHANGE_CALCULATION: new ChangeCalculationModel(),
  MONEY_COMBINATIONS: new MoneyCombinationsModel(),
  MIXED_MONEY_UNITS: new MixedMoneyUnitsModel(),
  MONEY_FRACTIONS: new MoneyFractionsModel(),
  MONEY_SCALING: new MoneyScalingModel(),
  SHAPE_RECOGNITION: new ShapeRecognitionModel(),
  SHAPE_PROPERTIES: new ShapePropertiesModel(),
  ANGLE_MEASUREMENT: new AngleMeasurementModel(),
  POSITION_DIRECTION: new PositionDirectionModel(),
  AREA_PERIMETER: new AreaPerimeterModel()
};

export type ModelId = keyof typeof mathModels;

// Get a specific model
export function getModel(modelId: ModelId) {
  const model = mathModels[modelId];
  if (!model) {
    throw new Error(`Model ${modelId} not found`);
  }
  return model;
}

// Get all available models
export function getAllModels() {
  return Object.keys(mathModels);
}

// Generate a question using a specific model
export function generateMathQuestion(
  modelId: ModelId,
  year?: number,
  customParams?: any
) {
  const model = getModel(modelId);
  const params = customParams || model.getDefaultParams(year || 4);
  return model.generate(params);
}

// Export components
export { DifficultyPresets };
export * from './models/addition.model';
export * from './models/subtraction.model';
export * from './models/multiplication.model';
export * from './models/division.model';
export * from './models/percentage.model';
```
--- END FILE: lib\math-engine\index.ts ---

--- START FILE: lib\math-engine\models\addition.model.ts ---
```typescript
import {
  IMathModel,
  AdditionDifficultyParams,
  AdditionOutput,
  DecimalFormatted
} from '@/lib/types';
import {
  generateRandomNumber,
  formatDecimal,
  requiresCarrying,
  ensureUnique
} from '@/lib/utils';

export class AdditionModel implements IMathModel<AdditionDifficultyParams, AdditionOutput> {
  public readonly model_id = "ADDITION";

  generate(params: AdditionDifficultyParams): AdditionOutput {
    const operands = this.generateOperands(params);
    const result = this.calculateSum(operands);
    const intermediateSteps = this.calculateIntermediateSteps(operands);
    const decimalFormatted = this.formatOutput(operands, result, params.decimal_places);

    return {
      operation: "ADDITION",
      operands,
      result,
      intermediate_steps: intermediateSteps,
      decimal_formatted: decimalFormatted
    };
  }

  getDefaultParams(year: number): AdditionDifficultyParams {
    if (year <= 2) {
      return {
        operand_count: 2,
        max_value: 20,
        decimal_places: 0,
        allow_carrying: false,
        value_constraints: {
          min: 1,
          step: 1
        }
      };
    } else if (year <= 4) {
      return {
        operand_count: 3,
        max_value: 100,
        decimal_places: year === 4 ? 2 : 0,
        allow_carrying: true,
        value_constraints: {
          min: 1,
          step: year === 4 ? 0.01 : 1
        }
      };
    } else {
      return {
        operand_count: 4,
        max_value: 1000,
        decimal_places: 2,
        allow_carrying: true,
        value_constraints: {
          min: 1,
          step: 0.01
        }
      };
    }
  }

  private generateOperands(params: AdditionDifficultyParams): number[] {
    const operands: number[] = [];
    let attempts = 0;
    const maxAttempts = 50;

    while (attempts < maxAttempts) {
      const tempOperands: number[] = [];
      
      for (let i = 0; i < params.operand_count; i++) {
        const value = generateRandomNumber(
          params.max_value,
          params.decimal_places,
          params.value_constraints.min,
          params.value_constraints.step
        );
        tempOperands.push(value);
      }

      // Check carrying requirement
      if (params.allow_carrying || !requiresCarrying(tempOperands)) {
        return tempOperands;
      }

      attempts++;
    }

    // Fallback: return operands regardless of carrying requirement
    return ensureUnique(
      () => generateRandomNumber(
        params.max_value,
        params.decimal_places,
        params.value_constraints.min,
        params.value_constraints.step
      ),
      params.operand_count
    );
  }

  private calculateSum(operands: number[]): number {
    const sum = operands.reduce((acc, val) => acc + val, 0);
    // Handle floating point precision
    return Math.round(sum * 1000) / 1000;
  }

  private calculateIntermediateSteps(operands: number[]): number[] {
    const steps: number[] = [];
    let runningSum = 0;
    
    for (let i = 0; i < operands.length - 1; i++) {
      runningSum += operands[i];
      steps.push(Math.round(runningSum * 1000) / 1000);
    }
    
    return steps;
  }

  private formatOutput(
    operands: number[],
    result: number,
    decimalPlaces: number
  ): DecimalFormatted {
    return {
      operands: operands.map(op => formatDecimal(op, decimalPlaces)),
      result: formatDecimal(result, decimalPlaces)
    };
  }
}
```
--- END FILE: lib\math-engine\models\addition.model.ts ---

--- START FILE: lib\math-engine\models\angle-measurement.model.ts ---
```typescript
import {
  IMathModel,
  AngleMeasurementDifficultyParams,
  AngleMeasurementOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class AngleMeasurementModel implements IMathModel<AngleMeasurementDifficultyParams, AngleMeasurementOutput> {
  public readonly model_id = "ANGLE_MEASUREMENT";

  private static readonly ANGLE_TYPES = {
    acute: { min: 1, max: 89, description: 'less than 90 degrees' },
    right: { min: 90, max: 90, description: 'exactly 90 degrees' },
    obtuse: { min: 91, max: 179, description: 'between 90 and 180 degrees' },
    straight: { min: 180, max: 180, description: 'exactly 180 degrees' },
    reflex: { min: 181, max: 359, description: 'between 180 and 360 degrees' }
  };

  private static readonly COMMON_ANGLES = [30, 45, 60, 90, 120, 135, 150, 180, 270];

  private static readonly CLOCK_ANGLES = {
    '3 o\'clock': 90,
    '6 o\'clock': 180,
    '9 o\'clock': 270,
    '12 o\'clock': 0,
    '1 o\'clock': 30,
    '2 o\'clock': 60,
    '4 o\'clock': 120,
    '5 o\'clock': 150,
    '7 o\'clock': 210,
    '8 o\'clock': 240,
    '10 o\'clock': 300,
    '11 o\'clock': 330
  };

  generate(params: AngleMeasurementDifficultyParams): AngleMeasurementOutput {
    const problemType = randomChoice(params.problem_types);
    
    switch (problemType) {
      case 'identify_type':
        return this.generateIdentifyTypeProblem(params);
      case 'measure_angle':
        return this.generateMeasureAngleProblem(params);
      case 'calculate_missing':
        return this.generateCalculateMissingProblem(params);
      case 'convert_units':
        return this.generateConvertUnitsProblem(params);
      default:
        return this.generateIdentifyTypeProblem(params);
    }
  }

  getDefaultParams(year: number): AngleMeasurementDifficultyParams {
    if (year <= 3) {
      return {
        angle_types: ['right'],
        measurement_units: ['right_angles', 'turns'],
        include_angle_drawing: false,
        include_angle_calculation: false,
        max_angle_degrees: 90,
        problem_types: ['identify_type']
      };
    } else if (year <= 4) {
      return {
        angle_types: ['right', 'acute', 'obtuse'],
        measurement_units: ['degrees', 'right_angles'],
        include_angle_drawing: false,
        include_angle_calculation: false,
        max_angle_degrees: 180,
        problem_types: ['identify_type', 'measure_angle']
      };
    } else if (year <= 5) {
      return {
        angle_types: ['right', 'acute', 'obtuse', 'straight'],
        measurement_units: ['degrees', 'right_angles', 'turns'],
        include_angle_drawing: true,
        include_angle_calculation: true,
        max_angle_degrees: 180,
        problem_types: ['identify_type', 'measure_angle', 'calculate_missing']
      };
    } else {
      return {
        angle_types: ['right', 'acute', 'obtuse', 'straight', 'reflex'],
        measurement_units: ['degrees', 'turns'],
        include_angle_drawing: true,
        include_angle_calculation: true,
        max_angle_degrees: 360,
        problem_types: ['identify_type', 'measure_angle', 'calculate_missing', 'convert_units']
      };
    }
  }

  private generateIdentifyTypeProblem(params: AngleMeasurementDifficultyParams): AngleMeasurementOutput {
    const angleType = randomChoice(params.angle_types);
    const angleData = AngleMeasurementModel.ANGLE_TYPES[angleType as keyof typeof AngleMeasurementModel.ANGLE_TYPES];
    
    let angleDegrees: number;
    if (angleType === 'right' || angleType === 'straight') {
      angleDegrees = angleData.min; // Exact values for these
    } else {
      // Use common angles when possible, otherwise generate random
      const commonAnglesInRange = AngleMeasurementModel.COMMON_ANGLES.filter(
        angle => angle >= angleData.min && angle <= angleData.max
      );
      
      if (commonAnglesInRange.length > 0 && Math.random() > 0.3) {
        angleDegrees = randomChoice(commonAnglesInRange);
      } else {
        angleDegrees = generateRandomNumber(angleData.max, 0, angleData.min);
      }
    }

    const context = this.generateAngleContext(angleDegrees);

    return {
      operation: "ANGLE_MEASUREMENT",
      problem_type: 'identify_type',
      angle_degrees: angleDegrees,
      angle_type: angleType,
      measurement_in_turns: angleDegrees / 360,
      measurement_in_right_angles: angleDegrees / 90,
      context: context.type,
      visual_description: context.description,
      correct_answer: angleType
    };
  }

  private generateMeasureAngleProblem(params: AngleMeasurementDifficultyParams): AngleMeasurementOutput {
    const unit = randomChoice(params.measurement_units);
    const angleType = randomChoice(params.angle_types);
    const angleData = AngleMeasurementModel.ANGLE_TYPES[angleType as keyof typeof AngleMeasurementModel.ANGLE_TYPES];
    
    let angleDegrees: number;
    if (angleType === 'right' || angleType === 'straight') {
      angleDegrees = angleData.min;
    } else {
      // Prefer common angles for measurement problems
      const commonAnglesInRange = AngleMeasurementModel.COMMON_ANGLES.filter(
        angle => angle >= angleData.min && angle <= angleData.max
      );
      
      if (commonAnglesInRange.length > 0) {
        angleDegrees = randomChoice(commonAnglesInRange);
      } else {
        angleDegrees = generateRandomNumber(angleData.max, 0, angleData.min);
      }
    }

    const context = this.generateAngleContext(angleDegrees);
    
    let correctAnswer: string | number;
    switch (unit) {
      case 'degrees':
        correctAnswer = `${angleDegrees}Â°`;
        break;
      case 'right_angles':
        correctAnswer = angleDegrees / 90;
        break;
      case 'turns':
        correctAnswer = angleDegrees / 360;
        break;
      default:
        correctAnswer = angleDegrees;
    }

    return {
      operation: "ANGLE_MEASUREMENT",
      problem_type: 'measure_angle',
      angle_degrees: angleDegrees,
      angle_type: angleType,
      measurement_in_turns: angleDegrees / 360,
      measurement_in_right_angles: angleDegrees / 90,
      context: context.type,
      visual_description: context.description,
      correct_answer: correctAnswer
    };
  }

  private generateCalculateMissingProblem(params: AngleMeasurementDifficultyParams): AngleMeasurementOutput {
    // Generate problems about angles on a straight line (sum to 180Â°) or around a point (sum to 360Â°)
    const problemContext = randomChoice(['straight_line', 'around_point']);
    
    let totalAngle: number;
    let contextDescription: string;
    
    if (problemContext === 'straight_line') {
      totalAngle = 180;
      contextDescription = 'angles on a straight line';
    } else {
      totalAngle = 360;
      contextDescription = 'angles around a point';
    }
    
    // Generate known angles that sum to less than the total
    const knownAngle1 = generateRandomNumber(60, 0, 20);
    const knownAngle2 = generateRandomNumber(80, 0, 30);
    const missingAngle = totalAngle - knownAngle1 - knownAngle2;
    
    // Ensure we have a valid problem
    if (missingAngle <= 0 || missingAngle >= totalAngle) {
      // Fallback to a simpler problem
      const known = generateRandomNumber(120, 0, 30);
      const missing = totalAngle - known;
      
      return {
        operation: "ANGLE_MEASUREMENT",
        problem_type: 'calculate_missing',
        angle_degrees: missing,
        angle_type: this.classifyAngle(missing),
        measurement_in_turns: missing / 360,
        measurement_in_right_angles: missing / 90,
        context: problemContext,
        visual_description: `Two angles: ${known}Â° and unknown angle on a ${problemContext === 'straight_line' ? 'straight line' : 'around a point'}`,
        correct_answer: `${missing}Â°`
      };
    }

    return {
      operation: "ANGLE_MEASUREMENT",
      problem_type: 'calculate_missing',
      angle_degrees: missingAngle,
      angle_type: this.classifyAngle(missingAngle),
      measurement_in_turns: missingAngle / 360,
      measurement_in_right_angles: missingAngle / 90,
      context: problemContext,
      visual_description: `Three angles: ${knownAngle1}Â°, ${knownAngle2}Â°, and unknown angle ${contextDescription}`,
      correct_answer: `${missingAngle}Â°`
    };
  }

  private generateConvertUnitsProblem(params: AngleMeasurementDifficultyParams): AngleMeasurementOutput {
    const fromUnit = randomChoice(params.measurement_units);
    const availableToUnits = params.measurement_units.filter(unit => unit !== fromUnit);
    const toUnit = randomChoice(availableToUnits);
    
    // Generate a suitable angle based on the conversion
    let angleDegrees: number;
    if (fromUnit === 'right_angles' || toUnit === 'right_angles') {
      // Use multiples of 90 for right angle conversions
      const rightAngleMultiples = [90, 180, 270, 360];
      angleDegrees = randomChoice(rightAngleMultiples.filter(angle => angle <= params.max_angle_degrees));
    } else if (fromUnit === 'turns' || toUnit === 'turns') {
      // Use fractions of 360 for turn conversions
      const turnFractions = [90, 180, 270, 360];
      angleDegrees = randomChoice(turnFractions.filter(angle => angle <= params.max_angle_degrees));
    } else {
      angleDegrees = randomChoice(AngleMeasurementModel.COMMON_ANGLES.filter(angle => angle <= params.max_angle_degrees));
    }

    let correctAnswer: string | number;
    if (toUnit === 'degrees') {
      correctAnswer = `${angleDegrees}Â°`;
    } else if (toUnit === 'right_angles') {
      correctAnswer = angleDegrees / 90;
    } else if (toUnit === 'turns') {
      const turns = angleDegrees / 360;
      correctAnswer = turns === 1 ? '1 full turn' : turns < 1 ? `${turns} turn` : `${turns} turns`;
    } else {
      correctAnswer = angleDegrees;
    }

    return {
      operation: "ANGLE_MEASUREMENT",
      problem_type: 'convert_units',
      angle_degrees: angleDegrees,
      angle_type: this.classifyAngle(angleDegrees),
      measurement_in_turns: angleDegrees / 360,
      measurement_in_right_angles: angleDegrees / 90,
      context: 'conversion',
      visual_description: `Converting ${angleDegrees}Â° from ${fromUnit} to ${toUnit}`,
      correct_answer: correctAnswer
    };
  }

  private generateAngleContext(angleDegrees: number): { type: string; description: string } {
    const contexts = ['clock', 'shape', 'lines'];
    const contextType = randomChoice(contexts);
    
    switch (contextType) {
      case 'clock':
        // Find closest clock position
        const clockEntries = Object.entries(AngleMeasurementModel.CLOCK_ANGLES);
        const closestClock = clockEntries.reduce((closest, [time, angle]) => {
          return Math.abs(angle - angleDegrees) < Math.abs(closest.angle - angleDegrees) 
            ? { time, angle } 
            : closest;
        }, { time: '12 o\'clock', angle: 0 });
        
        return {
          type: 'clock',
          description: `Clock hands at ${closestClock.time} form a ${angleDegrees}Â° angle`
        };
      
      case 'shape':
        return {
          type: 'shape',
          description: `Interior angle of ${angleDegrees}Â° in a polygon`
        };
      
      case 'lines':
        return {
          type: 'lines',
          description: `Angle of ${angleDegrees}Â° formed by two intersecting lines`
        };
      
      default:
        return {
          type: 'general',
          description: `An angle of ${angleDegrees}Â°`
        };
    }
  }

  private classifyAngle(degrees: number): string {
    if (degrees === 90) return 'right';
    if (degrees === 180) return 'straight';
    if (degrees < 90) return 'acute';
    if (degrees < 180) return 'obtuse';
    return 'reflex';
  }
}
```
--- END FILE: lib\math-engine\models\angle-measurement.model.ts ---

--- START FILE: lib\math-engine\models\area-perimeter.model.ts ---
```typescript
import {
  IMathModel,
  AreaPerimeterDifficultyParams,
  AreaPerimeterOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class AreaPerimeterModel implements IMathModel<AreaPerimeterDifficultyParams, AreaPerimeterOutput> {
  public readonly model_id = "AREA_PERIMETER";

  private static readonly SHAPE_FORMULAS = {
    rectangle: {
      area: (length: number, width: number) => length * width,
      perimeter: (length: number, width: number) => 2 * (length + width)
    },
    square: {
      area: (side: number) => side * side,
      perimeter: (side: number) => 4 * side
    },
    triangle: {
      area: (base: number, height: number) => 0.5 * base * height,
      perimeter: (a: number, b: number, c: number) => a + b + c
    },
    circle: {
      area: (radius: number) => Math.PI * radius * radius,
      perimeter: (radius: number) => 2 * Math.PI * radius
    }
  };

  private static readonly MEASUREMENT_UNITS = {
    'mm': { name: 'millimetres', symbol: 'mm', scale: 0.1 },
    'cm': { name: 'centimetres', symbol: 'cm', scale: 1 },
    'm': { name: 'metres', symbol: 'm', scale: 100 },
    'units': { name: 'units', symbol: 'units', scale: 1 }
  };

  generate(params: AreaPerimeterDifficultyParams): AreaPerimeterOutput {
    const problemType = randomChoice(params.calculation_types);
    const shapeType = randomChoice(params.shape_types);
    
    switch (problemType) {
      case 'area':
        return this.generateAreaProblem(params, shapeType);
      case 'perimeter':
        return this.generatePerimeterProblem(params, shapeType);
      case 'both':
        return this.generateBothProblem(params, shapeType);
      case 'find_missing_dimension':
        return this.generateMissingDimensionProblem(params, shapeType);
      default:
        return this.generateAreaProblem(params, shapeType);
    }
  }

  getDefaultParams(year: number): AreaPerimeterDifficultyParams {
    if (year <= 3) {
      return {
        shape_types: ['rectangle', 'square'],
        measurement_units: ['cm', 'units'],
        max_dimensions: 10,
        include_decimal_measurements: false,
        calculation_types: ['area', 'perimeter'],
        allow_compound_shapes: false
      };
    } else if (year <= 4) {
      return {
        shape_types: ['rectangle', 'square', 'triangle'],
        measurement_units: ['cm', 'm', 'units'],
        max_dimensions: 15,
        include_decimal_measurements: false,
        calculation_types: ['area', 'perimeter', 'both'],
        allow_compound_shapes: true
      };
    } else if (year <= 5) {
      return {
        shape_types: ['rectangle', 'square', 'triangle'],
        measurement_units: ['mm', 'cm', 'm'],
        max_dimensions: 20,
        include_decimal_measurements: true,
        calculation_types: ['area', 'perimeter', 'both', 'find_missing_dimension'],
        allow_compound_shapes: true
      };
    } else {
      return {
        shape_types: ['rectangle', 'square', 'triangle', 'circle'],
        measurement_units: ['mm', 'cm', 'm'],
        max_dimensions: 25,
        include_decimal_measurements: true,
        calculation_types: ['area', 'perimeter', 'both', 'find_missing_dimension'],
        allow_compound_shapes: true
      };
    }
  }

  private generateAreaProblem(params: AreaPerimeterDifficultyParams, shapeType: string): AreaPerimeterOutput {
    const unit = randomChoice(params.measurement_units);
    const dimensions = this.generateDimensions(shapeType, params);
    const area = this.calculateArea(shapeType, dimensions);
    
    return {
      operation: "AREA_PERIMETER",
      problem_type: 'calculate_area',
      shape_type: shapeType,
      dimensions: dimensions,
      measurement_unit: unit,
      area_result: this.formatResult(area, params.include_decimal_measurements),
      perimeter_result: undefined,
      missing_dimension: undefined,
      formula_used: this.getAreaFormula(shapeType),
      visual_description: this.generateShapeDescription(shapeType, dimensions, unit),
      correct_answer: `${this.formatResult(area, params.include_decimal_measurements)} ${unit}Â²`
    };
  }

  private generatePerimeterProblem(params: AreaPerimeterDifficultyParams, shapeType: string): AreaPerimeterOutput {
    const unit = randomChoice(params.measurement_units);
    const dimensions = this.generateDimensions(shapeType, params);
    const perimeter = this.calculatePerimeter(shapeType, dimensions);
    
    return {
      operation: "AREA_PERIMETER",
      problem_type: 'calculate_perimeter',
      shape_type: shapeType,
      dimensions: dimensions,
      measurement_unit: unit,
      area_result: undefined,
      perimeter_result: this.formatResult(perimeter, params.include_decimal_measurements),
      missing_dimension: undefined,
      formula_used: this.getPerimeterFormula(shapeType),
      visual_description: this.generateShapeDescription(shapeType, dimensions, unit),
      correct_answer: `${this.formatResult(perimeter, params.include_decimal_measurements)} ${unit}`
    };
  }

  private generateBothProblem(params: AreaPerimeterDifficultyParams, shapeType: string): AreaPerimeterOutput {
    const unit = randomChoice(params.measurement_units);
    const dimensions = this.generateDimensions(shapeType, params);
    const area = this.calculateArea(shapeType, dimensions);
    const perimeter = this.calculatePerimeter(shapeType, dimensions);
    
    return {
      operation: "AREA_PERIMETER",
      problem_type: 'calculate_both',
      shape_type: shapeType,
      dimensions: dimensions,
      measurement_unit: unit,
      area_result: this.formatResult(area, params.include_decimal_measurements),
      perimeter_result: this.formatResult(perimeter, params.include_decimal_measurements),
      missing_dimension: undefined,
      formula_used: `${this.getAreaFormula(shapeType)} and ${this.getPerimeterFormula(shapeType)}`,
      visual_description: this.generateShapeDescription(shapeType, dimensions, unit),
      correct_answer: `Area: ${this.formatResult(area, params.include_decimal_measurements)} ${unit}Â², Perimeter: ${this.formatResult(perimeter, params.include_decimal_measurements)} ${unit}`
    };
  }

  private generateMissingDimensionProblem(params: AreaPerimeterDifficultyParams, shapeType: string): AreaPerimeterOutput {
    const unit = randomChoice(params.measurement_units);
    const calculationType = randomChoice(['area', 'perimeter']);
    
    // Generate complete dimensions first
    const fullDimensions = this.generateDimensions(shapeType, params);
    
    // Choose which dimension to make unknown
    let knownDimensions: any = {};
    let missingDimension: { name: string; value: number } = { name: '', value: 0 };
    let knownValue: number;
    
    if (shapeType === 'rectangle') {
      const makeLengthUnknown = Math.random() > 0.5;
      if (makeLengthUnknown) {
        knownDimensions.width = fullDimensions.width;
        missingDimension = { name: 'length', value: fullDimensions.length };
        knownValue = calculationType === 'area' 
          ? this.calculateArea(shapeType, fullDimensions)
          : this.calculatePerimeter(shapeType, fullDimensions);
      } else {
        knownDimensions.length = fullDimensions.length;
        missingDimension = { name: 'width', value: fullDimensions.width };
        knownValue = calculationType === 'area' 
          ? this.calculateArea(shapeType, fullDimensions)
          : this.calculatePerimeter(shapeType, fullDimensions);
      }
    } else if (shapeType === 'square') {
      knownValue = calculationType === 'area' 
        ? this.calculateArea(shapeType, fullDimensions)
        : this.calculatePerimeter(shapeType, fullDimensions);
      missingDimension = { name: 'side', value: fullDimensions.side };
    } else {
      // For other shapes, default to finding area/perimeter instead
      return this.generateAreaProblem(params, shapeType);
    }
    
    return {
      operation: "AREA_PERIMETER",
      problem_type: 'find_missing_dimension',
      shape_type: shapeType,
      dimensions: knownDimensions,
      measurement_unit: unit,
      area_result: calculationType === 'area' ? this.formatResult(knownValue, params.include_decimal_measurements) : undefined,
      perimeter_result: calculationType === 'perimeter' ? this.formatResult(knownValue, params.include_decimal_measurements) : undefined,
      missing_dimension: missingDimension,
      formula_used: calculationType === 'area' ? this.getAreaFormula(shapeType) : this.getPerimeterFormula(shapeType),
      visual_description: this.generateMissingDimensionDescription(shapeType, knownDimensions, calculationType, knownValue, unit),
      correct_answer: `${this.formatResult(missingDimension.value, params.include_decimal_measurements)} ${unit}`
    };
  }

  private generateDimensions(shapeType: string, params: AreaPerimeterDifficultyParams): any {
    const maxDim = params.max_dimensions;
    const useDecimals = params.include_decimal_measurements;
    
    switch (shapeType) {
      case 'rectangle':
        return {
          length: this.generateMeasurement(maxDim, useDecimals),
          width: this.generateMeasurement(maxDim, useDecimals)
        };
      case 'square':
        return {
          side: this.generateMeasurement(maxDim, useDecimals)
        };
      case 'triangle':
        const base = this.generateMeasurement(maxDim, useDecimals);
        const height = this.generateMeasurement(maxDim, useDecimals);
        // For perimeter, generate three sides that form a valid triangle
        const side1 = base;
        const side2 = this.generateMeasurement(maxDim, useDecimals);
        const side3 = this.generateValidThirdSide(side1, side2, maxDim, useDecimals);
        return {
          base: base,
          height: height,
          side1: side1,
          side2: side2,
          side3: side3
        };
      case 'circle':
        return {
          radius: this.generateMeasurement(Math.min(maxDim, 10), useDecimals)
        };
      default:
        return {
          length: this.generateMeasurement(maxDim, useDecimals),
          width: this.generateMeasurement(maxDim, useDecimals)
        };
    }
  }

  private generateMeasurement(maxValue: number, useDecimals: boolean): number {
    if (useDecimals && Math.random() > 0.6) {
      // Generate decimal value
      const integer = generateRandomNumber(Math.floor(maxValue), 0, 1);
      const decimal = Math.round(Math.random() * 9) / 10;
      return integer + decimal;
    } else {
      return generateRandomNumber(maxValue, 0, 1);
    }
  }

  private generateValidThirdSide(side1: number, side2: number, maxValue: number, useDecimals: boolean): number {
    // Triangle inequality: side3 < side1 + side2 and side3 > |side1 - side2|
    const minSide = Math.abs(side1 - side2) + 0.1;
    const maxSide = Math.min(side1 + side2 - 0.1, maxValue);
    
    if (minSide >= maxSide) {
      return Math.min(side1, side2);
    }
    
    if (useDecimals && Math.random() > 0.6) {
      const range = maxSide - minSide;
      return Math.round((minSide + Math.random() * range) * 10) / 10;
    } else {
      return Math.floor(minSide) + generateRandomNumber(Math.floor(maxSide - minSide), 0, 0);
    }
  }

  private calculateArea(shapeType: string, dimensions: any): number {
    switch (shapeType) {
      case 'rectangle':
        return AreaPerimeterModel.SHAPE_FORMULAS.rectangle.area(dimensions.length, dimensions.width);
      case 'square':
        return AreaPerimeterModel.SHAPE_FORMULAS.square.area(dimensions.side);
      case 'triangle':
        return AreaPerimeterModel.SHAPE_FORMULAS.triangle.area(dimensions.base, dimensions.height);
      case 'circle':
        return AreaPerimeterModel.SHAPE_FORMULAS.circle.area(dimensions.radius);
      default:
        return 0;
    }
  }

  private calculatePerimeter(shapeType: string, dimensions: any): number {
    switch (shapeType) {
      case 'rectangle':
        return AreaPerimeterModel.SHAPE_FORMULAS.rectangle.perimeter(dimensions.length, dimensions.width);
      case 'square':
        return AreaPerimeterModel.SHAPE_FORMULAS.square.perimeter(dimensions.side);
      case 'triangle':
        return AreaPerimeterModel.SHAPE_FORMULAS.triangle.perimeter(dimensions.side1, dimensions.side2, dimensions.side3);
      case 'circle':
        return AreaPerimeterModel.SHAPE_FORMULAS.circle.perimeter(dimensions.radius);
      default:
        return 0;
    }
  }

  private getAreaFormula(shapeType: string): string {
    switch (shapeType) {
      case 'rectangle':
        return 'Area = length Ã width';
      case 'square':
        return 'Area = side Ã side';
      case 'triangle':
        return 'Area = Â½ Ã base Ã height';
      case 'circle':
        return 'Area = Ï Ã radiusÂ²';
      default:
        return 'Area formula';
    }
  }

  private getPerimeterFormula(shapeType: string): string {
    switch (shapeType) {
      case 'rectangle':
        return 'Perimeter = 2 Ã (length + width)';
      case 'square':
        return 'Perimeter = 4 Ã side';
      case 'triangle':
        return 'Perimeter = side1 + side2 + side3';
      case 'circle':
        return 'Circumference = 2 Ã Ï Ã radius';
      default:
        return 'Perimeter formula';
    }
  }

  private generateShapeDescription(shapeType: string, dimensions: any, unit: string): string {
    switch (shapeType) {
      case 'rectangle':
        return `Rectangle with length ${dimensions.length}${unit} and width ${dimensions.width}${unit}`;
      case 'square':
        return `Square with sides of ${dimensions.side}${unit}`;
      case 'triangle':
        return `Triangle with base ${dimensions.base}${unit} and height ${dimensions.height}${unit}`;
      case 'circle':
        return `Circle with radius ${dimensions.radius}${unit}`;
      default:
        return `${shapeType} shape`;
    }
  }

  private generateMissingDimensionDescription(
    shapeType: string, 
    knownDimensions: any, 
    calculationType: string, 
    knownValue: number, 
    unit: string
  ): string {
    const valueType = calculationType === 'area' ? 'area' : 'perimeter';
    const valueUnit = calculationType === 'area' ? `${unit}Â²` : unit;
    
    if (shapeType === 'rectangle') {
      const knownDim = Object.keys(knownDimensions)[0];
      const knownVal = knownDimensions[knownDim];
      return `Rectangle with ${knownDim} ${knownVal}${unit} and ${valueType} ${knownValue}${valueUnit}`;
    } else if (shapeType === 'square') {
      return `Square with ${valueType} ${knownValue}${valueUnit}`;
    }
    
    return `${shapeType} with ${valueType} ${knownValue}${valueUnit}`;
  }

  private formatResult(value: number, allowDecimals: boolean): number {
    if (allowDecimals) {
      return Math.round(value * 100) / 100;
    } else {
      return Math.round(value);
    }
  }
}
```
--- END FILE: lib\math-engine\models\area-perimeter.model.ts ---

--- START FILE: lib\math-engine\models\change-calculation.model.ts ---
```typescript
import {
  IMathModel,
  ChangeCalculationDifficultyParams,
  ChangeCalculationOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class ChangeCalculationModel implements IMathModel<ChangeCalculationDifficultyParams, ChangeCalculationOutput> {
  public readonly model_id = "CHANGE_CALCULATION";

  private static readonly COMMON_PAYMENTS = [
    100, 200, 500, 1000, 2000, 5000 // 1p, 2p, 5p, Â£1, Â£2, Â£5 etc in pence
  ];

  private static readonly UK_DENOMINATIONS = [1, 2, 5, 10, 20, 50, 100, 200, 500, 1000, 2000, 5000];

  generate(params: ChangeCalculationDifficultyParams): ChangeCalculationOutput {
    const problemType = this.selectProblemType(params);
    
    switch (problemType) {
      case 'simple_change':
        return this.generateSimpleChangeProblem(params);
      case 'exact_payment':
        return this.generateExactPaymentProblem(params);
      case 'multiple_items':
        return this.generateMultipleItemsProblem(params);
      case 'change_breakdown':
        return this.generateChangeBreakdownProblem(params);
      default:
        return this.generateSimpleChangeProblem(params);
    }
  }

  getDefaultParams(year: number): ChangeCalculationDifficultyParams {
    if (year <= 2) {
      return {
        max_item_cost: 50, // Up to 50p
        payment_methods: [100, 200, 500], // Â£1, Â£2, Â£5
        decimal_places: 0,
        problem_types: ['simple_change', 'exact_payment'],
        include_breakdown: false,
        max_items: 1,
        allow_overpayment: true
      };
    } else if (year <= 3) {
      return {
        max_item_cost: 500, // Up to Â£5
        payment_methods: [100, 200, 500, 1000, 2000], // Â£1-Â£20
        decimal_places: 2,
        problem_types: ['simple_change', 'multiple_items', 'change_breakdown'],
        include_breakdown: true,
        max_items: 3,
        allow_overpayment: true
      };
    } else {
      return {
        max_item_cost: 2000, // Up to Â£20
        payment_methods: [500, 1000, 2000, 5000], // Â£5-Â£50
        decimal_places: 2,
        problem_types: ['simple_change', 'multiple_items', 'change_breakdown', 'exact_payment'],
        include_breakdown: true,
        max_items: 5,
        allow_overpayment: true
      };
    }
  }

  private selectProblemType(params: ChangeCalculationDifficultyParams): string {
    return randomChoice(params.problem_types);
  }

  private generateSimpleChangeProblem(params: ChangeCalculationDifficultyParams): ChangeCalculationOutput {
    // Generate a simple single-item purchase with change
    const itemCost = this.generateItemCost(params);
    const paymentAmount = this.selectPaymentAmount(params, itemCost);
    const changeAmount = paymentAmount - itemCost;

    const changeBreakdown = params.include_breakdown ? 
      this.calculateOptimalChange(changeAmount) : [];

    return {
      operation: "CHANGE_CALCULATION",
      problem_type: 'simple_change',
      items: [{ name: 'item', cost: itemCost, quantity: 1 }],
      total_cost: itemCost,
      payment_amount: paymentAmount,
      change_amount: changeAmount,
      change_breakdown: changeBreakdown,
      payment_description: this.formatPaymentDescription(paymentAmount)
    };
  }

  private generateExactPaymentProblem(params: ChangeCalculationDifficultyParams): ChangeCalculationOutput {
    // Generate a problem where exact payment is needed
    const itemCost = this.generateItemCost(params);
    const paymentAmount = itemCost; // Exact payment
    const changeAmount = 0;

    return {
      operation: "CHANGE_CALCULATION",
      problem_type: 'exact_payment',
      items: [{ name: 'item', cost: itemCost, quantity: 1 }],
      total_cost: itemCost,
      payment_amount: paymentAmount,
      change_amount: changeAmount,
      change_breakdown: [],
      payment_description: this.formatPaymentDescription(paymentAmount)
    };
  }

  private generateMultipleItemsProblem(params: ChangeCalculationDifficultyParams): ChangeCalculationOutput {
    // Generate multiple items with total and change
    const itemCount = generateRandomNumber(Math.min(params.max_items, 4), 0, 2);
    const items: Array<{ name: string; cost: number; quantity: number }> = [];
    let totalCost = 0;

    for (let i = 0; i < itemCount; i++) {
      const cost = this.generateItemCost(params, 0.7); // Slightly smaller items for multiple
      const quantity = 1;
      items.push({
        name: this.getItemName(i),
        cost,
        quantity
      });
      totalCost += cost * quantity;
    }

    const paymentAmount = this.selectPaymentAmount(params, totalCost);
    const changeAmount = paymentAmount - totalCost;
    const changeBreakdown = params.include_breakdown ? 
      this.calculateOptimalChange(changeAmount) : [];

    return {
      operation: "CHANGE_CALCULATION",
      problem_type: 'multiple_items',
      items,
      total_cost: totalCost,
      payment_amount: paymentAmount,
      change_amount: changeAmount,
      change_breakdown: changeBreakdown,
      payment_description: this.formatPaymentDescription(paymentAmount)
    };
  }

  private generateChangeBreakdownProblem(params: ChangeCalculationDifficultyParams): ChangeCalculationOutput {
    // Focus on breaking down change into denominations
    const itemCost = this.generateItemCost(params, 0.6); // Smaller cost to ensure meaningful change
    const paymentAmount = this.selectPaymentAmount(params, itemCost, true); // Force larger payment
    const changeAmount = paymentAmount - itemCost;
    
    const changeBreakdown = this.calculateOptimalChange(changeAmount);

    return {
      operation: "CHANGE_CALCULATION",
      problem_type: 'change_breakdown',
      items: [{ name: 'item', cost: itemCost, quantity: 1 }],
      total_cost: itemCost,
      payment_amount: paymentAmount,
      change_amount: changeAmount,
      change_breakdown: changeBreakdown,
      payment_description: this.formatPaymentDescription(paymentAmount)
    };
  }

  private generateItemCost(params: ChangeCalculationDifficultyParams, multiplier: number = 1): number {
    const maxCost = Math.floor(params.max_item_cost * multiplier);
    let cost = generateRandomNumber(maxCost, params.decimal_places, 5); // Minimum 5p
    
    // Round to appropriate increment based on decimal places
    if (params.decimal_places === 0) {
      cost = Math.round(cost / 5) * 5; // Round to nearest 5p
    } else {
      cost = Math.round(cost * 100) / 100; // Round to nearest penny
    }
    
    return cost;
  }

  private selectPaymentAmount(
    params: ChangeCalculationDifficultyParams, 
    itemCost: number, 
    forceChange: boolean = false
  ): number {
    const availablePayments = params.payment_methods.filter(p => p > itemCost);
    
    if (availablePayments.length === 0 || (!forceChange && Math.random() < 0.2)) {
      // Sometimes allow exact payment or use next denomination up
      const nextUp = ChangeCalculationModel.COMMON_PAYMENTS.find(p => p > itemCost);
      return nextUp || itemCost * 1.5;
    }
    
    return randomChoice(availablePayments);
  }

  private calculateOptimalChange(changeAmount: number): Array<{ denomination: number; count: number; formatted: string }> {
    if (changeAmount <= 0) return [];

    const breakdown: Array<{ denomination: number; count: number; formatted: string }> = [];
    let remaining = Math.round(changeAmount); // Work in pence

    // Use greedy algorithm with UK denominations (in pence)
    const denominations = [5000, 2000, 1000, 500, 200, 100, 50, 20, 10, 5, 2, 1];
    
    for (const denom of denominations) {
      if (remaining >= denom) {
        const count = Math.floor(remaining / denom);
        breakdown.push({
          denomination: denom,
          count,
          formatted: this.formatDenomination(denom)
        });
        remaining -= count * denom;
      }
    }

    return breakdown;
  }

  private formatPaymentDescription(amount: number): string {
    if (amount >= 500) {
      const pounds = Math.floor(amount / 100);
      return `Â£${pounds} note`;
    } else if (amount >= 100) {
      const pounds = amount / 100;
      return `Â£${pounds} coin`;
    } else {
      return `${amount}p coin`;
    }
  }

  private formatDenomination(denominationInPence: number): string {
    if (denominationInPence >= 100) {
      const pounds = denominationInPence / 100;
      return `Â£${pounds}`;
    }
    return `${denominationInPence}p`;
  }

  private getItemName(index: number): string {
    const items = ['apple', 'book', 'pencil', 'rubber', 'sweet', 'toy', 'sticker', 'card'];
    return items[index % items.length];
  }
}
```
--- END FILE: lib\math-engine\models\change-calculation.model.ts ---

--- START FILE: lib\math-engine\models\coin-recognition.model.ts ---
```typescript
import {
  IMathModel,
  CoinRecognitionDifficultyParams,
  CoinRecognitionOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class CoinRecognitionModel implements IMathModel<CoinRecognitionDifficultyParams, CoinRecognitionOutput> {
  public readonly model_id = "COIN_RECOGNITION";

  private static readonly UK_COINS = {
    1: { name: 'penny', plural: 'pennies', format: '1p' },
    2: { name: 'two pence', plural: 'two pence coins', format: '2p' },
    5: { name: 'five pence', plural: 'five pence coins', format: '5p' },
    10: { name: 'ten pence', plural: 'ten pence coins', format: '10p' },
    20: { name: 'twenty pence', plural: 'twenty pence coins', format: '20p' },
    50: { name: 'fifty pence', plural: 'fifty pence coins', format: '50p' }
  };

  private static readonly UK_NOTES = {
    500: { name: 'five pound note', plural: 'five pound notes', format: 'Â£5' },
    1000: { name: 'ten pound note', plural: 'ten pound notes', format: 'Â£10' },
    2000: { name: 'twenty pound note', plural: 'twenty pound notes', format: 'Â£20' },
    5000: { name: 'fifty pound note', plural: 'fifty pound notes', format: 'Â£50' }
  };

  generate(params: CoinRecognitionDifficultyParams): CoinRecognitionOutput {
    const problemType = this.selectProblemType(params);
    const denominations = this.getAvailableDenominations(params);
    
    switch (problemType) {
      case 'identify_value':
        return this.generateIdentifyValueProblem(params, denominations);
      case 'identify_name':
        return this.generateIdentifyNameProblem(params, denominations);
      case 'count_collection':
        return this.generateCountCollectionProblem(params, denominations);
      case 'compare_values':
        return this.generateCompareValuesProblem(params, denominations);
      default:
        return this.generateIdentifyValueProblem(params, denominations);
    }
  }

  getDefaultParams(year: number): CoinRecognitionDifficultyParams {
    if (year <= 1) {
      return {
        include_coins: [1, 2, 5, 10],
        include_notes: [],
        problem_types: ['identify_value', 'identify_name'],
        max_coin_count: 3,
        allow_mixed_denominations: false,
        include_combinations: false
      };
    } else if (year <= 2) {
      return {
        include_coins: [1, 2, 5, 10, 20],
        include_notes: [500], // Â£5 note
        problem_types: ['identify_value', 'count_collection', 'compare_values'],
        max_coin_count: 5,
        allow_mixed_denominations: true,
        include_combinations: false
      };
    } else {
      return {
        include_coins: [1, 2, 5, 10, 20, 50],
        include_notes: [500, 1000, 2000], // Â£5, Â£10, Â£20
        problem_types: ['identify_value', 'count_collection', 'compare_values'],
        max_coin_count: 8,
        allow_mixed_denominations: true,
        include_combinations: true
      };
    }
  }

  private selectProblemType(params: CoinRecognitionDifficultyParams): string {
    return randomChoice(params.problem_types);
  }

  private getAvailableDenominations(params: CoinRecognitionDifficultyParams): number[] {
    return [...params.include_coins, ...params.include_notes];
  }

  private generateIdentifyValueProblem(
    params: CoinRecognitionDifficultyParams, 
    denominations: number[]
  ): CoinRecognitionOutput {
    const denomination = randomChoice(denominations);
    const isNote = denomination >= 500;
    const coinData = isNote ? 
      CoinRecognitionModel.UK_NOTES[denomination as keyof typeof CoinRecognitionModel.UK_NOTES] :
      CoinRecognitionModel.UK_COINS[denomination as keyof typeof CoinRecognitionModel.UK_COINS];

    return {
      operation: "COIN_RECOGNITION",
      problem_type: 'identify_value',
      target_denomination: denomination,
      denomination_name: coinData.name,
      formatted_value: coinData.format,
      is_note: isNote,
      collection: [{ denomination, count: 1 }],
      total_value: denomination,
      answer_type: 'value'
    };
  }

  private generateIdentifyNameProblem(
    params: CoinRecognitionDifficultyParams, 
    denominations: number[]
  ): CoinRecognitionOutput {
    const denomination = randomChoice(denominations);
    const isNote = denomination >= 500;
    const coinData = isNote ? 
      CoinRecognitionModel.UK_NOTES[denomination as keyof typeof CoinRecognitionModel.UK_NOTES] :
      CoinRecognitionModel.UK_COINS[denomination as keyof typeof CoinRecognitionModel.UK_COINS];

    return {
      operation: "COIN_RECOGNITION",
      problem_type: 'identify_name',
      target_denomination: denomination,
      denomination_name: coinData.name,
      formatted_value: coinData.format,
      is_note: isNote,
      collection: [{ denomination, count: 1 }],
      total_value: denomination,
      answer_type: 'name'
    };
  }

  private generateCountCollectionProblem(
    params: CoinRecognitionDifficultyParams, 
    denominations: number[]
  ): CoinRecognitionOutput {
    const collection: Array<{ denomination: number; count: number }> = [];
    let totalValue = 0;

    if (params.allow_mixed_denominations) {
      // Use 2-3 different denominations
      const selectedDenoms = this.selectMultipleDenominations(denominations, 2, 3);
      
      for (const denom of selectedDenoms) {
        const count = generateRandomNumber(3, 0, 1);
        if (count > 0) {
          collection.push({ denomination: denom, count });
          totalValue += denom * count;
        }
      }
    } else {
      // Use only one denomination
      const denomination = randomChoice(denominations.filter(d => d < 500)); // Prefer coins for counting
      const count = generateRandomNumber(Math.min(params.max_coin_count, 5), 0, 2);
      collection.push({ denomination, count });
      totalValue = denomination * count;
    }

    return {
      operation: "COIN_RECOGNITION",
      problem_type: 'count_collection',
      collection,
      total_value: totalValue,
      answer_type: 'total_value'
    };
  }

  private generateCompareValuesProblem(
    params: CoinRecognitionDifficultyParams, 
    denominations: number[]
  ): CoinRecognitionOutput {
    // Generate two different amounts to compare
    const denom1 = randomChoice(denominations);
    const denom2 = randomChoice(denominations.filter(d => d !== denom1));

    const collection = [
      { denomination: denom1, count: 1 },
      { denomination: denom2, count: 1 }
    ];

    const comparison_result = denom1 > denom2 ? 'first_greater' : 
                             denom1 < denom2 ? 'second_greater' : 'equal';

    return {
      operation: "COIN_RECOGNITION",
      problem_type: 'compare_values',
      collection,
      total_value: Math.max(denom1, denom2),
      comparison_result,
      answer_type: 'comparison'
    };
  }

  private selectMultipleDenominations(available: number[], min: number, max: number): number[] {
    const count = generateRandomNumber(max, 0, min);
    const selected: number[] = [];
    const remaining = [...available];

    for (let i = 0; i < count && remaining.length > 0; i++) {
      const index = Math.floor(Math.random() * remaining.length);
      selected.push(remaining[index]);
      remaining.splice(index, 1);
    }

    return selected;
  }

  getDenominationName(denomination: number): string {
    if (denomination >= 500) {
      return CoinRecognitionModel.UK_NOTES[denomination as keyof typeof CoinRecognitionModel.UK_NOTES]?.name || 'unknown';
    }
    return CoinRecognitionModel.UK_COINS[denomination as keyof typeof CoinRecognitionModel.UK_COINS]?.name || 'unknown';
  }

  formatDenomination(denomination: number): string {
    if (denomination >= 500) {
      return CoinRecognitionModel.UK_NOTES[denomination as keyof typeof CoinRecognitionModel.UK_NOTES]?.format || `Â£${denomination/100}`;
    }
    return CoinRecognitionModel.UK_COINS[denomination as keyof typeof CoinRecognitionModel.UK_COINS]?.format || `${denomination}p`;
  }
}
```
--- END FILE: lib\math-engine\models\coin-recognition.model.ts ---

--- START FILE: lib\math-engine\models\comparison.model.ts ---
```typescript
import {
  IMathModel,
  ComparisonDifficultyParams,
  ComparisonOutput,
  ComparisonOption
} from '@/lib/types';
import {
  generateRandomNumber,
  randomChoice
} from '@/lib/utils';

export class ComparisonModel implements IMathModel<ComparisonDifficultyParams, ComparisonOutput> {
  public readonly model_id = "COMPARISON";

  generate(params: ComparisonDifficultyParams): ComparisonOutput {
    const options = this.generateOptions(params);
    const analysis = this.analyzeOptions(options, params);

    return {
      operation: "COMPARISON",
      options,
      comparison_type: params.comparison_type,
      winner_index: analysis.winner_index,
      difference: analysis.difference,
      explanation: analysis.explanation
    };
  }

  getDefaultParams(year: number): ComparisonDifficultyParams {
    if (year <= 2) {
      return {
        value_count: 2,
        value_max: 50,
        comparison_type: "direct",
        decimal_places: 0,
        include_calculation: false
      };
    } else if (year <= 4) {
      return {
        value_count: 2,
        value_max: 200,
        comparison_type: randomChoice(["direct", "unit_rate"]),
        decimal_places: 2,
        include_calculation: true
      };
    } else {
      return {
        value_count: randomChoice([2, 3]),
        value_max: 1000,
        comparison_type: randomChoice(["direct", "unit_rate", "better_value"]),
        decimal_places: 2,
        include_calculation: true
      };
    }
  }

  private generateOptions(params: ComparisonDifficultyParams): ComparisonOption[] {
    const options: ComparisonOption[] = [];

    for (let i = 0; i < params.value_count; i++) {
      const option = this.generateSingleOption(params, i);
      options.push(option);
    }

    return options;
  }

  private generateSingleOption(params: ComparisonDifficultyParams, index: number): ComparisonOption {
    const value = generateRandomNumber(
      params.value_max,
      params.decimal_places,
      1,
      params.decimal_places > 0 ? 0.01 : 1
    );

    const option: ComparisonOption = {
      value,
      description: this.generateDescription(value, params.comparison_type, index)
    };

    if (params.comparison_type === "unit_rate" || params.comparison_type === "better_value") {
      option.quantity = this.generateQuantity(params);
      option.unit_rate = this.calculateUnitRate(value, option.quantity);
    }

    return option;
  }

  private generateQuantity(params: ComparisonDifficultyParams): number {
    // Generate reasonable quantities for unit rate calculations
    const quantities = [100, 250, 500, 750, 1000, 1500, 2000];
    return randomChoice(quantities.filter(q => q <= params.value_max * 10));
  }

  private calculateUnitRate(totalValue: number, quantity: number): number {
    const rate = totalValue / quantity;
    return Math.round(rate * 1000) / 1000; // Round to 3 decimal places
  }

  private generateDescription(value: number, comparisonType: string, index: number): string {
    const letters = ['A', 'B', 'C', 'D'];
    const letter = letters[index] || `Option ${index + 1}`;

    switch (comparisonType) {
      case "direct":
        return `${letter}: Â£${value.toFixed(2)}`;
      
      case "unit_rate":
      case "better_value":
        return `${letter}: Â£${value.toFixed(2)}`;
      
      default:
        return `${letter}: Â£${value.toFixed(2)}`;
    }
  }

  private analyzeOptions(options: ComparisonOption[], params: ComparisonDifficultyParams): {
    winner_index: number;
    difference?: number;
    explanation: string;
  } {
    switch (params.comparison_type) {
      case "direct":
        return this.analyzeDirectComparison(options, params);
      
      case "unit_rate":
      case "better_value":
        return this.analyzeUnitRateComparison(options, params);
      
      default:
        return this.analyzeDirectComparison(options, params);
    }
  }

  private analyzeDirectComparison(options: ComparisonOption[], params: ComparisonDifficultyParams): {
    winner_index: number;
    difference?: number;
    explanation: string;
  } {
    // Find the option with the highest value
    let maxValue = options[0].value;
    let maxIndex = 0;

    options.forEach((option, index) => {
      if (option.value > maxValue) {
        maxValue = option.value;
        maxIndex = index;
      }
    });

    // Calculate difference from the second highest
    const sortedValues = options.map(o => o.value).sort((a, b) => b - a);
    const difference = sortedValues[0] - sortedValues[1];

    const explanation = params.include_calculation
      ? `Option ${String.fromCharCode(65 + maxIndex)} has the highest value at Â£${maxValue.toFixed(2)}, which is Â£${difference.toFixed(2)} more than the next highest.`
      : `Option ${String.fromCharCode(65 + maxIndex)} is worth more.`;

    return {
      winner_index: maxIndex,
      difference: Math.round(difference * 100) / 100,
      explanation
    };
  }

  private analyzeUnitRateComparison(options: ComparisonOption[], params: ComparisonDifficultyParams): {
    winner_index: number;
    difference?: number;
    explanation: string;
  } {
    // Find the option with the best unit rate (lowest cost per unit)
    let bestRate = options[0].unit_rate || Infinity;
    let bestIndex = 0;

    options.forEach((option, index) => {
      const rate = option.unit_rate || Infinity;
      if (rate < bestRate) {
        bestRate = rate;
        bestIndex = index;
      }
    });

    // Calculate rate difference
    const sortedRates = options
      .map(o => o.unit_rate || Infinity)
      .filter(r => r !== Infinity)
      .sort((a, b) => a - b);
    
    const difference = sortedRates.length > 1 ? sortedRates[1] - sortedRates[0] : 0;

    const bestOption = options[bestIndex];
    const explanation = params.include_calculation
      ? `Option ${String.fromCharCode(65 + bestIndex)} offers the best value at Â£${bestRate.toFixed(3)} per unit (Â£${bestOption.value.toFixed(2)} for ${bestOption.quantity} units).`
      : `Option ${String.fromCharCode(65 + bestIndex)} is better value.`;

    return {
      winner_index: bestIndex,
      difference: Math.round(difference * 1000) / 1000,
      explanation
    };
  }

  // Helper method to format comparison for display
  static formatComparison(option: ComparisonOption, includeRate: boolean = false): string {
    let formatted = `Â£${option.value.toFixed(2)}`;
    
    if (option.quantity && includeRate) {
      formatted += ` for ${option.quantity} units`;
      if (option.unit_rate) {
        formatted += ` (Â£${option.unit_rate.toFixed(3)} per unit)`;
      }
    }
    
    return formatted;
  }
}
```
--- END FILE: lib\math-engine\models\comparison.model.ts ---

--- START FILE: lib\math-engine\models\conversion.model.ts ---
```typescript
import {
  IMathModel,
  ConversionDifficultyParams,
  ConversionOutput
} from '@/lib/types';
import {
  generateRandomNumber,
  randomChoice
} from '@/lib/utils';

export class ConversionModel implements IMathModel<ConversionDifficultyParams, ConversionOutput> {
  public readonly model_id = "CONVERSION";

  private static readonly COMMON_CONVERSIONS = [
    { from_unit: "pence", to_unit: "pounds", conversion_factor: 0.01 },
    { from_unit: "pounds", to_unit: "pence", conversion_factor: 100 },
    { from_unit: "grams", to_unit: "kilograms", conversion_factor: 0.001 },
    { from_unit: "kilograms", to_unit: "grams", conversion_factor: 1000 },
    { from_unit: "millilitres", to_unit: "litres", conversion_factor: 0.001 },
    { from_unit: "litres", to_unit: "millilitres", conversion_factor: 1000 },
    { from_unit: "millimetres", to_unit: "centimetres", conversion_factor: 0.1 },
    { from_unit: "centimetres", to_unit: "millimetres", conversion_factor: 10 },
    { from_unit: "centimetres", to_unit: "metres", conversion_factor: 0.01 },
    { from_unit: "metres", to_unit: "centimetres", conversion_factor: 100 },
    { from_unit: "metres", to_unit: "kilometres", conversion_factor: 0.001 },
    { from_unit: "kilometres", to_unit: "metres", conversion_factor: 1000 }
  ];

  generate(params: ConversionDifficultyParams): ConversionOutput {
    const conversion = this.selectConversion(params);
    const originalValue = this.generateValue(params, conversion);
    const convertedValue = this.performConversion(originalValue, conversion.conversion_factor);

    return {
      operation: "CONVERSION",
      original_value: originalValue,
      original_unit: conversion.from_unit,
      converted_value: convertedValue,
      converted_unit: conversion.to_unit,
      conversion_factor: conversion.conversion_factor,
      formatted_original: this.formatValue(originalValue, conversion.from_unit, params.decimal_places),
      formatted_converted: this.formatValue(convertedValue, conversion.to_unit, params.decimal_places)
    };
  }

  getDefaultParams(year: number): ConversionDifficultyParams {
    if (year <= 2) {
      return {
        value_max: 100,
        conversion_types: [
          { from_unit: "pence", to_unit: "pounds", conversion_factor: 0.01 }
        ],
        decimal_places: 2
      };
    } else if (year <= 4) {
      return {
        value_max: 1000,
        conversion_types: [
          { from_unit: "pence", to_unit: "pounds", conversion_factor: 0.01 },
          { from_unit: "pounds", to_unit: "pence", conversion_factor: 100 },
          { from_unit: "centimetres", to_unit: "metres", conversion_factor: 0.01 },
          { from_unit: "metres", to_unit: "centimetres", conversion_factor: 100 }
        ],
        decimal_places: 2
      };
    } else {
      return {
        value_max: 10000,
        conversion_types: ConversionModel.COMMON_CONVERSIONS,
        decimal_places: 3
      };
    }
  }

  private selectConversion(params: ConversionDifficultyParams): {
    from_unit: string;
    to_unit: string;
    conversion_factor: number;
  } {
    return randomChoice(params.conversion_types);
  }

  private generateValue(
    params: ConversionDifficultyParams,
    conversion: { from_unit: string; to_unit: string; conversion_factor: number }
  ): number {
    // Adjust max value based on conversion to avoid extreme results
    let adjustedMax = params.value_max;
    
    if (conversion.conversion_factor > 10) {
      // For conversions that multiply (e.g., pounds to pence), use smaller input values
      adjustedMax = Math.min(adjustedMax, 100);
    }

    return generateRandomNumber(
      adjustedMax,
      conversion.from_unit === "pounds" ? 2 : 0, // Use decimals for pounds
      1,
      0.01
    );
  }

  private performConversion(value: number, factor: number): number {
    const result = value * factor;
    // Round to avoid floating point precision issues
    return Math.round(result * 1000) / 1000;
  }

  private formatValue(value: number, unit: string, decimalPlaces: number): string {
    // Special formatting for currency
    if (unit === "pounds") {
      return `Â£${value.toFixed(2)}`;
    } else if (unit === "pence") {
      return `${Math.round(value)}p`;
    }
    
    // Standard formatting for other units
    const formattedValue = value % 1 === 0 ? value.toString() : value.toFixed(decimalPlaces);
    return `${formattedValue} ${unit}`;
  }

  // Helper method to get unit abbreviations
  static getUnitAbbreviation(unit: string): string {
    const abbreviations: { [key: string]: string } = {
      pounds: "Â£",
      pence: "p",
      kilograms: "kg",
      grams: "g",
      litres: "l",
      millilitres: "ml",
      metres: "m",
      centimetres: "cm",
      millimetres: "mm",
      kilometres: "km"
    };
    
    return abbreviations[unit] || unit;
  }

  // Helper method to determine if result should be whole number
  static shouldBeWholeNumber(unit: string): boolean {
    return ["pence", "grams", "millilitres", "millimetres", "centimetres"].includes(unit);
  }
}
```
--- END FILE: lib\math-engine\models\conversion.model.ts ---

--- START FILE: lib\math-engine\models\counting.model.ts ---
```typescript
import {
  IMathModel,
  CountingDifficultyParams,
  CountingOutput
} from '@/lib/types';
import {
  randomChoice
} from '@/lib/utils';

export class CountingModel implements IMathModel<CountingDifficultyParams, CountingOutput> {
  public readonly model_id = "COUNTING";

  // UK coin denominations in pence
  private static readonly UK_DENOMINATIONS = [1, 2, 5, 10, 20, 50, 100, 200];

  generate(params: CountingDifficultyParams): CountingOutput {
    const solutions = this.findSolutions(params);
    const selectedSolution = this.selectBestSolution(solutions, params);

    return {
      operation: "COUNTING",
      target_value: params.target_value,
      solutions: selectedSolution.solution,
      total_coins: selectedSolution.total_coins,
      is_minimum_solution: selectedSolution.is_minimum
    };
  }

  getDefaultParams(year: number): CountingDifficultyParams {
    if (year <= 2) {
      return {
        target_value: 50, // 50p or less
        allowed_denominations: [1, 2, 5, 10], // Basic coins
        solution_type: "exact",
        max_coins: 10
      };
    } else if (year <= 4) {
      return {
        target_value: 100, // Â£1 or less
        allowed_denominations: [1, 2, 5, 10, 20, 50], 
        solution_type: "minimum",
        max_coins: 15
      };
    } else {
      return {
        target_value: 500, // Â£5 or less
        allowed_denominations: [1, 2, 5, 10, 20, 50, 100, 200],
        solution_type: "multiple",
        max_coins: 20
      };
    }
  }

  private findSolutions(params: CountingDifficultyParams): Array<{
    solution: Array<{ denomination: number; count: number }>;
    total_coins: number;
    is_minimum: boolean;
  }> {
    const solutions: Array<{
      solution: Array<{ denomination: number; count: number }>;
      total_coins: number;
      is_minimum: boolean;
    }> = [];

    // Find minimum coin solution using greedy algorithm
    const minSolution = this.findMinimumCoinSolution(params);
    if (minSolution) {
      solutions.push({ ...minSolution, is_minimum: true });
    }

    // Find alternative solutions if requested
    if (params.solution_type === "multiple") {
      const alternatives = this.findAlternativeSolutions(params, 3);
      solutions.push(...alternatives.map(alt => ({ ...alt, is_minimum: false })));
    }

    return solutions;
  }

  private findMinimumCoinSolution(params: CountingDifficultyParams): {
    solution: Array<{ denomination: number; count: number }>;
    total_coins: number;
  } | null {
    const denominations = [...params.allowed_denominations].sort((a, b) => b - a);
    let remainingValue = params.target_value;
    const solution: Array<{ denomination: number; count: number }> = [];
    let totalCoins = 0;

    for (const denom of denominations) {
      if (remainingValue >= denom) {
        const count = Math.floor(remainingValue / denom);
        if (count > 0 && totalCoins + count <= params.max_coins) {
          solution.push({ denomination: denom, count });
          remainingValue -= denom * count;
          totalCoins += count;
        }
      }
    }

    // Check if we found an exact solution
    if (remainingValue === 0 && totalCoins <= params.max_coins) {
      return { solution, total_coins: totalCoins };
    }

    return null;
  }

  private findAlternativeSolutions(
    params: CountingDifficultyParams,
    maxAlternatives: number
  ): Array<{
    solution: Array<{ denomination: number; count: number }>;
    total_coins: number;
  }> {
    const alternatives: Array<{
      solution: Array<{ denomination: number; count: number }>;
      total_coins: number;
    }> = [];

    // Generate alternative solutions by varying coin usage
    const denominations = params.allowed_denominations.sort((a, b) => b - a);
    
    for (let attempt = 0; attempt < maxAlternatives * 3 && alternatives.length < maxAlternatives; attempt++) {
      const solution = this.generateAlternativeSolution(params, denominations);
      if (solution && !this.isDuplicateSolution(solution, alternatives)) {
        alternatives.push(solution);
      }
    }

    return alternatives;
  }

  private generateAlternativeSolution(
    params: CountingDifficultyParams,
    denominations: number[]
  ): {
    solution: Array<{ denomination: number; count: number }>;
    total_coins: number;
  } | null {
    let remainingValue = params.target_value;
    const solution: Array<{ denomination: number; count: number }> = [];
    let totalCoins = 0;

    // Randomly vary the approach by sometimes using smaller denominations
    for (let i = 0; i < denominations.length; i++) {
      const denom = denominations[i];
      
      if (remainingValue >= denom) {
        const maxCount = Math.floor(remainingValue / denom);
        const remainingCoinBudget = params.max_coins - totalCoins;
        
        // Sometimes use fewer large denominations to create variation
        const useAlternative = Math.random() < 0.4 && i < denominations.length - 1;
        const count = useAlternative 
          ? Math.max(0, Math.floor(maxCount * Math.random()))
          : Math.min(maxCount, remainingCoinBudget);

        if (count > 0) {
          solution.push({ denomination: denom, count });
          remainingValue -= denom * count;
          totalCoins += count;
        }
      }
    }

    if (remainingValue === 0 && totalCoins <= params.max_coins) {
      return { solution, total_coins: totalCoins };
    }

    return null;
  }

  private isDuplicateSolution(
    newSolution: { solution: Array<{ denomination: number; count: number }> },
    existing: Array<{ solution: Array<{ denomination: number; count: number }> }>
  ): boolean {
    return existing.some(existing => 
      this.areSolutionsEqual(newSolution.solution, existing.solution)
    );
  }

  private areSolutionsEqual(
    sol1: Array<{ denomination: number; count: number }>,
    sol2: Array<{ denomination: number; count: number }>
  ): boolean {
    if (sol1.length !== sol2.length) return false;
    
    const sorted1 = [...sol1].sort((a, b) => a.denomination - b.denomination);
    const sorted2 = [...sol2].sort((a, b) => a.denomination - b.denomination);
    
    return sorted1.every((coin, index) => 
      coin.denomination === sorted2[index].denomination &&
      coin.count === sorted2[index].count
    );
  }

  private selectBestSolution(
    solutions: Array<{
      solution: Array<{ denomination: number; count: number }>;
      total_coins: number;
      is_minimum: boolean;
    }>,
    params: CountingDifficultyParams
  ): {
    solution: Array<{ denomination: number; count: number }>;
    total_coins: number;
    is_minimum: boolean;
  } {
    if (solutions.length === 0) {
      // Fallback solution
      return {
        solution: [{ denomination: 1, count: params.target_value }],
        total_coins: params.target_value,
        is_minimum: false
      };
    }

    // For "minimum" type, prefer the solution with fewest coins
    if (params.solution_type === "minimum") {
      return solutions.reduce((best, current) => 
        current.total_coins < best.total_coins ? current : best
      );
    }

    // For other types, return a random valid solution
    return randomChoice(solutions);
  }
}
```
--- END FILE: lib\math-engine\models\counting.model.ts ---

--- START FILE: lib\math-engine\models\division.model.ts ---
```typescript
import {
  IMathModel,
  DivisionDifficultyParams,
  DivisionOutput,
  DecimalFormatted
} from '@/lib/types';
import {
  generateRandomNumber,
  formatDecimal,
  randomInt
} from '@/lib/utils';

export class DivisionModel implements IMathModel<DivisionDifficultyParams, DivisionOutput> {
  public readonly model_id = "DIVISION";

  generate(params: DivisionDifficultyParams): DivisionOutput {
    const { dividend, divisor } = this.generateOperands(params);
    const { quotient, remainder } = this.calculateDivision(dividend, divisor, params);
    const decimalFormatted = this.formatOutput(dividend, divisor, quotient, params.decimal_places);

    return {
      operation: "DIVISION",
      dividend,
      divisor,
      quotient,
      remainder,
      decimal_formatted: decimalFormatted
    };
  }

  getDefaultParams(year: number): DivisionDifficultyParams {
    if (year <= 2) {
      return {
        dividend_max: 20,
        divisor_max: 5,
        decimal_places: 0,
        allow_remainder: false,
        ensure_whole: true
      };
    } else if (year <= 4) {
      return {
        dividend_max: 100,
        divisor_max: 10,
        decimal_places: year === 4 ? 2 : 0,
        allow_remainder: year === 4,
        ensure_whole: year === 3
      };
    } else {
      return {
        dividend_max: 1000,
        divisor_max: 100,
        decimal_places: 3,
        allow_remainder: true,
        ensure_whole: false
      };
    }
  }

  private generateOperands(params: DivisionDifficultyParams): { dividend: number; divisor: number } {
    if (params.ensure_whole) {
      // Generate divisor first, then create dividend as multiple
      const divisor = randomInt(2, params.divisor_max);
      const multiplier = randomInt(1, Math.floor(params.dividend_max / divisor));
      const dividend = divisor * multiplier;
      
      return { dividend, divisor };
    } else {
      // Generate random dividend and divisor
      let dividend = generateRandomNumber(
        params.dividend_max,
        params.decimal_places,
        1,
        params.decimal_places > 0 ? 0.01 : 1
      );
      
      let divisor = generateRandomNumber(
        params.divisor_max,
        0, // Divisor typically whole number
        1,
        1
      );

      // Ensure divisor is not zero
      if (divisor === 0) {
        divisor = 1;
      }

      // If no remainder allowed and decimals are 0, adjust dividend
      if (!params.allow_remainder && params.decimal_places === 0) {
        dividend = Math.floor(dividend / divisor) * divisor;
      }

      return { dividend, divisor };
    }
  }

  private calculateDivision(
    dividend: number,
    divisor: number,
    params: DivisionDifficultyParams
  ): { quotient: number; remainder: number } {
    if (params.decimal_places > 0) {
      const quotient = dividend / divisor;
      return {
        quotient: Math.round(quotient * Math.pow(10, params.decimal_places)) / Math.pow(10, params.decimal_places),
        remainder: 0
      };
    } else {
      const quotient = Math.floor(dividend / divisor);
      const remainder = params.allow_remainder ? dividend % divisor : 0;
      return { quotient, remainder };
    }
  }

  private formatOutput(
    dividend: number,
    divisor: number,
    quotient: number,
    decimalPlaces: number
  ): DecimalFormatted {
    return {
      operands: [
        formatDecimal(dividend, decimalPlaces),
        formatDecimal(divisor, 0)
      ],
      quotient: formatDecimal(quotient, decimalPlaces),
      result: formatDecimal(quotient, decimalPlaces)
    };
  }
}
```
--- END FILE: lib\math-engine\models\division.model.ts ---

--- START FILE: lib\math-engine\models\fraction.model.ts ---
```typescript
import {
  IMathModel,
  FractionDifficultyParams,
  FractionOutput
} from '@/lib/types';
import {
  generateRandomNumber,
  randomChoice
} from '@/lib/utils';

export class FractionModel implements IMathModel<FractionDifficultyParams, FractionOutput> {
  public readonly model_id = "FRACTION";

  generate(params: FractionDifficultyParams): FractionOutput {
    const wholeValue = this.generateWholeValue(params);
    const fraction = this.selectFraction(params, wholeValue);
    const result = this.calculateFraction(wholeValue, fraction, params);

    return {
      operation: "FRACTION",
      whole_value: wholeValue,
      fraction: {
        numerator: fraction.numerator,
        denominator: fraction.denominator,
        formatted: `${fraction.numerator}/${fraction.denominator}`
      },
      result: result.final_result,
      calculation_steps: {
        division_result: result.division_result,
        final_result: result.final_result
      }
    };
  }

  getDefaultParams(year: number): FractionDifficultyParams {
    if (year <= 2) {
      return {
        whole_value_max: 20,
        fraction_types: [
          { numerator: 1, denominator: 2 }
        ],
        decimal_places: 0,
        ensure_whole_result: true
      };
    } else if (year <= 4) {
      return {
        whole_value_max: 100,
        fraction_types: [
          { numerator: 1, denominator: 2 },
          { numerator: 1, denominator: 3 },
          { numerator: 1, denominator: 4 },
          { numerator: 3, denominator: 4 }
        ],
        decimal_places: 2,
        ensure_whole_result: false
      };
    } else {
      return {
        whole_value_max: 1000,
        fraction_types: [
          { numerator: 1, denominator: 2 },
          { numerator: 1, denominator: 3 },
          { numerator: 2, denominator: 3 },
          { numerator: 1, denominator: 4 },
          { numerator: 3, denominator: 4 },
          { numerator: 1, denominator: 5 },
          { numerator: 2, denominator: 5 },
          { numerator: 3, denominator: 5 },
          { numerator: 4, denominator: 5 }
        ],
        decimal_places: 2,
        ensure_whole_result: false
      };
    }
  }

  private generateWholeValue(params: FractionDifficultyParams): number {
    if (params.ensure_whole_result) {
      // Generate values that will result in whole numbers for common fractions
      const fraction = randomChoice(params.fraction_types);
      const multiplier = Math.floor(Math.random() * 10) + 1;
      return fraction.denominator * multiplier;
    } else {
      return generateRandomNumber(
        params.whole_value_max,
        params.decimal_places,
        1,
        params.decimal_places > 0 ? 0.01 : 1
      );
    }
  }

  private selectFraction(
    params: FractionDifficultyParams,
    wholeValue: number
  ): { numerator: number; denominator: number } {
    if (params.ensure_whole_result) {
      // Filter fractions that will give whole results
      const validFractions = params.fraction_types.filter(f => 
        (wholeValue * f.numerator) % f.denominator === 0
      );
      return validFractions.length > 0 
        ? randomChoice(validFractions)
        : params.fraction_types[0];
    }
    
    return randomChoice(params.fraction_types);
  }

  private calculateFraction(
    wholeValue: number,
    fraction: { numerator: number; denominator: number },
    params: FractionDifficultyParams
  ): { division_result: number; final_result: number } {
    const division_result = wholeValue / fraction.denominator;
    const final_result = division_result * fraction.numerator;
    
    // Round to specified decimal places
    const factor = Math.pow(10, params.decimal_places);
    
    return {
      division_result: Math.round(division_result * factor) / factor,
      final_result: Math.round(final_result * factor) / factor
    };
  }
}
```
--- END FILE: lib\math-engine\models\fraction.model.ts ---

--- START FILE: lib\math-engine\models\linear-equation.model.ts ---
```typescript
import {
  IMathModel,
  LinearEquationDifficultyParams,
  LinearEquationOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class LinearEquationModel implements IMathModel<LinearEquationDifficultyParams, LinearEquationOutput> {
  public readonly model_id = "LINEAR_EQUATION";

  generate(params: LinearEquationDifficultyParams): LinearEquationOutput {
    const m = this.generateSlope(params);
    const c = this.generateIntercept(params);
    
    // Generate x values for evaluation
    const xValues = this.generateXValues(params);
    
    // Calculate corresponding y values
    const evaluations = xValues.map(x => ({
      x,
      y: this.evaluateEquation(m, c, x, params)
    }));

    // Generate coordinate pairs for the equation
    const coordinates = evaluations.map(evaluation => ({ x: evaluation.x, y: evaluation.y }));

    // Determine the problem type
    const problemType = this.selectProblemType(params);
    
    return {
      operation: "LINEAR_EQUATION",
      slope: m,
      intercept: c,
      equation: {
        slope: m,
        intercept: c,
        formatted: this.formatEquation(m, c)
      },
      problem_type: problemType,
      x_values: xValues,
      evaluations,
      coordinates,
      target_x: problemType === 'solve_for_x' ? randomChoice(xValues) : undefined,
      target_y: problemType === 'solve_for_y' ? randomChoice(evaluations).y : undefined
    } as any;
  }

  getDefaultParams(year: number): LinearEquationDifficultyParams {
    if (year <= 3) {
      // Simple linear patterns
      return {
        slope_range: { min: 1, max: 3 },
        intercept_range: { min: 0, max: 5 },
        x_range: { min: 0, max: 10 },
        decimal_places: 0,
        allow_negative_slope: false,
        allow_negative_intercept: false,
        problem_types: ['evaluate', 'complete_table'],
        x_value_count: 3
      };
    } else if (year <= 4) {
      return {
        slope_range: { min: 1, max: 5 },
        intercept_range: { min: -5, max: 10 },
        x_range: { min: 0, max: 15 },
        decimal_places: 1,
        allow_negative_slope: false,
        allow_negative_intercept: true,
        problem_types: ['evaluate', 'complete_table', 'solve_for_y'],
        x_value_count: 4
      };
    } else {
      return {
        slope_range: { min: -5, max: 5 },
        intercept_range: { min: -10, max: 10 },
        x_range: { min: -10, max: 20 },
        decimal_places: 2,
        allow_negative_slope: true,
        allow_negative_intercept: true,
        problem_types: ['evaluate', 'complete_table', 'solve_for_y', 'solve_for_x'],
        x_value_count: 5
      };
    }
  }

  private generateSlope(params: LinearEquationDifficultyParams): number {
    let slope: number;
    let attempts = 0;
    const maxAttempts = 100;
    
    // Determine valid range for slopes
    let minSlope = params.slope_range.min;
    let maxSlope = params.slope_range.max;
    
    // Adjust range based on constraints
    if (!params.allow_negative_slope) {
      minSlope = Math.max(minSlope, 1); // Ensure positive and not zero
    }
    
    // Ensure we have a valid range
    if (minSlope >= maxSlope) {
      return minSlope;
    }
    
    do {
      slope = generateRandomNumber(
        maxSlope,
        params.decimal_places,
        minSlope
      );
      attempts++;
      
      // Safety valve to prevent infinite loops
      if (attempts > maxAttempts) {
        slope = minSlope === 0 ? 1 : minSlope; // Safe fallback, never zero
        break;
      }
    } while (
      slope === 0 || // Avoid horizontal lines
      (!params.allow_negative_slope && slope < 0)
    );

    return slope;
  }

  private generateIntercept(params: LinearEquationDifficultyParams): number {
    let minIntercept = params.intercept_range.min;
    let maxIntercept = params.intercept_range.max;
    
    // Adjust range if negative intercepts not allowed
    if (!params.allow_negative_intercept) {
      minIntercept = Math.max(minIntercept, 0);
    }
    
    // Ensure valid range
    if (minIntercept > maxIntercept) {
      return minIntercept;
    }
    
    return generateRandomNumber(
      maxIntercept,
      params.decimal_places,
      minIntercept
    );
  }

  private generateXValues(params: LinearEquationDifficultyParams): number[] {
    const xValues: number[] = [];
    const usedValues = new Set<number>();
    let attempts = 0;
    const maxAttempts = 1000;
    
    // Calculate available range
    const rangeSize = params.x_range.max - params.x_range.min + 1;
    const requestedCount = Math.min(params.x_value_count, rangeSize);

    while (xValues.length < requestedCount) {
      const x = generateRandomNumber(
        params.x_range.max,
        0, // X values are typically integers
        params.x_range.min
      );

      if (!usedValues.has(x)) {
        xValues.push(x);
        usedValues.add(x);
      }
      
      attempts++;
      // Safety valve - if we can't generate enough unique values, fill systematically
      if (attempts > maxAttempts) {
        for (let i = params.x_range.min; i <= params.x_range.max && xValues.length < requestedCount; i++) {
          if (!usedValues.has(i)) {
            xValues.push(i);
            usedValues.add(i);
          }
        }
        break;
      }
    }

    return xValues.sort((a, b) => a - b);
  }

  private evaluateEquation(
    m: number, 
    c: number, 
    x: number, 
    params: LinearEquationDifficultyParams
  ): number {
    const y = m * x + c;
    return Math.round(y * Math.pow(10, params.decimal_places)) / Math.pow(10, params.decimal_places);
  }

  private selectProblemType(params: LinearEquationDifficultyParams): string {
    return randomChoice(params.problem_types);
  }

  private formatEquation(m: number, c: number): string {
    // Handle special cases for slope
    let slopeStr = '';
    if (m === 1) {
      slopeStr = '';
    } else if (m === -1) {
      slopeStr = '-';
    } else {
      slopeStr = m.toString();
    }

    // Handle intercept
    let interceptStr = '';
    if (c > 0) {
      interceptStr = ` + ${c}`;
    } else if (c < 0) {
      interceptStr = ` - ${Math.abs(c)}`;
    }
    // If c = 0, no intercept term

    // Build equation
    if (slopeStr === '' && interceptStr === '') {
      return 'y = x';
    } else if (slopeStr === '' && interceptStr !== '') {
      return `y = x${interceptStr}`;
    } else if (slopeStr !== '' && interceptStr === '') {
      return `y = ${slopeStr}x`;
    } else {
      return `y = ${slopeStr}x${interceptStr}`;
    }
  }
}
```
--- END FILE: lib\math-engine\models\linear-equation.model.ts ---

--- START FILE: lib\math-engine\models\mixed-money-units.model.ts ---
```typescript
import {
  IMathModel,
  MixedMoneyUnitsDifficultyParams,
  MixedMoneyUnitsOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class MixedMoneyUnitsModel implements IMathModel<MixedMoneyUnitsDifficultyParams, MixedMoneyUnitsOutput> {
  public readonly model_id = "MIXED_MONEY_UNITS";

  generate(params: MixedMoneyUnitsDifficultyParams): MixedMoneyUnitsOutput {
    const problemType = this.selectProblemType(params);
    
    switch (problemType) {
      case 'convert_units':
        return this.generateConvertUnitsProblem(params);
      case 'add_mixed_units':
        return this.generateAddMixedUnitsProblem(params);
      case 'subtract_mixed_units':
        return this.generateSubtractMixedUnitsProblem(params);
      case 'compare_mixed_amounts':
        return this.generateCompareMixedAmountsProblem(params);
      default:
        return this.generateConvertUnitsProblem(params);
    }
  }

  getDefaultParams(year: number): MixedMoneyUnitsDifficultyParams {
    if (year <= 2) {
      return {
        pounds_range: { min: 1, max: 5 },
        pence_range: { min: 1, max: 99 },
        problem_types: ['convert_units', 'add_mixed_units'],
        decimal_places: 0,
        allow_complex_operations: false,
        include_comparisons: false,
        max_operands: 2
      };
    } else if (year <= 3) {
      return {
        pounds_range: { min: 1, max: 20 },
        pence_range: { min: 1, max: 99 },
        problem_types: ['convert_units', 'add_mixed_units', 'subtract_mixed_units'],
        decimal_places: 2,
        allow_complex_operations: true,
        include_comparisons: true,
        max_operands: 3
      };
    } else {
      return {
        pounds_range: { min: 1, max: 100 },
        pence_range: { min: 1, max: 99 },
        problem_types: ['convert_units', 'add_mixed_units', 'subtract_mixed_units', 'compare_mixed_amounts'],
        decimal_places: 2,
        allow_complex_operations: true,
        include_comparisons: true,
        max_operands: 4
      };
    }
  }

  private selectProblemType(params: MixedMoneyUnitsDifficultyParams): string {
    return randomChoice(params.problem_types);
  }

  private generateConvertUnitsProblem(params: MixedMoneyUnitsDifficultyParams): MixedMoneyUnitsOutput {
    const conversionType = randomChoice(['pounds_to_pence', 'pence_to_pounds', 'mixed_to_decimal']);
    
    let sourceAmount: { pounds: number; pence: number };
    let targetFormat: string;
    let result: number;

    switch (conversionType) {
      case 'pounds_to_pence':
        sourceAmount = { 
          pounds: generateRandomNumber(params.pounds_range.max, 0, params.pounds_range.min), 
          pence: 0 
        };
        targetFormat = 'pence';
        result = sourceAmount.pounds * 100;
        break;
      
      case 'pence_to_pounds':
        const totalPence = generateRandomNumber(params.pence_range.max + 200, 0, 100); // Ensure > 100p
        sourceAmount = { pounds: 0, pence: totalPence };
        targetFormat = 'pounds_decimal';
        result = totalPence / 100;
        break;
      
      case 'mixed_to_decimal':
      default:
        sourceAmount = {
          pounds: generateRandomNumber(params.pounds_range.max, 0, params.pounds_range.min),
          pence: generateRandomNumber(params.pence_range.max, 0, params.pence_range.min)
        };
        targetFormat = 'decimal';
        result = sourceAmount.pounds + (sourceAmount.pence / 100);
        break;
    }

    return {
      operation: "MIXED_MONEY_UNITS",
      problem_type: 'convert_units',
      source_amount: sourceAmount,
      target_format: targetFormat,
      result: result,
      formatted_source: this.formatMixedAmount(sourceAmount),
      formatted_result: this.formatResult(result, targetFormat),
      conversion_type: conversionType
    };
  }

  private generateAddMixedUnitsProblem(params: MixedMoneyUnitsDifficultyParams): MixedMoneyUnitsOutput {
    const operandCount = generateRandomNumber(params.max_operands, 0, 2);
    const operands: Array<{ pounds: number; pence: number }> = [];
    
    for (let i = 0; i < operandCount; i++) {
      operands.push({
        pounds: generateRandomNumber(params.pounds_range.max, 0, params.pounds_range.min),
        pence: generateRandomNumber(params.pence_range.max, 0, params.pence_range.min)
      });
    }

    const result = this.addMixedAmounts(operands);

    return {
      operation: "MIXED_MONEY_UNITS",
      problem_type: 'add_mixed_units',
      operands: operands,
      result: result.total_decimal,
      result_mixed: result,
      formatted_operands: operands.map(op => this.formatMixedAmount(op)),
      formatted_result: this.formatMixedAmount(result)
    };
  }

  private generateSubtractMixedUnitsProblem(params: MixedMoneyUnitsDifficultyParams): MixedMoneyUnitsOutput {
    // Generate minuend and subtrahend
    const minuend = {
      pounds: generateRandomNumber(params.pounds_range.max, 0, params.pounds_range.min + 2),
      pence: generateRandomNumber(params.pence_range.max, 0, params.pence_range.min)
    };

    const subtrahend = {
      pounds: generateRandomNumber(Math.min(minuend.pounds, params.pounds_range.max - 1), 0, params.pounds_range.min),
      pence: generateRandomNumber(params.pence_range.max, 0, params.pence_range.min)
    };

    // Ensure positive result
    const minuendDecimal = minuend.pounds + (minuend.pence / 100);
    const subtrahendDecimal = subtrahend.pounds + (subtrahend.pence / 100);
    
    if (minuendDecimal < subtrahendDecimal) {
      // Swap to ensure positive result
      const temp = { ...minuend };
      minuend.pounds = subtrahend.pounds + 1;
      minuend.pence = subtrahend.pence;
      subtrahend.pounds = temp.pounds;
      subtrahend.pence = temp.pence;
    }

    const result = this.subtractMixedAmounts(minuend, subtrahend);

    return {
      operation: "MIXED_MONEY_UNITS",
      problem_type: 'subtract_mixed_units',
      minuend: minuend,
      subtrahend: subtrahend,
      result: result.total_decimal,
      result_mixed: result,
      formatted_minuend: this.formatMixedAmount(minuend),
      formatted_subtrahend: this.formatMixedAmount(subtrahend),
      formatted_result: this.formatMixedAmount(result),
      requires_borrowing: minuend.pence < subtrahend.pence
    };
  }

  private generateCompareMixedAmountsProblem(params: MixedMoneyUnitsDifficultyParams): MixedMoneyUnitsOutput {
    const amount1 = {
      pounds: generateRandomNumber(params.pounds_range.max, 0, params.pounds_range.min),
      pence: generateRandomNumber(params.pence_range.max, 0, params.pence_range.min)
    };

    const amount2 = {
      pounds: generateRandomNumber(params.pounds_range.max, 0, params.pounds_range.min),
      pence: generateRandomNumber(params.pence_range.max, 0, params.pence_range.min)
    };

    const decimal1 = amount1.pounds + (amount1.pence / 100);
    const decimal2 = amount2.pounds + (amount2.pence / 100);
    
    const comparison = decimal1 > decimal2 ? 'greater' : 
                      decimal1 < decimal2 ? 'less' : 'equal';

    return {
      operation: "MIXED_MONEY_UNITS",
      problem_type: 'compare_mixed_amounts',
      amount1: amount1,
      amount2: amount2,
      comparison_result: comparison,
      difference: Math.abs(decimal1 - decimal2),
      formatted_amount1: this.formatMixedAmount(amount1),
      formatted_amount2: this.formatMixedAmount(amount2),
      formatted_difference: this.formatDecimalAmount(Math.abs(decimal1 - decimal2))
    } as any;
  }

  private addMixedAmounts(amounts: Array<{ pounds: number; pence: number }>): { pounds: number; pence: number; total_decimal: number } {
    let totalPounds = 0;
    let totalPence = 0;

    for (const amount of amounts) {
      totalPounds += amount.pounds;
      totalPence += amount.pence;
    }

    // Handle pence overflow
    const extraPounds = Math.floor(totalPence / 100);
    totalPounds += extraPounds;
    totalPence = totalPence % 100;

    return {
      pounds: totalPounds,
      pence: totalPence,
      total_decimal: totalPounds + (totalPence / 100)
    };
  }

  private subtractMixedAmounts(
    minuend: { pounds: number; pence: number }, 
    subtrahend: { pounds: number; pence: number }
  ): { pounds: number; pence: number; total_decimal: number } {
    let resultPounds = minuend.pounds - subtrahend.pounds;
    let resultPence = minuend.pence - subtrahend.pence;

    // Handle borrowing
    if (resultPence < 0) {
      resultPence += 100;
      resultPounds -= 1;
    }

    return {
      pounds: Math.max(0, resultPounds),
      pence: Math.max(0, resultPence),
      total_decimal: Math.max(0, resultPounds + (resultPence / 100))
    };
  }

  private formatMixedAmount(amount: { pounds: number; pence: number }): string {
    if (amount.pounds === 0 && amount.pence > 0) {
      return `${amount.pence}p`;
    }
    if (amount.pence === 0 && amount.pounds > 0) {
      return `Â£${amount.pounds}`;
    }
    if (amount.pounds > 0 && amount.pence > 0) {
      return `Â£${amount.pounds} and ${amount.pence}p`;
    }
    return 'Â£0';
  }

  private formatDecimalAmount(amount: number): string {
    return `Â£${amount.toFixed(2)}`;
  }

  private formatResult(result: number, targetFormat: string): string {
    switch (targetFormat) {
      case 'pence':
        return `${result}p`;
      case 'pounds_decimal':
        return `Â£${result.toFixed(2)}`;
      case 'decimal':
        return `Â£${result.toFixed(2)}`;
      default:
        return `Â£${result.toFixed(2)}`;
    }
  }

  // Helper method to convert mixed amount to decimal
  toDecimal(amount: { pounds: number; pence: number }): number {
    return amount.pounds + (amount.pence / 100);
  }

  // Helper method to convert decimal to mixed amount
  fromDecimal(decimal: number): { pounds: number; pence: number } {
    const pounds = Math.floor(decimal);
    const pence = Math.round((decimal - pounds) * 100);
    
    return { pounds, pence };
  }
}
```
--- END FILE: lib\math-engine\models\mixed-money-units.model.ts ---

--- START FILE: lib\math-engine\models\money-combinations.model.ts ---
```typescript
import {
  IMathModel,
  MoneyCombinationsDifficultyParams,
  MoneyCombinationsOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class MoneyCombinationsModel implements IMathModel<MoneyCombinationsDifficultyParams, MoneyCombinationsOutput> {
  public readonly model_id = "MONEY_COMBINATIONS";

  private static readonly UK_DENOMINATIONS = [1, 2, 5, 10, 20, 50, 100, 200]; // In pence

  generate(params: MoneyCombinationsDifficultyParams): MoneyCombinationsOutput {
    const problemType = this.selectProblemType(params);
    
    switch (problemType) {
      case 'find_combinations':
        return this.generateFindCombinationsProblem(params);
      case 'make_amount':
        return this.generateMakeAmountProblem(params);
      case 'equivalent_amounts':
        return this.generateEquivalentAmountsProblem(params);
      case 'compare_combinations':
        return this.generateCompareCombinationsProblem(params);
      default:
        return this.generateFindCombinationsProblem(params);
    }
  }

  getDefaultParams(year: number): MoneyCombinationsDifficultyParams {
    if (year <= 2) {
      return {
        target_amount_range: { min: 5, max: 20 }, // 5p to 20p
        available_denominations: [1, 2, 5, 10],
        problem_types: ['find_combinations', 'make_amount'],
        max_combinations: 3,
        allow_notes: false,
        require_exact_combinations: true,
        decimal_places: 0
      };
    } else if (year <= 3) {
      return {
        target_amount_range: { min: 10, max: 100 }, // 10p to Â£1
        available_denominations: [1, 2, 5, 10, 20, 50, 100],
        problem_types: ['find_combinations', 'make_amount', 'equivalent_amounts'],
        max_combinations: 4,
        allow_notes: false,
        require_exact_combinations: true,
        decimal_places: 0
      };
    } else {
      return {
        target_amount_range: { min: 25, max: 500 }, // 25p to Â£5
        available_denominations: [1, 2, 5, 10, 20, 50, 100, 200],
        problem_types: ['find_combinations', 'equivalent_amounts', 'compare_combinations'],
        max_combinations: 5,
        allow_notes: true,
        require_exact_combinations: false,
        decimal_places: 2
      };
    }
  }

  private selectProblemType(params: MoneyCombinationsDifficultyParams): string {
    return randomChoice(params.problem_types);
  }

  private generateFindCombinationsProblem(params: MoneyCombinationsDifficultyParams): MoneyCombinationsOutput {
    const targetAmount = this.generateTargetAmount(params);
    const combinations = this.findAllCombinations(targetAmount, params);
    
    // Limit to max combinations for display
    const displayCombinations = combinations.slice(0, params.max_combinations);

    return {
      operation: "MONEY_COMBINATIONS",
      problem_type: 'find_combinations',
      target_amount: targetAmount,
      available_denominations: params.available_denominations,
      combinations: displayCombinations,
      total_combinations: combinations.length,
      formatted_target: this.formatAmount(targetAmount)
    };
  }

  private generateMakeAmountProblem(params: MoneyCombinationsDifficultyParams): MoneyCombinationsOutput {
    const targetAmount = this.generateTargetAmount(params);
    const combinations = this.findAllCombinations(targetAmount, params);
    
    // Choose one specific combination to present
    const selectedCombination = randomChoice(combinations);

    return {
      operation: "MONEY_COMBINATIONS",
      problem_type: 'make_amount',
      target_amount: targetAmount,
      available_denominations: params.available_denominations,
      combinations: [selectedCombination],
      total_combinations: combinations.length,
      formatted_target: this.formatAmount(targetAmount),
      specific_combination: selectedCombination
    };
  }

  private generateEquivalentAmountsProblem(params: MoneyCombinationsDifficultyParams): MoneyCombinationsOutput {
    const targetAmount = this.generateTargetAmount(params);
    const combinations = this.findAllCombinations(targetAmount, params);
    
    // Show 2-3 different ways to make the same amount
    const equivalentCombinations = combinations.slice(0, 3);

    return {
      operation: "MONEY_COMBINATIONS",
      problem_type: 'equivalent_amounts',
      target_amount: targetAmount,
      available_denominations: params.available_denominations,
      combinations: equivalentCombinations,
      total_combinations: combinations.length,
      formatted_target: this.formatAmount(targetAmount)
    };
  }

  private generateCompareCombinationsProblem(params: MoneyCombinationsDifficultyParams): MoneyCombinationsOutput {
    const targetAmount = this.generateTargetAmount(params);
    const combinations = this.findAllCombinations(targetAmount, params);
    
    // Compare combinations by coin count or other criteria
    const sortedByCount = [...combinations].sort((a, b) => {
      const countA = a.reduce((sum, coin) => sum + coin.count, 0);
      const countB = b.reduce((sum, coin) => sum + coin.count, 0);
      return countA - countB;
    });

    const comparisonCombinations = sortedByCount.slice(0, 2);

    return {
      operation: "MONEY_COMBINATIONS",
      problem_type: 'compare_combinations',
      target_amount: targetAmount,
      available_denominations: params.available_denominations,
      combinations: comparisonCombinations,
      total_combinations: combinations.length,
      formatted_target: this.formatAmount(targetAmount),
      comparison_criteria: 'fewest_coins'
    };
  }

  private generateTargetAmount(params: MoneyCombinationsDifficultyParams): number {
    let amount = generateRandomNumber(
      params.target_amount_range.max,
      params.decimal_places,
      params.target_amount_range.min
    );

    // Ensure the amount can be made with available denominations
    if (params.require_exact_combinations) {
      // Round to a value that can be made with available coins
      const minDenom = Math.min(...params.available_denominations);
      amount = Math.round(amount / minDenom) * minDenom;
    }

    return amount;
  }

  private findAllCombinations(
    targetAmount: number, 
    params: MoneyCombinationsDifficultyParams
  ): Array<Array<{ denomination: number; count: number; formatted: string }>> {
    const denominations = [...params.available_denominations].sort((a, b) => b - a);
    const combinations: Array<Array<{ denomination: number; count: number; formatted: string }>> = [];
    
    this.findCombinationsRecursive(
      Math.round(targetAmount), // Work in pence
      denominations,
      [],
      combinations,
      0
    );

    // Limit combinations to prevent excessive computation
    return combinations.slice(0, 10);
  }

  private findCombinationsRecursive(
    remaining: number,
    denominations: number[],
    currentCombination: Array<{ denomination: number; count: number }>,
    allCombinations: Array<Array<{ denomination: number; count: number; formatted: string }>>,
    denomIndex: number
  ): void {
    if (remaining === 0) {
      // Found a valid combination
      const formattedCombination = currentCombination
        .filter(coin => coin.count > 0)
        .map(coin => ({
          ...coin,
          formatted: this.formatDenomination(coin.denomination)
        }));
      
      if (formattedCombination.length > 0) {
        allCombinations.push(formattedCombination);
      }
      return;
    }

    if (denomIndex >= denominations.length || remaining < 0) {
      return;
    }

    const denom = denominations[denomIndex];
    const maxCount = Math.floor(remaining / denom);

    // Try different counts of this denomination
    for (let count = maxCount; count >= 0; count--) {
      const newCombination = [
        ...currentCombination,
        { denomination: denom, count }
      ];

      this.findCombinationsRecursive(
        remaining - (count * denom),
        denominations,
        newCombination,
        allCombinations,
        denomIndex + 1
      );
    }
  }

  private formatAmount(amount: number): string {
    if (amount >= 100) {
      const pounds = Math.floor(amount / 100);
      const pence = amount % 100;
      if (pence === 0) {
        return `Â£${pounds}`;
      }
      return `Â£${pounds}.${pence.toString().padStart(2, '0')}`;
    }
    return `${amount}p`;
  }

  private formatDenomination(denominationInPence: number): string {
    if (denominationInPence >= 100) {
      const pounds = denominationInPence / 100;
      return `Â£${pounds}`;
    }
    return `${denominationInPence}p`;
  }

  // Helper method to get the most efficient combination (fewest coins)
  getMostEfficientCombination(
    targetAmount: number, 
    params: MoneyCombinationsDifficultyParams
  ): Array<{ denomination: number; count: number; formatted: string }> {
    const combinations = this.findAllCombinations(targetAmount, params);
    
    if (combinations.length === 0) return [];

    // Find combination with fewest total coins
    return combinations.reduce((best, current) => {
      const bestCount = best.reduce((sum, coin) => sum + coin.count, 0);
      const currentCount = current.reduce((sum, coin) => sum + coin.count, 0);
      return currentCount < bestCount ? current : best;
    });
  }
}
```
--- END FILE: lib\math-engine\models\money-combinations.model.ts ---

--- START FILE: lib\math-engine\models\money-fractions.model.ts ---
```typescript
import {
  IMathModel,
  MoneyFractionsDifficultyParams,
  MoneyFractionsOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class MoneyFractionsModel implements IMathModel<MoneyFractionsDifficultyParams, MoneyFractionsOutput> {
  public readonly model_id = "MONEY_FRACTIONS";

  private static readonly COMMON_FRACTIONS = [
    { numerator: 1, denominator: 2, decimal: 0.5, name: 'half' },
    { numerator: 1, denominator: 3, decimal: 0.333333, name: 'third' },
    { numerator: 1, denominator: 4, decimal: 0.25, name: 'quarter' },
    { numerator: 1, denominator: 5, decimal: 0.2, name: 'fifth' },
    { numerator: 1, denominator: 10, decimal: 0.1, name: 'tenth' },
    { numerator: 2, denominator: 3, decimal: 0.666667, name: 'two thirds' },
    { numerator: 3, denominator: 4, decimal: 0.75, name: 'three quarters' },
    { numerator: 2, denominator: 5, decimal: 0.4, name: 'two fifths' },
    { numerator: 3, denominator: 5, decimal: 0.6, name: 'three fifths' },
    { numerator: 4, denominator: 5, decimal: 0.8, name: 'four fifths' }
  ];

  generate(params: MoneyFractionsDifficultyParams): MoneyFractionsOutput {
    const problemType = this.selectProblemType(params);
    
    switch (problemType) {
      case 'fraction_of_amount':
        return this.generateFractionOfAmountProblem(params);
      case 'find_whole_from_fraction':
        return this.generateFindWholeFromFractionProblem(params);
      case 'compare_fractional_amounts':
        return this.generateCompareFractionalAmountsProblem(params);
      case 'add_fractional_money':
        return this.generateAddFractionalMoneyProblem(params);
      default:
        return this.generateFractionOfAmountProblem(params);
    }
  }

  getDefaultParams(year: number): MoneyFractionsDifficultyParams {
    if (year <= 3) {
      return {
        amount_range: { min: 4, max: 20 }, // Â£4 to Â£20 - easily divisible amounts
        allowed_fractions: [
          { numerator: 1, denominator: 2 },
          { numerator: 1, denominator: 4 }
        ],
        problem_types: ['fraction_of_amount'],
        decimal_places: 2,
        ensure_whole_results: true,
        include_word_problems: true,
        max_fraction_complexity: 4
      };
    } else if (year <= 4) {
      return {
        amount_range: { min: 6, max: 50 },
        allowed_fractions: [
          { numerator: 1, denominator: 2 },
          { numerator: 1, denominator: 3 },
          { numerator: 1, denominator: 4 },
          { numerator: 1, denominator: 5 },
          { numerator: 3, denominator: 4 }
        ],
        problem_types: ['fraction_of_amount', 'find_whole_from_fraction'],
        decimal_places: 2,
        ensure_whole_results: false,
        include_word_problems: true,
        max_fraction_complexity: 5
      };
    } else {
      return {
        amount_range: { min: 10, max: 100 },
        allowed_fractions: [
          { numerator: 1, denominator: 2 },
          { numerator: 1, denominator: 3 },
          { numerator: 1, denominator: 4 },
          { numerator: 1, denominator: 5 },
          { numerator: 1, denominator: 10 },
          { numerator: 2, denominator: 3 },
          { numerator: 3, denominator: 4 },
          { numerator: 2, denominator: 5 },
          { numerator: 3, denominator: 5 }
        ],
        problem_types: ['fraction_of_amount', 'find_whole_from_fraction', 'compare_fractional_amounts', 'add_fractional_money'],
        decimal_places: 2,
        ensure_whole_results: false,
        include_word_problems: true,
        max_fraction_complexity: 10
      };
    }
  }

  private selectProblemType(params: MoneyFractionsDifficultyParams): string {
    return randomChoice(params.problem_types);
  }

  private generateFractionOfAmountProblem(params: MoneyFractionsDifficultyParams): MoneyFractionsOutput {
    const fraction = this.selectFraction(params);
    const wholeAmount = this.generateWholeAmount(params, fraction);
    const result = this.calculateFractionOfAmount(wholeAmount, fraction, params);

    return {
      operation: "MONEY_FRACTIONS",
      problem_type: 'fraction_of_amount',
      whole_amount: wholeAmount,
      fraction: fraction,
      result: result,
      formatted_whole: this.formatMoneyAmount(wholeAmount),
      formatted_fraction: this.formatFraction(fraction),
      formatted_result: this.formatMoneyAmount(result),
      fraction_name: this.getFractionName(fraction),
      calculation_steps: this.getCalculationSteps(wholeAmount, fraction, result)
    };
  }

  private generateFindWholeFromFractionProblem(params: MoneyFractionsDifficultyParams): MoneyFractionsOutput {
    const fraction = this.selectFraction(params);
    const wholeAmount = this.generateWholeAmount(params, fraction);
    const fractionalAmount = this.calculateFractionOfAmount(wholeAmount, fraction, params);

    return {
      operation: "MONEY_FRACTIONS",
      problem_type: 'find_whole_from_fraction',
      whole_amount: wholeAmount,
      fraction: fraction,
      fractional_amount: fractionalAmount,
      result: wholeAmount,
      formatted_whole: this.formatMoneyAmount(wholeAmount),
      formatted_fraction: this.formatFraction(fraction),
      formatted_fractional_amount: this.formatMoneyAmount(fractionalAmount),
      formatted_result: this.formatMoneyAmount(wholeAmount),
      fraction_name: this.getFractionName(fraction)
    };
  }

  private generateCompareFractionalAmountsProblem(params: MoneyFractionsDifficultyParams): MoneyFractionsOutput {
    const baseAmount = this.generateWholeAmount(params);
    const fraction1 = this.selectFraction(params);
    const fraction2 = this.selectFraction(params, [fraction1]);

    const amount1 = this.calculateFractionOfAmount(baseAmount, fraction1, params);
    const amount2 = this.calculateFractionOfAmount(baseAmount, fraction2, params);

    const comparison = amount1 > amount2 ? 'first_greater' : 
                      amount1 < amount2 ? 'second_greater' : 'equal';

    return {
      operation: "MONEY_FRACTIONS",
      problem_type: 'compare_fractional_amounts',
      base_amount: baseAmount,
      fraction1: fraction1,
      fraction2: fraction2,
      amount1: amount1,
      amount2: amount2,
      comparison_result: comparison,
      formatted_base: this.formatMoneyAmount(baseAmount),
      formatted_fraction1: this.formatFraction(fraction1),
      formatted_fraction2: this.formatFraction(fraction2),
      formatted_amount1: this.formatMoneyAmount(amount1),
      formatted_amount2: this.formatMoneyAmount(amount2)
    } as any;
  }

  private generateAddFractionalMoneyProblem(params: MoneyFractionsDifficultyParams): MoneyFractionsOutput {
    const baseAmount = this.generateWholeAmount(params);
    const fraction1 = this.selectFraction(params);
    const fraction2 = this.selectFraction(params);

    const amount1 = this.calculateFractionOfAmount(baseAmount, fraction1, params);
    const amount2 = this.calculateFractionOfAmount(baseAmount, fraction2, params);
    const result = amount1 + amount2;

    return {
      operation: "MONEY_FRACTIONS",
      problem_type: 'add_fractional_money',
      base_amount: baseAmount,
      fraction1: fraction1,
      fraction2: fraction2,
      amount1: amount1,
      amount2: amount2,
      result: result,
      formatted_base: this.formatMoneyAmount(baseAmount),
      formatted_fraction1: this.formatFraction(fraction1),
      formatted_fraction2: this.formatFraction(fraction2),
      formatted_amount1: this.formatMoneyAmount(amount1),
      formatted_amount2: this.formatMoneyAmount(amount2),
      formatted_result: this.formatMoneyAmount(result)
    };
  }

  private selectFraction(
    params: MoneyFractionsDifficultyParams, 
    exclude: Array<{ numerator: number; denominator: number }> = []
  ): { numerator: number; denominator: number } {
    const available = params.allowed_fractions.filter(f => 
      !exclude.some(ex => ex.numerator === f.numerator && ex.denominator === f.denominator)
    );
    
    return available.length > 0 ? randomChoice(available) : params.allowed_fractions[0];
  }

  private generateWholeAmount(
    params: MoneyFractionsDifficultyParams, 
    fraction?: { numerator: number; denominator: number }
  ): number {
    let amount = generateRandomNumber(
      params.amount_range.max,
      params.decimal_places,
      params.amount_range.min
    );

    // If we need whole results and have a fraction, ensure divisibility
    if (params.ensure_whole_results && fraction) {
      // Make sure the amount is divisible by the denominator
      const remainder = amount % fraction.denominator;
      if (remainder !== 0) {
        amount += (fraction.denominator - remainder);
      }
      
      // Ensure it's still within range
      if (amount > params.amount_range.max) {
        amount = params.amount_range.max - (params.amount_range.max % fraction.denominator);
      }
    }

    return amount;
  }

  private calculateFractionOfAmount(
    amount: number, 
    fraction: { numerator: number; denominator: number },
    params: MoneyFractionsDifficultyParams
  ): number {
    const result = (amount * fraction.numerator) / fraction.denominator;
    return Math.round(result * Math.pow(10, params.decimal_places)) / Math.pow(10, params.decimal_places);
  }

  private formatMoneyAmount(amount: number): string {
    if (amount >= 100) {
      return `Â£${(amount / 100).toFixed(2)}`;
    }
    return `${amount}p`;
  }

  private formatFraction(fraction: { numerator: number; denominator: number }): string {
    return `${fraction.numerator}/${fraction.denominator}`;
  }

  private getFractionName(fraction: { numerator: number; denominator: number }): string {
    const commonFraction = MoneyFractionsModel.COMMON_FRACTIONS.find(f => 
      f.numerator === fraction.numerator && f.denominator === fraction.denominator
    );
    
    return commonFraction ? commonFraction.name : this.formatFraction(fraction);
  }

  private getCalculationSteps(
    wholeAmount: number, 
    fraction: { numerator: number; denominator: number },
    result: number
  ): Array<{ step: string; calculation: string; result: string }> {
    const steps: Array<{ step: string; calculation: string; result: string }> = [];

    if (fraction.denominator !== 1) {
      steps.push({
        step: `Divide by ${fraction.denominator}`,
        calculation: `${this.formatMoneyAmount(wholeAmount)} Ã· ${fraction.denominator}`,
        result: this.formatMoneyAmount(wholeAmount / fraction.denominator)
      });
    }

    if (fraction.numerator !== 1) {
      steps.push({
        step: `Multiply by ${fraction.numerator}`,
        calculation: `${this.formatMoneyAmount(wholeAmount / fraction.denominator)} Ã ${fraction.numerator}`,
        result: this.formatMoneyAmount(result)
      });
    }

    return steps;
  }

  // Helper method to check if fraction results in whole money amount
  isWholeFraction(amount: number, fraction: { numerator: number; denominator: number }): boolean {
    const result = (amount * fraction.numerator) / fraction.denominator;
    return result === Math.floor(result);
  }

  // Helper method to find suitable amounts for a given fraction
  findSuitableAmounts(
    fraction: { numerator: number; denominator: number },
    range: { min: number; max: number },
    count: number = 5
  ): number[] {
    const amounts: number[] = [];
    
    for (let i = range.min; i <= range.max && amounts.length < count; i++) {
      if (i % fraction.denominator === 0) {
        amounts.push(i);
      }
    }
    
    return amounts;
  }
}
```
--- END FILE: lib\math-engine\models\money-fractions.model.ts ---

--- START FILE: lib\math-engine\models\money-scaling.model.ts ---
```typescript
import {
  IMathModel,
  MoneyScalingDifficultyParams,
  MoneyScalingOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class MoneyScalingModel implements IMathModel<MoneyScalingDifficultyParams, MoneyScalingOutput> {
  public readonly model_id = "MONEY_SCALING";

  generate(params: MoneyScalingDifficultyParams): MoneyScalingOutput {
    const problemType = this.selectProblemType(params);
    
    switch (problemType) {
      case 'scale_up':
        return this.generateScaleUpProblem(params);
      case 'scale_down':
        return this.generateScaleDownProblem(params);
      case 'proportional_reasoning':
        return this.generateProportionalReasoningProblem(params);
      case 'rate_problems':
        return this.generateRateProblem(params);
      default:
        return this.generateScaleUpProblem(params);
    }
  }

  getDefaultParams(year: number): MoneyScalingDifficultyParams {
    if (year <= 3) {
      return {
        base_amount_range: { min: 5, max: 50 },
        scale_factor_range: { min: 2, max: 5 },
        problem_types: ['scale_up', 'scale_down'],
        decimal_places: 2,
        include_fractional_scaling: false,
        allow_complex_ratios: false,
        context_types: ['shopping', 'bulk_buying']
      };
    } else if (year <= 4) {
      return {
        base_amount_range: { min: 10, max: 100 },
        scale_factor_range: { min: 2, max: 10 },
        problem_types: ['scale_up', 'scale_down', 'proportional_reasoning'],
        decimal_places: 2,
        include_fractional_scaling: true,
        allow_complex_ratios: false,
        context_types: ['shopping', 'bulk_buying', 'recipe_scaling', 'group_activities']
      };
    } else {
      return {
        base_amount_range: { min: 10, max: 500 },
        scale_factor_range: { min: 1.5, max: 20 },
        problem_types: ['scale_up', 'scale_down', 'proportional_reasoning', 'rate_problems'],
        decimal_places: 2,
        include_fractional_scaling: true,
        allow_complex_ratios: true,
        context_types: ['shopping', 'bulk_buying', 'recipe_scaling', 'group_activities', 'business', 'savings']
      };
    }
  }

  private selectProblemType(params: MoneyScalingDifficultyParams): string {
    return randomChoice(params.problem_types);
  }

  private generateScaleUpProblem(params: MoneyScalingDifficultyParams): MoneyScalingOutput {
    const baseAmount = this.generateBaseAmount(params);
    const scaleFactor = this.generateScaleFactor(params);
    const scaledAmount = this.calculateScaledAmount(baseAmount, scaleFactor, params);
    
    const context = this.generateContext(params, 'scale_up');

    return {
      operation: "MONEY_SCALING",
      problem_type: 'scale_up',
      base_amount: baseAmount,
      scale_factor: scaleFactor,
      scaled_amount: scaledAmount,
      context: context,
      formatted_base: this.formatMoneyAmount(baseAmount),
      formatted_scaled: this.formatMoneyAmount(scaledAmount),
      formatted_scale_factor: this.formatScaleFactor(scaleFactor),
      calculation: `${this.formatMoneyAmount(baseAmount)} Ã ${this.formatScaleFactor(scaleFactor)} = ${this.formatMoneyAmount(scaledAmount)}`
    };
  }

  private generateScaleDownProblem(params: MoneyScalingDifficultyParams): MoneyScalingOutput {
    const scaleFactor = this.generateScaleFactor(params);
    const baseAmount = this.generateBaseAmount(params);
    const originalAmount = this.calculateScaledAmount(baseAmount, scaleFactor, params);
    
    const context = this.generateContext(params, 'scale_down');

    return {
      operation: "MONEY_SCALING",
      problem_type: 'scale_down',
      base_amount: baseAmount,
      scale_factor: 1 / scaleFactor,
      original_amount: originalAmount,
      scaled_amount: baseAmount,
      context: context,
      formatted_base: this.formatMoneyAmount(baseAmount),
      formatted_original: this.formatMoneyAmount(originalAmount),
      formatted_scale_factor: this.formatScaleFactor(1 / scaleFactor),
      calculation: `${this.formatMoneyAmount(originalAmount)} Ã· ${this.formatScaleFactor(scaleFactor)} = ${this.formatMoneyAmount(baseAmount)}`
    };
  }

  private generateProportionalReasoningProblem(params: MoneyScalingDifficultyParams): MoneyScalingOutput {
    const baseQuantity = generateRandomNumber(10, 0, 2);
    const baseAmount = this.generateBaseAmount(params);
    const newQuantity = generateRandomNumber(20, 0, baseQuantity + 1);
    
    const unitCost = baseAmount / baseQuantity;
    const newAmount = unitCost * newQuantity;
    
    const context = this.generateProportionalContext(params);

    return {
      operation: "MONEY_SCALING",
      problem_type: 'proportional_reasoning',
      base_quantity: baseQuantity,
      base_amount: baseAmount,
      new_quantity: newQuantity,
      new_amount: Math.round(newAmount * 100) / 100,
      unit_cost: Math.round(unitCost * 100) / 100,
      context: context,
      formatted_base: this.formatMoneyAmount(baseAmount),
      formatted_new: this.formatMoneyAmount(Math.round(newAmount * 100) / 100),
      formatted_unit_cost: this.formatMoneyAmount(Math.round(unitCost * 100) / 100),
      calculation: `${baseQuantity} items cost ${this.formatMoneyAmount(baseAmount)}, so ${newQuantity} items cost ${this.formatMoneyAmount(Math.round(newAmount * 100) / 100)}`
    };
  }

  private generateRateProblem(params: MoneyScalingDifficultyParams): MoneyScalingOutput {
    const timeUnit = randomChoice(['hour', 'day', 'week']);
    const rate = this.generateBaseAmount(params);
    const timeAmount = generateRandomNumber(10, 0, 2);
    
    const totalAmount = this.calculateScaledAmount(rate, timeAmount, params);
    
    const context = this.generateRateContext(params, timeUnit);

    return {
      operation: "MONEY_SCALING",
      problem_type: 'rate_problems',
      rate: rate,
      time_amount: timeAmount,
      time_unit: timeUnit,
      total_amount: totalAmount,
      context: context,
      formatted_rate: this.formatMoneyAmount(rate),
      formatted_total: this.formatMoneyAmount(totalAmount),
      calculation: `${this.formatMoneyAmount(rate)} per ${timeUnit} Ã ${timeAmount} ${timeUnit}s = ${this.formatMoneyAmount(totalAmount)}`
    };
  }

  private generateBaseAmount(params: MoneyScalingDifficultyParams): number {
    return generateRandomNumber(
      params.base_amount_range.max,
      params.decimal_places,
      params.base_amount_range.min
    );
  }

  private generateScaleFactor(params: MoneyScalingDifficultyParams): number {
    let factor = generateRandomNumber(
      params.scale_factor_range.max,
      params.include_fractional_scaling ? 1 : 0,
      params.scale_factor_range.min
    );

    // For fractional scaling, sometimes use common fractions
    if (params.include_fractional_scaling && Math.random() < 0.3) {
      const commonFractions = [0.5, 0.25, 0.75, 1.5, 2.5, 3.5];
      factor = randomChoice(commonFractions.filter(f => 
        f >= params.scale_factor_range.min && f <= params.scale_factor_range.max
      ));
    }

    return factor;
  }

  private calculateScaledAmount(baseAmount: number, scaleFactor: number, params: MoneyScalingDifficultyParams): number {
    const result = baseAmount * scaleFactor;
    return Math.round(result * Math.pow(10, params.decimal_places)) / Math.pow(10, params.decimal_places);
  }

  private generateContext(params: MoneyScalingDifficultyParams, problemType: string): string {
    const contextType = randomChoice(params.context_types);
    
    switch (contextType) {
      case 'shopping':
        return problemType === 'scale_up' ? 
          'buying multiple items at the store' : 
          'calculating individual item cost from bulk purchase';
      
      case 'bulk_buying':
        return problemType === 'scale_up' ? 
          'ordering in larger quantities' : 
          'finding single unit cost from bulk price';
      
      case 'recipe_scaling':
        return problemType === 'scale_up' ? 
          'making a bigger batch of the recipe' : 
          'reducing recipe portion size';
      
      case 'group_activities':
        return problemType === 'scale_up' ? 
          'calculating costs for more people' : 
          'finding cost per person';
      
      case 'business':
        return problemType === 'scale_up' ? 
          'increasing production volume' : 
          'calculating unit production costs';
      
      case 'savings':
        return problemType === 'scale_up' ? 
          'saving for longer periods' : 
          'calculating daily saving amounts';
      
      default:
        return 'general scaling calculation';
    }
  }

  private generateProportionalContext(params: MoneyScalingDifficultyParams): string {
    const contexts = [
      'comparing different package sizes',
      'calculating costs for different group sizes',
      'finding the better value deal',
      'determining unit pricing',
      'scaling recipe costs'
    ];
    
    return randomChoice(contexts);
  }

  private generateRateContext(params: MoneyScalingDifficultyParams, timeUnit: string): string {
    const contexts = {
      hour: ['hourly wage calculation', 'parking fee calculation', 'rental cost calculation'],
      day: ['daily expense planning', 'vacation budget calculation', 'subscription cost calculation'],
      week: ['weekly allowance calculation', 'weekly shopping budget', 'weekly activity costs']
    };
    
    return randomChoice(contexts[timeUnit as keyof typeof contexts] || contexts.hour);
  }

  private formatMoneyAmount(amount: number): string {
    if (amount >= 100) {
      return `Â£${(amount / 100).toFixed(2)}`;
    }
    return `${amount}p`;
  }

  private formatScaleFactor(factor: number): string {
    if (factor === Math.floor(factor)) {
      return factor.toString();
    }
    return factor.toFixed(1);
  }

  // Helper method to find good scaling combinations
  findReasonableScalings(
    baseAmount: number, 
    params: MoneyScalingDifficultyParams
  ): Array<{ factor: number; result: number }> {
    const scalings: Array<{ factor: number; result: number }> = [];
    
    for (let factor = params.scale_factor_range.min; factor <= params.scale_factor_range.max; factor += 0.5) {
      const result = this.calculateScaledAmount(baseAmount, factor, params);
      
      // Check if result is reasonable (not too complex decimals)
      if (result < 1000 && (result === Math.floor(result) || result.toFixed(2) === result.toString())) {
        scalings.push({ factor, result });
      }
    }
    
    return scalings;
  }

  // Helper method to determine if scaling results in "nice" numbers
  isNiceScaling(baseAmount: number, scaleFactor: number): boolean {
    const result = baseAmount * scaleFactor;
    
    // Check if result is a whole number or has at most 2 decimal places
    const rounded = Math.round(result * 100) / 100;
    return Math.abs(result - rounded) < 0.001;
  }
}
```
--- END FILE: lib\math-engine\models\money-scaling.model.ts ---

--- START FILE: lib\math-engine\models\multi-step.model.ts ---
```typescript
import {
  IMathModel,
  MultiStepDifficultyParams,
  MultiStepOutput,
  StepResult
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';
import { getModel } from '../index';

export class MultiStepModel implements IMathModel<MultiStepDifficultyParams, MultiStepOutput> {
  public readonly model_id = "MULTI_STEP";

  generate(params: MultiStepDifficultyParams): MultiStepOutput {
    const steps = this.executeSequence(params);
    const finalResult = steps.length > 0 ? steps[steps.length - 1].result : 0;
    const intermediateResults = steps.slice(0, -1).map(step => step.result);

    return {
      operation: "MULTI_STEP",
      steps,
      final_result: finalResult,
      intermediate_results: intermediateResults
    };
  }

  getDefaultParams(year: number): MultiStepDifficultyParams {
    if (year <= 2) {
      return {
        operation_sequence: [
          {
            model: "ADDITION",
            params: { operand_count: 2, max_value: 10, decimal_places: 0, allow_carrying: false, value_constraints: { min: 1, step: 1 } },
            use_previous_result: false
          },
          {
            model: "SUBTRACTION", 
            params: { minuend_max: 20, subtrahend_max: 10, decimal_places: 0, allow_borrowing: false, ensure_positive: true, value_constraints: { step: 1 } },
            use_previous_result: true
          }
        ],
        max_steps: 2,
        intermediate_visibility: true
      };
    } else if (year <= 4) {
      return {
        operation_sequence: [
          {
            model: "MULTIPLICATION",
            params: { multiplicand_max: 10, multiplier_max: 5, decimal_places: year === 4 ? 2 : 0, operand_count: 2, use_fractions: false },
            use_previous_result: false
          },
          {
            model: "ADDITION",
            params: { operand_count: 2, max_value: 50, decimal_places: year === 4 ? 2 : 0, allow_carrying: true, value_constraints: { min: 1, step: year === 4 ? 0.01 : 1 } },
            use_previous_result: true
          },
          {
            model: "SUBTRACTION",
            params: { minuend_max: 100, subtrahend_max: 50, decimal_places: year === 4 ? 2 : 0, allow_borrowing: true, ensure_positive: true, value_constraints: { step: year === 4 ? 0.01 : 1 } },
            use_previous_result: true
          }
        ],
        max_steps: 3,
        intermediate_visibility: true
      };
    } else {
      return {
        operation_sequence: [
          {
            model: "MULTIPLICATION",
            params: { multiplicand_max: 20, multiplier_max: 10, decimal_places: 2, operand_count: 2, use_fractions: false },
            use_previous_result: false
          },
          {
            model: "ADDITION",
            params: { operand_count: 2, max_value: 100, decimal_places: 2, allow_carrying: true, value_constraints: { min: 1, step: 0.01 } },
            use_previous_result: true
          },
          {
            model: "SUBTRACTION", 
            params: { minuend_max: 200, subtrahend_max: 100, decimal_places: 2, allow_borrowing: true, ensure_positive: true, value_constraints: { step: 0.01 } },
            use_previous_result: true
          },
          {
            model: "DIVISION",
            params: { dividend_max: 100, divisor_max: 10, decimal_places: 2, allow_remainder: false, ensure_whole: false },
            use_previous_result: true
          }
        ],
        max_steps: 4,
        intermediate_visibility: true
      };
    }
  }

  private executeSequence(params: MultiStepDifficultyParams): StepResult[] {
    const steps: StepResult[] = [];
    let previousResult: number | null = null;

    const sequence = params.operation_sequence.slice(0, params.max_steps);

    for (let i = 0; i < sequence.length; i++) {
      const operation = sequence[i];
      
      try {
        const model = this.getModelSafe(operation.model);
        if (!model) {
          console.warn(`Model ${operation.model} not found, skipping step ${i + 1}`);
          continue;
        }

        // Modify parameters if using previous result
        let adjustedParams = { ...operation.params };
        if (operation.use_previous_result && previousResult !== null) {
          adjustedParams = this.adjustParamsForPreviousResult(
            operation.model, 
            adjustedParams, 
            previousResult
          );
        }

        const result = model.generate(adjustedParams);
        const stepResult = this.extractStepResult(i + 1, operation.model, result, previousResult);
        
        steps.push(stepResult);
        previousResult = stepResult.result;

      } catch (error) {
        console.warn(`Error in step ${i + 1} (${operation.model}):`, error);
        // Continue with fallback result
        const fallbackResult: number = previousResult || 10;
        steps.push({
          step: i + 1,
          operation: operation.model,
          inputs: [fallbackResult],
          result: fallbackResult
        });
        previousResult = fallbackResult;
      }
    }

    return steps;
  }

  private getModelSafe(modelId: string): any {
    try {
      return getModel(modelId as any);
    } catch {
      return null;
    }
  }

  private adjustParamsForPreviousResult(
    modelId: string, 
    params: any, 
    previousResult: number
  ): any {
    const roundedResult = Math.round(previousResult * 100) / 100;
    
    switch (modelId) {
      case 'ADDITION':
        // Use previous result as one of the operands
        return {
          ...params,
          operand_count: 2,
          // Generate one additional operand
          fixed_operand: roundedResult
        };
      
      case 'SUBTRACTION':
        // Use previous result as minuend or create a subtraction from it
        return {
          ...params,
          minuend_max: Math.max(roundedResult + 20, params.minuend_max),
          fixed_minuend: roundedResult
        };
      
      case 'MULTIPLICATION':
        // Use previous result as multiplicand
        return {
          ...params,
          multiplier_max: Math.min(params.multiplier_max, 10), // Keep multiplier reasonable
          fixed_multiplicand: roundedResult
        };
      
      case 'DIVISION':
        // Use previous result as dividend
        return {
          ...params,
          fixed_dividend: roundedResult,
          divisor_max: Math.min(Math.max(Math.floor(roundedResult / 2), 2), 10)
        };
      
      default:
        return params;
    }
  }

  private extractStepResult(
    stepNumber: number, 
    operation: string, 
    modelResult: any,
    previousInput: number | null
  ): StepResult {
    let inputs: number[] = [];
    let result: number = 0;

    switch (operation) {
      case 'ADDITION':
        inputs = modelResult.operands || [];
        result = modelResult.result || 0;
        break;
      
      case 'SUBTRACTION':
        inputs = [modelResult.minuend || 0, modelResult.subtrahend || 0];
        result = modelResult.result || 0;
        break;
      
      case 'MULTIPLICATION':
        inputs = [modelResult.multiplicand || 0, modelResult.multiplier || 0];
        result = modelResult.result || 0;
        break;
      
      case 'DIVISION':
        inputs = [modelResult.dividend || 0, modelResult.divisor || 0];
        result = modelResult.quotient || 0;
        break;
      
      default:
        inputs = previousInput !== null ? [previousInput] : [];
        result = modelResult.result || modelResult.final_result || 0;
    }

    return {
      step: stepNumber,
      operation,
      inputs,
      result: Math.round(result * 100) / 100
    };
  }
}
```
--- END FILE: lib\math-engine\models\multi-step.model.ts ---

--- START FILE: lib\math-engine\models\multiplication.model.ts ---
```typescript
import {
  IMathModel,
  MultiplicationDifficultyParams,
  MultiplicationOutput,
  DecimalFormatted
} from '@/lib/types';
import {
  generateRandomNumber,
  formatDecimal
} from '@/lib/utils';

export class MultiplicationModel implements IMathModel<MultiplicationDifficultyParams, MultiplicationOutput> {
  public readonly model_id = "MULTIPLICATION";

  generate(params: MultiplicationDifficultyParams): MultiplicationOutput {
    const factors = this.generateFactors(params);
    const result = this.calculateProduct(factors);
    const decimalFormatted = this.formatOutput(factors, result, params.decimal_places);

    return {
      operation: "MULTIPLICATION",
      multiplicand: factors[0],
      multiplier: factors.length > 1 ? factors[1] : 1,
      result,
      factors,
      decimal_formatted: decimalFormatted
    };
  }

  getDefaultParams(year: number): MultiplicationDifficultyParams {
    if (year <= 2) {
      return {
        multiplicand_max: 10,
        multiplier_max: 5,
        decimal_places: 0,
        operand_count: 2,
        use_fractions: false
      };
    } else if (year <= 4) {
      return {
        multiplicand_max: 100,
        multiplier_max: 10,
        decimal_places: year === 4 ? 2 : 0,
        operand_count: 2,
        use_fractions: false
      };
    } else {
      return {
        multiplicand_max: 1000,
        multiplier_max: 100,
        decimal_places: 3,
        operand_count: year === 6 ? 3 : 2,
        use_fractions: year === 6
      };
    }
  }

  private generateFactors(params: MultiplicationDifficultyParams): number[] {
    const factors: number[] = [];
    
    // Generate multiplicand
    factors.push(generateRandomNumber(
      params.multiplicand_max,
      params.use_fractions ? params.decimal_places : 0,
      1,
      params.use_fractions ? 0.01 : 1
    ));

    // Generate multiplier(s)
    for (let i = 1; i < params.operand_count; i++) {
      const max = i === 1 ? params.multiplier_max : 10; // Additional factors are smaller
      factors.push(generateRandomNumber(
        max,
        params.use_fractions && i === 1 ? params.decimal_places : 0,
        1,
        params.use_fractions && i === 1 ? 0.01 : 1
      ));
    }

    return factors;
  }

  private calculateProduct(factors: number[]): number {
    const product = factors.reduce((acc, val) => acc * val, 1);
    // Handle floating point precision
    return Math.round(product * 1000) / 1000;
  }

  private formatOutput(
    factors: number[],
    result: number,
    decimalPlaces: number
  ): DecimalFormatted {
    return {
      operands: factors.map(f => formatDecimal(f, decimalPlaces)),
      result: formatDecimal(result, decimalPlaces)
    };
  }
}
```
--- END FILE: lib\math-engine\models\multiplication.model.ts ---

--- START FILE: lib\math-engine\models\percentage.model.ts ---
```typescript
import {
  IMathModel,
  PercentageDifficultyParams,
  PercentageOutput
} from '@/lib/types';
import {
  generateRandomNumber,
  randomChoice
} from '@/lib/utils';

export class PercentageModel implements IMathModel<PercentageDifficultyParams, PercentageOutput> {
  public readonly model_id = "PERCENTAGE";

  generate(params: PercentageDifficultyParams): PercentageOutput {
    const baseValue = this.generateBaseValue(params);
    const percentage = this.selectPercentage(params);
    const { percentageAmount, result } = this.calculatePercentage(
      baseValue,
      percentage,
      params.operation_type
    );

    return {
      operation: "PERCENTAGE",
      operation_type: params.operation_type,
      base_value: baseValue,
      percentage,
      percentage_amount: percentageAmount,
      result
    };
  }

  getDefaultParams(year: number): PercentageDifficultyParams {
    if (year <= 4) {
      return {
        base_value_max: 100,
        percentage_values: [10, 50, 100],
        operation_type: "of",
        decimal_places: 0
      };
    } else if (year === 5) {
      return {
        base_value_max: 200,
        percentage_values: [10, 20, 25, 50, 75],
        operation_type: randomChoice(["of", "increase", "decrease"]),
        decimal_places: 2
      };
    } else {
      return {
        base_value_max: 500,
        percentage_values: [5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 80],
        operation_type: randomChoice(["of", "increase", "decrease", "reverse"]),
        decimal_places: 2
      };
    }
  }

  private generateBaseValue(params: PercentageDifficultyParams): number {
    return generateRandomNumber(
      params.base_value_max,
      params.decimal_places,
      10,
      params.decimal_places > 0 ? 0.01 : 1
    );
  }

  private selectPercentage(params: PercentageDifficultyParams): number {
    return randomChoice(params.percentage_values);
  }

  private calculatePercentage(
    baseValue: number,
    percentage: number,
    operationType: string
  ): { percentageAmount: number; result: number } {
    const percentageAmount = (baseValue * percentage) / 100;
    let result: number;

    switch (operationType) {
      case "of":
        result = percentageAmount;
        break;
      case "increase":
        result = baseValue + percentageAmount;
        break;
      case "decrease":
        result = baseValue - percentageAmount;
        break;
      case "reverse":
        // Find original value before percentage was applied
        result = (baseValue * 100) / (100 - percentage);
        break;
      default:
        result = percentageAmount;
    }

    return {
      percentageAmount: Math.round(percentageAmount * 100) / 100,
      result: Math.round(result * 100) / 100
    };
  }
}
```
--- END FILE: lib\math-engine\models\percentage.model.ts ---

--- START FILE: lib\math-engine\models\position-direction.model.ts ---
```typescript
import {
  IMathModel,
  PositionDirectionDifficultyParams,
  PositionDirectionOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class PositionDirectionModel implements IMathModel<PositionDirectionDifficultyParams, PositionDirectionOutput> {
  public readonly model_id = "POSITION_DIRECTION";

  private static readonly COMPASS_DIRECTIONS = ['North', 'South', 'East', 'West'];
  private static readonly INTERMEDIATE_DIRECTIONS = ['North-East', 'North-West', 'South-East', 'South-West'];
  private static readonly ALL_DIRECTIONS = [
    ...PositionDirectionModel.COMPASS_DIRECTIONS,
    ...PositionDirectionModel.INTERMEDIATE_DIRECTIONS
  ];

  private static readonly POSITION_WORDS = {
    horizontal: ['left', 'right'],
    vertical: ['above', 'below', 'up', 'down'],
    diagonal: ['above-right', 'above-left', 'below-right', 'below-left'],
    relative: ['next to', 'beside', 'near', 'far from', 'between']
  };

  private static readonly GRID_REFERENCES = {
    letters: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'],
    numbers: [1, 2, 3, 4, 5, 6, 7, 8]
  };

  generate(params: PositionDirectionDifficultyParams): PositionDirectionOutput {
    const problemType = randomChoice(params.problem_types);
    
    switch (problemType) {
      case 'identify_position':
        return this.generateIdentifyPositionProblem(params);
      case 'follow_directions':
        return this.generateFollowDirectionsProblem(params);
      case 'give_directions':
        return this.generateGiveDirectionsProblem(params);
      case 'coordinates':
        return this.generateCoordinatesProblem(params);
      case 'compass_directions':
        return this.generateCompassDirectionsProblem(params);
      case 'relative_position':
        return this.generateRelativePositionProblem(params);
      default:
        return this.generateIdentifyPositionProblem(params);
    }
  }

  getDefaultParams(year: number): PositionDirectionDifficultyParams {
    if (year <= 1) {
      return {
        coordinate_system: 'simple_grid',
        use_compass_directions: false,
        max_grid_size: 3,
        include_diagonals: false,
        movement_steps: 1,
        problem_types: ['identify_position', 'relative_position']
      };
    } else if (year <= 2) {
      return {
        coordinate_system: 'simple_grid',
        use_compass_directions: false,
        max_grid_size: 4,
        include_diagonals: false,
        movement_steps: 2,
        problem_types: ['identify_position', 'follow_directions', 'relative_position']
      };
    } else if (year <= 3) {
      return {
        coordinate_system: 'lettered_grid',
        use_compass_directions: true,
        max_grid_size: 5,
        include_diagonals: false,
        movement_steps: 3,
        problem_types: ['identify_position', 'follow_directions', 'compass_directions', 'relative_position']
      };
    } else if (year <= 4) {
      return {
        coordinate_system: 'lettered_grid',
        use_compass_directions: true,
        max_grid_size: 6,
        include_diagonals: true,
        movement_steps: 4,
        problem_types: ['identify_position', 'follow_directions', 'give_directions', 'coordinates', 'compass_directions']
      };
    } else if (year <= 5) {
      return {
        coordinate_system: 'coordinate_plane',
        use_compass_directions: true,
        max_grid_size: 8,
        include_diagonals: true,
        movement_steps: 5,
        problem_types: ['follow_directions', 'give_directions', 'coordinates', 'compass_directions', 'relative_position']
      };
    } else {
      return {
        coordinate_system: 'coordinate_plane',
        use_compass_directions: true,
        max_grid_size: 10,
        include_diagonals: true,
        movement_steps: 6,
        problem_types: ['follow_directions', 'give_directions', 'coordinates', 'compass_directions', 'relative_position']
      };
    }
  }

  private generateIdentifyPositionProblem(params: PositionDirectionDifficultyParams): PositionDirectionOutput {
    const gridSize = Math.min(params.max_grid_size, 8);
    const position = this.generateRandomPosition(params.coordinate_system, gridSize);
    
    let correctAnswer: string;
    if (params.coordinate_system === 'coordinate_plane') {
      correctAnswer = `(${position.x}, ${position.y})`;
    } else if (params.coordinate_system === 'lettered_grid') {
      const letter = PositionDirectionModel.GRID_REFERENCES.letters[position.x - 1];
      correctAnswer = `${letter}${position.y}`;
    } else {
      correctAnswer = `Column ${position.x}, Row ${position.y}`;
    }

    return {
      operation: "POSITION_DIRECTION",
      problem_type: 'identify_position',
      start_position: position,
      target_position: position,
      coordinate_system: params.coordinate_system,
      grid_size: gridSize,
      visual_description: `Object located at position on ${gridSize}Ã${gridSize} grid`,
      correct_answer: correctAnswer
    };
  }

  private generateFollowDirectionsProblem(params: PositionDirectionDifficultyParams): PositionDirectionOutput {
    const gridSize = Math.min(params.max_grid_size, 8);
    const startPosition = this.generateRandomPosition(params.coordinate_system, gridSize);
    const movements = this.generateMovements(params.movement_steps, params.use_compass_directions, params.include_diagonals);
    const targetPosition = this.calculateFinalPosition(startPosition, movements, gridSize);
    
    let correctAnswer: string;
    if (params.coordinate_system === 'coordinate_plane') {
      correctAnswer = `(${targetPosition.x}, ${targetPosition.y})`;
    } else if (params.coordinate_system === 'lettered_grid') {
      const letter = PositionDirectionModel.GRID_REFERENCES.letters[targetPosition.x - 1];
      correctAnswer = `${letter}${targetPosition.y}`;
    } else {
      correctAnswer = `Column ${targetPosition.x}, Row ${targetPosition.y}`;
    }

    const directionText = movements.map(m => `${m.steps} step${m.steps > 1 ? 's' : ''} ${m.direction}`).join(', then ');

    return {
      operation: "POSITION_DIRECTION",
      problem_type: 'follow_directions',
      start_position: startPosition,
      target_position: targetPosition,
      movements: movements,
      coordinate_system: params.coordinate_system,
      grid_size: gridSize,
      visual_description: `Starting position and movement instructions: ${directionText}`,
      correct_answer: correctAnswer
    };
  }

  private generateGiveDirectionsProblem(params: PositionDirectionDifficultyParams): PositionDirectionOutput {
    const gridSize = Math.min(params.max_grid_size, 8);
    const startPosition = this.generateRandomPosition(params.coordinate_system, gridSize);
    const targetPosition = this.generateRandomPosition(params.coordinate_system, gridSize);
    
    // Calculate the simplest path
    const movements = this.calculateSimplePath(startPosition, targetPosition, params.use_compass_directions);
    const directionText = movements.map(m => `${m.steps} step${m.steps > 1 ? 's' : ''} ${m.direction}`).join(', then ');

    return {
      operation: "POSITION_DIRECTION",
      problem_type: 'give_directions',
      start_position: startPosition,
      target_position: targetPosition,
      movements: movements,
      coordinate_system: params.coordinate_system,
      grid_size: gridSize,
      visual_description: `Path from start to target position`,
      correct_answer: directionText
    };
  }

  private generateCoordinatesProblem(params: PositionDirectionDifficultyParams): PositionDirectionOutput {
    const gridSize = Math.min(params.max_grid_size, 8);
    const position = this.generateRandomPosition(params.coordinate_system, gridSize);
    
    let questionFocus: string;
    let correctAnswer: string;
    
    if (params.coordinate_system === 'coordinate_plane') {
      const focusOptions = ['x_coordinate', 'y_coordinate', 'both_coordinates'];
      questionFocus = randomChoice(focusOptions);
      
      if (questionFocus === 'x_coordinate') {
        correctAnswer = String(position.x);
      } else if (questionFocus === 'y_coordinate') {
        correctAnswer = String(position.y);
      } else {
        correctAnswer = `(${position.x}, ${position.y})`;
      }
    } else {
      questionFocus = 'grid_reference';
      const letter = PositionDirectionModel.GRID_REFERENCES.letters[position.x - 1];
      correctAnswer = `${letter}${position.y}`;
    }

    return {
      operation: "POSITION_DIRECTION",
      problem_type: 'coordinates',
      start_position: position,
      target_position: position,
      coordinate_system: params.coordinate_system,
      grid_size: gridSize,
      question_focus: questionFocus,
      visual_description: `Object on coordinate grid at specific position`,
      correct_answer: correctAnswer
    };
  }

  private generateCompassDirectionsProblem(params: PositionDirectionDifficultyParams): PositionDirectionOutput {
    const gridSize = Math.min(params.max_grid_size, 8);
    const centerPosition = { x: Math.ceil(gridSize / 2), y: Math.ceil(gridSize / 2) };
    
    const directions = params.include_diagonals ? PositionDirectionModel.ALL_DIRECTIONS : PositionDirectionModel.COMPASS_DIRECTIONS;
    const direction = randomChoice(directions);
    const steps = generateRandomNumber(3, 0, 1);
    
    const targetPosition = this.moveInCompassDirection(centerPosition, direction, steps, gridSize);
    
    return {
      operation: "POSITION_DIRECTION",
      problem_type: 'compass_directions',
      start_position: centerPosition,
      target_position: targetPosition,
      movements: [{ direction, steps }],
      coordinate_system: params.coordinate_system,
      grid_size: gridSize,
      visual_description: `Movement ${steps} step${steps > 1 ? 's' : ''} ${direction} from center`,
      correct_answer: direction
    };
  }

  private generateRelativePositionProblem(params: PositionDirectionDifficultyParams): PositionDirectionOutput {
    const gridSize = Math.min(params.max_grid_size, 8);
    const referencePosition = this.generateRandomPosition(params.coordinate_system, gridSize);
    const targetPosition = this.generateRandomPosition(params.coordinate_system, gridSize);
    
    const relativeDescription = this.getRelativePosition(referencePosition, targetPosition);
    
    return {
      operation: "POSITION_DIRECTION",
      problem_type: 'relative_position',
      start_position: referencePosition,
      target_position: targetPosition,
      coordinate_system: params.coordinate_system,
      grid_size: gridSize,
      visual_description: `Two objects on grid with relative positioning`,
      correct_answer: relativeDescription
    };
  }

  private generateRandomPosition(coordinateSystem: string, gridSize: number): { x: number; y: number } {
    return {
      x: generateRandomNumber(gridSize, 0, 1),
      y: generateRandomNumber(gridSize, 0, 1)
    };
  }

  private generateMovements(maxSteps: number, useCompass: boolean, includeDiagonals: boolean): Array<{ direction: string; steps: number }> {
    const numberOfMoves = generateRandomNumber(Math.min(maxSteps, 3), 0, 1);
    const movements = [];
    
    for (let i = 0; i < numberOfMoves; i++) {
      let direction: string;
      if (useCompass) {
        const directions = includeDiagonals ? PositionDirectionModel.ALL_DIRECTIONS : PositionDirectionModel.COMPASS_DIRECTIONS;
        direction = randomChoice(directions);
      } else {
        const simpleDirections = ['up', 'down', 'left', 'right'];
        direction = randomChoice(simpleDirections);
      }
      
      const steps = generateRandomNumber(3, 0, 1);
      movements.push({ direction, steps });
    }
    
    return movements;
  }

  private calculateFinalPosition(
    start: { x: number; y: number }, 
    movements: Array<{ direction: string; steps: number }>, 
    gridSize: number
  ): { x: number; y: number } {
    let position = { ...start };
    
    for (const movement of movements) {
      position = this.moveInDirection(position, movement.direction, movement.steps, gridSize);
    }
    
    return position;
  }

  private moveInDirection(
    position: { x: number; y: number }, 
    direction: string, 
    steps: number, 
    gridSize: number
  ): { x: number; y: number } {
    let newPos = { ...position };
    
    switch (direction.toLowerCase()) {
      case 'north':
      case 'up':
        newPos.y = Math.min(newPos.y + steps, gridSize);
        break;
      case 'south':
      case 'down':
        newPos.y = Math.max(newPos.y - steps, 1);
        break;
      case 'east':
      case 'right':
        newPos.x = Math.min(newPos.x + steps, gridSize);
        break;
      case 'west':
      case 'left':
        newPos.x = Math.max(newPos.x - steps, 1);
        break;
      case 'north-east':
        newPos.x = Math.min(newPos.x + steps, gridSize);
        newPos.y = Math.min(newPos.y + steps, gridSize);
        break;
      case 'north-west':
        newPos.x = Math.max(newPos.x - steps, 1);
        newPos.y = Math.min(newPos.y + steps, gridSize);
        break;
      case 'south-east':
        newPos.x = Math.min(newPos.x + steps, gridSize);
        newPos.y = Math.max(newPos.y - steps, 1);
        break;
      case 'south-west':
        newPos.x = Math.max(newPos.x - steps, 1);
        newPos.y = Math.max(newPos.y - steps, 1);
        break;
    }
    
    return newPos;
  }

  private moveInCompassDirection(
    position: { x: number; y: number }, 
    direction: string, 
    steps: number, 
    gridSize: number
  ): { x: number; y: number } {
    return this.moveInDirection(position, direction, steps, gridSize);
  }

  private calculateSimplePath(
    start: { x: number; y: number }, 
    target: { x: number; y: number }, 
    useCompass: boolean
  ): Array<{ direction: string; steps: number }> {
    const movements = [];
    const deltaX = target.x - start.x;
    const deltaY = target.y - start.y;
    
    if (deltaX !== 0) {
      const direction = useCompass ? (deltaX > 0 ? 'East' : 'West') : (deltaX > 0 ? 'right' : 'left');
      movements.push({ direction, steps: Math.abs(deltaX) });
    }
    
    if (deltaY !== 0) {
      const direction = useCompass ? (deltaY > 0 ? 'North' : 'South') : (deltaY > 0 ? 'up' : 'down');
      movements.push({ direction, steps: Math.abs(deltaY) });
    }
    
    return movements;
  }

  private getRelativePosition(reference: { x: number; y: number }, target: { x: number; y: number }): string {
    const deltaX = target.x - reference.x;
    const deltaY = target.y - reference.y;
    
    if (deltaX === 0 && deltaY === 0) return 'same position';
    if (deltaX === 0 && deltaY > 0) return 'above';
    if (deltaX === 0 && deltaY < 0) return 'below';
    if (deltaX > 0 && deltaY === 0) return 'to the right';
    if (deltaX < 0 && deltaY === 0) return 'to the left';
    if (deltaX > 0 && deltaY > 0) return 'above and to the right';
    if (deltaX < 0 && deltaY > 0) return 'above and to the left';
    if (deltaX > 0 && deltaY < 0) return 'below and to the right';
    if (deltaX < 0 && deltaY < 0) return 'below and to the left';
    
    return 'near';
  }
}
```
--- END FILE: lib\math-engine\models\position-direction.model.ts ---

--- START FILE: lib\math-engine\models\shape-properties.model.ts ---
```typescript
import {
  IMathModel,
  ShapePropertiesDifficultyParams,
  ShapePropertiesOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class ShapePropertiesModel implements IMathModel<ShapePropertiesDifficultyParams, ShapePropertiesOutput> {
  public readonly model_id = "SHAPE_PROPERTIES";

  private static readonly SHAPE_PROPERTIES = {
    // 2D Shapes
    triangle: {
      sides: 3,
      vertices: 3,
      angles: 3,
      right_angles: 0, // for general triangle
      parallel_sides: 0,
      lines_of_symmetry: 3, // for equilateral
      rotational_symmetry: 3,
      interior_angle_sum: 180
    },
    square: {
      sides: 4,
      vertices: 4,
      angles: 4,
      right_angles: 4,
      parallel_sides: 2, // 2 pairs
      lines_of_symmetry: 4,
      rotational_symmetry: 4,
      interior_angle_sum: 360
    },
    rectangle: {
      sides: 4,
      vertices: 4,
      angles: 4,
      right_angles: 4,
      parallel_sides: 2, // 2 pairs
      lines_of_symmetry: 2,
      rotational_symmetry: 2,
      interior_angle_sum: 360
    },
    pentagon: {
      sides: 5,
      vertices: 5,
      angles: 5,
      right_angles: 0,
      parallel_sides: 0,
      lines_of_symmetry: 5, // for regular pentagon
      rotational_symmetry: 5,
      interior_angle_sum: 540
    },
    hexagon: {
      sides: 6,
      vertices: 6,
      angles: 6,
      right_angles: 0,
      parallel_sides: 3, // 3 pairs
      lines_of_symmetry: 6, // for regular hexagon
      rotational_symmetry: 6,
      interior_angle_sum: 720
    },
    circle: {
      sides: 0,
      vertices: 0,
      angles: 0,
      right_angles: 0,
      parallel_sides: 0,
      lines_of_symmetry: 'infinite',
      rotational_symmetry: 'infinite',
      interior_angle_sum: 0
    },
    rhombus: {
      sides: 4,
      vertices: 4,
      angles: 4,
      right_angles: 0,
      parallel_sides: 2, // 2 pairs
      lines_of_symmetry: 2,
      rotational_symmetry: 2,
      interior_angle_sum: 360
    },
    parallelogram: {
      sides: 4,
      vertices: 4,
      angles: 4,
      right_angles: 0,
      parallel_sides: 2, // 2 pairs
      lines_of_symmetry: 0,
      rotational_symmetry: 2,
      interior_angle_sum: 360
    }
  } as const;

  private static readonly PROPERTY_DESCRIPTIONS = {
    sides: 'straight edges',
    vertices: 'corners or points where sides meet',
    angles: 'corners formed where two sides meet',
    right_angles: 'square corners (90 degrees)',
    parallel_sides: 'pairs of sides that never meet',
    lines_of_symmetry: 'lines where the shape can be folded exactly in half',
    rotational_symmetry: 'number of times the shape looks the same when rotated 360Â°'
  };

  generate(params: ShapePropertiesDifficultyParams): ShapePropertiesOutput {
    const problemType = this.selectProblemType(params);
    const shapeName = randomChoice(params.shape_types);
    const propertyFocus = randomChoice(params.property_types);
    
    switch (problemType) {
      case 'count_properties':
        return this.generateCountPropertiesProblem(shapeName, propertyFocus, params);
      case 'identify_property':
        return this.generateIdentifyPropertyProblem(shapeName, propertyFocus, params);
      case 'compare_properties':
        return this.generateComparePropertiesProblem(params.shape_types, propertyFocus, params);
      case 'classify_shapes':
        return this.generateClassifyShapesProblem(params);
      default:
        return this.generateCountPropertiesProblem(shapeName, propertyFocus, params);
    }
  }

  getDefaultParams(year: number): ShapePropertiesDifficultyParams {
    if (year <= 2) {
      return {
        shape_types: ['triangle', 'square', 'rectangle', 'circle'],
        property_types: ['sides', 'vertices'],
        max_sides: 6,
        include_angle_types: false,
        include_symmetry: false,
        problem_complexity: 'simple'
      } as any;
    } else if (year <= 4) {
      return {
        shape_types: ['triangle', 'square', 'rectangle', 'pentagon', 'hexagon'],
        property_types: ['sides', 'vertices', 'angles', 'right_angles'],
        max_sides: 8,
        include_angle_types: true,
        include_symmetry: false,
        problem_complexity: 'medium'
      } as any;
    } else {
      return {
        shape_types: ['triangle', 'square', 'rectangle', 'pentagon', 'hexagon', 'rhombus', 'parallelogram'],
        property_types: ['sides', 'vertices', 'angles', 'right_angles', 'parallel_sides', 'lines_of_symmetry'],
        max_sides: 10,
        include_angle_types: true,
        include_symmetry: true,
        problem_complexity: 'complex'
      } as any;
    }
  }

  private selectProblemType(params: ShapePropertiesDifficultyParams): string {
    const problemTypes = ['count_properties', 'identify_property'];
    
    if (params.problem_complexity === 'medium') {
      problemTypes.push('compare_properties');
    }
    
    if (params.problem_complexity === 'complex') {
      problemTypes.push('compare_properties', 'classify_shapes');
    }
    
    return randomChoice(problemTypes);
  }

  private generateCountPropertiesProblem(
    shapeName: string, 
    propertyFocus: string, 
    params: ShapePropertiesDifficultyParams
  ): ShapePropertiesOutput {
    const shapeData = ShapePropertiesModel.SHAPE_PROPERTIES[shapeName as keyof typeof ShapePropertiesModel.SHAPE_PROPERTIES];
    const propertyValue = shapeData[propertyFocus as keyof typeof shapeData];
    
    // Handle special cases
    let correctAnswer: string | number = propertyValue;
    if (propertyValue === 'infinite') {
      correctAnswer = 'infinite';
    } else if (typeof propertyValue === 'number') {
      correctAnswer = propertyValue;
    }

    return {
      operation: "SHAPE_PROPERTIES",
      problem_type: 'count_properties',
      shape_name: shapeName,
      properties: {
        sides: shapeData.sides,
        vertices: shapeData.vertices,
        angles: shapeData.angles,
        right_angles: shapeData.right_angles,
        parallel_sides: shapeData.parallel_sides,
        lines_of_symmetry: shapeData.lines_of_symmetry,
        rotational_symmetry: shapeData.rotational_symmetry
      },
      question_focus: propertyFocus,
      correct_answer: correctAnswer,
      explanation: `A ${shapeName} has ${correctAnswer} ${ShapePropertiesModel.PROPERTY_DESCRIPTIONS[propertyFocus as keyof typeof ShapePropertiesModel.PROPERTY_DESCRIPTIONS] || propertyFocus}.`
    } as any;
  }

  private generateIdentifyPropertyProblem(
    shapeName: string, 
    propertyFocus: string, 
    params: ShapePropertiesDifficultyParams
  ): ShapePropertiesOutput {
    const shapeData = ShapePropertiesModel.SHAPE_PROPERTIES[shapeName as keyof typeof ShapePropertiesModel.SHAPE_PROPERTIES];
    
    // Create a property-based question
    let correctAnswer: string;
    let explanation: string;
    
    switch (propertyFocus) {
      case 'right_angles':
        correctAnswer = shapeData.right_angles > 0 ? 'yes' : 'no';
        explanation = `A ${shapeName} ${shapeData.right_angles > 0 ? 'has' : 'does not have'} right angles.`;
        break;
      case 'parallel_sides':
        correctAnswer = shapeData.parallel_sides > 0 ? 'yes' : 'no';
        explanation = `A ${shapeName} ${shapeData.parallel_sides > 0 ? 'has' : 'does not have'} parallel sides.`;
        break;
      default:
        correctAnswer = String(shapeData[propertyFocus as keyof typeof shapeData]);
        explanation = `A ${shapeName} has ${correctAnswer} ${propertyFocus}.`;
    }

    return {
      operation: "SHAPE_PROPERTIES",
      problem_type: 'identify_property',
      shape_name: shapeName,
      properties: {
        sides: shapeData.sides,
        vertices: shapeData.vertices,
        angles: shapeData.angles,
        right_angles: shapeData.right_angles,
        parallel_sides: shapeData.parallel_sides,
        lines_of_symmetry: shapeData.lines_of_symmetry,
        rotational_symmetry: shapeData.rotational_symmetry
      },
      question_focus: propertyFocus,
      correct_answer: correctAnswer,
      explanation
    } as any;
  }

  private generateComparePropertiesProblem(
    shapeTypes: string[], 
    propertyFocus: string, 
    params: ShapePropertiesDifficultyParams
  ): ShapePropertiesOutput {
    const shape1 = randomChoice(shapeTypes);
    const availableShapes = shapeTypes.filter(s => s !== shape1);
    const shape2 = randomChoice(availableShapes);
    
    const shape1Data = ShapePropertiesModel.SHAPE_PROPERTIES[shape1 as keyof typeof ShapePropertiesModel.SHAPE_PROPERTIES];
    const shape2Data = ShapePropertiesModel.SHAPE_PROPERTIES[shape2 as keyof typeof ShapePropertiesModel.SHAPE_PROPERTIES];
    
    const value1 = shape1Data[propertyFocus as keyof typeof shape1Data];
    const value2 = shape2Data[propertyFocus as keyof typeof shape2Data];
    
    let correctAnswer: string;
    let explanation: string;
    
    if (typeof value1 === 'number' && typeof value2 === 'number') {
      if (value1 > value2) {
        correctAnswer = shape1;
        explanation = `A ${shape1} has ${value1} ${propertyFocus}, while a ${shape2} has ${value2} ${propertyFocus}.`;
      } else if (value2 > value1) {
        correctAnswer = shape2;
        explanation = `A ${shape2} has ${value2} ${propertyFocus}, while a ${shape1} has ${value1} ${propertyFocus}.`;
      } else {
        correctAnswer = 'equal';
        explanation = `Both shapes have ${value1} ${propertyFocus}.`;
      }
    } else {
      correctAnswer = 'cannot compare';
      explanation = `These shapes have different types of ${propertyFocus}.`;
    }

    return {
      operation: "SHAPE_PROPERTIES",
      problem_type: 'compare_properties',
      shape_name: `${shape1} vs ${shape2}`,
      properties: {
        sides: 0,
        vertices: 0,
        angles: 0,
        right_angles: 0,
        parallel_sides: 0
      },
      question_focus: propertyFocus,
      correct_answer: correctAnswer,
      explanation
    } as any;
  }

  private generateClassifyShapesProblem(params: ShapePropertiesDifficultyParams): ShapePropertiesOutput {
    const propertyFocus = randomChoice(params.property_types);
    
    // Find shapes that share a common property
    const shapesWithProperty: string[] = [];
    const shapesWithoutProperty: string[] = [];
    
    for (const shapeName of params.shape_types) {
      const shapeData = ShapePropertiesModel.SHAPE_PROPERTIES[shapeName as keyof typeof ShapePropertiesModel.SHAPE_PROPERTIES];
      const propertyValue = shapeData[propertyFocus as keyof typeof shapeData];
      
      if (propertyFocus === 'right_angles' && typeof propertyValue === 'number' && propertyValue > 0) {
        shapesWithProperty.push(shapeName);
      } else if (propertyFocus === 'parallel_sides' && typeof propertyValue === 'number' && propertyValue > 0) {
        shapesWithProperty.push(shapeName);
      } else if (propertyFocus === 'sides' && typeof propertyValue === 'number' && propertyValue === 4) {
        shapesWithProperty.push(shapeName);
      } else {
        shapesWithoutProperty.push(shapeName);
      }
    }
    
    const correctAnswer = shapesWithProperty.join(', ');
    
    return {
      operation: "SHAPE_PROPERTIES",
      problem_type: 'classify_shapes',
      shape_name: 'multiple shapes',
      properties: {
        sides: 0,
        vertices: 0,
        angles: 0,
        right_angles: 0,
        parallel_sides: 0
      },
      question_focus: propertyFocus,
      correct_answer: correctAnswer,
      explanation: `Shapes with the specified property: ${correctAnswer}`
    } as any;
  }
}
```
--- END FILE: lib\math-engine\models\shape-properties.model.ts ---

--- START FILE: lib\math-engine\models\shape-recognition.model.ts ---
```typescript
import {
  IMathModel,
  ShapeRecognitionDifficultyParams,
  ShapeRecognitionOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class ShapeRecognitionModel implements IMathModel<ShapeRecognitionDifficultyParams, ShapeRecognitionOutput> {
  public readonly model_id = "SHAPE_RECOGNITION";

  private static readonly SHAPE_DATA = {
    // 2D Shapes
    circle: {
      type: '2d',
      sides: 0,
      vertices: 0,
      properties: ['curved', 'no_sides', 'no_vertices', 'symmetric'],
      category: 'circle'
    },
    triangle: {
      type: '2d',
      sides: 3,
      vertices: 3,
      properties: ['straight_sides', 'three_sides', 'three_vertices'],
      category: 'polygon'
    },
    square: {
      type: '2d',
      sides: 4,
      vertices: 4,
      properties: ['straight_sides', 'equal_sides', 'four_sides', 'right_angles'],
      category: 'quadrilateral'
    },
    rectangle: {
      type: '2d',
      sides: 4,
      vertices: 4,
      properties: ['straight_sides', 'parallel_sides', 'four_sides', 'right_angles'],
      category: 'quadrilateral'
    },
    pentagon: {
      type: '2d',
      sides: 5,
      vertices: 5,
      properties: ['straight_sides', 'five_sides', 'five_vertices'],
      category: 'polygon'
    },
    hexagon: {
      type: '2d',
      sides: 6,
      vertices: 6,
      properties: ['straight_sides', 'six_sides', 'six_vertices'],
      category: 'polygon'
    },
    // 3D Shapes
    cube: {
      type: '3d',
      faces: 6,
      edges: 12,
      vertices: 8,
      properties: ['square_faces', 'equal_edges', 'six_faces'],
      category: 'polyhedron'
    },
    sphere: {
      type: '3d',
      faces: 1,
      edges: 0,
      vertices: 0,
      properties: ['curved_surface', 'no_edges', 'no_vertices'],
      category: 'curved_3d'
    },
    cylinder: {
      type: '3d',
      faces: 3,
      edges: 2,
      vertices: 0,
      properties: ['curved_surface', 'circular_bases', 'three_faces'],
      category: 'curved_3d'
    },
    cone: {
      type: '3d',
      faces: 2,
      edges: 1,
      vertices: 1,
      properties: ['curved_surface', 'circular_base', 'pointed_top'],
      category: 'curved_3d'
    },
    pyramid: {
      type: '3d',
      faces: 5,
      edges: 8,
      vertices: 5,
      properties: ['triangular_faces', 'square_base', 'pointed_top'],
      category: 'polyhedron'
    }
  } as const;

  generate(params: ShapeRecognitionDifficultyParams): ShapeRecognitionOutput {
    const problemType = randomChoice(params.problem_types);
    const availableShapes = [...params.include_2d_shapes, ...params.include_3d_shapes];
    
    switch (problemType) {
      case 'identify_shape':
        return this.generateIdentifyShapeProblem(availableShapes);
      case 'count_sides':
        return this.generateCountSidesProblem(params);
      case 'count_vertices':
        return this.generateCountVerticesProblem(params);
      case 'compare_shapes':
        return this.generateCompareShapesProblem(availableShapes);
      default:
        return this.generateIdentifyShapeProblem(availableShapes);
    }
  }

  getDefaultParams(year: number): ShapeRecognitionDifficultyParams {
    if (year <= 1) {
      return {
        include_2d_shapes: ['circle', 'triangle', 'square'],
        include_3d_shapes: ['cube', 'sphere'],
        problem_types: ['identify_shape'],
        max_shapes_count: 1,
        include_irregular_shapes: false,
        allow_rotations: false
      } as any;
    } else if (year <= 2) {
      return {
        include_2d_shapes: ['circle', 'triangle', 'square', 'rectangle'],
        include_3d_shapes: ['cube', 'sphere', 'cylinder'],
        problem_types: ['identify_shape', 'count_sides'],
        max_shapes_count: 2,
        include_irregular_shapes: false,
        allow_rotations: false
      } as any;
    } else if (year <= 4) {
      return {
        include_2d_shapes: ['circle', 'triangle', 'square', 'rectangle', 'pentagon'],
        include_3d_shapes: ['cube', 'sphere', 'cylinder', 'cone'],
        problem_types: ['identify_shape', 'count_sides', 'count_vertices'],
        max_shapes_count: 3,
        include_irregular_shapes: false,
        allow_rotations: true
      } as any;
    } else {
      return {
        include_2d_shapes: ['circle', 'triangle', 'square', 'rectangle', 'pentagon', 'hexagon'],
        include_3d_shapes: ['cube', 'sphere', 'cylinder', 'cone', 'pyramid'],
        problem_types: ['identify_shape', 'count_sides', 'count_vertices', 'compare_shapes'],
        max_shapes_count: 4,
        include_irregular_shapes: true,
        allow_rotations: true
      } as any;
    }
  }

  private generateIdentifyShapeProblem(availableShapes: string[]): ShapeRecognitionOutput {
    const targetShape = randomChoice(availableShapes);
    const shapeInfo = ShapeRecognitionModel.SHAPE_DATA[targetShape as keyof typeof ShapeRecognitionModel.SHAPE_DATA];
    
    // Generate distractors (wrong answers)
    const distractors = availableShapes
      .filter(shape => shape !== targetShape)
      .slice(0, 3);

    return {
      operation: "SHAPE_RECOGNITION",
      problem_type: 'identify_shape',
      shape_data: [{
        name: targetShape,
        type: shapeInfo.type,
        sides: (shapeInfo as any).sides,
        vertices: (shapeInfo as any).vertices,
        properties: [...shapeInfo.properties],
        category: shapeInfo.category
      }],
      target_shape: targetShape,
      correct_answer: targetShape,
      distractors
    } as any;
  }

  private generateCountSidesProblem(params: ShapeRecognitionDifficultyParams): ShapeRecognitionOutput {
    // Focus on 2D shapes for counting sides
    const available2D = params.include_2d_shapes.filter(shape => 
      shape !== 'circle' // Circles don't have sides in the traditional sense
    );
    
    if (available2D.length === 0) {
      // Fallback to identify shape if no suitable shapes
      return this.generateIdentifyShapeProblem([...params.include_2d_shapes, ...params.include_3d_shapes]);
    }

    const targetShape = randomChoice(available2D);
    const shapeInfo = ShapeRecognitionModel.SHAPE_DATA[targetShape as keyof typeof ShapeRecognitionModel.SHAPE_DATA];

    return {
      operation: "SHAPE_RECOGNITION",
      problem_type: 'count_sides',
      shape_data: [{
        name: targetShape,
        type: shapeInfo.type,
        sides: (shapeInfo as any).sides,
        vertices: (shapeInfo as any).vertices,
        properties: [...shapeInfo.properties],
        category: shapeInfo.category
      }],
      target_shape: targetShape,
      correct_answer: (shapeInfo as any).sides || 0
    } as any;
  }

  private generateCountVerticesProblem(params: ShapeRecognitionDifficultyParams): ShapeRecognitionOutput {
    // Focus on shapes that have vertices
    const availableShapes = [...params.include_2d_shapes, ...params.include_3d_shapes]
      .filter(shape => shape !== 'circle' && shape !== 'sphere' && shape !== 'cylinder');
    
    if (availableShapes.length === 0) {
      // Fallback if no suitable shapes
      return this.generateIdentifyShapeProblem([...params.include_2d_shapes, ...params.include_3d_shapes]);
    }

    const targetShape = randomChoice(availableShapes);
    const shapeInfo = ShapeRecognitionModel.SHAPE_DATA[targetShape as keyof typeof ShapeRecognitionModel.SHAPE_DATA];

    return {
      operation: "SHAPE_RECOGNITION",
      problem_type: 'count_vertices',
      shape_data: [{
        name: targetShape,
        type: shapeInfo.type,
        sides: (shapeInfo as any).sides,
        vertices: (shapeInfo as any).vertices,
        properties: [...shapeInfo.properties],
        category: shapeInfo.category
      }],
      target_shape: targetShape,
      correct_answer: (shapeInfo as any).vertices || 0
    } as any;
  }

  private generateCompareShapesProblem(availableShapes: string[]): ShapeRecognitionOutput {
    const shape1 = randomChoice(availableShapes);
    const remainingShapes = availableShapes.filter(s => s !== shape1);
    const shape2 = randomChoice(remainingShapes);
    
    const shape1Info = ShapeRecognitionModel.SHAPE_DATA[shape1 as keyof typeof ShapeRecognitionModel.SHAPE_DATA];
    const shape2Info = ShapeRecognitionModel.SHAPE_DATA[shape2 as keyof typeof ShapeRecognitionModel.SHAPE_DATA];

    // Compare by number of sides
    let comparisonResult: string;
    let correctAnswer: string;
    
    const sides1 = (shape1Info as any).sides || 0;
    const sides2 = (shape2Info as any).sides || 0;
    
    if (sides1 > sides2) {
      comparisonResult = 'first_more_sides';
      correctAnswer = `${shape1} has more sides`;
    } else if (sides2 > sides1) {
      comparisonResult = 'second_more_sides';
      correctAnswer = `${shape2} has more sides`;
    } else {
      comparisonResult = 'equal_sides';
      correctAnswer = 'Both shapes have the same number of sides';
    }

    return {
      operation: "SHAPE_RECOGNITION",
      problem_type: 'compare_shapes',
      shape_data: [
        {
          name: shape1,
          type: shape1Info.type,
          sides: (shape1Info as any).sides,
          vertices: (shape1Info as any).vertices,
          properties: [...shape1Info.properties],
          category: shape1Info.category
        },
        {
          name: shape2,
          type: shape2Info.type,
          sides: (shape2Info as any).sides,
          vertices: (shape2Info as any).vertices,
          properties: [...shape2Info.properties],
          category: shape2Info.category
        }
      ],
      comparison_result: comparisonResult,
      correct_answer: correctAnswer
    } as any;
  }
}
```
--- END FILE: lib\math-engine\models\shape-recognition.model.ts ---

--- START FILE: lib\math-engine\models\subtraction.model.ts ---
```typescript
import {
  IMathModel,
  SubtractionDifficultyParams,
  SubtractionOutput,
  DecimalFormatted
} from '@/lib/types';
import {
  generateRandomNumber,
  formatDecimal,
  requiresBorrowing
} from '@/lib/utils';

export class SubtractionModel implements IMathModel<SubtractionDifficultyParams, SubtractionOutput> {
  public readonly model_id = "SUBTRACTION";

  generate(params: SubtractionDifficultyParams): SubtractionOutput {
    const { minuend, subtrahend } = this.generateOperands(params);
    const result = this.calculateDifference(minuend, subtrahend);
    const decimalFormatted = this.formatOutput(minuend, subtrahend, result, params.decimal_places);

    return {
      operation: "SUBTRACTION",
      minuend,
      subtrahend,
      result,
      decimal_formatted: decimalFormatted
    };
  }

  getDefaultParams(year: number): SubtractionDifficultyParams {
    if (year <= 2) {
      return {
        minuend_max: 20,
        subtrahend_max: 10,
        decimal_places: 0,
        allow_borrowing: false,
        ensure_positive: true,
        value_constraints: {
          step: 1
        }
      };
    } else if (year <= 4) {
      return {
        minuend_max: 100,
        subtrahend_max: 100,
        decimal_places: year === 4 ? 2 : 0,
        allow_borrowing: true,
        ensure_positive: true,
        value_constraints: {
          step: year === 4 ? 0.01 : 1
        }
      };
    } else {
      return {
        minuend_max: 1000,
        subtrahend_max: 1000,
        decimal_places: 3,
        allow_borrowing: true,
        ensure_positive: true,
        value_constraints: {
          step: 0.001
        }
      };
    }
  }

  private generateOperands(params: SubtractionDifficultyParams): { minuend: number; subtrahend: number } {
    let attempts = 0;
    const maxAttempts = 50;

    while (attempts < maxAttempts) {
      let minuend = generateRandomNumber(
        params.minuend_max,
        params.decimal_places,
        1,
        params.value_constraints.step
      );
      
      let subtrahend = generateRandomNumber(
        params.subtrahend_max,
        params.decimal_places,
        1,
        params.value_constraints.step
      );

      // Ensure positive result if required
      if (params.ensure_positive && subtrahend > minuend) {
        [minuend, subtrahend] = [subtrahend, minuend];
      }

      // Check borrowing requirement
      const needsBorrowing = requiresBorrowing(minuend, subtrahend);
      
      if (params.allow_borrowing || !needsBorrowing) {
        return { minuend, subtrahend };
      }

      attempts++;
    }

    // Fallback: ensure positive result
    let minuend = generateRandomNumber(
      params.minuend_max,
      params.decimal_places,
      1,
      params.value_constraints.step
    );
    
    let subtrahend = generateRandomNumber(
      Math.min(params.subtrahend_max, minuend),
      params.decimal_places,
      1,
      params.value_constraints.step
    );

    if (params.ensure_positive && subtrahend > minuend) {
      [minuend, subtrahend] = [subtrahend, minuend];
    }

    return { minuend, subtrahend };
  }

  private calculateDifference(minuend: number, subtrahend: number): number {
    const difference = minuend - subtrahend;
    // Handle floating point precision
    return Math.round(difference * 1000) / 1000;
  }

  private formatOutput(
    minuend: number,
    subtrahend: number,
    result: number,
    decimalPlaces: number
  ): DecimalFormatted {
    return {
      minuend: formatDecimal(minuend, decimalPlaces),
      subtrahend: formatDecimal(subtrahend, decimalPlaces),
      result: formatDecimal(result, decimalPlaces)
    };
  }
}
```
--- END FILE: lib\math-engine\models\subtraction.model.ts ---

--- START FILE: lib\math-engine\models\time-rate.model.ts ---
```typescript
import {
  IMathModel,
  TimeRateDifficultyParams,
  TimeRateOutput
} from '@/lib/types';
import {
  generateRandomNumber,
  randomChoice
} from '@/lib/utils';

export class TimeRateModel implements IMathModel<TimeRateDifficultyParams, TimeRateOutput> {
  public readonly model_id = "TIME_RATE";

  private static readonly PERIOD_MULTIPLIERS = {
    day: 1,
    week: 7,
    month: 30,
    year: 365
  };

  generate(params: TimeRateDifficultyParams): TimeRateOutput {
    const rate = this.generateRate(params);
    const calculation = this.generateCalculation(params, rate);

    return {
      operation: "TIME_RATE",
      rate: {
        value: rate.value,
        period: rate.period
      },
      calculation: {
        periods: calculation.periods,
        total_value: calculation.total_value
      },
      problem_type: params.problem_type
    };
  }

  getDefaultParams(year: number): TimeRateDifficultyParams {
    if (year <= 2) {
      return {
        rate_value_max: 10,
        rate_period: "day",
        target_value_max: 50,
        decimal_places: 0,
        problem_type: "total_after_time"
      };
    } else if (year <= 4) {
      return {
        rate_value_max: 50,
        rate_period: randomChoice(["day", "week"]),
        target_value_max: 200,
        decimal_places: 2,
        problem_type: randomChoice(["time_to_target", "total_after_time"])
      };
    } else {
      return {
        rate_value_max: 100,
        rate_period: randomChoice(["week", "month", "year"]),
        target_value_max: 1000,
        decimal_places: 2,
        problem_type: randomChoice(["time_to_target", "total_after_time", "rate_calculation"])
      };
    }
  }

  private generateRate(params: TimeRateDifficultyParams): {
    value: number;
    period: string;
  } {
    const value = generateRandomNumber(
      params.rate_value_max,
      params.decimal_places,
      0.01,
      params.decimal_places > 0 ? 0.01 : 1
    );

    return {
      value,
      period: params.rate_period
    };
  }

  private generateCalculation(
    params: TimeRateDifficultyParams,
    rate: { value: number; period: string }
  ): { periods: number; total_value: number } {
    switch (params.problem_type) {
      case "time_to_target":
        return this.calculateTimeToTarget(params, rate);
      
      case "total_after_time":
        return this.calculateTotalAfterTime(params, rate);
      
      case "rate_calculation":
        return this.calculateRateFromTotal(params, rate);
      
      default:
        return this.calculateTotalAfterTime(params, rate);
    }
  }

  private calculateTimeToTarget(
    params: TimeRateDifficultyParams,
    rate: { value: number; period: string }
  ): { periods: number; total_value: number } {
    // Generate a target value and calculate time needed
    const targetValue = generateRandomNumber(
      params.target_value_max,
      params.decimal_places,
      rate.value,
      params.decimal_places > 0 ? 0.01 : 1
    );

    const periods = Math.ceil(targetValue / rate.value);
    
    return {
      periods,
      total_value: targetValue
    };
  }

  private calculateTotalAfterTime(
    params: TimeRateDifficultyParams,
    rate: { value: number; period: string }
  ): { periods: number; total_value: number } {
    // Generate a time period and calculate total
    const maxPeriods = Math.floor(params.target_value_max / rate.value);
    const periods = Math.max(1, Math.floor(Math.random() * Math.min(maxPeriods, 52)) + 1);
    
    const totalValue = periods * rate.value;
    
    return {
      periods,
      total_value: Math.round(totalValue * 100) / 100
    };
  }

  private calculateRateFromTotal(
    params: TimeRateDifficultyParams,
    rate: { value: number; period: string }
  ): { periods: number; total_value: number } {
    // Generate total and periods, calculate rate (rate is given in this case)
    const periods = Math.floor(Math.random() * 20) + 2;
    const totalValue = periods * rate.value;
    
    return {
      periods,
      total_value: Math.round(totalValue * 100) / 100
    };
  }

  // Helper method to get period display name
  static getPeriodDisplayName(period: string, count: number = 1): string {
    const names = {
      day: count === 1 ? 'day' : 'days',
      week: count === 1 ? 'week' : 'weeks',
      month: count === 1 ? 'month' : 'months',
      year: count === 1 ? 'year' : 'years'
    };
    
    return names[period as keyof typeof names] || period;
  }

  // Helper method to convert between periods
  static convertPeriods(
    fromPeriod: string,
    toPeriod: string,
    value: number
  ): number {
    const fromDays = TimeRateModel.PERIOD_MULTIPLIERS[fromPeriod as keyof typeof TimeRateModel.PERIOD_MULTIPLIERS];
    const toDays = TimeRateModel.PERIOD_MULTIPLIERS[toPeriod as keyof typeof TimeRateModel.PERIOD_MULTIPLIERS];
    
    if (!fromDays || !toDays) return value;
    
    return Math.round((value * fromDays / toDays) * 100) / 100;
  }
}
```
--- END FILE: lib\math-engine\models\time-rate.model.ts ---

--- START FILE: lib\math-engine\models\unit-rate.model.ts ---
```typescript
import {
  IMathModel,
  UnitRateDifficultyParams,
  UnitRateOutput
} from '@/lib/types';
import {
  randomChoice,
  generateRandomNumber
} from '@/lib/utils';

export class UnitRateModel implements IMathModel<UnitRateDifficultyParams, UnitRateOutput> {
  public readonly model_id = "UNIT_RATE";

  private static readonly RATE_CONTEXTS = {
    speed: { unit: 'km/h', items: ['car', 'bike', 'bus', 'train'] },
    cost: { unit: 'Â£/item', items: ['apple', 'book', 'pencil', 'toy'] },
    production: { unit: 'items/hour', items: ['widget', 'cake', 'bottle', 'box'] },
    consumption: { unit: 'litres/100km', items: ['car', 'van', 'truck', 'motorbike'] },
    wage: { unit: 'Â£/hour', items: ['job', 'work', 'position', 'role'] }
  };

  generate(params: UnitRateDifficultyParams): UnitRateOutput {
    const context = randomChoice(Object.keys(UnitRateModel.RATE_CONTEXTS));
    const contextData = UnitRateModel.RATE_CONTEXTS[context as keyof typeof UnitRateModel.RATE_CONTEXTS];
    
    const item = randomChoice(contextData.items);
    const baseQuantity = this.generateBaseQuantity(params);
    const baseRate = this.generateBaseRate(params);
    const unitRate = this.calculateUnitRate(baseRate, baseQuantity, params);
    
    // Generate target quantity for scaling
    const targetQuantity = this.generateTargetQuantity(params, baseQuantity);
    const scaledValue = this.calculateScaledValue(unitRate, targetQuantity, params);

    // Determine problem type
    const problemType = this.selectProblemType(params);

    return {
      operation: "UNIT_RATE",
      context,
      item,
      unit: contextData.unit,
      base_quantity: baseQuantity,
      base_rate: baseRate,
      unit_rate: unitRate,
      target_quantity: targetQuantity,
      scaled_value: scaledValue,
      problem_type: problemType,
      comparison_rates: this.generateComparisonRates(params, context, unitRate)
    } as any;
  }

  getDefaultParams(year: number): UnitRateDifficultyParams {
    if (year <= 3) {
      return {
        base_quantity_range: { min: 2, max: 10 },
        base_rate_range: { min: 10, max: 50 },
        target_quantity_range: { min: 1, max: 20 },
        decimal_places: 0,
        allow_complex_rates: false,
        problem_types: ['find_unit_rate', 'scale_up'],
        include_comparisons: false,
        comparison_count: 0
      };
    } else if (year <= 4) {
      return {
        base_quantity_range: { min: 2, max: 20 },
        base_rate_range: { min: 5, max: 100 },
        target_quantity_range: { min: 1, max: 50 },
        decimal_places: 1,
        allow_complex_rates: false,
        problem_types: ['find_unit_rate', 'scale_up', 'scale_down'],
        include_comparisons: true,
        comparison_count: 2
      };
    } else {
      return {
        base_quantity_range: { min: 2, max: 50 },
        base_rate_range: { min: 1, max: 200 },
        target_quantity_range: { min: 1, max: 100 },
        decimal_places: 2,
        allow_complex_rates: true,
        problem_types: ['find_unit_rate', 'scale_up', 'scale_down', 'compare_rates', 'best_value'],
        include_comparisons: true,
        comparison_count: 3
      };
    }
  }

  private generateBaseQuantity(params: UnitRateDifficultyParams): number {
    return generateRandomNumber(
      params.base_quantity_range.max,
      0, // Quantities are typically whole numbers
      params.base_quantity_range.min
    );
  }

  private generateBaseRate(params: UnitRateDifficultyParams): number {
    return generateRandomNumber(
      params.base_rate_range.max,
      params.decimal_places,
      params.base_rate_range.min
    );
  }

  private generateTargetQuantity(params: UnitRateDifficultyParams, baseQuantity: number): number {
    let targetQuantity: number;
    let attempts = 0;
    const maxAttempts = 100;
    
    // Calculate available options excluding base quantity
    const availableValues: number[] = [];
    for (let i = params.target_quantity_range.min; i <= params.target_quantity_range.max; i++) {
      if (i !== baseQuantity) {
        availableValues.push(i);
      }
    }
    
    // If no alternatives available, return a safe fallback
    if (availableValues.length === 0) {
      return baseQuantity + 1 <= params.target_quantity_range.max ? 
        baseQuantity + 1 : 
        Math.max(params.target_quantity_range.min, baseQuantity - 1);
    }
    
    do {
      targetQuantity = generateRandomNumber(
        params.target_quantity_range.max,
        0,
        params.target_quantity_range.min
      );
      attempts++;
      
      // Safety valve to prevent infinite loops
      if (attempts > maxAttempts) {
        targetQuantity = randomChoice(availableValues);
        break;
      }
    } while (targetQuantity === baseQuantity);

    return targetQuantity;
  }

  private calculateUnitRate(baseRate: number, baseQuantity: number, params: UnitRateDifficultyParams): number {
    const rate = baseRate / baseQuantity;
    return Math.round(rate * Math.pow(10, params.decimal_places)) / Math.pow(10, params.decimal_places);
  }

  private calculateScaledValue(unitRate: number, targetQuantity: number, params: UnitRateDifficultyParams): number {
    const value = unitRate * targetQuantity;
    return Math.round(value * Math.pow(10, params.decimal_places)) / Math.pow(10, params.decimal_places);
  }

  private selectProblemType(params: UnitRateDifficultyParams): string {
    return randomChoice(params.problem_types);
  }

  private generateComparisonRates(
    params: UnitRateDifficultyParams, 
    context: string, 
    baseUnitRate: number
  ): Array<{ quantity: number; rate: number; unit_rate: number; better: boolean }> {
    if (!params.include_comparisons || params.comparison_count === 0) {
      return [];
    }

    const comparisons: Array<{ quantity: number; rate: number; unit_rate: number; better: boolean }> = [];
    
    for (let i = 0; i < params.comparison_count; i++) {
      const quantity = generateRandomNumber(
        params.base_quantity_range.max,
        0,
        params.base_quantity_range.min
      );
      
      // Generate a rate that creates either better or worse unit rate
      const isBetter = Math.random() > 0.5;
      
      // Create multiplier for better/worse rates using proper random float generation
      let rateMultiplier: number;
      if (isBetter) {
        // For better rates: 0.7 to 0.95 (5% to 30% better)
        const min = 0.7;
        const max = 0.95;
        rateMultiplier = Math.random() * (max - min) + min;
      } else {
        // For worse rates: 1.05 to 1.4 (5% to 40% worse)
        const min = 1.05;
        const max = 1.4;
        rateMultiplier = Math.random() * (max - min) + min;
      }
      
      // Round to appropriate decimal places
      rateMultiplier = Math.round(rateMultiplier * 100) / 100;

      const rate = Math.round(baseUnitRate * quantity * rateMultiplier * Math.pow(10, params.decimal_places)) / Math.pow(10, params.decimal_places);
      const unitRate = this.calculateUnitRate(rate, quantity, params);
      
      // Determine if this is better based on context
      let better: boolean;
      if (context === 'cost') {
        better = unitRate < baseUnitRate; // Lower cost per unit is better
      } else if (context === 'consumption') {
        better = unitRate < baseUnitRate; // Lower consumption is better
      } else {
        better = unitRate > baseUnitRate; // Higher rate is generally better
      }

      comparisons.push({
        quantity,
        rate,
        unit_rate: unitRate,
        better
      });
    }

    return comparisons;
  }
}
```
--- END FILE: lib\math-engine\models\unit-rate.model.ts ---

--- START FILE: lib\math-engine\progression-tracker.ts ---
```typescript
import {
  SubDifficultyLevel,
  PerformanceData,
  DifficultyAdjustment,
  StudentSession
} from '@/lib/types-enhanced';

import { EnhancedDifficultySystem } from './difficulty-enhanced';

/**
 * Tracks student progression and makes adaptive difficulty recommendations
 */
export class ProgressionTracker {
  
  private static sessions: Map<string, StudentSession> = new Map();
  
  /**
   * Create or retrieve a student session
   */
  static getSession(sessionId: string, studentId?: string): StudentSession {
    if (!this.sessions.has(sessionId)) {
      const session: StudentSession = {
        sessionId,
        studentId,
        startTime: new Date(),
        currentModel: 'ADDITION',
        currentLevel: EnhancedDifficultySystem.createLevel(3, 3), // Default to 3.3
        performanceHistory: [],
        adaptiveMode: true,
        confidenceMode: false,
        streakCount: 0,
        totalQuestions: 0,
        correctAnswers: 0
      };
      this.sessions.set(sessionId, session);
    }
    return this.sessions.get(sessionId)!;
  }

  /**
   * Record a student's attempt at a question
   */
  static recordAttempt(
    sessionId: string,
    questionId: string,
    modelId: string,
    level: SubDifficultyLevel,
    isCorrect: boolean,
    timeSpent: number,
    hintUsed: boolean = false,
    attemptsRequired: number = 1
  ): void {
    const session = this.getSession(sessionId);
    
    const performanceData: PerformanceData = {
      questionId,
      modelId,
      level,
      isCorrect,
      timeSpent,
      timestamp: new Date(),
      hintUsed,
      attemptsRequired
    };
    
    session.performanceHistory.push(performanceData);
    session.totalQuestions++;
    session.currentModel = modelId;
    session.currentLevel = level;
    
    if (isCorrect) {
      session.correctAnswers++;
      session.streakCount = Math.max(0, session.streakCount) + 1;
    } else {
      session.streakCount = Math.min(0, session.streakCount) - 1;
    }
    
    // Update session data
    this.sessions.set(sessionId, session);
  }

  /**
   * Get recommended next difficulty level based on performance
   */
  static getRecommendedLevel(
    sessionId: string,
    modelId: string
  ): SubDifficultyLevel {
    const session = this.getSession(sessionId);
    
    if (!session.adaptiveMode) {
      return session.currentLevel; // No automatic progression
    }
    
    const adjustment = this.analyzePerformance(session, modelId);
    return adjustment.toLevel;
  }

  /**
   * Analyze student performance and recommend difficulty adjustment
   */
  static analyzePerformance(
    session: StudentSession,
    modelId: string
  ): DifficultyAdjustment {
    const recentHistory = this.getRecentHistory(session, modelId, 10);
    const currentLevel = session.currentLevel;
    
    // Special handling for confidence mode
    if (session.confidenceMode) {
      return this.handleConfidenceMode(session, currentLevel);
    }
    
    // Analyze performance patterns
    const consecutiveCorrect = this.getConsecutiveCorrect(recentHistory);
    const consecutiveIncorrect = this.getConsecutiveIncorrect(recentHistory);
    const recentAccuracy = this.getAccuracy(recentHistory);
    
    // Apply adjustment rules
    return this.applyAdjustmentRules(
      currentLevel,
      consecutiveCorrect,
      consecutiveIncorrect,
      recentAccuracy,
      session.streakCount
    );
  }

  /**
   * Apply confidence-based adjustment rules
   */
  private static applyAdjustmentRules(
    currentLevel: SubDifficultyLevel,
    consecutiveCorrect: number,
    consecutiveIncorrect: number,
    recentAccuracy: number,
    streakCount: number
  ): DifficultyAdjustment {
    
    // Check for advancement triggers
    if (consecutiveCorrect >= 7) {
      return this.createAdvancement(currentLevel, 0.3, 'Seven consecutive correct answers');
    } else if (consecutiveCorrect >= 5) {
      return this.createAdvancement(currentLevel, 0.2, 'Five consecutive correct answers');
    } else if (consecutiveCorrect >= 3) {
      return this.createAdvancement(currentLevel, 0.1, 'Three consecutive correct answers');
    }
    
    // Check for support triggers  
    if (consecutiveIncorrect >= 4) {
      return this.createReduction(currentLevel, 'lock', 'Four consecutive incorrect - entering confidence mode');
    } else if (consecutiveIncorrect >= 3) {
      return this.createReduction(currentLevel, 0.2, 'Three consecutive incorrect answers');
    } else if (consecutiveIncorrect >= 2) {
      return this.createReduction(currentLevel, 0.1, 'Two consecutive incorrect answers');
    }
    
    // Check accuracy over last 10 questions
    if (recentAccuracy < 0.5) {
      return this.createReduction(currentLevel, 0.1, 'Accuracy below 50% in recent questions');
    } else if (recentAccuracy > 0.8) {
      return this.createAdvancement(currentLevel, 0.1, 'Accuracy above 80% in recent questions');
    }
    
    // Maintain current level
    return {
      action: 'maintain',
      fromLevel: currentLevel,
      toLevel: currentLevel,
      reason: 'Performance indicates appropriate difficulty level',
      confidence: recentAccuracy,
      recommendation: 'Continue at current level'
    };
  }

  /**
   * Handle confidence mode progression
   */
  private static handleConfidenceMode(
    session: StudentSession,
    currentLevel: SubDifficultyLevel
  ): DifficultyAdjustment {
    const recentHistory = this.getRecentHistory(session, session.currentModel, 20);
    const accuracy = this.getAccuracy(recentHistory);
    
    // Exit confidence mode if performing well
    if (accuracy >= 0.8 && recentHistory.length >= 10) {
      return {
        action: 'maintain',
        fromLevel: currentLevel,
        toLevel: currentLevel,
        reason: 'Ready to exit confidence mode',
        confidence: accuracy,
        recommendation: 'Confidence restored - can resume adaptive progression'
      };
    }
    
    // Stay in confidence mode
    return {
      action: 'maintain',
      fromLevel: currentLevel,
      toLevel: currentLevel,
      reason: 'Building confidence at current level',
      confidence: accuracy,
      recommendation: `Continue practicing at ${currentLevel.displayName} until 80% accuracy achieved`
    };
  }

  /**
   * Create advancement adjustment
   */
  private static createAdvancement(
    currentLevel: SubDifficultyLevel,
    increment: number,
    reason: string
  ): DifficultyAdjustment {
    const newLevel = this.incrementLevel(currentLevel, increment);
    
    return {
      action: 'advance',
      fromLevel: currentLevel,
      toLevel: newLevel,
      reason,
      confidence: 0.85, // High confidence for advancement
      recommendation: `Advance from ${currentLevel.displayName} to ${newLevel.displayName}`
    };
  }

  /**
   * Create reduction/support adjustment
   */
  private static createReduction(
    currentLevel: SubDifficultyLevel,
    decrement: number | 'lock',
    reason: string
  ): DifficultyAdjustment {
    if (decrement === 'lock') {
      return {
        action: 'lock',
        fromLevel: currentLevel,
        toLevel: currentLevel,
        reason,
        confidence: 0.3, // Low confidence
        recommendation: 'Enter confidence mode - stay at current level until performance improves'
      };
    }
    
    const newLevel = this.incrementLevel(currentLevel, -decrement);
    
    return {
      action: 'reduce',
      fromLevel: currentLevel,
      toLevel: newLevel,
      reason,
      confidence: 0.4, // Low confidence
      recommendation: `Reduce difficulty from ${currentLevel.displayName} to ${newLevel.displayName}`
    };
  }

  /**
   * Increment difficulty level by decimal amount
   */
  private static incrementLevel(
    level: SubDifficultyLevel,
    increment: number
  ): SubDifficultyLevel {
    // Convert to decimal representation
    const currentDecimal = level.year + (level.subLevel - 1) * 0.1;
    let newDecimal = currentDecimal + increment;
    
    // Clamp to valid ranges
    newDecimal = Math.max(1.1, Math.min(6.4, newDecimal));
    
    // Convert back to year/subLevel
    const newYear = Math.floor(newDecimal);
    const newSubLevel = Math.round((newDecimal - newYear) * 10) + 1;
    
    return EnhancedDifficultySystem.createLevel(newYear, Math.max(1, Math.min(4, newSubLevel)));
  }

  /**
   * Get recent performance history for specific model
   */
  private static getRecentHistory(
    session: StudentSession,
    modelId: string,
    count: number
  ): PerformanceData[] {
    return session.performanceHistory
      .filter(p => p.modelId === modelId)
      .slice(-count);
  }

  /**
   * Count consecutive correct answers from end of history
   */
  private static getConsecutiveCorrect(history: PerformanceData[]): number {
    let count = 0;
    for (let i = history.length - 1; i >= 0; i--) {
      if (history[i].isCorrect) {
        count++;
      } else {
        break;
      }
    }
    return count;
  }

  /**
   * Count consecutive incorrect answers from end of history
   */
  private static getConsecutiveIncorrect(history: PerformanceData[]): number {
    let count = 0;
    for (let i = history.length - 1; i >= 0; i--) {
      if (!history[i].isCorrect) {
        count++;
      } else {
        break;
      }
    }
    return count;
  }

  /**
   * Calculate accuracy percentage from performance history
   */
  private static getAccuracy(history: PerformanceData[]): number {
    if (history.length === 0) return 0.5; // Default to 50% when no data
    
    const correct = history.filter(p => p.isCorrect).length;
    return correct / history.length;
  }

  /**
   * Get session statistics for monitoring
   */
  static getSessionStats(sessionId: string) {
    const session = this.getSession(sessionId);
    
    return {
      totalQuestions: session.totalQuestions,
      correctAnswers: session.correctAnswers,
      accuracy: session.totalQuestions > 0 ? session.correctAnswers / session.totalQuestions : 0,
      currentStreak: session.streakCount,
      sessionDuration: Date.now() - session.startTime.getTime(),
      currentLevel: session.currentLevel.displayName,
      adaptiveMode: session.adaptiveMode,
      confidenceMode: session.confidenceMode
    };
  }

  /**
   * Enable/disable confidence mode
   */
  static setConfidenceMode(sessionId: string, enabled: boolean): void {
    const session = this.getSession(sessionId);
    session.confidenceMode = enabled;
    if (enabled) {
      session.adaptiveMode = false; // Disable adaptive progression in confidence mode
    }
    this.sessions.set(sessionId, session);
  }

  /**
   * Enable/disable adaptive mode
   */
  static setAdaptiveMode(sessionId: string, enabled: boolean): void {
    const session = this.getSession(sessionId);
    session.adaptiveMode = enabled;
    this.sessions.set(sessionId, session);
  }

  /**
   * Reset session (for testing or new student)
   */
  static resetSession(sessionId: string): void {
    const session = this.getSession(sessionId);
    session.performanceHistory = [];
    session.streakCount = 0;
    session.totalQuestions = 0;
    session.correctAnswers = 0;
    session.startTime = new Date();
    this.sessions.set(sessionId, session);
  }

  /**
   * Get all active sessions (for classroom monitoring)
   */
  static getAllSessions(): StudentSession[] {
    return Array.from(this.sessions.values());
  }

  /**
   * Clean up old sessions (call periodically)
   */
  static cleanupOldSessions(maxAgeHours: number = 24): void {
    const cutoffTime = new Date(Date.now() - maxAgeHours * 60 * 60 * 1000);
    
    for (const [sessionId, session] of this.sessions) {
      if (session.startTime < cutoffTime) {
        this.sessions.delete(sessionId);
      }
    }
  }

  /**
   * Export session data for analysis
   */
  static exportSessionData(sessionId: string): object {
    const session = this.getSession(sessionId);
    return {
      sessionInfo: {
        sessionId: session.sessionId,
        studentId: session.studentId,
        startTime: session.startTime,
        duration: Date.now() - session.startTime.getTime(),
        currentLevel: session.currentLevel.displayName
      },
      performance: {
        totalQuestions: session.totalQuestions,
        correctAnswers: session.correctAnswers,
        accuracy: session.totalQuestions > 0 ? session.correctAnswers / session.totalQuestions : 0,
        currentStreak: session.streakCount
      },
      history: session.performanceHistory,
      settings: {
        adaptiveMode: session.adaptiveMode,
        confidenceMode: session.confidenceMode
      }
    };
  }
}
```
--- END FILE: lib\math-engine\progression-tracker.ts ---

--- START FILE: lib\models\model-status.ts ---
```typescript
export enum ModelStatus {
  COMPLETE = 'complete',
  WIP = 'wip',
  BROKEN = 'broken',
  PLANNED = 'planned'
}

export interface ModelStatusInfo {
  id: string;
  name: string;
  status: ModelStatus;
  description: string;
  curriculumAreas: string[];
  supportedYears: number[];
  lastTested?: string;
  knownIssues?: string[];
  completionNotes?: string;
}

/**
 * Central tracking of all mathematical model completion status
 * Based on implementation and testing results
 */
export const MODEL_STATUS_REGISTRY: { [modelId: string]: ModelStatusInfo } = {
  // Core Mathematical Models - Fully Working
  'ADDITION': {
    id: 'ADDITION',
    name: 'Addition',
    status: ModelStatus.COMPLETE,
    description: 'Adding numbers together with various difficulty levels',
    curriculumAreas: ['Addition, subtraction, multiplication and division (calculations)'],
    supportedYears: [1, 2, 3, 4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Fully functional with decimal support and carrying'
  },

  'SUBTRACTION': {
    id: 'SUBTRACTION',
    name: 'Subtraction',
    status: ModelStatus.COMPLETE,
    description: 'Subtracting numbers with borrowing support',
    curriculumAreas: ['Addition, subtraction, multiplication and division (calculations)'],
    supportedYears: [1, 2, 3, 4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Fully functional with borrowing and decimal support'
  },

  'MULTIPLICATION': {
    id: 'MULTIPLICATION',
    name: 'Multiplication',
    status: ModelStatus.COMPLETE,
    description: 'Times tables and multiplication problems',
    curriculumAreas: ['Addition, subtraction, multiplication and division (calculations)'],
    supportedYears: [2, 3, 4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Supports times tables and complex multiplication'
  },

  'DIVISION': {
    id: 'DIVISION',
    name: 'Division',
    status: ModelStatus.COMPLETE,
    description: 'Division with quotients and remainders',
    curriculumAreas: ['Addition, subtraction, multiplication and division (calculations)'],
    supportedYears: [3, 4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Handles remainders and decimal division'
  },

  'PERCENTAGE': {
    id: 'PERCENTAGE',
    name: 'Percentages',
    status: ModelStatus.COMPLETE,
    description: 'Percentage calculations and comparisons',
    curriculumAreas: ['Fractions (including decimals and percentages)'],
    supportedYears: [4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Percentage of amounts, increases, decreases'
  },

  // Extended Mathematical Models - Working
  'FRACTION': {
    id: 'FRACTION',
    name: 'Fractions',
    status: ModelStatus.COMPLETE,
    description: 'Fraction calculations and conversions',
    curriculumAreas: ['Fractions (including decimals and percentages)'],
    supportedYears: [3, 4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Common fractions with practical applications'
  },

  'COUNTING': {
    id: 'COUNTING',
    name: 'Counting & Coins',
    status: ModelStatus.COMPLETE,
    description: 'Coin counting and combinations',
    curriculumAreas: ['Number and place value', 'Measurement'],
    supportedYears: [1, 2, 3, 4],
    lastTested: '2024-09-04',
    completionNotes: 'UK coin denominations with optimal combinations'
  },

  'TIME_RATE': {
    id: 'TIME_RATE',
    name: 'Time & Rate',
    status: ModelStatus.COMPLETE,
    description: 'Time-based calculations and rates',
    curriculumAreas: ['Measurement'],
    supportedYears: [3, 4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Savings over time and rate calculations'
  },

  'CONVERSION': {
    id: 'CONVERSION',
    name: 'Unit Conversion',
    status: ModelStatus.COMPLETE,
    description: 'Converting between different units',
    curriculumAreas: ['Measurement'],
    supportedYears: [3, 4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Common UK unit conversions'
  },

  'COMPARISON': {
    id: 'COMPARISON',
    name: 'Comparisons',
    status: ModelStatus.COMPLETE,
    description: 'Comparing values and determining best deals',
    curriculumAreas: ['Addition, subtraction, multiplication and division (calculations)', 'Measurement'],
    supportedYears: [4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Value comparison with reasoning'
  },

  // Advanced Models - Implementation Issues
  'MULTI_STEP': {
    id: 'MULTI_STEP',
    name: 'Multi-Step Problems',
    status: ModelStatus.COMPLETE,
    description: 'Problems requiring multiple calculations',
    curriculumAreas: ['Addition, subtraction, multiplication and division (calculations)'],
    supportedYears: [4, 5, 6],
    lastTested: '2024-09-04',
    completionNotes: 'Chains multiple operations successfully'
  },

  'LINEAR_EQUATION': {
    id: 'LINEAR_EQUATION',
    name: 'Linear Equations',
    status: ModelStatus.COMPLETE,
    description: 'Basic algebra and linear relationships',
    curriculumAreas: ['Algebra'],
    supportedYears: [5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Fixed parameter bounds checking and infinite loop issues'
  },

  'UNIT_RATE': {
    id: 'UNIT_RATE',
    name: 'Unit Rates',
    status: ModelStatus.COMPLETE,
    description: 'Rate calculations and value comparisons',
    curriculumAreas: ['Ratio and proportion'],
    supportedYears: [5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Fixed infinite loops and parameter generation issues'
  },

  // Money Models - Newly Implemented
  'COIN_RECOGNITION': {
    id: 'COIN_RECOGNITION',
    name: 'Coin Recognition',
    status: ModelStatus.COMPLETE,
    description: 'Identifying UK coins and notes',
    curriculumAreas: ['Measurement'],
    supportedYears: [1, 2, 3],
    lastTested: '2024-09-13',
    completionNotes: 'Added story engine support and fixed field mapping'
  },

  'CHANGE_CALCULATION': {
    id: 'CHANGE_CALCULATION',
    name: 'Change Calculation',
    status: ModelStatus.COMPLETE,
    description: 'Calculating change from purchases',
    curriculumAreas: ['Measurement'],
    supportedYears: [2, 3, 4, 5],
    lastTested: '2024-09-13',
    completionNotes: 'Added story engine support for single and multiple item purchases'
  },

  'MONEY_COMBINATIONS': {
    id: 'MONEY_COMBINATIONS',
    name: 'Money Combinations',
    status: ModelStatus.COMPLETE,
    description: 'Different ways to make the same amount',
    curriculumAreas: ['Measurement'],
    supportedYears: [2, 3, 4],
    lastTested: '2024-09-13',
    completionNotes: 'Added story engine support for multiple combination types'
  },

  'MIXED_MONEY_UNITS': {
    id: 'MIXED_MONEY_UNITS',
    name: 'Mixed Money Units',
    status: ModelStatus.COMPLETE,
    description: 'Working with pounds and pence together',
    curriculumAreas: ['Measurement'],
    supportedYears: [3, 4, 5],
    lastTested: '2024-09-13',
    completionNotes: 'Added story engine support for unit conversions'
  },

  'MONEY_FRACTIONS': {
    id: 'MONEY_FRACTIONS',
    name: 'Money Fractions',
    status: ModelStatus.COMPLETE,
    description: 'Fractional amounts of money',
    curriculumAreas: ['Fractions (including decimals and percentages)', 'Measurement'],
    supportedYears: [4, 5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Added story engine support for fractional money calculations'
  },

  'MONEY_SCALING': {
    id: 'MONEY_SCALING',
    name: 'Money Scaling',
    status: ModelStatus.COMPLETE,
    description: 'Proportional money problems',
    curriculumAreas: ['Ratio and proportion', 'Measurement'],
    supportedYears: [5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Added story engine support for proportional scaling problems'
  },

  // Geometry Models - New
  'SHAPE_RECOGNITION': {
    id: 'SHAPE_RECOGNITION',
    name: 'Shape Recognition',
    status: ModelStatus.COMPLETE,
    description: 'Identifying and comparing 2D and 3D shapes',
    curriculumAreas: ['Geometry â properties of shapes'],
    supportedYears: [1, 2, 3, 4, 5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Complete implementation with shape identification, counting properties, and comparisons'
  },

  'SHAPE_PROPERTIES': {
    id: 'SHAPE_PROPERTIES',
    name: 'Shape Properties',
    status: ModelStatus.COMPLETE,
    description: 'Analyzing properties of 2D shapes including sides, vertices, angles, and symmetry',
    curriculumAreas: ['Geometry â properties of shapes'],
    supportedYears: [1, 2, 3, 4, 5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Complete implementation with property counting, identification, comparison, and classification'
  },

  'ANGLE_MEASUREMENT': {
    id: 'ANGLE_MEASUREMENT',
    name: 'Angle Measurement',
    status: ModelStatus.COMPLETE,
    description: 'Identifying, measuring, and calculating angles including type classification and unit conversions',
    curriculumAreas: ['Geometry â properties of shapes'],
    supportedYears: [3, 4, 5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Complete implementation with angle identification, measurement, missing angle calculations, and unit conversions'
  },

  'POSITION_DIRECTION': {
    id: 'POSITION_DIRECTION',
    name: 'Position & Direction',
    status: ModelStatus.COMPLETE,
    description: 'Working with coordinates, compass directions, and spatial relationships on grids',
    curriculumAreas: ['Geometry â position and direction'],
    supportedYears: [1, 2, 3, 4, 5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Complete implementation with position identification, direction following, coordinate systems, and relative positioning'
  },

  'AREA_PERIMETER': {
    id: 'AREA_PERIMETER',
    name: 'Area & Perimeter',
    status: ModelStatus.COMPLETE,
    description: 'Calculating area and perimeter of 2D shapes including finding missing dimensions',
    curriculumAreas: ['Measurement'],
    supportedYears: [3, 4, 5, 6],
    lastTested: '2024-09-13',
    completionNotes: 'Complete implementation with area/perimeter calculations for rectangles, squares, triangles, and circles, plus missing dimension problems'
  },

  // Test Model - Permanently Broken
  'TEST_BROKEN': {
    id: 'TEST_BROKEN',
    name: 'Test Broken Model',
    status: ModelStatus.BROKEN,
    description: 'A model used exclusively for testing the API\'s ability to block requests for broken models.',
    curriculumAreas: [],
    supportedYears: [1, 2, 3, 4, 5, 6],
    lastTested: 'N/A',
    knownIssues: ['This model is intentionally non-functional.'],
    completionNotes: 'Should never be made functional.'
  }
};

/**
 * Get models by status
 */
export function getModelsByStatus(status: ModelStatus): ModelStatusInfo[] {
  return Object.values(MODEL_STATUS_REGISTRY).filter(model => model.status === status);
}

/**
 * Get models by year support
 */
export function getModelsByYear(year: number): ModelStatusInfo[] {
  return Object.values(MODEL_STATUS_REGISTRY).filter(
    model => model.supportedYears.includes(year)
  );
}

/**
 * Get models by curriculum area
 */
export function getModelsByCurriculumArea(area: string): ModelStatusInfo[] {
  return Object.values(MODEL_STATUS_REGISTRY).filter(
    model => model.curriculumAreas.some(currArea => 
      currArea.toLowerCase().includes(area.toLowerCase())
    )
  );
}

/**
 * Get completion summary statistics
 */
export function getCompletionStats() {
  const models = Object.values(MODEL_STATUS_REGISTRY);
  const total = models.length;
  const complete = models.filter(m => m.status === ModelStatus.COMPLETE).length;
  const wip = models.filter(m => m.status === ModelStatus.WIP).length;
  const broken = models.filter(m => m.status === ModelStatus.BROKEN).length;
  const planned = models.filter(m => m.status === ModelStatus.PLANNED).length;

  return {
    total,
    complete,
    wip,
    broken,
    planned,
    completionPercentage: Math.round((complete / total) * 100)
  };
}
```
--- END FILE: lib\models\model-status.ts ---

--- START FILE: lib\orchestrator\question-orchestrator.ts ---
```typescript
// Question Orchestrator - Main coordinator for enhanced question generation
// Manages format selection, controller routing, and output rendering

import {
  QuestionController,
  ControllerDependencies,
  MathEngine,
  ScenarioService,
  DistractorEngine
} from '@/lib/controllers/base-question.controller';
import { DirectCalculationController } from '@/lib/controllers/direct-calculation.controller';
import { ComparisonController } from '@/lib/controllers/comparison.controller';
import { EstimationController } from '@/lib/controllers/estimation.controller';
import { ValidationController } from '@/lib/controllers/validation.controller';
import { MultiStepController } from '@/lib/controllers/multi-step.controller';
import { MissingValueController } from '@/lib/controllers/missing-value.controller';
import { OrderingController } from '@/lib/controllers/ordering.controller';
import { PatternController } from '@/lib/controllers/pattern.controller';
import {
  QuestionDefinition,
  QuestionFormat,
  QuestionContent,
  ScenarioTheme,
  SubDifficultyLevel,
  FormatCompatibilityRule
} from '@/lib/types/question-formats';

// Import existing types for compatibility
import type { GenerationSetup } from '@/lib/types';

/**
 * Request structure for enhanced question generation
 */
export interface EnhancedQuestionRequest {
  model_id: string;
  difficulty_level?: string;        // New format: "3.2"
  year_level?: number;              // Legacy format: 3
  format_preference?: QuestionFormat;
  scenario_theme?: ScenarioTheme;
  pedagogical_focus?: string;
  difficulty_params?: Record<string, any>;
  session_id?: string;
  cultural_context?: string;
}

/**
 * Enhancement status tracking
 */
export interface EnhancementStatus {
  level: 'full' | 'partial' | 'fallback';
  requestedFormat: QuestionFormat;
  actualFormat: QuestionFormat;
  reason?: string;
  featuresActive: string[];
  featuresPending: string[];
  isFullyEnhanced: boolean;
}

/**
 * Generated question with enhanced metadata
 */
export interface EnhancedQuestion {
  // Core question content
  text: string;
  options: QuestionOption[];
  correctIndex: number;

  // Enhanced structured content for rich UI rendering
  questionContent?: QuestionContent;

  // Enhanced metadata
  format: QuestionFormat;
  difficulty: SubDifficultyLevel;
  cognitiveLoad: number;
  curriculumTags: string[];
  scenario: any;
  distractors: any[];

  // Enhancement status
  enhancementStatus: EnhancementStatus;

  // Original math output for compatibility
  mathOutput: any;

  // Generation metadata
  generationTime: number;
  questionId: string;

  // Complete generation setup details
  generationSetup?: GenerationSetup;
}

export interface QuestionOption {
  text: string;
  value: any;
  index: number;
}

/**
 * Main orchestrator that coordinates all enhanced question generation components
 */
export class QuestionOrchestrator {
  private controllers: Map<QuestionFormat, QuestionController>;
  private availableFormats: Set<QuestionFormat>;
  private formatSelector: FormatSelector;
  private renderer: QuestionRenderer;
  private mathEngine: MathEngine;

  constructor(
    mathEngine: MathEngine,
    scenarioService: ScenarioService,
    distractorEngine: DistractorEngine
  ) {
    this.mathEngine = mathEngine;
    this.controllers = new Map();
    this.availableFormats = new Set();
    this.initializeControllers(mathEngine, scenarioService, distractorEngine);
    this.formatSelector = new FormatSelector(this.availableFormats);
    this.renderer = new QuestionRenderer();
  }

  /**
   * Generate an enhanced question from request
   */
  async generateQuestion(request: EnhancedQuestionRequest): Promise<EnhancedQuestion> {
    const startTime = Date.now();

    // 1. Parse and validate difficulty level
    const difficulty = this.parseDifficulty(request.difficulty_level || request.year_level);

    // 2. Determine available formats for this model and difficulty
    const availableFormats = this.formatSelector.getAvailableFormats(
      request.model_id,
      difficulty
    );

    // 3. Select format based on preferences and pedagogical goals
    const selectedFormat = this.formatSelector.selectFormat(
      availableFormats,
      request.format_preference,
      request.pedagogical_focus
    );

    // 4. Get appropriate controller with fallback
    let actualFormat = selectedFormat;
    let controller = this.controllers.get(selectedFormat);
    let enhancementStatus: EnhancementStatus;

    if (!controller) {
      // Fallback to DIRECT_CALCULATION if requested format not available
      actualFormat = QuestionFormat.DIRECT_CALCULATION;
      controller = this.controllers.get(actualFormat);

      if (!controller) {
        throw new Error('Critical error: DIRECT_CALCULATION controller not available');
      }

      enhancementStatus = {
        level: 'fallback',
        requestedFormat: selectedFormat,
        actualFormat,
        reason: `${selectedFormat} format pending implementation`,
        featuresActive: ['enhanced_distractors', 'scenarios'],
        featuresPending: [selectedFormat.toLowerCase() + '_logic'],
        isFullyEnhanced: false
      };
    } else {
      // Determine enhancement level based on format complexity
      let enhancementLevel: 'partial' | 'full';
      if (actualFormat === QuestionFormat.DIRECT_CALCULATION) {
        enhancementLevel = 'partial';
      } else if ([QuestionFormat.COMPARISON, QuestionFormat.ESTIMATION, QuestionFormat.VALIDATION].includes(actualFormat)) {
        enhancementLevel = 'full';
      } else {
        // Advanced formats: MULTI_STEP, MISSING_VALUE, ORDERING, PATTERN_RECOGNITION
        enhancementLevel = 'full';
      }

      enhancementStatus = {
        level: enhancementLevel,
        requestedFormat: selectedFormat,
        actualFormat,
        featuresActive: ['enhanced_distractors', 'rich_scenarios', 'cognitive_load', 'advanced_formats'],
        featuresPending: [],
        isFullyEnhanced: true
      };
    }

    // 5. Generate question definition
    const questionDef = await controller.generate({
      mathModel: request.model_id,
      difficulty,
      difficultyParams: request.difficulty_params,
      preferredTheme: request.scenario_theme,
      culturalContext: request.cultural_context || 'UK',
      sessionId: request.session_id
    });

    // Update format in definition to reflect actual format used
    questionDef.format = actualFormat;

    // 6. Render to final format
    const rendered = this.renderer.render(questionDef);

    // 7. Create generation setup details
    const endTime = Date.now();
    const generationSetup: GenerationSetup = {
      // Orchestrator details
      controller_used: `${actualFormat}Controller`,
      format_requested: selectedFormat,
      format_actual: actualFormat,
      format_selection_reason: enhancementStatus.reason,

      // Scenario details
      scenario_theme: questionDef.scenario.theme || 'UNKNOWN',
      scenario_id: questionDef.scenario.id || 'UNKNOWN',
      scenario_selection_method: request.scenario_theme ? 'requested' : 'default',

      // Distractor details
      distractor_strategies: questionDef.solution.distractors?.map((d: any) => d.strategy) || [],
      distractor_count: questionDef.solution.distractors?.length || 0,

      // Rules and weights
      format_weights: undefined, // Will be set by bulk API if available
      theme_variety: false, // Will be set by bulk API if available
      format_variety: false, // Will be set by bulk API if available

      // Enhancement tracking
      enhancement_level: enhancementStatus.level,
      features_active: enhancementStatus.featuresActive,
      features_pending: enhancementStatus.featuresPending,

      // Performance
      generation_time_ms: endTime - startTime
    };

    // 8. Enhance with metadata and return
    return this.enhanceQuestion(rendered, questionDef, enhancementStatus, endTime - startTime, generationSetup);
  }

  /**
   * Initialize format-specific controllers
   */
  private initializeControllers(
    mathEngine: MathEngine,
    scenarioService: ScenarioService,
    distractorEngine: DistractorEngine
  ): void {
    const dependencies: ControllerDependencies = {
      mathEngine,
      scenarioService,
      distractorEngine
    };

    this.controllers = new Map();
    this.availableFormats = new Set();

    // Initialize available controllers
    this.controllers.set(
      QuestionFormat.DIRECT_CALCULATION,
      new DirectCalculationController(dependencies)
    );
    this.availableFormats.add(QuestionFormat.DIRECT_CALCULATION);

    this.controllers.set(
      QuestionFormat.COMPARISON,
      new ComparisonController(dependencies)
    );
    this.availableFormats.add(QuestionFormat.COMPARISON);

    this.controllers.set(
      QuestionFormat.ESTIMATION,
      new EstimationController(dependencies)
    );
    this.availableFormats.add(QuestionFormat.ESTIMATION);

    this.controllers.set(
      QuestionFormat.VALIDATION,
      new ValidationController(dependencies)
    );
    this.availableFormats.add(QuestionFormat.VALIDATION);

    this.controllers.set(
      QuestionFormat.MULTI_STEP,
      new MultiStepController(dependencies)
    );
    this.availableFormats.add(QuestionFormat.MULTI_STEP);

    this.controllers.set(
      QuestionFormat.MISSING_VALUE,
      new MissingValueController(dependencies)
    );
    this.availableFormats.add(QuestionFormat.MISSING_VALUE);

    this.controllers.set(
      QuestionFormat.ORDERING,
      new OrderingController(dependencies)
    );
    this.availableFormats.add(QuestionFormat.ORDERING);

    this.controllers.set(
      QuestionFormat.PATTERN_RECOGNITION,
      new PatternController(dependencies)
    );
    this.availableFormats.add(QuestionFormat.PATTERN_RECOGNITION);
  }

  /**
   * Parse difficulty level from various input formats
   */
  private parseDifficulty(level: number | string | undefined): SubDifficultyLevel {
    if (!level) {
      // Default to year 4, standard level
      return {
        year: 4,
        subLevel: 3,
        displayName: '4.3',
        cognitiveLoad: this.calculateCognitiveLoad(4, 3)
      };
    }

    if (typeof level === 'number') {
      // Legacy integer support (3 -> 3.3)
      return {
        year: Math.floor(level),
        subLevel: 3,
        displayName: `${level}.3`,
        cognitiveLoad: this.calculateCognitiveLoad(level, 3)
      };
    }

    // Parse string format "X.Y"
    const parts = level.split('.');
    if (parts.length !== 2) {
      throw new Error(`Invalid difficulty format: ${level}. Use "X.Y" format (e.g., "3.2")`);
    }

    const year = parseInt(parts[0]);
    const subLevel = parseInt(parts[1]);

    if (year < 1 || year > 6) {
      throw new Error('Year level must be between 1 and 6');
    }

    if (subLevel < 1 || subLevel > 4) {
      throw new Error('Sub level must be between 1 and 4');
    }

    return {
      year,
      subLevel,
      displayName: level,
      cognitiveLoad: this.calculateCognitiveLoad(year, subLevel)
    };
  }

  /**
   * Calculate cognitive load for a difficulty level
   */
  private calculateCognitiveLoad(year: number, subLevel: number): number {
    // Base load increases with year (10-60)
    const baseLoad = 10 + (year - 1) * 10;

    // Sub-level adjustment (0-15)
    const subLevelBonus = (subLevel - 1) * 5;

    return Math.min(100, baseLoad + subLevelBonus);
  }

  /**
   * Enhance rendered question with metadata
   */
  private enhanceQuestion(
    rendered: RenderedQuestion,
    definition: QuestionDefinition,
    enhancementStatus: EnhancementStatus,
    generationTime: number,
    generationSetup?: GenerationSetup
  ): EnhancedQuestion {
    // Ensure we have valid question text
    let questionText = rendered.questionText;
    if (!questionText || questionText === 'What is ?' || questionText.length < 10) {
      console.warn('Invalid question text detected, using fallback generation');
      questionText = this.generateFallbackQuestion(definition);
    }

    // Ensure we have valid options with numeric answers
    const validatedOptions = this.validateOptions(rendered.options, definition);

    return {
      text: questionText,
      options: validatedOptions,
      correctIndex: rendered.correctIndex,
      questionContent: definition.questionContent,
      format: definition.format,
      difficulty: definition.difficulty,
      cognitiveLoad: definition.difficulty.cognitiveLoad,
      curriculumTags: definition.metadata.curriculumAlignment,
      scenario: definition.scenario,
      distractors: definition.solution.distractors,
      enhancementStatus,
      mathOutput: this.extractMathOutput(definition),
      generationTime,
      questionId: definition.id,
      generationSetup
    };
  }

  /**
   * Generate fallback question text when rendering fails
   */
  private generateFallbackQuestion(definition: QuestionDefinition): string {
    const model = definition.mathModel;
    const values = definition.parameters?.mathValues || {};
    const narrative = definition.parameters?.narrativeValues || {};
    const scenario = definition.scenario;

    // Try to generate scenario-aware question first
    if (scenario && scenario.theme) {
      const scenarioQuestion = this.generateScenarioAwareFallback(model, values, narrative, scenario);
      if (scenarioQuestion) {
        return scenarioQuestion;
      }
    }

    // Generate basic question based on model
    switch (model) {
      case 'ADDITION':
        const addends = values.operands || [values.operand_1, values.operand_2, values.operand_3].filter(v => v !== undefined);
        if (addends.length > 0) {
          return `What is ${addends.join(' + ')}?`;
        }
        return 'Add the numbers together.';

      case 'SUBTRACTION':
        const minuend = values.minuend || values.operand_1;
        const subtrahend = values.subtrahend || values.operand_2;
        if (minuend !== undefined && subtrahend !== undefined) {
          return `What is ${minuend} - ${subtrahend}?`;
        }
        return 'Subtract to find the difference.';

      case 'MULTIPLICATION':
        const multiplicand = values.multiplicand || values.operand_1;
        const multiplier = values.multiplier || values.operand_2;
        if (multiplicand !== undefined && multiplier !== undefined) {
          return `What is ${multiplicand} Ã ${multiplier}?`;
        }
        return 'Multiply to find the product.';

      case 'DIVISION':
        const dividend = values.dividend || values.operand_1;
        const divisor = values.divisor || values.operand_2;
        if (dividend !== undefined && divisor !== undefined) {
          return `What is ${dividend} Ã· ${divisor}?`;
        }
        return 'Divide to find the quotient.';

      case 'PERCENTAGE':
        const percentage = values.percentage;
        const baseValue = values.base_value;
        if (percentage && baseValue) {
          return `What is ${percentage}% of ${baseValue}?`;
        }
        return 'Calculate the percentage.';

      case 'FRACTION':
        const numerator = values.numerator;
        const denominator = values.denominator;
        if (numerator && denominator) {
          return `What is ${numerator}/${denominator} as a decimal?`;
        }
        return 'Calculate the fraction.';

      case 'UNIT_RATE':
        return 'Compare the rates to find which is better value.';

      case 'MONEY_COMBINATIONS':
      case 'COIN_RECOGNITION':
      case 'CHANGE_CALCULATION':
        const amount = values.result || values.operand_1;
        if (amount) {
          return `How much money is this worth?`;
        }
        return 'Calculate the money amount.';

      default:
        // More descriptive default based on result
        if (values.result !== undefined) {
          return `What is the answer to this ${model.toLowerCase().replace('_', ' ')} problem?`;
        }
        return `Solve this ${model.toLowerCase().replace('_', ' ')} problem.`;
    }
  }

  /**
   * Generate scenario-aware fallback questions
   */
  private generateScenarioAwareFallback(
    model: string,
    values: Record<string, any>,
    narrative: Record<string, any>,
    scenario: any
  ): string | null {
    const character = narrative.character || scenario.characters?.[0]?.name || 'Sam';
    const theme = scenario.theme;

    switch (theme) {
      case 'SHOPPING':
        if (model === 'ADDITION' && values.operands) {
          return `${character} buys items costing ${this.formatPrice(values.operands[0])} and ${this.formatPrice(values.operands[1])}. How much does ${character} spend altogether?`;
        }
        if (model === 'CHANGE_CALCULATION' && values.minuend && values.subtrahend) {
          return `${character} pays ${this.formatPrice(values.minuend)} for an item costing ${this.formatPrice(values.subtrahend)}. How much change does ${character} get?`;
        }
        if (values.result) {
          return `${character} goes shopping. What is the total cost?`;
        }
        break;

      case 'SPORTS':
        if (model === 'MULTIPLICATION' && values.multiplicand && values.multiplier) {
          return `${character} buys ${values.multiplier} sports items at ${this.formatPrice(values.multiplicand)} each. How much does ${character} spend?`;
        }
        if (values.result) {
          return `${character} is calculating sports scores. What is the answer?`;
        }
        break;

      case 'COOKING':
        if (model === 'FRACTION' && values.numerator && values.denominator) {
          return `${character} needs ${values.numerator}/${values.denominator} of a recipe. What is this as a decimal?`;
        }
        if (values.result) {
          return `${character} is following a recipe. What is the calculation?`;
        }
        break;

      case 'SCHOOL':
        if (model === 'ADDITION' && values.operands) {
          return `${character} adds up school expenses: ${values.operands.map(v => this.formatPrice(v)).join(' + ')}. What is the total?`;
        }
        if (values.result) {
          return `${character} is doing maths homework. What is the answer?`;
        }
        break;

      case 'HOUSEHOLD':
        if (values.result) {
          return `${character} is calculating household expenses. What is the total?`;
        }
        break;
    }

    return null;
  }

  /**
   * Validate and fix options to ensure numeric answers
   */
  private validateOptions(options: any[], definition: QuestionDefinition): any[] {
    const correctValue = definition.solution?.correctAnswer?.value;

    return options.map((option, index) => {
      // Ensure option has valid numeric value
      if (typeof option.value === 'number' && !isNaN(option.value)) {
        return option;
      }

      // Try to extract numeric value from various fields
      let numericValue: number | undefined;
      if (typeof option === 'object' && option !== null) {
        numericValue = option.value ?? option.answer ?? option.result;
      }

      // If still no valid value, use a fallback based on correct answer
      if (typeof numericValue !== 'number' || isNaN(numericValue)) {
        if (index === 0 && typeof correctValue === 'number') {
          numericValue = correctValue;
        } else {
          // Generate a plausible distractor
          numericValue = correctValue ? correctValue * (0.8 + Math.random() * 0.4) : 0;
        }
        console.warn(`Invalid option value detected, using fallback: ${numericValue}`);
      }

      return {
        value: numericValue,
        text: this.formatValue(numericValue, 'Â£'),
        isCorrect: index === 0
      };
    });
  }

  /**
   * Extract math output for backward compatibility
   */
  private extractMathOutput(definition: QuestionDefinition): any {
    // Reconstruct math output from question parameters
    return {
      operation: definition.mathModel,
      ...definition.parameters.mathValues,
      // Add any additional fields needed for compatibility
    };
  }
}

/**
 * Format selector - determines which question format to use
 */
export class FormatSelector {
  private formatCompatibility: Map<string, FormatCompatibilityRule[]>;
  private availableFormats: Set<QuestionFormat>;

  constructor(availableFormats: Set<QuestionFormat>) {
    this.availableFormats = availableFormats;
    this.formatCompatibility = new Map();
    this.initializeCompatibilityRules();
  }

  /**
   * Get available formats for a model and difficulty
   */
  getAvailableFormats(
    modelId: string,
    difficulty: SubDifficultyLevel
  ): QuestionFormat[] {
    const rules = this.formatCompatibility.get(modelId) || [];

    return rules
      .filter(rule =>
        difficulty.year >= rule.minYear &&
        difficulty.year <= rule.maxYear &&
        difficulty.subLevel >= rule.minSubLevel &&
        this.availableFormats.has(rule.format) // Only return formats with controllers
      )
      .map(rule => rule.format);
  }

  /**
   * Select best format based on preferences
   */
  selectFormat(
    available: QuestionFormat[],
    preference?: QuestionFormat,
    pedagogicalFocus?: string
  ): QuestionFormat {
    // Priority 1: User preference if available
    if (preference && available.includes(preference)) {
      return preference;
    }

    // Priority 2: Pedagogical focus alignment
    if (pedagogicalFocus) {
      const aligned = this.getFormatsForPedagogy(pedagogicalFocus);
      const match = available.find(f => aligned.includes(f));
      if (match) return match;
    }

    // Priority 3: Weighted random selection
    return this.weightedRandomSelect(available);
  }

  /**
   * Initialize format compatibility rules
   */
  private initializeCompatibilityRules(): void {
    // ADDITION model compatibility
    this.formatCompatibility.set('ADDITION', [
      {
        format: QuestionFormat.DIRECT_CALCULATION,
        minYear: 1, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.COMPARISON,
        minYear: 3, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.VALIDATION,
        minYear: 2, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.ESTIMATION,
        minYear: 3, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.MULTI_STEP,
        minYear: 4, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.MISSING_VALUE,
        minYear: 3, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.ORDERING,
        minYear: 2, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.PATTERN_RECOGNITION,
        minYear: 4, maxYear: 6, minSubLevel: 2
      }
    ]);

    // SUBTRACTION model compatibility
    this.formatCompatibility.set('SUBTRACTION', [
      {
        format: QuestionFormat.DIRECT_CALCULATION,
        minYear: 1, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.COMPARISON,
        minYear: 3, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.VALIDATION,
        minYear: 2, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.ESTIMATION,
        minYear: 3, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.MULTI_STEP,
        minYear: 4, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.MISSING_VALUE,
        minYear: 3, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.ORDERING,
        minYear: 2, maxYear: 6, minSubLevel: 1
      }
    ]);

    // MULTIPLICATION model compatibility
    this.formatCompatibility.set('MULTIPLICATION', [
      {
        format: QuestionFormat.DIRECT_CALCULATION,
        minYear: 2, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.ESTIMATION,
        minYear: 3, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.VALIDATION,
        minYear: 3, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.MULTI_STEP,
        minYear: 4, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.MISSING_VALUE,
        minYear: 3, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.PATTERN_RECOGNITION,
        minYear: 4, maxYear: 6, minSubLevel: 2
      }
    ]);

    // DIVISION model compatibility
    this.formatCompatibility.set('DIVISION', [
      {
        format: QuestionFormat.DIRECT_CALCULATION,
        minYear: 3, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.ESTIMATION,
        minYear: 4, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.VALIDATION,
        minYear: 4, maxYear: 6, minSubLevel: 2
      },
      {
        format: QuestionFormat.MISSING_VALUE,
        minYear: 4, maxYear: 6, minSubLevel: 1
      }
    ]);

    // UNIT_RATE model compatibility
    this.formatCompatibility.set('UNIT_RATE', [
      {
        format: QuestionFormat.DIRECT_CALCULATION,
        minYear: 4, maxYear: 6, minSubLevel: 1
      },
      {
        format: QuestionFormat.COMPARISON,
        minYear: 4, maxYear: 6, minSubLevel: 2
      }
    ]);

    // COMPARISON model compatibility
    this.formatCompatibility.set('COMPARISON', [
      {
        format: QuestionFormat.COMPARISON,
        minYear: 3, maxYear: 6, minSubLevel: 1
      }
    ]);

    // Add compatibility rules for all other models with DIRECT_CALCULATION as default
    const allModels = [
      'PERCENTAGE', 'FRACTION', 'COUNTING', 'TIME_RATE', 'CONVERSION', 'MULTI_STEP',
      'LINEAR_EQUATION', 'COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS',
      'MIXED_MONEY_UNITS', 'MONEY_FRACTIONS', 'MONEY_SCALING',
      'SHAPE_RECOGNITION', 'SHAPE_PROPERTIES', 'ANGLE_MEASUREMENT',
      'POSITION_DIRECTION', 'AREA_PERIMETER'
    ];

    allModels.forEach(modelId => {
      if (!this.formatCompatibility.has(modelId)) {
        this.formatCompatibility.set(modelId, [
          {
            format: QuestionFormat.DIRECT_CALCULATION,
            minYear: 1, maxYear: 6, minSubLevel: 1
          }
        ]);
      }
    });
  }

  /**
   * Get formats aligned with pedagogical focus
   */
  private getFormatsForPedagogy(focus: string): QuestionFormat[] {
    const pedagogyMap: Record<string, QuestionFormat[]> = {
      'fluency': [QuestionFormat.DIRECT_CALCULATION],
      'reasoning': [QuestionFormat.COMPARISON, QuestionFormat.ESTIMATION, QuestionFormat.VALIDATION],
      'problem_solving': [QuestionFormat.MULTI_STEP, QuestionFormat.VALIDATION],
      'number_sense': [QuestionFormat.ESTIMATION, QuestionFormat.ORDERING]
    };

    return pedagogyMap[focus] || [];
  }

  /**
   * Weighted random selection of format
   */
  private weightedRandomSelect(formats: QuestionFormat[]): QuestionFormat {
    if (formats.length === 0) {
      throw new Error('No compatible formats available');
    }

    const weights = {
      [QuestionFormat.DIRECT_CALCULATION]: 40,
      [QuestionFormat.COMPARISON]: 25,
      [QuestionFormat.ESTIMATION]: 15,
      [QuestionFormat.VALIDATION]: 10,
      [QuestionFormat.MULTI_STEP]: 5,
      [QuestionFormat.MISSING_VALUE]: 3,
      [QuestionFormat.ORDERING]: 1,
      [QuestionFormat.PATTERN_RECOGNITION]: 1
    };

    const availableWeights = formats.map(f => weights[f] || 1);
    const totalWeight = availableWeights.reduce((a, b) => a + b, 0);

    let random = Math.random() * totalWeight;
    for (let i = 0; i < formats.length; i++) {
      random -= availableWeights[i];
      if (random <= 0) {
        return formats[i];
      }
    }

    return formats[0];
  }
}

/**
 * Question renderer - converts question definitions to final output
 */
export class QuestionRenderer {
  render(definition: QuestionDefinition): RenderedQuestion {
    // For now, create a simple text rendering
    // This can be enhanced with template systems later

    const questionText = this.renderQuestionText(definition);
    const options = this.renderOptions(definition);
    const correctIndex = this.findCorrectIndex(options, definition.solution.correctAnswer);

    return {
      questionText,
      options,
      correctIndex
    };
  }

  private renderQuestionText(definition: QuestionDefinition): string {
    // Priority 1: Use pre-generated questionContent if available
    if (definition.questionContent?.fullText) {
      return definition.questionContent.fullText;
    }

    // Priority 2: Use scenario templates if available
    const template = definition.scenario.templates.find(t =>
      t.formatCompatibility.includes(definition.format)
    );

    if (template) {
      return this.fillTemplate(template.template, definition);
    }

    // Priority 3: Fallback to basic rendering
    return this.generateBasicQuestion(definition);
  }

  private fillTemplate(template: string, definition: QuestionDefinition): string {
    let filled = template;

    // Build comprehensive replacement map
    const replacements: Record<string, string> = {};

    // Add narrative values if they exist
    if (definition.parameters?.narrativeValues) {
      Object.assign(replacements, definition.parameters.narrativeValues);
    }

    // Add math values if they exist
    if (definition.parameters?.mathValues) {
      Object.entries(definition.parameters.mathValues).forEach(([key, value]) => {
        replacements[key] = String(value);
      });
    }

    // Add character names with multiple keys for flexibility
    if (definition.scenario?.characters?.length > 0) {
      const characterName = definition.scenario.characters[0].name;
      replacements.character = characterName;
      replacements.person = characterName;
      replacements.name = characterName;
      replacements.student = characterName;
    }

    // Add items
    if (definition.scenario?.items?.length > 0) {
      replacements.items = definition.scenario.items.map((item: any) => item.name || item).join(', ');
      replacements.item = definition.scenario.items[0]?.name || definition.scenario.items[0] || 'item';
      // Add individual item references
      definition.scenario.items.forEach((item: any, index: number) => {
        replacements[`item${index + 1}`] = item.name || item;
      });
    }

    // Add location/setting
    if (definition.scenario?.setting) {
      replacements.location = definition.scenario.setting.location || '';
      replacements.place = definition.scenario.setting.location || '';
    }

    // Apply replacements for {placeholder} patterns
    filled = filled.replace(/\{(\w+)\}/g, (match, key) => {
      if (replacements[key] !== undefined && replacements[key] !== '') {
        return replacements[key];
      }

      // Generate intelligent fallbacks for common missing values
      const fallbackValue = this.generateFallbackValue(key, definition);
      if (fallbackValue) {
        console.log(`Generated fallback for ${key}: ${fallbackValue}`);
        return fallbackValue;
      }

      console.warn(`Missing template value for key: ${key} in template: ${template.substring(0, 100)}`);
      return match; // Keep original if no replacement found
    });

    // Handle literal "placeholder" text (fallback for malformed templates)
    if (replacements.character) {
      filled = filled.replace(/\bplaceholder\b/gi, replacements.character);
    }

    return filled;
  }

  /**
   * Generate intelligent fallback values for missing template variables
   */
  private generateFallbackValue(key: string, definition: QuestionDefinition): string | null {
    const mathValues = definition.parameters?.mathValues || {};
    const scenario = definition.scenario;

    switch (key.toLowerCase()) {
      case 'price':
        // Generate a price based on math values or scenario context
        if (mathValues.result && typeof mathValues.result === 'number') {
          return this.formatPrice(mathValues.result);
        }
        if (mathValues.operand_1 && typeof mathValues.operand_1 === 'number') {
          return this.formatPrice(mathValues.operand_1);
        }
        // Default based on theme
        if (scenario?.theme === 'SPORTS') return 'Â£15';
        if (scenario?.theme === 'SCHOOL') return 'Â£3';
        return 'Â£5';

      case 'quantity':
        // Generate a quantity based on math values
        if (mathValues.operand_2 && typeof mathValues.operand_2 === 'number') {
          return String(mathValues.operand_2);
        }
        if (mathValues.multiplier && typeof mathValues.multiplier === 'number') {
          return String(mathValues.multiplier);
        }
        return '2';

      case 'recipe':
        // Generate a random recipe name for cooking scenarios
        const recipes = ['biscuits', 'cake', 'muffins', 'bread', 'pizza', 'cookies', 'scones'];
        return recipes[Math.floor(Math.random() * recipes.length)];

      case 'recipes':
        // Alternative plural form
        const recipeOptions = ['biscuits and cake', 'muffins and bread', 'cookies and scones'];
        return recipeOptions[Math.floor(Math.random() * recipeOptions.length)];

      case 'prices':
        // Generate a list of prices from operands
        if (mathValues.operands && Array.isArray(mathValues.operands)) {
          return mathValues.operands.map((price: number) => this.formatPrice(price)).join(', ');
        }
        // Generate multiple prices from individual operands
        const priceList = [];
        if (mathValues.operand_1) priceList.push(this.formatPrice(mathValues.operand_1));
        if (mathValues.operand_2) priceList.push(this.formatPrice(mathValues.operand_2));
        if (priceList.length > 0) return priceList.join(', ');

        // Default price list based on theme
        if (scenario?.theme === 'COOKING') return 'Â£2.50, Â£1.80, Â£3.20';
        if (scenario?.theme === 'SCHOOL') return 'Â£1.50, Â£2.00, Â£0.75';
        return 'Â£2, Â£3, Â£5';

      case 'ingredient':
      case 'ingredients':
        const cookingItems = ['flour', 'sugar', 'butter', 'eggs', 'milk', 'chocolate chips'];
        if (key === 'ingredients') {
          return `${cookingItems[0]}, ${cookingItems[1]} and ${cookingItems[2]}`;
        }
        return cookingItems[Math.floor(Math.random() * cookingItems.length)];

      case 'sport':
      case 'sports':
        const sports = ['football', 'basketball', 'tennis', 'cricket', 'rugby'];
        return sports[Math.floor(Math.random() * sports.length)];

      case 'total':
      case 'sum':
        if (mathValues.result && typeof mathValues.result === 'number') {
          return this.formatPrice(mathValues.result);
        }
        return 'Â£10';

      case 'change':
        if (mathValues.result && typeof mathValues.result === 'number') {
          return this.formatPrice(mathValues.result);
        }
        return 'Â£2.50';

      default:
        return null;
    }
  }

  /**
   * Format a number as a UK price
   */
  private formatPrice(amount: number): string {
    if (amount < 1) {
      return `${Math.round(amount * 100)}p`;
    }
    return `Â£${amount.toFixed(2)}`;
  }

  private generateBasicQuestion(definition: QuestionDefinition): string {
    const mathModel = definition.mathModel;
    const values = definition.parameters.mathValues;

    switch (mathModel) {
      case 'ADDITION':
        const operands = Object.keys(values)
          .filter(k => k.startsWith('operand_'))
          .map(k => values[k]);
        return `What is ${operands.join(' + ')}?`;

      case 'SUBTRACTION':
        return `What is ${values.minuend} - ${values.subtrahend}?`;

      case 'MULTIPLICATION':
        return `What is ${values.multiplicand} Ã ${values.multiplier}?`;

      case 'DIVISION':
        return `What is ${values.dividend} Ã· ${values.divisor}?`;

      default:
        return `Calculate the result for this ${mathModel.toLowerCase()} problem.`;
    }
  }

  private renderOptions(definition: QuestionDefinition): QuestionOption[] {
    const options: QuestionOption[] = [];

    // Add correct answer
    options.push({
      text: definition.solution.correctAnswer.displayText,
      value: definition.solution.correctAnswer.value,
      index: 0
    });

    // Add distractors
    definition.solution.distractors.forEach((distractor, index) => {
      options.push({
        text: distractor.displayText,
        value: distractor.value,
        index: index + 1
      });
    });

    // Shuffle options
    return this.shuffleOptions(options);
  }

  private shuffleOptions(options: QuestionOption[]): QuestionOption[] {
    const shuffled = [...options];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    // Update indices after shuffle
    shuffled.forEach((option, index) => {
      option.index = index;
    });

    return shuffled;
  }

  private findCorrectIndex(options: QuestionOption[], correctAnswer: any): number {
    return options.findIndex(option => option.value === correctAnswer.value);
  }
}

/**
 * Rendered question structure
 */
interface RenderedQuestion {
  questionText: string;
  options: QuestionOption[];
  correctIndex: number;
}
```
--- END FILE: lib\orchestrator\question-orchestrator.ts ---

--- START FILE: lib\services\distractor-engine.service.ts ---
```typescript
// Enhanced Distractor Engine - Generates pedagogically sound wrong answers
// Uses strategy-based approach with misconception library

import {
  DistractorStrategy,
  DistractorRule,
  DistractorGenerator,
  DistractorContext,
  Distractor,
  MisconceptionLibrary,
  QuestionFormat
} from '@/lib/types/question-formats';

/**
 * Enhanced distractor generation engine that creates pedagogically meaningful wrong answers
 * Based on common student misconceptions and error patterns
 */
export class DistractorEngine {
  private strategies: Map<DistractorStrategy, DistractorRule>;
  private misconceptionLibrary: MisconceptionLibrary;

  constructor() {
    this.strategies = new Map();
    this.misconceptionLibrary = {
      byModel: {},
      byYear: {},
      byTopic: {}
    };

    this.initializeStrategies();
    this.loadMisconceptionLibrary();
  }

  /**
   * Generate distractors for a given correct answer and context
   */
  async generate(
    correctAnswer: any,
    context: DistractorContext,
    count: number = 3
  ): Promise<Distractor[]> {
    // 1. Select applicable strategies based on context
    const applicableStrategies = this.selectStrategies(context);

    // 2. Generate distractor candidates from multiple strategies
    const candidates: Distractor[] = [];
    for (const strategy of applicableStrategies) {
      try {
        const distractors = strategy.generator(correctAnswer, context);
        candidates.push(...distractors);
      } catch (error) {
        console.warn(`Failed to generate distractors for strategy ${strategy.strategy}:`, error);
      }
    }

    // 3. Filter and select best distractors
    return this.selectBestDistractors(candidates, correctAnswer, count);
  }

  /**
   * Select applicable distractor strategies based on context
   */
  private selectStrategies(context: DistractorContext): DistractorRule[] {
    return Array.from(this.strategies.values())
      .filter(rule =>
        rule.applicableFormats.includes(context.format) &&
        (rule.applicableModels.length === 0 ||
         rule.applicableModels.includes(context.mathModel))
      )
      .sort((a, b) => b.probability - a.probability)
      .slice(0, 8); // Limit to top 8 strategies to avoid overgeneration
  }

  /**
   * Select the best distractors from candidates
   */
  private selectBestDistractors(
    candidates: Distractor[],
    correctAnswer: any,
    count: number
  ): Distractor[] {
    // Remove duplicates
    const unique = this.removeDuplicates(candidates);

    // Remove distractors too similar to correct answer
    const filtered = unique.filter(d =>
      !this.tooSimilar(d.value, correctAnswer)
    );

    // Prioritize by strategy diversity and pedagogical value
    const diverse = this.ensureStrategyDiversity(filtered);

    // Return requested count
    return diverse.slice(0, count);
  }

  /**
   * Initialize distractor generation strategies
   */
  private initializeStrategies(): void {
    // Wrong Operation Strategy
    this.strategies.set(DistractorStrategy.WRONG_OPERATION, {
      strategy: DistractorStrategy.WRONG_OPERATION,
      applicableFormats: [QuestionFormat.DIRECT_CALCULATION],
      applicableModels: ['ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION'],
      generator: this.createWrongOperationGenerator(),
      probability: 0.8
    });

    // Place Value Error Strategy
    this.strategies.set(DistractorStrategy.PLACE_VALUE_ERROR, {
      strategy: DistractorStrategy.PLACE_VALUE_ERROR,
      applicableFormats: [QuestionFormat.DIRECT_CALCULATION],
      applicableModels: ['ADDITION', 'SUBTRACTION', 'MULTIPLICATION'],
      generator: this.createPlaceValueErrorGenerator(),
      probability: 0.7
    });

    // Partial Calculation Strategy
    this.strategies.set(DistractorStrategy.PARTIAL_CALCULATION, {
      strategy: DistractorStrategy.PARTIAL_CALCULATION,
      applicableFormats: [QuestionFormat.MULTI_STEP, QuestionFormat.DIRECT_CALCULATION],
      applicableModels: ['MULTI_STEP', 'ADDITION', 'MULTIPLICATION'],
      generator: this.createPartialCalculationGenerator(),
      probability: 0.6
    });

    // Unit Confusion Strategy
    this.strategies.set(DistractorStrategy.UNIT_CONFUSION, {
      strategy: DistractorStrategy.UNIT_CONFUSION,
      applicableFormats: [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.COMPARISON],
      applicableModels: ['PERCENTAGE', 'UNIT_RATE', 'CONVERSION'],
      generator: this.createUnitConfusionGenerator(),
      probability: 0.9
    });

    // Reversed Comparison Strategy
    this.strategies.set(DistractorStrategy.REVERSED_COMPARISON, {
      strategy: DistractorStrategy.REVERSED_COMPARISON,
      applicableFormats: [QuestionFormat.COMPARISON],
      applicableModels: ['COMPARISON', 'UNIT_RATE'],
      generator: this.createReversedComparisonGenerator(),
      probability: 0.8
    });

    // Close Value Strategy
    this.strategies.set(DistractorStrategy.CLOSE_VALUE, {
      strategy: DistractorStrategy.CLOSE_VALUE,
      applicableFormats: [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.ESTIMATION],
      applicableModels: [],
      generator: this.createCloseValueGenerator(),
      probability: 0.5
    });

    // Off by Magnitude Strategy
    this.strategies.set(DistractorStrategy.OFF_BY_MAGNITUDE, {
      strategy: DistractorStrategy.OFF_BY_MAGNITUDE,
      applicableFormats: [QuestionFormat.DIRECT_CALCULATION],
      applicableModels: ['MULTIPLICATION', 'DIVISION', 'PERCENTAGE'],
      generator: this.createOffByMagnitudeGenerator(),
      probability: 0.6
    });

    // Common Misconception Strategy
    this.strategies.set(DistractorStrategy.COMMON_MISCONCEPTION, {
      strategy: DistractorStrategy.COMMON_MISCONCEPTION,
      applicableFormats: [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.COMPARISON],
      applicableModels: [],
      generator: this.createMisconceptionGenerator(),
      probability: 0.9
    });
  }

  /**
   * Create wrong operation distractor generator
   */
  private createWrongOperationGenerator(): DistractorGenerator {
    return (correct: number, context: DistractorContext): Distractor[] => {
      const distractors: Distractor[] = [];

      if (!context.operands || context.operands.length < 2) {
        return distractors;
      }

      const [a, b] = context.operands;

      switch (context.operation) {
        case 'ADDITION':
          if (a - b > 0 && a - b !== correct) {
            distractors.push({
              value: a - b,
              displayText: String(a - b),
              strategy: DistractorStrategy.WRONG_OPERATION,
              reasoning: 'Subtracted instead of adding'
            });
          }
          if (a * b !== correct) {
            distractors.push({
              value: a * b,
              displayText: String(a * b),
              strategy: DistractorStrategy.WRONG_OPERATION,
              reasoning: 'Multiplied instead of adding'
            });
          }
          break;

        case 'SUBTRACTION':
          if (a + b !== correct) {
            distractors.push({
              value: a + b,
              displayText: String(a + b),
              strategy: DistractorStrategy.WRONG_OPERATION,
              reasoning: 'Added instead of subtracting'
            });
          }
          break;

        case 'MULTIPLICATION':
          if (a + b !== correct) {
            distractors.push({
              value: a + b,
              displayText: String(a + b),
              strategy: DistractorStrategy.WRONG_OPERATION,
              reasoning: 'Added instead of multiplying'
            });
          }
          if (a - b > 0 && a - b !== correct) {
            distractors.push({
              value: a - b,
              displayText: String(a - b),
              strategy: DistractorStrategy.WRONG_OPERATION,
              reasoning: 'Subtracted instead of multiplying'
            });
          }
          break;

        case 'DIVISION':
          if (a - b > 0 && a - b !== correct) {
            distractors.push({
              value: a - b,
              displayText: String(a - b),
              strategy: DistractorStrategy.WRONG_OPERATION,
              reasoning: 'Subtracted instead of dividing'
            });
          }
          break;
      }

      return distractors;
    };
  }

  /**
   * Create place value error distractor generator
   */
  private createPlaceValueErrorGenerator(): DistractorGenerator {
    return (correct: number, context: DistractorContext): Distractor[] => {
      const distractors: Distractor[] = [];

      if (correct < 10) return distractors; // Not applicable to single digits

      const magnitude = Math.pow(10, Math.floor(Math.log10(correct)));

      // Carry error - off by one magnitude
      const carryError = correct + magnitude;
      if (carryError !== correct) {
        distractors.push({
          value: carryError,
          displayText: String(carryError),
          strategy: DistractorStrategy.PLACE_VALUE_ERROR,
          reasoning: 'Error in carrying to next column'
        });
      }

      // Forget to carry
      const forgetCarry = correct - magnitude / 10;
      if (forgetCarry > 0 && forgetCarry !== correct) {
        distractors.push({
          value: forgetCarry,
          displayText: String(forgetCarry),
          strategy: DistractorStrategy.PLACE_VALUE_ERROR,
          reasoning: 'Forgot to carry'
        });
      }

      return distractors;
    };
  }

  /**
   * Create partial calculation distractor generator
   */
  private createPartialCalculationGenerator(): DistractorGenerator {
    return (correct: number, context: DistractorContext): Distractor[] => {
      const distractors: Distractor[] = [];

      if (context.operands && context.operands.length > 2) {
        // Stopped after first two operands
        const [a, b] = context.operands;
        let partial: number;

        switch (context.operation) {
          case 'ADDITION':
            partial = a + b;
            break;
          case 'MULTIPLICATION':
            partial = a * b;
            break;
          default:
            return distractors;
        }

        if (partial !== correct) {
          distractors.push({
            value: partial,
            displayText: String(partial),
            strategy: DistractorStrategy.PARTIAL_CALCULATION,
            reasoning: 'Stopped calculation early'
          });
        }
      }

      return distractors;
    };
  }

  /**
   * Create unit confusion distractor generator
   */
  private createUnitConfusionGenerator(): DistractorGenerator {
    return (correct: number, context: DistractorContext): Distractor[] => {
      const distractors: Distractor[] = [];

      if (context.mathModel === 'PERCENTAGE' && context.operands) {
        const [base, percent] = context.operands;

        // Forgot to divide by 100
        const wrongMultiply = base * percent;
        if (wrongMultiply !== correct) {
          distractors.push({
            value: wrongMultiply,
            displayText: String(wrongMultiply),
            strategy: DistractorStrategy.UNIT_CONFUSION,
            reasoning: 'Multiplied by percentage without converting to decimal'
          });
        }

        // Added percentage as absolute value
        const wrongAdd = base + percent;
        if (wrongAdd !== correct) {
          distractors.push({
            value: wrongAdd,
            displayText: String(wrongAdd),
            strategy: DistractorStrategy.UNIT_CONFUSION,
            reasoning: 'Added percentage as absolute value'
          });
        }
      }

      return distractors;
    };
  }

  /**
   * Create reversed comparison distractor generator
   */
  private createReversedComparisonGenerator(): DistractorGenerator {
    return (correct: number, context: DistractorContext): Distractor[] => {
      const distractors: Distractor[] = [];

      // For comparison questions, the opposite choice is always a valid distractor
      const oppositeChoice = correct === 0 ? 1 : 0;

      distractors.push({
        value: oppositeChoice,
        displayText: `Option ${String.fromCharCode(65 + oppositeChoice)}`,
        strategy: DistractorStrategy.REVERSED_COMPARISON,
        reasoning: 'Selected the worse option'
      });

      return distractors;
    };
  }

  /**
   * Create close value distractor generator
   */
  private createCloseValueGenerator(): DistractorGenerator {
    return (correct: number, context: DistractorContext): Distractor[] => {
      const distractors: Distractor[] = [];

      // Generate values close to the correct answer
      const variations = [1, -1, 2, -2, 5, -5, 10, -10];

      for (const variation of variations) {
        const candidate = correct + variation;
        if (candidate > 0 && candidate !== correct) {
          distractors.push({
            value: candidate,
            displayText: String(candidate),
            strategy: DistractorStrategy.CLOSE_VALUE,
            reasoning: `Off by ${Math.abs(variation)}`
          });

          if (distractors.length >= 3) break;
        }
      }

      return distractors;
    };
  }

  /**
   * Create off by magnitude distractor generator
   */
  private createOffByMagnitudeGenerator(): DistractorGenerator {
    return (correct: number, context: DistractorContext): Distractor[] => {
      const distractors: Distractor[] = [];

      if (correct >= 10) {
        // Off by factor of 10
        const tenTimes = correct * 10;
        const tenthOf = correct / 10;

        if (tenthOf >= 1 && tenthOf !== correct) {
          distractors.push({
            value: tenthOf,
            displayText: String(tenthOf),
            strategy: DistractorStrategy.OFF_BY_MAGNITUDE,
            reasoning: 'Result is 10 times too small'
          });
        }

        if (tenTimes !== correct) {
          distractors.push({
            value: tenTimes,
            displayText: String(tenTimes),
            strategy: DistractorStrategy.OFF_BY_MAGNITUDE,
            reasoning: 'Result is 10 times too large'
          });
        }
      }

      return distractors;
    };
  }

  /**
   * Create misconception-based distractor generator
   */
  private createMisconceptionGenerator(): DistractorGenerator {
    return (correct: number, context: DistractorContext): Distractor[] => {
      const distractors: Distractor[] = [];

      // Get misconceptions for this model and year level
      const modelMisconceptions = this.misconceptionLibrary.byModel[context.mathModel] || [];
      const yearMisconceptions = this.misconceptionLibrary.byYear[context.yearLevel] || [];

      const applicable = [...modelMisconceptions, ...yearMisconceptions]
        .filter(m =>
          m.yearRange.min <= context.yearLevel &&
          m.yearRange.max >= context.yearLevel
        );

      for (const misconception of applicable.slice(0, 2)) {
        try {
          const generated = misconception.generateDistractor(correct, context);
          distractors.push(...generated);
        } catch (error) {
          console.warn(`Failed to generate distractor for misconception ${misconception.id}:`, error);
        }
      }

      return distractors;
    };
  }

  /**
   * Load the misconception library with common student errors
   */
  private loadMisconceptionLibrary(): void {
    // Addition misconceptions
    this.misconceptionLibrary.byModel['ADDITION'] = [
      {
        id: 'add-001-no-carry',
        description: 'Forgets to carry when adding columns',
        example: '47 + 38 = 75 (instead of 85)',
        generateDistractor: (correct: number, context: DistractorContext): Distractor[] => {
          if (context.operands && context.operands.length === 2) {
            const [a, b] = context.operands;
            const wrongResult = this.simulateNoCarryAddition(a, b);
            if (wrongResult !== correct) {
              return [{
                value: wrongResult,
                displayText: String(wrongResult),
                strategy: DistractorStrategy.COMMON_MISCONCEPTION,
                reasoning: 'Forgot to carry when adding'
              }];
            }
          }
          return [];
        },
        prevalence: 'common',
        yearRange: { min: 2, max: 4 }
      }
    ];

    // Multiplication misconceptions
    this.misconceptionLibrary.byModel['MULTIPLICATION'] = [
      {
        id: 'mult-001-zero-property',
        description: 'Believes any number times zero equals the number',
        example: '5 Ã 0 = 5 (instead of 0)',
        generateDistractor: (correct: number, context: DistractorContext): Distractor[] => {
          if (context.operands && context.operands.includes(0)) {
            const nonZero = context.operands.find(n => n !== 0);
            if (nonZero && nonZero !== correct) {
              return [{
                value: nonZero,
                displayText: String(nonZero),
                strategy: DistractorStrategy.COMMON_MISCONCEPTION,
                reasoning: 'Incorrectly applied zero property'
              }];
            }
          }
          return [];
        },
        prevalence: 'common',
        yearRange: { min: 2, max: 5 }
      }
    ];

    // Add year-based misconceptions
    this.misconceptionLibrary.byYear[2] = [
      {
        id: 'year2-001-counting-on',
        description: 'Counts on from first number instead of using efficient strategy',
        example: '8 + 5: counts 9, 10, 11, 12, 13 instead of using known facts',
        generateDistractor: (correct: number, context: DistractorContext): Distractor[] => {
          // Generate counting errors
          return [{
            value: correct - 1,
            displayText: String(correct - 1),
            strategy: DistractorStrategy.COMMON_MISCONCEPTION,
            reasoning: 'Counting error'
          }];
        },
        prevalence: 'common',
        yearRange: { min: 1, max: 3 }
      }
    ];
  }

  /**
   * Simulate addition without carrying (common error)
   */
  private simulateNoCarryAddition(a: number, b: number): number {
    const aStr = a.toString();
    const bStr = b.toString();
    const maxLength = Math.max(aStr.length, bStr.length);

    let result = '';
    for (let i = 0; i < maxLength; i++) {
      const digitA = parseInt(aStr[aStr.length - 1 - i] || '0');
      const digitB = parseInt(bStr[bStr.length - 1 - i] || '0');
      const sum = digitA + digitB;
      result = (sum % 10) + result; // No carrying
    }

    return parseInt(result);
  }

  /**
   * Remove duplicate distractors
   */
  private removeDuplicates(distractors: Distractor[]): Distractor[] {
    const seen = new Set<any>();
    return distractors.filter(d => {
      if (seen.has(d.value)) {
        return false;
      }
      seen.add(d.value);
      return true;
    });
  }

  /**
   * Check if distractor value is too similar to correct answer
   */
  private tooSimilar(distractorValue: any, correctValue: any): boolean {
    if (typeof distractorValue === 'number' && typeof correctValue === 'number') {
      // Too similar if within 5% or difference is less than 1
      const difference = Math.abs(distractorValue - correctValue);
      const percentDifference = difference / Math.abs(correctValue);
      return difference < 1 || percentDifference < 0.05;
    }

    return distractorValue === correctValue;
  }

  /**
   * Ensure diversity in distractor strategies
   */
  private ensureStrategyDiversity(distractors: Distractor[]): Distractor[] {
    const strategyCounts = new Map<DistractorStrategy, number>();
    const diverse: Distractor[] = [];

    // Sort by pedagogical value (prioritize common misconceptions)
    const sorted = distractors.sort((a, b) => {
      const priorityOrder = [
        DistractorStrategy.COMMON_MISCONCEPTION,
        DistractorStrategy.WRONG_OPERATION,
        DistractorStrategy.UNIT_CONFUSION,
        DistractorStrategy.REVERSED_COMPARISON,
        DistractorStrategy.PLACE_VALUE_ERROR,
        DistractorStrategy.PARTIAL_CALCULATION,
        DistractorStrategy.CLOSE_VALUE,
        DistractorStrategy.OFF_BY_MAGNITUDE
      ];

      return priorityOrder.indexOf(a.strategy) - priorityOrder.indexOf(b.strategy);
    });

    for (const distractor of sorted) {
      const count = strategyCounts.get(distractor.strategy) || 0;
      if (count < 2) { // Max 2 per strategy
        diverse.push(distractor);
        strategyCounts.set(distractor.strategy, count + 1);
      }
    }

    return diverse;
  }
}
```
--- END FILE: lib\services\distractor-engine.service.ts ---

--- START FILE: lib\services\scenario.service.ts ---
```typescript
// Scenario Service - Provides rich contextual scenarios for question generation
// Expands beyond existing MoneyContextGenerator with diverse themes

import {
  ScenarioContext,
  ScenarioTheme,
  ScenarioCriteria,
  ScoredScenario,
  QuestionFormat,
  ScenarioSetting,
  Character,
  ContextItem,
  ItemCategory,
  CulturalElement,
  ScenarioTemplate,
  PlaceholderDefinition
} from '@/lib/types/question-formats';

/**
 * Enhanced scenario service that provides rich, diverse contexts for questions
 * Maintains compatibility with existing MoneyContextGenerator while adding new themes
 */
export class ScenarioService {
  private scenarios: Map<string, ScenarioContext>;
  private themeIndex: Map<ScenarioTheme, string[]>;
  private recentlyUsed: Set<string>;
  private recentlyUsedMaxSize = 20;
  private modelThemeCompatibility: Map<string, ScenarioTheme[]>;

  constructor() {
    this.scenarios = new Map();
    this.themeIndex = new Map();
    this.recentlyUsed = new Set();
    this.modelThemeCompatibility = new Map();

    this.initializeScenarios();
    this.buildThemeIndex();
    this.initializeModelThemeCompatibility();
  }

  /**
   * Select the best scenario for given criteria
   */
  async selectScenario(criteria: ScenarioCriteria): Promise<ScenarioContext> {
    // 1. Filter by format compatibility
    let candidates = this.filterByFormat(criteria.format);

    // 2. Filter by year appropriateness
    candidates = this.filterByYear(candidates, criteria.yearLevel);

    // 3. Filter by model-theme compatibility
    if (criteria.mathModel && !criteria.theme) {
      // If no theme is specified but we have a model, get compatible themes
      const compatibleThemes = this.modelThemeCompatibility.get(criteria.mathModel);
      if (compatibleThemes && compatibleThemes.length > 0) {
        candidates = candidates.filter(scenario =>
          compatibleThemes.includes(scenario.theme)
        );
      }
    }

    // 4. Filter by theme if specified
    if (criteria.theme) {
      // Check if specified theme is compatible with the model
      if (criteria.mathModel) {
        const compatibleThemes = this.modelThemeCompatibility.get(criteria.mathModel);
        if (compatibleThemes && !compatibleThemes.includes(criteria.theme)) {
          console.warn(`Theme ${criteria.theme} is not compatible with model ${criteria.mathModel}. Available themes:`, compatibleThemes);
          // Allow override but log warning
        }
      }
      candidates = this.filterByTheme(candidates, criteria.theme);
    }

    // 5. If no candidates found, generate dynamic scenario
    if (candidates.length === 0) {
      if (criteria.theme) {
        return this.generateDynamicScenario(criteria.theme, criteria.yearLevel);
      } else {
        // Fall back to a default scenario
        return this.getDefaultScenario(criteria.yearLevel);
      }
    }

    // 6. Score and rank candidates
    const scored = this.scoreScenarios(candidates, criteria);

    // 7. Select best match with some randomization
    return this.selectWithRandomization(scored);
  }

  /**
   * Generate a dynamic scenario for themes with procedural generation
   */
  async generateDynamicScenario(
    theme: ScenarioTheme,
    yearLevel: number
  ): Promise<ScenarioContext> {
    switch (theme) {
      case ScenarioTheme.POCKET_MONEY:
        return this.generatePocketMoneyScenario(yearLevel);
      case ScenarioTheme.SCHOOL:
        return this.generateSchoolScenario(yearLevel);
      case ScenarioTheme.SPORTS:
        return this.generateSportsScenario(yearLevel);
      case ScenarioTheme.COOKING:
        return this.generateCookingScenario(yearLevel);
      case ScenarioTheme.NATURE:
        return this.createPlaceholderScenario(ScenarioTheme.NATURE, yearLevel);
      case ScenarioTheme.TRANSPORT:
        return this.createPlaceholderScenario(ScenarioTheme.TRANSPORT, yearLevel);
      case ScenarioTheme.COLLECTIONS:
        return this.createPlaceholderScenario(ScenarioTheme.COLLECTIONS, yearLevel);
      case ScenarioTheme.HOUSEHOLD:
        return this.createPlaceholderScenario(ScenarioTheme.HOUSEHOLD, yearLevel);
      case ScenarioTheme.CELEBRATIONS:
        return this.createPlaceholderScenario(ScenarioTheme.CELEBRATIONS, yearLevel);
      default:
        return this.getDefaultScenario(yearLevel);
    }
  }

  /**
   * Filter scenarios by format compatibility
   */
  private filterByFormat(format: QuestionFormat): ScenarioContext[] {
    return Array.from(this.scenarios.values()).filter(scenario =>
      scenario.templates.some(template =>
        template.formatCompatibility.includes(format)
      )
    );
  }

  /**
   * Filter scenarios by year appropriateness
   */
  private filterByYear(scenarios: ScenarioContext[], yearLevel: number): ScenarioContext[] {
    return scenarios.filter(scenario =>
      scenario.yearAppropriate.includes(yearLevel)
    );
  }

  /**
   * Filter scenarios by theme
   */
  private filterByTheme(scenarios: ScenarioContext[], theme: ScenarioTheme): ScenarioContext[] {
    return scenarios.filter(scenario => scenario.theme === theme);
  }

  /**
   * Score scenarios based on various criteria
   */
  private scoreScenarios(
    scenarios: ScenarioContext[],
    criteria: ScenarioCriteria
  ): ScoredScenario[] {
    return scenarios.map(scenario => {
      let score = 0;

      // Cultural relevance (UK specific)
      if (scenario.culturalElements.some(e => e.type === 'currency' && e.value === 'Â£')) {
        score += 10;
      }

      // Real-world connection strength
      if (scenario.realWorldConnection) {
        score += 15;
      }

      // Variety bonus (if not recently used)
      if (!this.recentlyUsed.has(scenario.id)) {
        score += 20;
      }

      // Year alignment (closer to target year gets higher score)
      const yearDistance = Math.abs(
        scenario.yearAppropriate[0] - criteria.yearLevel
      );
      score -= yearDistance * 5;

      // Theme preference bonus
      if (criteria.theme && scenario.theme === criteria.theme) {
        score += 25;
      }

      return { scenario, score };
    });
  }

  /**
   * Select scenario with weighted randomization
   */
  private selectWithRandomization(scored: ScoredScenario[]): ScenarioContext {
    // Sort by score
    const sorted = scored.sort((a, b) => b.score - a.score);

    if (sorted.length === 0) {
        return this.getDefaultScenario(4); // Fallback
    }

    // Use weighted selection from top 3 candidates
    const topCandidates = sorted.slice(0, 3);
    const totalScore = topCandidates.reduce((sum, s) => sum + Math.max(1, s.score), 0);

    let random = Math.random() * totalScore;
    for (const candidate of topCandidates) {
      random -= Math.max(1, candidate.score);
      if (random <= 0) {
        this.markAsRecentlyUsed(candidate.scenario.id);
        return candidate.scenario;
      }
    }

    // Fallback to first candidate
    const selected = sorted[0].scenario;
    this.markAsRecentlyUsed(selected.id);
    return selected;
  }

  /**
   * Mark scenario as recently used
   */
  private markAsRecentlyUsed(scenarioId: string): void {
    this.recentlyUsed.add(scenarioId);
    if (this.recentlyUsed.size > this.recentlyUsedMaxSize) {
      const first = this.recentlyUsed.values().next().value;
      if (first) {
        this.recentlyUsed.delete(first);
      }
    }
  }

  /**
   * Generate pocket money scenario dynamically
   */
  private generatePocketMoneyScenario(year: number): ScenarioContext {
    const weeklyAmounts = {
      1: { min: 1, max: 2 },
      2: { min: 2, max: 3 },
      3: { min: 3, max: 5 },
      4: { min: 5, max: 7 },
      5: { min: 7, max: 10 },
      6: { min: 10, max: 15 }
    };

    const savingGoals = {
      1: ['toy', 'book', 'sweets'],
      2: ['game', 'toy', 'book'],
      3: ['video game', 'board game', 'sports equipment'],
      4: ['video game', 'clothes', 'hobby supplies'],
      5: ['phone case', 'headphones', 'games'],
      6: ['concert ticket', 'sports equipment', 'tech gadget']
    };

    const amount = weeklyAmounts[year as keyof typeof weeklyAmounts] || weeklyAmounts[3];
    const goals = savingGoals[year as keyof typeof savingGoals] || savingGoals[3];

    return {
      id: `pocket-money-${year}-${Date.now()}`,
      theme: ScenarioTheme.POCKET_MONEY,
      setting: {
        location: 'home',
        timeContext: 'weekly',
        atmosphere: 'planning'
      },
      characters: [
        { name: this.selectRandomName(), role: 'student' }
      ],
      items: goals.map(goal => ({
        name: goal,
        category: ItemCategory.SAVING_GOAL,
        typicalValue: {
          min: amount.min * 4,
          max: amount.max * 8,
          typical: amount.max * 5,
          distribution: 'normal' as const
        },
        unit: 'Â£',
        attributes: {
          quality: 'standard' as const
        }
      })),
      culturalElements: [
        {
          type: 'currency' as const,
          value: 'Â£',
          explanation: 'British pounds'
        },
        {
          type: 'custom' as const,
          value: 'pocket money',
          explanation: 'Weekly allowance for children'
        }
      ],
      realWorldConnection: 'Learning to save and budget money',
      yearAppropriate: [year],
      templates: [
        {
          formatCompatibility: [QuestionFormat.ESTIMATION, QuestionFormat.MULTI_STEP],
          template: 'If {character} gets {amount} pocket money each week, how many weeks will it take to save for a {item} that costs {price}?',
          answerTemplate: 'It will take {result} weeks',
          placeholders: [
            { key: 'character', type: 'character' as const },
            { key: 'amount', type: 'value' as const },
            { key: 'item', type: 'item' as const },
            { key: 'price', type: 'value' as const }
          ]
        }
      ]
    };
  }

  /**
   * Generate school scenario dynamically
   */
  private generateSchoolScenario(year: number): ScenarioContext {
    const schoolItems = {
      1: ['pencil', 'rubber', 'ruler', 'colouring pencil'],
      2: ['exercise book', 'pencil case', 'glue stick', 'scissors'],
      3: ['calculator', 'compass', 'protractor', 'highlighter'],
      4: ['folder', 'dividers', 'hole punch', 'stapler'],
      5: ['textbook', 'revision guide', 'ring binder', 'index cards'],
      6: ['laptop case', 'USB stick', 'planner', 'scientific calculator']
    };

    const items = schoolItems[year as keyof typeof schoolItems] || schoolItems[3];

    return {
      id: `school-${year}-${Date.now()}`,
      theme: ScenarioTheme.SCHOOL,
      setting: {
        location: 'school stationery shop',
        timeContext: 'start of term',
        atmosphere: 'busy'
      },
      characters: [
        { name: this.selectRandomName(), role: 'student' },
        { name: 'Mrs. Thompson', role: 'teacher' }
      ],
      items: items.map(item => ({
        name: item,
        category: ItemCategory.SCHOOL_SUPPLIES,
        typicalValue: {
          min: 0.50,
          max: 15.00,
          typical: 3.00,
          distribution: 'skewed_low' as const
        },
        unit: 'Â£',
        attributes: {
          quality: 'standard' as const
        }
      })),
      culturalElements: [
        {
          type: 'currency' as const,
          value: 'Â£',
          explanation: 'British pounds'
        },
        {
          type: 'event' as const,
          value: 'start of term',
          explanation: 'When students buy school supplies'
        }
      ],
      realWorldConnection: 'Budgeting for school supplies',
      yearAppropriate: [year],
      templates: [
        {
          formatCompatibility: [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.COMPARISON],
          template: '{character} needs to buy {items} for school. How much will it cost in total?',
          answerTemplate: 'The total cost is {result}',
          placeholders: [
            { key: 'character', type: 'character' as const },
            { key: 'items', type: 'item' as const },
            { key: 'result', type: 'value' as const }
          ]
        }
      ]
    };
  }

  /**
   * Generate sports scenario dynamically
   */
  private generateSportsScenario(year: number): ScenarioContext {
    const sportsEquipment = ['football', 'tennis ball', 'cricket bat', 'rugby ball', 'basketball'];
    const venues = ['sports shop', 'leisure centre', 'school sports hall'];

    return {
      id: `sports-${year}-${Date.now()}`,
      theme: ScenarioTheme.SPORTS,
      setting: {
        location: venues[Math.floor(Math.random() * venues.length)],
        timeContext: 'weekend',
        atmosphere: 'energetic'
      },
      characters: [
        { name: this.selectRandomName(), role: 'student' },
        { name: this.selectRandomName(), role: 'coach' }
      ],
      items: sportsEquipment.map(item => ({
        name: item,
        category: ItemCategory.SPORTS_EQUIPMENT,
        typicalValue: {
          min: 5.00,
          max: 50.00,
          typical: 20.00,
          distribution: 'normal' as const
        },
        unit: 'Â£',
        attributes: {
          quality: 'standard' as const
        }
      })),
      culturalElements: [
        {
          type: 'currency' as const,
          value: 'Â£',
          explanation: 'British pounds'
        }
      ],
      realWorldConnection: 'Calculating costs for sports activities',
      yearAppropriate: [year],
      templates: [
        {
          formatCompatibility: [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.MULTI_STEP],
          template: 'The {item} costs {price}. If {character} buys {quantity}, how much will it cost?',
          answerTemplate: 'The total cost is {result}',
          placeholders: [
            { key: 'character', type: 'character' as const },
            { key: 'item', type: 'item' as const },
            { key: 'price', type: 'value' as const },
            { key: 'quantity', type: 'value' as const },
            { key: 'result', type: 'value' as const }
          ]
        }
      ]
    };
  }

  /**
   * Generate cooking scenario dynamically
   */
  private generateCookingScenario(year: number): ScenarioContext {
    const ingredients = ['flour', 'eggs', 'butter', 'sugar', 'milk', 'chocolate chips'];
    const recipes = ['biscuits', 'cake', 'muffins', 'bread', 'pizza'];

    return {
      id: `cooking-${year}-${Date.now()}`,
      theme: ScenarioTheme.COOKING,
      setting: {
        location: 'kitchen',
        timeContext: 'weekend baking',
        atmosphere: 'creative'
      },
      characters: [
        { name: this.selectRandomName(), role: 'student' },
        { name: 'Mum', role: 'parent' }
      ],
      items: ingredients.map(ingredient => ({
        name: ingredient,
        category: ItemCategory.FOOD_ITEMS,
        typicalValue: {
          min: 1.00,
          max: 5.00,
          typical: 2.50,
          distribution: 'normal' as const
        },
        unit: 'Â£',
        attributes: {
          quality: 'standard' as const
        }
      })),
      culturalElements: [
        {
          type: 'currency' as const,
          value: 'Â£',
          explanation: 'British pounds'
        },
        {
          type: 'measurement' as const,
          value: 'grams',
          explanation: 'Weight measurement for ingredients'
        }
      ],
      realWorldConnection: 'Following recipes and calculating ingredient costs',
      yearAppropriate: [year],
      templates: [
        {
          formatCompatibility: [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.MULTI_STEP],
          template: '{character} is making {recipe}. The ingredients cost {prices}. What is the total cost?',
          answerTemplate: 'The total cost is {result}',
          placeholders: [
            { key: 'character', type: 'character' as const },
            { key: 'recipe', type: 'item' as const },
            { key: 'prices', type: 'value' as const },
            { key: 'result', type: 'value' as const }
          ]
        }
      ]
    };
  }

  /**
   * Creates a generic placeholder scenario to fix the theme selection bug
   */
  private createPlaceholderScenario(theme: ScenarioTheme, year: number): ScenarioContext {
      const themeName = theme.toLowerCase().replace('_', ' ');
      return {
          id: `${themeName.replace(' ', '-')}-${year}-${Date.now()}`,
          theme: theme,
          setting: { location: `${themeName} context`, atmosphere: 'neutral' },
          characters: [{ name: this.selectRandomName(), role: 'student' }],
          items: [{ name: 'object', category: ItemCategory.HOUSEHOLD_ITEMS, typicalValue: { min: 1, max: 10, typical: 5, distribution: 'normal' }, unit: '', attributes: {} }],
          culturalElements: [],
          realWorldConnection: `Applying math in a ${themeName} context.`,
          yearAppropriate: [year],
          templates: [{
              formatCompatibility: [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.ESTIMATION, QuestionFormat.MULTI_STEP],
              template: '{character} is solving a problem about {theme}. The numbers are {operands}. What is the result?',
              answerTemplate: 'The result is {result}',
              placeholders: []
          }]
      };
  }

  /**
   * Get default scenario for fallback
   */
  private getDefaultScenario(yearLevel: number): ScenarioContext {
    return {
      id: `default-${yearLevel}-${Date.now()}`,
      theme: ScenarioTheme.SHOPPING,
      setting: {
        location: 'shop',
        timeContext: 'afternoon',
        atmosphere: 'friendly'
      },
      characters: [
        { name: this.selectRandomName(), role: 'student' }
      ],
      items: [
        {
          name: 'item',
          category: ItemCategory.HOUSEHOLD_ITEMS,
          typicalValue: {
            min: 1.00,
            max: 10.00,
            typical: 5.00,
            distribution: 'normal' as const
          },
          unit: 'Â£',
          attributes: {
            quality: 'standard' as const
          }
        }
      ],
      culturalElements: [
        {
          type: 'currency' as const,
          value: 'Â£',
          explanation: 'British pounds'
        }
      ],
      realWorldConnection: 'Basic shopping calculations',
      yearAppropriate: [yearLevel],
      templates: [
        {
          formatCompatibility: [QuestionFormat.DIRECT_CALCULATION],
          template: '{character} buys a {item} for {price}. How much does it cost?',
          answerTemplate: 'It costs {result}',
          placeholders: [
            { key: 'character', type: 'character' as const },
            { key: 'item', type: 'item' as const },
            { key: 'price', type: 'value' as const },
            { key: 'result', type: 'value' as const }
          ]
        }
      ]
    };
  }

  /**
   * Select a random name for characters
   */
  private selectRandomName(): string {
    const names = [
      'Emma', 'Olivia', 'Ava', 'Isabella', 'Sophia', 'Charlotte', 'Mia', 'Amelia',
      'Harper', 'Evelyn', 'Abigail', 'Emily', 'Elizabeth', 'Sofia', 'Madison',
      'Liam', 'Noah', 'William', 'James', 'Oliver', 'Benjamin', 'Elijah', 'Lucas',
      'Mason', 'Logan', 'Alexander', 'Ethan', 'Jacob', 'Michael', 'Daniel', 'Henry'
    ];
    return names[Math.floor(Math.random() * names.length)];
  }

  /**
   * Initialize pre-built scenarios
   */
  private initializeScenarios(): void {
    // Shopping scenarios
    this.addShoppingScenarios();

    // School scenarios
    this.addSchoolScenarios();

    // Celebration scenarios
    this.addCelebrationScenarios();
  }

  /**
   * Add shopping scenarios
   */
  private addShoppingScenarios(): void {
    const bookFairScenario: ScenarioContext = {
      id: 'shop-001-bookfair',
      theme: ScenarioTheme.SHOPPING,
      setting: {
        location: 'school book fair',
        timeContext: 'lunch break',
        atmosphere: 'busy'
      },
      characters: [
        { name: 'Sarah', role: 'student' },
        { name: 'Mr. Johnson', role: 'teacher' }
      ],
      items: [
        {
          name: 'book',
          category: ItemCategory.BOOKS_MEDIA,
          typicalValue: { min: 3.00, max: 12.00, typical: 6.50, distribution: 'normal' },
          unit: 'Â£',
          attributes: { quality: 'standard' }
        },
        {
          name: 'bookmark',
          category: ItemCategory.SCHOOL_SUPPLIES,
          typicalValue: { min: 0.50, max: 2.00, typical: 1.00, distribution: 'normal' },
          unit: 'Â£',
          attributes: { quality: 'standard' }
        }
      ],
      culturalElements: [
        { type: 'currency', value: 'Â£', explanation: 'British pounds' },
        { type: 'event', value: 'book fair', explanation: 'School fundraising event' }
      ],
      realWorldConnection: 'School fundraising and reading promotion',
      yearAppropriate: [2, 3, 4, 5],
      templates: [
        {
          formatCompatibility: [QuestionFormat.DIRECT_CALCULATION, QuestionFormat.COMPARISON],
          template: '{character} wants to buy books at the book fair. Calculate the total cost.',
          answerTemplate: 'The total cost is {result}',
          placeholders: [
            { key: 'character', type: 'character' },
            { key: 'result', type: 'value' }
          ]
        }
      ]
    };

    this.scenarios.set(bookFairScenario.id, bookFairScenario);

    // Add realistic general shopping scenario
    this.addRealisticShoppingScenario();
  }

  /**
   * Add realistic shopping scenario with proper pricing constraints
   */
  private addRealisticShoppingScenario(): void {
    const realisticPrices: Record<string, { min: number, max: number, typical: number }> = {
      'apple': { min: 0.20, max: 0.50, typical: 0.35 },
      'banana': { min: 0.15, max: 0.40, typical: 0.25 },
      'sandwich': { min: 2.50, max: 6.00, typical: 4.00 },
      'drink': { min: 0.80, max: 2.50, typical: 1.50 },
      'cake': { min: 1.50, max: 4.00, typical: 2.50 },
      'biscuit': { min: 0.80, max: 2.00, typical: 1.20 },
      'sweet': { min: 0.10, max: 1.00, typical: 0.50 },
      'chocolate': { min: 0.60, max: 3.00, typical: 1.50 },
      'pen': { min: 0.50, max: 2.00, typical: 1.00 },
      'pencil': { min: 0.20, max: 1.00, typical: 0.50 },
      'ruler': { min: 0.80, max: 2.50, typical: 1.50 },
      'notebook': { min: 1.00, max: 4.00, typical: 2.00 },
      'eraser': { min: 0.30, max: 1.50, typical: 0.75 },
      'book': { min: 3.00, max: 15.00, typical: 8.00 },
      'comic': { min: 2.00, max: 5.00, typical: 3.00 },
      'magazine': { min: 2.50, max: 6.00, typical: 4.00 },
      'toy': { min: 5.00, max: 25.00, typical: 12.00 },
      'game': { min: 8.00, max: 60.00, typical: 25.00 },
      'puzzle': { min: 5.00, max: 20.00, typical: 12.00 },
      'sticker': { min: 0.20, max: 2.00, typical: 0.80 },
      'badge': { min: 0.50, max: 3.00, typical: 1.50 },
      'poster': { min: 2.00, max: 8.00, typical: 4.00 },
      'card': { min: 0.50, max: 4.00, typical: 2.00 }
    };

    const items = Object.entries(realisticPrices).map(([name, pricing]) => ({
      name,
      category: this.getCategoryForItem(name),
      typicalValue: {
        min: pricing.min,
        max: pricing.max,
        typical: pricing.typical,
        distribution: 'normal' as const
      },
      unit: 'Â£',
      attributes: { quality: 'standard' as const }
    }));

    const realisticShoppingScenario: ScenarioContext = {
      id: 'shop-002-realistic-general',
      theme: ScenarioTheme.SHOPPING,
      setting: {
        location: 'local shop',
        timeContext: 'after school',
        atmosphere: 'friendly'
      },
      characters: [
        { name: this.selectRandomName(), role: 'student' }
      ],
      items,
      culturalElements: [
        { type: 'currency', value: 'Â£', explanation: 'British pounds' },
        { type: 'location', value: 'UK local shop', explanation: 'Typical British corner shop' }
      ],
      realWorldConnection: 'Everyday shopping with realistic UK prices',
      yearAppropriate: [1, 2, 3, 4, 5, 6],
      templates: [
        {
          formatCompatibility: [
            QuestionFormat.DIRECT_CALCULATION,
            QuestionFormat.ESTIMATION,
            QuestionFormat.MULTI_STEP
          ],
          template: '{character} goes to the shop and buys {purchases}. How much does {character} spend in total?',
          answerTemplate: '{character} spends {result} in total',
          placeholders: [
            { key: 'character', type: 'character' },
            { key: 'purchases', type: 'item_list' },
            { key: 'result', type: 'value' }
          ]
        },
        {
          formatCompatibility: [QuestionFormat.ESTIMATION],
          template: 'Estimate: If {character} buys {items}, about how much will it cost?',
          answerTemplate: 'It will cost approximately {result}',
          placeholders: [
            { key: 'character', type: 'character' },
            { key: 'items', type: 'item_list' },
            { key: 'result', type: 'value' }
          ]
        },
        {
          formatCompatibility: [QuestionFormat.VALIDATION],
          template: '{character} calculated that {items} costs {amount}. Is this correct?',
          answerTemplate: '{validation_result}',
          placeholders: [
            { key: 'character', type: 'character' },
            { key: 'items', type: 'item_list' },
            { key: 'amount', type: 'value' },
            { key: 'validation_result', type: 'boolean' }
          ]
        }
      ]
    };

    this.scenarios.set(realisticShoppingScenario.id, realisticShoppingScenario);
  }

  private getCategoryForItem(item: string): ItemCategory {
    const categoryMap: Record<string, ItemCategory> = {
      'apple': ItemCategory.FOOD_DRINK, 'banana': ItemCategory.FOOD_DRINK, 'sandwich': ItemCategory.FOOD_DRINK,
      'drink': ItemCategory.FOOD_DRINK, 'cake': ItemCategory.FOOD_DRINK, 'biscuit': ItemCategory.FOOD_DRINK,
      'sweet': ItemCategory.FOOD_DRINK, 'chocolate': ItemCategory.FOOD_DRINK, 'pen': ItemCategory.SCHOOL_SUPPLIES,
      'pencil': ItemCategory.SCHOOL_SUPPLIES, 'ruler': ItemCategory.SCHOOL_SUPPLIES, 'notebook': ItemCategory.SCHOOL_SUPPLIES,
      'eraser': ItemCategory.SCHOOL_SUPPLIES, 'book': ItemCategory.BOOKS_MEDIA, 'comic': ItemCategory.BOOKS_MEDIA,
      'magazine': ItemCategory.BOOKS_MEDIA, 'toy': ItemCategory.TOYS_GAMES, 'game': ItemCategory.TOYS_GAMES,
      'puzzle': ItemCategory.TOYS_GAMES, 'sticker': ItemCategory.TOYS_GAMES, 'badge': ItemCategory.TOYS_GAMES,
      'poster': ItemCategory.BOOKS_MEDIA, 'card': ItemCategory.BOOKS_MEDIA
    };
    return categoryMap[item] || ItemCategory.HOUSEHOLD_ITEMS;
  }

  private addSchoolScenarios(): void {}
  private addCelebrationScenarios(): void {}

  private buildThemeIndex(): void {
    for (const [id, scenario] of this.scenarios) {
      if (!this.themeIndex.has(scenario.theme)) {
        this.themeIndex.set(scenario.theme, []);
      }
      this.themeIndex.get(scenario.theme)!.push(id);
    }
  }

  private initializeModelThemeCompatibility(): void {
    const allModels = [
      'ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'PERCENTAGE', 'FRACTION', 'COUNTING', 
      'TIME_RATE', 'CONVERSION', 'COMPARISON', 'MULTI_STEP', 'LINEAR_EQUATION', 'UNIT_RATE', 
      'COIN_RECOGNITION', 'CHANGE_CALCULATION', 'MONEY_COMBINATIONS', 'MIXED_MONEY_UNITS', 
      'MONEY_FRACTIONS', 'MONEY_SCALING', 'SHAPE_RECOGNITION', 'SHAPE_PROPERTIES', 
      'ANGLE_MEASUREMENT', 'POSITION_DIRECTION', 'AREA_PERIMETER'
    ];

    allModels.forEach(model => {
        let themes: ScenarioTheme[] = [ScenarioTheme.SHOPPING, ScenarioTheme.SCHOOL, ScenarioTheme.HOUSEHOLD];
        if (['MULTIPLICATION', 'DIVISION', 'FRACTION', 'UNIT_RATE'].includes(model)) {
            themes.push(ScenarioTheme.COOKING);
        }
        if (['ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'TIME_RATE', 'POSITION_DIRECTION'].includes(model)) {
            themes.push(ScenarioTheme.SPORTS, ScenarioTheme.TRANSPORT);
        }
         if (['COUNTING', 'SHAPE_RECOGNITION', 'SHAPE_PROPERTIES', 'ANGLE_MEASUREMENT', 'POSITION_DIRECTION'].includes(model)) {
            themes.push(ScenarioTheme.NATURE);
        }
        if(['ADDITION', 'SUBTRACTION', 'MULTIPLICATION', 'DIVISION', 'COUNTING'].includes(model)){
            themes.push(ScenarioTheme.COLLECTIONS, ScenarioTheme.CELEBRATIONS);
        }
        if(['ADDITION', 'SUBTRACTION', 'PERCENTAGE', 'TIME_RATE'].includes(model)){
            themes.push(ScenarioTheme.POCKET_MONEY);
        }
        this.modelThemeCompatibility.set(model, [...new Set(themes)]);
    });
  }
}
```
--- END FILE: lib\services\scenario.service.ts ---

--- START FILE: lib\story-engine\contexts\money.context.ts ---
```typescript
import { StoryContext } from '@/lib/types';
import { randomChoice, getRandomName, MONEY_ITEMS } from '@/lib/utils';

export interface MoneyContext extends StoryContext {
  currency: string;
  currency_symbol: string;
  person: string;
  items: string[];
  shop_type?: string;
  payment_method?: string;
}

export class MoneyContextGenerator {
  private static readonly SHOP_TYPES = [
    'shop', 'store', 'market', 'bakery', 'bookshop', 
    'toy shop', 'sweet shop', 'stationery shop'
  ];

  private static readonly PAYMENT_METHODS = [
    'pays with', 'gives the shopkeeper', 'hands over'
  ];

  private static readonly ACTION_VERBS = {
    addition: ['buys', 'purchases', 'gets', 'picks up'],
    subtraction: ['spends', 'pays', 'gives'],
    multiplication: ['buys', 'orders', 'purchases'],
    division: ['shares', 'splits', 'divides equally']
  };

  static generate(operation: string): MoneyContext {
    const person = getRandomName();
    const itemCount = operation === 'ADDITION' ? randomChoice([2, 3, 4]) : 1;
    const items = this.selectItems(itemCount);
    
    const poundSymbol = '\u00A3'; // Unicode for Â£ symbol

    return {
      unit_type: 'currency',
      unit_symbol: poundSymbol,
      currency: 'pounds',
      currency_symbol: poundSymbol,
      person,
      items,
      item_descriptors: items,
      shop_type: randomChoice(this.SHOP_TYPES),
      payment_method: randomChoice(this.PAYMENT_METHODS),
      action_verb: this.getActionVerb(operation),
      scenario_type: this.getScenarioType(operation)
    };
  }

  private static selectItems(count: number): string[] {
    const selected: string[] = [];
    const available = [...MONEY_ITEMS];
    
    for (let i = 0; i < count && available.length > 0; i++) {
      const index = Math.floor(Math.random() * available.length);
      selected.push(available[index]);
      available.splice(index, 1);
    }
    
    return selected;
  }

  private static getActionVerb(operation: string): string {
    const verbs = (this.ACTION_VERBS as any)[operation.toLowerCase()] || this.ACTION_VERBS.addition;
    return randomChoice(verbs);
  }

  private static getScenarioType(operation: string): string {
    switch (operation) {
      case 'SUBTRACTION':
        return randomChoice(['change', 'spending', 'saving']);
      case 'DIVISION':
        return 'sharing';
      case 'MULTIPLICATION':
        return 'bulk_purchase';
      case 'PERCENTAGE':
        return 'discount';
      default:
        return 'purchase';
    }
  }

  static formatMoney(value: number, includeSymbol: boolean = true): string {
    const formatted = value.toFixed(2);
    // Use Unicode code point to ensure proper encoding
    const poundSymbol = '\u00A3'; // Unicode for Â£ symbol

    // Handle pence only (values less than 1)
    if (value < 1) {
      const pence = Math.round(value * 100);
      return includeSymbol ? `${pence}p` : `${pence} pence`;
    }

    // Handle pounds and pence
    const pounds = Math.floor(value);
    const pence = Math.round((value - pounds) * 100);

    if (pence === 0) {
      return includeSymbol ? `${poundSymbol}${pounds}` : `${pounds} pound${pounds !== 1 ? 's' : ''}`;
    }

    if (includeSymbol) {
      return `${poundSymbol}${formatted}`;
    }

    return `${pounds} pound${pounds !== 1 ? 's' : ''} and ${pence} pence`;
  }

  static generateChangeScenario(): {
    payment_amount: number;
    tendered_amount: number;
    payment_description: string;
  } {
    const payment = randomChoice([5, 10, 20, 50]);
    const costPercentage = randomChoice([0.3, 0.4, 0.5, 0.6, 0.7, 0.8]);
    const cost = Math.round(payment * costPercentage * 100) / 100;
    
    const poundSymbol = '\u00A3'; // Unicode for Â£ symbol

    return {
      payment_amount: cost,
      tendered_amount: payment,
      payment_description: `a ${poundSymbol}${payment} note`
    };
  }
}
```
--- END FILE: lib\story-engine\contexts\money.context.ts ---

--- START FILE: lib\story-engine\story.engine.ts ---
```typescript
import {
  StoryContext,
  AdditionOutput,
  SubtractionOutput,
  MultiplicationOutput,
  DivisionOutput,
  PercentageOutput,
  FractionOutput,
  CountingOutput,
  TimeRateOutput,
  ConversionOutput,
  ComparisonOutput,
  MultiStepOutput,
  LinearEquationOutput,
  UnitRateOutput,
  isAdditionOutput,
  isSubtractionOutput,
  isMultiplicationOutput,
  isDivisionOutput
} from '@/lib/types';
import { MoneyContextGenerator } from './contexts/money.context';

export class StoryEngine {
  generateQuestion(mathOutput: any, context: StoryContext): string {
    if (isAdditionOutput(mathOutput)) {
      return this.generateAdditionQuestion(mathOutput, context);
    }
    if (isSubtractionOutput(mathOutput)) {
      return this.generateSubtractionQuestion(mathOutput, context);
    }
    if (isMultiplicationOutput(mathOutput)) {
      return this.generateMultiplicationQuestion(mathOutput, context);
    }
    if (isDivisionOutput(mathOutput)) {
      return this.generateDivisionQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'PERCENTAGE') {
      return this.generatePercentageQuestion(mathOutput as PercentageOutput, context);
    }
    if (mathOutput.operation === 'FRACTION') {
      return this.generateFractionQuestion(mathOutput as FractionOutput, context);
    }
    if (mathOutput.operation === 'COUNTING') {
      return this.generateCountingQuestion(mathOutput as CountingOutput, context);
    }
    if (mathOutput.operation === 'TIME_RATE') {
      return this.generateTimeRateQuestion(mathOutput as TimeRateOutput, context);
    }
    if (mathOutput.operation === 'CONVERSION') {
      return this.generateConversionQuestion(mathOutput as ConversionOutput, context);
    }
    if (mathOutput.operation === 'COMPARISON') {
      return this.generateComparisonQuestion(mathOutput as ComparisonOutput, context);
    }
    if (mathOutput.operation === 'MULTI_STEP') {
      return this.generateMultiStepQuestion(mathOutput as MultiStepOutput, context);
    }
    if (mathOutput.operation === 'LINEAR_EQUATION') {
      return this.generateLinearEquationQuestion(mathOutput as LinearEquationOutput, context);
    }
    if (mathOutput.operation === 'UNIT_RATE') {
      return this.generateUnitRateQuestion(mathOutput as UnitRateOutput, context);
    }
    
    // Money-specific models
    if (mathOutput.operation === 'COIN_RECOGNITION') {
      return this.generateCoinRecognitionQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'CHANGE_CALCULATION') {
      return this.generateChangeCalculationQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'MONEY_COMBINATIONS') {
      return this.generateMoneyCombinationsQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'MIXED_MONEY_UNITS') {
      return this.generateMixedMoneyUnitsQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'MONEY_FRACTIONS') {
      return this.generateMoneyFractionsQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'MONEY_SCALING') {
      return this.generateMoneyScalingQuestion(mathOutput, context);
    }
    
    // Geometry models
    if (mathOutput.operation === 'SHAPE_RECOGNITION') {
      return this.generateShapeRecognitionQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'SHAPE_PROPERTIES') {
      return this.generateShapePropertiesQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'ANGLE_MEASUREMENT') {
      return this.generateAngleMeasurementQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'POSITION_DIRECTION') {
      return this.generatePositionDirectionQuestion(mathOutput, context);
    }
    if (mathOutput.operation === 'AREA_PERIMETER') {
      return this.generateAreaPerimeterQuestion(mathOutput, context);
    }
    
    return "Question generation not yet implemented for this model.";
  }

  private generateAdditionQuestion(output: AdditionOutput, context: StoryContext): string {
    const person = context.person || 'Sarah';
    const items = context.item_descriptors || ['item'];
    const symbol = context.unit_symbol || 'Â£';

    // Ensure we have enough items for all operands
    if (context.unit_type === 'currency' && items.length > 0) {
      // Shopping scenario - ensure we have items for each operand
      const itemsToUse = [];
      for (let i = 0; i < output.operands.length; i++) {
        itemsToUse.push(items[i % items.length]); // Reuse items if not enough
      }

      const purchases = output.operands.map((value, i) =>
        `a ${itemsToUse[i]} for ${MoneyContextGenerator.formatMoney(value)}`
      ).join(', ');

      return `${person} goes to the shop and buys ${purchases}. How much does ${person} spend in total?`;
    }
    
    // Generic addition
    if (context.unit_type === 'currency') {
      const symbol = context.unit_symbol || 'Â£';
      const values = output.operands.map(value => `${symbol}${output.decimal_formatted?.operands?.[output.operands.indexOf(value)] || value}`).join(', ');
      return `Add together: ${values}. What is the total?`;
    }
    
    const values = output.decimal_formatted.operands?.join(', ') || output.operands.join(', ');
    return `Add together: ${values}. What is the total?`;
  }

  private generateSubtractionQuestion(output: SubtractionOutput, context: StoryContext): string {
    const person = context.person || 'Tom';
    const symbol = context.unit_symbol || 'Â£';
    
    if (context.scenario_type === 'change' && context.unit_type === 'currency') {
      const item = context.item_descriptors?.[0] || 'item';
      return `${person} buys a ${item} for ${MoneyContextGenerator.formatMoney(output.subtrahend)}. ` +
             `${person} pays with ${MoneyContextGenerator.formatMoney(output.minuend)}. ` +
             `How much change does ${person} receive?`;
    }
    
    if (context.scenario_type === 'spending' && context.unit_type === 'currency') {
      return `${person} has ${MoneyContextGenerator.formatMoney(output.minuend)}. ` +
             `${person} spends ${MoneyContextGenerator.formatMoney(output.subtrahend)}. ` +
             `How much money does ${person} have left?`;
    }
    
    // Generic subtraction
    if (context.unit_type === 'currency') {
      const symbol = context.unit_symbol || 'Â£';
      const minuend = `${symbol}${output.decimal_formatted?.minuend || output.minuend}`;
      const subtrahend = `${symbol}${output.decimal_formatted?.subtrahend || output.subtrahend}`;
      return `Subtract: ${minuend} minus ${subtrahend}. What is the difference?`;
    }
    
    return `Subtract: ${output.decimal_formatted.minuend} minus ${output.decimal_formatted.subtrahend}. What is the difference?`;
  }

  private generateMultiplicationQuestion(output: MultiplicationOutput, context: StoryContext): string {
    const person = context.person || 'Emma';
    const symbol = context.unit_symbol || 'Â£';
    
    if (context.unit_type === 'currency') {
      const item = context.item_descriptors?.[0] || 'ticket';
      const quantity = Math.round(output.multiplier);
      
      return `${person} buys ${quantity} ${item}${quantity > 1 ? 's' : ''}. ` +
             `Each ${item} costs ${MoneyContextGenerator.formatMoney(output.multiplicand)}. ` +
             `How much does ${person} pay in total?`;
    }
    
    // Generic multiplication
    if (context.unit_type === 'currency') {
      const symbol = context.unit_symbol || 'Â£';
      const operand1 = `${symbol}${(output.decimal_formatted as any)?.multiplicand || (output as any).operands?.[0] || output.multiplicand}`;
      const operand2 = (output.decimal_formatted as any)?.multiplier || (output as any).operands?.[1] || output.multiplier;
      return `Multiply: ${operand1} Ã ${operand2}. What is the result?`;
    }
    
    return `Multiply: ${(output.decimal_formatted as any).multiplicand || output.multiplicand} Ã ${(output.decimal_formatted as any).multiplier || output.multiplier}. What is the result?`;
  }

  private generateDivisionQuestion(output: DivisionOutput, context: StoryContext): string {
    const person = context.person || 'James';
    
    if (context.scenario_type === 'sharing' && context.unit_type === 'currency') {
      const friends = Math.round(output.divisor);
      return `${friends} friends want to share ${MoneyContextGenerator.formatMoney(output.dividend)} equally. ` +
             `How much does each person get?`;
    }
    
    if (context.unit_type === 'currency') {
      const item = context.item_descriptors?.[0] || 'pen';
      const pack_size = Math.round(output.divisor);
      
      return `A pack of ${pack_size} ${item}s costs ${MoneyContextGenerator.formatMoney(output.dividend)}. ` +
             `What is the cost of one ${item}?`;
    }
    
    // Generic division
    if (context.unit_type === 'currency') {
      const symbol = context.unit_symbol || 'Â£';
      const dividend = `${symbol}${(output.decimal_formatted as any)?.dividend || (output as any).operands?.[0] || output.dividend}`;
      const divisor = (output.decimal_formatted as any)?.divisor || (output as any).operands?.[1] || output.divisor;
      const question = `Divide: ${dividend} Ã· ${divisor}. What is the result?`;
      if (output.remainder > 0) {
        return `${question} (Give your answer as a quotient and remainder)`;
      }
      return question;
    }
    
    const question = `Divide: ${(output.decimal_formatted as any).dividend || output.dividend} Ã· ${(output.decimal_formatted as any).divisor || output.divisor}. What is the result?`;
    if (output.remainder > 0) {
      return `${question} (Give your answer as a quotient and remainder)`;
    }
    return question;
  }

  private generatePercentageQuestion(output: PercentageOutput, context: StoryContext): string {
    const person = context.person || 'Lucy';
    
    if (context.unit_type === 'currency') {
      const item = context.item_descriptors?.[0] || 'jacket';
      
      switch (output.operation_type) {
        case 'decrease':
          return `A ${item} costs ${MoneyContextGenerator.formatMoney(output.base_value)}. ` +
                 `In a sale, it is reduced by ${output.percentage}%. What is the new price?`;
        
        case 'increase':
          return `${person} has ${MoneyContextGenerator.formatMoney(output.base_value)} in savings. ` +
                 `The bank pays ${output.percentage}% interest. ` +
                 `How much will ${person} have after the interest is added?`;
        
        case 'of':
          return `${person} wants to save ${output.percentage}% of ${MoneyContextGenerator.formatMoney(output.base_value)}. ` +
                 `How much should ${person} save?`;
        
        default:
          return `What is ${output.percentage}% of ${MoneyContextGenerator.formatMoney(output.base_value)}?`;
      }
    }
    
    // Generic percentage
    return `Calculate ${output.percentage}% of ${output.base_value}.`;
  }

  private generateFractionQuestion(output: FractionOutput, context: StoryContext): string {
    const person = context.person || 'Emma';
    const amount = context.unit_type === 'currency' 
      ? MoneyContextGenerator.formatMoney(output.whole_value)
      : String(output.whole_value);
    
    const fractionText = output.fraction.formatted === "1/2" ? "half" : 
                        output.fraction.formatted === "1/3" ? "one third" :
                        output.fraction.formatted === "1/4" ? "one quarter" :
                        output.fraction.formatted === "3/4" ? "three quarters" :
                        output.fraction.formatted;

    if (context.unit_type === 'currency') {
      return `${person} wants to save ${fractionText} of ${amount}. How much should ${person} save?`;
    }
    
    return `What is ${fractionText} of ${amount}?`;
  }

  private generateCountingQuestion(output: CountingOutput, context: StoryContext): string {
    const targetAmount = MoneyContextGenerator.formatMoney(output.target_value / 100);
    
    if (output.solutions.length === 1 && output.is_minimum_solution) {
      return `How many coins do you need to make ${targetAmount} using the smallest number of coins?`;
    } else if (output.solutions.length === 1) {
      const coinType = this.getCoinName(output.solutions[0].denomination);
      return `How many ${coinType} coins do you need to make ${targetAmount}?`;
    } else {
      return `Show two different ways to make ${targetAmount} using coins.`;
    }
  }

  private generateTimeRateQuestion(output: TimeRateOutput, context: StoryContext): string {
    const person = context.person || 'Tom';
    const rateAmount = MoneyContextGenerator.formatMoney(output.rate.value);
    const periodName = this.getPeriodName(output.rate.period, output.calculation.periods);
    
    switch (output.problem_type) {
      case "time_to_target":
        const targetAmount = MoneyContextGenerator.formatMoney(output.calculation.total_value);
        return `${person} saves ${rateAmount} every ${output.rate.period}. How many ${output.rate.period}s will it take to save ${targetAmount}?`;
      
      case "total_after_time":
        return `If ${person} saves ${rateAmount} every ${output.rate.period} for ${output.calculation.periods} ${periodName}, how much will ${person} have saved?`;
      
      case "rate_calculation":
        const totalSaved = MoneyContextGenerator.formatMoney(output.calculation.total_value);
        return `${person} saved ${totalSaved} over ${output.calculation.periods} ${periodName}. How much did ${person} save each ${output.rate.period}?`;
      
      default:
        return `Calculate the savings over time.`;
    }
  }

  private generateConversionQuestion(output: ConversionOutput, context: StoryContext): string {
    if (output.original_unit === "pence" && output.converted_unit === "pounds") {
      return `Convert ${output.original_value}p into pounds and pence.`;
    } else if (output.original_unit === "pounds" && output.converted_unit === "pence") {
      return `How many pence are there in ${MoneyContextGenerator.formatMoney(output.original_value)}?`;
    } else {
      return `Convert ${output.formatted_original} to ${output.converted_unit}.`;
    }
  }

  private generateComparisonQuestion(output: ComparisonOutput, context: StoryContext): string {
    const options = output.options.map((option, index) => {
      const letter = String.fromCharCode(65 + index);
      if (option.quantity && output.comparison_type === "better_value") {
        return `${letter}: ${MoneyContextGenerator.formatMoney(option.value)} for ${option.quantity}ml`;
      } else {
        return `${letter}: ${MoneyContextGenerator.formatMoney(option.value)}`;
      }
    }).join(', ');

    switch (output.comparison_type) {
      case "direct":
        return `Which is worth more? ${options}`;
      
      case "unit_rate":
      case "better_value":
        return `Which is better value? ${options}`;
      
      default:
        return `Compare these options: ${options}`;
    }
  }

  private getCoinName(denomination: number): string {
    const names: { [key: number]: string } = {
      1: "1p", 2: "2p", 5: "5p", 10: "10p", 
      20: "20p", 50: "50p", 100: "Â£1", 200: "Â£2"
    };
    return names[denomination] || `${denomination}p`;
  }

  private getPeriodName(period: string, count: number = 1): string {
    const names = {
      day: count === 1 ? 'day' : 'days',
      week: count === 1 ? 'week' : 'weeks',
      month: count === 1 ? 'month' : 'months',
      year: count === 1 ? 'year' : 'years'
    };
    return names[period as keyof typeof names] || period;
  }

  generateAnswer(mathOutput: any, context: StoryContext): string {
    if (context.unit_type === 'currency') {
      let value: number;
      
      if (isAdditionOutput(mathOutput) || isSubtractionOutput(mathOutput)) {
        value = mathOutput.result;
      } else if (isMultiplicationOutput(mathOutput)) {
        value = mathOutput.result;
      } else if (isDivisionOutput(mathOutput)) {
        value = mathOutput.quotient;
        if (mathOutput.remainder > 0) {
          return `${MoneyContextGenerator.formatMoney(value)} with ${MoneyContextGenerator.formatMoney(mathOutput.remainder)} remaining`;
        }
      } else if (mathOutput.operation === 'PERCENTAGE') {
        value = mathOutput.result;
      } else if (mathOutput.operation === 'FRACTION') {
        value = mathOutput.result;
      } else if (mathOutput.operation === 'TIME_RATE') {
        if (mathOutput.problem_type === 'time_to_target') {
          return `${mathOutput.calculation.periods} ${this.getPeriodName(mathOutput.rate.period, mathOutput.calculation.periods)}`;
        }
        value = mathOutput.calculation.total_value;
      } else if (mathOutput.operation === 'COUNTING') {
        const coins = mathOutput.solutions.map((s: any) => 
          `${s.count} Ã ${this.getCoinName(s.denomination)}`
        ).join(', ');
        return `${coins} (${mathOutput.total_coins} coins total)`;
      } else if (mathOutput.operation === 'CONVERSION') {
        return mathOutput.formatted_converted;
      } else if (mathOutput.operation === 'COMPARISON') {
        const winner = String.fromCharCode(65 + mathOutput.winner_index);
        return `${winner} is ${mathOutput.comparison_type === 'direct' ? 'worth more' : 'better value'}`;
      } else if (mathOutput.operation === 'MULTI_STEP') {
        value = mathOutput.final_result;
      } else if (mathOutput.operation === 'LINEAR_EQUATION') {
        if (mathOutput.problem_type === 'solve_for_x') {
          return `x = ${mathOutput.target_x}`;
        } else if (mathOutput.problem_type === 'solve_for_y') {
          return `y = ${mathOutput.target_y}`;
        } else {
          return mathOutput.equation;
        }
      } else if (mathOutput.operation === 'UNIT_RATE') {
        if (mathOutput.problem_type === 'find_unit_rate') {
          return `${MoneyContextGenerator.formatMoney(mathOutput.unit_rate)} per ${mathOutput.item}`;
        } else if (mathOutput.problem_type === 'compare_rates') {
          const better = mathOutput.comparison_rates.find((r: any) => r.better);
          return better ? `Option with ${better.quantity} ${mathOutput.item}s is better` : 'Base option is better';
        }
        value = mathOutput.scaled_value;
      } else if (mathOutput.operation === 'COIN_RECOGNITION') {
        if (mathOutput.problem_type === 'identify_value') {
          return mathOutput.formatted_value || this.getCoinName(mathOutput.target_denomination);
        } else if (mathOutput.problem_type === 'identify_name') {
          return mathOutput.denomination_name;
        } else if (mathOutput.problem_type === 'compare_values') {
          return mathOutput.comparison_result === 'first_greater' ? 'First collection' : 
                 mathOutput.comparison_result === 'second_greater' ? 'Second collection' : 'Equal value';
        }
        return `${mathOutput.total_value}p`;
      } else if (mathOutput.operation === 'CHANGE_CALCULATION') {
        return this.formatCurrency(mathOutput.change_amount);
      } else if (mathOutput.operation === 'MONEY_COMBINATIONS') {
        const combination = mathOutput.combinations[0];
        const coins = combination.map((coin: any) => `${coin.count} Ã ${coin.formatted}`).join(', ');
        return `${coins} (one possible way)`;
      } else if (mathOutput.operation === 'MIXED_MONEY_UNITS') {
        return mathOutput.formatted_result;
      } else if (mathOutput.operation === 'MONEY_FRACTIONS') {
        return this.formatCurrency(mathOutput.result_amount);
      } else if (mathOutput.operation === 'MONEY_SCALING') {
        return this.formatCurrency(mathOutput.scaled_cost);
      } else if (mathOutput.operation === 'SHAPE_RECOGNITION') {
        return String(mathOutput.correct_answer);
      } else if (mathOutput.operation === 'SHAPE_PROPERTIES') {
        return String(mathOutput.correct_answer);
      } else if (mathOutput.operation === 'ANGLE_MEASUREMENT') {
        return String(mathOutput.correct_answer);
      } else if (mathOutput.operation === 'POSITION_DIRECTION') {
        return String(mathOutput.correct_answer);
      } else if (mathOutput.operation === 'AREA_PERIMETER') {
        return String(mathOutput.correct_answer);
      } else {
        value = mathOutput.result || mathOutput.final_result || 0;
      }
      
      return MoneyContextGenerator.formatMoney(value);
    }
    
    // Generic answer
    if (mathOutput.result !== undefined) {
      return String(mathOutput.result);
    }
    if (mathOutput.quotient !== undefined) {
      if (mathOutput.remainder > 0) {
        return `${mathOutput.quotient} remainder ${mathOutput.remainder}`;
      }
      return String(mathOutput.quotient);
    }
    
    return String(mathOutput.final_result || 0);
  }

  private generateMultiStepQuestion(output: MultiStepOutput, context: StoryContext): string {
    const person = context.person || 'Sarah';
    const symbol = context.unit_symbol || 'Â£';
    
    const steps = output.steps.map((step, index) => {
      const stepNum = index + 1;
      if (step.operation === 'ADDITION') {
        return `adds ${symbol}${step.inputs.slice(1).join(' + ' + symbol)}`;
      } else if (step.operation === 'SUBTRACTION') {
        return `subtracts ${symbol}${step.inputs[1]}`;
      } else if (step.operation === 'MULTIPLICATION') {
        return `multiplies by ${step.inputs[1]}`;
      } else if (step.operation === 'DIVISION') {
        return `divides by ${step.inputs[1]}`;
      }
      return `performs ${step.operation.toLowerCase()}`;
    });

    const firstStep = output.steps[0];
    let questionText = `${person} starts with ${symbol}${firstStep.inputs[0]}`;
    
    if (steps.length > 1) {
      questionText += `, then ${steps.slice(1).join(', then ')}`;
    }
    
    questionText += '. How much does she have now?';
    
    return questionText;
  }

  private generateLinearEquationQuestion(output: any, context: StoryContext): string {
    if (output.problem_type === 'evaluate') {
      return `Using the equation ${output.equation}, what is the value of y when x = ${output.x_values[0]}?`;
    } else if (output.problem_type === 'complete_table') {
      return `Using the equation ${output.equation}, complete the table for x values: ${output.x_values.join(', ')}.`;
    } else if (output.problem_type === 'solve_for_y') {
      return `Using the equation ${output.equation}, find the value of y when x = ${output.target_x}.`;
    } else if (output.problem_type === 'solve_for_x') {
      return `Using the equation ${output.equation}, find the value of x when y = ${output.target_y}.`;
    }
    
    return `Work with the linear equation: ${output.equation}`;
  }

  private generateUnitRateQuestion(output: any, context: StoryContext): string {
    const symbol = context.unit_symbol || 'Â£';
    
    if (output.problem_type === 'find_unit_rate') {
      return `If ${output.base_quantity} ${output.item}s cost ${symbol}${output.base_rate}, what is the cost per ${output.item}?`;
    } else if (output.problem_type === 'scale_up' || output.problem_type === 'scale_down') {
      return `If ${output.base_quantity} ${output.item}s cost ${symbol}${output.base_rate}, how much would ${output.target_quantity} ${output.item}s cost?`;
    } else if (output.problem_type === 'compare_rates') {
      let question = `Compare these options for buying ${output.item}s:\n`;
      question += `Option A: ${output.base_quantity} for ${symbol}${output.base_rate}\n`;
      output.comparison_rates.forEach((rate: any, index: number) => {
        const letter = String.fromCharCode(66 + index); // B, C, D...
        question += `Option ${letter}: ${rate.quantity} for ${symbol}${rate.rate}\n`;
      });
      question += 'Which offers the best value per item?';
      return question;
    } else if (output.problem_type === 'best_value') {
      return `Which is the better deal: ${output.base_quantity} ${output.item}s for ${symbol}${output.base_rate}, or ${output.comparison_rates[0]?.quantity} ${output.item}s for ${symbol}${output.comparison_rates[0]?.rate}?`;
    }
    
    return `Calculate the rate for ${output.item}s at ${symbol}${output.unit_rate} per ${output.item}.`;
  }

  // Money-specific question generators
  private generateCoinRecognitionQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Tom';
    
    switch (output.problem_type) {
      case 'identify_value':
        return `${person} has a ${this.getCoinName(output.target_denomination)} coin. What is the value of this coin?`;
      
      case 'compare_values':
        const coins = output.collection.map((coin: any) => `${coin.count} Ã ${this.getCoinName(coin.denomination)}`).join(' and ');
        return `${person} has ${coins}. Which coin or collection has greater value?`;
      
      case 'total_value':
        const coinList = output.collection.map((coin: any) => `${coin.count} Ã ${this.getCoinName(coin.denomination)}`).join(', ');
        return `${person} has ${coinList}. What is the total value?`;
      
      default:
        return `${person} needs to identify the value of the coins.`;
    }
  }

  private generateChangeCalculationQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Sarah';
    
    if (output.problem_type === 'single_item') {
      const item = output.items[0];
      return `${person} buys a ${item.name} for ${this.formatCurrency(item.cost)}. ` +
             `${person} pays with ${output.payment_description}. How much change should ${person} receive?`;
    } else if (output.problem_type === 'multiple_items') {
      const itemList = output.items.map((item: any) => `${item.quantity} ${item.name}${item.quantity > 1 ? 's' : ''} for ${this.formatCurrency(item.cost * item.quantity)}`).join(' and ');
      return `${person} buys ${itemList} (total: ${this.formatCurrency(output.total_cost)}). ` +
             `${person} pays with ${output.payment_description}. How much change should ${person} receive?`;
    }
    
    return `${person} needs to calculate change from a purchase.`;
  }

  private generateMoneyCombinationsQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Emma';
    const targetAmount = output.formatted_target;
    
    switch (output.problem_type) {
      case 'find_combinations':
        return `Show ${output.combinations.length} different ways to make ${targetAmount} using coins.`;
      
      case 'make_amount':
        return `${person} wants to make ${targetAmount}. Show one way to do this using coins.`;
      
      case 'equivalent_amounts':
        return `${person} has ${targetAmount}. Show three different combinations of coins that make this amount.`;
      
      case 'compare_combinations':
        return `${person} wants to make ${targetAmount}. Which combination uses fewer coins?`;
      
      default:
        return `Find different ways to make ${targetAmount} using coins.`;
    }
  }

  private generateMixedMoneyUnitsQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'James';
    
    switch (output.problem_type) {
      case 'convert_units':
        if (output.conversion_type === 'pence_to_pounds') {
          return `${person} has ${output.formatted_source}. How much is this in pounds?`;
        } else if (output.conversion_type === 'pounds_to_pence') {
          return `${person} has ${output.formatted_source}. How much is this in pence?`;
        }
        break;
      
      case 'add_mixed_units':
        const amounts = output.amounts.map((amt: any) => amt.formatted).join(' and ');
        return `${person} has ${amounts}. What is the total amount?`;
      
      case 'subtract_mixed_units':
        return `${person} has ${output.formatted_source} and spends ${output.amount_spent.formatted}. How much is left?`;
      
      default:
        return `${person} needs to work with pounds and pence.`;
    }
    
    return `Convert between pounds and pence.`;
  }

  private generateMoneyFractionsQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Lucy';
    const amount = this.formatCurrency(output.whole_amount);
    const fractionText = this.getFractionText(output.fraction);
    
    switch (output.problem_type) {
      case 'fraction_of_amount':
        return `${person} wants to save ${fractionText} of ${amount}. How much should ${person} save?`;
      
      case 'find_fraction':
        return `${person} has ${amount} and spends ${this.formatCurrency(output.spent_amount)}. What fraction of the money did ${person} spend?`;
      
      case 'compare_fractions':
        return `${person} has ${amount}. Is ${fractionText} of this amount more than ${this.formatCurrency(output.comparison_amount)}?`;
      
      default:
        return `Calculate ${fractionText} of ${amount}.`;
    }
  }

  private generateMoneyScalingQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Alex';
    
    switch (output.problem_type) {
      case 'scale_up':
        return `If ${output.base_quantity} ${output.item}s cost ${this.formatCurrency(output.base_cost)}, ` +
               `how much would ${output.target_quantity} ${output.item}s cost?`;
      
      case 'scale_down':
        return `If ${output.base_quantity} ${output.item}s cost ${this.formatCurrency(output.base_cost)}, ` +
               `how much would ${output.target_quantity} ${output.item}s cost?`;
      
      case 'find_unit_cost':
        return `${output.base_quantity} ${output.item}s cost ${this.formatCurrency(output.base_cost)}. ` +
               `What is the cost of one ${output.item}?`;
      
      default:
        return `${person} needs to calculate proportional costs for ${output.item}s.`;
    }
  }

  private formatCurrency(amount: number): string {
    if (amount >= 100) {
      return `Â£${(amount / 100).toFixed(2)}`;
    } else {
      return `${amount}p`;
    }
  }

  private getFractionText(fraction: any): string {
    if (fraction.formatted === "1/2") return "half";
    if (fraction.formatted === "1/3") return "one third";
    if (fraction.formatted === "1/4") return "one quarter";
    if (fraction.formatted === "3/4") return "three quarters";
    return fraction.formatted;
  }

  // Geometry question generators
  private generateShapeRecognitionQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Tom';
    
    switch (output.problem_type) {
      case 'identify_shape':
        return `${person} is looking at a shape. What shape is this?`;
      
      case 'count_sides':
        const shapeName = output.target_shape;
        return `${person} is looking at a ${shapeName}. How many sides does this shape have?`;
      
      case 'count_vertices':
        const shapeForVertices = output.target_shape;
        return `${person} is looking at a ${shapeForVertices}. How many vertices (corners) does this shape have?`;
      
      case 'compare_shapes':
        const shape1 = output.shape_data[0]?.name;
        const shape2 = output.shape_data[1]?.name;
        return `${person} has a ${shape1} and a ${shape2}. Which shape has more sides?`;
      
      default:
        return `${person} needs to identify the shape.`;
    }
  }

  private generateShapePropertiesQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Emma';
    const shapeName = output.shape_name;
    const propertyFocus = output.question_focus;
    
    switch (output.problem_type) {
      case 'count_properties':
        const propertyName = this.getPropertyDisplayName(propertyFocus);
        return `${person} is studying a ${shapeName}. How many ${propertyName} does this shape have?`;
      
      case 'identify_property':
        if (propertyFocus === 'right_angles') {
          return `${person} is looking at a ${shapeName}. Does this shape have any right angles?`;
        } else if (propertyFocus === 'parallel_sides') {
          return `${person} is looking at a ${shapeName}. Does this shape have any parallel sides?`;
        } else {
          return `${person} is examining a ${shapeName}. What can you tell about its ${propertyFocus}?`;
        }
      
      case 'compare_properties':
        const shapes = shapeName.split(' vs ');
        const shape1 = shapes[0];
        const shape2 = shapes[1];
        const propertyDisplay = this.getPropertyDisplayName(propertyFocus);
        return `${person} is comparing shapes. Which shape has more ${propertyDisplay}: a ${shape1} or a ${shape2}?`;
      
      case 'classify_shapes':
        const propertyDesc = this.getPropertyDisplayName(propertyFocus);
        return `${person} needs to group shapes. Which of these shapes have ${propertyDesc}?`;
      
      default:
        return `${person} is studying the properties of a ${shapeName}.`;
    }
  }

  private generateAngleMeasurementQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Sophie';
    
    switch (output.problem_type) {
      case 'identify_type':
        return `${person} measures an angle and finds it is ${output.angle_degrees}Â°. What type of angle is this?`;
      
      case 'measure_angle':
        if (output.context === 'clock') {
          return `${person} is looking at a clock. ${output.visual_description}. What is the measurement of this angle?`;
        } else if (output.context === 'shape') {
          return `${person} is measuring an angle in a polygon. ${output.visual_description}. What is the measurement of this angle?`;
        } else {
          return `${person} needs to measure an angle. ${output.visual_description}. What is the measurement?`;
        }
      
      case 'calculate_missing':
        if (output.context === 'straight_line') {
          return `${person} knows that angles on a straight line add up to 180Â°. ${output.visual_description}. What is the missing angle?`;
        } else {
          return `${person} knows that angles around a point add up to 360Â°. ${output.visual_description}. What is the missing angle?`;
        }
      
      case 'convert_units':
        return `${person} measured an angle as ${output.angle_degrees}Â°. ${output.visual_description}. What is this measurement in the requested unit?`;
      
      default:
        return `${person} is working with angles.`;
    }
  }

  private generatePositionDirectionQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Alex';
    
    switch (output.problem_type) {
      case 'identify_position':
        if (output.coordinate_system === 'coordinate_plane') {
          return `${person} needs to identify the position of an object on a coordinate grid. What are the coordinates of the object?`;
        } else if (output.coordinate_system === 'lettered_grid') {
          return `${person} is looking at a grid with letters and numbers. What is the grid reference for the object?`;
        } else {
          return `${person} needs to describe the position of an object on the grid. What position is it in?`;
        }
      
      case 'follow_directions':
        const startDesc = this.formatPosition(output.start_position, output.coordinate_system);
        return `${person} starts at ${startDesc}. ${output.visual_description}. Where does ${person} end up?`;
      
      case 'give_directions':
        const startPos = this.formatPosition(output.start_position, output.coordinate_system);
        const targetPos = this.formatPosition(output.target_position, output.coordinate_system);
        return `${person} needs to get from ${startPos} to ${targetPos}. What directions should ${person} follow?`;
      
      case 'coordinates':
        if (output.question_focus === 'x_coordinate') {
          return `${person} is looking at a point on the coordinate plane. What is the x-coordinate?`;
        } else if (output.question_focus === 'y_coordinate') {
          return `${person} is looking at a point on the coordinate plane. What is the y-coordinate?`;
        } else {
          return `${person} needs to read the coordinates of a point. What are the coordinates?`;
        }
      
      case 'compass_directions':
        const centerDesc = this.formatPosition(output.start_position, output.coordinate_system);
        return `${person} starts at ${centerDesc} and moves according to compass directions. ${output.visual_description}. Which compass direction did ${person} move?`;
      
      case 'relative_position':
        return `${person} is comparing the positions of two objects on the grid. ${output.visual_description}. How would you describe the position of the second object relative to the first?`;
      
      default:
        return `${person} is working with positions and directions on a grid.`;
    }
  }

  private formatPosition(position: { x: number; y: number }, coordinateSystem: string): string {
    if (coordinateSystem === 'coordinate_plane') {
      return `(${position.x}, ${position.y})`;
    } else if (coordinateSystem === 'lettered_grid') {
      const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
      const letter = letters[position.x - 1] || 'A';
      return `${letter}${position.y}`;
    } else {
      return `column ${position.x}, row ${position.y}`;
    }
  }

  private generateAreaPerimeterQuestion(output: any, context: StoryContext): string {
    const person = context.person || 'Maya';
    const shapeType = output.shape_type;
    const unit = output.measurement_unit;
    
    switch (output.problem_type) {
      case 'calculate_area':
        return `${person} needs to find the area of a ${shapeType}. ${output.visual_description}. What is the area?`;
      
      case 'calculate_perimeter':
        const perimeterName = shapeType === 'circle' ? 'circumference' : 'perimeter';
        return `${person} needs to find the ${perimeterName} of a ${shapeType}. ${output.visual_description}. What is the ${perimeterName}?`;
      
      case 'calculate_both':
        return `${person} needs to find both the area and perimeter of a ${shapeType}. ${output.visual_description}. What are the area and perimeter?`;
      
      case 'find_missing_dimension':
        const missingDim = output.missing_dimension?.name || 'dimension';
        const knownType = output.area_result ? 'area' : 'perimeter';
        const knownValue = output.area_result || output.perimeter_result;
        const knownUnit = output.area_result ? `${unit}Â²` : unit;
        return `${person} knows that a ${shapeType} has a ${knownType} of ${knownValue} ${knownUnit}. ${output.visual_description}. What is the missing ${missingDim}?`;
      
      default:
        return `${person} is working with the area and perimeter of a ${shapeType}.`;
    }
  }

  private getPropertyDisplayName(property: string): string {
    const displayNames: { [key: string]: string } = {
      'sides': 'sides',
      'vertices': 'vertices (corners)',
      'angles': 'angles',
      'right_angles': 'right angles',
      'parallel_sides': 'parallel sides',
      'lines_of_symmetry': 'lines of symmetry',
      'rotational_symmetry': 'rotational symmetry'
    };
    
    return displayNames[property] || property;
  }
}
```
--- END FILE: lib\story-engine\story.engine.ts ---

--- START FILE: lib\types\question-formats.ts ---
```typescript
// Enhanced Question Format Type Definitions
// Defines cognitive tasks, scenarios, and question structures for the enhanced system

/**
 * Defines the cognitive task required of the student.
 * This determines which controller handles the question generation.
 */
export enum QuestionFormat {
  DIRECT_CALCULATION = 'DIRECT_CALCULATION',    // "What is 25 + 17?"
  COMPARISON = 'COMPARISON',                    // "Which is better value?"
  ESTIMATION = 'ESTIMATION',                    // "Estimate the capacity"
  ORDERING = 'ORDERING',                        // "Order from smallest to largest"
  VALIDATION = 'VALIDATION',                    // "Do you have enough money?"
  MULTI_STEP = 'MULTI_STEP',                   // Multiple calculations required
  MISSING_VALUE = 'MISSING_VALUE',              // "Find the missing number"
  PATTERN_RECOGNITION = 'PATTERN_RECOGNITION',  // "What comes next?"
}

/**
 * Maps question formats to their cognitive demands and year appropriateness
 */
export interface FormatMetadata {
  format: QuestionFormat;
  cognitiveLoad: number;           // Base cognitive demand (0-100)
  minYear: number;                 // Earliest appropriate year
  maxYear: number;                 // Latest appropriate year
  requiredSkills: string[];        // Prerequisite mathematical skills
  pedagogicalObjectives: string[]; // Learning objectives addressed
}

/**
 * Rich contextual framework for question narratives
 */
export interface ScenarioContext {
  id: string;
  theme: ScenarioTheme;
  setting: ScenarioSetting;
  characters: Character[];
  items: ContextItem[];
  culturalElements: CulturalElement[];
  realWorldConnection: string;
  yearAppropriate: number[];
  templates: ScenarioTemplate[];
}

export enum ScenarioTheme {
  SHOPPING = 'SHOPPING',
  COOKING = 'COOKING',
  SPORTS = 'SPORTS',
  SCHOOL = 'SCHOOL',
  TRANSPORT = 'TRANSPORT',
  POCKET_MONEY = 'POCKET_MONEY',
  COLLECTIONS = 'COLLECTIONS',
  NATURE = 'NATURE',
  HOUSEHOLD = 'HOUSEHOLD',
  CELEBRATIONS = 'CELEBRATIONS'
}

export interface ScenarioSetting {
  location: string;           // "school book fair", "local shop", "kitchen"
  timeContext?: string;       // "after school", "weekend", "holiday"
  atmosphere: string;         // "busy", "quiet", "exciting"
}

export interface Character {
  name: string;
  role?: string;              // "student", "parent", "shopkeeper"
  attributes?: string[];      // Age-appropriate descriptors
}

export enum ItemCategory {
  SCHOOL_SUPPLIES = 'SCHOOL_SUPPLIES',
  FOOD_ITEMS = 'FOOD_ITEMS',
  TOYS_GAMES = 'TOYS_GAMES',
  CLOTHING = 'CLOTHING',
  SPORTS_EQUIPMENT = 'SPORTS_EQUIPMENT',
  BOOKS_MEDIA = 'BOOKS_MEDIA',
  HOUSEHOLD_ITEMS = 'HOUSEHOLD_ITEMS',
  SAVING_GOAL = 'SAVING_GOAL'
}

export interface ContextItem {
  name: string;
  category: ItemCategory;
  typicalValue: ValueRange;
  unit: string;
  attributes: ItemAttributes;
  realWorldExample?: string;
}

export interface ItemAttributes {
  size?: 'small' | 'medium' | 'large';
  quality?: 'basic' | 'standard' | 'premium';
  quantity?: 'single' | 'pack' | 'bulk';
  brandTier?: 'generic' | 'branded';
  seasonality?: string[];
}

export interface ValueRange {
  min: number;
  max: number;
  typical: number;
  distribution: 'uniform' | 'normal' | 'skewed_low' | 'skewed_high';
}

export interface CulturalElement {
  type: 'currency' | 'measurement' | 'custom' | 'event';
  value: string;
  explanation?: string;
}

export interface ScenarioTemplate {
  formatCompatibility: QuestionFormat[];
  template: string;           // Question template with placeholders
  answerTemplate: string;     // Answer format template
  placeholders: PlaceholderDefinition[];
}

export interface PlaceholderDefinition {
  key: string;
  type: 'character' | 'item' | 'value' | 'unit' | 'action';
  constraints?: any;
  grammaticalForm?: 'singular' | 'plural' | 'possessive';
}

/**
 * Complete definition of a generated question before rendering
 */
export interface QuestionDefinition {
  // Identification
  id: string;
  timestamp: Date;

  // Core structure
  format: QuestionFormat;
  mathModel: string;              // e.g., 'ADDITION', 'UNIT_RATE'
  difficulty: SubDifficultyLevel;

  // Content
  scenario: ScenarioContext;
  parameters: QuestionParameters;

  // Enhanced question content for rich rendering
  questionContent?: QuestionContent;

  // Solution
  solution: QuestionSolution;

  // Metadata
  metadata: QuestionMetadata;
}

export interface SubDifficultyLevel {
  year: number;
  subLevel: number;              // 1-4 (X.1 to X.4)
  displayName: string;           // "3.2"
  cognitiveLoad: number;         // 0-100
}

export interface QuestionParameters {
  mathValues: Record<string, number>;    // Numerical values from math engine
  narrativeValues: Record<string, any>;  // Story elements
  units: Record<string, string>;         // Units for values
  formatting: FormattingOptions;
}

export interface FormattingOptions {
  currencyFormat: 'symbol' | 'words';
  decimalPlaces: number;
  useGroupingSeparators: boolean;
  unitPosition: 'before' | 'after';
}

export interface QuestionSolution {
  correctAnswer: Answer;
  distractors: Distractor[];
  explanation?: string;
  workingSteps?: string[];
  solutionStrategy: string;
}

export interface Answer {
  value: any;                   // The mathematical result
  displayText: string;          // Formatted for display
  units?: string;
  metadata?: any;
}

export interface Distractor extends Answer {
  strategy: DistractorStrategy;
  reasoning: string;            // Why a student might choose this
}

export interface QuestionMetadata {
  curriculumAlignment: string[];
  pedagogicalTags: string[];
  cognitiveSkills: string[];
  estimatedTime: number;        // seconds
  accessibility: AccessibilityInfo;
}

export interface AccessibilityInfo {
  readingLevel: number;         // Year level for reading difficulty
  visualElements: boolean;      // Contains diagrams/charts
  assistiveTechFriendly: boolean;
}

/**
 * Distractor generation system types
 */
export enum DistractorStrategy {
  // Calculation-based
  WRONG_OPERATION = 'WRONG_OPERATION',
  PARTIAL_CALCULATION = 'PARTIAL_CALCULATION',
  CALCULATION_ERROR = 'CALCULATION_ERROR',

  // Conceptual
  COMMON_MISCONCEPTION = 'COMMON_MISCONCEPTION',
  UNIT_CONFUSION = 'UNIT_CONFUSION',
  PLACE_VALUE_ERROR = 'PLACE_VALUE_ERROR',

  // Proximity-based
  OFF_BY_MAGNITUDE = 'OFF_BY_MAGNITUDE',
  CLOSE_VALUE = 'CLOSE_VALUE',
  ROUNDED_VALUE = 'ROUNDED_VALUE',

  // Format-specific
  REVERSED_COMPARISON = 'REVERSED_COMPARISON',
  WRONG_SELECTION = 'WRONG_SELECTION',
  PLAUSIBLE_ESTIMATE = 'PLAUSIBLE_ESTIMATE'
}

export interface DistractorRule {
  strategy: DistractorStrategy;
  applicableFormats: QuestionFormat[];
  applicableModels: string[];
  generator: DistractorGenerator;
  probability: number;          // Likelihood of using this strategy
}

export type DistractorGenerator = (
  correctAnswer: any,
  context: DistractorContext
) => Distractor[];

export interface DistractorContext {
  mathModel: string;
  format: QuestionFormat;
  operands?: number[];
  operation?: string;
  yearLevel: number;
  existingDistractors: any[];  // Avoid duplicates
}

export interface MisconceptionLibrary {
  byModel: Record<string, Misconception[]>;
  byYear: Record<number, Misconception[]>;
  byTopic: Record<string, Misconception[]>;
}

export interface Misconception {
  id: string;
  description: string;
  example: string;
  generateDistractor: DistractorGenerator;
  prevalence: 'rare' | 'uncommon' | 'common' | 'very_common';
  yearRange: { min: number; max: number };
}

/**
 * Format compatibility rules
 */
export interface FormatCompatibilityRule {
  format: QuestionFormat;
  minYear: number;
  maxYear: number;
  minSubLevel: number;
}

/**
 * Scenario selection criteria
 */
export interface ScenarioCriteria {
  format: QuestionFormat;
  yearLevel: number;
  theme?: ScenarioTheme;
  culturalContext?: string;
  mathModel?: string; // Add mathModel for theme compatibility filtering
}

export interface ScoredScenario {
  scenario: ScenarioContext;
  score: number;
}

/**
 * Enhanced question content for rich UI rendering
 */
export interface QuestionContent {
  // Complete rendered text for simple display
  fullText: string;

  // Structured components for rich UI
  components?: QuestionComponents;

  // Template data for custom rendering
  templateData?: QuestionTemplateData;
}

export interface QuestionComponents {
  narrative?: string;           // "Sarah is shopping and needs to calculate:"
  steps?: QuestionStep[];       // For multi-step problems
  prompt?: string;              // "What is the final result?"
  highlightValues?: number[];   // Values to emphasize in UI
  operators?: string[];         // ['+', '-', 'Ã'] for display
  sequence?: (number | string)[];  // For ordering/pattern questions
}

export interface QuestionStep {
  stepNumber: number;
  text: string;
  operation?: string;
  values?: number[];
  result?: number;
  description?: string;
}

export interface QuestionTemplateData {
  character?: string;
  action?: string;
  items?: string[];
  quantities?: number[];
  prices?: number[];
  units?: string[];
  context?: string;
  theme?: string;
}
```
--- END FILE: lib\types\question-formats.ts ---

--- START FILE: lib\types-enhanced.ts ---
```typescript
// Enhanced TypeScript interfaces for sub-difficulty system
// Extends existing types.ts with granular difficulty progression

export * from './types'; // Re-export all existing types

// Enhanced Difficulty System Types
export interface SubDifficultyLevel {
  year: number;        // 1-6
  subLevel: number;    // 1-4 
  displayName: string; // "3.2"
}

export interface DifficultyProgression {
  currentLevel: SubDifficultyLevel;
  parameters: any; // DifficultyParams from existing types
  nextLevel: {
    recommended: SubDifficultyLevel;  // Based on performance
    alternative: SubDifficultyLevel;  // For struggling students
  };
  changeDescription: string[]; // Human-readable change summary
  cognitiveLoadDelta: number; // Estimated difficulty change (-100 to +100)
  newSkillsRequired: string[];
  skillsReinforced: string[];
}

export interface DifficultyInterpolation {
  model: string;
  fromLevel: SubDifficultyLevel;
  toLevel: SubDifficultyLevel;
  parameterChanges: Array<{
    parameter: string;
    fromValue: any;
    toValue: any;
    interpolationType: 'linear' | 'stepped' | 'exponential';
    changeReason: string;
  }>;
}

export interface ProgressionRules {
  maxParameterIncrease: number; // 0.5 = 50% max increase
  maxSimultaneousChanges: number; // 2 parameters max
  confidenceThreshold: number; // 0.75 = 75% success needed
  adaptiveEnabled: boolean;
}

export interface PerformanceData {
  questionId: string;
  modelId: string;
  level: SubDifficultyLevel;
  isCorrect: boolean;
  timeSpent: number; // milliseconds
  timestamp: Date;
  hintUsed: boolean;
  attemptsRequired: number;
}

export interface DifficultyAdjustment {
  action: 'advance' | 'maintain' | 'reduce' | 'lock' | 'remedial';
  fromLevel: SubDifficultyLevel;
  toLevel: SubDifficultyLevel;
  reason: string;
  confidence: number; // 0-1
  recommendation: string;
}

export interface StudentSession {
  sessionId: string;
  studentId?: string;
  startTime: Date;
  currentModel: string;
  currentLevel: SubDifficultyLevel;
  performanceHistory: PerformanceData[];
  adaptiveMode: boolean;
  confidenceMode: boolean;
  streakCount: number;
  totalQuestions: number;
  correctAnswers: number;
}

export interface TransitionValidation {
  isSmooth: boolean;
  maxParameterChange: number;
  simultaneousChanges: number;
  cognitiveLoadIncrease: number;
  warnings: string[];
  recommendations: string[];
}

export interface CognitiveDemands {
  workingMemoryLoad: number; // 1-10
  proceduralComplexity: number; // 1-10
  conceptualDepth: number; // 1-10
  visualProcessing: number; // 1-10
  totalLoad: number; // 0-100
}

// Enhanced model-specific parameters for sub-levels
export interface EnhancedAdditionParams extends AdditionDifficultyParams {
  carryingFrequency: 'never' | 'rare' | 'occasional' | 'common' | 'always';
  numberRange: 'single-digit' | 'teen' | 'two-digit' | 'three-digit' | 'large';
  visualSupport: boolean;
}

export interface EnhancedSubtractionParams extends SubtractionDifficultyParams {
  borrowingFrequency: 'never' | 'rare' | 'occasional' | 'common' | 'always';
  numberRange: 'single-digit' | 'teen' | 'two-digit' | 'three-digit' | 'large';
  visualSupport: boolean;
}

export interface EnhancedMultiplicationParams extends MultiplicationDifficultyParams {
  tablesFocus: number[]; // [2, 5, 10] for specific times tables
  numberRange: 'basic' | 'extended' | 'large';
  conceptualSupport: boolean;
}

export interface EnhancedDivisionParams extends DivisionDifficultyParams {
  remainderFrequency: 'never' | 'rare' | 'occasional' | 'common' | 'always';
  tablesFocus: number[]; // Division facts to focus on
  visualSupport: boolean;
}

export interface EnhancedPercentageParams extends PercentageDifficultyParams {
  percentageComplexity: 'simple' | 'standard' | 'complex';
  conceptualContext: string[];
  visualSupport: boolean;
}

export interface EnhancedFractionParams extends FractionDifficultyParams {
  denominatorComplexity: 'basic' | 'common' | 'mixed' | 'complex';
  numeratorTypes: 'unit' | 'simple' | 'mixed' | 'improper';
  visualSupport: boolean;
}

// Re-export with import alias to avoid conflicts
import { 
  AdditionDifficultyParams,
  SubtractionDifficultyParams, 
  MultiplicationDifficultyParams,
  DivisionDifficultyParams,
  PercentageDifficultyParams,
  FractionDifficultyParams
} from './types';
```
--- END FILE: lib\types-enhanced.ts ---

--- START FILE: lib\types.ts ---
```typescript
// Core TypeScript interfaces for the Question Factory system

// Generic Math Model Interface
export interface IMathModel<TParams, TOutput> {
  model_id: string;
  generate(params: TParams): TOutput;
  getDefaultParams(year: number): TParams;
}

// Base interfaces
export interface ValueConstraints {
  min: number;
  step: number;
}

export interface DecimalFormatted {
  operands?: string[];
  result: string;
  minuend?: string;
  subtrahend?: string;
  quotient?: string;
}

// ADDITION Model
export interface AdditionDifficultyParams {
  operand_count: number;        // Number of values to sum (2-10)
  max_value: number;            // Maximum value for any operand
  decimal_places: number;       // Number of decimal places (0-3)
  allow_carrying: boolean;      // Whether carrying is required
  value_constraints: ValueConstraints;
}

export interface AdditionOutput {
  operation: "ADDITION";
  operands: number[];
  result: number;
  intermediate_steps: number[];
  decimal_formatted: DecimalFormatted;
}

// SUBTRACTION Model
export interface SubtractionDifficultyParams {
  minuend_max: number;          // Maximum value for the minuend
  subtrahend_max: number;       // Maximum value for the subtrahend
  decimal_places: number;       // Number of decimal places (0-3)
  allow_borrowing: boolean;    // Whether borrowing is required
  ensure_positive: boolean;    // Ensures result is non-negative
  value_constraints: {
    step: number;               // Step size for values
  };
}

export interface SubtractionOutput {
  operation: "SUBTRACTION";
  minuend: number;
  subtrahend: number;
  result: number;
  decimal_formatted: DecimalFormatted;
}

// MULTIPLICATION Model
export interface MultiplicationDifficultyParams {
  multiplicand_max: number;     // Maximum value for multiplicand
  multiplier_max: number;       // Maximum value for multiplier
  decimal_places: number;       // Decimal places in operands (0-3)
  operand_count: number;        // Number of values to multiply (2-4)
  use_fractions: boolean;       // Allow fractional multipliers
}

export interface MultiplicationOutput {
  operation: "MULTIPLICATION";
  multiplicand: number;
  multiplier: number;
  result: number;
  factors: number[];
  decimal_formatted: DecimalFormatted;
}

// DIVISION Model
export interface DivisionDifficultyParams {
  dividend_max: number;         // Maximum value for dividend
  divisor_max: number;          // Maximum value for divisor
  decimal_places: number;       // Decimal places in result (0-3)
  allow_remainder: boolean;     // Whether to include remainders
  ensure_whole: boolean;        // Ensure result is whole number
}

export interface DivisionOutput {
  operation: "DIVISION";
  dividend: number;
  divisor: number;
  quotient: number;
  remainder: number;
  decimal_formatted: DecimalFormatted;
}

// MULTI_STEP Model
export interface MultiStepOperation {
  model: string;                // "ADDITION", "SUBTRACTION", etc.
  params: any;                  // Parameters for the specific model
  use_previous_result: boolean; // Use result from previous step
}

export interface MultiStepDifficultyParams {
  operation_sequence: MultiStepOperation[];
  max_steps: number;            // Maximum number of operations (2-5)
  intermediate_visibility: boolean; // Show intermediate results
}

export interface StepResult {
  step: number;
  operation: string;
  inputs: number[];
  result: number;
}

export interface MultiStepOutput {
  operation: "MULTI_STEP";
  steps: StepResult[];
  final_result: number;
  intermediate_results: number[];
}

// LINEAR_EQUATION Model
export interface LinearEquationDifficultyParams {
  slope_range: { min: number; max: number };
  intercept_range: { min: number; max: number };
  x_range: { min: number; max: number };
  decimal_places: number;
  allow_negative_slope: boolean;
  allow_negative_intercept: boolean;
  problem_types: string[];
  x_value_count: number;
}

export interface LinearEquationOutput {
  operation: "LINEAR_EQUATION";
  equation: {
    slope: number;
    intercept: number;
    formatted: string;
  };
  input: number;
  output: number;
  calculation_steps: {
    mx: number;
    mx_plus_c: number;
  };
}

// PERCENTAGE Model
export interface PercentageDifficultyParams {
  base_value_max: number;       // Maximum base value
  percentage_values: number[];  // Allowed percentage values [10, 20, 25, 50, etc.]
  operation_type: "of" | "increase" | "decrease" | "reverse";
  decimal_places: number;       // Decimal places in result
}

export interface PercentageOutput {
  operation: "PERCENTAGE";
  operation_type: string;
  base_value: number;
  percentage: number;
  percentage_amount: number;
  result: number;
}

// UNIT_RATE Model
export interface UnitRateDifficultyParams {
  base_quantity_range: { min: number; max: number };
  base_rate_range: { min: number; max: number };
  target_quantity_range: { min: number; max: number };
  decimal_places: number;
  allow_complex_rates: boolean;
  problem_types: string[];
  include_comparisons: boolean;
  comparison_count: number;
  unit_contexts?: string[];
}

export interface UnitRateCalculation {
  total: number;
  quantity: number;
  unit_rate: number;
}

export interface UnitRateOutput {
  operation: "UNIT_RATE";
  calculations: UnitRateCalculation[];
  best_value_index: number;
}

// FRACTION Model
export interface FractionDifficultyParams {
  whole_value_max: number;       // Maximum whole value to find fraction of
  fraction_types: Array<{        // Allowed fractions
    numerator: number;
    denominator: number;
  }>;
  decimal_places: number;        // Decimal places in result
  ensure_whole_result: boolean;  // Ensure result is whole number when possible
}

export interface FractionOutput {
  operation: "FRACTION";
  whole_value: number;
  fraction: {
    numerator: number;
    denominator: number;
    formatted: string;           // "1/2", "3/4", etc.
  };
  result: number;
  calculation_steps: {
    division_result: number;
    final_result: number;
  };
}

// COUNTING Model
export interface CountingDifficultyParams {
  target_value: number;          // Target amount to make
  allowed_denominations: number[]; // Coins/notes allowed
  solution_type: "exact" | "minimum" | "multiple"; // Type of counting problem
  max_coins: number;             // Maximum coins to use
}

export interface CountingOutput {
  operation: "COUNTING";
  target_value: number;
  solutions: Array<{
    denomination: number;
    count: number;
  }>;
  total_coins: number;
  is_minimum_solution: boolean;
}

// TIME_RATE Model  
export interface TimeRateDifficultyParams {
  rate_value_max: number;        // Maximum rate value
  rate_period: "day" | "week" | "month" | "year"; // Time period
  target_value_max: number;      // Maximum target value
  decimal_places: number;        // Decimal places
  problem_type: "time_to_target" | "total_after_time" | "rate_calculation";
}

export interface TimeRateOutput {
  operation: "TIME_RATE";
  rate: {
    value: number;
    period: string;
  };
  calculation: {
    periods: number;
    total_value: number;
  };
  problem_type: string;
}

// CONVERSION Model
export interface ConversionDifficultyParams {
  value_max: number;             // Maximum value to convert
  conversion_types: Array<{      // Available conversions
    from_unit: string;
    to_unit: string;
    conversion_factor: number;
  }>;
  decimal_places: number;        // Decimal places in result
}

export interface ConversionOutput {
  operation: "CONVERSION";
  original_value: number;
  original_unit: string;
  converted_value: number;
  converted_unit: string;
  conversion_factor: number;
  formatted_original: string;
  formatted_converted: string;
}

// COMPARISON Model
export interface ComparisonDifficultyParams {
  value_count: number;           // Number of values to compare (2-4)
  value_max: number;             // Maximum value
  comparison_type: "direct" | "unit_rate" | "better_value";
  decimal_places: number;        // Decimal places
  include_calculation: boolean;  // Whether to show calculation steps
}

export interface ComparisonOption {
  value: number;
  quantity?: number;
  unit_rate?: number;
  description: string;
}

export interface ComparisonOutput {
  operation: "COMPARISON";
  options: ComparisonOption[];
  comparison_type: string;
  winner_index: number;
  difference?: number;
  explanation: string;
}

// Story Engine Context Types
export interface StoryContext {
  unit_type: string;            // "currency", "measurement", "count"
  unit_symbol: string;          // "Â£", "kg", ""
  item_descriptors?: string[];  // ["cake", "drink"]
  action_verb?: string;         // "buys", "collects", "earns"
  scenario_type?: string;       // "change", "difference", "remaining"
  initial_context?: string;     // "pays with", "has saved"
  removal_context?: string;     // "costs", "spent"
  quantity_type?: string;       // "groups", "items_per_unit"
  unit_descriptor?: string;     // "tickets", "pens per pack"
  person?: string;              // "Sarah", "Tom", etc.
}

// Question Generation Types
export interface GenerateRequest {
  model_id: string;
  difficulty_params?: any;
  context_type?: string;
  year_level?: number;
}

export interface GenerationSetup {
  // Orchestrator details
  controller_used: string;
  format_requested: string;
  format_actual: string;
  format_selection_reason?: string;

  // Scenario details
  scenario_theme: string;
  scenario_id: string;
  scenario_selection_method: string;

  // Distractor details
  distractor_strategies: string[];
  distractor_count: number;

  // Rules and weights
  format_weights?: Record<string, number>;
  theme_variety: boolean;
  format_variety: boolean;

  // Enhancement tracking
  enhancement_level: 'full' | 'partial' | 'fallback';
  features_active: string[];
  features_pending: string[];

  // Performance
  generation_time_ms: number;
  controller_init_time_ms?: number;
}

export interface GeneratedQuestion {
  question: string;
  answer: string | number;
  math_output: any;
  context: StoryContext;
  metadata: {
    model_id: string;
    year_level: number;
    sub_level?: string;
    difficulty_params: any;
    enhanced_system_used?: boolean;
    session_id?: string;
    timestamp: Date;
  };
  generation_setup?: GenerationSetup;
}

// Model Information Types
export interface ModelParameter {
  name: string;
  type: 'number' | 'boolean' | 'string' | 'array';
  min?: number;
  max?: number;
  default: any;
  description: string;
}

export interface ModelInfo {
  model_id: string;
  description: string;
  difficulty_parameters: ModelParameter[];
  supported_year_levels: number[];
  context_types: string[];
}

// Test Types
export interface TestRequest {
  model_id: string;
  test_count: number;
  difficulty_params: any;
}

export interface TestResult {
  question: string;
  answer: string | number;
  generation_time_ms: number;
}

export interface TestResponse {
  results: TestResult[];
  statistics: {
    avg_generation_time: number;
    success_rate: number;
    unique_questions: number;
    total_time_ms: number;
  };
}

// Export Request Types
export interface ExportRequest {
  questions: GeneratedQuestion[];
  format: 'json' | 'csv';
  include_metadata: boolean;
}

// Type guards
export function isAdditionOutput(output: any): output is AdditionOutput {
  return output.operation === "ADDITION";
}

export function isSubtractionOutput(output: any): output is SubtractionOutput {
  return output.operation === "SUBTRACTION";
}

export function isMultiplicationOutput(output: any): output is MultiplicationOutput {
  return output.operation === "MULTIPLICATION";
}

export function isDivisionOutput(output: any): output is DivisionOutput {
  return output.operation === "DIVISION";
}

// Money Models - UK National Curriculum Specific

// COIN_RECOGNITION Model
export interface CoinRecognitionDifficultyParams {
  include_coins: number[];          // Which coin denominations to include (in pence)
  include_notes: number[];          // Which note denominations to include (in pence)
  problem_types: string[];          // Types of problems: identify_value, identify_name, count_collection, compare_values
  max_coin_count: number;           // Maximum number of coins in a collection
  allow_mixed_denominations: boolean; // Whether to mix different coin types
  include_combinations: boolean;    // Whether to include combination problems
}

export interface CoinRecognitionOutput {
  operation: "COIN_RECOGNITION";
  problem_type: string;
  target_denomination?: number;
  denomination_name?: string;
  formatted_value?: string;
  is_note?: boolean;
  collection: Array<{ denomination: number; count: number }>;
  total_value: number;
  answer_type: string;
  comparison_result?: string;
}

// CHANGE_CALCULATION Model
export interface ChangeCalculationDifficultyParams {
  max_item_cost: number;            // Maximum cost of individual items
  payment_methods: number[];        // Available payment denominations
  decimal_places: number;           // Number of decimal places
  problem_types: string[];          // Types: simple_change, exact_payment, multiple_items, change_breakdown
  include_breakdown: boolean;       // Whether to break down change into denominations
  max_items: number;                // Maximum number of items in a transaction
  allow_overpayment: boolean;       // Whether to allow overpayment scenarios
}

export interface ChangeCalculationOutput {
  operation: "CHANGE_CALCULATION";
  problem_type: string;
  items: Array<{ name: string; cost: number; quantity: number }>;
  total_cost: number;
  payment_amount: number;
  change_amount: number;
  change_breakdown: Array<{ denomination: number; count: number; formatted: string }>;
  payment_description: string;
}

// MONEY_COMBINATIONS Model
export interface MoneyCombinationsDifficultyParams {
  target_amount_range: { min: number; max: number };
  available_denominations: number[];
  problem_types: string[];          // Types: find_combinations, make_amount, equivalent_amounts, compare_combinations
  max_combinations: number;
  allow_notes: boolean;
  require_exact_combinations: boolean;
  decimal_places: number;
}

export interface MoneyCombinationsOutput {
  operation: "MONEY_COMBINATIONS";
  problem_type: string;
  target_amount: number;
  available_denominations: number[];
  combinations: Array<Array<{ denomination: number; count: number; formatted: string }>>;
  total_combinations: number;
  formatted_target: string;
  specific_combination?: Array<{ denomination: number; count: number; formatted: string }>;
  comparison_criteria?: string;
}

// MIXED_MONEY_UNITS Model
export interface MixedMoneyUnitsDifficultyParams {
  pounds_range: { min: number; max: number };
  pence_range: { min: number; max: number };
  problem_types: string[];          // Types: convert_units, add_mixed_units, subtract_mixed_units, compare_mixed_amounts
  decimal_places: number;
  allow_complex_operations: boolean;
  include_comparisons: boolean;
  max_operands: number;
}

export interface MixedMoneyUnitsOutput {
  operation: "MIXED_MONEY_UNITS";
  problem_type: string;
  source_amount?: { pounds: number; pence: number };
  target_format?: string;
  result: number;
  result_mixed?: { pounds: number; pence: number; total_decimal: number };
  operands?: Array<{ pounds: number; pence: number }>;
  minuend?: { pounds: number; pence: number };
  subtrahend?: { pounds: number; pence: number };
  amount1?: { pounds: number; pence: number };
  amount2?: { pounds: number; pence: number };
  comparison_result?: string;
  difference?: number;
  formatted_source?: string;
  formatted_result?: string;
  formatted_operands?: string[];
  formatted_minuend?: string;
  formatted_subtrahend?: string;
  formatted_amount1?: string;
  formatted_amount2?: string;
  formatted_difference?: string;
  conversion_type?: string;
  requires_borrowing?: boolean;
}

// MONEY_FRACTIONS Model
export interface MoneyFractionsDifficultyParams {
  amount_range: { min: number; max: number };
  allowed_fractions: Array<{ numerator: number; denominator: number }>;
  problem_types: string[];          // Types: fraction_of_amount, find_whole_from_fraction, compare_fractional_amounts, add_fractional_money
  decimal_places: number;
  ensure_whole_results: boolean;
  include_word_problems: boolean;
  max_fraction_complexity: number;
}

export interface MoneyFractionsOutput {
  operation: "MONEY_FRACTIONS";
  problem_type: string;
  whole_amount?: number;
  base_amount?: number;
  fraction?: { numerator: number; denominator: number };
  fraction1?: { numerator: number; denominator: number };
  fraction2?: { numerator: number; denominator: number };
  result: number;
  fractional_amount?: number;
  amount1?: number;
  amount2?: number;
  comparison_result?: string;
  formatted_whole?: string;
  formatted_base?: string;
  formatted_fraction?: string;
  formatted_fraction1?: string;
  formatted_fraction2?: string;
  formatted_result?: string;
  formatted_fractional_amount?: string;
  formatted_amount1?: string;
  formatted_amount2?: string;
  fraction_name?: string;
  calculation_steps?: Array<{ step: string; calculation: string; result: string }>;
}

// MONEY_SCALING Model
export interface MoneyScalingDifficultyParams {
  base_amount_range: { min: number; max: number };
  scale_factor_range: { min: number; max: number };
  problem_types: string[];          // Types: scale_up, scale_down, proportional_reasoning, rate_problems
  decimal_places: number;
  include_fractional_scaling: boolean;
  allow_complex_ratios: boolean;
  context_types: string[];
}

export interface MoneyScalingOutput {
  operation: "MONEY_SCALING";
  problem_type: string;
  base_amount?: number;
  scale_factor?: number;
  scaled_amount?: number;
  original_amount?: number;
  base_quantity?: number;
  new_quantity?: number;
  new_amount?: number;
  unit_cost?: number;
  rate?: number;
  time_amount?: number;
  time_unit?: string;
  total_amount?: number;
  context: string;
  formatted_base?: string;
  formatted_scaled?: string;
  formatted_original?: string;
  formatted_new?: string;
  formatted_scale_factor?: string;
  formatted_unit_cost?: string;
  formatted_rate?: string;
  formatted_total?: string;
  calculation?: string;
}

// GEOMETRY Models

// SHAPE_RECOGNITION Model
export interface ShapeRecognitionDifficultyParams {
  include_2d_shapes: string[];      // ['circle', 'triangle', 'square', 'rectangle', 'pentagon', 'hexagon']
  include_3d_shapes: string[];      // ['cube', 'sphere', 'cylinder', 'cone', 'pyramid']
  problem_types: string[];          // ['identify_shape', 'count_sides', 'count_vertices', 'compare_shapes']
  max_shapes_count: number;         // Maximum number of shapes to show at once
  include_irregular_shapes: boolean; // Include irregular versions of shapes
  allow_rotations: boolean;         // Include rotated versions of shapes
}

export interface ShapeRecognitionOutput {
  operation: "SHAPE_RECOGNITION";
  problem_type: string;            // 'identify_shape', 'count_sides', 'count_vertices', 'compare_shapes'
  shape_data: {
    name: string;                  // 'circle', 'triangle', etc.
    type: '2d' | '3d';
    sides?: number;                // For polygons
    vertices?: number;             // For polygons
    properties: string[];          // ['curved', 'straight_sides', 'equal_sides', etc.]
    category: string;              // 'polygon', 'circle', 'polyhedron', etc.
  }[];
  target_shape?: string;           // For identification problems
  correct_answer: string | number;
  distractors?: string[];          // Incorrect options for multiple choice
  comparison_result?: string;      // For comparison problems
}

// SHAPE_PROPERTIES Model  
export interface ShapePropertiesDifficultyParams {
  shape_types: string[];           // ['triangle', 'quadrilateral', 'polygon', 'circle']
  property_types: string[];        // ['sides', 'vertices', 'angles', 'symmetry', 'parallel_lines']
  max_sides: number;               // Maximum sides for polygons
  include_angle_types: boolean;    // Include right angles, acute, obtuse
  include_symmetry: boolean;       // Include line/rotational symmetry
  problem_complexity: 'simple' | 'medium' | 'complex';
}

export interface ShapePropertiesOutput {
  operation: "SHAPE_PROPERTIES";
  problem_type: string;            // 'count_properties', 'identify_property', 'compare_properties'
  shape_name: string;
  properties: {
    sides: number;
    vertices: number;
    angles?: number;
    right_angles?: number;
    parallel_sides?: number;
    lines_of_symmetry?: number;
    rotational_symmetry?: number;
  };
  question_focus: string;          // Which property is being asked about
  correct_answer: string | number;
  explanation?: string;
}

// ANGLE_MEASUREMENT Model
export interface AngleMeasurementDifficultyParams {
  angle_types: string[];           // ['right', 'acute', 'obtuse', 'straight', 'reflex']
  measurement_units: string[];     // ['degrees', 'turns', 'right_angles']
  include_angle_drawing: boolean;  // Include problems about drawing angles
  include_angle_calculation: boolean; // Include calculating missing angles
  max_angle_degrees: number;       // Maximum angle size in degrees
  problem_types: string[];         // ['identify_type', 'measure_angle', 'draw_angle', 'calculate_missing']
}

export interface AngleMeasurementOutput {
  operation: "ANGLE_MEASUREMENT";
  problem_type: string;
  angle_degrees: number;
  angle_type: string;              // 'right', 'acute', 'obtuse', etc.
  measurement_in_turns?: number;   // Angle as fraction of full turn
  measurement_in_right_angles?: number; // Angle as multiple of right angles
  context: string;                 // 'clock', 'shape', 'lines', etc.
  visual_description?: string;     // Description of the angle's appearance
  correct_answer: string | number;
}

// POSITION_DIRECTION Model
export interface PositionDirectionDifficultyParams {
  coordinate_system: string;       // 'simple_grid', 'lettered_grid', 'coordinate_plane'
  use_compass_directions: boolean; // Include N/S/E/W directions
  max_grid_size: number;          // Size of coordinate grid
  include_diagonals: boolean;     // Include diagonal movements
  movement_steps: number;         // Maximum number of movement steps
  problem_types: string[];        // ['identify_position', 'follow_directions', 'give_directions', 'coordinates', 'compass_directions', 'relative_position']
}

export interface PositionDirectionOutput {
  operation: "POSITION_DIRECTION";
  problem_type: string;
  start_position: { x: number; y: number };
  target_position: { x: number; y: number };
  movements?: Array<{ direction: string; steps: number }>;
  coordinate_system: string;
  grid_size: number;
  question_focus?: string;
  visual_description: string;
  correct_answer: string;
}

// AREA_PERIMETER Model
export interface AreaPerimeterDifficultyParams {
  shape_types: string[];           // ['rectangle', 'square', 'triangle', 'circle', 'compound']
  measurement_units: string[];     // ['cm', 'mm', 'm', 'units']
  max_dimensions: number;          // Maximum length/width values
  include_decimal_measurements: boolean;
  calculation_types: string[];     // ['area', 'perimeter', 'both', 'find_missing_dimension']
  allow_compound_shapes: boolean;  // Shapes made of multiple rectangles
}

export interface AreaPerimeterOutput {
  operation: "AREA_PERIMETER";
  problem_type: string;           // 'calculate_area', 'calculate_perimeter', 'calculate_both', 'find_missing_dimension'
  shape_type: string;
  dimensions: any;                // Flexible object containing shape-specific dimensions
  measurement_unit: string;
  area_result?: number;
  perimeter_result?: number;
  missing_dimension?: { name: string; value: number };
  formula_used: string;
  visual_description: string;
  correct_answer: string;
}
```
--- END FILE: lib\types.ts ---

--- START FILE: lib\utils.ts ---
```typescript
/**
 * Utility functions for the Factory Architect application
 */

/**
 * Simple class name utility (fallback without external dependencies)
 */
export function cn(...classes: (string | undefined)[]): string {
  return classes.filter(Boolean).join(' ')
}

/**
 * Generate random number between min and max (inclusive)
 * UPDATED to handle decimals.
 */
export function generateRandomNumber(
  max: number,
  decimalPlaces: number = 0,
  min: number = 0,
  step: number = 1
): number {
  if (min > max) {
    [min, max] = [max, min]; // Swap if min is greater than max
  }
  const range = (max - min) / step;
  const randomStep = Math.floor(Math.random() * (range + 1));
  const value = min + randomStep * step;
  return parseFloat(value.toFixed(decimalPlaces));
}

/**
 * Choose a random element from an array
 */
export function randomChoice<T>(array: T[]): T {
  return array[Math.floor(Math.random() * array.length)]
}

/**
 * Choose multiple random elements from an array without replacement
 */
export function randomChoices<T>(array: T[], count: number): T[] {
  const shuffled = [...array].sort(() => 0.5 - Math.random())
  return shuffled.slice(0, Math.min(count, array.length))
}

/**
 * Round number to specified decimal places
 */
export function roundToDecimal(num: number, decimals: number): number {
  return Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals)
}

/**
 * Format number as currency (UK pounds).
 */
export function formatCurrency(value: number): string {
    const poundSymbol = '\u00A3';
    if (value < 1 && value > 0) {
      return `${Math.round(value * 100)}p`;
    }
    return `${poundSymbol}${value.toFixed(2)}`;
}

/**
 * Central value formatter for all controllers.
 */
export function formatValue(value: number, unit?: string, decimalPlaces: number = 2): string {
    if (unit === 'Â£' || unit === 'pounds') {
      return formatCurrency(value);
    }
    if (unit === 'p' || unit === 'pence') {
        return `${Math.round(value)}p`;
    }

    if (Number.isInteger(value) && decimalPlaces === 0) {
      return value.toString();
    }
    
    const factor = Math.pow(10, decimalPlaces);
    return (Math.round(value * factor) / factor).toString();
}

/**
 * Generate a random integer within a range with optional step
 */
export function randomInt(min: number, max: number, step: number = 1): number {
  const range = Math.floor((max - min) / step) + 1
  return min + Math.floor(Math.random() * range) * step
}

/**
 * Clamp a number between min and max values
 */
export function clamp(num: number, min: number, max: number): number {
  return Math.min(Math.max(num, min), max)
}

/**
 * Check if a number is within a range (inclusive)
 */
export function isInRange(num: number, min: number, max: number): boolean {
  return num >= min && num <= max
}

/**
 * Generate an array of numbers in a range
 */
export function range(start: number, end: number, step: number = 1): number[] {
  const result: number[] = []
  for (let i = start; i <= end; i += step) {
    result.push(i)
  }
  return result
}

/**
 * Shuffle an array using Fisher-Yates algorithm
 */
export function shuffle<T>(array: T[]): T[] {
  const shuffled = [...array]
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1))
    ;[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
  }
  return shuffled
}

/**
 * Check if addition requires carrying.
 * UPDATED to handle an array of operands.
 */
export function requiresCarrying(operands: number[]): boolean {
  // Convert all numbers to strings to work with digits
  const strOperands = operands.map(op => op.toString());
  const maxLength = Math.max(...strOperands.map(s => s.split('.')[0].length));

  let carry = 0;
  for (let i = 0; i < maxLength; i++) {
    let columnSum = carry;
    for (const op of strOperands) {
      const parts = op.split('.');
      const intPart = parts[0];
      const digitIndex = intPart.length - 1 - i;
      if (digitIndex >= 0) {
        columnSum += parseInt(intPart[digitIndex], 10);
      }
    }
    if (columnSum >= 10) {
      return true; // Carrying is required
    }
    carry = Math.floor(columnSum / 10);
  }
  return false;
}

/**
 * Check if subtraction requires borrowing
 */
export function requiresBorrowing(a: number, b: number): boolean {
  if (b > a) return true; // Borrowing from thin air!
  
  const aStr = a.toString().split('.')[0];
  const bStr = b.toString().split('.')[0];
  const maxLen = Math.max(aStr.length, bStr.length);

  for (let i = 0; i < maxLen; i++) {
    const digitA = parseInt(aStr[aStr.length - 1 - i] || '0')
    const digitB = parseInt(bStr[bStr.length - 1 - i] || '0')

    if (digitA < digitB) {
      return true
    }
  }

  return false
}

/**
 * Format decimal number with specified precision
 */
export function formatDecimal(num: number, decimals: number = 2): string {
    if (decimals === 0 && Number.isInteger(num)) {
        return num.toString();
    }
    return num.toFixed(decimals);
}

/**
 * Ensure array contains unique values only by calling a generator function
 */
export function ensureUnique<T>(generator: () => T, count: number): T[] {
    const set = new Set<T>();
    let attempts = 0;
    while(set.size < count && attempts < count * 10) { // Safety break
        set.add(generator());
        attempts++;
    }
    return Array.from(set);
}


/**
 * Get random name for story contexts
 */
export function getRandomName(): string {
  const names = [
    'Alice', 'Bob', 'Charlie', 'Diana', 'Emma', 'Frank', 'Grace', 'Henry',
    'Ivy', 'Jack', 'Kate', 'Liam', 'Maya', 'Noah', 'Olivia', 'Peter',
    'Quinn', 'Ruby', 'Sam', 'Tara', 'Uma', 'Victor', 'Wendy', 'Xander',
    'Yara', 'Zoe'
  ]
  return randomChoice(names)
}

/**
 * Money items for story contexts
 */
export const MONEY_ITEMS = [
  'apple',
  'banana',
  'orange',
  'sandwich',
  'drink',
  'chocolate bar',
  'magazine',
  'pencil',
  'notebook',
  'sticker pack',
  'toy car',
  'book'
]
```
--- END FILE: lib\utils.ts ---

--- START FILE: next.config.ts ---
```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;

```
--- END FILE: next.config.ts ---

--- START FILE: package.json ---
```json
{
  "name": "factory-architect",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@radix-ui/react-label": "^2.1.7",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-slider": "^1.3.6",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.542.0",
    "next": "15.5.2",
    "react": "19.1.0",
    "react-dom": "19.1.0",
    "tailwind-merge": "^3.3.1"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "15.5.2",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}

```
--- END FILE: package.json ---

--- START FILE: postcss.config.mjs ---
```javascript
const config = {
  plugins: ["@tailwindcss/postcss"],
};

export default config;

```
--- END FILE: postcss.config.mjs ---


--- START FILE: tsconfig.json ---
```json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}

```
--- END FILE: tsconfig.json ---

